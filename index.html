<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/12/21/单实例rman备份异机恢复到rac环境/"><span>[Oracle] 单实例rman备份异机恢复到rac环境</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/21/单实例rman备份异机恢复到rac环境/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-21T03:11:00.000Z">
          2018-12-21
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、查询DBID信息"><a href="#1、查询DBID信息" class="headerlink" title="1、查询DBID信息"></a>1、查询DBID信息</h4><p>DBID是DataBase IDentifier的缩写，是数据库的唯一标识符。这个DBID在数据文件头和控制文件都是存在的，可以用于标示数据文件的归属。对于不同数据库来说，DBID应当不同，而db_name则可能是相同的。一般在nocatalog模式并且控制文件丢失时才需要这个。<br>查看源库的dbid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@ testcadb&gt; select name,dbid from v$database;</span><br><span class="line">NAME		DBID</span><br><span class="line">--------- ----------</span><br><span class="line">TESTCADB  2313387174</span><br></pre></td></tr></table></figure></p>
<h4 id="2、查看源库的数据文件路径"><a href="#2、查看源库的数据文件路径" class="headerlink" title="2、查看源库的数据文件路径"></a>2、查看源库的数据文件路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYS@ testcadb&gt; select file_id,file_name from dba_data_files;</span><br><span class="line">FILE_ID FILE_NAME</span><br><span class="line"></span><br><span class="line"> 4 /home/oracle/u01/app/oracle/oradata/testcadb/users01.dbf</span><br><span class="line"> 3 /home/oracle/u01/app/oracle/oradata/testcadb/undotbs01.dbf</span><br><span class="line"> 2 /home/oracle/u01/app/oracle/oradata/testcadb/sysaux01.dbf</span><br><span class="line"> 1 /home/oracle/u01/app/oracle/oradata/testcadb/system01.dbf</span><br><span class="line"> 5 /home/oracle/oradata/orcl/ebank_data.dbf</span><br></pre></td></tr></table></figure>
<h4 id="3、查看临时表空间数据文件"><a href="#3、查看临时表空间数据文件" class="headerlink" title="3、查看临时表空间数据文件"></a>3、查看临时表空间数据文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYS@ testcadb&gt; select * from dba_temp_files;</span><br><span class="line">FILE_NAME																					           FILE_ID TABLESPACE_NAME			 BYTES	   BLOCKS STATUS  RELATIVE_FNO AUT   MAXBYTES  MAXBLOCKS INCREMENT_BY USER_BYTES USER_BLOCKS</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">/home/oracle/u01/app/oracle/oradata/testcadb/temp01.dbf 															         1 TEMP			      20971520	     2560 ONLINE	     1 YES 3.4360E+10	 4194302	   80	19922944	2432</span><br><span class="line">/home/oracle/oradata/orcl/test_temp01.dbf																	         2 TEST_TEMP			      33554432	     4096 ONLINE	     1 YES 2147483648	  262144	 4096	32505856	3968</span><br></pre></td></tr></table></figure>
<h4 id="4、查看日志文件路径："><a href="#4、查看日志文件路径：" class="headerlink" title="4、查看日志文件路径："></a>4、查看日志文件路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select a.bytes/1024/1024,b.member,b.group#,a.thread# from v$log a,v$logfile b where a.group#=b.group#;</span><br><span class="line">A.BYTES/1024/1024 MEMBER																			      GROUP#	  THREAD#</span><br><span class="line">50 /home/oracle/u01/app/oracle/oradata/testcadb/redo03.log													           3		1</span><br><span class="line">50 /home/oracle/u01/app/oracle/oradata/testcadb/redo02.log													           2		1</span><br><span class="line">50 /home/oracle/u01/app/oracle/oradata/testcadb/redo01.log													           1		1</span><br></pre></td></tr></table></figure>
<h4 id="5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）"><a href="#5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）" class="headerlink" title="5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）"></a>5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mkdir -p /tmp/backup/</span><br><span class="line">shell &gt; rman target /</span><br><span class="line">RMAN&gt; run &#123;</span><br><span class="line"> allocate channel c1 device type disk;  </span><br><span class="line"> backup incremental level 0 format &apos;/tmp/backup/db_full_%U.bkp&apos; tag &apos;2018-12-19-FULL&apos; database plus archivelog;  </span><br><span class="line"> release channel c1;</span><br><span class="line">&#125;</span><br><span class="line">备份控制文件</span><br><span class="line">RMAN&gt; backup current controlfile format &apos;/tmp/backup/control20181219.bak&apos;;</span><br><span class="line">备份pfile文件</span><br><span class="line">RMAN&gt; backup spfile format &apos;/tmp/backup/spfile20181219.bak&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="6、拷贝源库备份文件到目标库服务器"><a href="#6、拷贝源库备份文件到目标库服务器" class="headerlink" title="6、拷贝源库备份文件到目标库服务器"></a>6、拷贝源库备份文件到目标库服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; scp /tmp/backup/* oracle@hostip*:/home/oracle/backup/</span><br></pre></td></tr></table></figure>
<h4 id="7、以下操作都是在目标节点上执行"><a href="#7、以下操作都是在目标节点上执行" class="headerlink" title="7、以下操作都是在目标节点上执行"></a>7、以下操作都是在目标节点上执行</h4><h4 id="8、查看文件权限，如果权限不对需要修改"><a href="#8、查看文件权限，如果权限不对需要修改" class="headerlink" title="8、查看文件权限，如果权限不对需要修改"></a>8、查看文件权限，如果权限不对需要修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; chown oracle.oinstall /home/oracle/backup/*</span><br></pre></td></tr></table></figure>
<h4 id="9、在节点1上执行恢复spfile文件："><a href="#9、在节点1上执行恢复spfile文件：" class="headerlink" title="9、在节点1上执行恢复spfile文件："></a>9、在节点1上执行恢复spfile文件：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">生成临时pfile文件</span><br><span class="line">shell &gt; echo &apos;db_name=testcadb&apos; &gt; $ORACLE_HOME/dbs/inittestcadb1.ora  </span><br><span class="line">声明ORACLE_SID</span><br><span class="line">shell &gt; export ORACLE_SID=testcadb1</span><br><span class="line">shell &gt; rman target /</span><br><span class="line">以临时pfile文件启动库到nomount：</span><br><span class="line">rman &gt; startup nomount  pfile=&apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora&apos;;</span><br><span class="line">设置dbid</span><br><span class="line">rman &gt; set DBID=2313387174;</span><br><span class="line">从备份中恢复spfile文件</span><br><span class="line">rman &gt; restore spfile to &apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/spfileoibs1.ora&apos; from &apos;/home/oracle/backup/spfile20181218.bak&apos;;</span><br></pre></td></tr></table></figure>
<p>操作结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 backup]$ rman target /</span><br><span class="line">恢复管理器: Release 11.2.0.4.0 - Production on 星期五 9月 23 14:13:35 2016</span><br><span class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</span><br><span class="line">RMAN&gt; startup nomount  pfile=&apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora&apos;;</span><br><span class="line">Oracle instance started</span><br><span class="line">Total System Global Area     371654656 bytes</span><br><span class="line">Fixed Size                     2253304 bytes</span><br><span class="line">Variable Size                314576392 bytes</span><br><span class="line">Database Buffers              50331648 bytes</span><br><span class="line">Redo Buffers                   4493312 bytes</span><br><span class="line"></span><br><span class="line">RMAN&gt; set DBID=2313387174;</span><br><span class="line">executing command: SET DBID</span><br><span class="line"></span><br><span class="line">RMAN&gt; restore spfile to &apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/spfiletestcadb1.ora&apos; from &apos;/home/oracle/backup/spfile20181219.bak&apos;;</span><br><span class="line">Starting restore at 2018:12:19 10:25:18</span><br><span class="line">using target database control file instead of recovery catalog</span><br><span class="line">allocated channel: ORA_DISK_1</span><br><span class="line">channel ORA_DISK_1: SID=134 device type=DISK</span><br><span class="line">channel ORA_DISK_1: restoring spfile from AUTOBACKUP /home/oracle/backup/spfile20181218.bak</span><br><span class="line">channel ORA_DISK_1: SPFILE restore from AUTOBACKUP complete</span><br><span class="line">Finished restore at 2018:12:19 10:25:20</span><br></pre></td></tr></table></figure></p>
<p>根据生成的spfile文件生成pfile文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 backup]$ sqlplus / as sysdba</span><br><span class="line">sql &gt; create pfile from spfile;</span><br></pre></td></tr></table></figure></p>
<p>对生成的pfile文件进行修改<br>vim /u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">*.__db_cache_size=969567232</span><br><span class="line">*.__java_pool_size=16777216</span><br><span class="line">*.__large_pool_size=184549376</span><br><span class="line">*.__oracle_base=&apos;/home/oracle/u01/app/oracle&apos;#ORACLE_BASE set from environment</span><br><span class="line">*.__pga_aggregate_target=1617245696</span><br><span class="line">*.__sga_target=1925868544</span><br><span class="line">*.__shared_io_pool_size=0</span><br><span class="line">*.__shared_pool_size=704643072</span><br><span class="line">*.__streams_pool_size=0</span><br><span class="line">*.aq_tm_processes=0</span><br><span class="line">*.audit_file_dest=&apos;/u01/app/oracle/admin/testcadb/adump&apos;</span><br><span class="line">*.audit_trail=&apos;db&apos;</span><br><span class="line">*.compatible=&apos;11.2.0.4.0&apos;</span><br><span class="line">*.control_files=&apos;+DATA1/testcadb/control01.ctl&apos;,&apos;+DATA1/testcadb/control02.ctl&apos;</span><br><span class="line">*.cpu_count=3</span><br><span class="line">*.db_block_size=8192</span><br><span class="line">*.db_domain=&apos;&apos;</span><br><span class="line">*.db_name=&apos;testcadb&apos;</span><br><span class="line">*.db_recovery_file_dest=&apos;+ARCH&apos;</span><br><span class="line">*.db_recovery_file_dest_size=4385144832</span><br><span class="line">*.diagnostic_dest=&apos;/u01/app/oracle&apos;</span><br><span class="line">*.dispatchers=&apos;(PROTOCOL=TCP) (SERVICE=testcadbXDB)&apos;</span><br><span class="line">*.job_queue_processes=0</span><br><span class="line">*.memory_target=3529482752</span><br><span class="line">*.open_cursors=300</span><br><span class="line">*.processes=400</span><br><span class="line">*.remote_login_passwordfile=&apos;EXCLUSIVE&apos;</span><br><span class="line">*.resource_manager_plan=&apos;default_plan&apos;</span><br><span class="line">*.sessions=445</span><br><span class="line">*.log_archive_dest_1=&apos;LOCATION=+ARCH/testcadb/archivelog&apos;</span><br><span class="line">*.log_archive_format=&apos;arch_%t_%s_%r.arc&apos;</span><br><span class="line">testcadb1.instance_name=&apos;testcadb1&apos;</span><br><span class="line">testcadb2.instance_name=&apos;testcadb2&apos;</span><br><span class="line">testcadb1.instance_number=1</span><br><span class="line">testcadb2.instance_number=2</span><br><span class="line">testcadb1.undo_tablespace=&apos;UNDOTBS1&apos;</span><br><span class="line">testcadb2.undo_tablespace=&apos;UNDOTBS2&apos;</span><br><span class="line">testcadb2.thread=2</span><br><span class="line">testcadb1.thread=1</span><br><span class="line">*.remote_listener=&apos;racscan:1521&apos;</span><br></pre></td></tr></table></figure></p>
<p>停止数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">19:17:48 SYS@ testcadb1&gt; shutdown immediate;</span><br><span class="line">ORA-01507: database not mounted</span><br><span class="line">ORACLE instance shut down.</span><br></pre></td></tr></table></figure></p>
<p>根据pfile文件中的设置路径,创建相应目录,oracle用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mkdir -p /u01/app/oracle/admin/testcadb/adump</span><br></pre></td></tr></table></figure></p>
<p>grid用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; asmcmd</span><br><span class="line">asmcmd&gt; mkdir ***</span><br></pre></td></tr></table></figure></p>
<p>修改完成之后以pfile文件重新启动数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; startup nomount pfile=&apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora&apos;;</span><br></pre></td></tr></table></figure></p>
<p>根据pfile文件生成新的spfile文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; create spfile=&apos;+DATA1/testcadb/spfiletestcadb.ora&apos; from pfile;</span><br><span class="line">SQL&gt; shutdown abort</span><br><span class="line">ORACLE instance shut down.</span><br></pre></td></tr></table></figure></p>
<p>将所有的节点上pfile文件，指向共享文件上的spfile文件<br>rac1节点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 ~]$ echo &quot;SPFILE=&apos;+DATA1/testcadb/spfiletestcadb.ora&apos; &quot; &gt; /u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora</span><br></pre></td></tr></table></figure></p>
<p>rac2节点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac2 ~]$ echo &quot;SPFILE=&apos;+DATA1/testcadb/spfiletestcadb.ora&apos; &quot; &gt; /u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb2.ora</span><br></pre></td></tr></table></figure></p>
<h4 id="10、还原数据库的controlfile"><a href="#10、还原数据库的controlfile" class="headerlink" title="10、还原数据库的controlfile"></a>10、还原数据库的controlfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac2 ~]$ rman target /</span><br><span class="line">rman &gt; startup nomount</span><br></pre></td></tr></table></figure>
<p>还原控制文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rman &gt; restore controlfile from &apos;/home/oracle/backup/control20181219.bak&apos;;</span><br></pre></td></tr></table></figure></p>
<p>启动到mount<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rman &gt; alter database mount;</span><br></pre></td></tr></table></figure></p>
<h4 id="11、还原数据库，指定备份文件到存放路径"><a href="#11、还原数据库，指定备份文件到存放路径" class="headerlink" title="11、还原数据库，指定备份文件到存放路径"></a>11、还原数据库，指定备份文件到存放路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">rman &gt; catalog start with &apos;/home/oracle/backup&apos;;</span><br><span class="line">rman &gt; list backup summary;</span><br><span class="line">执行下列run脚本(根据数据文件的不同作相应修改)</span><br><span class="line">RMAN&gt; run&#123;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/users01.dbf&apos; to &apos;+DATA1/testcadb/users01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/undotbs01.dbf&apos; to &apos;+DATA1/testcadb/undotbs01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/sysaux01.dbf&apos; to &apos;+DATA1/testcadb/sysaux01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/system01.dbf&apos; to &apos;+DATA1/testcadb/system01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/oradata/orcl/ebank_data.dbf&apos; to &apos;+DATA1/testcadb/ebank_data.dbf&apos;;</span><br><span class="line">restore database;</span><br><span class="line">switch datafile all;</span><br><span class="line">&#125;</span><br><span class="line">或者：</span><br><span class="line">RMAN&gt; run&#123;</span><br><span class="line">set newname for datafile 1 to &apos;+DATA1/testcadb/users01.dbf&apos;;</span><br><span class="line">set newname for datafile 2 to &apos;+DATA1/testcadb/undotbs01.dbf&apos;;</span><br><span class="line">set newname for datafile 3 to &apos;+DATA1/testcadb/sysaux01.dbf&apos;;</span><br><span class="line">set newname for datafile 4 to &apos;+DATA1/testcadb/system01.dbf&apos;;</span><br><span class="line">set newname for datafile 5 to &apos;+DATA1/testcadb/ebank_data.dbf&apos;;</span><br><span class="line">restore database;</span><br><span class="line">switch datafile all;</span><br><span class="line">&#125;</span><br><span class="line">查看备份的归档（如果是非归档模式的备份没有数据）</span><br><span class="line">RMAN&gt; list backup of archivelog all;</span><br><span class="line">根据scn恢复数据库</span><br><span class="line">RMAN&gt; recover database until scn 2896925;</span><br><span class="line">或者如果没有归档，直接恢复数据库</span><br><span class="line">RMAN&gt; recover database;</span><br></pre></td></tr></table></figure>
<p>尝试打开数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; sqlplus / as sysdba</span><br><span class="line">sql &gt; alter database open resetlogs;</span><br><span class="line">alter database open resetlogs</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-00344: unable to re-create online log &apos;/home/oracle/u01/app/oracle/oradata/testcadb/redo01.log&apos;</span><br><span class="line">ORA-27040: file create error, unable to create file</span><br><span class="line">Linux-x86_64 Error: 2: No such file or directory</span><br><span class="line">Additional information: 1</span><br></pre></td></tr></table></figure></p>
<p>提示redolog文件路径错误，重新生成redolog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select group#,thread#,members,archived,status from v$log;</span><br><span class="line"></span><br><span class="line">    GROUP#    THREAD#	 MEMBERS ARCHIV STATUS</span><br><span class="line">---------- ---------- ---------- ------ --------------------------------</span><br><span class="line">	 1	    1	       1 NO	CLEARING</span><br><span class="line">	 3	    1	       1 NO	CLEARING_CURRENT</span><br><span class="line">	 2	    1	       1 NO	CLEARING</span><br><span class="line">Elapsed: 00:00:00.03</span><br><span class="line">删除原来的logfile</span><br><span class="line">sql &gt; alter database drop logfile group 1;</span><br><span class="line">新增logfile(要保证redolog路径存在)</span><br><span class="line">sql &gt; alter database add logfile group 1 &apos;+ARCH/testcadb/redolog/redo01.log&apos; size 100M;</span><br><span class="line">sql &gt; alter database drop logfile group 2;</span><br><span class="line">sql &gt; alter database add logfile group 2 &apos;+ARCH/testcadb/redolog/redo02.log&apos; size 100M;</span><br><span class="line">sql &gt; alter database drop logfile group 3;</span><br><span class="line">提示日志无法删除</span><br><span class="line">sql &gt; alter database drop logfile group 3;</span><br><span class="line">alter database drop logfile group 3</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01623: log 3 is current log for instance testcadb1 (thread 1) - cannot drop</span><br><span class="line">ORA-00312: online log 3 thread 1: &apos;/home/oracle/u01/app/oracle/oradata/testcadb/redo03.log&apos;</span><br><span class="line">对文件进行重命名</span><br><span class="line">sql &gt; alter database rename file &apos;/home/oracle/u01/app/oracle/oradata/testcadb/redo03.log&apos; to &apos;+ARCH/testcadb/redolog/redo03.log&apos;;</span><br><span class="line">sql &gt; alter database clear logfile group 3;</span><br><span class="line">因为日志文件大小还是按原来的大小，需要重新建</span><br><span class="line">sql &gt; alter database drop logfile group 3;</span><br><span class="line">sql &gt; alter database add logfile group 3 &apos;+ARCH/testcadb/redolog/redo03.log&apos; size 100M;</span><br><span class="line">打开数据库</span><br><span class="line">sql &gt; alter database open resetlogs;</span><br><span class="line">如果原库版本不一样（源库11.2.0.3目标库11.2.0.4）需要升级数据库</span><br><span class="line">sql &gt; startup mount;</span><br><span class="line">sql &gt; alter database open upgrade;</span><br><span class="line">sql &gt; select status from v$Instance; </span><br><span class="line">sql &gt; @$ORACLE_HOME/rdbms/admin/catupgrd.sql;</span><br></pre></td></tr></table></figure></p>
<p>启动库之后临时表空间是不可用的，需要重新配置临时表空间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select * from dba_temp_files;</span><br><span class="line">select * from dba_temp_files</span><br><span class="line">              *</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01157: cannot identify/lock data file 201 - see DBWR trace file</span><br><span class="line">ORA-01110: data file 201: &apos;/home/oracle/u01/app/oracle/oradata/testcadb/temp01.dbf&apos;</span><br></pre></td></tr></table></figure></p>
<p>更换临时表空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">创建中转临时表空间</span><br><span class="line">sql &gt; create TEMPORARY TABLESPACE TEMP2 TEMPFILE &apos;+DATA1/testcadb/TEMP02.DBF&apos; SIZE 2048M REUSE AUTOEXTEND ON NEXT 640K MAXSIZE 5120M;</span><br><span class="line">切换默认临时表空间</span><br><span class="line">sql &gt; alter database default temporary tablespace temp2; </span><br><span class="line">sql &gt; </span><br><span class="line">sql &gt; drop tablespace temp including contents and datafiles; </span><br><span class="line">sql &gt; create TEMPORARY TABLESPACE TEMP TEMPFILE &apos;+DATA1/testcadb/TEMP01.DBF&apos; SIZE 2048M REUSE AUTOEXTEND ON NEXT 640K MAXSIZE 5120M; </span><br><span class="line">sql &gt; alter database default temporary tablespace temp; </span><br><span class="line">或者 sql &gt; alter user *** temporary tablespace temp;（修改单独某个用户的临时表空间）</span><br><span class="line"></span><br><span class="line">sql &gt; drop tablespace temp2 including contents and datafiles; </span><br><span class="line">sql &gt; select * from v$log;</span><br><span class="line">    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE	  MEMBERS ARCHIV STATUS 			  FIRST_CHANGE# FIRST_TIME	    NEXT_CHANGE# NEXT_TIME</span><br><span class="line">---------- ---------- ---------- ---------- ---------- ---------- ------ -------------------------------- ------------- ------------------- ------------ -------------------</span><br><span class="line">	 1	    1	      25  104857600	   512		1 NO	 INACTIVE			       64817466 2018:12:19 14:19:09	64828852 2018:12:19 14:21:47</span><br><span class="line">	 2	    1	      26  104857600	   512		1 NO	 CURRENT			       64828852 2018:12:19 14:21:47   2.8147E+14</span><br><span class="line">	 3	    1	      24   52428800	   512		1 NO	 INACTIVE			       64807090 2018:12:19 14:18:29	64817466 2018:12:19 14:19:09</span><br></pre></td></tr></table></figure></p>
<p>添加thread 2对应的logfile，用于分配给节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; alter database add logfile thread 2 group 4 &apos;+ARCH/testcadb/redolog/redo04.log&apos; size 100m;</span><br><span class="line">sql &gt; alter database add logfile thread 2 group 5 &apos;+ARCH/testcadb/redolog/redo05.log&apos; size 100m;</span><br><span class="line">sql &gt; alter database add logfile thread 2 group 6 &apos;+ARCH/testcadb/redolog/redo06.log&apos; size 100m;</span><br></pre></td></tr></table></figure></p>
<p>启动thread2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select thread#,status,enabled from v$thread;</span><br><span class="line">   THREAD# STATUS	ENABLED</span><br><span class="line">---------- ------------ ----------------</span><br><span class="line">	 1 OPEN 	PUBLIC</span><br><span class="line">	 2 CLOSED	DISABLED</span><br><span class="line">sql &gt; alter database enable thread 2;</span><br></pre></td></tr></table></figure></p>
<p>配置两个节点信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; alter system set thread=1 scope=spfile sid=&apos;testcadb1&apos;;</span><br><span class="line">sql &gt; alter system set thread=2 scope=spfile sid=&apos;testcadb2&apos;;</span><br><span class="line">sql &gt; alter system set instance_number=1 scope=spfile sid=&apos;testcadb1&apos;;</span><br><span class="line">sql &gt; alter system set instance_number=2 scope=spfile sid=&apos;testcadb2&apos;;</span><br><span class="line">sql &gt; alter system set cluster_database_instances=2 scope=spfile;</span><br><span class="line">sql &gt; alter system set cluster_database=true scope=spfile;</span><br></pre></td></tr></table></figure></p>
<p>为节点2添加undo表空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select substr(file_name,1,60) UNDO_FILES from dba_data_files where tablespace_name = &apos;UNDOTBS1&apos; </span><br><span class="line">sql &gt; create undo tablespace undotbs2 datafile &apos;+data1/testcadb/undotbs02.dbf&apos; size 200M;</span><br><span class="line">sql &gt; alter system set undo_tablespace=&apos;undotbs2&apos; scope=spfile sid=&apos;testcadb2&apos;;</span><br></pre></td></tr></table></figure></p>
<p>关闭节点1并重新启动,如果不重新启动节点1，直接启动节点2报一下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORA-01102: cannot mount database in EXCLUSIVE mode</span><br></pre></td></tr></table></figure></p>
<p>启动节点2（在节点2操作）<br>节点2：注意audit目录是否存在，不存在手动创建一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mkdir -p /u01/app/oracle/admin/testcadb/adump</span><br><span class="line">shell &gt; export ORACLE_SID=testcadb2</span><br><span class="line">shell &gt; sqlplus / as sysdba</span><br><span class="line">sql &gt; startup nomount;</span><br><span class="line">sql &gt; alter database mount;</span><br><span class="line">sql &gt; alter database open;</span><br></pre></td></tr></table></figure></p>
<p>至此数据库已经换成完成，但是恢复的数据库还没有注册到集群管理下</p>
<h4 id="12、将数据库注册到集群下"><a href="#12、将数据库注册到集群下" class="headerlink" title="12、将数据库注册到集群下"></a>12、将数据库注册到集群下</h4><p>在节点1使用oracle用户执行（不要使用grid用户）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 ~]$ srvctl add database -d testcadb -o /u01/app/oracle/product/11.2.0.4/dbhome_1 -p +DATA1/testcadb/spfiletestcadb.ora</span><br><span class="line">[oracle@rac1 ~]$ srvctl add instance -d testcadb -i testcadb1 -n rac1</span><br><span class="line">[oracle@rac1 ~]$ srvctl add instance -d testcadb -i testcadb2 -n rac2</span><br></pre></td></tr></table></figure></p>
<p>重启数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 ~]$ srvctl stop database -d testcadb</span><br><span class="line">#因为启动不是通过srvctl启动的，可能需要进入sqlplus控制台先手动关闭库（两个节点都要运行），然后通过下面命令启动数据库：</span><br><span class="line">[oracle@rac1 ~]$ srvctl start database -d testcadb</span><br></pre></td></tr></table></figure></p>
<h4 id="13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作"><a href="#13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作" class="headerlink" title="13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作"></a>13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; show parameter remote_listener;</span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">remote_listener 		     string	 racscan:1521</span><br><span class="line">#grid用户执行：</span><br><span class="line">shell &gt; lsnrctl status LISTENER_SCAN1</span><br><span class="line">#如果没有注册监听信息，按下面方法配置</span><br><span class="line">alter system set remote_listener = &apos;racscan:1521&apos; sid=&apos;*&apos; scope=both;</span><br><span class="line">alter system register;</span><br><span class="line">lsnrctl status LISTENER_SCAN1</span><br></pre></td></tr></table></figure>
<h4 id="14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题"><a href="#14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题" class="headerlink" title="14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题"></a>14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题</h4><p>查看remote_login_passwordfile设置值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; show parameter remote_login_passwordfile;</span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">remote_login_passwordfile	     string	 EXCLUSIVE</span><br><span class="line"></span><br><span class="line">修改值使用下面方法，修改完成之后，需要重新启动数据库才能生效：</span><br><span class="line">alter system set remote_login_passwordfile=&apos;exclusive&apos; scope=spfile sid=&apos;*&apos;;</span><br></pre></td></tr></table></figure></p>
<p>查看详细的remote_login_passwordfile配置点击<a href="https://zeven0707.github.io/2018/12/21/remote_login_passwordfile&amp;SQLNET.AUTHENTICATION_SERVICES%E5%8F%82%E6%95%B0/" target="_blank" rel="noopener">此处</a><br>remote_login_passwordfile修改完成之后,生成秘钥文件<br>节点1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orapwd file=orapwtestcadb1 password=oracle entries=100</span><br></pre></td></tr></table></figure></p>
<p>节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orapwd file=orapwtestcadb2 password=oracle entries=100</span><br></pre></td></tr></table></figure></p>
<p>现在，数据终于可以正常访问了。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/12/21/单实例rman备份异机恢复到rac环境/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/12/21/remote_login_passwordfile&SQLNET.AUTHENTICATION_SERVICES参数/"><span>[Oracle] remote_login_passwordfile&amp;SQLNET.AUTHENTICATION_SERVICES参数</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/21/remote_login_passwordfile&SQLNET.AUTHENTICATION_SERVICES参数/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-21T02:35:00.000Z">
          2018-12-21
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、remote-login-passwordfile参数"><a href="#1、remote-login-passwordfile参数" class="headerlink" title="1、remote_login_passwordfile参数"></a>1、remote_login_passwordfile参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shared：一个或者多个库都能使用该password file。sys用户不能修改，如果尝试修改sys密码，会提示 &quot;ORA-28046: Password change for SYS disallowed.&quot; ;其他用户有（SYSDBA, SYSOPER, SYSASM, SYSBACKUP, SYSDG, SYSKM）权限的，密码不能更新，如果更新会提示&quot;ORA-01999: password file cannot be updated in SHARED mode.&quot; ;给个别用户授权（SYSDBA, SYSOPER, SYSASM, SYSBACKUP, SYSDG, SYSKM）是不被允许的，否则提示&quot;ORA-01999: password file cannot be updated in SHARED mode.&quot;;如果passwordfile文件不存在，等同于REMOTE_LOGIN_PASSWORDFILE=none.</span><br><span class="line"></span><br><span class="line">exclusive：password file只能被一个库使用，文件可以包含sys和非sys用户。如果password file文件不存在，等同于REMOTE_LOGIN_PASSWORDFILE=none. </span><br><span class="line">remote_login_passwordfile =exclusive时，启用口令文件，允许远程登录；</span><br><span class="line"></span><br><span class="line">none：忽略password file，只能通过本地操作系统验证。</span><br></pre></td></tr></table></figure>
<p>修改值使用下面方法，因为该值为静态参数，修改完成之后，需要重新启动数据库才能生效：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter system set remote_login_passwordfile=&apos;exclusive&apos; scope=spfile sid=&apos;*&apos;;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、SQLNET-AUTHENTICATION-SERVICES参数详解"><a href="#2、SQLNET-AUTHENTICATION-SERVICES参数详解" class="headerlink" title="2、SQLNET.AUTHENTICATION_SERVICES参数详解"></a>2、SQLNET.AUTHENTICATION_SERVICES参数详解</h4><h5 id="2-1、值为none时"><a href="#2-1、值为none时" class="headerlink" title="2.1、值为none时"></a>2.1、值为none时</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#本地验证方式失效</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus / as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line">#使用用户名密码方式登录正常：</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle as sysdba</span><br><span class="line">22:51:21 SYS@ boston&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston</span><br><span class="line">22:52:00 TEST@ boston&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@192.168.168.177:1521/boston.us.oracle.com</span><br><span class="line">22:53:02 TEST@ 192.168.168.177:1521/boston.us.oracle.com&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br></pre></td></tr></table></figure>
<h5 id="2-2、值为all时"><a href="#2-2、值为all时" class="headerlink" title="2.2、值为all时"></a>2.2、值为all时</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">网络服务名方式和service_name方式失效</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus / as sysdba</span><br><span class="line">22:54:21 SYS@ boston&gt; </span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle as sysdba</span><br><span class="line">22:54:45 SYS@ boston&gt; </span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston</span><br><span class="line">ERROR:</span><br><span class="line">ORA-12641: Authentication service failed to initialize</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@192.168.168.177:1521/boston.us.oracle.com</span><br><span class="line">ERROR:</span><br><span class="line">ORA-12641: Authentication service failed to initialize</span><br></pre></td></tr></table></figure>
<h5 id="2-3、如果SQLNET-AUTHENTICATION-SERVICES-none-的情况下-修改remote-login-passwordfile的值从exclusive改为none-重启数据库使其生效-会报错提示权限不足："><a href="#2-3、如果SQLNET-AUTHENTICATION-SERVICES-none-的情况下-修改remote-login-passwordfile的值从exclusive改为none-重启数据库使其生效-会报错提示权限不足：" class="headerlink" title="2.3、如果SQLNET.AUTHENTICATION_SERVICES=(none)的情况下,修改remote_login_passwordfile的值从exclusive改为none,重启数据库使其生效,会报错提示权限不足："></a>2.3、如果SQLNET.AUTHENTICATION_SERVICES=(none)的情况下,修改remote_login_passwordfile的值从exclusive改为none,重启数据库使其生效,会报错提示权限不足：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">22:58:28 SYS@ boston&gt; alter system set remote_login_passwordfile=&apos;NONE&apos; scope=spfile;</span><br><span class="line">System altered.</span><br><span class="line">22:58:47 SYS@ boston&gt; shutdown immediate;</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">22:59:15 SYS@ boston&gt; startup </span><br><span class="line">ORA-01031: insufficient privileges</span><br><span class="line">22:59:34 SYS@ boston&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br><span class="line">尝试重新登录启动数据库</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle  as sysdba</span><br><span class="line">Connected to an idle instance.</span><br><span class="line">22:59:46 SYS@ boston&gt; startup</span><br><span class="line">ORA-01031: insufficient privileges</span><br><span class="line">22:59:48 SYS@ boston&gt; exit</span><br><span class="line">Disconnected</span><br></pre></td></tr></table></figure>
<p>只能禁用sqlnet.ora文件中的SQLNET.AUTHENTICATION_SERVICES=(none)参数，否则无法启动数据库。</p>
<h5 id="2-4、启动数据库之后，再次启用sqlnet-ora文件中的SQLNET-AUTHENTICATION-SERVICES-none-参数，如果在数据库开启的状态下，as-sysdba将无法登录，只能使用网络服务名和service-name登录"><a href="#2-4、启动数据库之后，再次启用sqlnet-ora文件中的SQLNET-AUTHENTICATION-SERVICES-none-参数，如果在数据库开启的状态下，as-sysdba将无法登录，只能使用网络服务名和service-name登录" class="headerlink" title="2.4、启动数据库之后，再次启用sqlnet.ora文件中的SQLNET.AUTHENTICATION_SERVICES=(none)参数，如果在数据库开启的状态下，as sysdba将无法登录，只能使用网络服务名和service_name登录"></a>2.4、启动数据库之后，再次启用sqlnet.ora文件中的SQLNET.AUTHENTICATION_SERVICES=(none)参数，如果在数据库开启的状态下，as sysdba将无法登录，只能使用网络服务名和service_name登录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">oracle@dax-mysql-slave admin]$ sqlplus / as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston</span><br><span class="line">10:13:30 TEST@ boston&gt; exit</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@192.168.168.177:1521/boston.us.oracle.com</span><br><span class="line">10:16:49 TEST@ 192.168.168.177:1521/boston.us.oracle.com&gt; select * from user_role_privs;</span><br><span class="line"></span><br><span class="line">USERNAME		       GRANTED_ROLE		      ADM DEF OS_</span><br><span class="line">------------------------------ ------------------------------ --- --- ---</span><br><span class="line">TEST			       CONNECT			      NO  YES NO</span><br><span class="line">TEST			       DBA			          NO  YES NO</span><br><span class="line">TEST			       RESOURCE 		      NO  YES NO</span><br><span class="line">Elapsed: 00:00:00.02</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/12/21/remote_login_passwordfile&SQLNET.AUTHENTICATION_SERVICES参数/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/12/17/zabbix监控域名证书过期时间/"><span>[Zabbix] zabbix监控域名证书过期时间</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/17/zabbix监控域名证书过期时间/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-17T08:32:24.000Z">
          2018-12-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、编辑脚本"><a href="#1、编辑脚本" class="headerlink" title="1、编辑脚本"></a>1、编辑脚本</h4><p>more /usr/local/zabbix/script/check_sslcert_expire_script.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#传入第一参数指定输入的域名</span><br><span class="line">domain=$1</span><br><span class="line">#传入的第二个参数指定https的端口</span><br><span class="line">port=$2</span><br><span class="line">#获取证书到期时间</span><br><span class="line">expired_date=`echo |openssl s_client -servername $&#123;domain&#125; -connect $&#123;domain&#125;:$&#123;port&#125; 2&gt;/dev/null | openssl x509 -noout -dates |sed -n &apos;s/notAfter=//p&apos;`</span><br><span class="line">#$&#123;expired_date&#125;参数一定要加上双引号，否则按多个参数处理</span><br><span class="line">#与当前系统日期时间做对比，查看证书过期时间</span><br><span class="line">if [ -n &quot;$&#123;expired_date&#125;&quot; ];then</span><br><span class="line">    expired_seconds=`date &apos;+%s&apos; --date &quot;$&#123;expired_date&#125;&quot;`</span><br><span class="line">    now_seconds=`date &apos;+%s&apos;`</span><br><span class="line">    echo &quot;($&#123;expired_seconds&#125;-$&#123;now_seconds&#125;)/24/3600&quot; | bc</span><br><span class="line">else</span><br><span class="line">  :</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<h4 id="2、修改zabbix-agentd-conf配置文件，添加下面一行"><a href="#2、修改zabbix-agentd-conf配置文件，添加下面一行" class="headerlink" title="2、修改zabbix_agentd.conf配置文件，添加下面一行"></a>2、修改zabbix_agentd.conf配置文件，添加下面一行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserParameter=check_ssl_cert_expire[*],sh /usr/local/zabbix/script/check_sslcert_expire_script.sh  $1 $2</span><br></pre></td></tr></table></figure>
<p>重新启动agent</p>
<h4 id="3、检查获取参数是否正常"><a href="#3、检查获取参数是否正常" class="headerlink" title="3、检查获取参数是否正常"></a>3、检查获取参数是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zabbix/bin/zabbix_get -s 127.0.0.1 -p 10050 -k check_ssl_cert_expire[www.baidu.com,443]</span><br><span class="line">159</span><br><span class="line">/usr/local/zabbix/bin/zabbix_get -s 127.0.0.1 -p 10050 -k check_ssl_cert_expire[www.masterdax.com,443]</span><br><span class="line">85</span><br></pre></td></tr></table></figure>
<h4 id="4、打开zabbix-web控制台添加模板，监控项"><a href="#4、打开zabbix-web控制台添加模板，监控项" class="headerlink" title="4、打开zabbix,web控制台添加模板，监控项"></a>4、打开zabbix,web控制台添加模板，监控项</h4><p><img src="https://i.imgur.com/jtLWcW3.png" alt=""><br>设置触发器，证书到期时触发报警<br><img src="https://i.imgur.com/OB8yEPD.png" alt=""></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/12/17/zabbix监控域名证书过期时间/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/12/17/oracle安装rlwrap/"><span>[Oracle] 为oracle-sqlplus安装rlwrap</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/17/oracle安装rlwrap/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-17T07:49:00.000Z">
          2018-12-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、安装rlwrap-0-42-1-1-x86-64-rpm方式"><a href="#1、安装rlwrap-0-42-1-1-x86-64-rpm方式" class="headerlink" title="1、安装rlwrap-0.42-1.1.x86_64.rpm方式"></a>1、安装rlwrap-0.42-1.1.x86_64.rpm方式</h4><p>下载rlwrap-0.42-1.1.x86_64.rpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/Ledest%3A/misc/CentOS_7/src/rlwrap-0.42-1.1.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h4 id="2、安装rlwarp"><a href="#2、安装rlwarp" class="headerlink" title="2、安装rlwarp"></a>2、安装rlwarp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall rlwrap-0.42-1.1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h4 id="3、修改环境变量文件"><a href="#3、修改环境变量文件" class="headerlink" title="3、修改环境变量文件"></a>3、修改环境变量文件</h4><p>grep ‘rlwrap’ ~/.bash_profile<br>alias sql=’rlwrap sqlplus “/ as sysdba”‘<br>alias rman=’rlwrap rman’</p>
<h4 id="4、如果找不到x86-64类型的文件，下载-rlwrap-0-42-1-1-src-rpm"><a href="#4、如果找不到x86-64类型的文件，下载-rlwrap-0-42-1-1-src-rpm" class="headerlink" title="4、如果找不到x86_64类型的文件，下载 rlwrap-0.42-1.1.src.rpm"></a>4、如果找不到x86_64类型的文件，下载 rlwrap-0.42-1.1.src.rpm</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/Ledest%3A/misc/CentOS_7/src/rlwrap-0.42-1.1.src.rpm</span><br></pre></td></tr></table></figure>
<h4 id="5、安装依赖"><a href="#5、安装依赖" class="headerlink" title="5、安装依赖"></a>5、安装依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install rpm-build -y</span><br><span class="line">yum install readline* libtermcap-devel* -y</span><br></pre></td></tr></table></figure>
<h4 id="6、安装rlwarp"><a href="#6、安装rlwarp" class="headerlink" title="6、安装rlwarp"></a>6、安装rlwarp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; rpm -i rlwrap-0.42-1.1.src.rpm </span><br><span class="line">warning: rlwrap-0.42-1.1.src.rpm: Header V3 RSA/SHA1 Signature, key ID 93680782: NOKEY</span><br><span class="line"></span><br><span class="line">shell &gt; cd rpmbuild/SOURCES</span><br><span class="line">shell &gt; tar -zxvf rlwrap-0.42.tar.gz </span><br><span class="line">shell &gt; cd rlwrap-0.42</span><br><span class="line">shell &gt; ls</span><br><span class="line">aclocal.m4  BUGS       completions  configure     COPYING  filters  Makefile.am  NEWS  README  test  tools</span><br><span class="line">AUTHORS     ChangeLog  config.h.in  configure.ac  doc      INSTALL  Makefile.in  PLEA  src     TODO</span><br><span class="line"></span><br><span class="line">shell &gt; ./configure</span><br><span class="line">shell &gt; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">#### 7、之后修改环境变量</span><br></pre></td></tr></table></figure>
<p>grep ‘rlwrap’ ~/.bash_profile<br>alias sql=’rlwrap sqlplus “/ as sysdba”‘<br>alias rman=’rlwrap rman’<br><code>`</code></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/12/17/oracle安装rlwrap/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/12/17/centos7安装rac报错ohasd failed to start/"><span>[Oracle] centos7安装rac报错ohasd failed to start</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/17/centos7安装rac报错ohasd failed to start/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-17T07:41:00.000Z">
          2018-12-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、具体报错信息"><a href="#1、具体报错信息" class="headerlink" title="1、具体报错信息"></a>1、具体报错信息</h4><p>安装完成grid之后，在执行/u01/app/11.2.0.4/grid/root.sh命令时报以下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ohasd failed to start</span><br><span class="line">Failed to start the Clusterware. Last 20 lines of the alert log follow</span><br></pre></td></tr></table></figure></p>
<h4 id="2、单独在linux-7中为ohasd设置一个服务。"><a href="#2、单独在linux-7中为ohasd设置一个服务。" class="headerlink" title="2、单独在linux 7中为ohasd设置一个服务。"></a>2、单独在linux 7中为ohasd设置一个服务。</h4><p>1、创建服务ohas.service的服务文件并赋予权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /usr/lib/systemd/system/ohas.service</span><br><span class="line">chmod 777 /usr/lib/systemd/system/ohas.service</span><br></pre></td></tr></table></figure></p>
<p>2、往ohas.service服务文件添加启动ohasd的相关信息<br>vi /usr/lib/systemd/system/ohas.service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Oracle High Availability Services</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/etc/init.d/init.ohasd run &gt;/dev/null 2&gt;&amp;1 Type=simple</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>3、重新加载守护进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure></p>
<p>设置守护进程自动启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ohas.service</span><br></pre></td></tr></table></figure></p>
<p>手工启动ohas服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ohas.service</span><br></pre></td></tr></table></figure></p>
<p>4、重新运行root.sh脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh root.sh</span><br></pre></td></tr></table></figure></p>
<p>5：查看ohas服务状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status ohas.service</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/12/17/centos7安装rac报错ohasd failed to start/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/12/17/oracle udev配置/"><span>[Oracle] oracle udev配置</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/12/17/oracle udev配置/" rel="bookmark">
        <time class="entry-date published" datetime="2018-12-17T07:40:00.000Z">
          2018-12-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、添加裸设备"><a href="#1、添加裸设备" class="headerlink" title="1、添加裸设备"></a>1、添加裸设备</h4><p>增加磁盘vda,vdb,vdc<br>在节点1上分别对vda，vdb，vdc三块盘分区<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/vda</span><br><span class="line">fdisk /dev/vdb</span><br><span class="line">fdisk /dev/vdc</span><br></pre></td></tr></table></figure></p>
<p>节点1查看设备信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 ~]# ll /dev/vd*</span><br><span class="line">brw-rw---- 1 root disk 252,  0 Dec 14 10:56 /dev/vda</span><br><span class="line">brw-rw---- 1 root disk 252,  1 Dec 14 10:56 /dev/vda1</span><br><span class="line">brw-rw---- 1 root disk 252,  2 Dec 14 10:56 /dev/vda2</span><br><span class="line">brw-rw---- 1 root disk 252, 16 Dec 14 11:41 /dev/vdb</span><br><span class="line">brw-rw---- 1 root disk 252, 17 Dec 14 11:41 /dev/vdb1</span><br><span class="line">brw-rw---- 1 root disk 252, 32 Dec 14 11:34 /dev/vdc</span><br><span class="line">brw-rw---- 1 root disk 252, 33 Dec 14 11:34 /dev/vdc1</span><br><span class="line">brw-rw---- 1 root disk 252, 48 Dec 14 11:34 /dev/vdd</span><br><span class="line">brw-rw---- 1 root disk 252, 49 Dec 14 11:34 /dev/vdd1</span><br></pre></td></tr></table></figure></p>
<p>节点2查看设备信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@rac2 ~]# ll /dev/vd*</span><br><span class="line">brw-rw---- 1 root disk 252,  0 Dec 14 10:56 /dev/vda</span><br><span class="line">brw-rw---- 1 root disk 252,  1 Dec 14 10:56 /dev/vda1</span><br><span class="line">brw-rw---- 1 root disk 252,  2 Dec 14 10:56 /dev/vda2</span><br><span class="line">brw-rw---- 1 root disk 252, 16 Dec 14 10:56 /dev/vdb</span><br><span class="line">brw-rw---- 1 root disk 252, 32 Dec 14 10:56 /dev/vdc</span><br><span class="line">brw-rw---- 1 root disk 252, 48 Dec 14 10:56 /dev/vdd</span><br></pre></td></tr></table></figure></p>
<p>major device number可以看作是设备驱动程序，被同一设备驱动程序管理的设备有相同的major device number.这个数字实际是Kernel中device driver table 的索引，这个表保存着不同设备驱动程序。（kvm虚拟机virto的驱动对应的major device number值为252，scsi的驱动对应的major device number值为8，裸设备为162）<br>minor device number用来代表被访问的具体设备。就是说Kernel根据major device number 找到设备驱动程序，然后再从minor device number 获得设备位置等属性。</p>
<h4 id="2、修改配置文件"><a href="#2、修改配置文件" class="headerlink" title="2、修改配置文件"></a>2、修改配置文件</h4><p>节点1<br>vim /etc/udev/rules.d/60-raw.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdb1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;17&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdc1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;33&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdd1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;49&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %M %m&quot;</span><br><span class="line"></span><br><span class="line">KERNEL==&quot;raw[1-3]&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;640&quot;</span><br></pre></td></tr></table></figure></p>
<p>节点2<br>vim /etc/udev/rules.d/60-raw.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdb1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;17&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdc1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;33&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdd1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;49&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %M %m&quot;</span><br><span class="line"></span><br><span class="line">KERNEL==&quot;raw[1-3]&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;640&quot;</span><br></pre></td></tr></table></figure></p>
<p>上述操作需要在双节点执行！且确保在双节点均可以看到裸设备文件，以及grid(或者oracle)用户具有对裸设备的权限</p>
<h4 id="3、启动udev"><a href="#3、启动udev" class="headerlink" title="3、启动udev"></a>3、启动udev</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">centos6使用start_udev</span><br><span class="line"></span><br><span class="line">centos7之后使用</span><br><span class="line">/sbin/udevadm control --reload-rules</span><br><span class="line">/sbin/udevadm trigger</span><br><span class="line">或者</span><br><span class="line">/sbin/udevadm trigger --type=devices --action=change</span><br><span class="line">查看设备状态：</span><br><span class="line">ll /dev/raw/raw*</span><br><span class="line">在配置过程中，启动udev之后没有看到设备，重启服务器后才生效。</span><br></pre></td></tr></table></figure>
<h4 id="4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘："><a href="#4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘：" class="headerlink" title="4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘："></a>4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘：</h4><p>添加sda，sdb，sdc三块盘，获取共享磁盘的uuid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 ~]# /usr/lib/udev/scsi_id -g -u /dev/sda</span><br><span class="line">0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0</span><br><span class="line">[root@rac1 ~]# /usr/lib/udev/scsi_id -g -u /dev/sdb</span><br><span class="line">0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2</span><br><span class="line">[root@rac1 ~]# /usr/lib/udev/scsi_id -g -u /dev/sdc</span><br><span class="line">0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1</span><br></pre></td></tr></table></figure></p>
<h4 id="5、按以下格式写入-etc-udev-rules-d-99-my-asmdevices-rules-文件，每个设备一行，中间不允许换行"><a href="#5、按以下格式写入-etc-udev-rules-d-99-my-asmdevices-rules-文件，每个设备一行，中间不允许换行" class="headerlink" title="5、按以下格式写入[/etc/udev/rules.d/99-my-asmdevices.rules]文件，每个设备一行，中间不允许换行"></a>5、按以下格式写入[/etc/udev/rules.d/99-my-asmdevices.rules]文件，每个设备一行，中间不允许换行</h4><p>节点1：<br>vim /etc/udev/rules.d/99-my-asmdevices.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-vote b  $major $minor; chown grid:asmadmin /dev/asmdisk-vote; chmod 0660 /dev/asmdisk-vote&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-arch b  $major $minor; chown grid:asmadmin /dev/asmdisk-arch; chmod 0660 /dev/asmdisk-arch&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-data b  $major $minor; chown grid:asmadmin /dev/asmdisk-data; chmod 0660 /dev/asmdisk-data&apos;&quot;</span><br></pre></td></tr></table></figure></p>
<p>节点2：<br>vim /etc/udev/rules.d/99-my-asmdevices.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-vote b  $major $minor; chown grid:asmadmin /dev/asmdisk-vote; chmod 0660 /dev/asmdisk-vote&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-arch b  $major $minor; chown grid:asmadmin /dev/asmdisk-arch; chmod 0660 /dev/asmdisk-arch&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-data b  $major $minor; chown grid:asmadmin /dev/asmdisk-data; chmod 0660 /dev/asmdisk-data&apos;&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="6、启动udev"><a href="#6、启动udev" class="headerlink" title="6、启动udev"></a>6、启动udev</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">centos6使用start_udev</span><br><span class="line"></span><br><span class="line">centos7之后使用</span><br><span class="line">/sbin/udevadm control --reload-rules</span><br><span class="line">/sbin/udevadm trigger</span><br><span class="line">或者</span><br><span class="line">/sbin/udevadm trigger --type=devices --action=change</span><br></pre></td></tr></table></figure>
<p>查看设备状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 ~]# ll /dev/asmdisk-*</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 16 Dec 14 14:18 /dev/asmdisk-arch</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 32 Dec 14 14:18 /dev/asmdisk-data</span><br><span class="line">brw-rw---- 1 grid asmadmin 8,  0 Dec 14 14:18 /dev/asmdisk-vote</span><br></pre></td></tr></table></figure></p>
<h4 id="7、使用udevadm查看设备信息"><a href="#7、使用udevadm查看设备信息" class="headerlink" title="7、使用udevadm查看设备信息"></a>7、使用udevadm查看设备信息</h4><p>udevadm info -a -p /sys/block/sda<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">Udevadm info starts with the device specified by the devpath and then</span><br><span class="line">walks up the chain of parent devices. It prints for every device</span><br><span class="line">found, all possible attributes in the udev rules key format.</span><br><span class="line">A rule to match, can be composed by the attributes of the device</span><br><span class="line">and the attributes from one single parent device.</span><br><span class="line"></span><br><span class="line">  looking at device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2/target2:0:0/2:0:0:0/block/sda&apos;:</span><br><span class="line">    KERNEL==&quot;sda&quot;</span><br><span class="line">    SUBSYSTEM==&quot;block&quot;</span><br><span class="line">    DRIVER==&quot;&quot;</span><br><span class="line">    ATTR&#123;ro&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;size&#125;==&quot;41943040&quot;</span><br><span class="line">    ATTR&#123;stat&#125;==&quot;  521604        4   820941  5583621   355886     1462  1263929  7839050        0  9373468 13420933&quot;</span><br><span class="line">    ATTR&#123;range&#125;==&quot;16&quot;</span><br><span class="line">    ATTR&#123;discard_alignment&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;events&#125;==&quot;&quot;</span><br><span class="line">    ATTR&#123;ext_range&#125;==&quot;256&quot;</span><br><span class="line">    ATTR&#123;events_poll_msecs&#125;==&quot;-1&quot;</span><br><span class="line">    ATTR&#123;alignment_offset&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;inflight&#125;==&quot;       0        0&quot;</span><br><span class="line">    ATTR&#123;removable&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;capability&#125;==&quot;50&quot;</span><br><span class="line">    ATTR&#123;events_async&#125;==&quot;&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2/target2:0:0/2:0:0:0&apos;:</span><br><span class="line">    KERNELS==&quot;2:0:0:0&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;scsi&quot;</span><br><span class="line">    DRIVERS==&quot;sd&quot;</span><br><span class="line">    ATTRS&#123;rev&#125;==&quot;1.5.&quot;</span><br><span class="line">    ATTRS&#123;type&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;scsi_level&#125;==&quot;6&quot;</span><br><span class="line">    ATTRS&#123;model&#125;==&quot;QEMU HARDDISK   &quot;</span><br><span class="line">    ATTRS&#123;state&#125;==&quot;running&quot;</span><br><span class="line">    ATTRS&#123;unpriv_sgio&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;queue_type&#125;==&quot;none&quot;</span><br><span class="line">    ATTRS&#123;iodone_cnt&#125;==&quot;0xd660c&quot;</span><br><span class="line">    ATTRS&#123;iorequest_cnt&#125;==&quot;0xd664c&quot;</span><br><span class="line">    ATTRS&#123;device_busy&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_capacity_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;timeout&#125;==&quot;30&quot;</span><br><span class="line">    ATTRS&#123;evt_media_change&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;ioerr_cnt&#125;==&quot;0x18&quot;</span><br><span class="line">    ATTRS&#123;queue_depth&#125;==&quot;128&quot;</span><br><span class="line">    ATTRS&#123;vendor&#125;==&quot;QEMU    &quot;</span><br><span class="line">    ATTRS&#123;evt_soft_threshold_reached&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;device_blocked&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_mode_parameter_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_lun_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_inquiry_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;dh_state&#125;==&quot;detached&quot;</span><br><span class="line">    ATTRS&#123;iocounterbits&#125;==&quot;32&quot;</span><br><span class="line">    ATTRS&#123;inquiry&#125;==&quot;&quot;</span><br><span class="line">    ATTRS&#123;vpd_pg83&#125;==&quot;&quot;</span><br><span class="line">    ATTRS&#123;eh_timeout&#125;==&quot;10&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2/target2:0:0&apos;:</span><br><span class="line">    KERNELS==&quot;target2:0:0&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;scsi&quot;</span><br><span class="line">    DRIVERS==&quot;&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2&apos;:</span><br><span class="line">    KERNELS==&quot;host2&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;scsi&quot;</span><br><span class="line">    DRIVERS==&quot;&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5&apos;:</span><br><span class="line">    KERNELS==&quot;virtio5&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;virtio&quot;</span><br><span class="line">    DRIVERS==&quot;virtio_scsi&quot;</span><br><span class="line">    ATTRS&#123;device&#125;==&quot;0x0008&quot;</span><br><span class="line">    ATTRS&#123;features&#125;==&quot;0110000000000000000000000000110000000000000000000000000000000000&quot;</span><br><span class="line">    ATTRS&#123;status&#125;==&quot;0x00000007&quot;</span><br><span class="line">    ATTRS&#123;vendor&#125;==&quot;0x1af4&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0&apos;:</span><br><span class="line">    KERNELS==&quot;0000:00:0d.0&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;pci&quot;</span><br><span class="line">    DRIVERS==&quot;virtio-pci&quot;</span><br><span class="line">    ATTRS&#123;irq&#125;==&quot;10&quot;</span><br><span class="line">    ATTRS&#123;subsystem_vendor&#125;==&quot;0x1af4&quot;</span><br><span class="line">    ATTRS&#123;broken_parity_status&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;class&#125;==&quot;0x010000&quot;</span><br><span class="line">    ATTRS&#123;driver_override&#125;==&quot;(null)&quot;</span><br><span class="line">    ATTRS&#123;consistent_dma_mask_bits&#125;==&quot;64&quot;</span><br><span class="line">    ATTRS&#123;dma_mask_bits&#125;==&quot;64&quot;</span><br><span class="line">    ATTRS&#123;local_cpus&#125;==&quot;ff&quot;</span><br><span class="line">    ATTRS&#123;device&#125;==&quot;0x1004&quot;</span><br><span class="line">    ATTRS&#123;enable&#125;==&quot;1&quot;</span><br><span class="line">    ATTRS&#123;msi_bus&#125;==&quot;&quot;</span><br><span class="line">    ATTRS&#123;local_cpulist&#125;==&quot;0-7&quot;</span><br><span class="line">    ATTRS&#123;vendor&#125;==&quot;0x1af4&quot;</span><br><span class="line">    ATTRS&#123;subsystem_device&#125;==&quot;0x0008&quot;</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;-1&quot;</span><br><span class="line">    ATTRS&#123;d3cold_allowed&#125;==&quot;0&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00&apos;:</span><br><span class="line">    KERNELS==&quot;pci0000:00&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;&quot;</span><br><span class="line">    DRIVERS==&quot;&quot;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/12/17/oracle udev配置/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/30/mysql-AUTO_INCREMENT参数详解/"><span>[Mysql] mysql-AUTO_INCREMENT参数详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/30/mysql-AUTO_INCREMENT参数详解/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-30T09:03:00.000Z">
          2018-11-30
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、auto-increment的性质就是为新行生成一个唯一标识-例如"><a href="#1、auto-increment的性质就是为新行生成一个唯一标识-例如" class="headerlink" title="1、auto_increment的性质就是为新行生成一个唯一标识,例如"></a>1、auto_increment的性质就是为新行生成一个唯一标识,例如</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建测试表</span><br><span class="line">  CREATE TABLE animals (</span><br><span class="line">     id MEDIUMINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">     name CHAR(30) NOT NULL,</span><br><span class="line">     PRIMARY KEY (id)</span><br><span class="line">);</span><br><span class="line">#插入测试数据:</span><br><span class="line">INSERT INTO animals (name) VALUES</span><br><span class="line">    (&apos;dog&apos;),(&apos;cat&apos;),(&apos;penguin&apos;),</span><br><span class="line">    (&apos;lax&apos;),(&apos;whale&apos;),(&apos;ostrich&apos;);</span><br><span class="line">#查看测试结果：</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h4 id="2、上面的auto-increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql-mode中no-auto-value-on-zero被启用时，如果auto-increment列被指定为0，则该值按0处理。"><a href="#2、上面的auto-increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql-mode中no-auto-value-on-zero被启用时，如果auto-increment列被指定为0，则该值按0处理。" class="headerlink" title="2、上面的auto_increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql_mode中no_auto_value_on_zero被启用时，如果auto_increment列被指定为0，则该值按0处理。"></a>2、上面的auto_increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql_mode中no_auto_value_on_zero被启用时，如果auto_increment列被指定为0，则该值按0处理。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#查看sql_mode模式</span><br><span class="line">show variables like &apos;%sql_mode%&apos;;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                  |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line">#插入数据</span><br><span class="line">insert into animals(id,name) values(0,&apos;pig&apos;);</span><br><span class="line">insert into animals(id,name) values(null,&apos;monkey&apos;);</span><br><span class="line"> [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">|  7 | pig     |</span><br><span class="line">|  8 | monkey  |</span><br><span class="line">+----+---------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line">#自动序列依次递增</span><br><span class="line">#修改sql_mode模式</span><br><span class="line">set @@sql_mode=&apos;NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br><span class="line">show variables like &apos;%sql_mode%&apos;;</span><br><span class="line">+---------------+----------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                                        |</span><br><span class="line">+---------------+----------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+----------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#再次插入数据</span><br><span class="line">insert into animals(id,name) values(0,&apos;lion&apos;);</span><br><span class="line">insert into animals(id,name) values(null,&apos;tiger&apos;);</span><br><span class="line">root@db 01:38:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  0 | lion    |</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">|  7 | pig     |</span><br><span class="line">|  8 | monkey  |</span><br><span class="line">|  9 | tiger   |</span><br><span class="line">+----+---------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>当sql_mode中NO_AUTO_VALUE_ON_ZERO为启用状态，插入的数值为0时，按0处理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#再次插入数据提示主键重复。</span><br><span class="line">root@db 01:41:  [aaaa]&gt; insert into animals(id,name) values(0,&apos;giraffe&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;0&apos; for key &apos;PRIMARY&apos;</span><br><span class="line"></span><br><span class="line">#修改sql_mode为原来配置</span><br><span class="line">set @@sql_mode=&apos;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br><span class="line">show variables like &apos;%sql_mode%&apos;;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                  |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto-increment对应列的最大值开始，例如："><a href="#3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto-increment对应列的最大值开始，例如：" class="headerlink" title="3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto_increment对应列的最大值开始，例如："></a>3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto_increment对应列的最大值开始，例如：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO animals (id,name) VALUES(100,&apos;rabbit&apos;);</span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;mouse&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+---------+</span><br><span class="line">| id  | name    |</span><br><span class="line">+-----+---------+</span><br><span class="line">|   0 | lion    |</span><br><span class="line">|   1 | dog     |</span><br><span class="line">|   2 | cat     |</span><br><span class="line">|   3 | penguin |</span><br><span class="line">|   4 | lax     |</span><br><span class="line">|   5 | whale   |</span><br><span class="line">|   6 | ostrich |</span><br><span class="line">|   7 | pig     |</span><br><span class="line">|   8 | monkey  |</span><br><span class="line">|   9 | tiger   |</span><br><span class="line">| 100 | rabbit  |</span><br><span class="line">| 101 | mouse   |</span><br><span class="line">+-----+---------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>当手动插入id为100的值之后，再次默认插入自动增长的值变为101。测试插入位于最小值和最大值之间的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO animals (id,name) VALUES(50,&apos;giraffe&apos;);</span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;tortoise&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   2 | cat      |</span><br><span class="line">|   3 | penguin  |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">+-----+----------+</span><br><span class="line">14 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>手动插入位于最小值和最大值之间的值，对生成的序列值没有任何影响。</p>
<h4 id="4、更新innodb类型的表中auto-increment的列值，不会重置auto-increment序列，但是myisam和ndb类型的表会重置。"><a href="#4、更新innodb类型的表中auto-increment的列值，不会重置auto-increment序列，但是myisam和ndb类型的表会重置。" class="headerlink" title="4、更新innodb类型的表中auto_increment的列值，不会重置auto_increment序列，但是myisam和ndb类型的表会重置。"></a>4、更新innodb类型的表中auto_increment的列值，不会重置auto_increment序列，但是myisam和ndb类型的表会重置。</h4><p>先以innodb类型表为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">#更新了auto_increment中列的值小于当前最大值</span><br><span class="line">update animals set id=10 where id=2;</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   3 | penguin  |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">+-----+----------+</span><br><span class="line">14 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;donkey&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   3 | penguin  |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">+-----+----------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#更新了auto_increment中列的值大于当前最大值</span><br><span class="line">update animals set id=110 where id=3;</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">| 110 | penguin  |</span><br><span class="line">+-----+----------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line"> SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">| 104 | cow      |</span><br><span class="line">| 110 | penguin  |</span><br><span class="line">+-----+----------+</span><br><span class="line">16 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>auto_increment序列值没有更新，这里面有个大坑，随着序列不断增长，当增长到110是，就会报逐渐重复的错误了，因此自动增长列中的值不要更改。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root@db 02:33:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;110&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">| 104 | cow      |</span><br><span class="line">| 105 | cow      |</span><br><span class="line">| 106 | cow      |</span><br><span class="line">| 107 | cow      |</span><br><span class="line">| 108 | cow      |</span><br><span class="line">| 109 | cow      |</span><br><span class="line">| 110 | penguin  |</span><br><span class="line">| 111 | cow      |</span><br><span class="line">+-----+----------+</span><br><span class="line">22 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>下面以myisam类型表为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#创建测试表</span><br><span class="line">CREATE TABLE animals_myisam (</span><br><span class="line">    id MEDIUMINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name CHAR(30) NOT NULL,</span><br><span class="line">    PRIMARY KEY (id)</span><br><span class="line">) ENGINE=MyISAM;</span><br><span class="line">#插入测试数据</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES</span><br><span class="line">    (&apos;dog&apos;),(&apos;cat&apos;),</span><br><span class="line">    (&apos;penguin&apos;),(&apos;lax&apos;),(&apos;whale&apos;),</span><br><span class="line">    (&apos;ostrich&apos;);</span><br><span class="line"></span><br><span class="line">SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line">#更新了auto_increment中列的值小于当前最大值</span><br><span class="line">update animals_myisam set id=10 where id=3;</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES (&apos;mouse&apos;);</span><br><span class="line">SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">| 10 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">| 11 | mouse   |</span><br><span class="line">+----+---------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">update animals_myisam set id=8 where id=4;</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES (&apos;donkey&apos;);</span><br><span class="line">root@db 03:51:  [aaaa]&gt; SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">| 10 | penguin |</span><br><span class="line">|  8 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">| 11 | mouse   |</span><br><span class="line">| 12 | donkey  |</span><br><span class="line">+----+---------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line">#更新了auto_increment中列的值大于当前最大值</span><br><span class="line">update animals_myisam set id=51 where id=4;</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES (&apos;horse&apos;);</span><br><span class="line">root@db 02:41:  [aaaa]&gt; SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">| 10 | penguin |</span><br><span class="line">| 51 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">| 11 | mouse   |</span><br><span class="line">| 52 | horse   |</span><br><span class="line">+----+---------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>对于myisam类型的表，当对auto_increment列更新时，无论更新后的值大于或者小于当前自增列的值，都按当前列的最大值处理。</p>
<h4 id="5、可以通过mysql函数last-insert-id查看最后插入的值："><a href="#5、可以通过mysql函数last-insert-id查看最后插入的值：" class="headerlink" title="5、可以通过mysql函数last_insert_id查看最后插入的值："></a>5、可以通过mysql函数last_insert_id查看最后插入的值：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select last_insert_id();</span><br><span class="line">+------------------+</span><br><span class="line">| last_insert_id() |</span><br><span class="line">+------------------+</span><br><span class="line">|               53 |</span><br><span class="line">+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h4 id="6、当auto-increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607"><a href="#6、当auto-increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607" class="headerlink" title="6、当auto_increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607"></a>6、当auto_increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO animals (id,name) VALUES(8388606,&apos;whale&apos;);</span><br><span class="line">root@db 02:54:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;elephant&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:55:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8388607&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 02:55:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8388607&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 02:55:  [aaaa]&gt;  SELECT * FROM animals;</span><br><span class="line">+---------+----------+</span><br><span class="line">| id      | name     |</span><br><span class="line">+---------+----------+</span><br><span class="line">|       0 | lion     |</span><br><span class="line">|       1 | dog      |</span><br><span class="line">|       4 | lax      |</span><br><span class="line">|       5 | whale    |</span><br><span class="line">|       6 | ostrich  |</span><br><span class="line">|       7 | pig      |</span><br><span class="line">|       8 | monkey   |</span><br><span class="line">|       9 | tiger    |</span><br><span class="line">|      10 | cat      |</span><br><span class="line">|      50 | giraffe  |</span><br><span class="line">|     100 | rabbit   |</span><br><span class="line">|     101 | mouse    |</span><br><span class="line">|     102 | tortoise |</span><br><span class="line">|     103 | donkey   |</span><br><span class="line">|     104 | cow      |</span><br><span class="line">|     105 | cow      |</span><br><span class="line">|     106 | cow      |</span><br><span class="line">|     107 | cow      |</span><br><span class="line">|     108 | cow      |</span><br><span class="line">|     109 | cow      |</span><br><span class="line">|     110 | penguin  |</span><br><span class="line">|     111 | cow      |</span><br><span class="line">| 8388606 | whale    |</span><br><span class="line">| 8388607 | elephant |</span><br><span class="line">+---------+----------+</span><br></pre></td></tr></table></figure>
<p>当插入的值达到8388607值时，没有办法再插入数据了，这时需要修改数据类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">alter table animals modify id int(10) NOT NULL AUTO_INCREMENT;</span><br><span class="line">INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">root@db 02:57:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 02:58:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+---------+------------+</span><br><span class="line">| id      | name       |</span><br><span class="line">+---------+------------+</span><br><span class="line">|       0 | lion       |</span><br><span class="line">|       1 | dog        |</span><br><span class="line">|       4 | lax        |</span><br><span class="line">|       5 | whale      |</span><br><span class="line">|       6 | ostrich    |</span><br><span class="line">|       7 | pig        |</span><br><span class="line">|       8 | monkey     |</span><br><span class="line">|       9 | tiger      |</span><br><span class="line">|      10 | cat        |</span><br><span class="line">|      50 | giraffe    |</span><br><span class="line">|     100 | rabbit     |</span><br><span class="line">|     101 | mouse      |</span><br><span class="line">|     102 | tortoise   |</span><br><span class="line">|     103 | donkey     |</span><br><span class="line">|     104 | cow        |</span><br><span class="line">|     105 | cow        |</span><br><span class="line">|     106 | cow        |</span><br><span class="line">|     107 | cow        |</span><br><span class="line">|     108 | cow        |</span><br><span class="line">|     109 | cow        |</span><br><span class="line">|     110 | penguin    |</span><br><span class="line">|     111 | cow        |</span><br><span class="line">| 8388606 | whale      |</span><br><span class="line">| 8388607 | elephant   |</span><br><span class="line">| 8388608 | rhinoceros |</span><br><span class="line">+---------+------------+</span><br></pre></td></tr></table></figure></p>
<p>修改完成之后，再次插入成功,下面是关于数据类型的最小值和最大值的对比<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Type   Storage(Bytes) MinimumValueSigned	MinimumValueUnsigned MaximumValueSigned	MaximumValueUnsigned</span><br><span class="line">TINYINT	    1	           -128	                   0	                127	              255</span><br><span class="line">SMALLINT	2	           -32768	               0	                32767	          65535</span><br><span class="line">MEDIUMINT	3	           -8388608	               0	                8388607	          16777215</span><br><span class="line">INT	        4	           -2147483648	           0	               2147483647	      4294967295</span><br><span class="line">BIGINT	    8	           -2^63	               0	                2^63-1	          2^64-1</span><br></pre></td></tr></table></figure></p>
<h4 id="7、想要修改auto-increment的起始值，可以找alter-table，比如："><a href="#7、想要修改auto-increment的起始值，可以找alter-table，比如：" class="headerlink" title="7、想要修改auto_increment的起始值，可以找alter table，比如："></a>7、想要修改auto_increment的起始值，可以找alter table，比如：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE animals AUTO_INCREMENT = 100;</span><br></pre></td></tr></table></figure>
<p>先使用truncate清除表数据,truncate会初始化起始值,delete语句不会初始化,先执行delete操作看一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 02:58:  [aaaa]&gt; delete from animals;</span><br><span class="line">Query OK, 25 rows affected (0.01 sec)</span><br><span class="line">root@db 03:04:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line">root@db 03:04:  [aaaa]&gt; insert into animals (name) values(&apos;dog&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 03:04:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+---------+------+</span><br><span class="line">| id      | name |</span><br><span class="line">+---------+------+</span><br><span class="line">| 8388609 | dog  |</span><br><span class="line">+---------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>auto_increment的值继续增长，没有从1开始。<br>执行truncate语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:04:  [aaaa]&gt; truncate table animals;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">root@db 03:05:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line">root@db 03:05:  [aaaa]&gt; insert into animals (name) values(&apos;dog&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 03:05:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | dog  |</span><br><span class="line">+----+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>auto_increment序列值从1重新开始计算。<br>下面使用alter table修改auto_increment的起始值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:05:  [aaaa]&gt; truncate table animals;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 03:06:  [aaaa]&gt; alter table animals auto_increment=99;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line">root@db 03:07:  [aaaa]&gt; insert into animals (name) values(&apos;dog&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 03:07:  [aaaa]&gt; insert into animals (name) values(&apos;cat&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 03:08:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+-----+------+</span><br><span class="line">| id  | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|  99 | dog  |</span><br><span class="line">| 100 | cat  |</span><br><span class="line">+-----+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>auto_increment起始值从99开始计算。<br>另外使用alter table设置的auto_increment列值，要大于auto_increment列中的最大值才会有效，如果设置的值小于auto_increment列中的最大值，该值会被重置为当前列的最大值+1。<br>如果设置系统级的步长(auto_increment_increment)和初始值(auto_increment_offset)<br>但是auto_increment_offset一定不能大于auto_increment_increment的值，否则auto_increment_offset会被忽略：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:18:  [aaaa]&gt; truncate table animals;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:18:  [aaaa]&gt; set @@auto_increment_offset=5;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:18:  [aaaa]&gt; set @@auto_increment_increment=7;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:19:  [aaaa]&gt; </span><br><span class="line">root@db 04:20:  [aaaa]&gt; </span><br><span class="line">root@db 04:20:  [aaaa]&gt; INSERT INTO animals (name) VALUES</span><br><span class="line">    -&gt;     (&apos;dog&apos;),(&apos;cat&apos;),(&apos;penguin&apos;),</span><br><span class="line">    -&gt;     (&apos;lax&apos;),(&apos;whale&apos;),(&apos;ostrich&apos;);</span><br><span class="line">Query OK, 6 rows affected (0.01 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 04:20:  [aaaa]&gt; select * from animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  5 | dog     |</span><br><span class="line">| 12 | cat     |</span><br><span class="line">| 19 | penguin |</span><br><span class="line">| 26 | lax     |</span><br><span class="line">| 33 | whale   |</span><br><span class="line">| 40 | ostrich |</span><br><span class="line">+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="8、对于myisam中的自增列-如果自增列在复合索引中-自增列会先匹配前缀-根据前缀条件搜索到的结果在自增-计算方法：s-MAX-auto-increment-column-1-WHERE-prefix-given-prefix。例如："><a href="#8、对于myisam中的自增列-如果自增列在复合索引中-自增列会先匹配前缀-根据前缀条件搜索到的结果在自增-计算方法：s-MAX-auto-increment-column-1-WHERE-prefix-given-prefix。例如：" class="headerlink" title="8、对于myisam中的自增列,如果自增列在复合索引中,自增列会先匹配前缀,根据前缀条件搜索到的结果在自增,计算方法：s MAX(auto_increment_column) + 1 WHERE prefix=given-prefix。例如："></a>8、对于myisam中的自增列,如果自增列在复合索引中,自增列会先匹配前缀,根据前缀条件搜索到的结果在自增,计算方法：s MAX(auto_increment_column) + 1 WHERE prefix=given-prefix。例如：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">drop table animals_myisam;</span><br><span class="line">CREATE TABLE animals_myisam (</span><br><span class="line">    grp ENUM(&apos;fish&apos;,&apos;mammal&apos;,&apos;bird&apos;) NOT NULL,</span><br><span class="line">    id MEDIUMINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name CHAR(30) NOT NULL,</span><br><span class="line">    PRIMARY KEY (grp,id)</span><br><span class="line">) ENGINE=MyISAM;</span><br><span class="line"></span><br><span class="line">INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line"></span><br><span class="line">root@db 03:12:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal |  3 | whale   |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:12:  [aaaa]&gt; INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    -&gt;     (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line">Query OK, 6 rows affected (0.00 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 03:13:  [aaaa]&gt; INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    -&gt;     (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line">Query OK, 6 rows affected (0.00 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 03:13:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal |  3 | whale   |</span><br><span class="line">| mammal |  4 | dog     |</span><br><span class="line">| mammal |  5 | cat     |</span><br><span class="line">| mammal |  6 | whale   |</span><br><span class="line">| mammal |  7 | dog     |</span><br><span class="line">| mammal |  8 | cat     |</span><br><span class="line">| mammal |  9 | whale   |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">18 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>在这种情况下，删除带有包括最大值的增长列，auto_increment序列值会被复用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">delete from animals_myisam where grp=&apos;mammal&apos; and id &gt; 2;</span><br><span class="line">root@db 03:23:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br><span class="line">#再次插入数据</span><br><span class="line">INSERT INTO animals_myisam (grp,name) VALUES (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;);</span><br><span class="line"></span><br><span class="line">root@db 03:23:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal |  3 | dog     |</span><br><span class="line">| mammal |  4 | cat     |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>以上情况是在id没有单独索引的情况下发生的，如果id单独的索引，那么插入的值会变成单一的值，不会跟grp列有任何关系。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">create index id_ind on animals_myisam(id);</span><br><span class="line">INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line">select * from animals_myisam order by mammal;</span><br><span class="line">root@db 03:29:  [aaaa]&gt; select * from animals_myisam order by grp;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   | 10 | lax     |</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal | 11 | whale   |</span><br><span class="line">| mammal |  8 | cat     |</span><br><span class="line">| mammal |  7 | dog     |</span><br><span class="line">| mammal |  3 | dog     |</span><br><span class="line">| mammal |  4 | cat     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  9 | penguin |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   | 12 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/30/mysql-AUTO_INCREMENT参数详解/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/27/optimize table运行是否支持online ddl/"><span>[Mysql] optimize table运行是否支持online ddl</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/27/optimize table运行是否支持online ddl/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-27T09:10:00.000Z">
          2018-11-27
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、相应官方文档"><a href="#0、相应官方文档" class="headerlink" title="0、相应官方文档"></a>0、相应官方文档</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（online ddl）官方文档提示当存在fulltext索引表进行优化表操作(optimize table)时是不支持online ddl的</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html#online-ddl-table-operations</span><br><span class="line">（optimize table）官方文档提示当存在索引时，对表进行优化不支持在线ddl</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/optimize-table.html</span><br></pre></td></tr></table></figure>
<p>下面分别对有主键索引、fulltext索引、无索引情况先查看是否支持online ddl;</p>
<h4 id="1、带有主键索引"><a href="#1、带有主键索引" class="headerlink" title="1、带有主键索引"></a>1、带有主键索引</h4><p>查看表结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:44:  [aaaa]&gt; show create table optimize_tb;</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table       | Create Table                                                                                                                                                                                     |</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb | CREATE TABLE `optimize_tb` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:44:  [aaaa]&gt; insert into optimize_tb (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (42.98 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:46:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.28 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]#  ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:44 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 15:46 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:47:  [aaaa]&gt; delete from optimize_tb limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (8.72 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:47:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.11 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件没有任何变化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:44 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 15:47 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:48:  [aaaa]&gt;  optimize table optimize_tb;</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table            | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb | optimize | status   | OK                                                                |</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (16.34 sec)</span><br></pre></td></tr></table></figure></p>
<p>session2执行插入语句操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:47:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.18 sec)</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8166638&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166639,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.25 sec)</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166640,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.25 sec)</span><br></pre></td></tr></table></figure></p>
<p>最后查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:48 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  28M 11月 27 15:48 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>数据插入成功，在有主键的情况下，使用optimize table可支持online ddl。</p>
<h4 id="2、带有fulltext索引"><a href="#2、带有fulltext索引" class="headerlink" title="2、带有fulltext索引"></a>2、带有fulltext索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:53:  [aaaa]&gt; create table optimize_tb1 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.65 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:53:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.04 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:53:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">ERROR 1075 (42000): Incorrect table definition; there can be only one auto column and it must be defined as a key</span><br></pre></td></tr></table></figure></p>
<p>因为存在自增约束，报错，需要删除约束<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:54:  [aaaa]&gt; alter table optimize_tb1 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (2.84 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:54:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.45 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:54:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:55:  [aaaa]&gt; insert into optimize_tb1 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (26.04 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:56:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.48 sec)</span><br></pre></td></tr></table></figure></p>
<p>创建fulltext 索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:56:  [aaaa]&gt; create fulltext index name_fullind on optimize_tb1(name);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (1 min 12.58 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 1</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:56 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 15:58 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:58:  [aaaa]&gt; delete from optimize_tb1 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (1 min 13.37 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:59:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.50 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:56 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 15:59 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1对表进行优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:59:  [aaaa]&gt; optimize table optimize_tb1;</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table             | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb1 | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb1 | optimize | status   | OK                                                                |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (1 min 13.65 sec)</span><br></pre></td></tr></table></figure></p>
<p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:00:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看数据库线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:00:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |   41 | copy to tmp table               | optimize table optimize_tb1                                      |</span><br><span class="line">|  7 | root | localhost | aaaa | Query   |   40 | Waiting for table metadata lock | insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">|  8 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:00 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:02 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>当表存在fulltext索引是，执行optimize table会锁表，其他会话连接进来无法做增删改操作。</p>
<h4 id="3、表不存在任何索引"><a href="#3、表不存在任何索引" class="headerlink" title="3、表不存在任何索引"></a>3、表不存在任何索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; create table optimize_tb2 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.60 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; alter table optimize_tb2 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.60 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; alter table optimize_tb2 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (3.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; insert into optimize_tb2 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (11.85 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:06:  [aaaa]&gt; </span><br><span class="line">root@db 16:07:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.41 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:04 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:06 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:07:  [aaaa]&gt; delete from optimize_tb2 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (2.50 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:11:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.29 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:04 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:11 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1对表进行优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:11:  [aaaa]&gt; optimize table optimize_tb2;</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table             | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb2 | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb2 | optimize | status   | OK                                                                |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (22.04 sec</span><br></pre></td></tr></table></figure></p>
<p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.35 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.44 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.24 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.38 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.20 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:11 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  32M 11月 27 16:12 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>在没有任何索引的情况下，insert语句成功。</p>
<h4 id="4、当mysql环境变量-old-alter-table为enabled（默认为off）或者-mysql启动参数添加了skip-new选项时，运行optimize-table命令，会使用table-copy的方式重建表，此时online-ddl是不可用的，下面添加skip-new参数重新进行测试。"><a href="#4、当mysql环境变量-old-alter-table为enabled（默认为off）或者-mysql启动参数添加了skip-new选项时，运行optimize-table命令，会使用table-copy的方式重建表，此时online-ddl是不可用的，下面添加skip-new参数重新进行测试。" class="headerlink" title="4、当mysql环境变量 old_alter_table为enabled（默认为off）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，此时online ddl是不可用的，下面添加skip-new参数重新进行测试。"></a>4、当mysql环境变量 old_alter_table为enabled（默认为off）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，此时online ddl是不可用的，下面添加skip-new参数重新进行测试。</h4><p>在/etc/my.cnf添加参数skip-new，重新启动mysql：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# more /etc/my.cnf|grep skip-new</span><br><span class="line">skip-new</span><br><span class="line">[root@dax-mysql-master aaaa]# /etc/init.d/mysql restart</span><br><span class="line">Shutting down MySQL....... SUCCESS! </span><br><span class="line">Starting MySQL..... SUCCESS!</span><br></pre></td></tr></table></figure></p>
<p>删除上面的测试表，再次进行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:21:  [aaaa]&gt; drop table optimize_tb,optimize_tb1,optimize_tb2;</span><br><span class="line">Query OK, 0 rows affected (1.58 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="5、带有主键索引"><a href="#5、带有主键索引" class="headerlink" title="5、带有主键索引"></a>5、带有主键索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:23:  [aaaa]&gt; create table optimize_tb like testfororder;</span><br><span class="line">Query OK, 0 rows affected (1.29 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:23:  [aaaa]&gt; insert into optimize_tb (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (33.65 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:24:  [aaaa]&gt; show create table optimize_tb;</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table       | Create Table                                                                                                                                                                                                            |</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb | CREATE TABLE `optimize_tb` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=8166638 DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:25:  [aaaa]&gt;  select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.25 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:23 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:24 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:26:  [aaaa]&gt; delete from optimize_tb limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (9.18 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:26:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.13 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:23 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:26 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; optimize table optimize_tb;</span><br><span class="line">Query OK, 500000 rows affected (26.01 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session2执行插入操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                            |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |   19 | copy to tmp table               | optimize table optimize_tb                                      |</span><br><span class="line">|  3 | root | localhost | aaaa | Query   |   11 | Waiting for table metadata lock | insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:27 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  28M 11月 27 16:27 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>在存在主键索引的情况下，数据插入失败，提示锁等待超时。</p>
<h4 id="6、表中带有fulltext索引"><a href="#6、表中带有fulltext索引" class="headerlink" title="6、表中带有fulltext索引"></a>6、表中带有fulltext索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:31:  [aaaa]&gt; create table optimize_tb1 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (1.07 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:31:  [aaaa]&gt; alter table optimize_tb1 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.13 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.41 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:32:  [aaaa]&gt; insert into optimize_tb1 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (14.49 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:32:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.44 sec)</span><br></pre></td></tr></table></figure></p>
<p>创建fulltext 索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:33:  [aaaa]&gt; create fulltext index name_fullind on optimize_tb1(name);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (57.22 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 1</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:33 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 16:34 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:34:  [aaaa]&gt; delete from optimize_tb1 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (59.90 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:35:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.69 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:33 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 16:36 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行对表进行优化操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:36:  [aaaa]&gt; optimize table optimize_tb1;</span><br><span class="line">Query OK, 500000 rows affected (55.85 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:37:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 16:37:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:37:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |    9 | copy to tmp table               | optimize table optimize_tb1                                      |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |    8 | Waiting for table metadata lock | insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:37 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:38 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>在存在fulltext索引的情况下，数据插入失败，提示锁等待超时。</p>
<h4 id="7、表中没有任何索引"><a href="#7、表中没有任何索引" class="headerlink" title="7、表中没有任何索引"></a>7、表中没有任何索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:38:  [aaaa]&gt; create table optimize_tb2 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.44 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:39:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; alter table optimize_tb2 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.39 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; alter table optimize_tb2 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:40:  [aaaa]&gt; insert into optimize_tb2 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (16.74 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:41:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.49 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:40 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:41 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:42:  [aaaa]&gt; delete from optimize_tb2 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (3.96 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:42:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.32 sec)</span><br></pre></td></tr></table></figure></p>
<p>数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:40 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:42 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:42:  [aaaa]&gt; optimize table optimize_tb2;</span><br><span class="line">Query OK, 500000 rows affected (23.61 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session2执行插入数据操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:43:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:43:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |    7 | copy to tmp table               | optimize table optimize_tb2                                      |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |    6 | Waiting for table metadata lock | insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在没有任何索引的情况下，插入数据锁等待</p>
<h4 id="8、结论"><a href="#8、结论" class="headerlink" title="8、结论"></a>8、结论</h4><p>当mysql环境变量 old_alter_table为enabled（默认为disabled）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，无论表中有无索引，此时online ddl是不可用的；<br>当mysql环境变量old_alter_table为disabled（默认为disabled）或者 mysql启动参数没有添加了skip-new选项时，运行optimize table命令，当表中不存在fulltext索引时，online ddl可用，当表中存在fulltext索引是，online ddl不可用。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/27/optimize table运行是否支持online ddl/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/25/mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires/"><span>[Mysql] mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires.&#39;, Error_code: 1236</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/25/mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-25T14:51:00.000Z">
          2018-11-25
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、实验环境介绍："><a href="#0、实验环境介绍：" class="headerlink" title="0、实验环境介绍："></a>0、实验环境介绍：</h4><p>mysql-mgr单主模式主节点1、从节点1、从节点2</p>
<h4 id="1、实验一，手动删除主库binlog日志文件"><a href="#1、实验一，手动删除主库binlog日志文件" class="headerlink" title="1、实验一，手动删除主库binlog日志文件"></a>1、实验一，手动删除主库binlog日志文件</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行stop group_replication;</span><br></pre></td></tr></table></figure></p>
<p>主库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#切换日志，创建表gtid_test10,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test10 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 05:48:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000029 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-27 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#切换日志，创建表gtid_test10,并查看当前的binlog日志文件：</span><br><span class="line">root@db 05:48:  [test]&gt; flush logs;create table gtid_test11 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">root@db 05:48:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000030 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-28 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#主库手动移除binlog文件：</span><br><span class="line">mv mysql-binlog.000029 /tmp/</span><br></pre></td></tr></table></figure></p>
<p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">执行start group_replication;</span><br><span class="line">#查看从库2的日志</span><br><span class="line">2018-09-18T05:49:55.983888Z 93 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T05:49:55.984034Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:31.&apos;</span><br><span class="line">2018-09-18T05:49:56.054981Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:56.144944Z 93 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T05:49:56.155058Z 95 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T05:49:56.157141Z 95 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T05:49:56.179441Z 96 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T05:49:56.326072Z 95 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: Could not open log file (server_errno=1236)</span><br><span class="line">2018-09-18T05:49:56.326236Z 95 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;Could not open log file&apos;, Error_code: 1236</span><br><span class="line">#因为已经手动删除了binlog文件，从库2无法从主库获取到binlog文件，报错</span><br><span class="line">2018-09-18T05:49:56.326310Z 95 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000029&apos;, position 4</span><br><span class="line">2018-09-18T05:49:56.326422Z 93 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T05:49:56.347776Z 96 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T05:49:56.438760Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:56.510091Z 93 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</span><br><span class="line">2018-09-18T05:49:56.572561Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从库2开始尝试从从库1节点获取binlog文件，因为只是删除了主库节点的binlog文件，从库1的文件未删除，从库2获取到所需要的文件，开始进行同步。</span><br><span class="line">2018-09-18T05:49:56.643413Z 93 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T05:49:56.643906Z 99 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T05:49:56.646363Z 99 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T05:49:56.666439Z 100 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T05:49:56.882987Z 93 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T05:49:56.905507Z 99 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T05:49:56.905535Z 99 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000005&apos;, position 10512</span><br><span class="line">2018-09-18T05:49:56.999936Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:57.084035Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p>
<p>同步完成。</p>
<h4 id="2、实验二，使用purge命令删除主库binlog文件"><a href="#2、实验二，使用purge命令删除主库binlog文件" class="headerlink" title="2、实验二，使用purge命令删除主库binlog文件"></a>2、实验二，使用purge命令删除主库binlog文件</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication:</span><br></pre></td></tr></table></figure></p>
<p>主库1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#切换日志，创建表gtid_test12,并查看当前的binlog日志文件：</span><br><span class="line">root@db 06:04:  [test]&gt; flush logs;create table gtid_test12 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 06:04:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000033 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-30 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#切换日志，创建表gtid_test13,并查看当前的binlog日志文件：</span><br><span class="line">root@db 06:04:  [test]&gt; flush logs;create table gtid_test13 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 06:04:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000034 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-31 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#主库清除mysql-binlog.000034之前的所有binlog日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000034&apos;;</span><br><span class="line">#查看日志log目录下的34之前的日志已经全部清除：</span><br><span class="line">ll mysql-binlog.*</span><br><span class="line">-rw-r----- 1 mysql mysql 493 Sep 18 06:04 mysql-binlog.000034</span><br><span class="line">-rw-r----- 1 mysql mysql  36 Sep 18 06:22 mysql-binlog.index</span><br><span class="line"></span><br><span class="line">#查看主库gtid信息，gtid_purged已经有记录：</span><br><span class="line">show global variables like &apos;%gtid%&apos;;</span><br><span class="line">root@db 06:37:  [test]&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                                                                                                                                                     |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery                       | ON                                                                                                                                                                        |</span><br><span class="line">| enforce_gtid_consistency                          | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_allow_local_disjoint_gtids_join | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_gtid_assignment_block_size      | 1000000                                                                                                                                                                   |</span><br><span class="line">| gtid_executed                                     | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-31 |</span><br><span class="line">| gtid_executed_compression_period                  | 1000                                                                                                                                                                      |</span><br><span class="line">| gtid_mode                                         | ON                                                                                                                                                                        |</span><br><span class="line">| gtid_owned                                        |                                                                                                                                                                           |</span><br><span class="line">| gtid_purged                                       | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-30 |</span><br><span class="line">| session_track_gtids                               | OFF                                                                                                                                                                       |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>从节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p>
<p>查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T06:38:36.664372Z 107 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2&quot;; group_replication_local_address: &quot;dax-mysql-slave2:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-slave:24901,dax-mysql-master:24901,dax-mysql-slave2:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-09-18T06:38:36.664408Z 107 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-09-18T06:38:36.664428Z 107 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-09-18T06:38:36.664457Z 107 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;c6ac9ccd-b80b-11e8-b968-000d3a801bf4&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-09-18T06:38:36.664812Z 109 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 493, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:38:36.736702Z 107 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-09-18T06:38:36.736749Z 107 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-09-18T06:38:36.736774Z 107 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-09-18T06:38:36.736708Z 112 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000014&apos; position: 4</span><br><span class="line">2018-09-18T06:38:36.737167Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-09-18T06:38:36.737227Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-09-18T06:38:38.815550Z 107 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address dax-mysql-master:3306.&apos;</span><br><span class="line">2018-09-18T06:38:38.815711Z 0 [ERROR] Plugin group_replication reported: &apos;Group contains 3 members which is greater than group_replication_auto_increment_increment value of 1. This can lead to an higher rate of transactional aborts.&apos;</span><br><span class="line">2018-09-18T06:38:38.816035Z 117 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T06:38:38.816125Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:33.&apos;</span><br><span class="line">2018-09-18T06:38:38.881138Z 117 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从节点2选择从从节点1获取binlog文件，因为从节点1文件没有删除，获取binlog文件正常。</span><br><span class="line">2018-09-18T06:38:38.959786Z 117 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T06:38:38.960147Z 119 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T06:38:38.962244Z 119 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T06:38:38.982193Z 120 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T06:38:39.194864Z 117 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T06:38:39.218168Z 119 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T06:38:39.218197Z 119 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000005&apos;, position 11362</span><br><span class="line">2018-09-18T06:38:39.313623Z 117 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:38:39.400236Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p>
<p>同步完成。</p>
<h4 id="3、实验三，删除主库节点和从节点1的binlog文件。"><a href="#3、实验三，删除主库节点和从节点1的binlog文件。" class="headerlink" title="3、实验三，删除主库节点和从节点1的binlog文件。"></a>3、实验三，删除主库节点和从节点1的binlog文件。</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br></pre></td></tr></table></figure></p>
<p>主库1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">3切换日志，创建表gtid_test14,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test14 (ID int) engine=innodb;</span><br><span class="line">show master status;</span><br><span class="line">#切换日志，创建表gtid_test15,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test15 (ID int) engine=innodb;</span><br><span class="line">show master status;</span><br><span class="line">#清除mysql-binlog.000036之前的日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000036&apos;;</span><br><span class="line">[root@dax-mysql-master log]# ll mysql-binlog.*</span><br><span class="line">-rw-r----- 1 mysql mysql 493 Sep 18 06:53 mysql-binlog.000036</span><br><span class="line">-rw-r----- 1 mysql mysql  36 Sep 18 06:56 mysql-binlog.index</span><br></pre></td></tr></table></figure></p>
<p>从库1删除binlog日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                                                 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000005 |    11728 |              |                  | 324a6fd1-ba55-11e8-b3ff-000d3a800ed3:1,</span><br><span class="line">8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-34 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#切换binlog日志：</span><br><span class="line">flush logs;</span><br><span class="line">show master status;</span><br><span class="line">root@db 06:57:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                                                 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000006 |      350 |              |                  | 324a6fd1-ba55-11e8-b3ff-000d3a800ed3:1,</span><br><span class="line">8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-34 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">[root@dax-mysql-slave log]# ll </span><br><span class="line">total 96</span><br><span class="line">-rw-r----- 1 mysql mysql 53478 Sep 18 06:49 error.log</span><br><span class="line">-rw-r----- 1 mysql mysql   177 Sep 17 08:39 mysql-binlog.000001</span><br><span class="line">-rw-r----- 1 mysql mysql   437 Sep 17 09:21 mysql-binlog.000002</span><br><span class="line">-rw-r----- 1 mysql mysql   217 Sep 17 09:25 mysql-binlog.000003</span><br><span class="line">-rw-r----- 1 mysql mysql   209 Sep 17 09:26 mysql-binlog.000004</span><br><span class="line">-rw-r----- 1 mysql mysql 11774 Sep 18 06:57 mysql-binlog.000005</span><br><span class="line">-rw-r----- 1 mysql mysql   350 Sep 18 06:57 mysql-binlog.000006</span><br><span class="line">-rw-r----- 1 mysql mysql   216 Sep 18 06:57 mysql-binlog.index</span><br><span class="line">-rw-r--r-- 1 mysql mysql     0 Sep 17 08:36 mysqld.log</span><br><span class="line">-rw-r----- 1 mysql mysql  1968 Sep 18 06:57 slow.log</span><br><span class="line">#删除mysql-binlog.000006之前的所有日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000006&apos;;</span><br><span class="line">[root@dax-mysql-slave log]# ll </span><br><span class="line">total 68</span><br><span class="line">-rw-r----- 1 mysql mysql 53478 Sep 18 06:49 error.log</span><br><span class="line">-rw-r----- 1 mysql mysql   350 Sep 18 06:57 mysql-binlog.000006</span><br><span class="line">-rw-r----- 1 mysql mysql    36 Sep 18 06:58 mysql-binlog.index</span><br><span class="line">-rw-r--r-- 1 mysql mysql     0 Sep 17 08:36 mysqld.log</span><br><span class="line">-rw-r----- 1 mysql mysql  1968 Sep 18 06:57 slow.log</span><br></pre></td></tr></table></figure></p>
<p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start group_replicatinon;</span><br></pre></td></tr></table></figure></p>
<p>查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T06:59:20.236425Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</span><br><span class="line">2018-09-18T06:59:20.309947Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:59:20.391623Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T06:59:20.391891Z 142 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T06:59:20.394226Z 142 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T06:59:20.416722Z 143 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T06:59:20.424400Z 142 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T06:59:20.424467Z 142 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T06:59:20.424488Z 142 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T06:59:20.424640Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T06:59:20.436806Z 143 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T06:59:20.522269Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:59:20.603837Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 3/10&apos;</span><br><span class="line">2018-09-18T07:00:20.679461Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:00:20.762021Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T07:00:20.762368Z 146 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:00:20.764842Z 146 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:00:20.787728Z 147 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:00:20.794590Z 146 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T07:00:20.794623Z 146 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T07:00:20.794635Z 146 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T07:00:20.794786Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:00:20.807977Z 147 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T07:00:20.895774Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从库2多次尝试从从库1获取binlog日志，没有成功，切换master_host节点，尝试从主库获取binlog日志文件：</span><br><span class="line">2018-09-18T07:00:20.980112Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 4/10&apos;</span><br><span class="line">2018-09-18T07:00:21.052930Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:00:21.141126Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T07:00:21.141498Z 150 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:00:21.143773Z 150 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:00:21.166993Z 151 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:00:21.171461Z 150 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T07:00:21.171518Z 150 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T07:00:21.171528Z 150 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T07:00:21.171645Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:00:21.186565Z 151 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T07:00:21.271867Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">....</span><br><span class="line">[ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br></pre></td></tr></table></figure></p>
<p>因为主库1和从库1的binlog文件都删除，从库2无法同步，最后退出集群。</p>
<h4 id="4、查看主库清除的日志"><a href="#4、查看主库清除的日志" class="headerlink" title="4、查看主库清除的日志"></a>4、查看主库清除的日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                                                                                                                                                     |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery                       | ON                                                                                                                                                                        |</span><br><span class="line">| enforce_gtid_consistency                          | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_allow_local_disjoint_gtids_join | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_gtid_assignment_block_size      | 1000000                                                                                                                                                                   |</span><br><span class="line">| gtid_executed                                     | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-35 |</span><br><span class="line">| gtid_executed_compression_period                  | 1000                                                                                                                                                                      |</span><br><span class="line">| gtid_mode                                         | ON                                                                                                                                                                        |</span><br><span class="line">| gtid_owned                                        |                                                                                                                                                                           |</span><br><span class="line">| gtid_purged                                       | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33 |</span><br><span class="line">| session_track_gtids                               | OFF                                                                                                                                                                       |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从库2尝试过滤掉缺失的那部分日志，然后重新加入集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">reset master;</span><br><span class="line">set global GTID_PURGED=&quot;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,d240752c-b809-11e8-8947-000d3a800ed3:1,dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&quot;;</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p>
<p>再次查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T07:08:05.524626Z 125 [Note] @@GLOBAL.GTID_PURGED was changed from &apos;&apos; to &apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&apos;.</span><br><span class="line">2018-09-18T07:08:05.524661Z 125 [Note] @@GLOBAL.GTID_EXECUTED was changed from &apos;&apos; to &apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&apos;.</span><br><span class="line">2018-09-18T07:08:20.457841Z 125 [Note] Plugin group_replication reported: &apos;Group communication SSL configuration: group_replication_ssl_mode: &quot;DISABLED&quot;&apos;</span><br><span class="line">2018-09-18T07:08:20.457971Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 10.0.7.51/24,127.0.0.1/8 to the whitelist&apos;</span><br><span class="line">2018-09-18T07:08:20.458188Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Translated &apos;dax-mysql-slave2&apos; to 10.0.7.51&apos;</span><br><span class="line">2018-09-18T07:08:20.458321Z 125 [Warning] Plugin group_replication reported: &apos;[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.&apos;</span><br><span class="line">2018-09-18T07:08:20.458401Z 125 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</span><br><span class="line">2018-09-18T07:08:20.458433Z 125 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2&quot;; group_replication_local_address: &quot;dax-mysql-slave2:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-slave:24901,dax-mysql-master:24901,dax-mysql-slave2:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-09-18T07:08:20.458473Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-09-18T07:08:20.458480Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-09-18T07:08:20.458503Z 125 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;c6ac9ccd-b80b-11e8-b968-000d3a801bf4&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-09-18T07:08:20.458664Z 181 [Note] Plugin group_replication reported: &apos;Detected previous RESET MASTER invocation or an issue exists in the group replication applier relay log. Purging existing applier logs.&apos;</span><br><span class="line">2018-09-18T07:08:20.531810Z 181 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:20.632692Z 125 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-09-18T07:08:20.632736Z 125 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-09-18T07:08:20.632758Z 125 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-09-18T07:08:20.632694Z 184 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:08:20.632947Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-09-18T07:08:20.632977Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-09-18T07:08:22.329812Z 125 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address dax-mysql-master:3306.&apos;</span><br><span class="line">2018-09-18T07:08:22.329901Z 0 [ERROR] Plugin group_replication reported: &apos;Group contains 3 members which is greater than group_replication_auto_increment_increment value of 1. This can lead to an higher rate of transactional aborts.&apos;</span><br><span class="line">2018-09-18T07:08:22.330145Z 189 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T07:08:22.330221Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:37.&apos;</span><br><span class="line">2018-09-18T07:08:22.394512Z 189 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:22.468142Z 189 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T07:08:22.468378Z 191 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:08:22.470340Z 191 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:08:22.490866Z 192 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:08:22.632774Z 189 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:08:22.653083Z 191 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T07:08:22.653098Z 191 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000036&apos;, position 1381</span><br><span class="line">2018-09-18T07:08:22.734186Z 189 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:22.808784Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p>
<p>此时从库2与主库、从库1的数据是不一致的，gtid_test14表时不存在的，因此需要使用pt-table-checksum和pt-table-sync去同步，但是该方法在mysql-mgr环境下测试没有成功。<br>另一种方法是直接备份一份主节点的最新备份数据，在从库2上恢复。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/25/mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/25/GlusterFS/"><span>[Linux] GlusterFS部署详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/25/GlusterFS/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-25T12:59:30.000Z">
          2018-11-25
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、安装之前须知："><a href="#0、安装之前须知：" class="headerlink" title="0、安装之前须知："></a>0、安装之前须知：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">推荐使用xfs，没用xfs推荐使用ext4，其他文件系统也可兼容；</span><br><span class="line">生产环境DNS NTP服务必须安装,DNS服务配置可点击[此处](https://zeven0707.github.io/2018/11/22/DNS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/)；</span><br><span class="line">如果是虚拟机环境最少1G内存；</span><br><span class="line">最好配置2个网卡，一个管理接口，一个数据传输接口；</span><br><span class="line">如果使用vm克隆额外的机器，确保glusterfs没有安装，如果安装了Gluster,会在每个系统上生产一个uuid，因此如果克隆了一个已经安装了gluster的系统，后面会报错；</span><br><span class="line">如果使用物理服务器，建议最低配置（2 CPU’s, 2GB of RAM, 1GBE），板载组件不如附加组件强大；</span><br><span class="line">安装官方文档，点击[此处](https://docs.gluster.org/en/latest/Install-Guide/Install/)</span><br><span class="line">centos7快速安装指南，点击[此处](https://wiki.centos.org/SpecialInterestGroup/Storage/gluster-Quickstart)</span><br><span class="line">/var/log目录最好单独挂在，一旦日志目录无法写入信息，gluster fs会出现古怪现象</span><br></pre></td></tr></table></figure>
<h4 id="1、配置yum源"><a href="#1、配置yum源" class="headerlink" title="1、配置yum源"></a>1、配置yum源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-gluster</span><br></pre></td></tr></table></figure>
<h4 id="2、在两个节点上添加磁盘，格式化-并挂在目录"><a href="#2、在两个节点上添加磁盘，格式化-并挂在目录" class="headerlink" title="2、在两个节点上添加磁盘，格式化,并挂在目录"></a>2、在两个节点上添加磁盘，格式化,并挂在目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#格式化磁盘，创建相应的挂在目录</span><br><span class="line">mkfs.xfs -i size=512 /dev/sdb1</span><br><span class="line">mkdir -p /gfs/test1</span><br><span class="line">#将挂在配置信息写入fstab配置文件，以便重启自动挂载</span><br><span class="line">vi /etc/fstab</span><br><span class="line">/dev/sdb1 /gfs/test1 xfs defaults 1 2</span><br><span class="line">#加载修改的配置信息</span><br><span class="line">mount -a &amp;&amp; mount</span><br></pre></td></tr></table></figure>
<p>Note: 在CentOS 6操作系统,需要安装xfs文件系统：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xfsprogs</span><br></pre></td></tr></table></figure></p>
<h4 id="3、安装、配置glusterd服务"><a href="#3、安装、配置glusterd服务" class="headerlink" title="3、安装、配置glusterd服务"></a>3、安装、配置glusterd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install glusterfs-server</span><br></pre></td></tr></table></figure>
<p>启动GlusterFS 管理进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#加入开机启动</span><br><span class="line">systemctl enable glusterd</span><br><span class="line">ln -s &apos;/usr/lib/systemd/system/glusterd.service&apos; &apos;/etc/systemd/system/multi-user.target.wants/glusterd.service&apos;</span><br><span class="line">#启动glusterd</span><br><span class="line">systemctl start glusterd</span><br><span class="line">#查看glusterd状态信息</span><br><span class="line">systemctl status glusterd</span><br><span class="line">● glusterd.service - GlusterFS, a clustered file-system server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/glusterd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-11-15 12:08:54 EST; 15s ago</span><br><span class="line">  Process: 2808 ExecStart=/usr/sbin/glusterd -p /var/run/glusterd.pid --log-level $LOG_LEVEL $GLUSTERD_OPTIONS (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 2810 (glusterd)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   CGroup: /system.slice/glusterd.service</span><br><span class="line">           └─2810 /usr/sbin/glusterd -p /var/run/glusterd.pid --log-level INFO</span><br><span class="line"></span><br><span class="line">Nov 15 12:08:53 node1 systemd[1]: Starting GlusterFS, a clustered file-system server...</span><br><span class="line">Nov 15 12:08:54 node1 systemd[1]: Started GlusterFS, a clustered file-system server.</span><br></pre></td></tr></table></figure></p>
<h4 id="4、防火墙配置"><a href="#4、防火墙配置" class="headerlink" title="4、防火墙配置"></a>4、防火墙配置</h4><p>默认glusted监听tcp/24007 ，但是你增加一个brick，会开启一个新的端口，通过命令”gluster volume status”可以查询到<br>，因此如果各个节点配置了防火墙，新增一个brick之后，需要注意修改防火墙的端口限制，不然下面的配置受信任池会报错。</p>
<h4 id="5、配置受信任池"><a href="#5、配置受信任池" class="headerlink" title="5、配置受信任池"></a>5、配置受信任池</h4><p>node1操作，将node2添加到受信任池：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: success.</span><br></pre></td></tr></table></figure></p>
<p>如果防火墙开启可能会提示下面错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: failed: Probe returned with Transport endpoint is not connected</span><br></pre></td></tr></table></figure></p>
<p>node2操作，将node1添加到受信任池<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# gluster peer probe node1</span><br><span class="line">peer probe: success. Host node1 port 24007 already in peer list</span><br></pre></td></tr></table></figure></p>
<h4 id="6、建立GlusterFS-volume"><a href="#6、建立GlusterFS-volume" class="headerlink" title="6、建立GlusterFS volume"></a>6、建立GlusterFS volume</h4><p>node1 and node2操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /gfs/test1/gv0</span><br></pre></td></tr></table></figure></p>
<p>在任意一个节点上执行即可，不需要重复执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv0 replica 2 node1:/gfs/test1/gv0 node2:/gfs/test1/gv0</span><br><span class="line">[root@node1 ~]# gluster volume create gv0 replica 2 node1:/gfs/test1/gv0 node2:/gfs/test1/gv0</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">volume create: gv0: success: please start the volume to access data</span><br></pre></td></tr></table></figure></p>
<p>提示只有2个副本有可能出现脑裂的情况，创建带有仲裁节点以上的gluserfs volume至少三个节点，因此两个节点的副本集可以只能忽略这个问题。<br>下面启动创建的gv0卷<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume start gv0</span><br><span class="line">[root@node1 ~]# gluster volume start gv0</span><br><span class="line">volume start: gv0: success</span><br><span class="line">Confirm that the volume shows &quot;Started&quot;:</span><br></pre></td></tr></table></figure></p>
<p>查看启动的gv0卷信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume info</span><br><span class="line">[root@node1 ~]# gluster volume info</span><br><span class="line"> </span><br><span class="line">Volume Name: gv0</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: 79c81f10-0cb8-4f26-a7ab-d21fe19f0bbf</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x 2 = 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv0</span><br><span class="line">Brick2: node2:/gfs/test1/gv0</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure></p>
<p>/var/log/glusterfs如果没有正常启动，可以查看日志</p>
<h4 id="7、测试Glusterfs-volume-gv0副本集是否生效"><a href="#7、测试Glusterfs-volume-gv0副本集是否生效" class="headerlink" title="7、测试Glusterfs volume gv0副本集是否生效"></a>7、测试Glusterfs volume gv0副本集是否生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#挂在到任意空目录</span><br><span class="line">mount -t glusterfs node1:/gv0 /mnt</span><br><span class="line">#创造测试数据</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#查看生成数据的数量</span><br><span class="line">ls  /mnt | wc -l</span><br><span class="line">#在node1和node2的/gfs/test1/gv0目录下均生成了100个文件</span><br><span class="line">ls /gfs/test1/gv0 |wc -l</span><br></pre></td></tr></table></figure>
<p>[root@node1 ~]# gluster volume create gv1 disperse 2 node1:/gfs/test1/gv1 node2:/gfs/test1/gv1<br>disperse count must be greater than 2<br>disperse option given twice</p>
<p>Usage:<br>volume create <new-volname> [stripe <count>] [replica <count> [arbiter <count>]] [disperse [<count>]] [disperse-data <count>] [redundancy <count>] [transport &lt;tcp|rdma|tcp,rdma&gt;] <new-brick>?&lt;vg_name&gt;… [force]</new-brick></count></count></count></count></count></count></new-volname></p>
<h4 id="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"><a href="#8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来" class="headerlink" title="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"></a>8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node3</span><br><span class="line">[root@node1 ~]# gluster peer status</span><br><span class="line">Number of Peers: 2</span><br><span class="line"></span><br><span class="line">Hostname: node2</span><br><span class="line">Uuid: 588d2f92-f085-4e74-ab63-c6f5aa6ffb24</span><br><span class="line">State: Peer in Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: node3</span><br><span class="line">Uuid: 3495bc9c-7330-4038-ac94-1777ba0286f5</span><br><span class="line">State: Peer in Cluster (Connected)</span><br></pre></td></tr></table></figure>
<h4 id="9、创建2节点分布式volume"><a href="#9、创建2节点分布式volume" class="headerlink" title="9、创建2节点分布式volume"></a>9、创建2节点分布式volume</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建卷不添加任何参数的情况下，默认模式为分布式：</span><br><span class="line">#gluster volume create gv3 node1:/gfs/test1/gv3 node2:/gfs/test1/gv3</span><br><span class="line">[root@node1 ~]# gluster volume create gv3 node1:/gfs/test1/gv3 node2:/gfs/test1/gv3</span><br><span class="line">volume create: gv1: success: please start the volume to access data</span><br><span class="line"># 启动gv3</span><br><span class="line"># gluster volume start gv3</span><br><span class="line">[root@node1 ~]# gluster volume start gv3</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# gluster volume info gv3</span><br><span class="line"></span><br><span class="line">Volume Name: gv3</span><br><span class="line">Type: Distribute</span><br><span class="line">Volume ID: 02e3163b-1c69-402f-aad5-9cf4dba3267c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv3</span><br><span class="line">Brick2: node2:/gfs/test1/gv3</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br></pre></td></tr></table></figure>
<h4 id="10、测试Glusterfs-volume-gv3"><a href="#10、测试Glusterfs-volume-gv3" class="headerlink" title="10、测试Glusterfs volume gv3"></a>10、测试Glusterfs volume gv3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:/gv3 /mnt</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#node1查看数据：</span><br><span class="line">[root@node1 gv3]# ls  /mnt | wc -l</span><br><span class="line">100</span><br><span class="line">#node1:查看文件实际位置下的数据：</span><br><span class="line">[root@node1 gv3]# ls /gfs/test1/gv3/ |wc -l</span><br><span class="line">50</span><br><span class="line">#node2：查看文件实际位置下的数据：</span><br><span class="line">[root@node2 gv3]# ls /gfs/test1/gv3/ |wc -l</span><br><span class="line">50</span><br><span class="line">#虽然在节点3没有生成集群卷，在节点3上挂在/gv3也可以看到数据：</span><br><span class="line">mount -t glusterfs 127.0.0.1:/gv3 /mnt</span><br><span class="line">[root@node3 mnt]# ls /mnt/ |wc -l</span><br><span class="line">100</span><br></pre></td></tr></table></figure>
<h4 id="11、创建分布式副本"><a href="#11、创建分布式副本" class="headerlink" title="11、创建分布式副本"></a>11、创建分布式副本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 node4:/gfs/test1/gv4</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 </span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">number of bricks is not a multiple of replica count</span><br><span class="line">#创建副本的节点数要和副本个数成倍数关系</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 node4:/gfs/test1/gv4</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">volume create: gv4: success: please start the volume to access data</span><br><span class="line">[root@node1 test1]# gluster volume start gv4</span><br><span class="line">[root@node1 test1]# gluster volume info gv4</span><br><span class="line">Volume Name: gv4</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: e8556b2e-462d-4407-99c4-a6e622754e6c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2 x 2 = 4</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv4</span><br><span class="line">Brick2: node2:/gfs/test1/gv4</span><br><span class="line">Brick3: node3:/gfs/test1/gv4</span><br><span class="line">Brick4: node4:/gfs/test1/gv4</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h4 id="12、测试Glusterfs-volume-gv4"><a href="#12、测试Glusterfs-volume-gv4" class="headerlink" title="12、测试Glusterfs volume gv4:"></a>12、测试Glusterfs volume gv4:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:/gv4 /mnt</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#查看数据分布，node1与node2数据相同，node3和node4存储另一半信息</span><br><span class="line">[root@node1 test1]# ls /gfs/test1/gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node2 gv0]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node3 test]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node4 ~]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br></pre></td></tr></table></figure>
<h4 id="13、创建带有仲裁的副本集"><a href="#13、创建带有仲裁的副本集" class="headerlink" title="13、创建带有仲裁的副本集"></a>13、创建带有仲裁的副本集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test1]# gluster volume create gv5 replica 2 arbiter 2 transport tcp node1:/gfs/test1/gv5 node2:/gfs/test1/gv5 node3:/gfs/test1/gv5</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">For arbiter configuration, replica count must be 3 and arbiter count must be 1. The 3rd brick of the replica will be the arbiter</span><br><span class="line">#提示创建仲裁必须是三个副本集</span><br><span class="line">[root@node1 test1]# gluster volume create gv5 replica 3 arbiter 1 transport tcp node1:/gfs/test1/gv5 node2:/gfs/test1/gv5 node3:/gfs/test1/gv5</span><br><span class="line">#启动gv5</span><br><span class="line">[root@node1 test1]# gluster volume start gv5</span><br><span class="line">[root@node1 test1]# gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: fd4fca20-1bb3-480b-9c24-703dd3e8b508</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) = 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv5</span><br><span class="line">Brick2: node2:/gfs/test1/gv5</span><br><span class="line">Brick3: node3:/gfs/test1/gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h4 id="14、GlusterFS的常见的卷介绍"><a href="#14、GlusterFS的常见的卷介绍" class="headerlink" title="14、GlusterFS的常见的卷介绍"></a>14、GlusterFS的常见的卷介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Distributed：分布式卷，文件通过 hash 算法随机分布到由 bricks 组成的卷上。</span><br><span class="line">Replicated: 复制式卷，类似 RAID 1，replica 数必须等于 volume 中 brick 所包含的存储服务器数，可用性高。</span><br><span class="line">Striped: 条带式卷，类似 RAID 0，stripe 数必须等于 volume 中 brick 所包含的存储服务器数，文件被分成数据块，以 Round Robin 的方式存储在 bricks 中，并发粒度是数据块，大文件性能好。</span><br><span class="line">Distributed Striped: 分布式的条带卷，volume中 brick 所包含的存储服务器数必须是 stripe 的倍数（&gt;=2倍），兼顾分布式和条带式的功能。</span><br><span class="line">Distributed Replicated: 分布式的复制卷，volume 中 brick 所包含的存储服务器数必须是 replica 的倍数（&gt;=2倍），兼顾分布式和复制式的功能。</span><br><span class="line">分布式复制卷的brick顺序决定了文件分布的位置，一般来说，先是两个brick形成一个复制关系，然后两个复制关系形成分布。</span><br><span class="line">企业一般用后两种，大部分会用分布式复制（可用容量为 总容量/复制份数），通过网络传输的话最好用万兆交换机，万兆网卡来做。这样就会优化一部分性能。它们的数据都是通过网络来传输的。</span><br><span class="line"></span><br><span class="line">查看官方提供的gluster volume，点击[此处](https://docs.gluster.org/en/latest/Administrator%20Guide/Setting%20Up%20Volumes/)</span><br></pre></td></tr></table></figure>
<h4 id="15、删除卷"><a href="#15、删除卷" class="headerlink" title="15、删除卷"></a>15、删除卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#先停止要删除的卷</span><br><span class="line">[root@node01 ~]# gluster volume stop gv1</span><br><span class="line">[root@node01 ~]# gluster volume delete gv</span><br></pre></td></tr></table></figure>
<h4 id="16、监控负载"><a href="#16、监控负载" class="headerlink" title="16、监控负载"></a>16、监控负载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">volume profile &lt;VOLNAME&gt; &#123;start|info [peek|incremental [peek]|cumulative|clear]|stop&#125; [nfs]</span><br><span class="line">#启动性能分析：</span><br><span class="line">gluster volume profile gv5 start</span><br><span class="line">#显示io信息：</span><br><span class="line">gluster volume profile gv5 info</span><br><span class="line">#停止性能分析：</span><br><span class="line">gluster volume profile gv5 stop</span><br><span class="line"></span><br><span class="line">#使用top命令查看读取，写入，文件打开调用，读取调用，写入调用等指标：</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;open|read|write|opendir|readdir|clear&#125; [nfs|brick &lt;brick&gt;] [list-cnt &lt;value&gt;] |</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;read-perf|write-perf&#125; [bs &lt;size&gt; count &lt;count&gt;] [brick &lt;brick&gt;] [list-cnt &lt;value&gt;]</span><br><span class="line">#查看fd的当前打开数，和最大打开数</span><br><span class="line">gluster volume top gv5  open brick node1:/gfs/test1/gv5 list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Current open fds: 0, Max open fds: 1, Max openfd time: 2018-11-21 14:10:02.279118</span><br><span class="line"></span><br><span class="line">#显示文件读取调用数量：</span><br><span class="line">gluster volume top gv5  read brick node1:/gfs/test1/gv5 list-cnt  10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">1		/copy-test-002</span><br><span class="line">1		/copy-test-001</span><br><span class="line"></span><br><span class="line">#每个brick下面文件被写入的数量列表</span><br><span class="line">gluster volume top gv5  write brick node1:/gfs/test1/gv5 list-cnt  10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">12		/copy-test-100</span><br><span class="line">12		/copy-test-099</span><br><span class="line">12		/copy-test-098</span><br><span class="line">12		/copy-test-097</span><br><span class="line">12		/copy-test-096</span><br><span class="line">12		/copy-test-095</span><br><span class="line">12		/copy-test-094</span><br><span class="line">12		/copy-test-093</span><br><span class="line">12		/copy-test-092</span><br><span class="line">12		/copy-test-091</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被打开的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  opendir brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">1		/test</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被读的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  readdir brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">2		/test</span><br><span class="line"></span><br><span class="line">#查看brick的读性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5 read-perf bs 256  count 1 brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Throughput 51.20 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">==== ========                                        ====                      </span><br><span class="line">   0 /copy-test-001                                  2018-11-21 16:14:30.512003</span><br><span class="line">   0 /copy-test-003                                  2018-11-21 16:13:32.481649</span><br><span class="line">   0 /copy-test-002                                  2018-11-21 16:06:19.696071</span><br><span class="line">#查看brick的写性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  write-perf bs 256  count 1 brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Throughput 10.67 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">==== ========                                        ====                      </span><br><span class="line">   0 /.copy-test-001.swp                             2018-11-21 16:14:53.514516</span><br><span class="line">   0 /copy-test-001                                  2018-11-21 16:14:53.489068</span><br><span class="line">   0 /.copy-test-001.swp                             2018-11-21 16:14:30.483696</span><br><span class="line">   0 /.copy-test-003.swp                             2018-11-21 16:12:46.331094</span><br><span class="line">   0 /copy-test-100                                  2018-11-21 14:10:06.65163 </span><br><span class="line">   0 /copy-test-099                                  2018-11-21 14:10:05.953871</span><br><span class="line">   0 /copy-test-098                                  2018-11-21 14:10:05.773626</span><br><span class="line">   0 /copy-test-097                                  2018-11-21 14:10:05.620743</span><br><span class="line">   0 /copy-test-096                                  2018-11-21 14:10:05.591005</span><br><span class="line">   0 /copy-test-095                                  2018-11-21 14:10:05.555036</span><br><span class="line">#查看单个卷的信息：</span><br><span class="line">gluster volume info &lt;VOLNAME&gt;</span><br><span class="line"></span><br><span class="line">gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: e12e23f5-7347-4049-8d77-53cef76b0633</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) = 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv5</span><br><span class="line">Brick2: node2:/gfs/test1/gv5</span><br><span class="line">Brick3: node3:/gfs/test1/gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br><span class="line"></span><br><span class="line">#查看所有卷的信息：</span><br><span class="line">gluster volume info all</span><br><span class="line"></span><br><span class="line">#查看卷状态：</span><br><span class="line">gluster volume status [all| []] [detail|clients|mem|inode|fd|callpool]</span><br><span class="line">#显示所有卷的状态</span><br><span class="line">gluster volume status all</span><br><span class="line">#显示卷额外的信息：</span><br><span class="line">gluster volume status gv5  detail</span><br><span class="line">#显示客户端列表：</span><br><span class="line">gluster volume status gv5  clients</span><br><span class="line">#显示内存使用情况：</span><br><span class="line">gluster volume status gv5  mem</span><br><span class="line">#显示卷的inode表</span><br><span class="line">gluster volume status gv5  inode</span><br><span class="line">#显示卷打开的fd表</span><br><span class="line">gluster volume status gv5  fd</span><br><span class="line">#显示卷的挂起调用</span><br><span class="line">gluster volume status gv5  callpool</span><br></pre></td></tr></table></figure>
<h4 id="17、glusterfs其他信息查看"><a href="#17、glusterfs其他信息查看" class="headerlink" title="17、glusterfs其他信息查看"></a>17、glusterfs其他信息查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#看下节点有没有在线</span><br><span class="line">gluster volume status nfsp</span><br><span class="line">#启动完全修复</span><br><span class="line">gluster volume heal gv2 full</span><br><span class="line">#查看需要修复的文件</span><br><span class="line">gluster volume heal gv2 info</span><br><span class="line">#查看修复成功的文件</span><br><span class="line">gluster volume heal gv2 info healed</span><br><span class="line">#查看修复失败的文件</span><br><span class="line">gluster volume heal gv2 heal-failed</span><br><span class="line">#查看脑裂的文件</span><br><span class="line">gluster volume heal gv2 info split-brain</span><br><span class="line">#激活quota功能</span><br><span class="line">gluster volume quota gv2 enable</span><br><span class="line">#关闭quota功能</span><br><span class="line">gulster volume quota gv2 disable</span><br><span class="line">#目录限制（卷中文件夹的大小）</span><br><span class="line">gluster volume quota limit-usage /data/30MB --/gv2/data</span><br><span class="line">#quota信息列表</span><br><span class="line">gluster volume quota gv2 list</span><br><span class="line">#限制目录的quota信息</span><br><span class="line">gluster volume quota gv2 list /data</span><br><span class="line">#设置信息的超时时间</span><br><span class="line">gluster volume set gv2 features.quota-timeout 5</span><br><span class="line">#删除某个目录的quota设置</span><br><span class="line">gluster volume quota gv2 remove /data</span><br><span class="line">备注：quota功能，主要是对挂载点下的某个目录进行空间限额。如：/mnt/gulster/data目录，而不是对组成卷组的空间进行限制。</span><br></pre></td></tr></table></figure>
<h4 id="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"><a href="#18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。" class="headerlink" title="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"></a>18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gfszabbix监控</span><br><span class="line">https://github.com/MrCirca/zabbix-glusterfs</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/25/GlusterFS/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2018 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

<script>'use strict';'serviceWorker'in navigator&&navigator.serviceWorker.register('service-worker.js').then(function(a){a.onupdatefound=function(){var b=a.installing;b.onstatechange=function(){switch(b.state){case'installed':navigator.serviceWorker.controller?console.log('New or updated content is available.'):console.log('Content is now available offline!');break;case'redundant':console.error('The installing service worker became redundant.');}}}}).catch(function(a){console.error('Error during service worker registration:',a)});
</script></body></html>