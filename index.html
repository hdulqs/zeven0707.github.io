<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/27/optimize table运行是否支持online ddl/"><span>[Mysql] optimize table运行是否支持online ddl</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/27/optimize table运行是否支持online ddl/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-27T09:10:00.000Z">
          2018-11-27
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、相应官方文档"><a href="#0、相应官方文档" class="headerlink" title="0、相应官方文档"></a>0、相应官方文档</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（online ddl）官方文档提示当存在fulltext索引表进行优化表操作(optimize table)时是不支持online ddl的</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html#online-ddl-table-operations</span><br><span class="line">（optimize table）官方文档提示当存在索引时，对表进行优化不支持在线ddl</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/optimize-table.html</span><br></pre></td></tr></table></figure>
<p>下面分别对有主键索引、fulltext索引、无索引情况先查看是否支持online ddl;</p>
<h4 id="1、带有主键索引"><a href="#1、带有主键索引" class="headerlink" title="1、带有主键索引"></a>1、带有主键索引</h4><p>查看表结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:44:  [aaaa]&gt; show create table optimize_tb;</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table       | Create Table                                                                                                                                                                                     |</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb | CREATE TABLE `optimize_tb` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:44:  [aaaa]&gt; insert into optimize_tb (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (42.98 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:46:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.28 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]#  ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:44 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 15:46 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:47:  [aaaa]&gt; delete from optimize_tb limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (8.72 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:47:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.11 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件没有任何变化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:44 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 15:47 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:48:  [aaaa]&gt;  optimize table optimize_tb;</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table            | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb | optimize | status   | OK                                                                |</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (16.34 sec)</span><br></pre></td></tr></table></figure></p>
<p>session2执行插入语句操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:47:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.18 sec)</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8166638&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166639,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.25 sec)</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166640,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.25 sec)</span><br></pre></td></tr></table></figure></p>
<p>最后查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:48 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  28M 11月 27 15:48 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>数据插入成功，在有主键的情况下，使用optimize table可支持online ddl。</p>
<h4 id="2、带有fulltext索引"><a href="#2、带有fulltext索引" class="headerlink" title="2、带有fulltext索引"></a>2、带有fulltext索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:53:  [aaaa]&gt; create table optimize_tb1 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.65 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:53:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.04 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:53:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">ERROR 1075 (42000): Incorrect table definition; there can be only one auto column and it must be defined as a key</span><br></pre></td></tr></table></figure></p>
<p>因为存在自增约束，报错，需要删除约束<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:54:  [aaaa]&gt; alter table optimize_tb1 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (2.84 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:54:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.45 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:54:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:55:  [aaaa]&gt; insert into optimize_tb1 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (26.04 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:56:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.48 sec)</span><br></pre></td></tr></table></figure></p>
<p>创建fulltext 索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:56:  [aaaa]&gt; create fulltext index name_fullind on optimize_tb1(name);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (1 min 12.58 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 1</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:56 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 15:58 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:58:  [aaaa]&gt; delete from optimize_tb1 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (1 min 13.37 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:59:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.50 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:56 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 15:59 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1对表进行优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:59:  [aaaa]&gt; optimize table optimize_tb1;</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table             | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb1 | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb1 | optimize | status   | OK                                                                |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (1 min 13.65 sec)</span><br></pre></td></tr></table></figure></p>
<p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:00:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看数据库线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:00:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |   41 | copy to tmp table               | optimize table optimize_tb1                                      |</span><br><span class="line">|  7 | root | localhost | aaaa | Query   |   40 | Waiting for table metadata lock | insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">|  8 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:00 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:02 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>当表存在fulltext索引是，执行optimize table会锁表，其他会话连接进来无法做增删改操作。</p>
<h4 id="3、表不存在任何索引"><a href="#3、表不存在任何索引" class="headerlink" title="3、表不存在任何索引"></a>3、表不存在任何索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; create table optimize_tb2 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.60 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; alter table optimize_tb2 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.60 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; alter table optimize_tb2 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (3.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; insert into optimize_tb2 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (11.85 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:06:  [aaaa]&gt; </span><br><span class="line">root@db 16:07:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.41 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:04 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:06 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:07:  [aaaa]&gt; delete from optimize_tb2 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (2.50 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:11:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.29 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:04 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:11 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1对表进行优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:11:  [aaaa]&gt; optimize table optimize_tb2;</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table             | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb2 | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb2 | optimize | status   | OK                                                                |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (22.04 sec</span><br></pre></td></tr></table></figure></p>
<p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.35 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.44 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.24 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.38 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.20 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:11 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  32M 11月 27 16:12 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>在没有任何索引的情况下，insert语句成功。</p>
<h4 id="4、当mysql环境变量-old-alter-table为enabled（默认为off）或者-mysql启动参数添加了skip-new选项时，运行optimize-table命令，会使用table-copy的方式重建表，此时online-ddl是不可用的，下面添加skip-new参数重新进行测试。"><a href="#4、当mysql环境变量-old-alter-table为enabled（默认为off）或者-mysql启动参数添加了skip-new选项时，运行optimize-table命令，会使用table-copy的方式重建表，此时online-ddl是不可用的，下面添加skip-new参数重新进行测试。" class="headerlink" title="4、当mysql环境变量 old_alter_table为enabled（默认为off）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，此时online ddl是不可用的，下面添加skip-new参数重新进行测试。"></a>4、当mysql环境变量 old_alter_table为enabled（默认为off）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，此时online ddl是不可用的，下面添加skip-new参数重新进行测试。</h4><p>在/etc/my.cnf添加参数skip-new，重新启动mysql：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# more /etc/my.cnf|grep skip-new</span><br><span class="line">skip-new</span><br><span class="line">[root@dax-mysql-master aaaa]# /etc/init.d/mysql restart</span><br><span class="line">Shutting down MySQL....... SUCCESS! </span><br><span class="line">Starting MySQL..... SUCCESS!</span><br></pre></td></tr></table></figure></p>
<p>删除上面的测试表，再次进行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:21:  [aaaa]&gt; drop table optimize_tb,optimize_tb1,optimize_tb2;</span><br><span class="line">Query OK, 0 rows affected (1.58 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="5、带有主键索引"><a href="#5、带有主键索引" class="headerlink" title="5、带有主键索引"></a>5、带有主键索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:23:  [aaaa]&gt; create table optimize_tb like testfororder;</span><br><span class="line">Query OK, 0 rows affected (1.29 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:23:  [aaaa]&gt; insert into optimize_tb (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (33.65 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:24:  [aaaa]&gt; show create table optimize_tb;</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table       | Create Table                                                                                                                                                                                                            |</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb | CREATE TABLE `optimize_tb` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=8166638 DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:25:  [aaaa]&gt;  select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.25 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:23 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:24 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:26:  [aaaa]&gt; delete from optimize_tb limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (9.18 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:26:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.13 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:23 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:26 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; optimize table optimize_tb;</span><br><span class="line">Query OK, 500000 rows affected (26.01 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session2执行插入操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                            |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |   19 | copy to tmp table               | optimize table optimize_tb                                      |</span><br><span class="line">|  3 | root | localhost | aaaa | Query   |   11 | Waiting for table metadata lock | insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:27 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  28M 11月 27 16:27 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p>
<p>在存在主键索引的情况下，数据插入失败，提示锁等待超时。</p>
<h4 id="6、表中带有fulltext索引"><a href="#6、表中带有fulltext索引" class="headerlink" title="6、表中带有fulltext索引"></a>6、表中带有fulltext索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:31:  [aaaa]&gt; create table optimize_tb1 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (1.07 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:31:  [aaaa]&gt; alter table optimize_tb1 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.13 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.41 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:32:  [aaaa]&gt; insert into optimize_tb1 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (14.49 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:32:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.44 sec)</span><br></pre></td></tr></table></figure></p>
<p>创建fulltext 索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:33:  [aaaa]&gt; create fulltext index name_fullind on optimize_tb1(name);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (57.22 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 1</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:33 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 16:34 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:34:  [aaaa]&gt; delete from optimize_tb1 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (59.90 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:35:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.69 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:33 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 16:36 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行对表进行优化操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:36:  [aaaa]&gt; optimize table optimize_tb1;</span><br><span class="line">Query OK, 500000 rows affected (55.85 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:37:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 16:37:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:37:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |    9 | copy to tmp table               | optimize table optimize_tb1                                      |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |    8 | Waiting for table metadata lock | insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:37 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:38 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p>
<p>在存在fulltext索引的情况下，数据插入失败，提示锁等待超时。</p>
<h4 id="7、表中没有任何索引"><a href="#7、表中没有任何索引" class="headerlink" title="7、表中没有任何索引"></a>7、表中没有任何索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:38:  [aaaa]&gt; create table optimize_tb2 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.44 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:39:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; alter table optimize_tb2 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.39 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; alter table optimize_tb2 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:40:  [aaaa]&gt; insert into optimize_tb2 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (16.74 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:41:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.49 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:40 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:41 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:42:  [aaaa]&gt; delete from optimize_tb2 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (3.96 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:42:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.32 sec)</span><br></pre></td></tr></table></figure></p>
<p>数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:40 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:42 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p>
<p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:42:  [aaaa]&gt; optimize table optimize_tb2;</span><br><span class="line">Query OK, 500000 rows affected (23.61 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session2执行插入数据操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:43:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:43:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |    7 | copy to tmp table               | optimize table optimize_tb2                                      |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |    6 | Waiting for table metadata lock | insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在没有任何索引的情况下，插入数据锁等待</p>
<h4 id="8、结论"><a href="#8、结论" class="headerlink" title="8、结论"></a>8、结论</h4><p>当mysql环境变量 old_alter_table为enabled（默认为disabled）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，无论表中有无索引，此时online ddl是不可用的；<br>当mysql环境变量old_alter_table为disabled（默认为disabled）或者 mysql启动参数没有添加了skip-new选项时，运行optimize table命令，当表中不存在fulltext索引时，online ddl可用，当表中存在fulltext索引是，online ddl不可用。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/27/optimize table运行是否支持online ddl/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/25/mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires/"><span>[Mysql] mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires.&#39;, Error_code: 1236</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/25/mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-25T14:51:00.000Z">
          2018-11-25
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、实验环境介绍："><a href="#0、实验环境介绍：" class="headerlink" title="0、实验环境介绍："></a>0、实验环境介绍：</h4><p>mysql-mgr单主模式主节点1、从节点1、从节点2</p>
<h4 id="1、实验一，手动删除主库binlog日志文件"><a href="#1、实验一，手动删除主库binlog日志文件" class="headerlink" title="1、实验一，手动删除主库binlog日志文件"></a>1、实验一，手动删除主库binlog日志文件</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行stop group_replication;</span><br></pre></td></tr></table></figure></p>
<p>主库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#切换日志，创建表gtid_test10,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test10 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 05:48:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000029 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-27 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#切换日志，创建表gtid_test10,并查看当前的binlog日志文件：</span><br><span class="line">root@db 05:48:  [test]&gt; flush logs;create table gtid_test11 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">root@db 05:48:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000030 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-28 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#主库手动移除binlog文件：</span><br><span class="line">mv mysql-binlog.000029 /tmp/</span><br></pre></td></tr></table></figure></p>
<p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">执行start group_replication;</span><br><span class="line">#查看从库2的日志</span><br><span class="line">2018-09-18T05:49:55.983888Z 93 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T05:49:55.984034Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:31.&apos;</span><br><span class="line">2018-09-18T05:49:56.054981Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:56.144944Z 93 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T05:49:56.155058Z 95 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T05:49:56.157141Z 95 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T05:49:56.179441Z 96 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T05:49:56.326072Z 95 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: Could not open log file (server_errno=1236)</span><br><span class="line">2018-09-18T05:49:56.326236Z 95 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;Could not open log file&apos;, Error_code: 1236</span><br><span class="line">#因为已经手动删除了binlog文件，从库2无法从主库获取到binlog文件，报错</span><br><span class="line">2018-09-18T05:49:56.326310Z 95 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000029&apos;, position 4</span><br><span class="line">2018-09-18T05:49:56.326422Z 93 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T05:49:56.347776Z 96 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T05:49:56.438760Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:56.510091Z 93 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</span><br><span class="line">2018-09-18T05:49:56.572561Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从库2开始尝试从从库1节点获取binlog文件，因为只是删除了主库节点的binlog文件，从库1的文件未删除，从库2获取到所需要的文件，开始进行同步。</span><br><span class="line">2018-09-18T05:49:56.643413Z 93 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T05:49:56.643906Z 99 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T05:49:56.646363Z 99 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T05:49:56.666439Z 100 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T05:49:56.882987Z 93 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T05:49:56.905507Z 99 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T05:49:56.905535Z 99 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000005&apos;, position 10512</span><br><span class="line">2018-09-18T05:49:56.999936Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:57.084035Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p>
<p>同步完成。</p>
<h4 id="2、实验二，使用purge命令删除主库binlog文件"><a href="#2、实验二，使用purge命令删除主库binlog文件" class="headerlink" title="2、实验二，使用purge命令删除主库binlog文件"></a>2、实验二，使用purge命令删除主库binlog文件</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication:</span><br></pre></td></tr></table></figure></p>
<p>主库1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#切换日志，创建表gtid_test12,并查看当前的binlog日志文件：</span><br><span class="line">root@db 06:04:  [test]&gt; flush logs;create table gtid_test12 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 06:04:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000033 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-30 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#切换日志，创建表gtid_test13,并查看当前的binlog日志文件：</span><br><span class="line">root@db 06:04:  [test]&gt; flush logs;create table gtid_test13 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 06:04:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000034 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-31 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#主库清除mysql-binlog.000034之前的所有binlog日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000034&apos;;</span><br><span class="line">#查看日志log目录下的34之前的日志已经全部清除：</span><br><span class="line">ll mysql-binlog.*</span><br><span class="line">-rw-r----- 1 mysql mysql 493 Sep 18 06:04 mysql-binlog.000034</span><br><span class="line">-rw-r----- 1 mysql mysql  36 Sep 18 06:22 mysql-binlog.index</span><br><span class="line"></span><br><span class="line">#查看主库gtid信息，gtid_purged已经有记录：</span><br><span class="line">show global variables like &apos;%gtid%&apos;;</span><br><span class="line">root@db 06:37:  [test]&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                                                                                                                                                     |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery                       | ON                                                                                                                                                                        |</span><br><span class="line">| enforce_gtid_consistency                          | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_allow_local_disjoint_gtids_join | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_gtid_assignment_block_size      | 1000000                                                                                                                                                                   |</span><br><span class="line">| gtid_executed                                     | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-31 |</span><br><span class="line">| gtid_executed_compression_period                  | 1000                                                                                                                                                                      |</span><br><span class="line">| gtid_mode                                         | ON                                                                                                                                                                        |</span><br><span class="line">| gtid_owned                                        |                                                                                                                                                                           |</span><br><span class="line">| gtid_purged                                       | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-30 |</span><br><span class="line">| session_track_gtids                               | OFF                                                                                                                                                                       |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>从节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p>
<p>查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T06:38:36.664372Z 107 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2&quot;; group_replication_local_address: &quot;dax-mysql-slave2:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-slave:24901,dax-mysql-master:24901,dax-mysql-slave2:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-09-18T06:38:36.664408Z 107 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-09-18T06:38:36.664428Z 107 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-09-18T06:38:36.664457Z 107 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;c6ac9ccd-b80b-11e8-b968-000d3a801bf4&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-09-18T06:38:36.664812Z 109 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 493, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:38:36.736702Z 107 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-09-18T06:38:36.736749Z 107 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-09-18T06:38:36.736774Z 107 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-09-18T06:38:36.736708Z 112 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000014&apos; position: 4</span><br><span class="line">2018-09-18T06:38:36.737167Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-09-18T06:38:36.737227Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-09-18T06:38:38.815550Z 107 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address dax-mysql-master:3306.&apos;</span><br><span class="line">2018-09-18T06:38:38.815711Z 0 [ERROR] Plugin group_replication reported: &apos;Group contains 3 members which is greater than group_replication_auto_increment_increment value of 1. This can lead to an higher rate of transactional aborts.&apos;</span><br><span class="line">2018-09-18T06:38:38.816035Z 117 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T06:38:38.816125Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:33.&apos;</span><br><span class="line">2018-09-18T06:38:38.881138Z 117 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从节点2选择从从节点1获取binlog文件，因为从节点1文件没有删除，获取binlog文件正常。</span><br><span class="line">2018-09-18T06:38:38.959786Z 117 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T06:38:38.960147Z 119 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T06:38:38.962244Z 119 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T06:38:38.982193Z 120 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T06:38:39.194864Z 117 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T06:38:39.218168Z 119 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T06:38:39.218197Z 119 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000005&apos;, position 11362</span><br><span class="line">2018-09-18T06:38:39.313623Z 117 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:38:39.400236Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p>
<p>同步完成。</p>
<h4 id="3、实验三，删除主库节点和从节点1的binlog文件。"><a href="#3、实验三，删除主库节点和从节点1的binlog文件。" class="headerlink" title="3、实验三，删除主库节点和从节点1的binlog文件。"></a>3、实验三，删除主库节点和从节点1的binlog文件。</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br></pre></td></tr></table></figure></p>
<p>主库1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">3切换日志，创建表gtid_test14,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test14 (ID int) engine=innodb;</span><br><span class="line">show master status;</span><br><span class="line">#切换日志，创建表gtid_test15,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test15 (ID int) engine=innodb;</span><br><span class="line">show master status;</span><br><span class="line">#清除mysql-binlog.000036之前的日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000036&apos;;</span><br><span class="line">[root@dax-mysql-master log]# ll mysql-binlog.*</span><br><span class="line">-rw-r----- 1 mysql mysql 493 Sep 18 06:53 mysql-binlog.000036</span><br><span class="line">-rw-r----- 1 mysql mysql  36 Sep 18 06:56 mysql-binlog.index</span><br></pre></td></tr></table></figure></p>
<p>从库1删除binlog日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                                                 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000005 |    11728 |              |                  | 324a6fd1-ba55-11e8-b3ff-000d3a800ed3:1,</span><br><span class="line">8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-34 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#切换binlog日志：</span><br><span class="line">flush logs;</span><br><span class="line">show master status;</span><br><span class="line">root@db 06:57:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                                                 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000006 |      350 |              |                  | 324a6fd1-ba55-11e8-b3ff-000d3a800ed3:1,</span><br><span class="line">8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-34 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">[root@dax-mysql-slave log]# ll </span><br><span class="line">total 96</span><br><span class="line">-rw-r----- 1 mysql mysql 53478 Sep 18 06:49 error.log</span><br><span class="line">-rw-r----- 1 mysql mysql   177 Sep 17 08:39 mysql-binlog.000001</span><br><span class="line">-rw-r----- 1 mysql mysql   437 Sep 17 09:21 mysql-binlog.000002</span><br><span class="line">-rw-r----- 1 mysql mysql   217 Sep 17 09:25 mysql-binlog.000003</span><br><span class="line">-rw-r----- 1 mysql mysql   209 Sep 17 09:26 mysql-binlog.000004</span><br><span class="line">-rw-r----- 1 mysql mysql 11774 Sep 18 06:57 mysql-binlog.000005</span><br><span class="line">-rw-r----- 1 mysql mysql   350 Sep 18 06:57 mysql-binlog.000006</span><br><span class="line">-rw-r----- 1 mysql mysql   216 Sep 18 06:57 mysql-binlog.index</span><br><span class="line">-rw-r--r-- 1 mysql mysql     0 Sep 17 08:36 mysqld.log</span><br><span class="line">-rw-r----- 1 mysql mysql  1968 Sep 18 06:57 slow.log</span><br><span class="line">#删除mysql-binlog.000006之前的所有日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000006&apos;;</span><br><span class="line">[root@dax-mysql-slave log]# ll </span><br><span class="line">total 68</span><br><span class="line">-rw-r----- 1 mysql mysql 53478 Sep 18 06:49 error.log</span><br><span class="line">-rw-r----- 1 mysql mysql   350 Sep 18 06:57 mysql-binlog.000006</span><br><span class="line">-rw-r----- 1 mysql mysql    36 Sep 18 06:58 mysql-binlog.index</span><br><span class="line">-rw-r--r-- 1 mysql mysql     0 Sep 17 08:36 mysqld.log</span><br><span class="line">-rw-r----- 1 mysql mysql  1968 Sep 18 06:57 slow.log</span><br></pre></td></tr></table></figure></p>
<p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start group_replicatinon;</span><br></pre></td></tr></table></figure></p>
<p>查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T06:59:20.236425Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</span><br><span class="line">2018-09-18T06:59:20.309947Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:59:20.391623Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T06:59:20.391891Z 142 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T06:59:20.394226Z 142 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T06:59:20.416722Z 143 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T06:59:20.424400Z 142 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T06:59:20.424467Z 142 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T06:59:20.424488Z 142 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T06:59:20.424640Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T06:59:20.436806Z 143 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T06:59:20.522269Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:59:20.603837Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 3/10&apos;</span><br><span class="line">2018-09-18T07:00:20.679461Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:00:20.762021Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T07:00:20.762368Z 146 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:00:20.764842Z 146 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:00:20.787728Z 147 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:00:20.794590Z 146 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T07:00:20.794623Z 146 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T07:00:20.794635Z 146 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T07:00:20.794786Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:00:20.807977Z 147 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T07:00:20.895774Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从库2多次尝试从从库1获取binlog日志，没有成功，切换master_host节点，尝试从主库获取binlog日志文件：</span><br><span class="line">2018-09-18T07:00:20.980112Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 4/10&apos;</span><br><span class="line">2018-09-18T07:00:21.052930Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:00:21.141126Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T07:00:21.141498Z 150 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:00:21.143773Z 150 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:00:21.166993Z 151 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:00:21.171461Z 150 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T07:00:21.171518Z 150 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T07:00:21.171528Z 150 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T07:00:21.171645Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:00:21.186565Z 151 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T07:00:21.271867Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">....</span><br><span class="line">[ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br></pre></td></tr></table></figure></p>
<p>因为主库1和从库1的binlog文件都删除，从库2无法同步，最后退出集群。</p>
<h4 id="4、查看主库清除的日志"><a href="#4、查看主库清除的日志" class="headerlink" title="4、查看主库清除的日志"></a>4、查看主库清除的日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                                                                                                                                                     |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery                       | ON                                                                                                                                                                        |</span><br><span class="line">| enforce_gtid_consistency                          | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_allow_local_disjoint_gtids_join | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_gtid_assignment_block_size      | 1000000                                                                                                                                                                   |</span><br><span class="line">| gtid_executed                                     | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-35 |</span><br><span class="line">| gtid_executed_compression_period                  | 1000                                                                                                                                                                      |</span><br><span class="line">| gtid_mode                                         | ON                                                                                                                                                                        |</span><br><span class="line">| gtid_owned                                        |                                                                                                                                                                           |</span><br><span class="line">| gtid_purged                                       | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33 |</span><br><span class="line">| session_track_gtids                               | OFF                                                                                                                                                                       |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>从库2尝试过滤掉缺失的那部分日志，然后重新加入集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">reset master;</span><br><span class="line">set global GTID_PURGED=&quot;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,d240752c-b809-11e8-8947-000d3a800ed3:1,dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&quot;;</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p>
<p>再次查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T07:08:05.524626Z 125 [Note] @@GLOBAL.GTID_PURGED was changed from &apos;&apos; to &apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&apos;.</span><br><span class="line">2018-09-18T07:08:05.524661Z 125 [Note] @@GLOBAL.GTID_EXECUTED was changed from &apos;&apos; to &apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&apos;.</span><br><span class="line">2018-09-18T07:08:20.457841Z 125 [Note] Plugin group_replication reported: &apos;Group communication SSL configuration: group_replication_ssl_mode: &quot;DISABLED&quot;&apos;</span><br><span class="line">2018-09-18T07:08:20.457971Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 10.0.7.51/24,127.0.0.1/8 to the whitelist&apos;</span><br><span class="line">2018-09-18T07:08:20.458188Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Translated &apos;dax-mysql-slave2&apos; to 10.0.7.51&apos;</span><br><span class="line">2018-09-18T07:08:20.458321Z 125 [Warning] Plugin group_replication reported: &apos;[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.&apos;</span><br><span class="line">2018-09-18T07:08:20.458401Z 125 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</span><br><span class="line">2018-09-18T07:08:20.458433Z 125 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2&quot;; group_replication_local_address: &quot;dax-mysql-slave2:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-slave:24901,dax-mysql-master:24901,dax-mysql-slave2:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-09-18T07:08:20.458473Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-09-18T07:08:20.458480Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-09-18T07:08:20.458503Z 125 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;c6ac9ccd-b80b-11e8-b968-000d3a801bf4&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-09-18T07:08:20.458664Z 181 [Note] Plugin group_replication reported: &apos;Detected previous RESET MASTER invocation or an issue exists in the group replication applier relay log. Purging existing applier logs.&apos;</span><br><span class="line">2018-09-18T07:08:20.531810Z 181 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:20.632692Z 125 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-09-18T07:08:20.632736Z 125 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-09-18T07:08:20.632758Z 125 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-09-18T07:08:20.632694Z 184 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:08:20.632947Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-09-18T07:08:20.632977Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-09-18T07:08:22.329812Z 125 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address dax-mysql-master:3306.&apos;</span><br><span class="line">2018-09-18T07:08:22.329901Z 0 [ERROR] Plugin group_replication reported: &apos;Group contains 3 members which is greater than group_replication_auto_increment_increment value of 1. This can lead to an higher rate of transactional aborts.&apos;</span><br><span class="line">2018-09-18T07:08:22.330145Z 189 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T07:08:22.330221Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:37.&apos;</span><br><span class="line">2018-09-18T07:08:22.394512Z 189 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:22.468142Z 189 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T07:08:22.468378Z 191 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:08:22.470340Z 191 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:08:22.490866Z 192 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:08:22.632774Z 189 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:08:22.653083Z 191 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T07:08:22.653098Z 191 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000036&apos;, position 1381</span><br><span class="line">2018-09-18T07:08:22.734186Z 189 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:22.808784Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p>
<p>此时从库2与主库、从库1的数据是不一致的，gtid_test14表时不存在的，因此需要使用pt-table-checksum和pt-table-sync去同步，但是该方法在mysql-mgr环境下测试没有成功。<br>另一种方法是直接备份一份主节点的最新备份数据，在从库2上恢复。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/25/mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/25/GlusterFS/"><span>[Linux] GlusterFS部署详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/25/GlusterFS/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-25T12:59:30.000Z">
          2018-11-25
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、安装之前须知："><a href="#0、安装之前须知：" class="headerlink" title="0、安装之前须知："></a>0、安装之前须知：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">推荐使用xfs，没用xfs推荐使用ext4，其他文件系统也可兼容；</span><br><span class="line">生产环境DNS NTP服务必须安装,DNS服务配置可点击[此处](https://zeven0707.github.io/2018/11/22/DNS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/)；</span><br><span class="line">如果是虚拟机环境最少1G内存；</span><br><span class="line">最好配置2个网卡，一个管理接口，一个数据传输接口；</span><br><span class="line">如果使用vm克隆额外的机器，确保glusterfs没有安装，如果安装了Gluster,会在每个系统上生产一个uuid，因此如果克隆了一个已经安装了gluster的系统，后面会报错；</span><br><span class="line">如果使用物理服务器，建议最低配置（2 CPU’s, 2GB of RAM, 1GBE），板载组件不如附加组件强大；</span><br><span class="line">安装官方文档，点击[此处](https://docs.gluster.org/en/latest/Install-Guide/Install/)</span><br><span class="line">centos7快速安装指南，点击[此处](https://wiki.centos.org/SpecialInterestGroup/Storage/gluster-Quickstart)</span><br><span class="line">/var/log目录最好单独挂在，一旦日志目录无法写入信息，gluster fs会出现古怪现象</span><br></pre></td></tr></table></figure>
<h4 id="1、配置yum源"><a href="#1、配置yum源" class="headerlink" title="1、配置yum源"></a>1、配置yum源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-gluster</span><br></pre></td></tr></table></figure>
<h4 id="2、在两个节点上添加磁盘，格式化-并挂在目录"><a href="#2、在两个节点上添加磁盘，格式化-并挂在目录" class="headerlink" title="2、在两个节点上添加磁盘，格式化,并挂在目录"></a>2、在两个节点上添加磁盘，格式化,并挂在目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#格式化磁盘，创建相应的挂在目录</span><br><span class="line">mkfs.xfs -i size=512 /dev/sdb1</span><br><span class="line">mkdir -p /gfs/test1</span><br><span class="line">#将挂在配置信息写入fstab配置文件，以便重启自动挂载</span><br><span class="line">vi /etc/fstab</span><br><span class="line">/dev/sdb1 /gfs/test1 xfs defaults 1 2</span><br><span class="line">#加载修改的配置信息</span><br><span class="line">mount -a &amp;&amp; mount</span><br></pre></td></tr></table></figure>
<p>Note: 在CentOS 6操作系统,需要安装xfs文件系统：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xfsprogs</span><br></pre></td></tr></table></figure></p>
<h4 id="3、安装、配置glusterd服务"><a href="#3、安装、配置glusterd服务" class="headerlink" title="3、安装、配置glusterd服务"></a>3、安装、配置glusterd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install glusterfs-server</span><br></pre></td></tr></table></figure>
<p>启动GlusterFS 管理进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#加入开机启动</span><br><span class="line">systemctl enable glusterd</span><br><span class="line">ln -s &apos;/usr/lib/systemd/system/glusterd.service&apos; &apos;/etc/systemd/system/multi-user.target.wants/glusterd.service&apos;</span><br><span class="line">#启动glusterd</span><br><span class="line">systemctl start glusterd</span><br><span class="line">#查看glusterd状态信息</span><br><span class="line">systemctl status glusterd</span><br><span class="line">● glusterd.service - GlusterFS, a clustered file-system server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/glusterd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-11-15 12:08:54 EST; 15s ago</span><br><span class="line">  Process: 2808 ExecStart=/usr/sbin/glusterd -p /var/run/glusterd.pid --log-level $LOG_LEVEL $GLUSTERD_OPTIONS (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 2810 (glusterd)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   CGroup: /system.slice/glusterd.service</span><br><span class="line">           └─2810 /usr/sbin/glusterd -p /var/run/glusterd.pid --log-level INFO</span><br><span class="line"></span><br><span class="line">Nov 15 12:08:53 node1 systemd[1]: Starting GlusterFS, a clustered file-system server...</span><br><span class="line">Nov 15 12:08:54 node1 systemd[1]: Started GlusterFS, a clustered file-system server.</span><br></pre></td></tr></table></figure></p>
<h4 id="4、防火墙配置"><a href="#4、防火墙配置" class="headerlink" title="4、防火墙配置"></a>4、防火墙配置</h4><p>默认glusted监听tcp/24007 ，但是你增加一个brick，会开启一个新的端口，通过命令”gluster volume status”可以查询到<br>，因此如果各个节点配置了防火墙，新增一个brick之后，需要注意修改防火墙的端口限制，不然下面的配置受信任池会报错。</p>
<h4 id="5、配置受信任池"><a href="#5、配置受信任池" class="headerlink" title="5、配置受信任池"></a>5、配置受信任池</h4><p>node1操作，将node2添加到受信任池：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: success.</span><br></pre></td></tr></table></figure></p>
<p>如果防火墙开启可能会提示下面错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: failed: Probe returned with Transport endpoint is not connected</span><br></pre></td></tr></table></figure></p>
<p>node2操作，将node1添加到受信任池<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# gluster peer probe node1</span><br><span class="line">peer probe: success. Host node1 port 24007 already in peer list</span><br></pre></td></tr></table></figure></p>
<h4 id="6、建立GlusterFS-volume"><a href="#6、建立GlusterFS-volume" class="headerlink" title="6、建立GlusterFS volume"></a>6、建立GlusterFS volume</h4><p>node1 and node2操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /gfs/test1/gv0</span><br></pre></td></tr></table></figure></p>
<p>在任意一个节点上执行即可，不需要重复执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv0 replica 2 node1:/gfs/test1/gv0 node2:/gfs/test1/gv0</span><br><span class="line">[root@node1 ~]# gluster volume create gv0 replica 2 node1:/gfs/test1/gv0 node2:/gfs/test1/gv0</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">volume create: gv0: success: please start the volume to access data</span><br></pre></td></tr></table></figure></p>
<p>提示只有2个副本有可能出现脑裂的情况，创建带有仲裁节点以上的gluserfs volume至少三个节点，因此两个节点的副本集可以只能忽略这个问题。<br>下面启动创建的gv0卷<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume start gv0</span><br><span class="line">[root@node1 ~]# gluster volume start gv0</span><br><span class="line">volume start: gv0: success</span><br><span class="line">Confirm that the volume shows &quot;Started&quot;:</span><br></pre></td></tr></table></figure></p>
<p>查看启动的gv0卷信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume info</span><br><span class="line">[root@node1 ~]# gluster volume info</span><br><span class="line"> </span><br><span class="line">Volume Name: gv0</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: 79c81f10-0cb8-4f26-a7ab-d21fe19f0bbf</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x 2 = 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv0</span><br><span class="line">Brick2: node2:/gfs/test1/gv0</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure></p>
<p>/var/log/glusterfs如果没有正常启动，可以查看日志</p>
<h4 id="7、测试Glusterfs-volume-gv0副本集是否生效"><a href="#7、测试Glusterfs-volume-gv0副本集是否生效" class="headerlink" title="7、测试Glusterfs volume gv0副本集是否生效"></a>7、测试Glusterfs volume gv0副本集是否生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#挂在到任意空目录</span><br><span class="line">mount -t glusterfs node1:/gv0 /mnt</span><br><span class="line">#创造测试数据</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#查看生成数据的数量</span><br><span class="line">ls  /mnt | wc -l</span><br><span class="line">#在node1和node2的/gfs/test1/gv0目录下均生成了100个文件</span><br><span class="line">ls /gfs/test1/gv0 |wc -l</span><br></pre></td></tr></table></figure>
<p>[root@node1 ~]# gluster volume create gv1 disperse 2 node1:/gfs/test1/gv1 node2:/gfs/test1/gv1<br>disperse count must be greater than 2<br>disperse option given twice</p>
<p>Usage:<br>volume create <new-volname> [stripe <count>] [replica <count> [arbiter <count>]] [disperse [<count>]] [disperse-data <count>] [redundancy <count>] [transport &lt;tcp|rdma|tcp,rdma&gt;] <new-brick>?&lt;vg_name&gt;… [force]</new-brick></count></count></count></count></count></count></new-volname></p>
<h4 id="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"><a href="#8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来" class="headerlink" title="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"></a>8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node3</span><br><span class="line">[root@node1 ~]# gluster peer status</span><br><span class="line">Number of Peers: 2</span><br><span class="line"></span><br><span class="line">Hostname: node2</span><br><span class="line">Uuid: 588d2f92-f085-4e74-ab63-c6f5aa6ffb24</span><br><span class="line">State: Peer in Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: node3</span><br><span class="line">Uuid: 3495bc9c-7330-4038-ac94-1777ba0286f5</span><br><span class="line">State: Peer in Cluster (Connected)</span><br></pre></td></tr></table></figure>
<h4 id="9、创建2节点分布式volume"><a href="#9、创建2节点分布式volume" class="headerlink" title="9、创建2节点分布式volume"></a>9、创建2节点分布式volume</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建卷不添加任何参数的情况下，默认模式为分布式：</span><br><span class="line">#gluster volume create gv3 node1:/gfs/test1/gv3 node2:/gfs/test1/gv3</span><br><span class="line">[root@node1 ~]# gluster volume create gv3 node1:/gfs/test1/gv3 node2:/gfs/test1/gv3</span><br><span class="line">volume create: gv1: success: please start the volume to access data</span><br><span class="line"># 启动gv3</span><br><span class="line"># gluster volume start gv3</span><br><span class="line">[root@node1 ~]# gluster volume start gv3</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# gluster volume info gv3</span><br><span class="line"></span><br><span class="line">Volume Name: gv3</span><br><span class="line">Type: Distribute</span><br><span class="line">Volume ID: 02e3163b-1c69-402f-aad5-9cf4dba3267c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv3</span><br><span class="line">Brick2: node2:/gfs/test1/gv3</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br></pre></td></tr></table></figure>
<h4 id="10、测试Glusterfs-volume-gv3"><a href="#10、测试Glusterfs-volume-gv3" class="headerlink" title="10、测试Glusterfs volume gv3"></a>10、测试Glusterfs volume gv3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:/gv3 /mnt</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#node1查看数据：</span><br><span class="line">[root@node1 gv3]# ls  /mnt | wc -l</span><br><span class="line">100</span><br><span class="line">#node1:查看文件实际位置下的数据：</span><br><span class="line">[root@node1 gv3]# ls /gfs/test1/gv3/ |wc -l</span><br><span class="line">50</span><br><span class="line">#node2：查看文件实际位置下的数据：</span><br><span class="line">[root@node2 gv3]# ls /gfs/test1/gv3/ |wc -l</span><br><span class="line">50</span><br><span class="line">#虽然在节点3没有生成集群卷，在节点3上挂在/gv3也可以看到数据：</span><br><span class="line">mount -t glusterfs 127.0.0.1:/gv3 /mnt</span><br><span class="line">[root@node3 mnt]# ls /mnt/ |wc -l</span><br><span class="line">100</span><br></pre></td></tr></table></figure>
<h4 id="11、创建分布式副本"><a href="#11、创建分布式副本" class="headerlink" title="11、创建分布式副本"></a>11、创建分布式副本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 node4:/gfs/test1/gv4</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 </span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">number of bricks is not a multiple of replica count</span><br><span class="line">#创建副本的节点数要和副本个数成倍数关系</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 node4:/gfs/test1/gv4</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">volume create: gv4: success: please start the volume to access data</span><br><span class="line">[root@node1 test1]# gluster volume start gv4</span><br><span class="line">[root@node1 test1]# gluster volume info gv4</span><br><span class="line">Volume Name: gv4</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: e8556b2e-462d-4407-99c4-a6e622754e6c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2 x 2 = 4</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv4</span><br><span class="line">Brick2: node2:/gfs/test1/gv4</span><br><span class="line">Brick3: node3:/gfs/test1/gv4</span><br><span class="line">Brick4: node4:/gfs/test1/gv4</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h4 id="12、测试Glusterfs-volume-gv4"><a href="#12、测试Glusterfs-volume-gv4" class="headerlink" title="12、测试Glusterfs volume gv4:"></a>12、测试Glusterfs volume gv4:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:/gv4 /mnt</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#查看数据分布，node1与node2数据相同，node3和node4存储另一半信息</span><br><span class="line">[root@node1 test1]# ls /gfs/test1/gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node2 gv0]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node3 test]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node4 ~]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br></pre></td></tr></table></figure>
<h4 id="13、创建带有仲裁的副本集"><a href="#13、创建带有仲裁的副本集" class="headerlink" title="13、创建带有仲裁的副本集"></a>13、创建带有仲裁的副本集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test1]# gluster volume create gv5 replica 2 arbiter 2 transport tcp node1:/gfs/test1/gv5 node2:/gfs/test1/gv5 node3:/gfs/test1/gv5</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">For arbiter configuration, replica count must be 3 and arbiter count must be 1. The 3rd brick of the replica will be the arbiter</span><br><span class="line">#提示创建仲裁必须是三个副本集</span><br><span class="line">[root@node1 test1]# gluster volume create gv5 replica 3 arbiter 1 transport tcp node1:/gfs/test1/gv5 node2:/gfs/test1/gv5 node3:/gfs/test1/gv5</span><br><span class="line">#启动gv5</span><br><span class="line">[root@node1 test1]# gluster volume start gv5</span><br><span class="line">[root@node1 test1]# gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: fd4fca20-1bb3-480b-9c24-703dd3e8b508</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) = 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv5</span><br><span class="line">Brick2: node2:/gfs/test1/gv5</span><br><span class="line">Brick3: node3:/gfs/test1/gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h4 id="14、GlusterFS的常见的卷介绍"><a href="#14、GlusterFS的常见的卷介绍" class="headerlink" title="14、GlusterFS的常见的卷介绍"></a>14、GlusterFS的常见的卷介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Distributed：分布式卷，文件通过 hash 算法随机分布到由 bricks 组成的卷上。</span><br><span class="line">Replicated: 复制式卷，类似 RAID 1，replica 数必须等于 volume 中 brick 所包含的存储服务器数，可用性高。</span><br><span class="line">Striped: 条带式卷，类似 RAID 0，stripe 数必须等于 volume 中 brick 所包含的存储服务器数，文件被分成数据块，以 Round Robin 的方式存储在 bricks 中，并发粒度是数据块，大文件性能好。</span><br><span class="line">Distributed Striped: 分布式的条带卷，volume中 brick 所包含的存储服务器数必须是 stripe 的倍数（&gt;=2倍），兼顾分布式和条带式的功能。</span><br><span class="line">Distributed Replicated: 分布式的复制卷，volume 中 brick 所包含的存储服务器数必须是 replica 的倍数（&gt;=2倍），兼顾分布式和复制式的功能。</span><br><span class="line">分布式复制卷的brick顺序决定了文件分布的位置，一般来说，先是两个brick形成一个复制关系，然后两个复制关系形成分布。</span><br><span class="line">企业一般用后两种，大部分会用分布式复制（可用容量为 总容量/复制份数），通过网络传输的话最好用万兆交换机，万兆网卡来做。这样就会优化一部分性能。它们的数据都是通过网络来传输的。</span><br><span class="line"></span><br><span class="line">查看官方提供的gluster volume，点击[此处](https://docs.gluster.org/en/latest/Administrator%20Guide/Setting%20Up%20Volumes/)</span><br></pre></td></tr></table></figure>
<h4 id="15、删除卷"><a href="#15、删除卷" class="headerlink" title="15、删除卷"></a>15、删除卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#先停止要删除的卷</span><br><span class="line">[root@node01 ~]# gluster volume stop gv1</span><br><span class="line">[root@node01 ~]# gluster volume delete gv</span><br></pre></td></tr></table></figure>
<h4 id="16、监控负载"><a href="#16、监控负载" class="headerlink" title="16、监控负载"></a>16、监控负载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">volume profile &lt;VOLNAME&gt; &#123;start|info [peek|incremental [peek]|cumulative|clear]|stop&#125; [nfs]</span><br><span class="line">#启动性能分析：</span><br><span class="line">gluster volume profile gv5 start</span><br><span class="line">#显示io信息：</span><br><span class="line">gluster volume profile gv5 info</span><br><span class="line">#停止性能分析：</span><br><span class="line">gluster volume profile gv5 stop</span><br><span class="line"></span><br><span class="line">#使用top命令查看读取，写入，文件打开调用，读取调用，写入调用等指标：</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;open|read|write|opendir|readdir|clear&#125; [nfs|brick &lt;brick&gt;] [list-cnt &lt;value&gt;] |</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;read-perf|write-perf&#125; [bs &lt;size&gt; count &lt;count&gt;] [brick &lt;brick&gt;] [list-cnt &lt;value&gt;]</span><br><span class="line">#查看fd的当前打开数，和最大打开数</span><br><span class="line">gluster volume top gv5  open brick node1:/gfs/test1/gv5 list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Current open fds: 0, Max open fds: 1, Max openfd time: 2018-11-21 14:10:02.279118</span><br><span class="line"></span><br><span class="line">#显示文件读取调用数量：</span><br><span class="line">gluster volume top gv5  read brick node1:/gfs/test1/gv5 list-cnt  10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">1		/copy-test-002</span><br><span class="line">1		/copy-test-001</span><br><span class="line"></span><br><span class="line">#每个brick下面文件被写入的数量列表</span><br><span class="line">gluster volume top gv5  write brick node1:/gfs/test1/gv5 list-cnt  10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">12		/copy-test-100</span><br><span class="line">12		/copy-test-099</span><br><span class="line">12		/copy-test-098</span><br><span class="line">12		/copy-test-097</span><br><span class="line">12		/copy-test-096</span><br><span class="line">12		/copy-test-095</span><br><span class="line">12		/copy-test-094</span><br><span class="line">12		/copy-test-093</span><br><span class="line">12		/copy-test-092</span><br><span class="line">12		/copy-test-091</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被打开的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  opendir brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">1		/test</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被读的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  readdir brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Count		filename</span><br><span class="line">=======================</span><br><span class="line">2		/test</span><br><span class="line"></span><br><span class="line">#查看brick的读性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5 read-perf bs 256  count 1 brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Throughput 51.20 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">==== ========                                        ====                      </span><br><span class="line">   0 /copy-test-001                                  2018-11-21 16:14:30.512003</span><br><span class="line">   0 /copy-test-003                                  2018-11-21 16:13:32.481649</span><br><span class="line">   0 /copy-test-002                                  2018-11-21 16:06:19.696071</span><br><span class="line">#查看brick的写性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  write-perf bs 256  count 1 brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Throughput 10.67 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">==== ========                                        ====                      </span><br><span class="line">   0 /.copy-test-001.swp                             2018-11-21 16:14:53.514516</span><br><span class="line">   0 /copy-test-001                                  2018-11-21 16:14:53.489068</span><br><span class="line">   0 /.copy-test-001.swp                             2018-11-21 16:14:30.483696</span><br><span class="line">   0 /.copy-test-003.swp                             2018-11-21 16:12:46.331094</span><br><span class="line">   0 /copy-test-100                                  2018-11-21 14:10:06.65163 </span><br><span class="line">   0 /copy-test-099                                  2018-11-21 14:10:05.953871</span><br><span class="line">   0 /copy-test-098                                  2018-11-21 14:10:05.773626</span><br><span class="line">   0 /copy-test-097                                  2018-11-21 14:10:05.620743</span><br><span class="line">   0 /copy-test-096                                  2018-11-21 14:10:05.591005</span><br><span class="line">   0 /copy-test-095                                  2018-11-21 14:10:05.555036</span><br><span class="line">#查看单个卷的信息：</span><br><span class="line">gluster volume info &lt;VOLNAME&gt;</span><br><span class="line"></span><br><span class="line">gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: e12e23f5-7347-4049-8d77-53cef76b0633</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) = 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv5</span><br><span class="line">Brick2: node2:/gfs/test1/gv5</span><br><span class="line">Brick3: node3:/gfs/test1/gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br><span class="line"></span><br><span class="line">#查看所有卷的信息：</span><br><span class="line">gluster volume info all</span><br><span class="line"></span><br><span class="line">#查看卷状态：</span><br><span class="line">gluster volume status [all| []] [detail|clients|mem|inode|fd|callpool]</span><br><span class="line">#显示所有卷的状态</span><br><span class="line">gluster volume status all</span><br><span class="line">#显示卷额外的信息：</span><br><span class="line">gluster volume status gv5  detail</span><br><span class="line">#显示客户端列表：</span><br><span class="line">gluster volume status gv5  clients</span><br><span class="line">#显示内存使用情况：</span><br><span class="line">gluster volume status gv5  mem</span><br><span class="line">#显示卷的inode表</span><br><span class="line">gluster volume status gv5  inode</span><br><span class="line">#显示卷打开的fd表</span><br><span class="line">gluster volume status gv5  fd</span><br><span class="line">#显示卷的挂起调用</span><br><span class="line">gluster volume status gv5  callpool</span><br></pre></td></tr></table></figure>
<h4 id="17、glusterfs其他信息查看"><a href="#17、glusterfs其他信息查看" class="headerlink" title="17、glusterfs其他信息查看"></a>17、glusterfs其他信息查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#看下节点有没有在线</span><br><span class="line">gluster volume status nfsp</span><br><span class="line">#启动完全修复</span><br><span class="line">gluster volume heal gv2 full</span><br><span class="line">#查看需要修复的文件</span><br><span class="line">gluster volume heal gv2 info</span><br><span class="line">#查看修复成功的文件</span><br><span class="line">gluster volume heal gv2 info healed</span><br><span class="line">#查看修复失败的文件</span><br><span class="line">gluster volume heal gv2 heal-failed</span><br><span class="line">#查看脑裂的文件</span><br><span class="line">gluster volume heal gv2 info split-brain</span><br><span class="line">#激活quota功能</span><br><span class="line">gluster volume quota gv2 enable</span><br><span class="line">#关闭quota功能</span><br><span class="line">gulster volume quota gv2 disable</span><br><span class="line">#目录限制（卷中文件夹的大小）</span><br><span class="line">gluster volume quota limit-usage /data/30MB --/gv2/data</span><br><span class="line">#quota信息列表</span><br><span class="line">gluster volume quota gv2 list</span><br><span class="line">#限制目录的quota信息</span><br><span class="line">gluster volume quota gv2 list /data</span><br><span class="line">#设置信息的超时时间</span><br><span class="line">gluster volume set gv2 features.quota-timeout 5</span><br><span class="line">#删除某个目录的quota设置</span><br><span class="line">gluster volume quota gv2 remove /data</span><br><span class="line">备注：quota功能，主要是对挂载点下的某个目录进行空间限额。如：/mnt/gulster/data目录，而不是对组成卷组的空间进行限制。</span><br></pre></td></tr></table></figure>
<h4 id="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"><a href="#18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。" class="headerlink" title="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"></a>18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gfszabbix监控</span><br><span class="line">https://github.com/MrCirca/zabbix-glusterfs</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/25/GlusterFS/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/23/vsftp启用虚拟用户功能/"><span>[Linux] vsftp启用虚拟用户功能</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/23/vsftp启用虚拟用户功能/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-23T09:17:30.000Z">
          2018-11-23
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处"><a href="#0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处" class="headerlink" title="0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处"></a>0、部署vsftp-server，请先跳转到<a href="https://zeven0707.github.io/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/" target="_blank" rel="noopener">此处</a>，部署vsfpt-ssl功能，点击<a href="https://zeven0707.github.io/2018/11/12/vsftpd%E9%85%8D%E7%BD%AEssl/" target="_blank" rel="noopener">此处</a></h4><h4 id="1、在-etc-vsftpd-conf配置文件添加以下内容"><a href="#1、在-etc-vsftpd-conf配置文件添加以下内容" class="headerlink" title="1、在/etc/vsftpd.conf配置文件添加以下内容"></a>1、在/etc/vsftpd.conf配置文件添加以下内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启虚拟用户的功能</span><br><span class="line">guest_enable=YES</span><br><span class="line">#指定虚拟用户的宿主用户</span><br><span class="line">guest_username=vir</span><br><span class="line">#指定虚拟用户配置文件的存放路径</span><br><span class="line">user_config_dir=/etc/vsftpd/vuser_conf</span><br><span class="line">#虚拟用户和本地用户有相同的权限</span><br><span class="line">virtual_use_local_privs=YES</span><br></pre></td></tr></table></figure>
<h4 id="2、建立虚拟用户名文件"><a href="#2、建立虚拟用户名文件" class="headerlink" title="2、建立虚拟用户名文件"></a>2、建立虚拟用户名文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/vsftpd/vsftpd_users.conf</span><br><span class="line">#输入奇数行为账号，偶数行为密码</span><br><span class="line">f1</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<h4 id="3、生成认证文件-如果db-load命令不存在先安装-yum-install-db4-db4-utils"><a href="#3、生成认证文件-如果db-load命令不存在先安装-yum-install-db4-db4-utils" class="headerlink" title="3、生成认证文件,如果db_load命令不存在先安装(yum install db4 db4-utils)"></a>3、生成认证文件,如果db_load命令不存在先安装(yum install db4 db4-utils)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# db_load -T -t hash -f /etc/vsftpd/vsftpd_users.conf /etc/vsftpd/vsftpd_users.db</span><br></pre></td></tr></table></figure>
<h4 id="4、文件生成之后，修改文件权限"><a href="#4、文件生成之后，修改文件权限" class="headerlink" title="4、文件生成之后，修改文件权限"></a>4、文件生成之后，修改文件权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chmod 600 /etc/vsftpd/vsftpd_users.db</span><br></pre></td></tr></table></figure>
<h4 id="5、编辑认证文件-将其余行注释，只保留第一行和最后两行"><a href="#5、编辑认证文件-将其余行注释，只保留第一行和最后两行" class="headerlink" title="5、编辑认证文件,将其余行注释，只保留第一行和最后两行"></a>5、编辑认证文件,将其余行注释，只保留第一行和最后两行</h4><p>“/etc/vsftpd/vsftpd_users”根据自己配置的文件设置，.db后缀无需添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost f2]# more /etc/pam.d/vsftpd</span><br><span class="line">#%PAM-1.0</span><br><span class="line">#session    optional     pam_keyinit.so    force revoke</span><br><span class="line">#auth       required	pam_listfile.so item=user sense=deny file=/etc/vsftpd/ftpusers onerr=succeed</span><br><span class="line">#auth       required	pam_shells.so</span><br><span class="line">#auth       include	password-auth</span><br><span class="line">#account    include	password-auth</span><br><span class="line">#session    required     pam_loginuid.so</span><br><span class="line">#session    include	password-auth</span><br><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_users</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_users</span><br></pre></td></tr></table></figure></p>
<h4 id="6、建立虚拟用户配置文件存放位置"><a href="#6、建立虚拟用户配置文件存放位置" class="headerlink" title="6、建立虚拟用户配置文件存放位置"></a>6、建立虚拟用户配置文件存放位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /etc/vsftpd/vuser_conf/</span><br><span class="line">[root@localhost ~]# vim /etc/vsftpd/vuser_conf/f1</span><br><span class="line">#添加以下内容</span><br><span class="line">local_root=/var/ftp/f1</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br></pre></td></tr></table></figure>
<h4 id="7、将f1用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f1用户登录"><a href="#7、将f1用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f1用户登录" class="headerlink" title="7、将f1用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f1用户登录"></a>7、将f1用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f1用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/chroot_list |grep f1</span><br><span class="line">f1</span><br><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/vsftpd.user_list |grep f1</span><br><span class="line">f1</span><br></pre></td></tr></table></figure>
<h4 id="8、重新启动vsftp"><a href="#8、重新启动vsftp" class="headerlink" title="8、重新启动vsftp"></a>8、重新启动vsftp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl vsftpd restart</span><br></pre></td></tr></table></figure>
<h4 id="9、测试用户能否正常登录："><a href="#9、测试用户能否正常登录：" class="headerlink" title="9、测试用户能否正常登录："></a>9、测试用户能否正常登录：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# ./sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL/TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f1</span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">Connection problem SSLTCP:525:ssl_read tcp:-1000:SSL failure. (SSL_ERROR_SSL):error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number</span><br><span class="line">Channel open, login Failed!</span><br></pre></td></tr></table></figure>
<p>提示的错误没找到任何相关文档，尝试用tcpdump抓包看看交互情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15:50:39.932746 IP 192.168.168.120.21 &gt; 192.168.168.121.39398: Flags [P.], seq 1806:1816, ack 772, win 243, options [nop,nop,TS val 513318660 ecr 1441172002], length 10: FTP: 500 OOPS: [!ftp]</span><br><span class="line">15:50:39.932769 IP 192.168.168.120.21 &gt; 192.168.168.121.39398: Flags [P.], seq 1816:1851, ack 772, win 243, options [nop,nop,TS val 513318660 ecr 1441172002], length 35: FTP: cannot change directory:/var/ftp/f1[!ftp]</span><br></pre></td></tr></table></figure></p>
<p>提示f1的目录不存在，尝试创建f1的目录，并修改权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/ftp/f1</span><br><span class="line">chown ftp1.ftp1 /var/ftp/f1</span><br></pre></td></tr></table></figure></p>
<p>再次登录，正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# ./sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL/TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f1</span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">230 Login successful.</span><br><span class="line">Type in &quot;save&quot; to save login details to /root/.netrc</span><br><span class="line">sslftp&gt; ls</span><br><span class="line">226 Directory send OK.</span><br><span class="line">sslftp&gt; exit</span><br><span class="line">221 Goodbye.</span><br><span class="line">Channel Closed.</span><br></pre></td></tr></table></figure></p>
<h4 id="10、新增f2用户，修改vsftpd-users-conf配置文件，添加f2用户"><a href="#10、新增f2用户，修改vsftpd-users-conf配置文件，添加f2用户" class="headerlink" title="10、新增f2用户，修改vsftpd_users.conf配置文件，添加f2用户"></a>10、新增f2用户，修改vsftpd_users.conf配置文件，添加f2用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/vsftpd/vsftpd_users.conf</span><br><span class="line">#输入奇数行为账号，偶数行为密码</span><br><span class="line">f1</span><br><span class="line">123456</span><br><span class="line">f2</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<h4 id="11、重新生成认证文件"><a href="#11、重新生成认证文件" class="headerlink" title="11、重新生成认证文件"></a>11、重新生成认证文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# db_load -T -t hash -f /etc/vsftpd/vsftpd_users.conf /etc/vsftpd/vsftpd_users.db</span><br></pre></td></tr></table></figure>
<h4 id="12、将f2用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f2用户登录"><a href="#12、将f2用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f2用户登录" class="headerlink" title="12、将f2用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f2用户登录"></a>12、将f2用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f2用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/chroot_list |grep -E &quot;f1|f2&quot;</span><br><span class="line">f1</span><br><span class="line">f2</span><br><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/vsftpd.user_list |grep -E &quot;f1|f2&quot;</span><br><span class="line">f1</span><br><span class="line">f2</span><br></pre></td></tr></table></figure>
<h4 id="13、添加f2配置文件"><a href="#13、添加f2配置文件" class="headerlink" title="13、添加f2配置文件"></a>13、添加f2配置文件</h4><p>vim /etc/vsftpd/vuser_conf/f2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local_root=/var/ftp/f2</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br></pre></td></tr></table></figure></p>
<h4 id="14、创建f2目录，并修改权限"><a href="#14、创建f2目录，并修改权限" class="headerlink" title="14、创建f2目录，并修改权限"></a>14、创建f2目录，并修改权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/ftp/f2</span><br><span class="line">chown ftp1.ftp1 /var/ftp/f2</span><br></pre></td></tr></table></figure>
<h4 id="15、重新启动vsftpd"><a href="#15、重新启动vsftpd" class="headerlink" title="15、重新启动vsftpd"></a>15、重新启动vsftpd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl vsftpd restart</span><br></pre></td></tr></table></figure>
<h4 id="16、测试登录vsftpd是否正常"><a href="#16、测试登录vsftpd是否正常" class="headerlink" title="16、测试登录vsftpd是否正常"></a>16、测试登录vsftpd是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# ./sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL/TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f2 </span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">230 Login successful.</span><br><span class="line">Type in &quot;save&quot; to save login details to /root/.netrc</span><br><span class="line">sslftp&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/23/vsftp启用虚拟用户功能/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/22/DNS服务部署/"><span>[Linux] DNS服务部署(单点&amp;主从)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/22/DNS服务部署/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-22T15:10:30.000Z">
          2018-11-22
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、关闭防火墙开启相应的服务"><a href="#1、关闭防火墙开启相应的服务" class="headerlink" title="1、关闭防火墙开启相应的服务"></a>1、关闭防火墙开启相应的服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost  ~]#setenforce  0</span><br><span class="line">[root@localhost  ~]#iptables  -F</span><br></pre></td></tr></table></figure>
<h3 id="2、主节点安装dns"><a href="#2、主节点安装dns" class="headerlink" title="2、主节点安装dns"></a>2、主节点安装dns</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure>
<h4 id="3、修改配置文件"><a href="#3、修改配置文件" class="headerlink" title="3、修改配置文件"></a>3、修改配置文件</h4><h5 id="3-1、-etc-named-conf—–主配置文件-服务器主要运行参数"><a href="#3-1、-etc-named-conf—–主配置文件-服务器主要运行参数" class="headerlink" title="3.1、/etc/named.conf—–主配置文件,服务器主要运行参数"></a>3.1、/etc/named.conf—–主配置文件,服务器主要运行参数</h5><p>修改dns主配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 10.0.30.95;127.0.0.1 &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line">        forwarders &#123; 8.8.8.8; &#125;;</span><br></pre></td></tr></table></figure></p>
<h5 id="3-2、-etc-named-rfc1912-zones—–区域文件，主要指定要解析哪个域名"><a href="#3-2、-etc-named-rfc1912-zones—–区域文件，主要指定要解析哪个域名" class="headerlink" title="3.2、/etc/named.rfc1912.zones—–区域文件，主要指定要解析哪个域名"></a>3.2、/etc/named.rfc1912.zones—–区域文件，主要指定要解析哪个域名</h5><p>vim /etc/named.rfc1912.zones<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 首先对文件中正向解析的区域进行修改</span><br><span class="line">zone &quot;node&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;node.conf&quot;;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">// 设置好域名格式以及相应的数据文件接下来进行反向解析区域的配置</span><br><span class="line">zone  &quot;30.0.10.in -addr.arpa&quot;  IN&#123;</span><br><span class="line">          type master;</span><br><span class="line">          file &quot;node.txt&quot;;</span><br><span class="line">          allow-update &#123; none; &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="3-3、配置完成之后校验一下文件配置是否正确："><a href="#3-3、配置完成之后校验一下文件配置是否正确：" class="headerlink" title="3.3、配置完成之后校验一下文件配置是否正确："></a>3.3、配置完成之后校验一下文件配置是否正确：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# named-checkconf</span><br><span class="line">[root@node4 named]# </span><br><span class="line">没有任何输出表示 /etc/named.conf没有语法错误</span><br></pre></td></tr></table></figure>
<h5 id="3-4、-var-named-xxx-xx-——-数据文件，用来正向和反向的解析"><a href="#3-4、-var-named-xxx-xx-——-数据文件，用来正向和反向的解析" class="headerlink" title="3.4、/var/named/xxx.xx ——-数据文件，用来正向和反向的解析"></a>3.4、/var/named/xxx.xx ——-数据文件，用来正向和反向的解析</h5><p>主文件及区域文件修改完成后接下来进行数据文件的修改,切换到/var/named目录下,对数据文件进行相应的选项配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/named/</span><br><span class="line">cp named.empty  node.conf</span><br></pre></td></tr></table></figure></p>
<p>首先对其正向解析的数据文件进行配置<br>vim node.com<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA gfs.com rname.invalid. (</span><br><span class="line">					0	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">                NS	dns.gfs.com.</span><br><span class="line">dns.gfs.com	    A 10.0.30.95</span><br><span class="line">node1.gfs.com 1 A 10.0.30.51</span><br><span class="line">	           AAAA	::1</span><br></pre></td></tr></table></figure></p>
<p>对反向解析的数据文件进行配置，反向解析数据文件里面只有SOA、NS、PTR资源记录，所有A记录都要改为PTR记录，名称为IP地址，IP地址可以写全也可以简写，如果写全则是IP地址反写加上.in-addr.arpa.例如：116.2.16.172.in-addr.arpa. PTR资源记录的值为域名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp named.empty  node.txt</span><br></pre></td></tr></table></figure></p>
<p>vim node.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA gfs.com rname.invalid. (</span><br><span class="line">					0	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">     NS	dns.gfs.com.</span><br><span class="line">95	PTR dns.gfs.com.</span><br><span class="line">51  PTR node1.gfs.com.</span><br></pre></td></tr></table></figure></p>
<h5 id="3-5、解析文件参数详解"><a href="#3-5、解析文件参数详解" class="headerlink" title="3.5、解析文件参数详解"></a>3.5、解析文件参数详解</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">区域解析库文件第一个记录必须是SOA记录，必须有NS记录并且正解区域要有NS记录的A记录，反解则不需要有NS记录对应的A记录。</span><br><span class="line">$TTL表示宏定义，TTL(Time- To-Live)，dns记录在本地DNS服务器上保留的时间</span><br><span class="line">@符号可代表区域文件/etc/named.conf里面定义的区域名称，即：&quot;gfs.com.&quot;。</span><br><span class="line">2018030422 ;标识序列号，十进制数字，不能超过10位，通常使用日期</span><br><span class="line">2H ;刷新时间，即每隔多久到主服务器检查一次，此处为2小时，实验环境可以设置小一点</span><br><span class="line">4M ;重试时间，应该小于刷新时间，此处为4分钟，实验环境可以设置小一点</span><br><span class="line">1D ;过期时间，此处为1天</span><br><span class="line">2D ;主服务器挂后，从服务器至多工作的时间，此处为2天)</span><br><span class="line">这个文件里所有的域名结尾的点号一定不能省略。</span><br><span class="line">区域解析库文件是放在/var/named目录下，由named进程是以named用户运行，因此区域解析库文件的属组应设置为named。</span><br><span class="line"></span><br><span class="line">（1）A记录（Address）正向解析</span><br><span class="line">A记录是将一个主机名（全称域名FQDN）和一个IP地址关联起来。这也是大多数客户端程序默认的查询类型。</span><br><span class="line">（2）PTR记录（Pointer）反向解析</span><br><span class="line">PTR记录将一个IP地址对应到主机名（全称域名FQDN）。这些记录保存在in-addr.arpa域中。</span><br><span class="line">（3）CNAME记录(Canonical Name)别名</span><br><span class="line">别名记录，也称为规范名字(Canonical Name)。这种记录允许您将多个名字映射到同一台计算机。</span><br><span class="line">（4）MX记录（Mail eXchange）</span><br><span class="line">MX记录是邮件交换记录，它指向一个邮件服务器，用于电子邮件系统发邮件时根据 收信人的地址后缀来定位邮件服务器。MX记录也叫做邮件路由记录，用户可以将该域名下的邮件服务器指向到自己的mail server上，然后即可自行操控所有的邮箱设置。</span><br><span class="line">当有多个MX记录（即有多个邮件服务器）时，则需要设置数值来确定其优先级。通过设置优先级数字来指明首选服务器，数字越小表示优先级越高。</span><br><span class="line">（5）NS记录（Name Server）</span><br><span class="line">NS（Name Server）记录是域名服务器记录，也称为授权服务器，用来指定该域名由哪个DNS服务器来进行解析。</span><br><span class="line">将网站的NS记录指向到目标地址，在设置NS记录的同时还需要设置目标网站的指向，否则NS记录将无法正常解析</span><br><span class="line">NS记录优先于A记录。即，如果一个主机地址同时存在NS记录和A记录，则A记录不生效。</span><br><span class="line">（6）AAAA记录 IPV6解析记录</span><br><span class="line">该记录是将域名解析到一个指定的IPV6的IP上。</span><br></pre></td></tr></table></figure>
<h5 id="3-6、相应的数据配置文件完成后对数据文件的属主进行修改"><a href="#3-6、相应的数据配置文件完成后对数据文件的属主进行修改" class="headerlink" title="3.6、相应的数据配置文件完成后对数据文件的属主进行修改"></a>3.6、相应的数据配置文件完成后对数据文件的属主进行修改</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost  named]#chown  named  node.*</span><br><span class="line">[root@node4 named]# ll node.*</span><br><span class="line">-rw-r-----. 1 named root 286 Nov 22 16:12 node.conf</span><br><span class="line">-rw-r-----. 1 named root 310 Nov 22 16:12 node.txt</span><br></pre></td></tr></table></figure>
<h5 id="3-7、配置完成后检测解析文件是否正确"><a href="#3-7、配置完成后检测解析文件是否正确" class="headerlink" title="3.7、配置完成后检测解析文件是否正确"></a>3.7、配置完成后检测解析文件是否正确</h5><p>[root@node4 named]# named-checkzone “gfs.com” node.conf<br>zone gfs.com/IN: loaded serial 0<br>OK</p>
<h5 id="3-8、检测反向解析库配置有没有错误"><a href="#3-8、检测反向解析库配置有没有错误" class="headerlink" title="3.8、检测反向解析库配置有没有错误"></a>3.8、检测反向解析库配置有没有错误</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# named-checkzone &quot;30.0.10.in-addr.arpa&quot; node.txt</span><br><span class="line">zone 30.0.10.in-addr.arpa/IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h4 id="4、修改完成后启动dns服务"><a href="#4、修改完成后启动dns服务" class="headerlink" title="4、修改完成后启动dns服务"></a>4、修改完成后启动dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named.service</span><br></pre></td></tr></table></figure>
<h4 id="5、在客户端配置dns信息"><a href="#5、在客户端配置dns信息" class="headerlink" title="5、在客户端配置dns信息"></a>5、在客户端配置dns信息</h4><h5 id="5-1、修改-etc-NetworkManager-NetworkManager-conf-文件，防止重启网卡后dns被重置，在main部分添加-“dns-none”-选项"><a href="#5-1、修改-etc-NetworkManager-NetworkManager-conf-文件，防止重启网卡后dns被重置，在main部分添加-“dns-none”-选项" class="headerlink" title="5.1、修改 /etc/NetworkManager/NetworkManager.conf 文件，防止重启网卡后dns被重置，在main部分添加 “dns=none” 选项"></a>5.1、修改 /etc/NetworkManager/NetworkManager.conf 文件，防止重启网卡后dns被重置，在main部分添加 “dns=none” 选项</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">plugins=ifcfg-rh</span><br><span class="line">dns=none</span><br></pre></td></tr></table></figure>
<h5 id="5-2、NetworkManager重新装载上面修改的配置"><a href="#5-2、NetworkManager重新装载上面修改的配置" class="headerlink" title="5.2、NetworkManager重新装载上面修改的配置"></a>5.2、NetworkManager重新装载上面修改的配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart NetworkManager.service</span><br></pre></td></tr></table></figure>
<h5 id="5-3、之后修改-etc-resolv-conf配置文件："><a href="#5-3、之后修改-etc-resolv-conf配置文件：" class="headerlink" title="5.3、之后修改/etc/resolv.conf配置文件："></a>5.3、之后修改/etc/resolv.conf配置文件：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">[root@node2 ~]# /etc/init.d/network restart</span><br><span class="line">Restarting network (via systemctl):                        [  OK  ]</span><br><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 202.106.0.20</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# ls</span><br><span class="line">anaconda-ks.cfg  Desktop  Documents  Downloads  initial-setup-ks.cfg  Music  Pictures  Public  Templates  Videos</span><br><span class="line">[root@node2 ~]# vim /etc/NetworkManager/NetworkManager.conf </span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# systemctl restart NetworkManager.service</span><br><span class="line">[root@node2 ~]# vim /etc/resolv.conf</span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">[root@node2 ~]# /etc/init.d/network restart</span><br><span class="line">Restarting network (via systemctl):                        [  OK  ]</span><br><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br></pre></td></tr></table></figure>
<h5 id="5-4、测试dns是否能正常解析："><a href="#5-4、测试dns是否能正常解析：" class="headerlink" title="5.4、测试dns是否能正常解析："></a>5.4、测试dns是否能正常解析：</h5><p>正向解析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 30794</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 17:44:35 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure></p>
<p>反向解析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -x 10.0.30.51 </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -x 10.0.30.51</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 50154</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;51.30.0.10.in-addr.arpa.	IN	PTR</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">51.30.0.10.in-addr.arpa. 10800	IN	PTR	node1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">30.0.10.in-addr.arpa.	10800	IN	NS	dns2.gfs.com.</span><br><span class="line">30.0.10.in-addr.arpa.	10800	IN	NS	dns1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 17:44:47 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 149</span><br></pre></td></tr></table></figure></p>
<p>上面单节点的dns配置完成，下面配置dns主从，从节点实时同步主节点更新的数据。</p>
<h4 id="6、主节点修改-etc-named-rfc1912-zones"><a href="#6、主节点修改-etc-named-rfc1912-zones" class="headerlink" title="6、主节点修改/etc/named.rfc1912.zones"></a>6、主节点修改/etc/named.rfc1912.zones</h4><p>allow-transfer { 10.0.30.117; }; #指定允许转发的目标主机，即从服务器<br>also-notify:主动通知从域名服务器进行更新，在主域名服务器进行更新后，而不需要在等规定的时间后才通知从域名服务器进行更新<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;gfs.com&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;node.conf&quot;;</span><br><span class="line">        allow-transfer &#123; 10.0.30.117; &#125;;</span><br><span class="line">        also-notify &#123; 10.0.30.117; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  &quot;30.0.10.in-addr.arpa&quot;  IN&#123;</span><br><span class="line">          type master;</span><br><span class="line">          file &quot;node.txt&quot;;</span><br><span class="line">          also-notify &#123; 10.0.30.117; &#125;;</span><br><span class="line">          allow-transfer &#123; 10.0.30.117; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="7、修改主节点正向解析文件"><a href="#7、修改主节点正向解析文件" class="headerlink" title="7、修改主节点正向解析文件"></a>7、修改主节点正向解析文件</h4><p>[root@node4 named]# more node.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA	gfs.com. rname.invalid. (</span><br><span class="line">					2	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">	NS	dns1.gfs.com.</span><br><span class="line">    NS  dns2.gfs.com.</span><br><span class="line">dns1 A 10.0.30.95</span><br><span class="line">dns2 A 10.0.30.117</span><br><span class="line">node1  A 10.0.30.51</span><br><span class="line">node2  A 10.0.30.35</span><br><span class="line">node3  A 10.0.30.117</span><br><span class="line">	AAAA	::1</span><br></pre></td></tr></table></figure></p>
<h4 id="8、修改主节点反向解析文件"><a href="#8、修改主节点反向解析文件" class="headerlink" title="8、修改主节点反向解析文件"></a>8、修改主节点反向解析文件</h4><p>[root@node4 named]# more node.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA gfs.com. rname.invalid. (</span><br><span class="line">					2	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">      NS  dns1.gfs.com.</span><br><span class="line">      NS  dns2.gfs.com.</span><br><span class="line">95   PTR dns1.gfs.com.</span><br><span class="line">117  PTR dns2.gfs.com.</span><br><span class="line">51   PTR node1.gfs.com.</span><br><span class="line">35   PTR node2.gfs.com.</span><br><span class="line">117  PTR node3.gfs.com.</span><br></pre></td></tr></table></figure></p>
<h4 id="9、重新启动dns服务器"><a href="#9、重新启动dns服务器" class="headerlink" title="9、重新启动dns服务器"></a>9、重新启动dns服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named.service</span><br></pre></td></tr></table></figure>
<h4 id="10、在从服务器上安装dns服务"><a href="#10、在从服务器上安装dns服务" class="headerlink" title="10、在从服务器上安装dns服务"></a>10、在从服务器上安装dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure>
<h4 id="11、修改从节点-etc-named-conf配置文件"><a href="#11、修改从节点-etc-named-conf配置文件" class="headerlink" title="11、修改从节点/etc/named.conf配置文件"></a>11、修改从节点/etc/named.conf配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">	listen-on port 53 &#123; 10.0.30.117;127.0.0.1; &#125;;</span><br><span class="line">	listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">	directory 	&quot;/var/named&quot;;</span><br><span class="line">	dump-file 	&quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">	statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">	memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">	allow-query     &#123; any; &#125;;</span><br><span class="line">	forwarders &#123; 8.8.8.8; &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="12、修改-etc-named-rfc1912-zones"><a href="#12、修改-etc-named-rfc1912-zones" class="headerlink" title="12、修改/etc/named.rfc1912.zones"></a>12、修改/etc/named.rfc1912.zones</h4><p>allow-notify 接受这个网段内的主机发送来的通知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;gfs.com&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        masters &#123; 10.0.30.95; &#125;;</span><br><span class="line">        allow-notify &#123; 10.0.30.95; &#125;;</span><br><span class="line">        file &quot;slaves/node.conf&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  &quot;30.0.10.in-addr.arpa&quot;  IN&#123;</span><br><span class="line">          type slave;</span><br><span class="line">          masters &#123; 10.0.30.95; &#125;;</span><br><span class="line">          allow-notify &#123; 10.0.30.95; &#125;;</span><br><span class="line">          file &quot;slaves/node.txt&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="13、从服务器启动dns服务"><a href="#13、从服务器启动dns服务" class="headerlink" title="13、从服务器启动dns服务"></a>13、从服务器启动dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named.service</span><br></pre></td></tr></table></figure>
<h4 id="14、查看-var-named-slaves目录下已经多出了node-的两个文件"><a href="#14、查看-var-named-slaves目录下已经多出了node-的两个文件" class="headerlink" title="14、查看/var/named/slaves目录下已经多出了node.*的两个文件"></a>14、查看/var/named/slaves目录下已经多出了node.*的两个文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# pwd</span><br><span class="line">/var/named/slaves</span><br><span class="line">[root@node3 slaves]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 416 Nov 22 16:12 node.conf</span><br><span class="line">-rw-r--r--. 1 named named 514 Nov 22 16:12 node.txt</span><br></pre></td></tr></table></figure>
<h4 id="15、测试主从文件能否正常同步，修改主节点node-配置文件"><a href="#15、测试主从文件能否正常同步，修改主节点node-配置文件" class="headerlink" title="15、测试主从文件能否正常同步，修改主节点node.*配置文件"></a>15、测试主从文件能否正常同步，修改主节点node.*配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# vim node.conf </span><br><span class="line">[root@node4 named]# vim node.txt </span><br><span class="line">[root@node4 named]# </span><br><span class="line">[root@node4 named]# ll node.*</span><br><span class="line">-rw-r-----. 1 named root 265 Nov 22 18:48 node.conf</span><br><span class="line">-rw-r-----. 1 named root 272 Nov 22 18:48 node.txt</span><br></pre></td></tr></table></figure>
<p>***注意修改配置文件的时候一定要修改配置文件中serial那一行，只有该行的数值大于前一个值，才会同步到从节点。</p>
<h4 id="16、主节点重新加载dns"><a href="#16、主节点重新加载dns" class="headerlink" title="16、主节点重新加载dns"></a>16、主节点重新加载dns</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload named.service</span><br></pre></td></tr></table></figure>
<h4 id="17、查看从节点日志信息"><a href="#17、查看从节点日志信息" class="headerlink" title="17、查看从节点日志信息"></a>17、查看从节点日志信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Nov 22 18:48:55 node3 named[98442]: client 10.0.30.95#52505: received notify for zone &apos;gfs.com&apos;</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com/IN: Transfer started.</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;gfs.com/IN&apos; from 10.0.30.95#53: connected using 10.0.30.117#58148</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com/IN: transferred serial 3</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;gfs.com/IN&apos; from 10.0.30.95#53: Transfer completed: 1 messages, 9 records, 252 bytes, 0.008 secs (31500 bytes/sec)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com/IN: sending notifies (serial 3)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: client 10.0.30.95#54023: received notify for zone &apos;30.0.10.in-addr.arpa&apos;</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa/IN: Transfer started.</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;30.0.10.in-addr.arpa/IN&apos; from 10.0.30.95#53: connected using 10.0.30.117#51530</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa/IN: transferred serial 3</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;30.0.10.in-addr.arpa/IN&apos; from 10.0.30.95#53: Transfer completed: 1 messages, 8 records, 249 bytes, 0.002 secs (124500 bytes/sec)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa/IN: sending notifies (serial 3)</span><br></pre></td></tr></table></figure>
<h4 id="18、查看从节点配置文件信息"><a href="#18、查看从节点配置文件信息" class="headerlink" title="18、查看从节点配置文件信息"></a>18、查看从节点配置文件信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 375 Nov 22 18:48 node.conf</span><br><span class="line">-rw-r--r--. 1 named named 433 Nov 22 18:48 node.txt</span><br></pre></td></tr></table></figure>
<p>从节点文件已和主节点正常同步</p>
<h4 id="19、客户端测试主节点dns服务器挂掉从节点能否正常使用"><a href="#19、客户端测试主节点dns服务器挂掉从节点能否正常使用" class="headerlink" title="19、客户端测试主节点dns服务器挂掉从节点能否正常使用"></a>19、客户端测试主节点dns服务器挂掉从节点能否正常使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">nameserver 10.0.30.117</span><br></pre></td></tr></table></figure>
<h4 id="20、测试正向解析是否正常"><a href="#20、测试正向解析是否正常" class="headerlink" title="20、测试正向解析是否正常"></a>20、测试正向解析是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 55761</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 18:54:03 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<h4 id="21、主节点停掉dns服务："><a href="#21、主节点停掉dns服务：" class="headerlink" title="21、主节点停掉dns服务："></a>21、主节点停掉dns服务：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# systemctl stop named.service</span><br><span class="line">[root@node4 named]# systemctl status named.service</span><br><span class="line">● named.service - Berkeley Internet Name Domain (DNS)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line"></span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: zone 30.0.10.in-addr.arpa/IN: sending notifies (serial 3)</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#58148 (gfs.com): transfer of &apos;gfs.com/IN&apos;: AXFR-style IXFR started</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#58148 (gfs.com): transfer of &apos;gfs.com/IN&apos;: AXFR-style IXFR ended</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#28664: received notify for zone &apos;gfs.com&apos;</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#51530 (30.0.10.in-addr.arpa): transfer of &apos;30.0.10.in-addr.arpa/IN&apos;: AXFR-style IXFR started</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#51530 (30.0.10.in-addr.arpa): transfer of &apos;30.0.10.in-addr.arpa/IN&apos;: AXFR-style IXFR ended</span><br><span class="line">Nov 22 18:48:56 node4 named[10366]: client 10.0.30.117#41288: received notify for zone &apos;30.0.10.in-addr.arpa&apos;</span><br><span class="line">Nov 22 18:59:26 node4 systemd[1]: Stopping Berkeley Internet Name Domain (DNS)...</span><br><span class="line">Nov 22 18:59:26 node4 named[10366]: received control channel command &apos;stop&apos;</span><br><span class="line">Nov 22 18:59:26 node4 systemd[1]: Stopped Berkeley Internet Name Domain (DNS).</span><br></pre></td></tr></table></figure>
<h4 id="22、客户端解析仍然正常"><a href="#22、客户端解析仍然正常" class="headerlink" title="22、客户端解析仍然正常"></a>22、客户端解析仍然正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39672</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.117#53(10.0.30.117)</span><br><span class="line">;; WHEN: Thu Nov 22 18:59:48 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<h4 id="23、指定dns为主节点，解析失败"><a href="#23、指定dns为主节点，解析失败" class="headerlink" title="23、指定dns为主节点，解析失败"></a>23、指定dns为主节点，解析失败</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com @10.0.30.95</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com @10.0.30.95</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>
<h4 id="24、指定为从节点，解析正常"><a href="#24、指定为从节点，解析正常" class="headerlink" title="24、指定为从节点，解析正常"></a>24、指定为从节点，解析正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com @10.0.30.117</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com @10.0.30.117</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 53270</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.117#53(10.0.30.117)</span><br><span class="line">;; WHEN: Thu Nov 22 19:01:30 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<h4 id="25、把从节点dns服务也关掉"><a href="#25、把从节点dns服务也关掉" class="headerlink" title="25、把从节点dns服务也关掉"></a>25、把从节点dns服务也关掉</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# systemctl stop named.service</span><br></pre></td></tr></table></figure>
<h4 id="26、解析域名报错"><a href="#26、解析域名报错" class="headerlink" title="26、解析域名报错"></a>26、解析域名报错</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>
<h4 id="27、额外参考信息"><a href="#27、额外参考信息" class="headerlink" title="27、额外参考信息"></a>27、额外参考信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DNS服务器监听端口:</span><br><span class="line">PORT: udp/tcp  53   ---&gt; 服务端口</span><br><span class="line">PORT: udp/tcp 953  ---&gt; 主从连接端口</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns各参数详解，点击[此处](https://blog.csdn.net/bpingchang/article/details/38427113)跳转</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/22/DNS服务部署/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/14/mysql-show table status语法/"><span>[Mysql] mysql-show table status语法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/14/mysql-show table status语法/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-14T09:13:00.000Z">
          2018-11-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、使用方法："><a href="#1、使用方法：" class="headerlink" title="1、使用方法："></a>1、使用方法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show table status from aaaa like &apos;test_order&apos;;</span><br><span class="line">或</span><br><span class="line">show table status in aaaa like &apos;test_order&apos;;</span><br></pre></td></tr></table></figure>
<p>结果显示如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: test_order</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 84052104</span><br><span class="line"> Avg_row_length: 372</span><br><span class="line">    Data_length: 31321817088</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 25528303616</span><br><span class="line">      Data_free: 7340032</span><br><span class="line"> Auto_increment: 86709693</span><br><span class="line">    Create_time: 2018-11-02 16:20:25</span><br><span class="line">    Update_time: NULL</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: utf8mb4_general_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="2、具体参数详解："><a href="#2、具体参数详解：" class="headerlink" title="2、具体参数详解："></a>2、具体参数详解：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Name:表名</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine:表使用的存储引擎</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Version：该列在8.0版本已经废弃，在5.7版本下显示硬编码10</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Row_format：行存储格式（Fixed, Dynamic, Compressed, Redundant, Compact）。对于myisam表，Dynamic值与 myisamchk -dvv查询出来的Packed值相对应。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rows:对于myisam存储引擎，显示实际行数。对于其他引擎，比如innodb，值是近似的(粗略估计），和实际值可能相差40%至50%之间，想要获取准确的值使用select count(*)。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Avg_row_length：平均行长度。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Data_length：对于Myisam表，该值以字节为单位显示数据文件的长度；对于Innodb,该值以字节为单位显示为聚簇索引分配内存的值（近似）。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Max_data_length：对于Myisam表，该值显示数据文件的最大长度。这是可以存储在表中的数据的总字节数，该表给定使用的数据指针大小。对于Innodb，该值已弃用。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Index_length：对于Myisam，该值为索引文件的长度（以字节为单位）。对于Innodb，该值显示内存为非聚簇索引分配的数量（以字节为单位），它是内存页中非聚簇索引大小的总和与</span><br><span class="line">Innodb内存页大小的乘积。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Data_free：已分配但未使用的字节数。Innodb-tables代表当前表所属表空间的可用空间。如果该表位于共享表空间，该值代表共享表空间的剩余空间。如果使用多个表空间，每个表拥有自己的表空间，该值仅代表当前表的剩余空间。剩余空间的意思就是当前完全空闲的区字节数减去一个安全的边界值。即使该值为0，只要新的区可以被分配插入数据也是正常的。</span><br><span class="line">对于NDB集群，该值显示磁盘分配的空间，但是还没有被磁盘数据表或者磁盘数据碎片使用的空间。</span><br><span class="line">对于分区表，该值只是估计值并不准确。想要获取更加准确的方法使用下面方法查询：</span><br><span class="line">SELECT SUM(DATA_FREE) FROM  INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA = &apos;mydb&apos; AND TABLE_NAME = &apos;mytable&apos;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Auto_increment：下一个自动增长值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Create_time：表创建时间。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Update_time：数据文件最后更新时间。对于一些存储引擎，该是为null。例如，Innodb存储多个表在系统表空间而且数据文件时间戳没有应用。Innodb表是使用file-per-table模式，每个表都有他自己的.ibd文件，内存buffer写入数据文件存在延迟，因而文件修改时间与最后的插入、更新、删除修改时间是不同的。对于Myisam表，数据文件时间戳是可用的，但是在window系统上，更新并不会更新时间戳，因此该值是不准确的。</span><br><span class="line">对于非分区的Innodb表，该值显示最后update、insert、delete的时间戳的值。对于MVCC，时间戳的值代表commit的时间。如果服务器重启或者该表被数据字典缓存清除，时间戳不会保留。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Check_time：表最后一次检查时间。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collation：表默认的排序规则。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Checksum：校验值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Create_options：创建表时的额外选项。当执行create table时被保留的原始选项，这些选项与活动表的设置和选项不同。</span><br><span class="line">对于Innodb表，该值显示row_format和key_block_size选项。如果表示分区表，该值会显示partitioned。当创建或者修改一个file-per-table表空间为加密模式时，该值会显示为ENCRYPTIONG(general tablespace除外)。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Comment：创建表空间添加的注释。</span><br></pre></td></tr></table></figure>
<h4 id="3、测试对innodb表添加encryption功能："><a href="#3、测试对innodb表添加encryption功能：" class="headerlink" title="3、测试对innodb表添加encryption功能："></a>3、测试对innodb表添加encryption功能：</h4><p>3.1、安装插件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN keyring_file  soname &apos;keyring_file.so&apos;;</span><br></pre></td></tr></table></figure></p>
<p>3.2、创建密钥文件目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mysql/keyfile</span><br><span class="line">chown mysql.mysql -R /data/mysql/keyfile</span><br></pre></td></tr></table></figure></p>
<p>3.3、设置key文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set global keyring_file_data=&apos;/data/mysql/keyfile/key01&apos;;</span><br><span class="line">show global variables like &apos;%keyring_file_data%&apos;;</span><br><span class="line">root@db 16:28:  [aaaa]&gt; show global variables like &apos;%keyring_file_data%&apos;;</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">| Variable_name     | Value                     |</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">| keyring_file_data | /data/mysql/keyfile/key01 |</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>3.4、查看插件状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; SELECT PLUGIN_NAME, PLUGIN_STATUS</span><br><span class="line">    -&gt;        FROM INFORMATION_SCHEMA.PLUGINS</span><br><span class="line">    -&gt;        WHERE PLUGIN_NAME LIKE &apos;keyring%&apos;;</span><br><span class="line">+--------------+---------------+</span><br><span class="line">| PLUGIN_NAME  | PLUGIN_STATUS |</span><br><span class="line">+--------------+---------------+</span><br><span class="line">| keyring_file | ACTIVE        |</span><br><span class="line">+--------------+---------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>3.5、表aa未加密时，查看表状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:29:  [aaaa]&gt; show table status from aaaa like &apos;aa&apos;;</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time | Check_time | Collation          | Checksum | Create_options | Comment |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| aa   | InnoDB |      10 | Dynamic    |   12 |           1365 |       16384 |               0 |            0 |         0 |           NULL | 2018-10-29 17:30:47 | NULL        | NULL       | utf8mb4_general_ci |     NULL |                |         |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>3.6、对表aa进行加密：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:29:  [aaaa]&gt; alter table aa encryption=&apos;Y&apos;;</span><br><span class="line">Query OK, 12 rows affected (5.13 sec)</span><br><span class="line">Records: 12  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>3.7、再次查看表aa状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:30:  [aaaa]&gt; show table status from aaaa like &apos;aa&apos;;</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation          | Checksum | Create_options | Comment |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| aa   | InnoDB |      10 | Dynamic    |   12 |           1365 |       16384 |               0 |            0 |         0 |           NULL | 2018-11-14 16:30:16 | 2018-11-14 16:30:14 | NULL       | utf8mb4_general_ci |     NULL | ENCRYPTION=&quot;Y&quot; |         |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下："><a href="#4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下：" class="headerlink" title="4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下："></a>4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此<a href="http://en.latindevelopers.com/ivancp/2012/a-better-show-table-status/" target="_blank" rel="noopener">跳转</a>至原文，具体内容如下：</h4><p>4.1、存储过程所在的aaaa数据库，可根据自己数据库情况自行修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">DROP PROCEDURE IF EXISTS `aaaa`.`sp_status` $$</span><br><span class="line">CREATE PROCEDURE `aaaa`.`sp_status`(dbname VARCHAR(50))</span><br><span class="line">BEGIN </span><br><span class="line">-- Obtaining tables and views</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">     TABLE_NAME AS `Table Name`, </span><br><span class="line">     ENGINE AS `Engine`,</span><br><span class="line">     TABLE_ROWS AS `Rows`,</span><br><span class="line">     CONCAT(</span><br><span class="line">        (FORMAT((DATA_LENGTH + INDEX_LENGTH) / POWER(1024,2),2))</span><br><span class="line">        , &apos; Mb&apos;)</span><br><span class="line">       AS `Size`,</span><br><span class="line">     TABLE_COLLATION AS `Collation`</span><br><span class="line">    FROM information_schema.TABLES</span><br><span class="line">    WHERE TABLES.TABLE_SCHEMA = dbname</span><br><span class="line">          AND TABLES.TABLE_TYPE = &apos;BASE TABLE&apos;</span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">     TABLE_NAME AS `Table Name`, </span><br><span class="line">     &apos;[VIEW]&apos; AS `Engine`,</span><br><span class="line">     &apos;-&apos; AS `Rows`,</span><br><span class="line">     &apos;-&apos; `Size`,</span><br><span class="line">     &apos;-&apos; AS `Collation`</span><br><span class="line">    FROM information_schema.TABLES</span><br><span class="line">    WHERE TABLES.TABLE_SCHEMA = dbname </span><br><span class="line">          AND TABLES.TABLE_TYPE = &apos;VIEW&apos;</span><br><span class="line">)</span><br><span class="line">ORDER BY 1;</span><br><span class="line">-- Obtaining functions, procedures and triggers</span><br><span class="line">(</span><br><span class="line">    SELECT ROUTINE_NAME AS `Routine Name`, </span><br><span class="line">     ROUTINE_TYPE AS `Type`,</span><br><span class="line">     &apos;&apos; AS `Comment`</span><br><span class="line">    FROM information_schema.ROUTINES</span><br><span class="line">    WHERE ROUTINE_SCHEMA = dbname</span><br><span class="line">    ORDER BY ROUTINES.ROUTINE_TYPE, ROUTINES.ROUTINE_NAME</span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">(</span><br><span class="line">    SELECT TRIGGER_NAME,&apos;TRIGGER&apos; AS `Type`, </span><br><span class="line">    concat(&apos;On &apos;,EVENT_MANIPULATION,&apos;: &apos;,EVENT_OBJECT_TABLE) AS `Comment`</span><br><span class="line">    FROM information_schema.TRIGGERS</span><br><span class="line">    WHERE EVENT_OBJECT_SCHEMA = dbname</span><br><span class="line">)</span><br><span class="line">ORDER BY 2,1;</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></p>
<p>4.2、执行存储过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call aaaa.sp_status(&apos;aaaa&apos;);</span><br></pre></td></tr></table></figure></p>
<p>4.3、结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:58:  [aaaa]&gt; call aaaa.sp_status(&apos;aaaa&apos;);</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br><span class="line">| Table Name   | Engine | Rows     | Size         | Collation          |</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br><span class="line">| aa           | InnoDB | 12       | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| sequence     | InnoDB | 12292293 | 515.98 Mb    | utf8mb4_general_ci |</span><br><span class="line">| test         | InnoDB | 0        | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| test1        | InnoDB | 6        | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| test_order  | InnoDB | 84052104 | 54,216.50 Mb | utf8mb4_general_ci |</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/14/mysql-show table status语法/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/12/vsftpd配置ssl/"><span>[Linux] vsftpd配置ssl</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/12/vsftpd配置ssl/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-12T11:09:30.000Z">
          2018-11-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、如果还没有部署vsftp-server，请先跳转到此处"><a href="#0、如果还没有部署vsftp-server，请先跳转到此处" class="headerlink" title="0、如果还没有部署vsftp-server，请先跳转到此处"></a>0、如果还没有部署vsftp-server，请先跳转到<a href="https://zeven0707.github.io/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/" target="_blank" rel="noopener">此处</a></h4><h4 id="1、查询vsftpd软件是否支持SSL"><a href="#1、查询vsftpd软件是否支持SSL" class="headerlink" title="1、查询vsftpd软件是否支持SSL"></a>1、查询vsftpd软件是否支持SSL</h4><p>ldd /usr/sbin/vsftpd | grep ssl<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libssl.so.10 =&gt; /lib64/libssl.so.10 (0x00007f6cfc4a6000)</span><br></pre></td></tr></table></figure></p>
<h4 id="2、生成vsftpd-pem-证书"><a href="#2、生成vsftpd-pem-证书" class="headerlink" title="2、生成vsftpd.pem 证书"></a>2、生成vsftpd.pem 证书</h4><p>[root@localhost vsftpd]# openssl req -x509 -nodes -days 365 -newkey rsa:1024 -keyout /etc/vsftpd/vsftpd.pem -out /etc/vsftpd/vsftpd.pem<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">..................................++++++</span><br><span class="line">.........++++++</span><br><span class="line">writing new private key to &apos;/etc/vsftpd/vsftpd.pem&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:goopal</span><br><span class="line">Organizational Unit Name (eg, section) []:goopal</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:zeven</span><br><span class="line">Email Address []:test@goopal.com</span><br></pre></td></tr></table></figure></p>
<p>查看生成vsftpd.pem是否成功<br>ls -l /etc/vsftpd/|grep vsftpd.pem<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- 1 root root 1982 11月  9 14:20 vsftpd.pem</span><br></pre></td></tr></table></figure></p>
<h4 id="3、修改主配置文件-etc-vsftpd-vsftpd-conf"><a href="#3、修改主配置文件-etc-vsftpd-vsftpd-conf" class="headerlink" title="3、修改主配置文件/etc/vsftpd/vsftpd.conf"></a>3、修改主配置文件/etc/vsftpd/vsftpd.conf</h4><p>下面是ssl参数一些定义，根据自己需求去修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ssl_enable=yes/no             是否启用 SSL,默认为no</span><br><span class="line">allow_anon_ssl=yes/no         是否允许匿名用户使用SSL,默认为no</span><br><span class="line">rsa_cert_file=/path/to/file       rsa证书的位置</span><br><span class="line">dsa_cert_file=/path/to/file      dsa证书的位置</span><br><span class="line">force_local_logins_ssl=yes/no    非匿名用户登陆时是否加密,默认为yes</span><br><span class="line">force_local_data_ssl=yes/no     非匿名用户传输数据时是否加密,默认为yes</span><br><span class="line">force_anon_logins_ssl=yes/no    匿名用户登录时是否加密,默认为no</span><br><span class="line">force_anon_data_ssl=yes/no     匿名用户数据传输时是否加密,默认为no</span><br><span class="line">ssl_sslv2=yes/no               是否激活sslv2加密,默认no</span><br><span class="line">ssl_sslv3=yes/no                是否激活sslv3加密,默认no</span><br><span class="line">ssl_tlsv1=yes/no                是否激活tls v1加密,默认yes</span><br><span class="line">ssl_ciphers=加密方法            默认是DES-CBC3-SHA</span><br><span class="line">require_ssl_reuse=no 需要数据与控制流使用相同的ssl通道，程序是另起一个ssl通道，选no</span><br><span class="line">#使用ftps的情况下，主动模式是不能用的，必须使用别动模式，为考虑安全问题，可以指定被动端口范围：</span><br><span class="line">pasv_enable=YES</span><br><span class="line">pasv_min_port=20000</span><br><span class="line">pasv_max_port=20001</span><br></pre></td></tr></table></figure></p>
<p>修改vsftpd的主配置文件vsftpd.conf添加如下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ssl_enable=YES</span><br><span class="line">allow_anon_ssl=YES</span><br><span class="line">force_anon_logins_ssl=YES</span><br><span class="line">force_anon_data_ssl=YES</span><br><span class="line">force_local_logins_ssl=YES</span><br><span class="line">force_local_data_ssl=YES</span><br><span class="line">ssl_tlsv1=YES</span><br><span class="line">ssl_sslv2=NO</span><br><span class="line">ssl_sslv3=NO</span><br><span class="line">rsa_cert_file=/etc/vsftpd/vsftpd.pem</span><br><span class="line">require_ssl_reuse=no</span><br><span class="line">pasv_enable=YES</span><br><span class="line">pasv_min_port=20000</span><br><span class="line">pasv_max_port=20001</span><br></pre></td></tr></table></figure></p>
<h4 id="4、重启vsftpd服务"><a href="#4、重启vsftpd服务" class="headerlink" title="4、重启vsftpd服务"></a>4、重启vsftpd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd</span><br></pre></td></tr></table></figure>
<h4 id="5、默认linux自带的ftp-client不支持ssl协议，如果配置了ssl，使用ftp-client连接会报错"><a href="#5、默认linux自带的ftp-client不支持ssl协议，如果配置了ssl，使用ftp-client连接会报错" class="headerlink" title="5、默认linux自带的ftp client不支持ssl协议，如果配置了ssl，使用ftp client连接会报错"></a>5、默认linux自带的ftp client不支持ssl协议，如果配置了ssl，使用ftp client连接会报错</h4><p><img src="https://i.imgur.com/gklzknf.png" alt=""><br>可以使用第三方的surgeftp测试，下载方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.netwinsite.com/pub/surgeftp/surgeftp_23f2_linux64.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>解压之后，测试连接是否正常：<br><img src="https://i.imgur.com/8blhpQc.png" alt=""><br>也可以使用windows下的ftp软件测试，如FileZilla，配置方法如下：<br><img src="https://i.imgur.com/UUcMQL8.png" alt=""></p>
<h4 id="6、配置过程终于到的问题："><a href="#6、配置过程终于到的问题：" class="headerlink" title="6、配置过程终于到的问题："></a>6、配置过程终于到的问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">522 SSL connection failed; session reuse required: see require_ssl_reuse option in vsftpd.conf man page</span><br><span class="line">解决方法：</span><br><span class="line">查看vsftpd.conf配置文件是否配置了下面参数</span><br><span class="line">require_ssl_reuse=no</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/12/vsftpd配置ssl/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr解散集群并重新添加/"><span>[Mysql] mysql-mgr解散集群并重新加入集群</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr解散集群并重新添加/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T09:21:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、查看集群状态"><a href="#1、查看集群状态" class="headerlink" title="1、查看集群状态"></a>1、查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、解散集群："><a href="#2、解散集群：" class="headerlink" title="2、解散集群："></a>2、解散集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.dissolve()</span><br><span class="line">The cluster still has active ReplicaSets.</span><br><span class="line">Please use cluster.dissolve(&#123;force: true&#125;) to deactivate replication</span><br><span class="line">and unregister the ReplicaSets from the cluster.</span><br><span class="line"></span><br><span class="line">The following replicasets are currently registered:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;topology&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.dissolve(&#123;force: true&#125;)</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The cluster was successfully dissolved.</span><br><span class="line">Replication was disabled but user data was left intact.</span><br></pre></td></tr></table></figure>
<h4 id="3、查看集群信息已经被删掉了："><a href="#3、查看集群信息已经被删掉了：" class="headerlink" title="3、查看集群信息已经被删掉了："></a>3、查看集群信息已经被删掉了：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:54:  [mysql_innodb_cluster_metadata]&gt; select * from clusters;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h4 id="4、重新建立集群："><a href="#4、重新建立集群：" class="headerlink" title="4、重新建立集群："></a>4、重新建立集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; var cluster = dba.createCluster(&apos;prodCluster&apos;);</span><br><span class="line">A new InnoDB cluster will be created on instance &apos;repl@dax-mysql-master:3306&apos;.</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-master:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-master</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;repl@dax-mysql-master:3306&apos;...</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">Adding Seed Instance...</span><br><span class="line"></span><br><span class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</span><br><span class="line">At least 3 instances are needed for the cluster to be able to withstand up to</span><br><span class="line">one server failure.</span><br></pre></td></tr></table></figure>
<h4 id="5、-查看集群状态，现在只有一个节点信息"><a href="#5、-查看集群状态，现在只有一个节点信息" class="headerlink" title="5、 查看集群状态，现在只有一个节点信息"></a>5、 查看集群状态，现在只有一个节点信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、添加新的节点："><a href="#6、添加新的节点：" class="headerlink" title="6、添加新的节点："></a>6、添加新的节点：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &apos;root@dax-mysql-slave:3306&apos;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &apos;root@dax-mysql-slave:3306&apos; was successfully added to the cluster.</span><br></pre></td></tr></table></figure>
<h4 id="7、查看集群状态，可以看到两个节点了："><a href="#7、查看集群状态，可以看到两个节点了：" class="headerlink" title="7、查看集群状态，可以看到两个节点了："></a>7、查看集群状态，可以看到两个节点了：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@db 17:14:  [mysql_innodb_cluster_metadata]&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 17:14:  [mysql_innodb_cluster_metadata]&gt; show status like &apos;%primary%&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr解散集群并重新添加/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr单主模式切换为多主/"><span>[Mysql] mysql-mgr单主模式切换为多主，多主切换为单主</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr单主模式切换为多主/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T03:54:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、停止组复制-所有节点执行-："><a href="#1、停止组复制-所有节点执行-：" class="headerlink" title="1、停止组复制(所有节点执行)："></a>1、停止组复制(所有节点执行)：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop group_replication; </span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode=OFF; </span><br><span class="line">mysql&gt; set global group_replication_enforce_update_everywhere_checks=ON;</span><br></pre></td></tr></table></figure>
<h4 id="2、随便选择某个节点执行"><a href="#2、随便选择某个节点执行" class="headerlink" title="2、随便选择某个节点执行"></a>2、随便选择某个节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON; </span><br><span class="line">mysql&gt; START GROUP_REPLICATION; </span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</span><br></pre></td></tr></table></figure>
<h4 id="3、其他节点执行"><a href="#3、其他节点执行" class="headerlink" title="3、其他节点执行"></a>3、其他节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>
<p>查看节点启动报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018-11-08T14:00:52.098660Z 56 [ERROR] Plugin group_replication reported: &apos;There was an error when connecting to the donor server. Please check that group_replication_recovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.&apos;</span><br><span class="line">2018-11-08T14:00:52.098689Z 56 [ERROR] Plugin group_replication reported: &apos;For details please check performance_schema.replication_connection_status table and error log messages of Slave I/O for channel group_replication_recovery.&apos;</span><br></pre></td></tr></table></figure></p>
<p>手动配置复制信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_user=&apos;repl&apos;,master_password=&apos;12345678&apos; for channel &apos;group_replication_recovery&apos;;</span><br></pre></td></tr></table></figure></p>
<p>再次启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、查看组信息，所有节点的信息正常，所有节点均为主："><a href="#4、查看组信息，所有节点的信息正常，所有节点均为主：" class="headerlink" title="4、查看组信息，所有节点的信息正常，所有节点均为主："></a>4、查看组信息，所有节点的信息正常，所有节点均为主：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br></pre></td></tr></table></figure>
<h4 id="5、查看集群状态"><a href="#5、查看集群状态" class="headerlink" title="5、查看集群状态"></a>5、查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Single-Master) does not match the current Group Replication configuration (Multi-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure>
<p>提示cluster 拓扑类型为单主与当前的mgr(多主)不匹配，使用cluster.rescan()参数重新扫描：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan()</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再次查看集群状态仍然报错：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Single-Master) does not match the current Group Replication configuration (Multi-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure></p>
<p>尝试删除集群元数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dba.dropMetadataSchema();</span><br><span class="line">Are you sure you want to remove the Metadata? [y/N]: y</span><br><span class="line">Metadata Schema successfully removed.</span><br></pre></td></tr></table></figure></p>
<p>重新创建集群<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true ,force: true&#125;);</span><br></pre></td></tr></table></figure></p>
<p>报错提示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Plugin group_replication reported: &apos;Table instances has a foreign key with &apos;CASCADE&apos; clause. This is not compatible with Group Replication&apos;</span><br></pre></td></tr></table></figure></p>
<p>创建集群会在mysql_innodb_cluster_metadata库下建立一个instances的表，在单主模式下创建集群没有外键级联的报错问题，在多主模式下提示有外键级联的问题，表内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `instances` (</span><br><span class="line">  `instance_id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `host_id` int(10) unsigned NOT NULL,</span><br><span class="line">  `replicaset_id` int(10) unsigned DEFAULT NULL,</span><br><span class="line">  `mysql_server_uuid` varchar(40) NOT NULL,</span><br><span class="line">  `instance_name` varchar(256) NOT NULL,</span><br><span class="line">  `role` enum(&apos;HA&apos;,&apos;readScaleOut&apos;) NOT NULL,</span><br><span class="line">  `weight` float DEFAULT NULL,</span><br><span class="line">  `addresses` json NOT NULL,</span><br><span class="line">  `attributes` json DEFAULT NULL,</span><br><span class="line">  `version_token` int(10) unsigned DEFAULT NULL,</span><br><span class="line">  `description` text,</span><br><span class="line">  PRIMARY KEY (`instance_id`),</span><br><span class="line">  UNIQUE KEY `mysql_server_uuid` (`mysql_server_uuid`),</span><br><span class="line">  UNIQUE KEY `instance_name` (`instance_name`),</span><br><span class="line">  KEY `host_id` (`host_id`),</span><br><span class="line">  KEY `instances_ibfk_2` (`replicaset_id`),</span><br><span class="line">  CONSTRAINT `instances_ibfk_1` FOREIGN KEY (`host_id`) REFERENCES `hosts` (`host_id`),</span><br><span class="line">  CONSTRAINT `instances_ibfk_2` FOREIGN KEY (`replicaset_id`) REFERENCES `replicasets` (`replicaset_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br></pre></td></tr></table></figure></p>
<p>查阅官方文档有提示说多主模式下存在这个<a href="https://bugs.mysql.com/bug.php?id=91972" target="_blank" rel="noopener">bug</a>，将该表下的外键约束去掉：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` DROP FOREIGN KEY `instances_ibfk_1`;</span><br><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` DROP FOREIGN KEY `instances_ibfk_2`;</span><br></pre></td></tr></table></figure></p>
<p>重建添加外键使用下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` ADD CONSTRAINT `instances_ibfk_1` FOREIGN KEY (`host_id`) REFERENCES `hosts` (`host_id`);</span><br><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` ADD CONSTRAINT `instances_ibfk_2` </span><br><span class="line">FOREIGN KEY (`replicaset_id`) REFERENCES `replicasets` (`replicaset_id`);</span><br></pre></td></tr></table></figure></p>
<p>将外键约束删除之后，重新创建集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true ,force: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &apos;repl@dax-mysql-master:3306&apos;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;repl@dax-mysql-master:3306&apos;...</span><br><span class="line">Adding Instance &apos;dax-mysql-slave:3306&apos;...</span><br><span class="line">Adding Instance &apos;dax-mysql-master:3306&apos;...</span><br><span class="line"></span><br><span class="line">Cluster successfully created based on existing replication group.</span><br></pre></td></tr></table></figure></p>
<p>集群创建成功，查看集群状态,两个节点均为读写模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主："><a href="#6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主：" class="headerlink" title="6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主："></a>6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主：</h4><h4 id="7、所有节点执行"><a href="#7、所有节点执行" class="headerlink" title="7、所有节点执行"></a>7、所有节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop group_replication; </span><br><span class="line">mysql&gt; set global group_replication_enforce_update_everywhere_checks=OFF; </span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode=ON;</span><br></pre></td></tr></table></figure>
<h4 id="8、主节点（dax-mysql-master）执行"><a href="#8、主节点（dax-mysql-master）执行" class="headerlink" title="8、主节点（dax-mysql-master）执行"></a>8、主节点（dax-mysql-master）执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL group_replication_bootstrap_group=ON; </span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br></pre></td></tr></table></figure>
<h4 id="9、从节点执行："><a href="#9、从节点执行：" class="headerlink" title="9、从节点执行："></a>9、从节点执行：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>
<h4 id="10、查看MGR组信息-所有节点同步正常："><a href="#10、查看MGR组信息-所有节点同步正常：" class="headerlink" title="10、查看MGR组信息,所有节点同步正常："></a>10、查看MGR组信息,所有节点同步正常：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br></pre></td></tr></table></figure>
<p>查看当前主节点信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show status like &apos;%primary%&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="11、登录mysql-shell查看集群信息："><a href="#11、登录mysql-shell查看集群信息：" class="headerlink" title="11、登录mysql-shell查看集群信息："></a>11、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Multi-Master) does not match the current Group Replication configuration (Single-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan()</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Multi-Master) does not match the current Group Replication configuration (Single-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure>
<p>跟多主切换为单主报错相同，尝试删除集群元数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dba.dropMetadataSchema();</span><br><span class="line">Are you sure you want to remove the Metadata? [y/N]: y</span><br><span class="line">Metadata Schema successfully removed.</span><br></pre></td></tr></table></figure></p>
<p>重新创建集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &apos;repl@dax-mysql-master:3306&apos;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;repl@dax-mysql-master:3306&apos;...</span><br><span class="line">Adding Seed Instance...</span><br><span class="line">Adding Instance &apos;dax-mysql-slave:3306&apos;...</span><br><span class="line"></span><br><span class="line">Cluster successfully created based on existing replication group.</span><br></pre></td></tr></table></figure></p>
<p>集群创建成功，查看集群状态为一主一从模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt;  cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr单主模式切换为多主/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/"><span>[Mysql] mysql-mgr（双节点)依次修改server-id</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T02:18:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、查看从节点server-id信息："><a href="#1、查看从节点server-id信息：" class="headerlink" title="1、查看从节点server-id信息："></a>1、查看从节点server-id信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:55:  [(none)]&gt; show variables like &quot;%server%&quot;;</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| character_set_server                              | utf8mb4                              |</span><br><span class="line">| collation_server                                  | utf8mb4_general_ci                   |</span><br><span class="line">| group_replication_recovery_ssl_verify_server_cert | OFF                                  |</span><br><span class="line">| innodb_ft_server_stopword_table                   |                                      |</span><br><span class="line">| server_id                                         | 3306102                              |</span><br><span class="line">| server_id_bits                                    | 32                                   |</span><br><span class="line">| server_uuid                                       | bddd9c32-8fee-11e8-ac79-525400edbe8d |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="2、登录mysql-shell查看集群信息："><a href="#2、登录mysql-shell查看集群信息：" class="headerlink" title="2、登录mysql-shell查看集群信息："></a>2、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将从节点移除集群：<br>MySQL  dax-mysql-master:3306  JS &gt; cluster.removeInstance(‘dax-mysql-slave:3306’)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">The instance will be removed from the InnoDB cluster. Depending on the </span><br><span class="line">instance being the Seed or not, the Metadata session might become invalid. </span><br><span class="line">If so, please start a new session to the Metadata Storage R/W instance.</span><br><span class="line"></span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The instance &apos;dax-mysql-slave:3306&apos; was successfully removed from the cluster.</span><br><span class="line"></span><br><span class="line">WARNING: The &apos;group_replication_start_on_boot&apos; variable must be set to &apos;OFF&apos; in the server configuration file, otherwise it might silently rejoin the cluster upon restart.</span><br></pre></td></tr></table></figure></p>
<p>重新扫描集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan();</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、从节点修改server-id，并重启库，之后将从节点加入集群："><a href="#3、从节点修改server-id，并重启库，之后将从节点加入集群：" class="headerlink" title="3、从节点修改server-id，并重启库，之后将从节点加入集群："></a>3、从节点修改server-id，并重启库，之后将从节点加入集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql-shell &gt; cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &apos;root@dax-mysql-slave:3306&apos;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &apos;root@dax-mysql-slave:3306&apos; was successfully added to the cluster.</span><br></pre></td></tr></table></figure>
<p>查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他节点修改方法如上。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2018 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

<script>'use strict';'serviceWorker'in navigator&&navigator.serviceWorker.register('service-worker.js').then(function(a){a.onupdatefound=function(){var b=a.installing;b.onstatechange=function(){switch(b.state){case'installed':navigator.serviceWorker.controller?console.log('New or updated content is available.'):console.log('Content is now available offline!');break;case'redundant':console.error('The installing service worker became redundant.');}}}}).catch(function(a){console.error('Error during service worker registration:',a)});
</script></body></html>