<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>[Mysql] mysql innodb_trx参数详解</title>
      <link href="/2018/09/10/mysql%20innodb_trx%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/09/10/mysql%20innodb_trx%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="1、innodb-trx表提供了当前innodb引擎内每个事物的信息（只读事物除外），包括当一个事物启动，事物是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句："><a href="#1、innodb-trx表提供了当前innodb引擎内每个事物的信息（只读事物除外），包括当一个事物启动，事物是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句：" class="headerlink" title="1、innodb_trx表提供了当前innodb引擎内每个事物的信息（只读事物除外），包括当一个事物启动，事物是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句："></a>1、innodb_trx表提供了当前innodb引擎内每个事物的信息（只读事物除外），包括当一个事物启动，事物是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_trx;</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/QEeh4UJ.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_trx\G</span><br></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/MLfEIgP.png" alt=""></p><h3 id="2、innodb-trx表列信息详解："><a href="#2、innodb-trx表列信息详解：" class="headerlink" title="2、innodb_trx表列信息详解："></a>2、innodb_trx表列信息详解：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">trx_id：唯一事物id号，只读事物和非锁事物是不会创建id的。</span><br><span class="line">TRX_WEIGHT：事物的高度，代表修改的行数（不一定准确）和被事物锁住的行数。为了解决死锁，innodb会选择一个高度最小的事物来当做牺牲品进行回滚。已经被更改的非交易型表的事务权重比其他事务高，即使改变的行和锁住的行比其他事务低。</span><br><span class="line">TRX_STATE：事物的执行状态，值一般分为：RUNNING, LOCK WAIT, ROLLING BACK, and COMMITTING.</span><br><span class="line">TRX_STARTED：事物的开始时间</span><br><span class="line">TRX_REQUESTED_LOCK_ID:如果trx_state是lockwait,显示事物当前等待锁的id，不是则为空。想要获取锁的信息，根据该lock_id，以innodb_locks表中lock_id列匹配条件进行查询，获取相关信息。</span><br><span class="line">TRX_WAIT_STARTED：如果trx_state是lockwait,该值代表事物开始等待锁的时间；否则为空。</span><br><span class="line">TRX_MYSQL_THREAD_ID：mysql线程id。想要获取该线程的信息，根据该thread_id，以INFORMATION_SCHEMA.PROCESSLIST表的id列为匹配条件进行查询。</span><br><span class="line">TRX_QUERY：事物正在执行的sql语句。</span><br><span class="line">TRX_OPERATION_STATE：事物当前的操作状态，没有则为空。</span><br><span class="line">TRX_TABLES_IN_USE：事物在处理当前sql语句使用innodb引擎表的数量。</span><br><span class="line">TRX_TABLES_LOCKED：当前sql语句有行锁的innodb表的数量。（因为只是行锁，不是表锁，表仍然可以被多个事物读和写）</span><br><span class="line">TRX_LOCK_STRUCTS：事物保留锁的数量。</span><br><span class="line">TRX_LOCK_MEMORY_BYTES：在内存中事物索结构占得空间大小。</span><br><span class="line">TRX_ROWS_LOCKED：事物行锁最准确的数量。这个值可能包括对于事物在物理上存在，实际不可见的删除标记的行。</span><br><span class="line">TRX_ROWS_MODIFIED：事物修改和插入的行数</span><br><span class="line">TRX_CONCURRENCY_TICKETS：该值代表当前事物在被清掉之前可以多少工作，由 innodb_concurrency_tickets系统变量值指定。</span><br><span class="line">TRX_ISOLATION_LEVEL：事物隔离等级。</span><br><span class="line">TRX_UNIQUE_CHECKS：当前事物唯一性检查启用还是禁用。当批量数据导入时，这个参数是关闭的。</span><br><span class="line">TRX_FOREIGN_KEY_CHECKS：当前事物的外键坚持是启用还是禁用。当批量数据导入时，这个参数是关闭的。</span><br><span class="line">TRX_LAST_FOREIGN_KEY_ERROR：最新一个外键错误信息，没有则为空。</span><br><span class="line">TRX_ADAPTIVE_HASH_LATCHED：自适应哈希索引是否被当前事物阻塞。当自适应哈希索引查找系统分区，一个单独的事物不会阻塞全部的自适应hash索引。自适应hash索引分区通过 innodb_adaptive_hash_index_parts参数控制，默认值为8。</span><br><span class="line">TRX_ADAPTIVE_HASH_TIMEOUT：是否为了自适应hash索引立即放弃查询锁，或者通过调用mysql函数保留它。当没有自适应hash索引冲突，该值为0并且语句保持锁直到结束。在冲突过程中，该值被计数为0，每句查询完之后立即释放门闩。当自适应hash索引查询系统被分区（由 innodb_adaptive_hash_index_parts参数控制），值保持为0。</span><br><span class="line">TRX_IS_READ_ONLY：值为1表示事物是read only。</span><br><span class="line">TRX_AUTOCOMMIT_NON_LOCKING：值为1表示事物是一个select语句，该语句没有使用for update或者shared mode锁，并且执行开启了autocommit，因此事物只包含一个语句。当TRX_AUTOCOMMIT_NON_LOCKING和TRX_IS_READ_ONLY同时为1，innodb通过降低事物开销和改变表数据库来优化事物。</span><br></pre></td></tr></table></figure><h3 id="3、注意事项"><a href="#3、注意事项" class="headerlink" title="3、注意事项"></a>3、注意事项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该表用于当系统负载较高时，诊断性能问题。</span><br><span class="line">查询该表必须有process权限。</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql show processlist详解</title>
      <link href="/2018/09/09/mysql%20show%20processlist%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/09/09/mysql%20show%20processlist%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="0、show-processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。"><a href="#0、show-processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。" class="headerlink" title="0、show processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。"></a>0、show processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。</h3><p>有管理员权限的用户，如下图所示：<br><img src="https://i.imgur.com/CwMY5kv.png" alt=""><br>没有管理权限的用户，如下图所示：：<br><img src="https://i.imgur.com/iJ8OO2x.png" alt=""><br>如果不加full关键字，每条语句的info信息栏只能显示前100个字符。<br>如果看到“too many connections”的错误信息，想要看看什么线程正在运行，使用show processlist语句是很有用的。mysql数据库会额外保持一个连接，供具有connection_admin或者super权限用户的使用，用以确保管理员能随时连接进来检查系统状况（假设你没有将此权限授予所有用户）。<br>show processlist输出列详解：</p><h3 id="1、id：连接标识符，与INFORMATION-SCHEMA-PROCESSLIST表的id列显示的是同类型的值，如下图所示："><a href="#1、id：连接标识符，与INFORMATION-SCHEMA-PROCESSLIST表的id列显示的是同类型的值，如下图所示：" class="headerlink" title="1、id：连接标识符，与INFORMATION_SCHEMA PROCESSLIST表的id列显示的是同类型的值，如下图所示："></a>1、id：连接标识符，与INFORMATION_SCHEMA PROCESSLIST表的id列显示的是同类型的值，如下图所示：</h3><p><img src="https://i.imgur.com/Hl57tcb.png" alt=""><br>Performance_Schema threads表的processlist_id列也是相同值，由connection_id())函数返回值。<br><img src="https://i.imgur.com/CwS1fUD.png" alt=""><br>通过kill 语句可以杀掉查询到的线程，执行命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill id号</span><br></pre></td></tr></table></figure></p><h3 id="2、user-代表数据库用户，如果是system-user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system-user，host列没有任何信息。-unauthenticated-user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event-scheduler-是监控调度事件的线程。"><a href="#2、user-代表数据库用户，如果是system-user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system-user，host列没有任何信息。-unauthenticated-user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event-scheduler-是监控调度事件的线程。" class="headerlink" title="2、user: 代表数据库用户，如果是system user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system user，host列没有任何信息。 unauthenticated user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event_scheduler 是监控调度事件的线程。"></a>2、user: 代表数据库用户，如果是system user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system user，host列没有任何信息。 unauthenticated user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event_scheduler 是监控调度事件的线程。</h3><h3 id="3、host：发起线程的客户的主机名（对于system-user，host这一列为空）。tcp-ip连接的主机名是：hostname：client-port格式，用这种格式来更方面查看客户端在做什么操作。"><a href="#3、host：发起线程的客户的主机名（对于system-user，host这一列为空）。tcp-ip连接的主机名是：hostname：client-port格式，用这种格式来更方面查看客户端在做什么操作。" class="headerlink" title="3、host：发起线程的客户的主机名（对于system user，host这一列为空）。tcp/ip连接的主机名是：hostname：client_port格式，用这种格式来更方面查看客户端在做什么操作。"></a>3、host：发起线程的客户的主机名（对于system user，host这一列为空）。tcp/ip连接的主机名是：hostname：client_port格式，用这种格式来更方面查看客户端在做什么操作。</h3><h3 id="4、db：如果指定了库名，会使用当前的库名；如果没有则为空。"><a href="#4、db：如果指定了库名，会使用当前的库名；如果没有则为空。" class="headerlink" title="4、db：如果指定了库名，会使用当前的库名；如果没有则为空。"></a>4、db：如果指定了库名，会使用当前的库名；如果没有则为空。</h3><h3 id="5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处"><a href="#5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处" class="headerlink" title="5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处"></a>5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击<a href="https://dev.mysql.com/doc/refman/8.0/en/thread-commands.html" target="_blank" rel="noopener">此处</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">connect：从复制已经连接到主库</span><br><span class="line">connect out：从复制正在连接到主库</span><br><span class="line">create db：正在执行一个创建库的操作。</span><br><span class="line">execute：正在执行一个准备好的语句。</span><br><span class="line">field list：提取表列信息线程</span><br><span class="line">kill：当前线程被其他线程杀掉。</span><br><span class="line">query：正在整型一条语句。</span><br><span class="line">quit：线程被终止。</span><br><span class="line">refresh：刷新表、日志、缓存、重置状态变量值或从服务信息线程。</span><br><span class="line">shutdown：关闭服务线程</span><br><span class="line">sleep：等待客户端发送一条新语句线程。</span><br><span class="line">table dump：发送表内容到从服务器</span><br><span class="line">statics：获取当前服务状态信息。</span><br><span class="line">如果一个线程耗时比较久，需要重点关注造成该线程。</span><br></pre></td></tr></table></figure><h3 id="6、time：当前线程耗时。对于slave-sql-线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。"><a href="#6、time：当前线程耗时。对于slave-sql-线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。" class="headerlink" title="6、time：当前线程耗时。对于slave sql 线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。"></a>6、time：当前线程耗时。对于slave sql 线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。</h3><h3 id="7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处"><a href="#7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处" class="headerlink" title="7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处"></a>7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击<a href="https://dev.mysql.com/doc/refman/8.0/en/general-thread-states.html" target="_blank" rel="noopener">此处</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">after create：执行完create table函数之后，创建表的线程（包括内部临时表），即使因为某些错误创建表失败，该状态也会显示。</span><br><span class="line">analyzing：统计myisam表键分布（例如执行analyze table）</span><br><span class="line">checking permissions：检查是否有权限执行该语句。</span><br><span class="line">check tables：执行表检查操作。</span><br><span class="line">cleaning up：线程正在处理一条命名，准备释放内存重置某些状态变量。</span><br><span class="line">closing tables:刷新更改的表到磁盘，关闭使用的表。该操作应该快速完成，如果没有，请确保是否有足够的磁盘空间或者磁盘io是否太高。</span><br><span class="line">copy to tmp table:处理alter table语句。该状态发生在表新结构被创建之后，行数据被拷贝到表之前。</span><br><span class="line">copying to group table：该执行语句中order by和group by有不同的关键字，行被组处理拷贝到临时表。</span><br><span class="line">copying to tmp table：正在复制内存中的临时表。</span><br><span class="line">altering table：正在执行alter table</span><br><span class="line">Copying to tmp table on disk:正在拷贝临时表到磁盘。临时结果变得太大，因此，线程将临时表从内存转到磁盘来节省内存。</span><br><span class="line">creating index：对myisam表进行alter table ... enable keys操作</span><br><span class="line">creating sort index:使用内部临时表处理一个select语句。</span><br><span class="line">creating table：正在创建表（包括创建临时表）</span><br><span class="line">creating tmp table：在内存或磁盘创建一个临时表。如果一个表刚开始再内存创建，之后转到磁盘，该状态会变为：Copying to tmp table on disk。</span><br><span class="line">committing alter table to storage engine：alter table已经执行完成，正在提交 结果。</span><br><span class="line">executing：已经开始执行一个语句</span><br><span class="line">freeing items：已经执行了一个命令，该状态通常在cleaning up之后。</span><br><span class="line">query end：，在freeing items状态之前，处理一个查询之后</span><br><span class="line">logging slow query：写语句到slow-query日志</span><br><span class="line">sending data：正在读取和处理一个select语句的行，并发送数据到客户端，因为可能会发生物理读，该状态可能是给定生命周期时间最长的。</span><br><span class="line">update：准备更新表</span><br><span class="line">updating：正在搜索更新的行，并更新他们</span><br><span class="line">system lock：调用了mysql_lock_tables()函数，线程状态一直没有更新。产生该问题原因很多：</span><br><span class="line">比如：请求或等待一个表的内部或者外部系统锁。当innodb等待一个表锁等级为lock tables时会发生。如果这个问题是由请求外部锁，并且你没有用多个mysqld服务访问相同的myisam引擎表，你可以通过参数 --skip-external-locking禁用外部系统锁。但是外部锁默认情况下是禁用的，因此该参数可能没有影响。对于show profile命令，该状态代表正在请求锁（不是在等待锁）</span><br><span class="line">对于系统表锁状态是Locking system tables。</span><br><span class="line">waiting for commit lock：flush tables with read lock正在等待一个commit 锁</span><br><span class="line">waiting for tables：线程收到通知，表的底层架构已经更改，需要重新打开表后去一个新的结构。但是重新打开一个表，需要等待其他正在访问该表的线程。</span><br><span class="line">通常在其他线程使用flush tables或者执行下面语句: FLUSH TABLES tbl_name, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, or OPTIMIZE TABLE. 时会发生此通知。</span><br></pre></td></tr></table></figure><h3 id="8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。"><a href="#8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。" class="headerlink" title="8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。"></a>8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。</h3><h3 id="9、另外使用mysqladmin-processlist也可以查看进程信息，如下图所示："><a href="#9、另外使用mysqladmin-processlist也可以查看进程信息，如下图所示：" class="headerlink" title="9、另外使用mysqladmin processlist也可以查看进程信息，如下图所示："></a>9、另外使用mysqladmin processlist也可以查看进程信息，如下图所示：</h3><p><img src="https://i.imgur.com/72IPvk1.png" alt=""></p><h3 id="10、如果想通过sql命令去获取自己设定的行，可按以下方法设置："><a href="#10、如果想通过sql命令去获取自己设定的行，可按以下方法设置：" class="headerlink" title="10、如果想通过sql命令去获取自己设定的行，可按以下方法设置："></a>10、如果想通过sql命令去获取自己设定的行，可按以下方法设置：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.processlist where state !=&apos; &apos;;</span><br><span class="line">![](https://i.imgur.com/pGGuMER.png)</span><br></pre></td></tr></table></figure><p>可根据自己需求添加条件。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql update一条语句过程遇到的问题</title>
      <link href="/2018/09/09/mysql%20update%E4%B8%80%E6%9D%A1%E8%AF%AD%E5%8F%A5%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/09/mysql%20update%E4%B8%80%E6%9D%A1%E8%AF%AD%E5%8F%A5%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h3 id="1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题："><a href="#1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题：" class="headerlink" title="1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题："></a>1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos;;</span><br><span class="line">error：Multi-statement TRANSACTION required more THAN &apos;max_binlog_cache_size&apos; bytes of STORAGE; increase this mysqld variable AND try again</span><br></pre></td></tr></table></figure><h3 id="2、查看binlog-cache-size，最大值为1G："><a href="#2、查看binlog-cache-size，最大值为1G：" class="headerlink" title="2、查看binlog_cache_size，最大值为1G："></a>2、查看binlog_cache_size，最大值为1G：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%binlog_cache_size%&apos;;</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| Variable_name         | Value      |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| binlog_cache_size     | 4194304    |</span><br><span class="line">| max_binlog_cache_size | 1073741824 |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3、尝试去调高max-binlog-cache-size，在此执行update语句："><a href="#3、尝试去调高max-binlog-cache-size，在此执行update语句：" class="headerlink" title="3、尝试去调高max_binlog_cache_size，在此执行update语句："></a>3、尝试去调高max_binlog_cache_size，在此执行update语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global max_binlog_cache_size=4073741824;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">mysql&gt; show variables like &apos;%binlog_cache_size%&apos;;</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| Variable_name         | Value      |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| binlog_cache_size     | 4194304    |</span><br><span class="line">| max_binlog_cache_size | 4073738240 |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog-cache-size仍然不满足，每次更新100万，执行正常："><a href="#4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog-cache-size仍然不满足，每次更新100万，执行正常：" class="headerlink" title="4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog_cache_size仍然不满足，每次更新100万，执行正常："></a>4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog_cache_size仍然不满足，每次更新100万，执行正常：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id &gt;=1 and id &lt;= 1000000;</span><br><span class="line">Query OK, 974190 rows affected (2 min 3.48 sec)</span><br><span class="line">Rows matched: 974190  Changed: 974190  Warnings: 0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id &gt;=16000000 and id &lt;= 17000000;</span><br><span class="line">Query OK, 982238 rows affected (2 min 37.44 sec)</span><br><span class="line">Rows matched: 982238  Changed: 982238  Warnings: 0</span><br></pre></td></tr></table></figure><p>每100万更新耗时为2min 40s左右</p><h3 id="5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法："><a href="#5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法：" class="headerlink" title="5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法："></a>5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from trade_order ORDER BY id ASC LIMIT 1,1000000) as tmp);</span><br></pre></td></tr></table></figure><p>该方法涉及到一个子查询，总体执行速度会下降，根据取值范围和当前实际更新的行数，耗时在4min左右：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from trade_order ORDER BY id ASC LIMIT 1,1000000) as tmp);</span><br><span class="line">Query OK, 981631 rows affected (3 min 49.27 sec)</span><br><span class="line">Rows matched: 981631  Changed: 981631  Warnings: 0</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql报错：[ERROR] InnoDB: Unable to lock ./ibdata1</title>
      <link href="/2018/09/08/mysql%E6%8A%A5%E9%94%99-%5BERROR%5D%20InnoDB-Unable%20to%20lock%20-ibdata1/"/>
      <url>/2018/09/08/mysql%E6%8A%A5%E9%94%99-%5BERROR%5D%20InnoDB-Unable%20to%20lock%20-ibdata1/</url>
      <content type="html"><![CDATA[<h3 id="1、-登录mysql报错："><a href="#1、-登录mysql报错：" class="headerlink" title="1、 登录mysql报错："></a>1、 登录mysql报错：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">ERROR 2002 (HY000): Can&apos;t connect to local MySQL server through socket &apos;/data/mysql/tmp/mysql.sock&apos; (2)</span><br></pre></td></tr></table></figure><h3 id="2、netstat-tunlp-grep-3306发现mysql进程不存在，尝试去启动mysql："><a href="#2、netstat-tunlp-grep-3306发现mysql进程不存在，尝试去启动mysql：" class="headerlink" title="2、netstat -tunlp|grep 3306发现mysql进程不存在，尝试去启动mysql："></a>2、netstat -tunlp|grep 3306发现mysql进程不存在，尝试去启动mysql：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br><span class="line"> ERROR! MySQL server PID file could not be found!</span><br><span class="line">Starting MySQL....................................................................................^C</span><br><span class="line">启动失败，按ctrl+c退出。</span><br></pre></td></tr></table></figure><h3 id="3、查看log日志，一直在刷错误日志"><a href="#3、查看log日志，一直在刷错误日志" class="headerlink" title="3、查看log日志，一直在刷错误日志"></a>3、查看log日志，一直在刷错误日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] InnoDB: Unable to lock ./ibdata1 error: 11</span><br><span class="line">[Note] InnoDB: Check that you do not already have</span><br></pre></td></tr></table></figure><h3 id="4、查看磁盘使用情况"><a href="#4、查看磁盘使用情况" class="headerlink" title="4、查看磁盘使用情况"></a>4、查看磁盘使用情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdc1       1.1T   59G  967G   6% /data</span><br><span class="line">数据目录还有很多空间。</span><br></pre></td></tr></table></figure><h3 id="5、查看mysql进程"><a href="#5、查看mysql进程" class="headerlink" title="5、查看mysql进程"></a>5、查看mysql进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;ps -ef|grep mysql</span><br><span class="line">mysql      1486 130771  2 05:16 pts/0    00:00:01 /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306</span><br><span class="line">root      77736      1  0 Jul25 ?        00:00:00 /bin/sh /data/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/tmp/mysql.pid</span><br><span class="line">mysql    128601  77736 85 05:13 ?        00:03:49 /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306</span><br><span class="line">root     130771      1  0 05:16 pts/0    00:00:00 /bin/sh /data/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/tmp/mysql.pid</span><br></pre></td></tr></table></figure><h3 id="6、top查看进程运行情况"><a href="#6、top查看进程运行情况" class="headerlink" title="6、top查看进程运行情况"></a>6、top查看进程运行情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tasks: 187 total,   1 running, 186 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.4 us,  0.3 sy,  0.0 ni, 99.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 32930580 total, 21548588 free,  7218592 used,  4163400 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 24748960 avail Mem </span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                             </span><br><span class="line">128601 mysql     20   0 21.711g 4.678g  12784 S   2.6 14.9   3:50.26 mysqld</span><br></pre></td></tr></table></figure><h3 id="7、杀掉进程128601"><a href="#7、杀掉进程128601" class="headerlink" title="7、杀掉进程128601"></a>7、杀掉进程128601</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -9 128601</span><br><span class="line">/data/mysql/bin/mysqld_safe: line 198:  1486 Killed                  nohup /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306 &lt; /dev/null &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>因为mysql的守护进程存在，会自动启动mysql进程，再次登录数据库<br>mysql -uroot -p,登录正常。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql批量建库、修改多库中同一命名个表</title>
      <link href="/2018/09/07/%E4%BA%91%E4%BA%A4%E6%98%93%E6%89%80%E5%BB%BA%E5%BA%93%E3%80%81%E4%BF%AE%E6%94%B9%E5%A4%9A%E4%B8%AA%E8%A1%A8%E7%9A%84%E8%AF%AD%E5%8F%A5/"/>
      <url>/2018/09/07/%E4%BA%91%E4%BA%A4%E6%98%93%E6%89%80%E5%BB%BA%E5%BA%93%E3%80%81%E4%BF%AE%E6%94%B9%E5%A4%9A%E4%B8%AA%E8%A1%A8%E7%9A%84%E8%AF%AD%E5%8F%A5/</url>
      <content type="html"><![CDATA[<h3 id="1、批量删除数据库"><a href="#1、批量删除数据库" class="headerlink" title="1、批量删除数据库"></a>1、批量删除数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">mysql -u root -ptest -e &quot;drop database $i&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="2、批量创建数据库"><a href="#2、批量创建数据库" class="headerlink" title="2、批量创建数据库"></a>2、批量创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">mysql -u root -ptest -e &quot;create database $i&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="3、批量在多个库中创建多个表"><a href="#3、批量在多个库中创建多个表" class="headerlink" title="3、批量在多个库中创建多个表"></a>3、批量在多个库中创建多个表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">for j in &#123;0..19&#125;</span><br><span class="line">do </span><br><span class="line">sql=&quot;CREATE TABLE \`match_record_$&#123;j&#125;\` (</span><br><span class="line">  \`id\` bigint(20) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">  \`symbol\` varchar(30) NOT NULL COMMENT &apos;交易对&apos;,</span><br><span class="line">  \`price\` decimal(30,15) NOT NULL COMMENT &apos;成交价格&apos;,</span><br><span class="line">  \`quantity\` decimal(30,15) NOT NULL COMMENT &apos;成交量&apos;,</span><br><span class="line">  \`buy_match_seq\` int(11) NOT NULL COMMENT &apos;买入成交序号&apos;,</span><br><span class="line">  \`buy_tx_no\` varchar(32) NOT NULL COMMENT &apos;买入交易单号&apos;,</span><br><span class="line">  \`sell_match_seq\` int(11) NOT NULL COMMENT &apos;卖出成交序号&apos;,</span><br><span class="line">  \`sell_tx_no\` varchar(32) NOT NULL COMMENT &apos;卖出交易单号&apos;,</span><br><span class="line">  \`is_maker\` tinyint(1) NOT NULL COMMENT &apos;买入方是否为maker&apos;,</span><br><span class="line">  \`create_time\` bigint(20) NOT NULL COMMENT &apos;成交时间戳&apos;,</span><br><span class="line">  PRIMARY KEY (\`id\`),</span><br><span class="line">  UNIQUE KEY \`uniq_idsymbol\` (\`id\`,\`symbol\`),</span><br><span class="line">  UNIQUE KEY \`uniq_txno\` (\`buy_tx_no\`,\`sell_tx_no\`),</span><br><span class="line">  KEY \`idx_create_time\` (\`create_time\`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;成交记录表&apos;;</span><br><span class="line">&quot;</span><br><span class="line">mysql -uroot -ptest -D $i -e&quot;$&#123;sql&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="4、批量修改多个库中的一个同名表做ddl语句操作"><a href="#4、批量修改多个库中的一个同名表做ddl语句操作" class="headerlink" title="4、批量修改多个库中的一个同名表做ddl语句操作"></a>4、批量修改多个库中的一个同名表做ddl语句操作</h3><p>对表增加列，添加唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">symbol=`echo &quot;$i&quot;| awk -F &apos;test_&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">sql=&quot;alter table match_record_0 add column symbol varchar(30) NOT NULL COMMENT &apos;交易对&apos; default &apos;&quot;$&#123;symbol&#125;&quot;&apos;&quot;</span><br><span class="line">alter1=&quot;alter table match_record_0 add UNIQUE KEY \`uniq_idsymbol\` (\`id\`,\`symbol\`)&quot;</span><br><span class="line">alter2=&quot;alter table match_record_0 add UNIQUE KEY \`uniq_txno\` (\`buy_tx_no\`,\`sell_tx_no\`)&quot;</span><br><span class="line">mysql -u root -ptest -D $i -e&quot;$&#123;sql&#125;;$&#123;alter1&#125;;$&#123;alter2&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p><p>对表删除列，删除唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">symbol=`echo &quot;$i&quot;| awk -F &apos;test_&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">sql=&quot;alter table match_record_0 drop column symbol&quot;</span><br><span class="line">alter1=&quot;alter table match_record_0 drop index \`uniq_idsymbol\`&quot;</span><br><span class="line">alter2=&quot;alter table match_record_0 drop index \`uniq_txno\`&quot;</span><br><span class="line">mysql -u root -ptest -D $i -e&quot;$&#123;sql&#125;;$&#123;alter1&#125;;$&#123;alter2&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-binary排序规则与_bin排序规则对比</title>
      <link href="/2018/09/06/mysql%20binary%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E4%B8%8E_bin%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E5%AF%B9%E6%AF%94/"/>
      <url>/2018/09/06/mysql%20binary%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E4%B8%8E_bin%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E5%AF%B9%E6%AF%94/</url>
      <content type="html"><![CDATA[<h3 id="1、binary排序规则与-bin排序规则对比"><a href="#1、binary排序规则与-bin排序规则对比" class="headerlink" title="1、binary排序规则与_bin排序规则对比"></a>1、binary排序规则与_bin排序规则对比</h3><p>二进制字符串（像用binary，barbinary，blob存储的数据类型）有一个字符集和以binary命名的排序规则。二进制字符串是序列字节，这些字节的数字值决定了比较和排序的顺序。<br>非二进制字符串（像用char，varchar，text存储的数据类型）有一个字符集和排序规则（名称不是binary）。一个给定的非二进制字符集有几个排序规则，每一种排序规则对集合中的字符串定义一个特定的比较和排序的顺序。这些非二进制字符集的命名规则是在二进制字符集排序规则的名称后面添加_bin后缀。例如二进制排序规则latin1和utf8分别被命名latin1_bin,utf8_bin。</p><h3 id="2、在某些方面，二进制排序规则与-bin排序规则不同。"><a href="#2、在某些方面，二进制排序规则与-bin排序规则不同。" class="headerlink" title="2、在某些方面，二进制排序规则与_bin排序规则不同。"></a>2、在某些方面，二进制排序规则与_bin排序规则不同。</h3><h5 id="2-1、比较和排序单元："><a href="#2-1、比较和排序单元：" class="headerlink" title="2.1、比较和排序单元："></a>2.1、比较和排序单元：</h5><p>二进制字符串是字节序列。对于二进制排序规则，比较和排序是基于数字字节值。<br>非二进制字符串是（可能是多字节）字符的序列。非二进制排序规则定义了比较和排序字符值的顺序。对于_bin排序规则，这个顺序基于数字字符串编码值，类似于二进制字符串顺序（多字节字符串编制值除外）</p><h5 id="2-2、字符转换："><a href="#2-2、字符转换：" class="headerlink" title="2.2、字符转换："></a>2.2、字符转换：</h5><p>一个非二进制字符串有一个字符集，在很多情况下（即使字符串有_bin排序规则）也可以自动转换为另一个字符集。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当从另一个有不同字符集的列分配列值：</span><br><span class="line">UPDATE t1 SET utf8_bin_column=latin1_column;</span><br><span class="line">INSERT INTO t1 (latin1_column) SELECT utf8_bin_column FROM t2;</span><br><span class="line">当使用字符串文字为insert或update分配值时：</span><br><span class="line">SET NAMES latin1;</span><br><span class="line">INSERT INTO t1 (utf8_bin_column) VALUES (&apos;string-in-latin1&apos;);</span><br><span class="line">当从服务端给客户端返回结果：</span><br><span class="line">SET NAMES latin1;</span><br><span class="line">SELECT utf8_bin_column FROM t2;</span><br></pre></td></tr></table></figure></p><p>对于二进制字符串列，没有转换发生。对于前面的情况，字符串值是按字节复制的。</p><h5 id="2-3、大小写转换："><a href="#2-3、大小写转换：" class="headerlink" title="2.3、大小写转换："></a>2.3、大小写转换：</h5><p>非二进制字符集排序规则提供关于字符字母大小写的信息，因此非二进制字符可以被转换从一个字母到另一个，即使_bin排序规则忽略字母大小写顺序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES latin1 COLLATE latin1_bin;</span><br><span class="line">mysql&gt; SELECT LOWER(&apos;aA&apos;), UPPER(&apos;zZ&apos;);</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| LOWER(&apos;aA&apos;) | UPPER(&apos;zZ&apos;) |</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| aa          | ZZ          |</span><br><span class="line">+-------------+-------------+</span><br></pre></td></tr></table></figure></p><p>字母大小写的概念对二进制字符串的字节不适用，执行字母大小写转换，字符串必须转换为非二进制字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES binary;</span><br><span class="line">mysql&gt; SELECT LOWER(&apos;aA&apos;), LOWER(CONVERT(&apos;aA&apos; USING latin1));</span><br><span class="line">+-------------+-----------------------------------+</span><br><span class="line">| LOWER(&apos;aA&apos;) | LOWER(CONVERT(&apos;aA&apos; USING latin1)) |</span><br><span class="line">+-------------+-----------------------------------+</span><br><span class="line">| aA          | aa                                |</span><br><span class="line">+-------------+-----------------------------------+</span><br></pre></td></tr></table></figure></p><h5 id="2-4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括-bin排序规则，尾随空间在比较过程是无关紧要的："><a href="#2-4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括-bin排序规则，尾随空间在比较过程是无关紧要的：" class="headerlink" title="2.4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括_bin排序规则，尾随空间在比较过程是无关紧要的："></a>2.4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括_bin排序规则，尾随空间在比较过程是无关紧要的：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; SELECT &apos;a &apos; = &apos;a&apos;;</span><br><span class="line">+------------+</span><br><span class="line">| &apos;a &apos; = &apos;a&apos; |</span><br><span class="line">+------------+</span><br><span class="line">|          1 |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure><p>对于二进制字符串，比较过程所有的字符都是重要的，包括尾随空间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES binary;</span><br><span class="line">mysql&gt; SELECT &apos;a &apos; = &apos;a&apos;;</span><br><span class="line">+------------+</span><br><span class="line">| &apos;a &apos; = &apos;a&apos; |</span><br><span class="line">+------------+</span><br><span class="line">|          0 |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure></p><h5 id="2-5、在插入和检索中的尾随空间处理："><a href="#2-5、在插入和检索中的尾随空间处理：" class="headerlink" title="2.5、在插入和检索中的尾随空间处理："></a>2.5、在插入和检索中的尾随空间处理：</h5><p>char(n)列存储非二进制字符串，当insert操作是，值小于n字符会使用空格扩展。在检索时尾随空间会被移除。<br>二进制列存储二进制字符串,插入过程中值小于n字节，会使用ox00扩展，在检索过程中不会被移除；总是返回声明长度的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE t1 (</span><br><span class="line">         a CHAR(10) CHARACTER SET utf8 COLLATE utf8_bin,</span><br><span class="line">         b BINARY(10)</span><br><span class="line">       );</span><br><span class="line">mysql&gt; INSERT INTO t1 VALUES (&apos;a&apos;,&apos;a&apos;);</span><br><span class="line">mysql&gt; SELECT HEX(a), HEX(b) FROM t1;</span><br><span class="line">+--------+----------------------+</span><br><span class="line">| HEX(a) | HEX(b)               |</span><br><span class="line">+--------+----------------------+</span><br><span class="line">| 61     | 61000000000000000000 |</span><br><span class="line">+--------+----------------------+</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql唯一性索引详解</title>
      <link href="/2018/09/05/mysql%E5%94%AF%E4%B8%80%E6%80%A7%E7%B4%A2%E5%BC%95/"/>
      <url>/2018/09/05/mysql%E5%94%AF%E4%B8%80%E6%80%A7%E7%B4%A2%E5%BC%95/</url>
      <content type="html"><![CDATA[<h3 id="1、唯一性索引创建条件："><a href="#1、唯一性索引创建条件：" class="headerlink" title="1、唯一性索引创建条件："></a>1、唯一性索引创建条件：</h3><p>唯一性索引创建一个约束条件要求索引列上的所有值必须是不同的，如果你尝试添加一行新数据，但该行的键值与已经存在的其他行的键值相同将会报错。如果为唯一性索引指定前缀值，前缀长度的列值要保证唯一。唯一性索引允许null值。</p><h3 id="2、唯一非空索引-rowid的使用："><a href="#2、唯一非空索引-rowid的使用：" class="headerlink" title="2、唯一非空索引_rowid的使用："></a>2、唯一非空索引_rowid的使用：</h3><p>如果一个表有主键索引或者唯一非空索引，且索引由一个单独整型列类型组成，你可以在select语句使用_rowid来引用索引列，具体如下：<br>_rowid引用主键列如果主键列由单个整型列组成，如果存在主键列但是他不是由一个单独整型列组成，_rowid不能被使用。<br>另外，_rowid引用第一个有单个整型列组成的唯一非空索引列，如果不是，_rowid不能被使用。</p><h3 id="3、创建测试表，并将列修改为唯一非空进行试验："><a href="#3、创建测试表，并将列修改为唯一非空进行试验：" class="headerlink" title="3、创建测试表，并将列修改为唯一非空进行试验："></a>3、创建测试表，并将列修改为唯一非空进行试验：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table unique_t(id int,name varchar(10));</span><br><span class="line">alter table unique_t add unique index id_unique_ind(id);</span><br><span class="line">alter table unique_t modify id int not null;</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                                      |</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL,</span><br><span class="line">  UNIQUE KEY `id_unique_ind` (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>插入测试数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">insert into unique_t values(1,&apos;a&apos;),(2,&apos;b&apos;),(3,&apos;c&apos;),(4,&apos;d&apos;),(6,&apos;e&apos;);</span><br><span class="line">select *,_rowid from unique_t;</span><br><span class="line">+----+------+--------+</span><br><span class="line">| id | name | _rowid |</span><br><span class="line">+----+------+--------+</span><br><span class="line">|  1 | a    |      1 |</span><br><span class="line">|  2 | b    |      2 |</span><br><span class="line">|  3 | c    |      3 |</span><br><span class="line">|  4 | d    |      4 |</span><br><span class="line">|  6 | e    |      6 |</span><br><span class="line">+----+------+--------+</span><br></pre></td></tr></table></figure></p><h3 id="4、删除唯一性索引，修改id默认列可以为空："><a href="#4、删除唯一性索引，修改id默认列可以为空：" class="headerlink" title="4、删除唯一性索引，修改id默认列可以为空："></a>4、删除唯一性索引，修改id默认列可以为空：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">alter table unique_t drop index id_unique_ind;</span><br><span class="line">alter table unique_t modify id int null;</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                     |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>为id列创建主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">alter table unique_t add primary key(id);</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                       |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">select *,_rowid from unique_t;</span><br><span class="line">+----+------+--------+</span><br><span class="line">| id | name | _rowid |</span><br><span class="line">+----+------+--------+</span><br><span class="line">|  1 | a    |      1 |</span><br><span class="line">|  2 | b    |      2 |</span><br><span class="line">|  3 | c    |      3 |</span><br><span class="line">|  4 | d    |      4 |</span><br><span class="line">|  6 | e    |      6 |</span><br><span class="line">+----+------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>给id添加主键约束和唯一非空约束，_rowid都可以引用对应列。</p><h3 id="5、删除id主键，将name列设置为主键测试"><a href="#5、删除id主键，将name列设置为主键测试" class="headerlink" title="5、删除id主键，将name列设置为主键测试"></a>5、删除id主键，将name列设置为主键测试</h3><p>alter table unique_t drop primary key;<br>alter table unique_t add primary key(name);<br>show index from unique_t;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| Table    | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| unique_t |          0 | PRIMARY  |            1 | name        | A         |           5 |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line"></span><br><span class="line"> show create table unique_t;</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                     |</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">root@db 07:11:  [exchange_market]&gt; select *,_rowid from unique_t;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &apos;_rowid&apos; in &apos;field list&apos;</span><br></pre></td></tr></table></figure></p><p>非单个整型列的主键，_rowid无法使用。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql前缀索引详解</title>
      <link href="/2018/09/05/mysql%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95/"/>
      <url>/2018/09/05/mysql%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95/</url>
      <content type="html"><![CDATA[<h3 id="1、使用前缀索引注意事项："><a href="#1、使用前缀索引注意事项：" class="headerlink" title="1、使用前缀索引注意事项："></a>1、使用前缀索引注意事项：</h3><p>1)、列类型为char，varchar，binary，varbinary可以创建前缀索引；<br>2)、列类型为blob，text必须创建前缀索引，而且只有innodb，myisam，blackhole的存储引擎前缀索引才生效；<br>3)、前缀限制是以字节为单位的，但是在create table，alter table，create index语句中索引指定的前缀长度的值为：非二进制类型的（cahr varchar，text）的字符串数据量、二进制类型的（binary，varbinary，blob）的字节数量。当用多字节字符串集为非二进制字符串列创建前缀索引长度时，需要考虑这一点。<br>是否支持前缀索引和前缀的长度跟存储引擎有关系。例如，innodb引擎表前缀索引支持767字节长度，如果开启innodb_large_prefix参数，支持3072字节长度。myisam存储引擎表，前缀长度为1000字节。NDB引擎不支持前缀索引。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_large_prefix'</span>;</span><br><span class="line">+<span class="comment">---------------------+-------+</span></span><br><span class="line">| Variable_name       | Value |</span><br><span class="line">+<span class="comment">---------------------+-------+</span></span><br><span class="line">| innodb_large_prefix | ON    |</span><br><span class="line">+<span class="comment">---------------------+-------+</span></span><br></pre></td></tr></table></figure></p><p>4)、以mysql5.7.17为例，如果一个指定的索引前缀长度超过最大列数据类型大小，create index时会如下处理索引：<br>对于非唯一索引，或者一个错误发生(严格sqlmode开启)，或者索引长度降低到最大列数据类型大小并产生一个警告信息(如果strcit sql mode没有开启)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;sql_mode&apos;;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                  |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>严格模式是指将SQL_MODE变量设置为STRICT_TRANS_TABLES或STRICT_ALL_TABLES中的至少一种。<br>对于唯一索引，不管sqlmode模式是何种，都会直接报错，因为降低索引长度会插入非唯一的条目不满足唯一性需求。</p><p>5)、创建前缀索引语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX part_of_name ON customer (name(10));</span><br></pre></td></tr></table></figure></p><p>如果列中的名字在前10个字节中通常是不同的，查询性能不应该慢于创建整个name列索引的查询。另外使用列前缀索引使索引文件更小，能够节省更多的磁盘空间并且增加插入速度。</p><h3 id="2、下面是根据网上提供的方法做的测试，参考链接"><a href="#2、下面是根据网上提供的方法做的测试，参考链接" class="headerlink" title="2、下面是根据网上提供的方法做的测试，参考链接"></a>2、下面是根据网上提供的方法做的测试，<a href="https://blog.csdn.net/dhrome/article/details/72853153" target="_blank" rel="noopener">参考链接</a></h3><p>1)、插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table music(</span><br><span class="line">name varchar(30)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into music values(&apos;BITE&apos;),(&apos;There for you&apos;),(&apos;Scarborough Fair&apos;),(&apos;Shape of You&apos;),(&apos;Marvin Gaye&apos;),(&apos;Pretty Girl&apos;),(&apos;Pretty Boy&apos;),(&apos;Walk Away&apos;),(&apos;YOUTH&apos;),(&apos;Paris&apos;);</span><br><span class="line"></span><br><span class="line">insert into music values (&apos;Scarborough Fair&apos;),(&apos;Shape of You&apos;),(&apos;Marvin Gaye&apos;),(&apos;Pretty Girl&apos;),(&apos;Pretty Boy&apos;),(&apos;Walk Away&apos;),(&apos;YOUTH&apos;),(&apos;Paris&apos;);</span><br></pre></td></tr></table></figure></p><p>2)、查看完整列索引选择性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:31:  [exchange_market]&gt; select count(distinct name) / count(*) from music;</span><br><span class="line">+---------------------------------+</span><br><span class="line">| count(distinct name) / count(*) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                          0.5556 |</span><br><span class="line">+---------------------------------+</span><br></pre></td></tr></table></figure></p><p>3)、查找合适的前缀索引长度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct left(name,1))/count(*) as sel1, count(distinct left(name,2))/count(*) as sel2, count(distinct left(name,3))/count(*) as sel3, count(distinct left(name,4))/count(*) as sel4 from music;</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">| sel1   | sel2   | sel3   | sel4   |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">| 0.3889 | 0.5000 | 0.5000 | 0.5000 |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></p><p>4)、可以看到当前缀长度为2是已经接近完整列索引选择性,添加前缀索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">alter table music add index music_index(name(2));</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">show index from music;</span><br><span class="line">+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| Table | Non_unique | Key_name    | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| music |          1 | music_index |            1 | name        | A         |           9 |        2 | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br></pre></td></tr></table></figure></p><p>5)、查询索引是否被正常应用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">select * from music where name like &apos;s%&apos;;</span><br><span class="line">+------------------+</span><br><span class="line">| name             |</span><br><span class="line">+------------------+</span><br><span class="line">| Scarborough Fair |</span><br><span class="line">| Scarborough Fair |</span><br><span class="line">| Shape of You     |</span><br><span class="line">| Shape of You     |</span><br><span class="line">+------------------+</span><br><span class="line">4 rows in set (0.07 sec)</span><br><span class="line"></span><br><span class="line">explain select * from music where name like &apos;s%&apos;;</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+-------------+---------+------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key         | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+-------------+---------+------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | music | NULL       | range | music_index   | music_index | 11      | NULL |    4 |   100.00 | Using where |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+-------------+---------+------+------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 使用mysqladmin查看innodb_buffer_pool缓存命中率及缓存使用情况</title>
      <link href="/2018/09/04/%E4%BD%BF%E7%94%A8mysqladmin%E6%9F%A5%E7%9C%8Binnodb_buffer_pool%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87%E5%8F%8A%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5/"/>
      <url>/2018/09/04/%E4%BD%BF%E7%94%A8mysqladmin%E6%9F%A5%E7%9C%8Binnodb_buffer_pool%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87%E5%8F%8A%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5/</url>
      <content type="html"><![CDATA[<h3 id="1、查看缓存命中率"><a href="#1、查看缓存命中率" class="headerlink" title="1、查看缓存命中率"></a>1、查看缓存命中率</h3><p>计算缓存命中率相关参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Innodb_buffer_pool_reads：innodb缓存无法满足逻辑读，不得不从磁盘获取数据的逻辑读数量</span><br><span class="line">Innodb_buffer_pool_read_requests：逻辑读的请求数量</span><br></pre></td></tr></table></figure></p><p>如果查看当前某一时刻的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> mysqladmin -uroot -p12345678  ext | grep Innodb_buffer_pool_reads</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_reads                      | 31763701                                         |</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> mysqladmin -uroot -p12345678 ext | grep Innodb_buffer_pool_read_requests </span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 866018530                                        |</span><br></pre></td></tr></table></figure><p>如果想要查看多次的取值，并计算间隔的差值(-i 1间隔为1s)(-r 获取前后两个值之间的差值)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_reads</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_reads                      | 31763701                                         |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_read_requests </span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 866018530                                        |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br></pre></td></tr></table></figure><p>也可指定-c(value)参数，指定获取几次的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 -c5 ext | grep Innodb_buffer_pool_read_requests</span><br></pre></td></tr></table></figure></p><p>根据获取到的值计算缓存命中率：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Innodb_buffer_pool_read_requests-Innodb_buffer_pool_reads)/Innodb_buffer_pool_read_requests</span><br></pre></td></tr></table></figure></p><p>如果太低，建议增大innodb_buffer_pool</p><h3 id="2、查看缓存池使用情况"><a href="#2、查看缓存池使用情况" class="headerlink" title="2、查看缓存池使用情况"></a>2、查看缓存池使用情况</h3><p>缓存池使用情况参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Innodb_buffer_pool_pages_free:innodb buffer pool空闲页；</span><br><span class="line">Innodb_buffer_pool_pages_data：innodb buffer pool包含数据的页数量：</span><br><span class="line">Innodb_buffer_pool_pages_total：innodb buffer pool内存页总数量(每页16k)；</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_pages_free</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 31974                                            |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_pages_data</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 96923                                            |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_pages_total</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 131056                                           |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br></pre></td></tr></table></figure><p>如果Innodb_buffer_pool_pages_free偏大的话，证明有很多缓存没有被利用到，这时可以考虑减小缓存，相反Innodb_buffer_pool_pages_data过大就考虑增大缓存。</p><h3 id="3、另附使用mysqladmin查询qps的方法，参考链接"><a href="#3、另附使用mysqladmin查询qps的方法，参考链接" class="headerlink" title="3、另附使用mysqladmin查询qps的方法，参考链接"></a>3、另附使用mysqladmin查询qps的方法，<a href="http://blog.itpub.net/31475233/viewspace-2142864/" target="_blank" rel="noopener">参考链接</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -P3306 -uroot -p12345678  -ri1 ext |\</span><br><span class="line">awk -F&quot;|&quot; \</span><br><span class="line">&quot;BEGIN&#123; count=0; &#125;&quot;\</span><br><span class="line">&apos;&#123; if($2 ~ /Variable_name/ &amp;&amp; ((++count)%20 == 1))&#123;\</span><br><span class="line">  print &quot;----------|---------|--- MySQL Command Status --|----- Innodb row operation ----|-- Buffer Pool Read --&quot;;\</span><br><span class="line">  print &quot;---Time---|---QPS---|select insert update delete| read inserted updated deleted|  logical  physical&quot;;\</span><br><span class="line">&#125;\</span><br><span class="line">else if ($2 ~ /Queries/)&#123;queries=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_select /)&#123;com_select=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_insert /)&#123;com_insert=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_update /)&#123;com_update=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_delete /)&#123;com_delete=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_read/)&#123;innodb_rows_read=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_deleted/)&#123;innodb_rows_deleted=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_inserted/)&#123;innodb_rows_inserted=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_updated/)&#123;innodb_rows_updated=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_buffer_pool_read_requests/)&#123;innodb_lor=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_buffer_pool_reads/)&#123;innodb_phr=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Uptime / &amp;&amp; count &gt;= 2)&#123;\</span><br><span class="line"> printf(&quot; %s |%9d&quot;,strftime(&quot;%H:%M:%S&quot;),queries);\</span><br><span class="line"> printf(&quot;|%6d %6d %6d %6d&quot;,com_select,com_insert,com_update,com_delete);\</span><br><span class="line"> printf(&quot;|%6d %8d %7d %7d&quot;,innodb_rows_read,innodb_rows_inserted,innodb_rows_updated,innodb_rows_deleted);\</span><br><span class="line"> printf(&quot;|%10d %11d\n&quot;,innodb_lor,innodb_phr);\</span><br><span class="line">&#125;&#125;&apos;</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql blackhole-engine详解</title>
      <link href="/2018/09/04/mysql%20blackhole-engine/"/>
      <url>/2018/09/04/mysql%20blackhole-engine/</url>
      <content type="html"><![CDATA[<h3 id="1、mysql-黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。"><a href="#1、mysql-黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。" class="headerlink" title="1、mysql 黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。"></a>1、mysql 黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE test(i INT, c CHAR(10)) ENGINE = BLACKHOLE;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">mysql&gt; INSERT INTO test VALUES(1,&apos;record one&apos;),(2,&apos;record two&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line">mysql&gt; SELECT * FROM test;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为-frm，没有与该表关联的其他文件"><a href="#2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为-frm，没有与该表关联的其他文件" class="headerlink" title="2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为.frm，没有与该表关联的其他文件"></a>2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为.frm，没有与该表关联的其他文件</h3><p>黑洞引擎支持所有类型的索引，定义表时，可以声明索引。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll test.*</span><br><span class="line">-rw-r----- 1 mysql mysql 8578 Sep  4 06:22 test.frm</span><br></pre></td></tr></table></figure></p><h3 id="3、可以通过show-engines查看是否支持黑洞引擎："><a href="#3、可以通过show-engines查看是否支持黑洞引擎：" class="headerlink" title="3、可以通过show engines查看是否支持黑洞引擎："></a>3、可以通过show engines查看是否支持黑洞引擎：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br></pre></td></tr></table></figure><h3 id="4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。"><a href="#4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。" class="headerlink" title="4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。"></a>4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设您的应用程序需要从属端过滤规则，但是传输所有的二进制数据到从库会造成很大的网络流量，在这种情况下，在主库设置存储引擎为黑洞的‘dummy’从进程，如下图所示：</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/cxMKOso.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主库写入二级制日志，‘dummy’mysqld 进程作为从进程执行，合并replicate-do-* 和replicate-ignore-*规则，自己写入一个新的，过滤好的二进制日志，该过滤日志传递给从库。</span><br><span class="line">虚拟的进程不存储任何数据，因此外的mysqld进程复制主库信息产生少量的开销。</span><br><span class="line">黑洞引擎表，insert触发器可正常使用，但是因为不存储数据，update和delete引擎没有激活，因为没有行，for each row触发器定义不适用。</span><br></pre></td></tr></table></figure></p><h3 id="5、黑洞引擎的用途："><a href="#5、黑洞引擎的用途：" class="headerlink" title="5、黑洞引擎的用途："></a>5、黑洞引擎的用途：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、验证转储文件语法</span><br><span class="line">2、启用或禁用二级制日志，来测量二进制日志带来的开销</span><br><span class="line">3、黑洞引擎本质上是一个无操作的引擎，因此可以用于查找与引擎本身无关的性能瓶颈。</span><br></pre></td></tr></table></figure><p>黑洞引擎是交易感知的，提交的事物写入二进制日志，回滚事物不写入。</p><h3 id="6、黑洞引擎和自动增量列的问题："><a href="#6、黑洞引擎和自动增量列的问题：" class="headerlink" title="6、黑洞引擎和自动增量列的问题："></a>6、黑洞引擎和自动增量列的问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">主从架构数据库：1、主库黑洞表有一个自动增量字段是主键；2、从服务器有相同表引擎为myisam，3、主库执行insert，并隐式设置增量值。</span><br><span class="line">在这种情况下，主从复制将失败，</span><br><span class="line">如果主站有许多从站，则在发送到从站之前进行过滤可能会减少网络流量。</span><br><span class="line">在基于行的复制中，引擎为行返回的值对于每个插入始终是相同的。这将导致从服务器尝试使用主键列的相同值重播两个插入日志条目，因此复制将失败。</span><br></pre></td></tr></table></figure><h3 id="7、黑洞引擎和列过滤问题："><a href="#7、黑洞引擎和列过滤问题：" class="headerlink" title="7、黑洞引擎和列过滤问题："></a>7、黑洞引擎和列过滤问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">基于行的复制，从库支持表中缺少最后一列。</span><br><span class="line">从库端执行过滤，在执行过滤之前，先将数据传到从库，最少有两种情况不希望将列拷贝到从库：</span><br><span class="line">1、数据是机密的，从库没有权限访问它；</span><br><span class="line">2、主库有多个从库，在发送到从库之前执行过滤用于减少网络带宽</span><br></pre></td></tr></table></figure><p>官方文档提供的案例如下,对于受信任和不受信任从库的语句未找到合理解释，没看懂：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用BLACKHOLE引擎和 --replicate-do-table或 --replicate-ignore-table选项，可以实现主列过滤，</span><br><span class="line">主库配置：</span><br><span class="line">CREATE TABLE t1 (public_col_1, ..., public_col_N,</span><br><span class="line">                 secret_col_1, ..., secret_col_M) ENGINE=MyISAM;</span><br><span class="line">受信任的从库配置：</span><br><span class="line">CREATE TABLE t1 (public_col_1, ..., public_col_N) ENGINE=BLACKHOLE;</span><br><span class="line">不受信任的从库配置：</span><br><span class="line">CREATE TABLE t1 (public_col_1, ..., public_col_N) ENGINE=MyISAM;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Grafana] grafana监控redis、mongodb、mysql数据库</title>
      <link href="/2018/08/29/grafana+prometheus%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7mysql%E3%80%81redis%E3%80%81mongodb/"/>
      <url>/2018/08/29/grafana+prometheus%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7mysql%E3%80%81redis%E3%80%81mongodb/</url>
      <content type="html"><![CDATA[<h3 id="0、参考链接"><a href="#0、参考链接" class="headerlink" title="0、参考链接"></a>0、参考链接</h3><p><a href="https://mp.weixin.qq.com/s/Qz87UE1aXFZbAdFlx7Zeow" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Qz87UE1aXFZbAdFlx7Zeow</a></p><h3 id="1、grafana下载安装"><a href="#1、grafana下载安装" class="headerlink" title="1、grafana下载安装"></a>1、grafana下载安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.2.2-1.x86_64.rpm</span><br><span class="line">sudo yum localinstall grafana-5.2.2-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p>启动grafana<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service grafana-server start</span><br><span class="line">service grafana-server status</span><br></pre></td></tr></table></figure></p><p>加入开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add grafana-server</span><br></pre></td></tr></table></figure></p><p>查看grafana端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -plntu | grep grafana-serv</span><br><span class="line">tcp6       0      0 :::3000                 :::*                    LISTEN      2539/grafana-server</span><br></pre></td></tr></table></figure></p><p>登录web界面，localhost:3000<br>用户：admin<br>密码：admin（默认）<br>登录之后提示修改密码,登录界面如下图所示<br><img src="https://i.imgur.com/drKlMKC.png" alt=""></p><h3 id="2、安装Prometheus"><a href="#2、安装Prometheus" class="headerlink" title="2、安装Prometheus"></a>2、安装Prometheus</h3><p>下载Prometheus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.3.2/prometheus-2.3.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p><p>解压安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf prometheus-2.3.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p><p>配置 Prometheus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd prometheus-2.3.2.linux-amd64/</span><br><span class="line">cat prometheus.yml </span><br><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&apos;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;0.0.0.0:9090&apos;]</span><br></pre></td></tr></table></figure></p><p>启动prometheus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml</span><br><span class="line">----</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966212621Z caller=main.go:222 msg=&quot;Starting Prometheus&quot; version=&quot;(version=2.3.2, branch=HEAD, revision=71af5e29e815795e9dd14742ee7725682fa14b7b)&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966876421Z caller=main.go:223 build_context=&quot;(go=go1.10.3, user=root@5258e0bd9cc1, date=20180712-14:02:52)&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966953021Z caller=main.go:224 host_details=&quot;(Linux 3.10.0-693.21.1.el7.x86_64 #1 SMP Wed Mar 7 19:03:37 UTC 2018 x86_64 dax-mysql-mha (none))&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966990021Z caller=main.go:225 fd_limits=&quot;(soft=1024, hard=4096)&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.968101421Z caller=main.go:533 msg=&quot;Starting TSDB ...&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.970314221Z caller=web.go:415 component=web msg=&quot;Start listening for connections&quot; address=0.0.0.0:9090</span><br><span class="line">level=info ts=2018-08-28T03:42:08.977918922Z caller=main.go:543 msg=&quot;TSDB started&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.977966022Z caller=main.go:603 msg=&quot;Loading configuration file&quot; filename=prometheus.yml</span><br><span class="line">level=info ts=2018-08-28T03:42:08.979126022Z caller=main.go:629 msg=&quot;Completed loading of configuration file&quot; filename=prometheus.yml</span><br><span class="line">level=info ts=2018-08-28T03:42:08.979171222Z caller=main.go:502 msg=&quot;Server is ready to receive web requests.&quot;</span><br><span class="line">level=info ts=2018-08-28T05:00:04.558075427Z caller=compact.go:398 component=tsdb msg=&quot;write block&quot; mint=1535421600000 maxt=1535428800000 ulid=01CNZEEBGJ237RVH965D3VWT57</span><br><span class="line">level=info ts=2018-08-28T05:00:04.566214242Z caller=head.go:348 component=tsdb msg=&quot;head GC completed&quot; duration=1.539902ms</span><br><span class="line">level=info ts=2018-08-28T05:00:04.575381958Z caller=head.go:357 component=tsdb msg=&quot;WAL truncation completed&quot; duration=9.095816ms</span><br><span class="line">-----</span><br></pre></td></tr></table></figure></p><p>登录控制台 localhost:9090,登录界面如下：<br><img src="https://i.imgur.com/xMfoPTq.png" alt=""></p><h3 id="3、mysql-exporter部署"><a href="#3、mysql-exporter部署" class="headerlink" title="3、mysql_exporter部署"></a>3、mysql_exporter部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf mysqld_exporter-0.11.0.linux-amd64.tar.gz </span><br><span class="line">cd mysqld_exporter-0.11.0.linux-amd64/</span><br></pre></td></tr></table></figure><p>配置连接数据库文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat .my.cnf</span><br><span class="line">[client]</span><br><span class="line">host = 127.0.0.1</span><br><span class="line">user=root</span><br><span class="line">password=12345678</span><br></pre></td></tr></table></figure></p><p>启动mysqld_exporter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./mysqld_exporter --config.my-cnf=&quot;/data/soft/mysqld_exporter-0.11.0.linux-amd64/.my.cnf&quot;  </span><br><span class="line">----</span><br><span class="line">INFO[0000] Starting mysqld_exporter (version=0.11.0, branch=HEAD, revision=5d7179615695a61ecc3b5bf90a2a7c76a9592cdd)  source=&quot;mysqld_exporter.go:206&quot;</span><br><span class="line">INFO[0000] Build context (go=go1.10.3, user=root@3d3ff666b0e4, date=20180629-15:00:35)  source=&quot;mysqld_exporter.go:207&quot;</span><br><span class="line">INFO[0000] Enabled scrapers:                             source=&quot;mysqld_exporter.go:218&quot;</span><br><span class="line">INFO[0000]  --collect.global_status                      source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000]  --collect.global_variables                   source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000]  --collect.slave_status                       source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000]  --collect.info_schema.tables                 source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000] Listening on :9104                            source=&quot;mysqld_exporter.go:232&quot;</span><br><span class="line">----</span><br></pre></td></tr></table></figure></p><p>查看进程是否启动正常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp|grep 9104</span><br></pre></td></tr></table></figure></p><p>登录web界面,<a href="http://localhost:9104/" target="_blank" rel="noopener">http://localhost:9104/</a><br><img src="https://i.imgur.com/aqDGY1B.png" alt=""><br>修改vim prometheus.yml配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- job_name: mysql</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;127.0.0.1:9104&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: test</span><br></pre></td></tr></table></figure></p><p>备注:<br>job_name,当前执行job的名字<br>targets，连接的主机<br>instance，数据库实例的标签明</p><p>重新启动prometheus，进入prometheus控制台，点击status-&gt;target<br><img src="https://i.imgur.com/ecV2em3.png" alt=""></p><h3 id="4、添加数据源"><a href="#4、添加数据源" class="headerlink" title="4、添加数据源"></a>4、添加数据源</h3><p><img src="https://i.imgur.com/MDVSTgs.png" alt=""><br><img src="https://i.imgur.com/NCJXDQj.png" alt=""><br>保存测试</p><h3 id="5、下载仪表盘"><a href="#5、下载仪表盘" class="headerlink" title="5、下载仪表盘"></a>5、下载仪表盘</h3><p><a href="https://github.com/percona/grafana-dashboards/tree/master/dashboards">https://github.com/percona/grafana-dashboards/tree/master/dashboards</a><br>选择仪表盘类型，导入到grafana<br><img src="https://i.imgur.com/L0zhbuM.png" alt=""><br><img src="https://i.imgur.com/PkzRe5Y.png" alt=""><br><img src="https://i.imgur.com/1eYa7uN.png" alt=""><br>点击仪表盘查看<br><img src="https://i.imgur.com/i5qvt2u.png" alt=""></p><h3 id="6、mongodb-exporter部署用于监控mongodb"><a href="#6、mongodb-exporter部署用于监控mongodb" class="headerlink" title="6、mongodb_exporter部署用于监控mongodb"></a>6、mongodb_exporter部署用于监控mongodb</h3><p>prometheus监控mongodb数据库，安装之前需要配置go环境下载配置go环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.google.com/go/go1.11.linux-amd64.tar.gz</span><br><span class="line">tar -C /usr/local -xzf go1.11.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p><p>添加环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;</span><br><span class="line">GOPATH=$HOME/go</span><br><span class="line">export PATH=$PATH:$GOPATH/bin&quot; &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p>使配置的环境变量生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p>创建配置mognodb所需要的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/go/&#123;dir,src,pkg&#125;</span><br></pre></td></tr></table></figure></p><p>安装glide<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://glide.sh/get | sh</span><br></pre></td></tr></table></figure></p><p>安装mongodb-exporter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:dcu/mongodb_exporter.git $GOPATH/src/github.com/dcu/mongodb_exporter</span><br><span class="line">cd $GOPATH/src/github.com/dcu/mongodb_exporter</span><br><span class="line">make build</span><br></pre></td></tr></table></figure></p><p>查看mongdob_exporter使用的参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mongodb_exporter -h</span><br></pre></td></tr></table></figure></p><p>启动mongodb_exporter,获取数据库的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mongodb_exporter -mongodb.uri mongodb://localhost:30000</span><br></pre></td></tr></table></figure></p><p>启动端口默认为9001,登录<a href="http://localhost:9001，查看是否正常" target="_blank" rel="noopener">http://localhost:9001，查看是否正常</a><br><img src="https://i.imgur.com/1pnvKo4.png" alt=""><br>修改prometheus.yml，添加mongodb参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: mongodb</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&apos;127.0.0.1:9001&apos;]</span><br></pre></td></tr></table></figure></p><p>重启premetheus,登录premetheus控制台查看获取mognodb是否正常<br><img src="https://i.imgur.com/UK4EwiK.png" alt=""><br>登录grafana添加模板，可以添加模板id或者导入代码<br><img src="https://i.imgur.com/24JBVvP.png" alt=""><br>点击<a href="https://grafana.com/dashboards/2583" target="_blank" rel="noopener">链接</a>，跳转到mongodb_exporter模板<br>添加完成模板如下图所示：<br><img src="https://i.imgur.com/O0lRt1R.png" alt=""></p><h3 id="7、redis-exporter部署用于监控redis-安装redis-exporter模板"><a href="#7、redis-exporter部署用于监控redis-安装redis-exporter模板" class="headerlink" title="7、redis_exporter部署用于监控redis,安装redis-exporter模板"></a>7、redis_exporter部署用于监控redis,安装redis-exporter模板</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/oliver006/redis_exporter</span><br><span class="line">cd $GOPATH/src/github.com/oliver006/redis_exporter</span><br><span class="line">go build</span><br></pre></td></tr></table></figure><p>启动redis_exporter进程获取redis数据(默认进程端口号位9121)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis_exporter -redis.addr redis://127.0.0.1:6379 -redis.password test</span><br></pre></td></tr></table></figure></p><p>启动端口默认为9001,登录<a href="http://localhost:9121，查看是否正常" target="_blank" rel="noopener">http://localhost:9121，查看是否正常</a><br><img src="https://i.imgur.com/Xaokb9P.png" alt=""><br>修改prometheus.yml，添加redis参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: redis</span><br><span class="line">  static_configs:</span><br><span class="line">     - targets: [&apos;127.0.0.1:9121&apos;]</span><br></pre></td></tr></table></figure></p><p>重启premetheus,登录premetheus控制台查看获取redis是否正常<br><img src="https://i.imgur.com/FzmeelO.png" alt=""><br>登录grafana添加模板，可以添加模板id或者导入代码,点击<a href="https://github.com/oliver006/redis_exporter/blob/master/contrib/grafana_prometheus_redis_dashboard_alias.json">此处</a>跳转到redis_exporter链接<br>，导入完成之后界面如下图所示：<br><img src="https://i.imgur.com/4M5y84Y.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mongodb </tag>
            
            <tag> redis </tag>
            
            <tag> grafana </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] 解决zabbix中文乱码问题</title>
      <link href="/2018/08/28/%E8%A7%A3%E5%86%B3zabbix%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/"/>
      <url>/2018/08/28/%E8%A7%A3%E5%86%B3zabbix%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/</url>
      <content type="html"><![CDATA[<h3 id="1、在windows机器上查找simkai-ttf文件，在windows下拷贝simkai字体到zabbix-server端，并拷贝到相应目录"><a href="#1、在windows机器上查找simkai-ttf文件，在windows下拷贝simkai字体到zabbix-server端，并拷贝到相应目录" class="headerlink" title="1、在windows机器上查找simkai.ttf文件，在windows下拷贝simkai字体到zabbix server端，并拷贝到相应目录"></a>1、在windows机器上查找simkai.ttf文件，在windows下拷贝simkai字体到zabbix server端，并拷贝到相应目录</h3><p>可在c盘路径下搜索simkai.ttf，本地机器的路径为‘C:\Windows\WinSxS\amd64_microsoft-windows-font-truetype-simkai_31bf3856ad364e35_10.0.17134.1_none_d7e1e1a5de638405’，每台机器对应的目录会有差异，但‘C:\Windows\WinSxS’路径一致。</p><h3 id="2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下"><a href="#2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下" class="headerlink" title="2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下"></a>2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv simkai.ttf /data/nginx-1.9.15/html/zabbix/fonts/</span><br></pre></td></tr></table></figure><h3 id="3、修改nginx配置文件"><a href="#3、修改nginx配置文件" class="headerlink" title="3、修改nginx配置文件"></a>3、修改nginx配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/DejaVuSans/simkai/g&apos; /data/nginx-1.9.15/html/zabbix/include/defines.inc.php</span><br></pre></td></tr></table></figure><h3 id="4、重启php-fpm、nginx"><a href="#4、重启php-fpm、nginx" class="headerlink" title="4、重启php-fpm、nginx"></a>4、重启php-fpm、nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop</span><br><span class="line">service php-fpm stop</span><br><span class="line">service php-fpm start</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控磁盘io总吞吐量批量安装配置</title>
      <link href="/2018/08/27/zabbix%E7%9B%91%E6%8E%A7%E7%A3%81%E7%9B%98io%E6%80%BB%E5%90%9E%E5%90%90%E9%87%8F/"/>
      <url>/2018/08/27/zabbix%E7%9B%91%E6%8E%A7%E7%A3%81%E7%9B%98io%E6%80%BB%E5%90%9E%E5%90%90%E9%87%8F/</url>
      <content type="html"><![CDATA[<h2 id="0、编辑监控磁盘io总吞吐量脚本"><a href="#0、编辑监控磁盘io总吞吐量脚本" class="headerlink" title="0、编辑监控磁盘io总吞吐量脚本"></a>0、编辑监控磁盘io总吞吐量脚本</h2><p>cat /home/zabbix/disk_io_check.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">sudo bash</span><br><span class="line">#安装iostat命令</span><br><span class="line">yum install -y sysstat </span><br><span class="line">#创建监控目录及数据文件</span><br><span class="line">mkdir -p /usr/local/zabbix/script</span><br><span class="line">touch /usr/local/zabbix/script/iostat_data.txt</span><br><span class="line">chown zabbix.zabbix /usr/local/zabbix/script/iostat_data.txt</span><br><span class="line">chmod 777 /usr/local/zabbix/script/iostat_data.txt</span><br><span class="line">touch /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">chown zabbix.zabbix /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">chmod 777 /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">#编辑收集数据脚本</span><br><span class="line">echo &quot;</span><br><span class="line">#!/bin/bash</span><br><span class="line">iostat -dxkt 1 2|grep -E &apos;^sd|^xvda|^vd&apos; &gt; /usr/local/zabbix/script/iostat_data.txt&quot; &gt; /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">#添加到定时任务，每分钟收集一次</span><br><span class="line">echo &quot;* * * * * root sh /usr/local/zabbix/script/iostat_collect_data.sh&quot; &gt;&gt; /etc/crontab</span><br><span class="line">#添加参数到zabbix配置文件</span><br><span class="line">echo &quot;</span><br><span class="line">#每秒进行 merge 的读操作数目。即 rmerge/s</span><br><span class="line">UserParameter=disk.status.rmerge,cat /usr/local/zabbix/script/iostat_data.txt|tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$2&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos; </span><br><span class="line">#每秒进行 merge 的写操作数目。即 wmerge/s</span><br><span class="line">UserParameter=disk.status.wmerge,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$3&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒完成的读 I/O 设备次数。即 rio/s</span><br><span class="line">UserParameter=disk.status.rio,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$4&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒完成的写 I/O 设备次数。即 wio/s</span><br><span class="line">UserParameter=disk.status.wio,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$5&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。</span><br><span class="line">UserParameter=disk.status.rsect,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$6&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒写K字节数。是 wsect/s 的一半。</span><br><span class="line">UserParameter=disk.status.wsect,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$7&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O操作的数据大小 (扇区)。</span><br><span class="line">UserParameter=disk.status.sectsize,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$8&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均I/O队列长度。</span><br><span class="line">UserParameter=disk.status.queuelength,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$9&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O操作的等待时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.avgiowait,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$10&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O读操作的等待时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.avgreadiowait,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$11&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O写操作的等待时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.avgwriteiowait,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$12&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O操作的服务时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.svctm,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$13&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line"># 一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比</span><br><span class="line">UserParameter=disk.status.util,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$14&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">&quot; &gt; /usr/local/zabbix/etc/zabbix_agentd.conf.d/iostat_data.conf</span><br><span class="line">echo &quot;</span><br><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d</span><br><span class="line">&quot; &gt;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line">#重新启动zabbix_agent客户端</span><br><span class="line">/etc/init.d/zabbix_agentd restart</span><br><span class="line">#查看监控进程是否启动</span><br><span class="line">netstat -tunlp|grep 10050</span><br></pre></td></tr></table></figure></p><h2 id="1、如果需要批量安装，在ansible-server端配置批量上传脚本"><a href="#1、如果需要批量安装，在ansible-server端配置批量上传脚本" class="headerlink" title="1、如果需要批量安装，在ansible-server端配置批量上传脚本"></a>1、如果需要批量安装，在ansible-server端配置批量上传脚本</h2><p>cat /etc/ansible/scopy-diskio-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix-agent config to all hosts</span><br><span class="line">    copy: src=&quot;/home/zabbix/disk_io_check.sh&quot; dest=&quot;/home/zabbix/disk_io_check.sh&quot;</span><br></pre></td></tr></table></figure></p><p>执行批量上传脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-diskio-zabbix.sh</span><br></pre></td></tr></table></figure></p><p>执行脚本批量配置监控磁盘io总吞吐量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/execute-zabbix.sh&apos;</span><br></pre></td></tr></table></figure></p><h2 id="2、web端配置监控模板，亦可自行编译，点击此处下载"><a href="#2、web端配置监控模板，亦可自行编译，点击此处下载" class="headerlink" title="2、web端配置监控模板，亦可自行编译，点击此处下载"></a>2、web端配置监控模板，亦可自行编译，点击此处<a href="https://pan.baidu.com/s/1aJmOWwVpdPAaoBABQGiBig" target="_blank" rel="noopener">下载</a></h2>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix-agent批量安装配置</title>
      <link href="/2018/08/27/zabbix-agent%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85/"/>
      <url>/2018/08/27/zabbix-agent%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<h2 id="0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible"><a href="#0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible" class="headerlink" title="0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible"></a>0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure><h2 id="1、修改ansible-server端免交互登录"><a href="#1、修改ansible-server端免交互登录" class="headerlink" title="1、修改ansible-server端免交互登录"></a>1、修改ansible-server端免交互登录</h2><p>cat /etc/ssh/ssh_config<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StrictHostKeyChecking no</span><br><span class="line">UserKnownHostsFile /dev/null</span><br></pre></td></tr></table></figure></p><p>修改好配置后，重新启动sshd服务即可，命令为：/etc/init.d/sshd restart （或 service sshd restart 或/bin/systemctl restart  sshd.service）</p><h2 id="2、编辑-etc-ansible-hosts主机配置文件"><a href="#2、编辑-etc-ansible-hosts主机配置文件" class="headerlink" title="2、编辑/etc/ansible/hosts主机配置文件"></a>2、编辑/etc/ansible/hosts主机配置文件</h2><p>cat /etc/ansible/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[test]</span><br><span class="line">172.29.25.196   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos </span><br><span class="line">172.29.16.6   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos</span><br><span class="line">172.29.20.97   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos</span><br></pre></td></tr></table></figure></p><p>hosts文件使用参数详解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible_ssh_host   #用于指定被管理的主机的真实IP</span><br><span class="line">ansible_ssh_port   #用于指定连接到被管理主机的ssh端口号，默认是22</span><br><span class="line">ansible_ssh_user   #ssh连接时默认使用的用户名</span><br><span class="line">ansible_ssh_pass   #ssh连接时的密码</span><br><span class="line">ansible_sudo_pass  #使用sudo连接用户时的密码</span><br><span class="line">ansible_sudo_exec  #如果sudo命令不在默认路径，需要指定sudo命令路径 </span><br><span class="line">ansible_ssh_private_key_file #秘钥文件路径，秘钥文件如果不想使用ssh-agent管理时可以使用此选项 </span><br><span class="line">ansible_shell_type          #目标系统的shell的类型，默认sh </span><br><span class="line">ansible_connection         #SSH 连接的类型： local , ssh , paramiko，在 ansible 1.2 之前默认是 paramiko ，后来智能选择，优先使用基于 ControlPersist 的 ssh(支持的前提)</span><br><span class="line">ansible_python_interpreter  #用来指定python解释器的路径，默认为/usr/bin/python 同样可以指定ruby 、perl 的路径 </span><br><span class="line">ansible_*_interpreter     #其他解释器路径，用法和ansible_python_interpreter类似，这里&quot;*&quot;可以是ruby或才perl等其他语言</span><br></pre></td></tr></table></figure></p><p>上例中使用的是私钥和用户名，如果想要使用执行端口，密码，用户名可参考上面详解参数。</p><h2 id="3、编辑批量上传脚本"><a href="#3、编辑批量上传脚本" class="headerlink" title="3、编辑批量上传脚本"></a>3、编辑批量上传脚本</h2><p>cat /etc/ansible/scopy-test-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix to all hosts</span><br><span class="line">    copy: src=&quot;/root/zabbix-3.4.2.tar.gz&quot; dest=&quot;/home/centos/zabbix-3.4.2.tar.gz&quot;</span><br><span class="line">  - name: scopy zabbix-agent config to all hosts</span><br><span class="line">    copy: src=&quot;/home/centos/execute-zabbix.sh&quot; dest=&quot;/home/centos/execute-zabbix.sh&quot;</span><br></pre></td></tr></table></figure></p><p>src:代表本机的源文件，dest代表目标端的路径<br>hosts：要与/etc/ansible/hosts下的[test]保持一致。</p><p>execute-zabbix.sh脚本为安装zabbix-agent脚本<br>cat /home/centos/execute-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"> mkdir /home/zabbix</span><br><span class="line"> useradd -r -s /sbin/nologin zabbix</span><br><span class="line"> yum -y install gcc gcc-c++ pcre-devel openssl-devel</span><br><span class="line"> mv /home/centos/zabbix-3.4.2.tar.gz /home/zabbix/</span><br><span class="line">cd /home/zabbix</span><br><span class="line"> tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line"> /home/zabbix/zabbix-3.4.2/configure --prefix=/usr/local/zabbix --enable-agent  --with-openssl </span><br><span class="line"> make </span><br><span class="line"> make install</span><br><span class="line">#host1=`ifconfig eth0 |awk -F &apos;[ :]+&apos; &apos;NR==2 &#123;print $3&#125;&apos;`</span><br><span class="line">host1=`ip addr |grep dynamic |awk &apos;&#123;print $2&#125;&apos;|awk -F&apos;/&apos; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">echo &quot;LogFile=/tmp/zabbix_agentd.log</span><br><span class="line">Server=172.29.12.85</span><br><span class="line">ServerActive=172.29.12.85</span><br><span class="line">Hostname=$host1&quot;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line"></span><br><span class="line">cp /home/zabbix/zabbix-3.4.2/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/         </span><br><span class="line">ln -s /usr/local/zabbix/etc/zabbix_agentd.conf /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">sed -i &apos;s/BASEDIR=\/usr\/local/BASEDIR=\/usr\/local\/zabbix/g&apos; /etc/init.d/zabbix_agentd</span><br><span class="line">service zabbix_agentd start</span><br><span class="line">chkconfig --add zabbix_agentd</span><br><span class="line">chkconfig --level 35 zabbix_agentd on                                                  </span><br><span class="line">netstat -lnpt | grep zabbix_agent</span><br></pre></td></tr></table></figure></p><p>server端的ip地址根据自己的zabbix-proxy或者zabbix-server自行定义。</p><p>执行批量脚本将文件上传到目标端：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-test-zabbix.sh</span><br></pre></td></tr></table></figure></p><p>在ansible-server端执行批量安装脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/execute-zabbix.sh&apos;</span><br></pre></td></tr></table></figure></p><h2 id="4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端"><a href="#4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端" class="headerlink" title="4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端"></a>4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端</h2><p>编辑检查zabbix-agent进程脚本<br>cat /home/centos/check-zabbix-port.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">netstat -tunlp |grep 10050</span><br></pre></td></tr></table></figure></p><p>编辑批量上传脚本<br>cat /etc/ansible/scopy-test-check-zabbixport.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix-check-port to all hosts</span><br><span class="line">    copy: src=&quot;/home/centos/check-zabbix-port.sh&quot; dest=&quot;/home/centos/check-zabbix-port.sh&quot;</span><br></pre></td></tr></table></figure></p><p>执行批量上传脚本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-test-check-zabbixport.sh</span><br></pre></td></tr></table></figure></p><p>在ansible-server服务端执行检查脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/check-zabbix-port.sh&apos;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix-server安装配置</title>
      <link href="/2018/08/27/zabbix-server%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/08/27/zabbix-server%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包："><a href="#0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包：" class="headerlink" title="0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包："></a>0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall &quot;Development tools&quot;  </span><br><span class="line">yum -y install gcc gcc-c++ cmake autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers pcre-devel libaio</span><br></pre></td></tr></table></figure><h2 id="1、上传nginx软件包到服务器，如果没有可点击此处下载"><a href="#1、上传nginx软件包到服务器，如果没有可点击此处下载" class="headerlink" title="1、上传nginx软件包到服务器，如果没有可点击此处下载"></a>1、上传nginx软件包到服务器，如果没有可点击此处<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">下载</a></h2><p>创建nginx用户，创建nginx安装目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd nginx -s /sbin/nologin -M   </span><br><span class="line">mkdir /application</span><br></pre></td></tr></table></figure></p><p>解压安装包、编译安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.9.15.tar.gz</span><br><span class="line">cd nginx-1.9.15</span><br><span class="line">./configure --prefix=/application/nginx-1.9.15 --user=nginx --group=nginx --with-http_stub_status_module --with-http_ssl_module  </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>创建软链接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /application/nginx-1.9.15 /application/nginx</span><br></pre></td></tr></table></figure></p><p>检查语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/application/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure></p><p>启动nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/application/nginx/sbin/nginx</span><br></pre></td></tr></table></figure></p><p>查看进程是否正常启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp|grep nginx</span><br></pre></td></tr></table></figure></p><p>关闭nginx服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/application/nginx/sbin/nginx -s stop</span><br></pre></td></tr></table></figure></p><h2 id="2、Mysql数据库安装"><a href="#2、Mysql数据库安装" class="headerlink" title="2、Mysql数据库安装"></a>2、Mysql数据库安装</h2><p>下载mysql数据库(可自行下载自己喜欢的版本）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p><p>添加用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd mysql -s /sbin/nologin -M</span><br></pre></td></tr></table></figure></p><p>解压、重命名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz </span><br><span class="line">mv mysql-5.7.18-linux-glibc2.5-x86_64 /application/mysql</span><br></pre></td></tr></table></figure></p><p>改变权限权限、初始化,初始化过程中会默认生成随机密码，记录以便后面更改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql /application/mysql/ </span><br><span class="line">/application/mysql/bin/mysqld --initialize --user=mysql --basedir=/application/mysql/ --datadir=/application/mysql/data/</span><br><span class="line">/application/mysql/bin/mysql_ssl_rsa_setup --datadir=/application/mysql/data/</span><br></pre></td></tr></table></figure></p><p>修改配置文件<br>cat /application/mysql/support-files/my_default.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line">server_id = 1</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">basedir =/application/mysql/</span><br><span class="line">datadir =/application/mysql/data/</span><br><span class="line">character-set-server=utf8</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br></pre></td></tr></table></figure></p><p>配合mysql启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp my_default.cnf /etc/my.cnf</span><br><span class="line">cp mysql.server /etc/init.d/mysqld</span><br><span class="line">chmod 755 /etc/init.d/mysqld</span><br></pre></td></tr></table></figure></p><p>修改/etc/init.d/mysqld，文件数据和安装路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/application/mysql/data/</span><br></pre></td></tr></table></figure></p><p>启动mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p><p>修改mysql密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u  root -p</span><br><span class="line">set password=password(&apos;root&apos;);</span><br><span class="line">grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;root&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p><h2 id="3、安装php服务"><a href="#3、安装php服务" class="headerlink" title="3、安装php服务"></a>3、安装php服务</h2><p>安装依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zlib libxml2 libjpeg freetype libpng gd curl libiconv  zlib-devel libxml2-devel libjpeg-devel freetype-devel libpng-devel gd-devel curl-devel openssl-devel libxslt-devel libxslt*</span><br></pre></td></tr></table></figure></p><p>安装libiconv,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libiconv-1.14.tar.gz </span><br><span class="line">cd libiconv-1.14</span><br><span class="line">./configure --prefix=/usr/local/libiconv   </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">```   </span><br><span class="line">安装Libmcrypt,下载[链接](https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ)</span><br></pre></td></tr></table></figure></p><p>tar -zxvf libmcrypt-2.5.8.tar.gz<br>cd libmcrypt-2.5.8<br>./configure<br>make &amp;&amp; make install   </p><p>/sbin/ldconfig<br>cd libltdl/<br>./configure –enable-ltdl-install<br>make &amp;&amp; make install<br>cd ../../<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安装mhash,下载[链接](https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ)</span><br></pre></td></tr></table></figure></p><p>tar -zxvf mhash-0.9.9.9.tar.gz<br>cd mhash-0.9.9.9<br>./configure<br>make &amp;&amp; make install<br>cd ../<br>rm -f /usr/lib64/libmcrypt.<em><br>rm -f /usr/lib64/libmhash</em><br>ln -s /usr/local/lib/libmcrypt.la /usr/lib64/libmcrypt.la<br>ln -s /usr/local/lib/libmcrypt.so /usr/lib64/libmcrypt.so<br>ln -s /usr/local/lib/libmcrypt.so.4 /usr/lib64/libmcrypt.so.4<br>ln -s /usr/local/lib/libmcrypt.so.4.4.8 /usr/lib64/libmcrypt.so.4.4.8<br>ln -s /usr/local/lib/libmhash.a /usr/lib64/libmhash.a<br>ln -s /usr/local/lib/libmhash.la /usr/lib64/libmhash.la<br>ln -s /usr/local/lib/libmhash.so /usr/lib64/libmhash.so<br>ln -s /usr/local/lib/libmhash.so.2 /usr/lib64/libmhash.so.2<br>ln -s /usr/local/lib/libmhash.so.2.0.1 /usr/lib64/libmhash.so.2.0.1<br>ln -s /usr/local/lib/libmcrypt-config /usr/lib/libmcrypt-config<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安装mcrypt,下载[链接](https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ)</span><br></pre></td></tr></table></figure></p><p>tar -xf mcrypt-2.6.8.tar.gz<br>cd mcrypt-2.6.8/<br>/sbin/ldconfig<br>./configure LD_LIBRARY=/usr/local/lib &amp;&amp; make &amp;&amp;make install<br>cd ..<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安装php,下载[链接](https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ)</span><br></pre></td></tr></table></figure></p><p>tar -zxvf php-5.6.11.tar.gz<br>cd php-5.6.11<br>./configure –prefix=/application/php-5.6.11 –with-mysql=/application/mysql –with-iconv-dir=/usr/local/libiconv –with-freetype-dir –with-jpeg-dir –with-png-dir –with-zlib –with-libxml-dir=/usr –enable-xml –disable-rpath –enable-safe-mode –enable-bcmath –enable-shmop –enable-sysvsem –enable-inline-optimization–with-curl–with-curlwrappers –enable-mbregex –enable-fpm –enable-mbstring –with-mcrypt –with-gd –enable-gd-native-ttf –with-openssl –with-mhash –enable-pcntl –enable-sockets –with-xmlrpc–enable-zip –enable-soap –enable-short-tags –enable-zend-multibyte –enable-static –with-xsl –with-fpm-user=nginx –with-fpm-group=nginx –enable-ftp –enable-pdo–with-pdo-mysql<br>make &amp;&amp; make install<br>cd ..<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安装过程提示缺少lib包的问题，根据版本差异执行以下命令：</span><br></pre></td></tr></table></figure></p><p>ln -s /application/mysql/lib/libmysqlclient.so.18 /usr/lib64/<br>或者<br>ln -s /application/mysql/lib/libmysqlclient.so.20 /usr/lib64/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置文件（php.ini和php-fpm）</span><br></pre></td></tr></table></figure></p><p>ln -s /application/php-5.6.11 /application/php<br>cp ./php-5.6.11/php.ini-production /application/php/lib/php.ini<br>cat /application/php/etc/php-fpm.conf.default&gt;/application/php/etc/php-fpm.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">检查语法、启动</span><br></pre></td></tr></table></figure></p><p>/application/php/sbin/php-fpm -t<br>/application/php/sbin/php-fpm<br>cp /root/php-5.6.11/sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm<br>chmod a+x /etc/init.d/php-fpm</p><h1 id="加入开机启动"><a href="#加入开机启动" class="headerlink" title="加入开机启动"></a>加入开机启动</h1><p>chkconfig –add php-fpm<br>chkconfig –level 35 php-fpm on</p><h1 id="启动-php-fpm"><a href="#启动-php-fpm" class="headerlink" title="启动 php-fpm"></a>启动 php-fpm</h1><p>service php-fpm start<br>netstat -anpt | grep php-fpm</p><h1 id="停止-php-fpm"><a href="#停止-php-fpm" class="headerlink" title="停止 php-fpm"></a>停止 php-fpm</h1><p>service php-fpm stop<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## 4、配置nginx使其支持php</span><br><span class="line">cat /application/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure></p><p>server {<br>listen 80;<br>server_name localhost;</p><p>location / {<br>root html;<br>index index.php index.html index.htm;                               # 加入 index.php<br>}</p><p>error_page 500 502 503 504 /50x.html;<br>location = /50x.html {<br>root html;<br>}</p><p>location ~ .php$ { # 整段注释去掉<br>root html;<br>fastcgi_pass 127.0.0.1:9000;<br>fastcgi_index index.php;<br>fastcgi_param SCRIPT_FILENAME /application/nginx/html$fastcgi_script_name;                          # 修改为自己的根目录<br>include fastcgi_params;<br>}<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">创建测试页面</span><br><span class="line">```bash</span><br><span class="line">echo &quot;&lt;?php phpinfo(); ?&gt;&quot; &gt; /application/nginx/html/info.php</span><br></pre></td></tr></table></figure></p><p>重启 Nginx 、php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service php-fpm stop</span><br><span class="line">service php-fpm start</span><br><span class="line">/application/nginx/sbin/nginx -s stop</span><br><span class="line">/application/nginx/sbin/nginx</span><br></pre></td></tr></table></figure></p><p>浏览器访问测试页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost/info.php</span><br></pre></td></tr></table></figure></p><h2 id="5、安装zabbix-server，下载链接"><a href="#5、安装zabbix-server，下载链接" class="headerlink" title="5、安装zabbix-server，下载链接"></a>5、安装zabbix-server，下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a></h2><p>安装依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntpdate net-snmp net-snmp-devel libcurl-devel libevent-devel</span><br></pre></td></tr></table></figure></p><p>设置zabbix用户，编译安装zabbix<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2 --with-openssl  </span><br><span class="line"># --prefix  指定安装路径</span><br><span class="line"># --enable-server  安装 Server 端</span><br><span class="line"># --enable-agent  安装 Agent 端</span><br><span class="line"># --with-mysql  使用 Mysql 数据库</span><br><span class="line"># --with-net-snmp  支持 SNMP 协议</span><br><span class="line"># --with-libcurl  支持 libcurl URL 监控</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>mysql数据库添加zabbix初始化数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mysql -uroot -proot</span><br><span class="line">mysql&gt; create database zabbixDB character set utf8;                                    # 创建 zabbixDB 并设置编码为 utf8</span><br><span class="line">mysql&gt; grant all on zabbixDB.* to &apos;zabbix&apos;@&apos;%&apos; identified by &apos;zabbix&apos;;                 # 建立授权用户</span><br><span class="line">mysql&gt; flush privileges;                                                               # 刷新授权表 ( 虽然 grant 操作是不需要刷新授权表的，但那又如何 ? )</span><br><span class="line">mysql&gt; use zabbixDB;</span><br><span class="line">mysql&gt; source /root/zabbix-3.4.2/database/mysql/schema.sql                             # 导入数据</span><br><span class="line">mysql&gt; source /root/zabbix-3.4.2/database/mysql/images.sql</span><br><span class="line">mysql&gt; source /root/zabbix-3.4.2/database/mysql/data.sql</span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure></p><p>配置 Zabbix 服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 服务端启动脚本</span><br><span class="line">shell &gt; cp /root/zabbix-3.4.2/misc/init.d/fedora/core/zabbix_server /etc/init.d/</span><br><span class="line"># 客户端启动脚本</span><br><span class="line">shell &gt; cp /root/zabbix-3.4.2/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/</span><br><span class="line"># 网页文件</span><br><span class="line">shell &gt; cp -R /root/zabbix-3.4.2/frontends/php/ /data/nginx/html/zabbix </span><br><span class="line">```            </span><br><span class="line">服务端配置文件</span><br><span class="line">vim /usr/local/zabbix/etc/zabbix_server.conf</span><br></pre></td></tr></table></figure></p><p>LogFile=/tmp/zabbix_server.log  # 日志文件存放位置<br>DBName=zabbixDB                  # 数据库名<br>DBUser=zabbix                    # 连接用户<br>DBPassword=zabbix               # 连接密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务端启动脚本</span><br></pre></td></tr></table></figure></p><p>shell &gt; vim /etc/init.d/zabbix_server<br>BASEDIR=/usr/local/zabbix # 修改后的位置 ( 原：/usr/local )<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端启动脚本</span><br></pre></td></tr></table></figure></p><p>shell &gt;vim /etc/init.d/zabbix_agentd<br>BASEDIR=/usr/local/zabbix # 修改后的位置 ( 原：/usr/local )<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置zabbix开机启动，并启动Zabbix服务</span><br></pre></td></tr></table></figure></p><p>shell &gt; chkconfig –add zabbix_server<br>shell &gt; chkconfig –add zabbix_agentd<br>shell &gt; chkconfig –level 35 zabbix_server on<br>shell &gt; chkconfig –level 35 zabbix_agentd on<br>shell &gt; service zabbix_server start<br>Starting zabbix_server: [确定]<br>shell &gt; service zabbix_agentd start<br>Starting zabbix_agentd: [确定]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看进程启动是否正常</span><br></pre></td></tr></table></figure></p><p>shell &gt; netstat -anpt | grep zabbix ( 注意：要来确认一下到底有没有启动成功，因为当授权用户无法连接数据库时，zabbix_server 是无法启动的，但是启动过程显示成功 )<br>tcp        0      0 0.0.0.0:10050               0.0.0.0:<em>                   LISTEN      75399/zabbix_agentd<br>tcp        0      0 0.0.0.0:10051               0.0.0.0:</em>                   LISTEN      75321/zabbix_server </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 6、登陆网页进行配置 Zabbix ( http://your-domain/zabbix )（初始用户名密码为admin/zabbix）</span><br><span class="line"></span><br><span class="line">&gt; 第一个页面是欢迎页面，直接 Next</span><br><span class="line">&gt; 第二个页面大多会有多处检测失败，也是出问题最多的位置,修改php文件一下参数：</span><br><span class="line">vim /data/php-5.6.11/lib/php.ini</span><br></pre></td></tr></table></figure><p>post_max_size = 16M<br>max_execution_time = 300<br>max_input_time = 300<br>date.timezone = Asia/Shanghai<br>always_populate_raw_post_data = -1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据页面提示报错还需要修改以下配置：</span><br></pre></td></tr></table></figure></p><p>cd /root/php-5.6.11/ext/openssl/<br>cp  ./config0.m4 ./config.m4</p><p>#重新编译php，添加mysqli模块<br>cd /root/php-5.6.11/ext/mysqli<br>/data/php/bin/phpize<br>./configure –prefix=/data/mysqli –with-php-config=/data/php-5.6.11/bin/php-config –with-mysqli=/data/mysql/bin/mysql_config<br>make<br>make test<br>make install<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">配置完成后在php.ini下加入下来一行</span><br><span class="line">vim /data/php-5.6.11/lib/php.ini</span><br></pre></td></tr></table></figure></p><p>extension=mysqli.so<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">安装过程中的其他报错：</span><br></pre></td></tr></table></figure></p><p>fatal error: ext/mysqlnd/mysql_float_to_double.h: No such file or directory<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /root/php-5.6.11/ext/mysqli/mysqli_api.c</span><br></pre></td></tr></table></figure></p><p>把第36行的</p><p>#include “ext/mysqlnd/mysql_float_to_double.h”<br>修改为</p><p>#include “/root/php-5.6.11/ext/mysqlnd/mysql_float_to_double.h”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 7、zabbix-proxy代理端安装</span><br><span class="line">依赖包安装</span><br></pre></td></tr></table></figure></p><p>yum -y install ntpdate net-snmp net-snmp-devel libcurl-devel libevent-devel pcre-devel<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">添加zabbix用户，并编译安装zabbix-proxy</span><br></pre></td></tr></table></figure></p><p>useradd -r -s /sbin/nologin zabbix<br>tar -zxvf zabbix-3.4.2.tar.gz<br>cd zabbix-3.4.2<br>yum install pcre-devel<br>./configure –prefix=/usr/local/zabbix –enable-agent –enable-proxy –with-mysql   # –enable-agent 不是必须的 ( 如果不想监控 Proxy 的话 )<br>make &amp;&amp; make install<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制 Agent 启动脚本</span><br></pre></td></tr></table></figure></p><p>cp /usr/local/src/zabbix-2.4.5/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">修改 Zabbix 安装路径</span><br></pre></td></tr></table></figure></p><p>sed -i ‘s#BASEDIR=/usr/local#BASEDIR=/usr/local/zabbix#’ /etc/init.d/zabbix_agentd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">将proxy代理所需要的初始化数据导入到mysql数据库：</span><br></pre></td></tr></table></figure></p><p>mysql -u root -p<br>mysql&gt; create database proxydb character set utf8;                                            # 创建数据库<br>mysql&gt; grant all on proxydb.* to ‘proxy‘@’%’ identified by ‘proxydb’;                         # 创建授权用户<br>mysql&gt; flush privileges;                                                                      # 刷新授权表，虽然不需要~<br>mysql&gt; use proxydb;<br>mysql&gt; source /root/zabbix-3.4.2/database/mysql/schema.sql                                    # 导入数据，只导入这一个就可以了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">修改zabbix_proxy.conf配置文件</span><br></pre></td></tr></table></figure></p><p>[root@node1 ~]# grep -vP ‘^$|#’ /usr/local/zabbix/etc/zabbix_proxy.conf<br>ProxyMode=0<br>Server=192.168.197.135<br>ServerPort=10051<br>Hostname=node1<br>LogFile=/tmp/zabbix_proxy.log<br>DBHost=localhost<br>DBName=proxydb<br>DBUser=proxy<br>DBPassword=proxydb<br>ConfigFrequency=60<br>DataSenderFrequency=60<br>Timeout=4<br>LogSlowQueries=3000<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数详解：</span><br></pre></td></tr></table></figure></p><p>ProxyMode=0                    # 0 代表 Proxy 处于主动模式，即：Proxy 主动去请求 Zabbix Server 获取监控项；1 代表被动模式<br>Server=192.168.214.40          # Zabbix Server 地址，当 Proxy 处于被动模式时，不需要设置该项 ( 想想也能明白 )<br>ServerPort=10051              # Zabbix Server 监听端口，同上只在 Proxy 为主动模式时生效<br>Hostname=my_proxy              # 这个很重要啦，跟 Agent 的 Hostname 一样重要，待会要用<br>LogFile=/tmp/zabbix_proxy.log  # Proxy 日志文件位置<br>DBHost=localhost              # 连接哪里的数据库<br>DBName=proxydb                # 数据库名<br>DBUser=proxy                  # 连接用户<br>DBPassword=proxypass          # 用户密码<br>ConfigFrequency=60            # Proxy 向 Zabbix Server 请求监控项间隔，单位为 秒<br>DataSenderFrequency=60        # Proxy 向 Zabbix Server 发送监控数据间隔，单位为 秒<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启动 zabbix_proxy</span><br></pre></td></tr></table></figure></p><p> /usr/local/zabbix/sbin/zabbix_proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启动报错如下</span><br></pre></td></tr></table></figure></p><p>/usr/local/zabbix/sbin/zabbix_proxy: error while loading shared libraries: libmysqlclient.so.20: cannot open shared object file: No such file or directory<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">解决方法</span><br></pre></td></tr></table></figure></p><p>ln -s /application/mysql/lib/libmysqlclient.so.20 /usr/lib64/</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看是否启动成功：</span><br></pre></td></tr></table></figure><p>netstat -lnpt | grep zabbix_proxy<br>tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      80154/zabbix_proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加入开机启动</span><br></pre></td></tr></table></figure></p><p>echo “/usr/local/zabbix/sbin/zabbix_proxy” &gt;&gt; /etc/rc.local<br><code>`</code></p>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控cassandra数据库</title>
      <link href="/2018/08/27/zabbix%E7%9B%91%E6%8E%A7cassandra%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
      <url>/2018/08/27/zabbix%E7%9B%91%E6%8E%A7cassandra%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
      <content type="html"><![CDATA[<h2 id="1、安装java-gate-way-如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server-将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）："><a href="#1、安装java-gate-way-如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server-将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）：" class="headerlink" title="1、安装java_gate_way,如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server,将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）："></a>1、安装java_gate_way,如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server,将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">创建zabbix用户，安装依赖包：</span><br><span class="line">sudo bash</span><br><span class="line">mkdir /home/zabbix</span><br><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">yum -y install gcc gcc-c++ pcre-devel openssl-devel</span><br><span class="line">yum -y install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br><span class="line"></span><br><span class="line">上传zabbix安装包，并安装java-gate-way：</span><br><span class="line"> mv /data/download/zabbix-3.4.2.tar.gz /home/zabbix/</span><br><span class="line"> cd /home/zabbix/</span><br><span class="line">tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line">./configure --prefix=/data/zabbix --enable-java</span><br><span class="line">(如果zabbix-porxy或zabbix-server已安装，可指定一个新路径，gate-way与proxy、server并没有直接关系，可不必一起安装；如果都没有安装，为了管理方便，亦可放到同一目录）</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>安装完成之后，会在指定目录下存在以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ll /data/zabbix/sbin/zabbix_java/</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x. 2 root root   65 Aug 23 02:41 bin</span><br><span class="line">drwxr-xr-x. 2 root root  177 Aug 23 02:36 lib</span><br><span class="line">-rw-r--r--. 1 root root  791 Aug 23 02:36 settings.sh</span><br><span class="line">-rwxr-xr-x. 1 root root  545 Aug 23 02:36 shutdown.sh</span><br><span class="line">-rwxr-xr-x. 1 root root 2025 Aug 23 02:36 startup.sh</span><br></pre></td></tr></table></figure></p><p>包括启动脚本，关闭脚本，配置文件，依赖库，运行命令等文件。<br>启动java_gate_way：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./startup.sh</span><br></pre></td></tr></table></figure></p><h2 id="2、安装完成之后，修改zabbix-proxy-conf配置文件，添加以下参数："><a href="#2、安装完成之后，修改zabbix-proxy-conf配置文件，添加以下参数：" class="headerlink" title="2、安装完成之后，修改zabbix_proxy.conf配置文件，添加以下参数："></a>2、安装完成之后，修改zabbix_proxy.conf配置文件，添加以下参数：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaGateway=127.0.0.1</span><br><span class="line">JavaGatewayPort=10052</span><br><span class="line">StartJavaPollers=5</span><br></pre></td></tr></table></figure><p>默认端口为10052，因为zabbix-proxy与gate-way在同一台服务器上，因此使用127.0.0.1即可。必须指定java轮询器的预分叉实例数，默认情况下启动不会启动与jmx监控相关的进程。<br>修改完成之后重新启动zabbix-proxy服务，是修改参数生效。</p><h2 id="3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问"><a href="#3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问" class="headerlink" title="3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问"></a>3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问</h2><p>cat /etc/cassandra/conf/cassandra-env.sh |grep -v ‘^#’ |grep -v ‘^$’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">calculate_heap_sizes()</span><br><span class="line">&#123;</span><br><span class="line">    case &quot;`uname`&quot; in</span><br><span class="line">        Linux)</span><br><span class="line">            system_memory_in_mb=`free -m | awk &apos;/:/ &#123;print $2;exit&#125;&apos;`</span><br><span class="line">            system_cpu_cores=`egrep -c &apos;processor([[:space:]]+):.*&apos; /proc/cpuinfo`</span><br><span class="line">        ;;</span><br><span class="line">        FreeBSD)</span><br><span class="line">            system_memory_in_bytes=`sysctl hw.physmem | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            system_memory_in_mb=`expr $system_memory_in_bytes / 1024 / 1024`</span><br><span class="line">            system_cpu_cores=`sysctl hw.ncpu | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">        SunOS)</span><br><span class="line">            system_memory_in_mb=`prtconf | awk &apos;/Memory size:/ &#123;print $3&#125;&apos;`</span><br><span class="line">            system_cpu_cores=`psrinfo | wc -l`</span><br><span class="line">        ;;</span><br><span class="line">        Darwin)</span><br><span class="line">            system_memory_in_bytes=`sysctl hw.memsize | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            system_memory_in_mb=`expr $system_memory_in_bytes / 1024 / 1024`</span><br><span class="line">            system_cpu_cores=`sysctl hw.ncpu | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">        *)</span><br><span class="line">            # assume reasonable defaults for e.g. a modern desktop or</span><br><span class="line">            # cheap server</span><br><span class="line">            system_memory_in_mb=&quot;2048&quot;</span><br><span class="line">            system_cpu_cores=&quot;2&quot;</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">    # some systems like the raspberry pi don&apos;t report cores, use at least 1</span><br><span class="line">    if [ &quot;$system_cpu_cores&quot; -lt &quot;1&quot; ]</span><br><span class="line">    then</span><br><span class="line">        system_cpu_cores=&quot;1&quot;</span><br><span class="line">    fi</span><br><span class="line">    # set max heap size based on the following</span><br><span class="line">    # max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB))</span><br><span class="line">    # calculate 1/2 ram and cap to 1024MB</span><br><span class="line">    # calculate 1/4 ram and cap to 8192MB</span><br><span class="line">    # pick the max</span><br><span class="line">    half_system_memory_in_mb=`expr $system_memory_in_mb / 2`</span><br><span class="line">    quarter_system_memory_in_mb=`expr $half_system_memory_in_mb / 2`</span><br><span class="line">    if [ &quot;$half_system_memory_in_mb&quot; -gt &quot;1024&quot; ]</span><br><span class="line">    then</span><br><span class="line">        half_system_memory_in_mb=&quot;1024&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$quarter_system_memory_in_mb&quot; -gt &quot;8192&quot; ]</span><br><span class="line">    then</span><br><span class="line">        quarter_system_memory_in_mb=&quot;8192&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$half_system_memory_in_mb&quot; -gt &quot;$quarter_system_memory_in_mb&quot; ]</span><br><span class="line">    then</span><br><span class="line">        max_heap_size_in_mb=&quot;$half_system_memory_in_mb&quot;</span><br><span class="line">    else</span><br><span class="line">        max_heap_size_in_mb=&quot;$quarter_system_memory_in_mb&quot;</span><br><span class="line">    fi</span><br><span class="line">    MAX_HEAP_SIZE=&quot;$&#123;max_heap_size_in_mb&#125;M&quot;</span><br><span class="line">    # Young gen: min(max_sensible_per_modern_cpu_core * num_cores, 1/4 * heap size)</span><br><span class="line">    max_sensible_yg_per_core_in_mb=&quot;100&quot;</span><br><span class="line">    max_sensible_yg_in_mb=`expr $max_sensible_yg_per_core_in_mb &quot;*&quot; $system_cpu_cores`</span><br><span class="line">    desired_yg_in_mb=`expr $max_heap_size_in_mb / 4`</span><br><span class="line">    if [ &quot;$desired_yg_in_mb&quot; -gt &quot;$max_sensible_yg_in_mb&quot; ]</span><br><span class="line">    then</span><br><span class="line">        HEAP_NEWSIZE=&quot;$&#123;max_sensible_yg_in_mb&#125;M&quot;</span><br><span class="line">    else</span><br><span class="line">        HEAP_NEWSIZE=&quot;$&#123;desired_yg_in_mb&#125;M&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">java_ver_output=`&quot;$&#123;JAVA:-java&#125;&quot; -version 2&gt;&amp;1`</span><br><span class="line">jvmver=`echo &quot;$java_ver_output&quot; | grep &apos;[openjdk|java] version&apos; | awk -F&apos;&quot;&apos; &apos;NR==1 &#123;print $2&#125;&apos; | cut -d\- -f1`</span><br><span class="line">JVM_VERSION=$&#123;jvmver%_*&#125;</span><br><span class="line">JVM_PATCH_VERSION=$&#123;jvmver#*_&#125;</span><br><span class="line">if [ &quot;$JVM_VERSION&quot; \&lt; &quot;1.8&quot; ] ; then</span><br><span class="line">    echo &quot;Cassandra 3.0 and later require Java 8u40 or later.&quot;</span><br><span class="line">    exit 1;</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$JVM_VERSION&quot; \&lt; &quot;1.8&quot; ] &amp;&amp; [ &quot;$JVM_PATCH_VERSION&quot; -lt 40 ] ; then</span><br><span class="line">    echo &quot;Cassandra 3.0 and later require Java 8u40 or later.&quot;</span><br><span class="line">    exit 1;</span><br><span class="line">fi</span><br><span class="line">jvm=`echo &quot;$java_ver_output&quot; | grep -A 1 &apos;java version&apos; | awk &apos;NR==2 &#123;print $1&#125;&apos;`</span><br><span class="line">case &quot;$jvm&quot; in</span><br><span class="line">    OpenJDK)</span><br><span class="line">        JVM_VENDOR=OpenJDK</span><br><span class="line">        # this will be &quot;64-Bit&quot; or &quot;32-Bit&quot;</span><br><span class="line">        JVM_ARCH=`echo &quot;$java_ver_output&quot; | awk &apos;NR==3 &#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">    &quot;Java(TM)&quot;)</span><br><span class="line">        JVM_VENDOR=Oracle</span><br><span class="line">        # this will be &quot;64-Bit&quot; or &quot;32-Bit&quot;</span><br><span class="line">        JVM_ARCH=`echo &quot;$java_ver_output&quot; | awk &apos;NR==3 &#123;print $3&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        # Help fill in other JVM values</span><br><span class="line">        JVM_VENDOR=other</span><br><span class="line">        JVM_ARCH=unknown</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Xloggc:/var/log/cassandra/gc.log&quot;</span><br><span class="line">JVM_OPTS_FILE=$CASSANDRA_CONF/jvm.options</span><br><span class="line">for opt in `grep &quot;^-&quot; $JVM_OPTS_FILE`</span><br><span class="line">do</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS $opt&quot;</span><br><span class="line">done</span><br><span class="line">echo $JVM_OPTS | grep -q Xmn</span><br><span class="line">DEFINED_XMN=$?</span><br><span class="line">echo $JVM_OPTS | grep -q Xmx</span><br><span class="line">DEFINED_XMX=$?</span><br><span class="line">echo $JVM_OPTS | grep -q Xms</span><br><span class="line">DEFINED_XMS=$?</span><br><span class="line">echo $JVM_OPTS | grep -q UseConcMarkSweepGC</span><br><span class="line">USING_CMS=$?</span><br><span class="line">echo $JVM_OPTS | grep -q UseG1GC</span><br><span class="line">USING_G1=$?</span><br><span class="line">if [ &quot;x$MAX_HEAP_SIZE&quot; = &quot;x&quot; ] &amp;&amp; [ &quot;x$HEAP_NEWSIZE&quot; = &quot;x&quot; -o $USING_G1 -eq 0 ]; then</span><br><span class="line">    calculate_heap_sizes</span><br><span class="line">elif [ &quot;x$MAX_HEAP_SIZE&quot; = &quot;x&quot; ] ||  [ &quot;x$HEAP_NEWSIZE&quot; = &quot;x&quot; -a $USING_G1 -ne 0 ]; then</span><br><span class="line">    echo &quot;please set or unset MAX_HEAP_SIZE and HEAP_NEWSIZE in pairs when using CMS GC (see cassandra-env.sh)&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">if [ &quot;x$MALLOC_ARENA_MAX&quot; = &quot;x&quot; ] ; then</span><br><span class="line">    export MALLOC_ARENA_MAX=4</span><br><span class="line">fi</span><br><span class="line">if [ $DEFINED_XMX -ne 0 ] &amp;&amp; [ $DEFINED_XMS -ne 0 ]; then</span><br><span class="line">     JVM_OPTS=&quot;$JVM_OPTS -Xms$&#123;MAX_HEAP_SIZE&#125;&quot;</span><br><span class="line">     JVM_OPTS=&quot;$JVM_OPTS -Xmx$&#123;MAX_HEAP_SIZE&#125;&quot;</span><br><span class="line">elif [ $DEFINED_XMX -ne 0 ] || [ $DEFINED_XMS -ne 0 ]; then</span><br><span class="line">     echo &quot;Please set or unset -Xmx and -Xms flags in pairs on jvm.options file.&quot;</span><br><span class="line">     exit 1</span><br><span class="line">fi</span><br><span class="line">if [ $DEFINED_XMN -eq 0 ] &amp;&amp; [ $DEFINED_XMX -ne 0 ]; then</span><br><span class="line">    echo &quot;Please set or unset -Xmx and -Xmn flags in pairs on jvm.options file.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">elif [ $DEFINED_XMN -ne 0 ] &amp;&amp; [ $USING_CMS -eq 0 ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -Xmn$&#123;HEAP_NEWSIZE&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$JVM_ARCH&quot; = &quot;64-Bit&quot; ] &amp;&amp; [ $USING_CMS -eq 0 ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -XX:+UseCondCardMark&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -XX:CompileCommandFile=$CASSANDRA_CONF/hotspot_compiler&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -javaagent:$CASSANDRA_HOME/lib/jamm-0.3.0.jar&quot;</span><br><span class="line">if [ &quot;x$CASSANDRA_HEAPDUMP_DIR&quot; != &quot;x&quot; ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -XX:HeapDumpPath=$CASSANDRA_HEAPDUMP_DIR/cassandra-`date +%s`-pid$$.hprof&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_ON_OUT_OF_MEMORY_ERROR_OPT=&quot;-XX:OnOutOfMemoryError=kill -9 %p&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Djava.rmi.server.hostname=10.0.7.50&quot;</span><br><span class="line">if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span><br><span class="line">    LOCAL_JMX=no</span><br><span class="line">fi</span><br><span class="line">JMX_PORT=&quot;7199&quot;</span><br><span class="line">if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT&quot;</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">else</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.remote.port=$JMX_PORT&quot;</span><br><span class="line">  # if ssl is enabled the same port cannot be used for both jmx and rmi so either</span><br><span class="line">  # pick another value for this property or comment out to use a random port (though see CASSANDRA-7087 for origins)</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;</span><br><span class="line">  # turn on JMX authentication. See below for further options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">  # jmx ssl options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl=false&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.need.client.auth=true&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.enabled.protocols=&lt;enabled-protocols&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.enabled.cipher.suites=&lt;enabled-cipher-suites&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.keyStore=/path/to/keystore&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.keyStorePassword=&lt;keystore-password&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.trustStore=/path/to/truststore&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.trustStorePassword=&lt;truststore-password&gt;&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Djava.library.path=$CASSANDRA_HOME/lib/sigar-bin&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $MX4J_ADDRESS&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $MX4J_PORT&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $JVM_EXTRA_OPTS&quot;</span><br></pre></td></tr></table></figure></p><p>主要修改一下内容，默认LOCAL_JMX=yes<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span><br><span class="line">    LOCAL_JMX=no</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p><p>将true改为false,修改远程访问认证无需密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT&quot;</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">else</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.remote.port=$JMX_PORT&quot;</span><br><span class="line">  # if ssl is enabled the same port cannot be used for both jmx and rmi so either</span><br><span class="line">  # pick another value for this property or comment out to use a random port (though see CASSANDRA-7087 for origins)</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;</span><br><span class="line">  # turn on JMX authentication. See below for further options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br></pre></td></tr></table></figure></p><h2 id="4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下："><a href="#4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下：" class="headerlink" title="4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下："></a>4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下：</h2><p>cat /data/zabbix/sbin/zabbix_java/bin/zabbix_get_jmx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">if [ $# != 5 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;Usage: $0 &lt;JAVA_GATEWAY_HOST&gt; &lt;JAVA_GATEWAY_PORT&gt; &lt;JMX_SERVER&gt; &lt;JMX_PORT&gt; &lt;KEY&gt;&quot;</span><br><span class="line">        exit;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># create connection</span><br><span class="line">exec 3&lt;&gt;/dev/tcp/$1/$2</span><br><span class="line"></span><br><span class="line"># compose message</span><br><span class="line">MSG=&quot;&#123;\&quot;request\&quot;: \&quot;java gateway jmx\&quot;,\&quot;jmx_endpoint\&quot;:\&quot;service:jmx:rmi:///jndi/rmi://$3:$4/jmxrmi\&quot;,\&quot;keys\&quot;: [\&quot;$5\&quot;]&#125;&quot;</span><br><span class="line"># write message length as zero-padded 16-digit hexadecimal number</span><br><span class="line">printf -v LEN &apos;%016x&apos; &quot;$&#123;#MSG&#125;&quot;</span><br><span class="line"></span><br><span class="line"># prepare message length in little endian representation</span><br><span class="line">BYTES=&quot;&quot;</span><br><span class="line">for i in &#123;0..14..2&#125;</span><br><span class="line">do</span><br><span class="line">        BYTES=&quot;\\x$&#123;LEN:$i:2&#125;$BYTES&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># prepend protocol header and message length</span><br><span class="line">printf &quot;ZBXD\\1$BYTES%s&quot; &quot;$MSG&quot; &gt;&amp;3</span><br><span class="line"></span><br><span class="line"># output the result skipping 5 bytes of &quot;ZBXD\\1&quot; header and 8 bytes of message length</span><br><span class="line">tail -c+13 &lt;&amp;3</span><br></pre></td></tr></table></figure></p><p>该脚本可自行存放，没有规定，测试命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zabbix_get_jmx 127.0.0.1 10052 10.0.7.50 7199 &apos;jmx[\&quot;org.apache.cassandra.metrics:type=ThreadPools,path=internal,scope=MemtablePostFlush,name=ActiveTasks\&quot;,\&quot;Value\&quot;]&apos;</span><br></pre></td></tr></table></figure></p><p>127.0.0.1:为java-gate-way地址；<br>10052：为java-gate-way端口；<br>10.0.7.50：为被监控端的ip地址；<br>7199：为被监控端jmx的端口；<br>org.apache**:为要获取的参数，需要获取哪些参数可查看<a href="https://cassandra.apache.org/doc/latest/operating/metrics.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载"><a href="#5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载" class="headerlink" title="5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载"></a>5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击<a href="https://share.zabbix.com/databases/cassandradb/cassandra-cluster-template-jmx" target="_blank" rel="noopener">此处</a>，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处<a href="https://pan.baidu.com/s/1Yo-9-dP6QRRl0nu5u-icYw" target="_blank" rel="noopener">下载</a></h2>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> cassandra </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] centos7.2 服务器 使用df -h卡死问题</title>
      <link href="/2018/08/23/centos7.2%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8df%20-h%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/"/>
      <url>/2018/08/23/centos7.2%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8df%20-h%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="1、服务器使用df-h命令卡死，crtl-c没有反应，ps-ef-grep-df-命令杀掉df-h进程也无效。"><a href="#1、服务器使用df-h命令卡死，crtl-c没有反应，ps-ef-grep-df-命令杀掉df-h进程也无效。" class="headerlink" title="1、服务器使用df -h命令卡死，crtl+c没有反应，ps -ef|grep df 命令杀掉df -h进程也无效。"></a>1、服务器使用df -h命令卡死，crtl+c没有反应，ps -ef|grep df 命令杀掉df -h进程也无效。</h2><h2 id="2、重新启动会话，使用strace跟踪df-h执行状态"><a href="#2、重新启动会话，使用strace跟踪df-h执行状态" class="headerlink" title="2、重新启动会话，使用strace跟踪df -h执行状态"></a>2、重新启动会话，使用strace跟踪df -h执行状态</h2><p>strace df -h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/df&quot;, [&quot;df&quot;, &quot;-h&quot;], [/* 24 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77097000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=19527, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 19527, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77092000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0 \34\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2107816, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3932736, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efe76ab6000</span><br><span class="line">mprotect(0x7efe76c6c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7efe76e6c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b6000) = 0x7efe76e6c000</span><br><span class="line">mmap(0x7efe76e72000, 16960, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efe76e72000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77091000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe7708f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7efe7708f740) = 0</span><br><span class="line">mprotect(0x7efe76e6c000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x616000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7efe77098000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7efe77092000, 19527)           = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">brk(0x1ebd000)                          = 0x1ebd000</span><br><span class="line">brk(NULL)                               = 0x1ebd000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106065056, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106065056, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe7058f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2502, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=190751, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 190751, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77060000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/mtab&quot;, O_RDONLY|O_CLOEXEC)   = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;rootfs / rootfs rw 0 0\nsysfs /sy&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;ev,noexec,relatime,freezer 0 0\nc&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;sd rw,relatime 0 0\n&quot;, 1024)   = 19</span><br><span class="line">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/lib64/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26254, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26254, PROT_READ, MAP_SHARED, 3, 0) = 0x7efe77059000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/pts&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/sys/fs/binfmt_misc&quot;</span><br></pre></td></tr></table></figure></p><p>df -h进程在”/proc/sys/fs/binfmt_misc”这个位置卡主了</p><h2 id="3、启动另一个会话，重新挂在这个目录"><a href="#3、启动另一个会话，重新挂在这个目录" class="headerlink" title="3、启动另一个会话，重新挂在这个目录"></a>3、启动另一个会话，重新挂在这个目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart proc-sys-fs-binfmt_misc.automount</span><br></pre></td></tr></table></figure><h2 id="4、strace-df-h-跟踪的进程内容有新的输出，完整信息输出如下："><a href="#4、strace-df-h-跟踪的进程内容有新的输出，完整信息输出如下：" class="headerlink" title="4、strace df -h 跟踪的进程内容有新的输出，完整信息输出如下："></a>4、strace df -h 跟踪的进程内容有新的输出，完整信息输出如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/df&quot;, [&quot;df&quot;, &quot;-h&quot;], [/* 24 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77097000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=19527, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 19527, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77092000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0 \34\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2107816, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3932736, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efe76ab6000</span><br><span class="line">mprotect(0x7efe76c6c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7efe76e6c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b6000) = 0x7efe76e6c000</span><br><span class="line">mmap(0x7efe76e72000, 16960, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efe76e72000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77091000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe7708f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7efe7708f740) = 0</span><br><span class="line">mprotect(0x7efe76e6c000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x616000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7efe77098000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7efe77092000, 19527)           = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">brk(0x1ebd000)                          = 0x1ebd000</span><br><span class="line">brk(NULL)                               = 0x1ebd000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106065056, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106065056, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe7058f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2502, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=190751, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 190751, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77060000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/mtab&quot;, O_RDONLY|O_CLOEXEC)   = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;rootfs / rootfs rw 0 0\nsysfs /sy&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;ev,noexec,relatime,freezer 0 0\nc&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;sd rw,relatime 0 0\n&quot;, 1024)   = 19</span><br><span class="line">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/lib64/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26254, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26254, PROT_READ, MAP_SHARED, 3, 0) = 0x7efe77059000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/pts&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/sys/fs/binfmt_misc&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/hugepages&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/debug&quot;, &#123;st_mode=S_IFDIR|0700, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/mqueue&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/boot&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run/user/0&quot;, &#123;st_mode=S_IFDIR|0700, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/var/lib/nfs/rpc_pipefs&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/fs/nfsd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;xkey-boss01-8035-184&quot;, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/&quot;, &#123;f_type=0x58465342, f_bsize=4096, f_blocks=9293380, f_bfree=5378782, f_bavail=5378782, f_files=37191680, f_ffree=37150656, f_fsid=&#123;64768, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=494791, f_bfree=494791, f_bavail=494791, f_files=494791, f_ffree=494430, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/kernel/security&quot;, &#123;f_type=SECURITYFS_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev/shm&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=497337, f_bavail=497337, f_files=497337, f_ffree=497336, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/run&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=458142, f_bavail=458142, f_files=497337, f_ffree=496689, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=497337, f_bavail=497337, f_files=497337, f_ffree=497324, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RDONLY|ST_NOSUID|ST_NODEV|ST_NOEXEC&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/systemd&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/pstore&quot;, &#123;f_type=PSTOREFS_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/memory&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/freezer&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/devices&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/blkio&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/kernel/config&quot;, &#123;f_type=0x62656570, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev/hugepages&quot;, &#123;f_type=HUGETLBFS_MAGIC, f_bsize=2097152, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=2097152, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/dev/hugepages&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/boot&quot;, &#123;f_type=0x58465342, f_bsize=4096, f_blocks=127147, f_bfree=95769, f_bavail=95769, f_files=512000, f_ffree=511670, f_fsid=&#123;64513, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/boot&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/run/user/0&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=99468, f_bfree=99468, f_bavail=99468, f_files=497337, f_ffree=497336, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/run/user/0&quot;, &#123;st_mode=S_IFDIR|0700, st_size=40, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/proc/fs/nfsd&quot;, &#123;f_type=0x6e667364, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/proc/fs/nfsd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(136, 7), ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">write(1, &quot;\346\226\207\344\273\266\347\263\273\347\273\237                 \345\256\271&quot;..., 70文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">) = 70</span><br><span class="line">write(1, &quot;/dev/mapper/centos-root   36G   &quot;..., 50/dev/mapper/centos-root   36G   15G   21G   43% /</span><br><span class="line">) = 50</span><br><span class="line">write(1, &quot;devtmpfs                 1.9G   &quot;..., 53devtmpfs                 1.9G     0  1.9G    0% /dev</span><br><span class="line">) = 53</span><br><span class="line">write(1, &quot;tmpfs                    1.9G   &quot;..., 57tmpfs                    1.9G     0  1.9G    0% /dev/shm</span><br><span class="line">) = 57</span><br><span class="line">write(1, &quot;tmpfs                    1.9G  1&quot;..., 53tmpfs                    1.9G  154M  1.8G    8% /run</span><br><span class="line">) = 53</span><br><span class="line">write(1, &quot;tmpfs                    1.9G   &quot;..., 63tmpfs                    1.9G     0  1.9G    0% /sys/fs/cgroup</span><br><span class="line">) = 63</span><br><span class="line">write(1, &quot;/dev/vda1                497M  1&quot;..., 54/dev/vda1                497M  123M  375M   25% /boot</span><br><span class="line">) = 54</span><br><span class="line">write(1, &quot;tmpfs                    389M   &quot;..., 60tmpfs                    389M     0  389M    0% /run/user/0</span><br><span class="line">) = 60</span><br><span class="line">close(1)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure><h2 id="5、重新使用df-h命令，恢复正常。"><a href="#5、重新使用df-h命令，恢复正常。" class="headerlink" title="5、重新使用df -h命令，恢复正常。"></a>5、重新使用df -h命令，恢复正常。</h2>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] InnoDB：page_cleaner：1000ms intended loop took xxxms</title>
      <link href="/2018/08/21/InnoDB-page_cleaner-1000ms%20intended%20loop%20took%20xxxms/"/>
      <url>/2018/08/21/InnoDB-page_cleaner-1000ms%20intended%20loop%20took%20xxxms/</url>
      <content type="html"><![CDATA[<h2 id="1、在查看mysqllog日志的时候不经意间发现一条这个提示："><a href="#1、在查看mysqllog日志的时候不经意间发现一条这个提示：" class="headerlink" title="1、在查看mysqllog日志的时候不经意间发现一条这个提示："></a>1、在查看mysqllog日志的时候不经意间发现一条这个提示：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] InnoDB: page_cleaner: 1000ms intended loop took 16111ms. The settings might not be optimal. (flushed=7 and evicted=0, during the time.)</span><br></pre></td></tr></table></figure><p>造成该问题的主要原因：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">page_cleaner_thread:脏页清理线程负责将脏页从内存写到磁盘。</span><br><span class="line"></span><br><span class="line">出现该问题的原因：上面提示的信息的含义是,有大量脏页需要刷新，理论上应该在1s内完成，但实际却用了16s的时间将脏页刷新到磁盘，它接受脏页的数量远远大于它每秒能够处理脏页的能力，因此为了避免该问题，可降低每秒循环期间搜索脏页的深度（innodb_lru_scan_depth）。</span><br><span class="line"></span><br><span class="line">如果数据库存在很多的buffer pool instance 将会引起更多的刷新工作，因此如果只是增大 buffer pool instances 而没有降低lru_scan_depth,很可能会引起性能瓶颈。</span><br><span class="line"></span><br><span class="line">如果只是临时对数据库进行大量导入操作造成的这类问题,可以忽略这个问题不需关注。如果数据库一直存在大量更新操作，快速创建大量的脏页，该问题一直存在需要关注。</span><br></pre></td></tr></table></figure></p><p>下面是官方文档对lru_scan_depth参数的解释，中文为自己对官方文档的理解翻译，错误之处望大家指正。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A setting smaller than the default is generally suitable for most workloads. A value that is much higher than necessary may impact performance. Only consider increasing the value if you have spare I/O capacity under a typical workload. Conversely, if a write-intensive workload saturates your I/O capacity, decrease the value, especially in the case of a large buffer pool.</span><br><span class="line">When tuning innodb_lru_scan_depth, start with a low value and configure the setting upward with the goal of rarely seeing zero free pages. Also, consider adjusting innodb_lru_scan_depth when changing the number of buffer pool instances, since innodb_lru_scan_depth * innodb_buffer_pool_instances defines the amount of work performed by the page cleaner thread each second.</span><br><span class="line">比默认值小适合于大多数工作负载，如果设置比默认值大可能会影响性能。只有当有额外的磁盘io容量的时候才考虑需不需要增加该值。相反，如果在写密集度负载已经使io容量饱和，需要降低该值，尤其是buffer pool的值设置特别大的时候。</span><br><span class="line"></span><br><span class="line">如果lru_scan_depth值特别低，而且存在0空闲页，可以考虑调高该值。如果调整buffer pool instances时，需要考虑是否调整innodb_lru_scan_depth大小，因为innodb_lru_scan_depth * innodb_buffer_pool_instances决定了每秒page cleaner thread处理的工作量。</span><br></pre></td></tr></table></figure></p><h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL innodb_lru_scan_depth=256;</span><br></pre></td></tr></table></figure><p>该参数默认只为1024。<br>这只是数据库级别调整，出现该问题还需要查看服务器硬件问题，磁盘io是否达到瓶颈扥问题。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mgr集群节点主节点与两个从节点网络异常，造成的集群异常问题</title>
      <link href="/2018/08/20/mysql-mgr%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8E%E4%B8%A4%E4%B8%AA%E4%BB%8E%E8%8A%82%E7%82%B9%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%EF%BC%8C%E9%80%A0%E6%88%90%E7%9A%84%E9%9B%86%E7%BE%A4%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/"/>
      <url>/2018/08/20/mysql-mgr%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8E%E4%B8%A4%E4%B8%AA%E4%BB%8E%E8%8A%82%E7%82%B9%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%EF%BC%8C%E9%80%A0%E6%88%90%E7%9A%84%E9%9B%86%E7%BE%A4%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B-切换为主，报错如下："><a href="#1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B-切换为主，报错如下：" class="headerlink" title="1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B)切换为主，报错如下："></a>1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B)切换为主，报错如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-08-20T05:38:16.071653Z 0 [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-2:3306 has become unreachable.&apos;</span><br><span class="line">2018-08-20T05:38:16.071730Z 0 [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-3:3306 has become unreachable.&apos;</span><br><span class="line">2018-08-20T05:38:16.071744Z 0 [ERROR] Plugin group_replication reported: &apos;This server is not able to reach a majority of members in the group. This server will now block all updates. The server will remain blocked until contact with the majority is restored. It is possible to use group_replication_force_members to force a new group membership.&apos;</span><br></pre></td></tr></table></figure><h2 id="2、对故障节点A操作，使其重新加入集群"><a href="#2、对故障节点A操作，使其重新加入集群" class="headerlink" title="2、对故障节点A操作，使其重新加入集群"></a>2、对故障节点A操作，使其重新加入集群</h2><p>A节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p><p>查看报错日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2018-08-20T07:29:40.796952Z 12 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-08-20T07:29:40.803975Z 26 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-08-20T07:29:40.855935Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;wallet-mysql-2&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-08-20T07:29:40.906041Z 12 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 4/10&apos;</span><br><span class="line">2018-08-20T07:29:40.949597Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;wallet-mysql-3&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-08-20T07:29:41.001446Z 12 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e at wallet-mysql-3 port: 3306.&apos;</span><br><span class="line">2018-08-20T07:29:41.001738Z 29 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-08-20T07:29:41.005538Z 29 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@wallet-mysql-3:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-08-20T07:29:41.016839Z 30 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-08-20T07:29:41.028408Z 29 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-08-20T07:29:41.028442Z 29 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-08-20T07:29:41.028449Z 29 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-08-20T07:29:41.028493Z 12 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-08-20T07:29:41.028790Z 30 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-08-20T07:29:41.085012Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;wallet-mysql-3&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br></pre></td></tr></table></figure></p><p>出现该问题的原因是现在的新的主节点B，已经清除了binglog,A节点需要恢复的日志已经找不到了，因此需要对A进行数据恢复。</p><h2 id="3、在B节点mysqldump一份最新数据，命令如下："><a href="#3、在B节点mysqldump一份最新数据，命令如下：" class="headerlink" title="3、在B节点mysqldump一份最新数据，命令如下："></a>3、在B节点mysqldump一份最新数据，命令如下：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqldump --all-databases --<span class="built_in">set</span>-gtid-purged=ON --single-transaction -uroot -p***** &gt; /data/backup/all.sql</span><br></pre></td></tr></table></figure><h2 id="4、将dump的数据库拷贝到A节点，对节点A进行恢复："><a href="#4、将dump的数据库拷贝到A节点，对节点A进行恢复：" class="headerlink" title="4、将dump的数据库拷贝到A节点，对节点A进行恢复："></a>4、将dump的数据库拷贝到A节点，对节点A进行恢复：</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p******* &lt; /data/backup/all.sql</span><br></pre></td></tr></table></figure><p>执行提示报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</span><br></pre></td></tr></table></figure></p><p>解决方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">提示只有@@GLOBAL.GTID_EXECUTED为空是，才能设置@@GLOBAL.GTID_PURGED的值，清空GLOBAL.GTID_EXECUTED的值</span><br><span class="line">root@db 07:53:  [(none)]&gt; reset master;</span><br><span class="line">ERROR 3190 (HY000): RESET MASTER is not allowed because Group Replication is running.</span><br><span class="line">root@db 07:53:  [(none)]&gt; stop group_replication;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">root@db 07:53:  [(none)]&gt; reset master;</span><br><span class="line">Query OK, 0 rows affected (0.27 sec)</span><br><span class="line">如果数据库为只读的状态还需要将数据库改为读写模式：</span><br><span class="line">root@db 07:54:  [performance_schema]&gt; set global read_only=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="5、重新恢复数据"><a href="#5、重新恢复数据" class="headerlink" title="5、重新恢复数据"></a>5、重新恢复数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p******* &lt; /data/backup/all.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure><p>恢复完成</p><h2 id="6、重新将该节点加入集群"><a href="#6、重新将该节点加入集群" class="headerlink" title="6、重新将该节点加入集群"></a>6、重新将该节点加入集群</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">root@db 07:56:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">| group_replication_applier |           |             |        NULL | OFFLINE      |</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@db <span class="number">07</span>:<span class="number">56</span>:  [performance_schema]&gt; <span class="keyword">start</span> group_replication;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (3.03 sec)</span><br><span class="line">root@db 07:57:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">| group_replication_applier | *** | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-1 |        3306 | RECOVERING   |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>此时节点A正在与主节点同步数据，待同步完成之后再查看及节点之间的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:57:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>此时集群恢复完成。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控redis数据库</title>
      <link href="/2018/08/17/zabbix%E7%9B%91%E6%8E%A7redis/"/>
      <url>/2018/08/17/zabbix%E7%9B%91%E6%8E%A7redis/</url>
      <content type="html"><![CDATA[<h3 id="1、编写定期收集redis信息脚本，并指定到对应目录"><a href="#1、编写定期收集redis信息脚本，并指定到对应目录" class="headerlink" title="1、编写定期收集redis信息脚本，并指定到对应目录"></a>1、编写定期收集redis信息脚本，并指定到对应目录</h3><p>cat /usr/local/zabbix/script/redis_get_data.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件路径</span></span><br><span class="line">dbconfigfile=/data/redis/etc/redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">主机ip地址</span></span><br><span class="line">dbhost=`cat $&#123;dbconfigfile&#125; |grep bind|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">redis启动端口</span></span><br><span class="line">dbport=`cat $&#123;dbconfigfile&#125; |grep port|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">数据库命令路径</span></span><br><span class="line">dbcmdpath=/data/redis/src</span><br><span class="line"><span class="meta">#</span><span class="bash">数据库密码</span></span><br><span class="line">dbpass=`cat $&#123;dbconfigfile&#125; |grep requirepass|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">指定生成的<span class="built_in">log</span>路径</span></span><br><span class="line">dblogpath=/tmp/redis.log</span><br><span class="line"><span class="meta">#</span><span class="bash">如果有没密码，使用以下命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$&#123;dbcmdpath&#125;</span>/redis-cli -h <span class="variable">$&#123;dbhost&#125;</span> -a <span class="variable">$&#123;dbpass&#125;</span> -p <span class="variable">$&#123;dbport&#125;</span>  <span class="string">'info'</span> &gt; <span class="variable">$&#123;dblogpath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果没有密码，使用以下命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbcmdpath&#125;/redis-cli -h <span class="variable">$&#123;dbhost&#125;</span> -p <span class="variable">$&#123;dbport&#125;</span>  <span class="string">'info'</span> &gt; <span class="variable">$&#123;dblogpath&#125;</span></span></span><br></pre></td></tr></table></figure></p><p>修改redis配置文件目录，生成的log目录，修改完成之后授权脚本执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/redis_get_data.sh</span><br></pre></td></tr></table></figure></p><h3 id="2、将脚本添加到定时任务，每分钟执行一次"><a href="#2、将脚本添加到定时任务，每分钟执行一次" class="headerlink" title="2、将脚本添加到定时任务，每分钟执行一次"></a>2、将脚本添加到定时任务，每分钟执行一次</h3><p>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /usr/local/zabbix/script/redis_get_data.sh</span><br></pre></td></tr></table></figure></p><h3 id="3、编写zabbix监控项文件-通过-usr-local-zabbix-script-redis-get-data-sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值"><a href="#3、编写zabbix监控项文件-通过-usr-local-zabbix-script-redis-get-data-sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值" class="headerlink" title="3、编写zabbix监控项文件,通过/usr/local/zabbix/script/redis_get_data.sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值"></a>3、编写zabbix监控项文件,通过/usr/local/zabbix/script/redis_get_data.sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值</h3><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/redis_monitor_parameter.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#数据库进程是否存在</span><br><span class="line">UserParameter=redis_exist[*],ps -ef|grep redis-server|grep -v grep|wc -l</span><br><span class="line">#客户端连接数，包括从库的连接</span><br><span class="line">UserParameter=connected_clients[*],cat /tmp/redis.log |grep &apos;connected_clients&apos; |cut -d&apos;:&apos; -f2</span><br><span class="line">#当前客户端最长输出列表</span><br><span class="line">UserParameter=client_longest_output_list[*],cat /tmp/redis.log |grep client_longest_output_list |cut -d&apos;:&apos; -f2</span><br><span class="line">#当前客户端最大输入缓冲区</span><br><span class="line">UserParameter=client_biggest_input_buf[*],cat /tmp/redis.log |grep client_biggest_input_buf |cut -d&apos;:&apos; -f2</span><br><span class="line">#阻塞会话数</span><br><span class="line">UserParameter=blocked_clients[*],cat /tmp/redis.log |grep blocked_clients |cut -d&apos;:&apos; -f2</span><br><span class="line">#redis通过分配器分配的总内存</span><br><span class="line">UserParameter=used_memory[*],cat /tmp/redis.log |grep used_memory |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#操作系统通过top和ps命令查看到redis分配的内存</span><br><span class="line">UserParameter=used_memory_rss[*],cat /tmp/redis.log |grep used_memory_rss |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#redis消耗内存的峰值</span><br><span class="line">UserParameter=used_memory_peak[*],cat /tmp/redis.log |grep used_memory_peak |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#系统为管理内部数据架构造成的所有内存开销</span><br><span class="line">UserParameter=used_memory_overhead[*],cat /tmp/redis.log |grep used_memory_overhead |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#redis启动初始化消耗的内存</span><br><span class="line">UserParameter=used_memory_startup[*],cat /tmp/redis.log |grep used_memory_startup |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#数据集的大小（used_memory减去used_memory_overhead）</span><br><span class="line">UserParameter=used_memory_dataset[*],cat /tmp/redis.log |grep used_memory_dataset |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#数据集内存占净内存的百分比（used_memory_dataset/(used_memory-used_memory_startup))</span><br><span class="line">UserParameter=used_memory_dataset_perc[*],cat /tmp/redis.log |grep used_memory_dataset_perc |cut -d&apos;:&apos; -f2|head -1|cut -d&apos;%&apos; -f1</span><br><span class="line">#lua引擎使用的内存</span><br><span class="line">UserParameter=used_memory_lua[*],cat /tmp/redis.log |grep used_memory_lua |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#系统配置文件配置的内存</span><br><span class="line">UserParameter=maxmemory[*],cat /tmp/redis.log |grep maxmemory |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#内存碎片率（需要重点关注）远大于1过高说明内存碎片化严重，原小于1过低说明有大量内存交换，建议增加内存。</span><br><span class="line">UserParameter=mem_fragmentation_ratio[*],cat /tmp/redis.log |grep mem_fragmentation_ratio |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#自上次转存以来redis发生的更改数</span><br><span class="line">UserParameter=rdb_changes_since_last_save[*],cat /tmp/redis.log |grep rdb_changes_since_last_save |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端接受的总连接数</span><br><span class="line">UserParameter=total_connections_received[*],cat /tmp/redis.log |grep total_connections_received |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端处理命令总数</span><br><span class="line">UserParameter=total_commands_processed[*],cat /tmp/redis.log |grep total_commands_processed |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端每秒处理命令数</span><br><span class="line">UserParameter=instantaneous_ops_per_sec[*],cat /tmp/redis.log |grep instantaneous_ops_per_sec |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#网络读取的总流量</span><br><span class="line">UserParameter=total_net_input_bytes[*],cat /tmp/redis.log |grep total_net_input_bytes |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#网络写入的总流量</span><br><span class="line">UserParameter=total_net_output_bytes[*],cat /tmp/redis.log |grep total_net_output_bytes |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#每秒网络读的流量</span><br><span class="line">UserParameter=instantaneous_input_kbps[*],cat /tmp/redis.log |grep instantaneous_input_kbps |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#每秒网络写的流量</span><br><span class="line">UserParameter=instantaneous_output_kbps[*],cat /tmp/redis.log |grep instantaneous_output_kbps |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#因最大连接数达到上限，而被拒绝的连接数，maxclient默认值为10000</span><br><span class="line">UserParameter=rejected_connections[*],cat /tmp/redis.log |grep rejected_connections |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#键值到期总数</span><br><span class="line">UserParameter=expired_keys[*],cat /tmp/redis.log |grep expired_keys |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#因maxmemory限制，被驱逐的键值</span><br><span class="line">UserParameter=evicted_keys[*],cat /tmp/redis.log |grep evicted_keys |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#在主字典里面键值匹配成功的次数</span><br><span class="line">UserParameter=keyspace_hits[*],cat /tmp/redis.log |grep keyspace_hits |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#在主字典里面键值匹配失败的次数</span><br><span class="line">UserParameter=keyspace_misses[*],cat /tmp/redis.log |grep keyspace_misses |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#db0数据库键值的数量</span><br><span class="line">UserParameter=db0_keys[*], cat /tmp/redis.log |grep db0 |cat /tmp/redis.log |grep db0|cut -d &apos;,&apos; -f1|cut -d &apos;=&apos; -f2</span><br><span class="line">#db0数据库键值过期的数量</span><br><span class="line">UserParameter=db0_keys_expired[*],cat /tmp/redis.log |cat /tmp/redis.log |grep db0|cut -d &apos;,&apos; -f2|cut -d &apos;=&apos; -f2</span><br></pre></td></tr></table></figure><h3 id="4、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数："><a href="#4、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数：" class="headerlink" title="4、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数："></a>4、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span><br></pre></td></tr></table></figure><p>添加完成之后，需要重启zabbix_agent客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure></p><h3 id="5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载"><a href="#5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载" class="headerlink" title="5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载"></a>5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击<a href="https://pan.baidu.com/s/1dpWSBo-gZXk34aQNtjwqEw" target="_blank" rel="noopener">下载</a></h3>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[linux] suse_11_sp4安装samba-server</title>
      <link href="/2018/08/17/samba%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/08/17/samba%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="0、当前系统版本"><a href="#0、当前系统版本" class="headerlink" title="0、当前系统版本"></a>0、当前系统版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">Welcome to SUSE Linux Enterprise Server 11 SP4  (x86_64) - Kernel \r (\l).</span><br></pre></td></tr></table></figure><h2 id="1、查看samba是否安装"><a href="#1、查看samba是否安装" class="headerlink" title="1、查看samba是否安装"></a>1、查看samba是否安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # rpm -q samba</span><br><span class="line">samba-3.6.3-0.58.1</span><br></pre></td></tr></table></figure><p>如果没有安装，使用以下命令安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # zypper install samba</span><br></pre></td></tr></table></figure></p><h2 id="2、新建共享目录"><a href="#2、新建共享目录" class="headerlink" title="2、新建共享目录"></a>2、新建共享目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # mkdir -p /data/share</span><br></pre></td></tr></table></figure><h2 id="3、开始配置共享目录"><a href="#3、开始配置共享目录" class="headerlink" title="3、开始配置共享目录"></a>3、开始配置共享目录</h2><p>yast进入控制台,network services-samba server<br><img src="https://i.imgur.com/LZWt4Tz.png" alt=""><br>第一次启用samba server会做一些初始化，操作如下（也可根据自己需求自定义）：<br><img src="https://i.imgur.com/xFQrJwS.png" alt=""><br><img src="https://i.imgur.com/BUT6kUS.png" alt=""><br><img src="https://i.imgur.com/G06GBBG.png" alt=""><br>初始化完成之后，再一次进入samba server,会显示如下：<br><img src="https://i.imgur.com/P74w0YP.png" alt=""><br>点击add,开始新增共享目录<br><img src="https://i.imgur.com/e0OSaZ3.png" alt=""><br>修改完成之后保存，会显示新的share目录<br><img src="https://i.imgur.com/r0ueNn5.png" alt=""></p><h2 id="4、添加smbuser系统用户"><a href="#4、添加smbuser系统用户" class="headerlink" title="4、添加smbuser系统用户"></a>4、添加smbuser系统用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # useradd smbuser</span><br><span class="line">localhost:~ # passwd smbuser</span><br><span class="line">Changing password for smbuser.</span><br><span class="line">New Password: </span><br><span class="line">Bad password: too simple</span><br><span class="line">Reenter New Password: </span><br><span class="line">Password changed.</span><br></pre></td></tr></table></figure><h2 id="5、为samba服务添加访问用户，设置访问用的密码："><a href="#5、为samba服务添加访问用户，设置访问用的密码：" class="headerlink" title="5、为samba服务添加访问用户，设置访问用的密码："></a>5、为samba服务添加访问用户，设置访问用的密码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # smbpasswd -a smbuser</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user smbuser.</span><br></pre></td></tr></table></figure><h2 id="6、修改共享目录权限"><a href="#6、修改共享目录权限" class="headerlink" title="6、修改共享目录权限"></a>6、修改共享目录权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown smbuser /data/share</span><br><span class="line">chmod 777 /data/share</span><br></pre></td></tr></table></figure><p>**如果不修改目录权限，访问预览都是正常的，但是没有写权限，创建目录会报错</p><h2 id="7、修改配置配置文件-添加读写权限"><a href="#7、修改配置配置文件-添加读写权限" class="headerlink" title="7、修改配置配置文件,添加读写权限"></a>7、修改配置配置文件,添加读写权限</h2><p>vim /etc/samba/smb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[share]</span></span><br><span class="line">        <span class="string">comment</span> <span class="string">=</span> <span class="string">share</span></span><br><span class="line">        <span class="string">inherit</span> <span class="string">acls</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">        <span class="string">path</span> <span class="string">=</span> <span class="string">/data/share</span></span><br><span class="line">        <span class="string">read</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">No</span></span><br><span class="line">        <span class="string">Valid</span> <span class="string">users</span> <span class="string">=smbuser</span></span><br><span class="line">        <span class="string">Writable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">　      <span class="string">Browsable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br></pre></td></tr></table></figure></p><h2 id="8、重启samba服务器"><a href="#8、重启samba服务器" class="headerlink" title="8、重启samba服务器"></a>8、重启samba服务器</h2><p>/etc/rc.d/smb restart</p><h2 id="9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口"><a href="#9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口" class="headerlink" title="9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口"></a>9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口</h2><p>vim /etc/sysconfig/SuSEfirewall2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FW_SERVICES_EXT_TCP=&quot;22 1521 139 445&quot;</span><br></pre></td></tr></table></figure></p><p>重新启动防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rcSuSEfirewall2 restart</span><br></pre></td></tr></table></figure></p><h2 id="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："><a href="#10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：" class="headerlink" title="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："></a>10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：</h2><p><img src="https://i.imgur.com/XPOeklf.png" alt=""><br>因此修改sambaserver服务器端的协议，启用smbv2协议<br>vim /etc/samba/smb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">min protocol = SMB2</span><br><span class="line">max protocol = SMB2</span><br><span class="line">client min protocol = SMB2</span><br><span class="line">client max protocol = SMB2</span><br></pre></td></tr></table></figure></p><p>重启samba服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.d/smb restart</span><br></pre></td></tr></table></figure></p><h2 id="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"><a href="#11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误" class="headerlink" title="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"></a>11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -U smbuser //10.0.30.180/share -m smb2</span><br><span class="line">Unrecognised protocol level smb2</span><br><span class="line">WARNING: Ignoring invalid value &apos;SMB3&apos; for parameter &apos;max protocol&apos;</span><br><span class="line">Unknown parameter encountered: &quot;client min protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client min protocol&quot;</span><br><span class="line">Unknown parameter encountered: &quot;client max protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client max protocol&quot;</span><br></pre></td></tr></table></figure><p>该问题为suse 11版本的问题，默认只支持smbv1协议，suse12版本之后才开始支持smbv2.</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql lock table &amp;&amp; unlock tables实验</title>
      <link href="/2018/08/17/mysql%20lock%20table%20&amp;&amp;%20unlock%20tables%E5%AE%9E%E9%AA%8C/"/>
      <url>/2018/08/17/mysql%20lock%20table%20&amp;&amp;%20unlock%20tables%E5%AE%9E%E9%AA%8C/</url>
      <content type="html"><![CDATA[<h2 id="0、mysql版本"><a href="#0、mysql版本" class="headerlink" title="0、mysql版本"></a>0、mysql版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:12:  [aaaa]&gt; select @@version;</span><br><span class="line">+------------+</span><br><span class="line">| @@version  |</span><br><span class="line">+------------+</span><br><span class="line">| 5.7.22-log |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="1、创建实验表，内容如下："><a href="#1、创建实验表，内容如下：" class="headerlink" title="1、创建实验表，内容如下："></a>1、创建实验表，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:11:  [aaaa]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_aaaa |</span><br><span class="line">+----------------+</span><br><span class="line">| aaa            |</span><br><span class="line">| bbb            |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from bbb;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="2、开启两个会话，session1、session2-对表aaa进行read表锁"><a href="#2、开启两个会话，session1、session2-对表aaa进行read表锁" class="headerlink" title="2、开启两个会话，session1、session2,对表aaa进行read表锁"></a>2、开启两个会话，session1、session2,对表aaa进行read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:16:  [aaaa]&gt; lock table aaa read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:17:  [aaaa]&gt; </span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;aaa&apos; was locked with a READ lock and can&apos;t be updated</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:18:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:20:  [aaaa]&gt; show OPEN TABLES where In_use &gt; 0;</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| Database | Table | In_use | Name_locked |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| aaaa     | aaa   |      1 |           0 |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：在session1对表aaa进行read锁表，session1只能对表aaa进行读操作，对其他表没有任何操作权限，session2对表aaa有读权限，没有写权限。</p><h2 id="3、开启两个会话，session1、session2-对表aaa进行write表锁"><a href="#3、开启两个会话，session1、session2-对表aaa进行write表锁" class="headerlink" title="3、开启两个会话，session1、session2,对表aaa进行write表锁"></a>3、开启两个会话，session1、session2,对表aaa进行write表锁</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; lock table aaa write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:27:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">root@db 15:29:  [aaaa]&gt; update bbb set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:20:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:28:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:31:  [aaaa]&gt; unlock  tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：在session1对表aaa进行write锁表，session1对表aaa有读写权限，对其他表没有任何操作权限，session2对表aaa即没有读权限，又没有写权限。</p><h2 id="4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁"><a href="#4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁" class="headerlink" title="4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁"></a>4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:32:  [aaaa]&gt; lock table aaa write , aaa as t1 read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:32root@db 04:01:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:01:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:02:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;t1&apos; was locked with a READ lock and can&apos;t be updated</span><br><span class="line">root@db 04:04:  [aaaa]&gt; update aaa  set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa as t1;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;1&apos; for key &apos;PRIMARY&apos;</span><br></pre></td></tr></table></figure></p><p>session2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:05:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 04:06:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=2;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:07:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：session1对表aaa同时进行read，write锁，需要使用别名。对表进行select,update操作正常，如果使用insert into aaa select * from aaa as t1;需要加上别名。session 2对表aaa即没有读权限，又没有写权限。</p><h2 id="5、对表aaa进行read表锁，并使用别名"><a href="#5、对表aaa进行read表锁，并使用别名" class="headerlink" title="5、对表aaa进行read表锁，并使用别名"></a>5、对表aaa进行read表锁，并使用别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:47:  [aaaa]&gt;  LOCK TABLE aaa AS t1 READ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:48:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：session 1对表aaa加别名read表锁，session1查询需要使用别名，直接查询无效，session2对表aaa有读权限，无写权限</p><h2 id="6、对表aaa使用write表锁，并添加别名"><a href="#6、对表aaa使用write表锁，并添加别名" class="headerlink" title="6、对表aaa使用write表锁，并添加别名"></a>6、对表aaa使用write表锁，并添加别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:51:  [aaaa]&gt; LOCK TABLE aaa AS t1 write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; </span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:54:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：session 1对表aaa加别名write表锁，session1查询和更改需要使用别名，直接查询和更改无效，session2对表aaa无读权限，无写权限</p><p>##7、额外提示：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">LOCK</span> <span class="string">TABLES或者UNLOCK</span> <span class="string">TABLES，当应用于分区表时，始终锁定或解锁整个表;</span> <span class="string">这些语句不支持分区锁定修剪</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控mongodb数据库</title>
      <link href="/2018/08/15/zabbix%E7%9B%91%E6%8E%A7mongodb/"/>
      <url>/2018/08/15/zabbix%E7%9B%91%E6%8E%A7mongodb/</url>
      <content type="html"><![CDATA[<h2 id="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"><a href="#1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本" class="headerlink" title="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"></a>1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本</h2><p>mkdir -p /usr/local/zabbix/script<br>vim /usr/local/zabbix/script/zabbix_monitor_mongodb.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#mongodb管理员用户</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#mongodb管理员密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#Mongodb指定验证数据库</span></span><br><span class="line"><span class="string">authdb=admin</span></span><br><span class="line"><span class="comment">#mongodb指定端口</span></span><br><span class="line"><span class="string">dbport=30000</span></span><br><span class="line"><span class="comment">#mongodb安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongo</span> <span class="bullet">--port</span> <span class="string">$&#123;dbport&#125;</span> <span class="bullet">-u</span> <span class="string">$&#123;authuser&#125;</span> <span class="bullet">-p</span> <span class="string">$&#123;authpass&#125;</span> <span class="bullet">--authenticationDatabase</span> <span class="string">$&#123;authdb&#125;</span></span><br></pre></td></tr></table></figure></p><p>授权脚本执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/zabbix_monitor_mongodb.sh</span><br></pre></td></tr></table></figure></p><h2 id="2、修改zabbix监控项脚本，用于获取mongodb参数"><a href="#2、修改zabbix监控项脚本，用于获取mongodb参数" class="headerlink" title="2、修改zabbix监控项脚本，用于获取mongodb参数"></a>2、修改zabbix监控项脚本，用于获取mongodb参数</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/zabbix_mongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#当前连接数，包括当前的shell会话，副本集成员连接，mongos实例连接</span><br><span class="line">#(4.0version)connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前可用的连接数，数据库上的连接负载的值</span><br><span class="line">#(4.0version)connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#服务器所有的连接，包括已经关闭的连接</span><br><span class="line">#(4.0version)connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p|cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line"></span><br><span class="line">#因锁而造成排队等待的总数</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因读锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因写锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用内存情况</span><br><span class="line">#(4.0version)mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用虚拟内存的大小</span><br><span class="line">#(4.0version)mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#流入mongodb数据库的总量</span><br><span class="line">#(4.0version)network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库流出总量</span><br><span class="line">#(4.0version)network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1|cut -d &apos;&quot;&apos; -f2|cut -d &apos;&quot;&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库总请求数</span><br><span class="line">#(4.0version)network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前副本集状态，为1代表为主节点，为2代表为从节点</span><br><span class="line">#(4.0version)rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#页错误总数，当数据库性能不佳、内存限制、或者数据库较大会导致该值增加</span><br><span class="line">#(4.0version)extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br></pre></td></tr></table></figure></p><h2 id="3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件"><a href="#3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件" class="headerlink" title="3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件"></a>3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span></span><br></pre></td></tr></table></figure></p><h2 id="4、重新启动agent客户端"><a href="#4、重新启动agent客户端" class="headerlink" title="4、重新启动agent客户端"></a>4、重新启动agent客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure><h2 id="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"><a href="#5、通过zabbix-web端，添加配置模板，参考模板，点击下载" class="headerlink" title="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"></a>5、通过zabbix-web端，添加配置模板，参考模板，点击<a href="https://pan.baidu.com/s/1tpyzeOEFihpWge_IN-zDdw" target="_blank" rel="noopener">下载</a></h2>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控mysql数据库</title>
      <link href="/2018/08/14/zabbix%E7%9B%91%E6%8E%A7mysql/"/>
      <url>/2018/08/14/zabbix%E7%9B%91%E6%8E%A7mysql/</url>
      <content type="html"><![CDATA[<h3 id="1、编写定期收集mysql信息脚本，并指定到对应目录"><a href="#1、编写定期收集mysql信息脚本，并指定到对应目录" class="headerlink" title="1、编写定期收集mysql信息脚本，并指定到对应目录"></a>1、编写定期收集mysql信息脚本，并指定到对应目录</h3><p>cat /usr/local/zabbix/script/mysql_monitor.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">dbpath='/data/mysql/bin/mysql'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的用户</span></span><br><span class="line">dbuser='root'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的密码</span></span><br><span class="line">dbpass='123456'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的端口</span></span><br><span class="line">dbport='3306'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的socket文件</span></span><br><span class="line">dbsocket='/data/mysql/tmp/mysql.sock'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-status日志路径</span></span><br><span class="line">dbstatuspath=/tmp/mysql_status_monitor.log</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-engine-status日志路径</span></span><br><span class="line">dbenginestatuspath=/tmp/mysql_engine_innodb_status.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查询mysql-status信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbpath&#125; -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> -S<span class="variable">$&#123;dbsocket&#125;</span> -P<span class="variable">$&#123;dbport&#125;</span> -BNe <span class="string">"show global status;"</span> &gt; <span class="variable">$&#123;dbstatuspath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查询mysql-engine-innodb信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbpath&#125; -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> -S<span class="variable">$&#123;dbsocket&#125;</span> -P<span class="variable">$&#123;dbport&#125;</span> -BNe <span class="string">"show engine innodb status\G"</span> &gt; <span class="variable">$&#123;dbenginestatuspath&#125;</span></span></span><br></pre></td></tr></table></figure></p><p>根据自己的数据库配置，修改相应的参数，修改完成之后授权脚本执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/mysql_monitor.sh</span><br></pre></td></tr></table></figure></p><h3 id="2、将脚本添加到定时任务，每分钟执行一次"><a href="#2、将脚本添加到定时任务，每分钟执行一次" class="headerlink" title="2、将脚本添加到定时任务，每分钟执行一次"></a>2、将脚本添加到定时任务，每分钟执行一次</h3><p>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /usr/local/zabbix/script/mysql_monitor.sh</span><br></pre></td></tr></table></figure></p><h3 id="3、编写获取数据脚本，对定时生成的log文件进行信息筛选"><a href="#3、编写获取数据脚本，对定时生成的log文件进行信息筛选" class="headerlink" title="3、编写获取数据脚本，对定时生成的log文件进行信息筛选"></a>3、编写获取数据脚本，对定时生成的log文件进行信息筛选</h3><p>cat /usr/local/zabbix/script/mysql_get_data.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">dbpath='/data/mysql/bin/mysql'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的用户</span></span><br><span class="line">dbuser='root'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的密码</span></span><br><span class="line">dbpass='123456'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的端口</span></span><br><span class="line">dbport='3306'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的socket文件</span></span><br><span class="line">dbsocket='/data/mysql/tmp/mysql.sock'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-status日志路径</span></span><br><span class="line">dbstatuspath=/tmp/mysql_status_monitor.log</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-engine-status日志路径</span></span><br><span class="line">dbenginestatuspath=/tmp/mysql_engine_innodb_status.log</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">nodecount)</span><br><span class="line">       #查询集群节点存活状态</span><br><span class="line">       nodecount=`export MYSQL_PWD=$&#123;dbpass&#125;;$&#123;dbpath&#125; -u$&#123;dbuser&#125; -S$&#123;dbsocket&#125; -P$&#123;dbport&#125; -BNe "select count(*) from performance_schema.replication_group_members where MEMBER_STATE='ONLINE'"`</span><br><span class="line">       echo $&#123;nodecount&#125;</span><br><span class="line">       ;;</span><br><span class="line">uptime)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_select)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_select/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    com_insert)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_insert/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_update)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_update/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_delete)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_delete/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    connections)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Connections/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    thread_cached)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_cached/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    threads_connected)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_connected/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    thread_created)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_created/ &#123;print $2&#125;'            </span><br><span class="line">       ;;</span><br><span class="line">    Threads_running)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_running/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_immediate)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_immediate/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_waited)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_waited/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    slow_launch_threads)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Slow_launch_threads/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    slow_queries)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Slow_queries/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    qps)</span><br><span class="line">       uptime=`cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1`</span><br><span class="line">       questions=`cat /tmp/mysql_status_monitor.log | awk '/Questions/ &#123;print $2&#125;'`</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;questions&#125;/$&#123;uptime&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    tps)</span><br><span class="line">       uptime=`cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1`</span><br><span class="line">       com_commit=`cat /tmp/mysql_status_monitor.log | awk '/Com_commit/ &#123;print $2&#125;'`</span><br><span class="line">       com_rollback=`cat /tmp/mysql_status_monitor.log | awk '/Com_rollback/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       com_sum=$(($&#123;com_commit&#125;+$&#123;com_rollback&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;com_sum&#125;/$&#123;uptime&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    innodb_buffer_read_hits)</span><br><span class="line">       innodb_buffer_pool_reads=`cat /tmp/mysql_status_monitor.log | awk '/Innodb_buffer_pool_reads/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       innodb_buffer_pool_read_requests=`cat /tmp/mysql_status_monitor.log | awk '/Innodb_buffer_pool_read_requests/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       innodb_buffer_read_diff=$(($&#123;innodb_buffer_pool_read_requests&#125;-$&#123;innodb_buffer_pool_reads&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;innodb_buffer_read_diff&#125;/$&#123;innodb_buffer_pool_read_requests&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    table_cache_hit)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Opened_tables/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    thread_cache_hits)</span><br><span class="line">       thread_created=`cat /tmp/mysql_status_monitor.log | awk '/Threads_created/ &#123;print $2&#125;'`</span><br><span class="line">       connections=`cat /tmp/mysql_status_monitor.log | awk '/Connections/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       thread_cache_diff=$(($&#123;connections&#125;-$&#123;thread_created&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;thread_cache_diff&#125;/$&#123;connections&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    create_tmp_tables_hits)</span><br><span class="line">       created_tmp_tables=`cat /tmp/mysql_status_monitor.log | awk '/Created_tmp_tables/ &#123;print $2&#125;'`</span><br><span class="line">       created_tmp_disk_tables=`cat /tmp/mysql_status_monitor.log | awk '/Created_tmp_disk_tables/ &#123;print $2&#125;'`</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;created_tmp_disk_tables&#125;/$&#123;created_tmp_tables&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    binlog_cache_disk_use)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Binlog_cache_disk_use/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_immediate)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_immediate/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_waited)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_waited/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    innodb_row_lock_waits)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Innodb_row_lock_waits/ &#123;print $2&#125;'</span><br><span class="line">       ;;               </span><br><span class="line">    *)</span><br><span class="line">       ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></p><h3 id="4、编写zabbix监控项文件-通过-usr-local-zabbix-script-mysql-get-data-sh脚本去获取对应监控的数值"><a href="#4、编写zabbix监控项文件-通过-usr-local-zabbix-script-mysql-get-data-sh脚本去获取对应监控的数值" class="headerlink" title="4、编写zabbix监控项文件,通过/usr/local/zabbix/script/mysql_get_data.sh脚本去获取对应监控的数值"></a>4、编写zabbix监控项文件,通过/usr/local/zabbix/script/mysql_get_data.sh脚本去获取对应监控的数值</h3><p>cat /usr/local/zabbix/etc/zabbix_agentd.conf.d/mysql_monitor_parameter.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#集群节点数量</span><br><span class="line">UserParameter=nodecount[*],sh /usr/local/zabbix/script/mysql_get_data.sh nodecount</span><br><span class="line">#系统运行时间</span><br><span class="line">UserParameter=uptime[*],sh /usr/local/zabbix/script/mysql_get_data.sh uptime</span><br><span class="line">#查看select语句的执行数</span><br><span class="line">UserParameter=com_select[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_select</span><br><span class="line">#查看insert语句的执行数</span><br><span class="line">UserParameter=com_insert[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_insert</span><br><span class="line">#查看update语句的执行数</span><br><span class="line">UserParameter=com_update[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_update</span><br><span class="line">#查看delete语句的执行数</span><br><span class="line">UserParameter=com_delete[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_delete</span><br><span class="line">#查看试图连接到MySQL(不管是否连接成功)的连接数</span><br><span class="line">UserParameter=connections[*],sh /usr/local/zabbix/script/mysql_get_data.sh connections</span><br><span class="line">#查看线程缓存内的线程的数量</span><br><span class="line">UserParameter=thread_cached[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_cached</span><br><span class="line">#当线程打开连接数</span><br><span class="line">UserParameter=threads_connected[*],sh /usr/local/zabbix/script/mysql_get_data.sh threads_connected</span><br><span class="line">#查看创建用来处理连接的线程数。如果Threads_created较大，你可能要增加thread_cache_size值</span><br><span class="line">UserParameter=thread_created[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_created</span><br><span class="line">#查看激活的(非睡眠状态)线程数</span><br><span class="line">UserParameter=threads_running[*],sh /usr/local/zabbix/script/mysql_get_data.sh threads_running</span><br><span class="line">#查看创建时间超过slow_launch_time秒的线程数。</span><br><span class="line">UserParameter=slow_launch_threads[*],sh /usr/local/zabbix/script/mysql_get_data.sh slow_launch_threads</span><br><span class="line">#查看查询时间超过long_query_time秒的查询的个数。</span><br><span class="line">UserParameter=slow_queries[*],sh /usr/local/zabbix/script/mysql_get_data.sh slow_queries</span><br><span class="line">#在服务器上执行语句的数量，只包括客户端发送给服务器的语句，并不包括存储项目执行的语句</span><br><span class="line">UserParameter=qps[*],sh /usr/local/zabbix/script/mysql_get_data.sh qps</span><br><span class="line">#事物提交数量com_commit</span><br><span class="line">#事物回滚数量com_rollback</span><br><span class="line">UserParameter=tps[*],sh /usr/local/zabbix/script/mysql_get_data.sh tps</span><br><span class="line">#在buffer pool满足不了逻辑读的请求，而必须直接从硬盘读取的数量innodb_buffer_pool_reads</span><br><span class="line">#逻辑读的请求数innodb_buffer_pool_read_requests</span><br><span class="line">#buffer_read命中率</span><br><span class="line">UserParameter=innodb_buffer_read_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh innodb_buffer_read_hits</span><br><span class="line">#打开表的数量open_tables</span><br><span class="line">#已经打开表的数量opened_tables</span><br><span class="line">#table_cache命中率</span><br><span class="line">UserParameter=table_cache_hit[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_cache_hit</span><br><span class="line">#thread_cache命中率</span><br><span class="line">UserParameter=thread_cache_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_cache_hits</span><br><span class="line">#执行语句过程中创建的临时表created_tmp_tables</span><br><span class="line">#当创建的内部临时表过大，mysql会自动将表从内存中转换为磁盘上的表created_tmp_disk_tables</span><br><span class="line">#在磁盘上创建临时表的比例</span><br><span class="line">UserParameter=create_tmp_tables_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh create_tmp_tables_hits</span><br><span class="line">#事物使用binlog但是临时二进制日志超过binlog_cache_size，使用临时文件存储事物的语句，如果该值不为0，需要调整binlog_cache_size</span><br><span class="line">UserParameter=binlog_cache_disk_use[*],sh /usr/local/zabbix/script/mysql_get_data.sh binlog_cache_disk_use</span><br><span class="line">#可以立即授予表锁请求的次数</span><br><span class="line">UserParameter=table_locks_immediate[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_locks_immediate</span><br><span class="line">#一个表锁的请求不能立即被授予，需要等待的次数,如果该值过高，说明数据库有性能问题，应该优化sql语句，表分区或者读写分离</span><br><span class="line">UserParameter=table_locks_waited[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_locks_waited</span><br><span class="line">#操作innodb表等待行数的次数</span><br><span class="line">UserParameter=innodb_row_lock_waits[*],sh /usr/local/zabbix/script/mysql_get_data.sh innodb_row_lock_waits</span><br></pre></td></tr></table></figure></p><h3 id="5、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数："><a href="#5、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数：" class="headerlink" title="5、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数："></a>5、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span><br></pre></td></tr></table></figure><p>添加完成之后，需要重启zabbix_agent客户端</p><h3 id="6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载"><a href="#6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载" class="headerlink" title="6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载"></a>6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击<a href="https://pan.baidu.com/s/1UiMl8fPY57RKDauV8uvVBg" target="_blank" rel="noopener">下载</a></h3><h3 id="7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件-usr-local-zabbix-script-mysql-get-data-sh："><a href="#7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件-usr-local-zabbix-script-mysql-get-data-sh：" class="headerlink" title="7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件/usr/local/zabbix/script/mysql_get_data.sh："></a>7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件/usr/local/zabbix/script/mysql_get_data.sh：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">qps)</span><br><span class="line">   #uptime=`cat /tmp/mysql_status_monitor.log | awk &apos;/Uptime/ &#123;print $2&#125;&apos; |head -1`</span><br><span class="line">   #questions=`cat /tmp/mysql_status_monitor.log | awk &apos;/Questions/ &#123;print $2&#125;&apos;`</span><br><span class="line">   #echo $(printf &quot;%.2f&quot; `echo &quot;scale=2;$&#123;questions&#125;/$&#123;uptime&#125;&quot;|bc`)</span><br><span class="line">   cat /tmp/mysql_status_monitor.log | awk &apos;/Questions/ &#123;print $2&#125;&apos;</span><br><span class="line">   ;;</span><br><span class="line">tps)</span><br><span class="line">   #uptime=`cat /tmp/mysql_status_monitor.log | awk &apos;/Uptime/ &#123;print $2&#125;&apos; |head -1`</span><br><span class="line">   com_commit=`cat /tmp/mysql_status_monitor.log | awk &apos;/Com_commit/ &#123;print $2&#125;&apos;`</span><br><span class="line">   com_rollback=`cat /tmp/mysql_status_monitor.log | awk &apos;/Com_rollback/ &#123;print $2&#125;&apos;|head -1`</span><br><span class="line">   com_sum=$(($&#123;com_commit&#125;+$&#123;com_rollback&#125;))</span><br><span class="line">   echo $&#123;com_sum&#125;</span><br><span class="line">   #echo $(printf &quot;%.2f&quot; `echo &quot;scale=2;$&#123;com_sum&#125;/$&#123;uptime&#125;&quot;|bc`)</span><br><span class="line">   ;;</span><br></pre></td></tr></table></figure><p>修改zabbix模板监控项，将tps、qps的监控项下添加如下图所示进程：<br><img src="https://i.imgur.com/zKYZfAT.png" alt=""><br>亦可点击此处<a href="https://pan.baidu.com/s/1T0coFSphBlfpl3IZZTImbw" target="_blank" rel="noopener">下载</a>，获取该模板，并导入zabbix。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 去掉查询结果中带的mysql: [Warning] Using a password on the command line interface can be insecure</title>
      <link href="/2018/08/14/%E5%8E%BB%E6%8E%89%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E4%B8%AD%E5%B8%A6%E7%9A%84mysql%20%5BWarning%5D%20Using%20a%20password%20on%20the%20command%20line%20interface%20can%20be%20insecure/"/>
      <url>/2018/08/14/%E5%8E%BB%E6%8E%89%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E4%B8%AD%E5%B8%A6%E7%9A%84mysql%20%5BWarning%5D%20Using%20a%20password%20on%20the%20command%20line%20interface%20can%20be%20insecure/</url>
      <content type="html"><![CDATA[<h2 id="1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码-输出结果如下："><a href="#1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码-输出结果如下：" class="headerlink" title="1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码,输出结果如下："></a>1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码,输出结果如下：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678 -BNe "<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> performance_schema.replication_group_members <span class="keyword">where</span> MEMBER_STATE=<span class="string">'ONLINE'</span><span class="string">"</span></span><br></pre></td></tr></table></figure><p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">3</span><br></pre></td></tr></table></figure></p><h2 id="2、为了消除结果中的-Warning-信息，只显示查询结果，可使用环境变量存储密码的方法："><a href="#2、为了消除结果中的-Warning-信息，只显示查询结果，可使用环境变量存储密码的方法：" class="headerlink" title="2、为了消除结果中的[Warning]信息，只显示查询结果，可使用环境变量存储密码的方法："></a>2、为了消除结果中的[Warning]信息，只显示查询结果，可使用环境变量存储密码的方法：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export MYSQL_PWD=12345678;mysql -u root -BNe "<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> performance_schema.replication_group_members <span class="keyword">where</span> MEMBER_STATE=<span class="string">'ONLINE'</span><span class="string">"</span></span><br></pre></td></tr></table></figure><p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-innodb buffer pool size调整</title>
      <link href="/2018/08/14/mysql-innodb%20buffer%20pool%20size%E8%B0%83%E6%95%B4/"/>
      <url>/2018/08/14/mysql-innodb%20buffer%20pool%20size%E8%B0%83%E6%95%B4/</url>
      <content type="html"><![CDATA[<h2 id="1、查看当前数据库innodb-buffer-pool参数"><a href="#1、查看当前数据库innodb-buffer-pool参数" class="headerlink" title="1、查看当前数据库innodb_buffer_pool参数"></a>1、查看当前数据库innodb_buffer_pool参数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_buffer_pool_size'</span>;</span><br></pre></td></tr></table></figure><p>##2、查看page_size大小<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_page_size'</span>;</span><br></pre></td></tr></table></figure></p><p>官方文档参数详解<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_page_size</span></span><br><span class="line"><span class="string">InnoDB</span> <span class="string">page</span> <span class="string">size</span> <span class="string">(default</span> <span class="number">16</span><span class="string">KB).</span> <span class="string">Many</span> <span class="string">values</span> <span class="string">are</span> <span class="string">counted</span> <span class="string">in</span> <span class="string">pages;</span> <span class="string">the</span> <span class="string">page</span> <span class="string">size</span> <span class="string">enables</span> <span class="string">them</span> <span class="string">to</span> <span class="string">be</span></span><br><span class="line"><span class="string">easily</span> <span class="string">converted</span> <span class="string">to</span> <span class="string">bytes</span></span><br></pre></td></tr></table></figure></p><h2 id="3、查看当前内存innodb页的总数量和包含数据的页的数量"><a href="#3、查看当前内存innodb页的总数量和包含数据的页的数量" class="headerlink" title="3、查看当前内存innodb页的总数量和包含数据的页的数量"></a>3、查看当前内存innodb页的总数量和包含数据的页的数量</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_data'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_total'</span>;</span><br></pre></td></tr></table></figure><p>官方文档参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_buffer_pool_pages_data</span></span><br><span class="line"><span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pages</span> <span class="string">in</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool</span> <span class="string">containing</span> <span class="string">data.</span> <span class="string">The</span> <span class="string">number</span> <span class="string">includes</span> <span class="string">both</span> <span class="string">dirty</span> <span class="string">and</span></span><br><span class="line"><span class="string">clean</span> <span class="string">pages.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Innodb_buffer_pool_pages_total</span></span><br><span class="line"><span class="string">The</span> <span class="string">total</span> <span class="string">size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool,</span> <span class="string">in</span> <span class="string">pages.</span></span><br></pre></td></tr></table></figure></p><h2 id="4、调优参考计算方法："><a href="#4、调优参考计算方法：" class="headerlink" title="4、调优参考计算方法："></a>4、调优参考计算方法：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val = Innodb_buffer_pool_pages_data / Innodb_buffer_pool_pages_total * 100%</span><br><span class="line">val &gt; 95% 则考虑增大 innodb_buffer_pool_size， 建议使用物理内存的75%</span><br><span class="line">val &lt; 95% 则考虑减小 innodb_buffer_pool_size， 建议设置为：Innodb_buffer_pool_pages_data * Innodb_page_size * 1.05 / (1024*1024*1024)</span><br></pre></td></tr></table></figure><h2 id="5、设置innodb-buffer-pool-siz大小"><a href="#5、设置innodb-buffer-pool-siz大小" class="headerlink" title="5、设置innodb_buffer_pool_siz大小"></a>5、设置innodb_buffer_pool_siz大小</h2><p>设置命令：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> innodb_buffer_pool_size = <span class="number">17179869184</span>;</span><br></pre></td></tr></table></figure></p><p>缓冲池字节大小，单位kb，如果不设置，默认为128M<br>5.7版本以后可以动态修改参数，但是也要修改配置文件参数，防止重启之后，参数又变成配置文件内的参数,5.7以下的版本为静态参数，需要修改配置文件，并重新启动mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/my.cnf</span><br><span class="line">---------</span><br><span class="line">innodb_buffer_pool_size = 17179869184  #设置16G</span><br><span class="line">---------</span><br></pre></td></tr></table></figure></p><h2 id="6、配置参数也可使用M、G等参数，内容如下："><a href="#6、配置参数也可使用M、G等参数，内容如下：" class="headerlink" title="6、配置参数也可使用M、G等参数，内容如下："></a>6、配置参数也可使用M、G等参数，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf：</span><br><span class="line">-------------------</span><br><span class="line">innodb_buffer_pool_size = 16G  #设置16G</span><br><span class="line">innodb_buffer_pool_size = 500M  #设置500M</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb4.0定时备份并邮件告知备份情况</title>
      <link href="/2018/08/12/mongodb4.0%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%B9%B6%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/"/>
      <url>/2018/08/12/mongodb4.0%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%B9%B6%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/</url>
      <content type="html"><![CDATA[<h2 id="1、mongodb全量备份脚本，内容如下："><a href="#1、mongodb全量备份脚本，内容如下：" class="headerlink" title="1、mongodb全量备份脚本，内容如下："></a>1、mongodb全量备份脚本，内容如下：</h2><p>cat /data/soft/mongodb_backup.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#认证用户名</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#认证用户对应密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#备份的服务器地址</span></span><br><span class="line"><span class="string">servername=testrepl/127.0.0.1:30000</span></span><br><span class="line"><span class="comment">#备份的数据库实例名称</span></span><br><span class="line"><span class="string">instancename=test</span></span><br><span class="line"><span class="comment">#认证数据库实例名称</span></span><br><span class="line"><span class="string">authdbname=admin</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line"><span class="string">stamp=`date</span> <span class="string">+"%Y-%m-%d"`</span></span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line"><span class="string">programname=bulingbuling</span></span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line"><span class="string">backuppath=/data/backup</span></span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line"><span class="string">backname=$&#123;backuppath&#125;/$&#123;instancename&#125;</span></span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line"><span class="string">oldstamp=`date</span> <span class="string">+"%Y-%m-%d"</span> <span class="bullet">-d</span> <span class="string">"-5 day"</span><span class="string">`</span></span><br><span class="line"><span class="string">oldbackname=$&#123;backname&#125;-$&#123;oldstamp&#125;.dump</span></span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line"><span class="string">backuplogname=/tmp/mongodb_bakcup_$&#123;stamp&#125;.log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line"><span class="string">localname=`hostname`</span></span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line"><span class="string">localip=`ip</span> <span class="string">a</span> <span class="string">|grep</span> <span class="string">global|</span> <span class="string">head</span> <span class="bullet">-1</span><span class="string">| awk '&#123;print $2&#125;'|awk -F'/' '&#123;print $1&#125;'`</span></span><br><span class="line"><span class="string">#localip='65.52.165.104'</span></span><br><span class="line"><span class="string">#目标邮箱</span></span><br><span class="line"><span class="string">dest_mail='test@qq.com'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="string">if [ -e $&#123;backuplogname&#125; ];then</span></span><br><span class="line"><span class="string">   sudo rm -rf $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">   :</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="string">send_fail_mail()&#123;</span></span><br><span class="line"><span class="string">echo "$&#123;programname&#125;备份失败,登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看报错！！！" |mail -s $&#123;programname&#125;数据库备份情况 $&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="string">send_success_mail()&#123;</span></span><br><span class="line"><span class="string">echo "$&#123;programname&#125;备份成功,可登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看备份信息。" |mail -s $&#123;programname&#125;数据库备份情况 $&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建备份时间函数</span></span><br><span class="line"><span class="string">date_func()&#123;</span></span><br><span class="line"><span class="string">   dateresult=$(($&#123;afterstamp&#125;-$&#123;beforstamp&#125;))</span></span><br><span class="line"><span class="string">   hour=$(($&#123;dateresult&#125;/3600))</span></span><br><span class="line"><span class="string">   min=$((($&#123;dateresult&#125;-$&#123;hour&#125;*3600)/60))</span></span><br><span class="line"><span class="string">   sec=$(($&#123;dateresult&#125;-$&#123;hour&#125;*3600-$&#123;min&#125;*60))</span></span><br><span class="line"><span class="string">   echo "6、本次备份运行时间为:"$&#123;hour&#125;时$&#123;min&#125;分$&#123;sec&#125;秒 &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="string">del_old_bakdata()&#123;</span></span><br><span class="line"><span class="string">   if [ -e $&#123;oldbackname&#125; ];then</span></span><br><span class="line"><span class="string">    sudo echo "7、五天前的备份数据$&#123;oldbackname&#125;存在，进行删除"  &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    rm -rf $&#123;oldbackname&#125;</span></span><br><span class="line"><span class="string">    if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    sudo echo "7.1、备份数据删除成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">    sudo echo "7.1、备份数据删除失败，注意查看失败原因" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">   else</span></span><br><span class="line"><span class="string">     sudo echo "7、五天前的备份数据$&#123;oldbackname&#125;不存在，不需要再删除。" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   fi </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#因为mongodbdump只能指定路径，不能自定义备份文件名称，因此需要对备份完成的目录重命名</span></span><br><span class="line"><span class="string">rename_backname_func()&#123;</span></span><br><span class="line"><span class="string">if [ -e $&#123;backname&#125;-$&#123;stamp&#125; ];then</span></span><br><span class="line"><span class="string">  mv $&#123;backname&#125;-$&#123;stamp&#125; $&#123;backname&#125;-$&#123;stamp&#125;-old</span></span><br><span class="line"><span class="string">  mv $&#123;backname&#125; $&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line"><span class="string">  if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名失败,查看命名失败原因！" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">  mv $&#123;backname&#125; $&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line"><span class="string">  if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名失败,查看命名失败原因！" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="string">if [ -d $&#123;backuppath&#125; ];then</span></span><br><span class="line"><span class="string">sudo echo "1、备份目录存在,可执行备份操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">sudo echo "1、备份目录不存在,手动创建" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">sudo mkdir -p $&#123;backuppath&#125;</span></span><br><span class="line"><span class="string">if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">   sudo echo "1.1、备份目录创建成功，可进行下面操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">   sudo echo "1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   exit</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="string">if [ -d $&#123;backname&#125; ];then</span></span><br><span class="line"><span class="string">sudo echo "2、指定的备份实例目录$&#123;backname&#125;已存在，对其进行重命名" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    mv $&#123;backname&#125; $&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump</span></span><br><span class="line"><span class="string">    if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    sudo echo "2.1、文件已重新命名为$&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump,可继续备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">    sudo echo "2.1、文件重命名失败，退出备份操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    exit</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">sudo echo "2、指定的备份文件不存在，开始进行备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前时间戳</span></span><br><span class="line"><span class="string">beforstamp=`date +%s`</span></span><br><span class="line"><span class="string">#开始全量备份数据库</span></span><br><span class="line"><span class="string">sudo echo "3、开始全量备份数据库" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongodump -h $&#123;servername&#125; -u $&#123;authuser&#125; -p $&#123;authpass&#125; -d $&#123;instancename&#125; -o $&#123;backuppath&#125; --authenticationDatabase $&#123;authdbname&#125;</span></span><br><span class="line"><span class="string">backupresult=$?</span></span><br><span class="line"><span class="string">afterstamp=`date +%s`</span></span><br><span class="line"><span class="string">if [ $&#123;backupresult&#125; == 0 ];then</span></span><br><span class="line"><span class="string">    sudo echo "4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份成功,文件名称为$&#123;backname&#125;，重命名备份文件" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    rename_backname_func</span></span><br><span class="line"><span class="string">    date_func</span></span><br><span class="line"><span class="string">        del_old_bakdata</span></span><br><span class="line"><span class="string">        send_success_mail</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">    sudo echo "4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份失败,注意查看备份失败原因并重新备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    send_fail_mail</span></span><br><span class="line"><span class="string">    exit</span></span><br><span class="line"><span class="string">fi</span></span><br></pre></td></tr></table></figure></p><p>使用该脚本需要修改自己数据库对应的用户名authuser,密码authpass,邮箱dest_mail,项目名称programname,服务器名称servername,数据库实例名称instancename,mongodb数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改</p><h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure></p><p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure></p><p>参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">from:</span><span class="string">指定发送邮件的发件人</span></span><br><span class="line"><span class="attr">smtp:</span><span class="string">指定smtp服务器信息</span></span><br><span class="line"><span class="attr">smtp-auth-user:</span><span class="string">允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure></p><p>2.3、发送测试邮件：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="bullet">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure></p><p>title:指定发送文件的标题，可自行定义</p><h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure><h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb4.0备份与恢复</title>
      <link href="/2018/08/12/mongdob4.0%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
      <url>/2018/08/12/mongdob4.0%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<h2 id="1、mongodb备份命令"><a href="#1、mongodb备份命令" class="headerlink" title="1、mongodb备份命令"></a>1、mongodb备份命令</h2><p>1.1、备份之前查看备份实例的相关数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.auth(&apos;admin1&apos;,&apos;admin123&apos;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use test;</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure></p><p>1.2、对于replica set集群模式命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongodump -h <span class="string">"testrepl/127.0.0.1:30000"</span> -u admin1 -p admin123 -d <span class="built_in">test</span> -o /data/backup/ --authenticationDatabase admin</span><br></pre></td></tr></table></figure></p><p>结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-12</span><span class="attr">T03:40:01.489+0000</span>    <span class="string">writing</span> <span class="string">test.test_collection</span> <span class="string">to</span> </span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-12</span><span class="attr">T03:40:03.823+0000</span>    <span class="string">done</span> <span class="string">dumping</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br></pre></td></tr></table></figure></p><p>会在指定的备份目录下，生成备份实例名对应的文件夹，文件夹下有以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_collection.bson  test_collection.metadata.json</span><br></pre></td></tr></table></figure></p><p>命令参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-h:</span><span class="string">指定当前备份主机ip</span></span><br><span class="line"><span class="attr">--port:</span><span class="string">指定当前mongodb的启动端口</span></span><br><span class="line"><span class="attr">-u:</span><span class="string">指定验证的用户名</span></span><br><span class="line"><span class="attr">-d:</span><span class="string">需要备份的数据库实例</span></span><br><span class="line"><span class="attr">-p:</span><span class="string">指定用户名对应的密码</span></span><br><span class="line"><span class="attr">-o:</span><span class="string">指定备份的路径</span></span><br><span class="line"><span class="attr">--authenticationDatabase:</span><span class="string">认证数据库</span></span><br></pre></td></tr></table></figure></p><p>备份过程没有加上指定认证数据库“–authenticationDatabase admin”,会报一下错误<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Failed:</span> <span class="string">error</span> <span class="string">connecting</span> <span class="string">to</span> <span class="string">db</span> <span class="attr">server:</span> <span class="string">server</span> <span class="string">returned</span> <span class="string">error</span> <span class="string">on</span> <span class="string">SASL</span> <span class="string">authentication</span> <span class="attr">step:</span> <span class="string">Authentication</span> <span class="string">failed.</span></span><br></pre></td></tr></table></figure></p><p>1.3、对于单节点备份命令如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/data/mongodb/bin/mongodump</span> <span class="bullet">-h</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="bullet">--port</span> <span class="number">30000</span> <span class="bullet">-u</span> <span class="string">admin1</span> <span class="bullet">-p</span> <span class="string">admin123</span> <span class="bullet">-d</span> <span class="string">test</span> <span class="bullet">-o</span> <span class="string">/data/backup</span> <span class="bullet">--authenticationDatabase</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure></p><h2 id="2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-："><a href="#2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-：" class="headerlink" title="2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)："></a>2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongorestore -h 10.0.7.36 --port 30000  -u admin1 -p admin123 -d <span class="built_in">test</span>  /data/backup/<span class="built_in">test</span> --authenticationDatabase admin</span><br></pre></td></tr></table></figure><p>恢复输出结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.860+0000</span>    <span class="string">the</span> <span class="bullet">--db</span> <span class="string">and</span> <span class="bullet">--collection</span> <span class="string">args</span> <span class="string">should</span> <span class="string">only</span> <span class="string">be</span> <span class="string">used</span> <span class="string">when</span> <span class="string">restoring</span> <span class="string">from</span> <span class="string">a</span> <span class="string">BSON</span> <span class="string">file.</span> <span class="string">Other</span> <span class="string">uses</span> <span class="string">are</span> <span class="string">deprecated</span> <span class="string">and</span> <span class="string">will</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">in</span> <span class="string">the</span> <span class="string">future;</span> <span class="string">use</span> <span class="bullet">--nsInclude</span> <span class="string">instead</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.860+0000</span>    <span class="string">building</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">collections</span> <span class="string">to</span> <span class="string">restore</span> <span class="string">from</span> <span class="string">/data/backup/test</span> <span class="string">dir</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.885+0000</span>    <span class="string">reading</span> <span class="string">metadata</span> <span class="string">for</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.metadata.json</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.972+0000</span>    <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.bson</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:51.781+0000</span>    <span class="string">[###########.............]</span>  <span class="string">test.test_collection</span>  <span class="number">28.4</span><span class="string">MB/57.1MB</span>  <span class="string">(49.8%)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:54.490+0000</span>    <span class="string">[########################]</span>  <span class="string">test.test_collection</span>  <span class="number">57.1</span><span class="string">MB/57.1MB</span>  <span class="string">(100.0%)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:54.490+0000</span>    <span class="string">restoring</span> <span class="string">indexes</span> <span class="string">for</span> <span class="string">collection</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">metadata</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:57.737+0000</span>    <span class="string">finished</span> <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:57.737+0000</span>    <span class="string">done</span></span><br></pre></td></tr></table></figure></p><p>控制台登录，查看数据是否一致：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise &gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise &gt; db.auth(&apos;admin1&apos;,&apos;admin123&apos;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise &gt; show dbs;</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">test    0.031GB</span><br><span class="line">MongoDB Enterprise &gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise &gt; show tables;</span><br><span class="line">test_collection</span><br><span class="line">MongoDB Enterprise &gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure></p><p>恢复完成</p>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 使用innodb trx和innodb lock信息表查看锁事物</title>
      <link href="/2018/08/11/%E4%BD%BF%E7%94%A8innodb%20trx%E5%92%8Cinnodb%20lock%E4%BF%A1%E6%81%AF%E8%A1%A8%E6%9F%A5%E7%9C%8B%E9%94%81%E4%BA%8B%E7%89%A9/"/>
      <url>/2018/08/11/%E4%BD%BF%E7%94%A8innodb%20trx%E5%92%8Cinnodb%20lock%E4%BF%A1%E6%81%AF%E8%A1%A8%E6%9F%A5%E7%9C%8B%E9%94%81%E4%BA%8B%E7%89%A9/</url>
      <content type="html"><![CDATA[<h2 id="1、插入表测试数据"><a href="#1、插入表测试数据" class="headerlink" title="1、插入表测试数据"></a>1、插入表测试数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> aaa;</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br></pre></td></tr></table></figure><h2 id="2、创建三个会话，造成锁事物"><a href="#2、创建三个会话，造成锁事物" class="headerlink" title="2、创建三个会话，造成锁事物"></a>2、创建三个会话，造成锁事物</h2><p>sessin 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">60</span>);</span><br></pre></td></tr></table></figure></p><p>session 2:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></p><p>sesion 3:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></p><h2 id="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："><a href="#3、使用以下查询来查看正在等待的事务以及阻止它们的事务：" class="headerlink" title="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："></a>3、使用以下查询来查看正在等待的事务以及阻止它们的事务：</h2><p>session 4<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  r.trx_id waiting_trx_id,</span><br><span class="line">  r.trx_mysql_thread_id waiting_thread,</span><br><span class="line">  r.trx_query waiting_query,</span><br><span class="line">  b.trx_id blocking_trx_id,</span><br><span class="line">  b.trx_mysql_thread_id blocking_thread,</span><br><span class="line">  b.trx_query blocking_query</span><br><span class="line"><span class="keyword">FROM</span>       information_schema.innodb_lock_waits w</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx b</span><br><span class="line">  <span class="keyword">ON</span> b.trx_id = w.blocking_trx_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx r</span><br><span class="line">  <span class="keyword">ON</span> r.trx_id = w.requesting_trx_id;</span><br><span class="line">查询结果如下：</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| waiting_trx_id | waiting_thread | waiting_query                        | blocking_trx_id | blocking_thread | blocking_query                  |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| 2488           |             58 | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2487</span>            |              <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">| <span class="number">2488</span>           |             <span class="number">58</span> | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">| <span class="number">2487</span>           |             <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>      | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br></pre></td></tr></table></figure></p><p>上述sql语句可能太繁琐，也可使用下面语句查询<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  waiting_trx_id,</span><br><span class="line">  waiting_pid,</span><br><span class="line">  waiting_query,</span><br><span class="line">  blocking_trx_id,</span><br><span class="line">  blocking_pid,</span><br><span class="line">  blocking_query</span><br><span class="line"><span class="keyword">FROM</span> sys.innodb_lock_waits;</span><br></pre></td></tr></table></figure></p><h2 id="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物"><a href="#4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物" class="headerlink" title="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物"></a>4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br><span class="line">| 57 | root        | localhost | aaaa | Sleep   |    566 |                                                        | NULL                  |</span><br></pre></td></tr></table></figure><p>查询出process_id为57</p><h2 id="5、通过processlist-id查询出thread-id"><a href="#5、通过processlist-id查询出thread-id" class="headerlink" title="5、通过processlist_id查询出thread_id"></a>5、通过processlist_id查询出thread_id</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID <span class="keyword">FROM</span> performance_schema.threads <span class="keyword">WHERE</span> PROCESSLIST_ID = <span class="number">57</span>;</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| THREAD_ID |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">|        79 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></table></figure><h2 id="6、根据thread-id查询出来造成锁事物的sql语句"><a href="#6、根据thread-id查询出来造成锁事物的sql语句" class="headerlink" title="6、根据thread_id查询出来造成锁事物的sql语句"></a>6、根据thread_id查询出来造成锁事物的sql语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_current </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">THREAD_ID: <span class="number">79</span></span><br><span class="line"> SQL_TEXT: <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。"><a href="#7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。" class="headerlink" title="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。"></a>7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_history </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> EVENT_ID;</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">| THREAD_ID | SQL_TEXT                        |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">|        79 | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</title>
      <link href="/2018/08/11/mysql-%20Lock%20wait%20timeout%20exceeded;%20try%20restarting%20transaction/"/>
      <url>/2018/08/11/mysql-%20Lock%20wait%20timeout%20exceeded;%20try%20restarting%20transaction/</url>
      <content type="html"><![CDATA[<h2 id="1、对一个表进行ddl操作"><a href="#1、对一个表进行ddl操作" class="headerlink" title="1、对一个表进行ddl操作"></a>1、对一个表进行ddl操作</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql&gt;ALTER</span> <span class="string">TABLE</span> <span class="string">deposit_coin_order_user</span> <span class="string">add</span> <span class="string">`txid`</span>  <span class="string">varchar(128)</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">COLLATE</span> <span class="string">utf8mb4_general_ci</span> <span class="string">NOT</span> <span class="literal">NULL</span> <span class="string">COMMENT</span> <span class="string">'区块链id'</span> <span class="string">;</span></span><br><span class="line"><span class="string">提示报错：</span></span><br><span class="line"><span class="string">ERROR</span> <span class="number">1205</span> <span class="string">(HY000):</span> <span class="string">Lock</span> <span class="string">wait</span> <span class="string">timeout</span> <span class="string">exceeded;</span> <span class="string">try</span> <span class="string">restarting</span> <span class="string">transaction</span></span><br></pre></td></tr></table></figure><p>查看该表数据只有39行数据：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">select</span> <span class="string">count(*)</span> <span class="string">from</span> <span class="string">deposit_coin_order_user;</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">| count(*) |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|       39 |</span></span><br><span class="line"><span class="string">+----------+</span></span><br></pre></td></tr></table></figure></p><h2 id="2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’"><a href="#2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’" class="headerlink" title="2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’"></a>2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">SELECT</span> <span class="string">*</span> <span class="string">FROM</span> <span class="string">information_schema.INNODB_TRX\G</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line"><span class="attr">                    trx_id:</span> <span class="number">421462261342800</span></span><br><span class="line"><span class="attr">                 trx_state:</span> <span class="string">RUNNING</span></span><br><span class="line"><span class="attr">               trx_started:</span> <span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-10</span> <span class="number">08</span><span class="string">:24:58</span></span><br><span class="line"><span class="attr">     trx_requested_lock_id:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">          trx_wait_started:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">                trx_weight:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">       trx_mysql_thread_id:</span> <span class="number">12989053</span></span><br><span class="line"><span class="attr">                 trx_query:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">       trx_operation_state:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">         trx_tables_in_use:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">         trx_tables_locked:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          trx_lock_structs:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">     trx_lock_memory_bytes:</span> <span class="number">1136</span></span><br><span class="line"><span class="attr">           trx_rows_locked:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">         trx_rows_modified:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">   trx_concurrency_tickets:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">       trx_isolation_level:</span> <span class="string">REPEATABLE</span> <span class="string">READ</span></span><br><span class="line"><span class="attr">         trx_unique_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    trx_foreign_key_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">trx_last_foreign_key_error:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr"> trx_adaptive_hash_latched:</span> <span class="number">0</span></span><br><span class="line"><span class="attr"> trx_adaptive_hash_timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          trx_is_read_only:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">trx_autocommit_non_locking:</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure><p>使用show full processlist查看是否有‘trx_mysql_thread_id’对应的进程，如果有就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。没有的话看看有没有正在执行的很慢SQL记录线程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show full processlist;</span><br><span class="line">| 12989053 | cwreadonly                        | 10.1.10.9:51650  | exchange_market | Sleep            |   1189 |                                                               | NULL</span><br></pre></td></tr></table></figure></p><h2 id="3、发现有id为12989053的sql，需要手动kill掉"><a href="#3、发现有id为12989053的sql，需要手动kill掉" class="headerlink" title="3、发现有id为12989053的sql，需要手动kill掉"></a>3、发现有id为12989053的sql，需要手动kill掉</h2><p>mysql &gt; KILL 12989053;</p><h2 id="4、再次执行ddl语句，正常执行"><a href="#4、再次执行ddl语句，正常执行" class="headerlink" title="4、再次执行ddl语句，正常执行"></a>4、再次执行ddl语句，正常执行</h2><p>ALTER TABLE deposit_coin_order_user add <code>txid</code>  varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT ‘区块链id’ ;</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql定时备份及邮件告知备份情况</title>
      <link href="/2018/08/10/mysql%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%8F%8A%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/"/>
      <url>/2018/08/10/mysql%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%8F%8A%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/</url>
      <content type="html"><![CDATA[<h2 id="1、mysql全量备份脚本，内容如下："><a href="#1、mysql全量备份脚本，内容如下：" class="headerlink" title="1、mysql全量备份脚本，内容如下："></a>1、mysql全量备份脚本，内容如下：</h2><p>cat /data/soft/mysql_backup.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#数据库用户名</span></span><br><span class="line">dbuser=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#数据库密码</span></span><br><span class="line">dbpass=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line">stamp=`date +<span class="string">"%Y-%m-%d"</span>`</span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line">programname=mw</span><br><span class="line"><span class="comment">#备份文件名称前缀</span></span><br><span class="line">fullbackupname=<span class="variable">$&#123;programname&#125;</span>-dbfullbak</span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line">backuppath=/data/backup</span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line">backname=<span class="variable">$backuppath</span>/<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump</span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line">oldstamp=`date +<span class="string">"%Y-%m-%d"</span> -d <span class="string">"-5 day"</span>`</span><br><span class="line">oldbackname=<span class="variable">$backuppath</span>/<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;oldstamp&#125;</span>.dump</span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line">dbpath=/data/mysql/bin</span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line">backuplogname=/tmp/backup_<span class="variable">$&#123;stamp&#125;</span>.<span class="built_in">log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line">localname=`hostname`</span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line">localip=`ip a |grep global| head -1| awk <span class="string">'&#123;print $2&#125;'</span>|awk -F<span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="comment">#localip='65.52.165.104'</span></span><br><span class="line"><span class="comment">#目标邮箱</span></span><br><span class="line">dest_mail=<span class="string">'test@qq.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;backuplogname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">   sudo rm -rf <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   :</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="function"><span class="title">send_fail_mail</span></span>()&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;programname&#125;</span>备份失败,登录服务器<span class="variable">$&#123;localname&#125;</span>-<span class="variable">$&#123;localip&#125;</span>的日志<span class="variable">$&#123;backuplogname&#125;</span>下查看报错！！！"</span> |mail -s <span class="variable">$&#123;programname&#125;</span>数据库备份情况 <span class="variable">$&#123;dest_mail&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="function"><span class="title">send_success_mail</span></span>()&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;programname&#125;</span>备份成功,可登录服务器<span class="variable">$&#123;localname&#125;</span>-<span class="variable">$&#123;localip&#125;</span>的日志<span class="variable">$&#123;backuplogname&#125;</span>下查看备份信息。"</span> |mail -s <span class="variable">$&#123;programname&#125;</span>数据库备份情况 <span class="variable">$&#123;dest_mail&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建备份时间函数</span></span><br><span class="line"><span class="function"><span class="title">date_func</span></span>()&#123;</span><br><span class="line">   dateresult=$((<span class="variable">$&#123;afterstamp&#125;</span>-<span class="variable">$&#123;beforstamp&#125;</span>))</span><br><span class="line">   hour=$((<span class="variable">$&#123;dateresult&#125;</span>/3600))</span><br><span class="line">   min=$(((<span class="variable">$&#123;dateresult&#125;</span>-<span class="variable">$&#123;hour&#125;</span>*3600)/60))</span><br><span class="line">   sec=$((<span class="variable">$&#123;dateresult&#125;</span>-<span class="variable">$&#123;hour&#125;</span>*3600-<span class="variable">$&#123;min&#125;</span>*60))</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"5、本次备份运行时间为:"</span><span class="variable">$&#123;hour&#125;</span>时<span class="variable">$&#123;min&#125;</span>分<span class="variable">$&#123;sec&#125;</span>秒 &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="function"><span class="title">del_old_bakdata</span></span>()&#123;</span><br><span class="line">   <span class="keyword">if</span> [ -e <span class="variable">$&#123;oldbackname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"6、五天前的备份数据<span class="variable">$&#123;oldbackname&#125;</span>存在，进行删除"</span>  &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    rm -rf <span class="variable">$&#123;oldbackname&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"6.1、备份数据删除成功"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"6.1、备份数据删除失败，注意查看失败原因"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     sudo <span class="built_in">echo</span> <span class="string">"6、五天前的备份数据<span class="variable">$&#123;oldbackname&#125;</span>不存在，不需要再删除。"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   <span class="keyword">fi</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$&#123;backuppath&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"1、备份目录存在,可执行备份操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"1、备份目录不存在,手动创建"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">sudo mkdir -p <span class="variable">$&#123;backuppath&#125;</span></span><br><span class="line"><span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">   sudo <span class="built_in">echo</span> <span class="string">"1.1、备份目录创建成功，可进行下面操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   sudo <span class="built_in">echo</span> <span class="string">"1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;backname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"2、指定的备份文件<span class="variable">$&#123;backname&#125;</span>已存在，对其进行重命名"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    mv <span class="variable">$&#123;backname&#125;</span> <span class="variable">$&#123;backuppath&#125;</span>/bak-<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump</span><br><span class="line">    <span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"2.1、文件已重新命名为<span class="variable">$&#123;backuppath&#125;</span>/bak-<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump,可继续备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"2.1、文件重命名失败，退出备份操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"2、指定的备份文件不存在，开始进行备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前时间戳</span></span><br><span class="line">beforstamp=`date +%s`</span><br><span class="line"><span class="comment">#开始全量备份数据库</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"3、开始全量备份数据库"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="variable">$&#123;dbpath&#125;</span>/mysqldump -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> --all-databases --<span class="built_in">set</span>-gtid-purged=OFF &gt; <span class="variable">$&#123;backname&#125;</span></span><br><span class="line">backupresult=$?</span><br><span class="line">afterstamp=`date +%s`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;backupresult&#125;</span> == 0 ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"4、<span class="variable">$&#123;programname&#125;</span>数据库备份成功,文件名称为<span class="variable">$&#123;backname&#125;</span>，准备删除五天前的备份数据"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    date_func</span><br><span class="line">        del_old_bakdata</span><br><span class="line">        send_success_mail</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"4、<span class="variable">$&#123;programname&#125;</span>数据库备份失败,注意查看备份失败原因并重新备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    send_fail_mail</span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><p>使用该脚本需要修改自己数据库对应的用户名dbuser,密码dbpass,邮箱dest_mail,项目名称programname,mysql数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改</p><h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure></p><p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure></p><p>参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">from:</span><span class="string">指定发送邮件的发件人</span></span><br><span class="line"><span class="attr">smtp:</span><span class="string">指定smtp服务器信息</span></span><br><span class="line"><span class="attr">smtp-auth-user:</span><span class="string">允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure></p><p>2.3、发送测试邮件：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="bullet">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure></p><p>title:指定发送文件的标题，可自行定义</p><h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mysql_backup.sh</span><br></pre></td></tr></table></figure><h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mysql_backup.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysqldump逻辑备份及恢复</title>
      <link href="/2018/08/09/mysqldump%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%8F%8A%E6%81%A2%E5%A4%8D/"/>
      <url>/2018/08/09/mysqldump%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%8F%8A%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<h2 id="0、mysql实验版本"><a href="#0、mysql实验版本" class="headerlink" title="0、mysql实验版本"></a>0、mysql实验版本</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.7</span><span class="number">.22</span><span class="bullet">-log</span></span><br></pre></td></tr></table></figure><h2 id="1、mysqldump备份操作详解："><a href="#1、mysqldump备份操作详解：" class="headerlink" title="1、mysqldump备份操作详解："></a>1、mysqldump备份操作详解：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-d --no-data No row information 只导出数据结构</span><br><span class="line">-t --no-create-info 只导出数据（不包含结构）</span><br><span class="line">1）导出所有数据库</span><br><span class="line">mysqldump -u root -p --all-databases &gt; all_db.dump</span><br><span class="line">2）导出指定数据库</span><br><span class="line">mysqldump -u root -p zabbixDB &gt; zabbix.dump</span><br><span class="line">3) 导出多个数据库</span><br><span class="line">mysqldump -u root -p --databases zabbixDB mysql &gt; zabbix_mysql.dump</span><br><span class="line">4）导出一个表</span><br><span class="line">mysqldump -u root -p zabbixDB task &gt;  zabbixDB_task.dump</span><br><span class="line">5)导出一个数据库的多个表</span><br><span class="line">mysqldump -u root -p --databases zabbixDB --tables trends users &gt; zabbix_trends_users.dump</span><br><span class="line">6)条件导出----导出db1表a1中id=1的数据</span><br><span class="line">mysqldump -uroot -p --databases db1 --tables a1 --where=&apos;id=1&apos; &gt; db1_a1_id.dump</span><br><span class="line">7)将h1服务器中的db1数据库的所有数据导入到h2中的db2数据库中，db2的数据库必须存在否则会报错</span><br><span class="line">mysqldump --host=h1 -uroot -proot --databases db1 |mysql --host=h2 -uroot -proot db2</span><br><span class="line">8)压缩备份</span><br><span class="line">mysqldump -uroot -p --databases zabbixDB 2&gt;/dev/null |gzip &gt; zabbixDB.gz</span><br></pre></td></tr></table></figure><p>##开始实验</p><h2 id="2、源库插入测试数据"><a href="#2、源库插入测试数据" class="headerlink" title="2、源库插入测试数据"></a>2、源库插入测试数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create database aaaa;</span><br><span class="line">use aaaa;</span><br><span class="line">create table aa (id int primary key);</span><br><span class="line">insert into aa values(&apos;1&apos;);</span><br></pre></td></tr></table></figure><h2 id="3、导出备份"><a href="#3、导出备份" class="headerlink" title="3、导出备份"></a>3、导出备份</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u root -p --all-databases --<span class="built_in">set</span>-gtid-purged=OFF  &gt; /tmp/test.dump</span><br></pre></td></tr></table></figure><h2 id="4、在目标数据库进行还原，全库导入"><a href="#4、在目标数据库进行还原，全库导入" class="headerlink" title="4、在目标数据库进行还原，全库导入"></a>4、在目标数据库进行还原，全库导入</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678 &lt; test.dump</span><br></pre></td></tr></table></figure><p>因为mysqldump属于逻辑备份，恢复步骤为先检查要恢复的database是否存在，如果不存在就手动创建，如果存在就进入database去检查表是否存在，如果存在，会先删除再手动创建,表创建完成之后插入数据,分析dump文件，具体内容如下：</p><p>4.1、创建database：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">Current</span> <span class="attr">Database:</span> <span class="string">`aaaa`</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="string">CREATE</span> <span class="string">DATABASE</span> <span class="string">/*!32312</span> <span class="string">IF</span> <span class="string">NOT</span> <span class="string">EXISTS*/</span> <span class="string">`aaaa`</span> <span class="string">/*!40100</span> <span class="string">DEFAULT</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">USE</span> <span class="string">`aaaa`;</span></span><br></pre></td></tr></table></figure></p><p>4.2、检查并创建表aaa:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">Table</span> <span class="string">structure</span> <span class="string">for</span> <span class="string">table</span> <span class="string">`aaa`</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="string">DROP</span> <span class="string">TABLE</span> <span class="string">IF</span> <span class="string">EXISTS</span> <span class="string">`aaa`;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">@saved_cs_client</span>     <span class="string">=</span> <span class="string">@@character_set_client</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">character_set_client</span> <span class="string">=</span> <span class="string">utf8</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">CREATE</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">(</span></span><br><span class="line">  <span class="string">`id`</span> <span class="string">int(11)</span> <span class="string">NOT</span> <span class="literal">NULL</span><span class="string">,</span></span><br><span class="line">  <span class="string">PRIMARY</span> <span class="string">KEY</span> <span class="string">(`id`)</span></span><br><span class="line"><span class="string">)</span> <span class="string">ENGINE=InnoDB</span> <span class="string">DEFAULT</span> <span class="string">CHARSET=utf8mb4;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">character_set_client</span> <span class="string">=</span> <span class="string">@saved_cs_client</span> <span class="string">*/;</span></span><br></pre></td></tr></table></figure></p><p>4.3、对表aaa插入备份出来的数据：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">Dumping</span> <span class="string">data</span> <span class="string">for</span> <span class="string">table</span> <span class="string">`aaa`</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="string">LOCK</span> <span class="string">TABLES</span> <span class="string">`aaa`</span> <span class="string">WRITE;</span></span><br><span class="line"><span class="string">/*!40000</span> <span class="string">ALTER</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">DISABLE</span> <span class="string">KEYS</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">INSERT</span> <span class="string">INTO</span> <span class="string">`aaa`</span> <span class="string">VALUES</span> <span class="string">(1);</span></span><br><span class="line"><span class="string">/*!40000</span> <span class="string">ALTER</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">ENABLE</span> <span class="string">KEYS</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">UNLOCK</span> <span class="string">TABLES;</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb sharding集群配置</title>
      <link href="/2018/08/08/mongodb-sharding-cluster%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/08/08/mongodb-sharding-cluster%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="0、前提需求"><a href="#0、前提需求" class="headerlink" title="0、前提需求"></a>0、前提需求</h2><p>为了满足mongodb数据库高可用环境，可以使用配置副本集CSRS（config server replica set)，搭建方法点击<a href="https://zeven0707.github.io/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/" target="_blank" rel="noopener">此处</a>,但是当业务吞吐量特别高的时刻，单台节点已经不能满足访问需求，因此需要考虑sharding cluster 模式，提高访问性能。</p><h2 id="1、将集群架构从csrs调整为sharding-cluster-下文按照上面搭建的csrs架构继续调整："><a href="#1、将集群架构从csrs调整为sharding-cluster-下文按照上面搭建的csrs架构继续调整：" class="headerlink" title="1、将集群架构从csrs调整为sharding cluster,下文按照上面搭建的csrs架构继续调整："></a>1、将集群架构从csrs调整为sharding cluster,下文按照上面搭建的csrs架构继续调整：</h2><p>1.1、节点信息如下：<br>主：10.0.7.53<br>从：10.0.7.51<br>仲裁：10.0.7.50<br>依次关闭仲裁、从、主节点，修改配置文件mongodb.conf，添加如下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sharding:</span><br><span class="line">   clusterRole: shardsvr</span><br></pre></td></tr></table></figure></p><p>1.2、修改完三个节点之后，依次启动主，从，仲裁三个节点，进入控制台使用rs.status()，查看集群状态是否正常。为了保证停机时间较短，可使用rs.stepDown()分别进行主从切换，对从库进行配置并重启。</p><h2 id="2、新建一个shard1集群节点，操作如下-三个节点都要执行）："><a href="#2、新建一个shard1集群节点，操作如下-三个节点都要执行）：" class="headerlink" title="2、新建一个shard1集群节点，操作如下(三个节点都要执行）："></a>2、新建一个shard1集群节点，操作如下(三个节点都要执行）：</h2><p>2.1、节点信息如下：<br>从：10.0.7.53<br>主：10.0.7.51<br>仲裁：10.0.7.50<br>2.2、拷贝一份mongodb.conf文件，并重新命名<br>cp mongodb.conf shard1mongodb.conf<br>2.3、主节点需要在无需验证的模式下，先配置用户名密码。之后修改（三个节点）shard1mongodb.conf配置文件内容如下：<br>cat shard1mongodb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line"><span class="attr">  destination:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/data/mongodb/shard1/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  dbPath:</span> <span class="string">/data/mongodb/shard1/data/</span></span><br><span class="line"><span class="attr">  journal:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line"><span class="attr">  fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line"><span class="attr">  pidFilePath:</span> <span class="string">/data/mongodb/shard1/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.53</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">   authorization:</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">   keyFile:</span> <span class="string">/data/mongodb/shard1/mongodb.keyfile</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line"><span class="attr">   replSetName:</span> <span class="string">"shard1"</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line"><span class="attr">   clusterRole:</span> <span class="string">shardsvr</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p><p>注意修改sharding、port、path、replname等参数</p><p>2.4、创建相应的数据目录和日志目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/shard1/&#123;<span class="built_in">log</span>,data&#125;</span><br></pre></td></tr></table></figure></p><p>2.5、生成keyfile文件并拷贝keyfile文件到指定目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mongodb.keyfile /data/mongodb/shard1/</span><br></pre></td></tr></table></figure></p><p>2.6、三个节点启动mongodb-shard1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod -f /data/mongodb/shard1mongodb.conf</span><br></pre></td></tr></table></figure></p><p>2.7、初始化集群配置：</p><h2 id="data-mongodb-bin-mongo-–port-30001"><a href="#data-mongodb-bin-mongo-–port-30001" class="headerlink" title="/data/mongodb/bin/mongo –port 30001"></a>/data/mongodb/bin/mongo –port 30001</h2><p>rs.initiate(<br>  {<br>    _id : “shard”,<br>    members: [<br>      { _id : 0, host : “10.0.7.53:30001” },<br>      { _id : 1, host : “10.0.7.50:30001” },<br>      { _id : 2, host : “10.0.7.51:30001”,”arbiterOnly” : true }<br>    ]<br>  }<br>)<br>2.8、查看集群节点信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status();</span><br></pre></td></tr></table></figure></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"set"</span> <span class="string">:</span> <span class="string">"shard"</span><span class="string">,</span></span><br><span class="line"><span class="string">"date"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.697Z"),</span></span><br><span class="line"><span class="string">"myState"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"term"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"heartbeatIntervalMillis"</span> <span class="string">:</span> <span class="string">NumberLong(2000),</span></span><br><span class="line"><span class="string">"optimes"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"readConcernMajorityOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"appliedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"durableOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"lastStableCheckpointTimestamp"</span> <span class="string">:</span> <span class="string">Timestamp(1533784355,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"members"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.53:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">47039</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"self"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"PRIMARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">46862</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line"><span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:33.395Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:32.735Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"electionTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533737562,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"electionDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-08T14:12:42Z"),</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">7</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"ARBITER"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">46862</span><span class="string">,</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.660Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.658Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(0),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"$gleStats"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"lastOpTime"</span> <span class="string">:</span> <span class="string">Timestamp(0,</span> <span class="number">0</span><span class="string">),</span></span><br><span class="line"><span class="string">"electionId"</span> <span class="string">:</span> <span class="string">ObjectId("000000000000000000000000")</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"$configServerState"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"opTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784394,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784408,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"dToZVSHbihPkQILJVl0qcSY+8ys="),</span></span><br><span class="line"><span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong("6587344633552961565")</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="3、新建一个config-server集群节点，操作如下-三个节点都要执行）："><a href="#3、新建一个config-server集群节点，操作如下-三个节点都要执行）：" class="headerlink" title="3、新建一个config-server集群节点，操作如下(三个节点都要执行）："></a>3、新建一个config-server集群节点，操作如下(三个节点都要执行）：</h2><p>3.1、节点信息如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">从：10.0.7.53</span></span><br><span class="line"><span class="string">从：10.0.7.51</span></span><br><span class="line"><span class="string">主：10.0.7.50</span></span><br></pre></td></tr></table></figure></p><p>3.2、拷贝一份mongodb.conf文件，并重新命名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp shard1mongodb.conf configmongodb.conf</span><br></pre></td></tr></table></figure></p><p>3.3、主节点需要在无需验证的模式下，先配置用户名密码。之后修改（三个节点）configmongodb.conf配置文件内容如下：<br>cat configmongodb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line"><span class="attr">  destination:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/data/mongodb/config/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  dbPath:</span> <span class="string">/data/mongodb/config/data/</span></span><br><span class="line"><span class="attr">  journal:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line"><span class="attr">  fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line"><span class="attr">  pidFilePath:</span> <span class="string">/data/mongodb/config/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.53</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#   authorization: enabled</span></span><br><span class="line"><span class="comment">#   keyFile: /data/mongodb/config/mongodb.keyfile</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line"><span class="attr">   replSetName:</span> <span class="string">"config"</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line"><span class="attr">   clusterRole:</span> <span class="string">configsvr</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p><p>注意修改sharding、repl、port、path<br>3.4、创建相应的数据目录和日志目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/config/&#123;<span class="built_in">log</span>,data&#125;</span><br></pre></td></tr></table></figure></p><p>3.5、三个节点启动mongodb-shard1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod --configsvr -f /data/mongodb/configmongodb.conf</span><br></pre></td></tr></table></figure></p><p>启动config-server服务需要指定参数，否则初始化集群的时候会报错：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"errmsg"</span> <span class="string">:</span> <span class="string">"Nodes being used for config servers must be started with the --configsvr flag"</span></span><br></pre></td></tr></table></figure></p><p>3.6、初始化集群配置：</p><h2 id="data-mongodb-bin-mongo-–port-30002"><a href="#data-mongodb-bin-mongo-–port-30002" class="headerlink" title="/data/mongodb/bin/mongo –port 30002"></a>/data/mongodb/bin/mongo –port 30002</h2><p>rs.initiate(<br>  {<br>    _id : “config”,<br>    configsvr: true,<br>    members: [<br>      { _id : 0, host : “10.0.7.53:30002” },<br>      { _id : 1, host : “10.0.7.50:30002” },<br>      { _id : 2, host : “10.0.7.51:30002” }<br>    ]<br>  }<br>)<br>3.7、查看集群信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rs.status();</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"set"</span> <span class="string">:</span> <span class="string">"config"</span><span class="string">,</span></span><br><span class="line"><span class="string">"date"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.472Z"),</span></span><br><span class="line"><span class="string">"myState"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"term"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"heartbeatIntervalMillis"</span> <span class="string">:</span> <span class="string">NumberLong(2000),</span></span><br><span class="line"><span class="string">"optimes"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"readConcernMajorityOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"appliedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"durableOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"lastStableCheckpointTimestamp"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"members"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.53:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">15</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.161Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:12.674Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(0),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">15</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.164Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:12.680Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"PRIMARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">59</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">"could not find member to sync from"</span><span class="string">,</span></span><br><span class="line"><span class="string">"electionTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544150,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"electionDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:10Z"),</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"self"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</span></span><br><span class="line"><span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong(0)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p><h2 id="4、配置mongs-mongodb-router-用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点"><a href="#4、配置mongs-mongodb-router-用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点" class="headerlink" title="4、配置mongs(mongodb-router),用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点"></a>4、配置mongs(mongodb-router),用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点</h2><p>4.1、拷贝一份配置文件，并重命名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp configmongodb.conf routermongodb.conf</span><br></pre></td></tr></table></figure></p><p>4.2、修改配置文件参数，内容如下：<br>cat routermongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># mongod.conf</span><br><span class="line"></span><br><span class="line"># for documentation of all options, see:</span><br><span class="line">#   http://docs.mongodb.org/manual/reference/routeruration-options/</span><br><span class="line"></span><br><span class="line"># where to write logging data.</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /data/mongodb/router/log/mongod.log</span><br><span class="line"></span><br><span class="line"># Where and how to store data.</span><br><span class="line">#storage:</span><br><span class="line">#  dbPath: /data/mongodb/router/data/</span><br><span class="line">#  journal:</span><br><span class="line">#    enabled: true</span><br><span class="line">#  engine:</span><br><span class="line">#  mmapv1:</span><br><span class="line">#  wiredTiger:</span><br><span class="line"></span><br><span class="line"># how the process runs</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true  # fork and run in background</span><br><span class="line">  pidFilePath: /data/mongodb/router/log/mongod.pid  # location of pidfile</span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 30004</span><br><span class="line">  bindIp: 127.0.0.1,10.0.7.53  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line"></span><br><span class="line">#security:</span><br><span class="line">#security:</span><br><span class="line">#   authorization: enabled</span><br><span class="line">#operationProfiling:</span><br><span class="line"></span><br><span class="line">#replication:</span><br><span class="line">#sharding:</span><br><span class="line">sharding:</span><br><span class="line">   configDB: config/10.0.7.53:30002,10.0.7.51:30002,10.0.7.50:30002</span><br><span class="line"></span><br><span class="line">## Enterprise-Only Options</span><br><span class="line"></span><br><span class="line">#auditLog:</span><br><span class="line"></span><br><span class="line">#snmp:</span><br></pre></td></tr></table></figure></p><p>注意修改sharding,port参数，注释掉storage参数<br>4.3、创建router日志目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/router/<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p><p>4.4、启动mongos<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongos -f /data/mongodb/routermongodb.conf</span><br></pre></td></tr></table></figure></p><p>4.5、为模拟生产环境数据，对testrepl集群节点，插入部分数据,批量插入脚本如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use test</span><br><span class="line">var bulk = db.test_collection.initializeUnorderedBulkOp();</span><br><span class="line">people = [&quot;Marc&quot;, &quot;Bill&quot;, &quot;George&quot;, &quot;Eliot&quot;, &quot;Matt&quot;, &quot;Trey&quot;, &quot;Tracy&quot;, &quot;Greg&quot;, &quot;Steve&quot;, &quot;Kristina&quot;, &quot;Katie&quot;, &quot;Jeff&quot;];</span><br><span class="line">for(var i=0; i&lt;1000000; i++)&#123;</span><br><span class="line">   user_id = i;</span><br><span class="line">   name = people[Math.floor(Math.random()*people.length)];</span><br><span class="line">   number = Math.floor(Math.random()*10001);</span><br><span class="line">   bulk.insert( &#123; &quot;user_id&quot;:user_id, &quot;name&quot;:name, &quot;number&quot;:number &#125;);</span><br><span class="line">&#125;</span><br><span class="line">bulk.execute();</span><br></pre></td></tr></table></figure></p><p>4.6、连接到mongos<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mongo --host 10.0.7.50 --port 30004</span><br><span class="line">mongos&gt; use admin</span><br><span class="line">mongos&gt; db.auth(<span class="string">'admin1'</span>,<span class="string">'admin123'</span>);</span><br></pre></td></tr></table></figure></p><p>4.7、将节点添加到集群内：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(&quot;testrepl/10.0.7.53:30000&quot;)</span><br><span class="line">mongos&gt; sh.addShard(&quot;shard1/10.0.7.53:30001&quot;)</span><br></pre></td></tr></table></figure></p><p>4.8、使数据库test支持sharding<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.enableSharding(&quot;test&quot;)</span><br><span class="line">mongos&gt; use test</span><br><span class="line">#在拆分键上创建索引</span><br><span class="line">mongos&gt; db.test_collection.createIndex( &#123; number : 1 &#125; )</span><br><span class="line">#拆分集合</span><br><span class="line">mongos&gt; sh.shardCollection(&apos;test.mycol2&apos;, &#123;&apos;_id&apos;: 1&#125;)</span><br></pre></td></tr></table></figure></p><p>4.9、查看拆分结果,(可多次重复4.5步骤进行测试）<br>sh.status()或者db.printShardingStatus()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  <span class="string">"_id"</span> : 1,</span><br><span class="line">  <span class="string">"minCompatibleVersion"</span> : 5,</span><br><span class="line">  <span class="string">"currentVersion"</span> : 6,</span><br><span class="line">  <span class="string">"clusterId"</span> : ObjectId(<span class="string">"5b6af30b5025146bfd45717b"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"shard"</span>,  <span class="string">"host"</span> : <span class="string">"shard/10.0.7.50:30001,10.0.7.53:30001"</span>,  <span class="string">"state"</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"testrepl"</span>,  <span class="string">"host"</span> : <span class="string">"testrepl/10.0.7.50:30000,10.0.7.53:30000"</span>,  <span class="string">"state"</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">"4.0.0"</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: yes</span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                4 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"config"</span>,  <span class="string">"primary"</span> : <span class="string">"config"</span>,  <span class="string">"partitioned"</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">"_id"</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shard1</span><br><span class="line">                        &#123; <span class="string">"_id"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">"_id"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : 1 &#125; &#125; on : shard Timestamp(1, 0) </span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"test"</span>,  <span class="string">"primary"</span> : <span class="string">"testrepl"</span>,  <span class="string">"partitioned"</span> : <span class="literal">true</span>,  <span class="string">"version"</span> : &#123;  <span class="string">"uuid"</span> : UUID(<span class="string">"185a3842-639f-42b0-89a1-afdc8dcdfbe7"</span>),  <span class="string">"lastMod"</span> : 1 &#125; &#125;</span><br><span class="line">                test.test_collection</span><br><span class="line">                        shard key: &#123; <span class="string">"number"</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shard4</span><br><span class="line">                                testrepl4</span><br><span class="line">                        &#123; <span class="string">"number"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 2394 &#125; on : shard Timestamp(2, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 2394 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 4791 &#125; on : shard Timestamp(3, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 4791 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 7194 &#125; on : shard Timestamp(4, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 7194 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 7892 &#125; on : shard Timestamp(5, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 7892 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 8591 &#125; on : testrepl Timestamp(5, 1) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 8591 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 9287 &#125; on : testrepl Timestamp(3, 4) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 9287 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 9589 &#125; on : testrepl Timestamp(3, 5) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 9589 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : 1 &#125; &#125; on : testrepl Timestamp(4, 1)</span><br></pre></td></tr></table></figure></p><h2 id="5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可"><a href="#5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可" class="headerlink" title="5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可"></a>5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可</h2>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mha主从环境，从库报错Error_code: 1062</title>
      <link href="/2018/08/07/5.7.22-log%E7%89%88%E6%9C%ACmysql,mha%E4%B8%BB%E4%BB%8E%E7%8E%AF%E5%A2%83%EF%BC%8C%E4%BB%8E%E5%BA%93%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF/"/>
      <url>/2018/08/07/5.7.22-log%E7%89%88%E6%9C%ACmysql,mha%E4%B8%BB%E4%BB%8E%E7%8E%AF%E5%A2%83%EF%BC%8C%E4%BB%8E%E5%BA%93%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF/</url>
      <content type="html"><![CDATA[<h2 id="0、数据库版本信息："><a href="#0、数据库版本信息：" class="headerlink" title="0、数据库版本信息："></a>0、数据库版本信息：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.7</span><span class="number">.22</span></span><br></pre></td></tr></table></figure><h2 id="1、从库报错信息"><a href="#1、从库报错信息" class="headerlink" title="1、从库报错信息"></a>1、从库报错信息</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Last_SQL_Error:</span> <span class="string">Could</span> <span class="string">not</span> <span class="string">execute</span> <span class="string">Write_rows</span> <span class="string">event</span> <span class="string">on</span> <span class="string">table</span> <span class="string">test.tb1;</span></span><br><span class="line"><span class="string">Duplicate</span> <span class="string">entry</span> <span class="string">'4'</span> <span class="string">for</span> <span class="string">key</span> <span class="string">'PRIMARY'</span><span class="string">,</span></span><br><span class="line"><span class="attr">Error_code:</span> <span class="number">1062</span><span class="string">;</span></span><br><span class="line"><span class="string">handler</span> <span class="string">error</span> <span class="string">HA_ERR_FOUND_DUPP_KEY;</span> <span class="string">the</span> <span class="string">event's</span> <span class="string">master</span> <span class="string">log</span> <span class="string">mysql-binlog.000005,</span> <span class="string">end_log_pos</span> <span class="number">273273632</span></span><br></pre></td></tr></table></figure><h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><p>2.1、在主库上查询二进制文件信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqlbinlog  -v --stop-position=273273632 /data/mysql/<span class="built_in">log</span>/mysql-binlog.000005 &gt; /tmp/f.log</span><br></pre></td></tr></table></figure></p><p>2.2、过滤出报错的pos所对应的行数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/f.log | awk <span class="string">'/end_log_pos 273273632/ &#123;print NR&#125;'</span></span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">22556452</span><br></pre></td></tr></table></figure><p>2.3、根据查询到的行数，查看其上下文：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/f.log | awk <span class="string">'NR==22556442,NR==22556492'</span></span><br></pre></td></tr></table></figure></p><p>2.4、查询到insert的插入语句<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### INSERT INTO `test`.`tb1`</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=4</span></span><br><span class="line"><span class="comment">###   @2='ERC20'</span></span><br><span class="line"><span class="comment">###   @3='GTO'</span></span><br><span class="line"><span class="comment">###   @4=1533176390</span></span><br><span class="line"><span class="string">ROLLBACK</span> <span class="string">/*</span> <span class="string">added</span> <span class="string">by</span> <span class="string">mysqlbinlog</span> <span class="string">*/</span> <span class="string">/*!*/;</span></span><br></pre></td></tr></table></figure></p><p>2.5、在从库上执行下面操作，停止主从同步<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure></p><p>2.6、删除报错提示的对应的行：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb1 <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">4</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb1;</span><br></pre></td></tr></table></figure></p><p>2.7、重新启动主从同步，查看节点信息正常：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb集群配置一主一从一仲裁</title>
      <link href="/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/"/>
      <url>/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/</url>
      <content type="html"><![CDATA[<h2 id="1、首先安装在三个节点安装mongodb-安装方法详见"><a href="#1、首先安装在三个节点安装mongodb-安装方法详见" class="headerlink" title="1、首先安装在三个节点安装mongodb,安装方法详见"></a>1、首先安装在三个节点安装mongodb,安装方法详见</h2><p>   <a href="https://zeven0707.github.io/2018/08/03/mongdob4.0/" target="_blank" rel="noopener">mongodb单点安装</a></p><h2 id="2、集群节点信息："><a href="#2、集群节点信息：" class="headerlink" title="2、集群节点信息："></a>2、集群节点信息：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">主：10.0.7.53</span></span><br><span class="line"><span class="string">从：10.0.7.51</span></span><br><span class="line"><span class="string">仲裁：10.0.7.50</span></span><br></pre></td></tr></table></figure><h2 id="3、启动主节点，进入主节点控制台，"><a href="#3、启动主节点，进入主节点控制台，" class="headerlink" title="3、启动主节点，进入主节点控制台，"></a>3、启动主节点，进入主节点控制台，</h2><p>3.1、创建管理员用户名、密码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; /data/mongodb/bin/mongo --port 30000</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt;use admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt;</span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: <span class="string">"admin"</span>,</span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"abc123"</span>,</span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>使用userAdminAnyDatabase的role权限去查看rs.status();会提示<br>“not authorized on admin to execute command”,建议授予root权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: <span class="string">"admin1"</span>,</span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"admin123"</span>,</span><br><span class="line">    roles: [ &#123; role: <span class="string">"root"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>3.2、查看创建的管理员信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.system.users.find()</span><br></pre></td></tr></table></figure></p><p>3.3、退出控制台，修改配置文件mongodb.conf(每个节点都要配置)：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">   authorization:</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure></p><h2 id="4、在主节点上，生成秘钥文件"><a href="#4、在主节点上，生成秘钥文件" class="headerlink" title="4、在主节点上，生成秘钥文件"></a>4、在主节点上，生成秘钥文件</h2><p>4.1、生成密钥文件，用于集群之间互相通信：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 756 &gt; /data/mongodb/mongodb.keyfile</span><br></pre></td></tr></table></figure></p><p>4.2、更改文件权限以仅为文件所有者提供读取权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 400 /data/mongodb/mongodb.keyfile</span><br></pre></td></tr></table></figure></p><p>4.3、将密钥文件复制到每个副本集成员<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /data/mongodb/mongodb.keyfile root@10.0.7.51:/data/mongodb/</span><br><span class="line">scp /data/mongodb/mongodb.keyfile root@10.0.7.50:/data/mongodb/</span><br></pre></td></tr></table></figure></p><p>4.4、修改配置文件mongodb.conf，添加keyfile参数(每个节点都要配置)：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">   keyFile:</span> <span class="string">/data/mongodb/mongodb.keyfile</span></span><br></pre></td></tr></table></figure></p><h2 id="5、配置集群"><a href="#5、配置集群" class="headerlink" title="5、配置集群"></a>5、配置集群</h2><p>5.1、修改配置文件mongodb.conf，添加集群配置参数(每个节点都要配置)：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">   replSetName: <span class="string">"testrepl"</span></span><br></pre></td></tr></table></figure></p><p>replSetName:设置集群名称，根据自己需求自定义（三个节点要保持一直）</p><p>5.2、重新启动mongodb<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod -f /data/mongodb/mongodb.conf</span><br></pre></td></tr></table></figure></p><p>5.3、进入主节点控制台<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongo --port 30000</span><br></pre></td></tr></table></figure></p><p>5.4、添加集群节点：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use admin;</span><br><span class="line">db.auth(<span class="string">'admin'</span>,<span class="string">'abc123'</span>);</span><br><span class="line"></span><br><span class="line">rs.initiate( &#123;</span><br><span class="line">   _id : <span class="string">"testrepl"</span>,</span><br><span class="line">   members: [</span><br><span class="line">      &#123; _id: 0, host: <span class="string">"10.0.7.53:30000"</span> &#125;,</span><br><span class="line">      &#123; _id: 1, host: <span class="string">"10.0.7.50:30000"</span> &#125;,</span><br><span class="line">      &#123; _id: 2, host: <span class="string">"10.0.7.51:30000"</span>,<span class="string">"arbiterOnly"</span> : <span class="literal">true</span>&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>执行结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line">        <span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">        <span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533388128,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">        <span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533388128,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">                <span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">                        <span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</span></span><br><span class="line">                        <span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong(0)</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p><p>5.5、查看集群状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; rs.status();</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"testrepl"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.894Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : 1,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(1),</span><br><span class="line">        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(2000),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"readConcernMajorityOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"lastStableCheckpointTimestamp"</span> : Timestamp(1533388140, 1),</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 1,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 289,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"electionTime"</span> : Timestamp(1533388139, 1),</span><br><span class="line">                        <span class="string">"electionDate"</span> : ISODate(<span class="string">"2018-08-04T13:08:59Z"</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.50:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 2,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 37,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.051Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.677Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(3),</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : 0,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.51:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 7,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"ARBITER"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 37,</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.031Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2018-08-04T13:09:24.265Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(0),</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : 1,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1533388160, 1),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(0,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(0)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5.6、从库默认为不能读写模式，如果要启动从库的读模式，进入从库执行以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk();</span><br></pre></td></tr></table></figure></p><p>5.7、增加一个仲裁节点，新增节点，配置文件中密钥文件、repl参数一定要保持一致：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(<span class="string">"m1.example.net:27017"</span>)</span><br></pre></td></tr></table></figure></p><p>5.8、添加一个新的从节点，添加之前设置该节点优先级为0，表决为0，以防止该节点数据未同步完成之前参与选举，待该节点数据同步完成之后，使用rs.reconfig()参数再修改其优先级和表决：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add( &#123; host: <span class="string">"mongodb3.example.net:27017"</span>, priority: 0, votes: 0 &#125; )</span><br></pre></td></tr></table></figure></p><p>rs.reconfig()命令执行如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var cfg = rs.conf();</span><br><span class="line">cfg.members[4].priority = 1</span><br><span class="line">cfg.members[4].votes = 1</span><br><span class="line">rs.reconfig(cfg)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongdob-enterprise-4.0安装</title>
      <link href="/2018/08/03/mongdob4.0/"/>
      <url>/2018/08/03/mongdob4.0/</url>
      <content type="html"><![CDATA[<h3 id="1、Yum方式安装"><a href="#1、Yum方式安装" class="headerlink" title="1、Yum方式安装"></a>1、Yum方式安装</h3><p>  1.1配置yum源<br> cat /etc/yum.repos.d/mongodb-enterprise.repo<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[mongodb-enterprise]</span></span><br><span class="line"><span class="string">name=MongoDB</span> <span class="string">Enterprise</span> <span class="string">Repository</span></span><br><span class="line"><span class="string">baseurl=https://repo.mongodb.com/yum/redhat/$releasever/mongodb-enterprise/4.0/$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span></span><br></pre></td></tr></table></figure></p><p>  1.2执行安装命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y mongodb-enterprise</span><br></pre></td></tr></table></figure></p><p> 如果想要指定安装某一个版本的mongodb,需要指定每一个组件的安装版本,如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y mongodb-enterprise-4.0.0 mongodb-enterprise-server-4.0.0 mongodb-enterprise-shell-4.0.0 mongodb-enterprise-mongos-4.0.0 mongodb-enterprise-tools-4.0.0</span><br></pre></td></tr></table></figure></p><p>  1.3mongodb启动、关闭命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service mongod start</span><br><span class="line">sudo service mongod stop</span><br><span class="line">sudo service mongod restart</span><br></pre></td></tr></table></figure></p><p>  1.4通过yum方式安装完之后，配置文件所在为/etc/mongod.conf</p><h3 id="2、tar包方式安装"><a href="#2、tar包方式安装" class="headerlink" title="2、tar包方式安装"></a>2、tar包方式安装</h3><p> 2.1安装之前需要，安装依赖包：<br> linux-6:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y cyrus-sasl cyrus-sasl-plain cyrus-sasl-gssapi krb5-libs libcurl libpcap net-snmp openldap openssl</span><br></pre></td></tr></table></figure></p><p> linux-7<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y cyrus-sasl cyrus-sasl-gssapi cyrus-sasl-plain krb5-libs libcurl libpcap lm_sensors-libs net-snmp net-snmp-agent-libs openldap openssl rpm-libs tcp_wrappers-libs</span><br></pre></td></tr></table></figure></p><p> 2.2下载mongodb-enterprise软件包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.mongodb.com/linux/mongodb-linux-x86_64-enterprise-rhel70-4.0.0.tgz</span><br></pre></td></tr></table></figure></p><p> 2.3解压软件包，修改目录名称，配置环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> tar -zxvf mongodb-linux-x86_64-enterprise-rhel70-4.0.0.tgz -C /data/</span><br><span class="line"> mv /data/mongodb-linux-x86_64-enterprise-rhel70-4.0.0 /data/mongodb</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export PATH=/data/mongodb/bin:\$PATH"</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p> 2.4修改配置文件<br> cat /data/mongodb/mongodb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line"><span class="attr">  destination:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/data/mongodb/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  dbPath:</span> <span class="string">/data/mongodb/data/</span></span><br><span class="line"><span class="attr">  journal:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line"><span class="attr">  fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line"><span class="attr">  pidFilePath:</span> <span class="string">/data/mongodb/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.51</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p><p> 2.5修改的配置文件中，如果数据目录，日志目录不存在会报错，需要手动配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/&#123;log,data&#125;</span><br></pre></td></tr></table></figure></p><p> 2.6启动mongodb<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;/data/mongodb/bin/mongod -f /data/mongodb/mongodb.conf</span><br><span class="line"> --------</span><br><span class="line"> 2018-08-03T08:42:19.873+0000 I CONTROL  [main] Automatically disabling TLS 1.0, to force-enable TLS 1.0 specify --sslDisabledProtocols <span class="string">'none'</span></span><br><span class="line">about to fork child process, waiting until server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 41022</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure></p><p> 2.7查看mongodb进程：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> netstat -tunlp|grep 30000</span><br><span class="line">---------</span><br><span class="line">tcp        0      0 10.0.7.51:30000         0.0.0.0:*               LISTEN      41022/mongod        </span><br><span class="line">tcp        0      0 127.0.0.1:30000         0.0.0.0:*               LISTEN      41022/mongod</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix3.4监控nginx性能</title>
      <link href="/2018/08/03/zabbix-nginx/"/>
      <url>/2018/08/03/zabbix-nginx/</url>
      <content type="html"><![CDATA[<h2 id="1、查看nginx安装HTTP-Stub-Status"><a href="#1、查看nginx安装HTTP-Stub-Status" class="headerlink" title="1、查看nginx安装HTTP Stub Status"></a>1、查看nginx安装HTTP Stub Status</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openresty -V</span><br></pre></td></tr></table></figure><p>如果”–with-http_stub_status_module”参数，表示没有安装，要手动添加：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">在编译nginx</span> <span class="string">的时候要加上参数</span> <span class="string">–with-http_stub_status_module，</span></span><br><span class="line"><span class="string">执行./configure</span> <span class="string">&amp;&amp;</span> <span class="string">make就可以了，不用make</span> <span class="string">install。不过，一般情况下都是安装了的。</span></span><br></pre></td></tr></table></figure></p><h2 id="2、nginx服务器添加配置"><a href="#2、nginx服务器添加配置" class="headerlink" title="2、nginx服务器添加配置"></a>2、nginx服务器添加配置</h2><p>   2.1添加配置文件nginx_status.conf<br>cat /usr/local/openresty/nginx/conf/conf.d/nginx_status.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line"></span><br><span class="line">    location /basic_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>   2.2重新加载配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openresty -s reload</span><br></pre></td></tr></table></figure></p><p>   2.3获取nginx监控状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1/basic_status</span><br><span class="line">-------------</span><br><span class="line">Active connections: 1 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 572 572 764 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0</span><br></pre></td></tr></table></figure></p><p>   nginx监控参数详解<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Active connections: 对后端发起的活动连接数</span></span><br><span class="line"><span class="comment">## Server accepts handled requests: Nginx 总共处理了 572 个连接，成功创建了 572 次握手（没有失败次数），总共处理了 764 个请求</span></span><br><span class="line"><span class="comment">## Reading: Nginx 读取到客户端的 Header 信息数</span></span><br><span class="line"><span class="comment">## Writing: Nginx 返回给客户端的 Header 信息数</span></span><br><span class="line"><span class="comment">## Waiting: 开启 keep-alive 的情况下，这个值等于 active - ( reading + writing ), 意思是 Nginx 已经处理完成，正在等待下一次请求指令的驻留连接</span></span><br><span class="line"><span class="comment">## 在访问效率很高，请求很快被处理完毕的情况下，Waiting 数比较多是正常的。如果 reading + writing 数较多，则说明并发访问量很大，正在处理过程中</span></span><br></pre></td></tr></table></figure></p><h2 id="3、配置zabbix"><a href="#3、配置zabbix" class="headerlink" title="3、配置zabbix"></a>3、配置zabbix</h2><p>创建存放脚本目录，（我的zabbix安装路径为 /usr/local/zabbix）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/zabbix/script</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/zabbix/script</span><br></pre></td></tr></table></figure></p><p>创建存放数据文件（可自行定义）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch .status.txt</span><br></pre></td></tr></table></figure></p><p>编辑脚本用于获取nginx监控状态参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">server_hostname=127.0.0.1</span></span><br><span class="line"><span class="string">data_file=/usr/local/zabbix/script/.status.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">status_data=\`curl -o \$data_file -s http://\$server_hostname/basic_status\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Active() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Active/&#123;print \$4&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Reading() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Reading/ &#123;print \$3&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Writing() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Writing/ &#123;print \$6&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Waiting() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Waiting/ &#123;print \$9&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\$1"</span> &gt; /usr/<span class="built_in">local</span>/zabbix/script/nginx_connection.sh</span><br></pre></td></tr></table></figure></p><p>修改目录下所有文件的权限，否则脚本写入文件会有权限问题<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R zabbix.zabbix /usr/<span class="built_in">local</span>/zabbix/script</span><br></pre></td></tr></table></figure></p><p>添加zabbix参数到agent配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \<span class="string">"UserParameter=nginx.Active,sh /usr/local/zabbix/script/nginx_connection.sh Active</span></span><br><span class="line"><span class="string">UserParameter=nginx.Writing,sh /usr/local/zabbix/script/nginx_connection.sh Writing</span></span><br><span class="line"><span class="string">UserParameter=nginx.Reading,sh /usr/local/zabbix/script/nginx_connection.sh Reading</span></span><br><span class="line"><span class="string">UserParameter=nginx.Waiting,sh /usr/local/zabbix/script/nginx_connection.sh Waiting\" &gt;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span></span><br></pre></td></tr></table></figure></p><p>重新启动agent客户端：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure></p><p>在server端测试是否能获取到参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/zabbix/bin/zabbix_get -s 10.1.130.47  -k nginx.Active</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Redis] redis-cluster集群部署</title>
      <link href="/2018/08/02/redis-cluster%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/08/02/redis-cluster%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="0、Redis-集群功能限制"><a href="#0、Redis-集群功能限制" class="headerlink" title="0、Redis 集群功能限制"></a>0、Redis 集群功能限制</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Redis集群相对单机在功能上有一定限制。</span></span><br><span class="line"><span class="string">key批量操作支持有限。如：MSET``MGET，目前只支持具有相同slot值的key执行批量操作。</span></span><br><span class="line"><span class="string">key事务操作支持有限。支持多key在同一节点上的事务操作，不支持分布在多个节点的事务功能。</span></span><br><span class="line"><span class="string">key作为数据分区的最小粒度，因此不能将一个大的键值对象映射到不同的节点。如：hash、list。</span></span><br><span class="line"><span class="string">不支持多数据库空间。单机下Redis支持16个数据库，集群模式下只能使用一个数据库空间，即db</span> <span class="number">0</span><span class="string">。</span></span><br><span class="line"><span class="string">复制结构只支持一层，不支持嵌套树状复制结构。</span></span><br></pre></td></tr></table></figure><h2 id="1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下："><a href="#1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下：" class="headerlink" title="1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下："></a>1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">主1：10.0.7.53-6379,</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span><span class="bullet">-6380</span></span><br><span class="line"><span class="string">主2：10.0.7.50-6379,</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.50</span><span class="bullet">-6380</span></span><br><span class="line"><span class="string">主3：10.0.7.51-6379,</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.51</span><span class="bullet">-6380</span></span><br></pre></td></tr></table></figure><h2 id="2、修改redis-conf配置文件"><a href="#2、修改redis-conf配置文件" class="headerlink" title="2、修改redis.conf配置文件"></a>2、修改redis.conf配置文件</h2><p>cat /data/redis/etc/redis6379.conf(不同服务器，修改bind对应的ip即可)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pidfile /data/redis6379/<span class="built_in">log</span>/redis.pid</span><br><span class="line"><span class="built_in">bind</span> 10.0.7.53</span><br><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile /data/redis6379/<span class="built_in">log</span>/redis.log</span><br><span class="line">dir /data/redis6379/</span><br><span class="line">databases 16</span><br><span class="line">maxmemory 1g</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p><p>cat /data/redis/etc/redis6380.conf(不同服务器，修改bind对应的ip即可)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pidfile /data/redis6380/<span class="built_in">log</span>/redis.pid</span><br><span class="line"><span class="built_in">bind</span> 10.0.7.53</span><br><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">logfile /data/redis6380/<span class="built_in">log</span>/redis.log</span><br><span class="line">dir /data/redis6380/</span><br><span class="line">databases 16</span><br><span class="line">maxmemory 1g</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p><p>创建指定的文件目录(指定目录不存在，启动会报错)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/redis6379/<span class="built_in">log</span>/</span><br><span class="line">mkdir -p /data/redis6380/<span class="built_in">log</span>/</span><br></pre></td></tr></table></figure></p><h2 id="3、启动redis服务"><a href="#3、启动redis服务" class="headerlink" title="3、启动redis服务"></a>3、启动redis服务</h2><p>3.1启动服务之前，修改内核参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">添加到开机自动启动/etc/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> &gt;&gt; /etc/rc.local</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"vm.overcommit_memory = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">使修改环境变量生效</span><br><span class="line">sysctl vm.overcommit_memory=1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 511 &gt; /proc/sys/net/core/somaxconn</span><br></pre></td></tr></table></figure></p><p>3.2在三个服务器上，分别启动redis服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-server /data/redis/etc/redis6379.conf</span><br><span class="line">/data/redis/src/redis-server /data/redis/etc/redis6380.conf</span><br></pre></td></tr></table></figure></p><h2 id="4、启动成功之后，在指定的dir目录下回生成一个nodes-conf的文件"><a href="#4、启动成功之后，在指定的dir目录下回生成一个nodes-conf的文件" class="headerlink" title="4、启动成功之后，在指定的dir目录下回生成一个nodes.conf的文件"></a>4、启动成功之后，在指定的dir目录下回生成一个nodes.conf的文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">/data/redis6379/nodes.conf</span></span><br><span class="line"><span class="number">4933</span><span class="string">ef69f73b390098a4431449aeef2e83dacfc0</span> <span class="string">:0@0</span> <span class="string">myself,master</span> <span class="bullet">-</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="string">connected</span></span><br><span class="line"><span class="string">vars</span> <span class="string">currentEpoch</span> <span class="number">0</span> <span class="string">lastVoteEpoch</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>该文件记录了节点信息id，不随主机名和端口的改变而改变。</p><h2 id="5、开始配置集群"><a href="#5、开始配置集群" class="headerlink" title="5、开始配置集群"></a>5、开始配置集群</h2><p>5.1配置集群需要安装ruby<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="bullet">-y</span> <span class="string">ruby</span></span><br><span class="line"><span class="string">安装完成之后运行：</span></span><br><span class="line"><span class="string">gem</span> <span class="string">install</span> <span class="string">redis</span></span><br><span class="line"><span class="string">提示报错：</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">Fetching:</span> <span class="string">redis-4.0.1.gem</span> <span class="string">(100%)</span></span><br><span class="line"><span class="attr">ERROR:</span>  <span class="string">Error</span> <span class="string">installing</span> <span class="attr">redis:</span></span><br><span class="line"><span class="string">redis</span> <span class="string">requires</span> <span class="string">Ruby</span> <span class="string">version</span> <span class="string">&gt;=</span> <span class="number">2.2</span><span class="number">.2</span><span class="string">.</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-----------</span></span><br><span class="line"><span class="string">默认yum安装ruby版本为2.0.0，但是安装redis-trib.rb运行的环境，最少需要ruby-2.2.2版本</span></span><br></pre></td></tr></table></figure></p><p>5.2需要先安装rvm，升级ruby版本<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">安装curl：</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">curl</span></span><br><span class="line"><span class="string">安装RVM</span></span><br><span class="line"><span class="string">curl</span> <span class="bullet">-L</span> <span class="string">get.rvm.io</span> <span class="string">| bash -s stable</span></span><br><span class="line"><span class="string">安装如果提示没有public key,按提示在命令行输入信息：</span></span><br><span class="line"><span class="string">shell&gt; gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</span></span><br><span class="line"><span class="string">-----</span></span><br><span class="line"><span class="string"></span><span class="attr">gpg:</span> <span class="string">Can't</span> <span class="string">check</span> <span class="attr">signature:</span> <span class="literal">No</span> <span class="string">public</span> <span class="string">key</span></span><br><span class="line"><span class="string">Warning,</span> <span class="string">RVM</span> <span class="number">1.26</span><span class="number">.0</span> <span class="string">introduces</span> <span class="string">signed</span> <span class="string">releases</span> <span class="string">and</span> <span class="string">automated</span> <span class="string">check</span> <span class="string">of</span> <span class="string">signatures</span> <span class="string">when</span> <span class="string">GPG</span> <span class="string">software</span> <span class="string">found.</span> <span class="string">Assuming</span> <span class="string">you</span> <span class="string">trust</span> <span class="string">Michal</span> <span class="string">Papis</span> <span class="string">import</span> <span class="string">the</span> <span class="string">mpapis</span> <span class="string">public</span> <span class="string">key</span> <span class="string">(downloading</span> <span class="string">the</span> <span class="string">signatures).</span></span><br><span class="line"></span><br><span class="line"><span class="string">GPG</span> <span class="string">signature</span> <span class="string">verification</span> <span class="string">failed</span> <span class="string">for</span> <span class="string">'/usr/local/rvm/archives/rvm-1.29.4.tgz'</span> <span class="bullet">-</span> <span class="string">'https://github.com/rvm/rvm/releases/download/1.29.4/1.29.4.tar.gz.asc'</span><span class="string">!</span> <span class="string">Try</span> <span class="string">to</span> <span class="string">install</span> <span class="string">GPG</span> <span class="string">v2</span> <span class="string">and</span> <span class="string">then</span> <span class="string">fetch</span> <span class="string">the</span> <span class="string">public</span> <span class="attr">key:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">gpg2</span> <span class="bullet">--recv-keys</span> <span class="number">409</span><span class="string">B6B1796C275462A1703113804BB82D39DC0E3</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-----------------------------</span></span><br><span class="line"><span class="string">使rvm环境变量生效</span></span><br><span class="line"><span class="string">source</span> <span class="string">/usr/local/rvm/scripts/rvm</span></span><br><span class="line"><span class="string">查看rvm库中已知的ruby版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">list</span> <span class="string">known</span></span><br><span class="line"><span class="string">安装一个ruby版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">install</span>  <span class="number">2.5</span><span class="number">.1</span></span><br><span class="line"><span class="string">使用一个ruby版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">use</span>  <span class="number">2.5</span><span class="number">.1</span></span><br><span class="line"><span class="string">卸载已安装的旧版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">remove</span> <span class="number">2.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">查看版本</span></span><br><span class="line"><span class="string">ruby</span>  <span class="bullet">--version</span></span><br></pre></td></tr></table></figure></p><p>5.3再安装redis就可以了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure></p><p>5.4安装完成之后，执行以下命令创建一个新的集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb create --replicas 1 10.0.7.53:6379 10.0.7.53:6380 10.0.7.50:6379 10.0.7.50:6380 10.0.7.51:6379 10.0.7.51:6380</span><br></pre></td></tr></table></figure><p>–replicas 1：该参数代表为每一个主节点增加一个从节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">[ERR] Sorry, can&apos;t connect to node 10.0.7.53:6379</span><br><span class="line">创建集群报错，确认gem版本没有问题，查看配置文件是否存在requirpass等参数</span><br></pre></td></tr></table></figure><p>重新执行创建集群<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">10.0.7.53:6379</span><br><span class="line">10.0.7.50:6379</span><br><span class="line">10.0.7.51:6379</span><br><span class="line">Adding replica 10.0.7.50:6380 to 10.0.7.53:6379</span><br><span class="line">Adding replica 10.0.7.51:6380 to 10.0.7.50:6379</span><br><span class="line">Adding replica 10.0.7.53:6380 to 10.0.7.51:6379</span><br><span class="line">M: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">S: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   replicates 4933ef69f73b390098a4431449aeef2e83dacfc0</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join...</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6379)</span><br><span class="line">M: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">S: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4933ef69f73b390098a4431449aeef2e83dacfc0</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">----------------------------------</span><br></pre></td></tr></table></figure></p><p>5.5集群安装完成，查看集群状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb check 10.0.7.53:6379</span><br><span class="line">（或者 进入控制台/data/redis/src/redis-cli -h  10.0.7.53，输入 CLUSTER nodes)</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6379)</span><br><span class="line">M: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">S: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4933ef69f73b390098a4431449aeef2e83dacfc0</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br></pre></td></tr></table></figure></p><h2 id="6、集群安装完成，测试集群是否正常运行"><a href="#6、集群安装完成，测试集群是否正常运行" class="headerlink" title="6、集群安装完成，测试集群是否正常运行"></a>6、集群安装完成，测试集群是否正常运行</h2><p>6.1杀掉任意一个主节点，从节点自动切换为主，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb check 10.0.7.53:6380</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6380)</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br></pre></td></tr></table></figure></p><p>6.2重新启动别杀掉的节点之后，该节点自动变为从：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb check 10.0.7.53:6380</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6380)</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 5b3aa1532d911e1a9b966ec53e3203a3221056e3</span><br><span class="line">M: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] centos7.4--yum install gcc报错</title>
      <link href="/2018/08/02/centos7.4yum%E5%AE%89%E8%A3%85gcc%E6%8A%A5%E9%94%99/"/>
      <url>/2018/08/02/centos7.4yum%E5%AE%89%E8%A3%85gcc%E6%8A%A5%E9%94%99/</url>
      <content type="html"><![CDATA[<h3 id="yum-install-gcc执行报错如下："><a href="#yum-install-gcc执行报错如下：" class="headerlink" title="[yum install gcc执行报错如下：]"></a>[yum install gcc执行报错如下：]</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Loaded</span> <span class="attr">plugins:</span> <span class="string">fastestmirror,</span> <span class="string">langpacks</span></span><br><span class="line"><span class="string">Loading</span> <span class="string">mirror</span> <span class="string">speeds</span> <span class="string">from</span> <span class="string">cached</span> <span class="string">hostfile</span></span><br><span class="line"><span class="string">Resolving</span> <span class="string">Dependencies</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">gcc.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-28.el7_5.1</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">libgomp</span> <span class="string">=</span> <span class="number">4.8</span><span class="number">.5</span><span class="bullet">-28.</span><span class="string">el7_5.1</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">cpp</span> <span class="string">=</span> <span class="number">4.8</span><span class="number">.5</span><span class="bullet">-28.</span><span class="string">el7_5.1</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc-devel</span> <span class="string">&gt;=</span> <span class="number">2.2</span><span class="number">.90</span><span class="bullet">-12</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">libmpfr.so.4()(64bit)</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">libmpc.so.3()(64bit)</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">cpp.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-28.el7_5.1</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc-devel.x86_64</span> <span class="number">0</span><span class="string">:2.17-222.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc-headers</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-222.</span><span class="string">el7</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-devel-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-222.</span><span class="string">el7</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-devel-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc-headers</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-devel-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">libgomp.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-11.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">updated</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">libgomp.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-28.el7_5.1</span> <span class="string">will</span> <span class="string">be</span> <span class="string">an</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">libmpc.x86_64</span> <span class="number">0</span><span class="string">:1.0.1-3.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">mpfr.x86_64</span> <span class="number">0</span><span class="string">:3.1.1-4.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc.x86_64</span> <span class="number">0</span><span class="string">:2.17-157.el7_3.5</span> <span class="string">will</span> <span class="string">be</span> <span class="string">updated</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc.x86_64</span> <span class="number">0</span><span class="string">:2.17-222.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">an</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc-headers.x86_64</span> <span class="number">0</span><span class="string">:2.17-222.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">kernel-headers</span> <span class="string">&gt;=</span> <span class="number">2.2</span><span class="number">.1</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-headers-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">kernel-headers</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-headers-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc.x86_64</span> <span class="number">0</span><span class="string">:2.17-157.el7_3.5</span> <span class="string">will</span> <span class="string">be</span> <span class="string">updated</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">kernel-headers.x86_64</span> <span class="number">0</span><span class="string">:3.10.0-862.9.1.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Finished</span> <span class="string">Dependency</span> <span class="string">Resolution</span></span><br><span class="line"><span class="attr">Error:</span> <span class="attr">Package:</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span> <span class="string">(@CentOS-Updates)</span></span><br><span class="line"><span class="attr">           Requires:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span></span><br><span class="line"><span class="attr">           Removing:</span> <span class="string">glibc-2.17-157.el7_3.5.x86_64</span> <span class="string">(@CentOS-Updates)</span></span><br><span class="line">               <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span></span><br><span class="line">           <span class="string">Updated</span> <span class="attr">By:</span> <span class="string">glibc-2.17-222.el7.x86_64</span> <span class="string">(base)</span></span><br><span class="line">               <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-222.</span><span class="string">el7</span></span><br><span class="line"> <span class="string">You</span> <span class="string">could</span> <span class="string">try</span> <span class="string">using</span> <span class="bullet">--skip-broken</span> <span class="string">to</span> <span class="string">work</span> <span class="string">around</span> <span class="string">the</span> <span class="string">problem</span></span><br><span class="line"><span class="string">**</span> <span class="string">Found</span> <span class="number">3</span> <span class="string">pre-existing</span> <span class="string">rpmdb</span> <span class="string">problem(s),</span> <span class="string">'yum check'</span> <span class="string">output</span> <span class="attr">follows:</span></span><br><span class="line"><span class="string">glibc-common-2.17-222.el7.x86_64</span> <span class="string">is</span> <span class="string">a</span> <span class="string">duplicate</span> <span class="string">with</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span></span><br><span class="line"><span class="string">glibc-common-2.17-222.el7.x86_64</span> <span class="string">has</span> <span class="string">missing</span> <span class="string">requires</span> <span class="string">of</span> <span class="string">glibc</span> <span class="string">=</span> <span class="string">('0',</span> <span class="string">'2.17'</span><span class="string">,</span> <span class="string">'222.el7'</span><span class="string">)</span></span><br><span class="line"><span class="string">libgcc-4.8.5-28.el7_5.1.x86_64</span> <span class="string">is</span> <span class="string">a</span> <span class="string">duplicate</span> <span class="string">with</span> <span class="string">libgcc-4.8.5-11.el7.x86_64</span></span><br></pre></td></tr></table></figure><p>产生该问题的主要原因是：在系统upgrade的时候，残存了上一个版本的软件包</p><h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="[解决办法：]"></a>[解决办法：]</h3><p>首先安装 yum-utils 套件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure></p><p>执行clean duplicate package　　<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package-cleanup --cleandupes</span><br></pre></td></tr></table></figure></p><p>重新安装glibc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum reinstall glibc glibc-common libgcc</span><br></pre></td></tr></table></figure></p><p>安装完成之后再安装gcc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Redis] redis-sentinel集群配置（一主两从三哨兵）</title>
      <link href="/2018/08/01/redis-sentinel%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE(%E4%B8%80%E4%B8%BB%E4%B8%A4%E4%BB%8E%E4%B8%89%E5%93%A8%E5%85%B5)/"/>
      <url>/2018/08/01/redis-sentinel%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE(%E4%B8%80%E4%B8%BB%E4%B8%A4%E4%BB%8E%E4%B8%89%E5%93%A8%E5%85%B5)/</url>
      <content type="html"><![CDATA[<h1 id="1、所有节点安装redis"><a href="#1、所有节点安装redis" class="headerlink" title="1、所有节点安装redis"></a>1、所有节点安装redis</h1><p>节点信息：<br>主1：10.0.7.53<br>从2：10.0.7.50<br>从3：10.0.7.51<br>除了在三个节点部署redis服务，再分别部署sentinel。</p><h1 id="2、配置主从，在主节点配置文件添加如下配置："><a href="#2、配置主从，在主节点配置文件添加如下配置：" class="headerlink" title="2、配置主从，在主节点配置文件添加如下配置："></a>2、配置主从，在主节点配置文件添加如下配置：</h1><p>主节点1配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pidfile</span> <span class="string">/data/redis/log/redis.pid</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span></span><br><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">daemonize</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">logfile</span> <span class="string">"/data/redis/log/redis.log"</span></span><br><span class="line"><span class="string">databases</span> <span class="number">16</span></span><br><span class="line"><span class="string">maxmemory</span> <span class="number">1</span><span class="string">g</span></span><br><span class="line"><span class="string">requirepass</span> <span class="number">123456</span></span><br><span class="line"><span class="string">masterauth</span> <span class="number">123456</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"><span class="string">repl-ping-slave-period</span> <span class="number">10</span></span><br><span class="line"><span class="string">repl-timeout</span> <span class="number">60</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-backlog-size</span> <span class="number">5</span><span class="string">mb</span></span><br><span class="line"><span class="string">repl-backlog-ttl</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p><p>从节点2配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pidfile</span> <span class="string">/data/redis/log/redis.pid</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.50</span></span><br><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">daemonize</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">logfile</span> <span class="string">"/data/redis/log/redis.log"</span></span><br><span class="line"><span class="string">databases</span> <span class="number">16</span></span><br><span class="line"><span class="string">maxmemory</span> <span class="number">1</span><span class="string">g</span></span><br><span class="line"><span class="string">slaveof</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span> <span class="number">6379</span></span><br><span class="line"><span class="string">masterauth</span> <span class="number">123456</span></span><br><span class="line"><span class="string">requirepass</span> <span class="number">123456</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"><span class="string">repl-ping-slave-period</span> <span class="number">10</span></span><br><span class="line"><span class="string">repl-timeout</span> <span class="number">60</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-backlog-size</span> <span class="number">5</span><span class="string">mb</span></span><br><span class="line"><span class="string">repl-backlog-ttl</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p><p>从节点3配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pidfile</span> <span class="string">/data/redis/log/redis.pid</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.50</span></span><br><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">daemonize</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">logfile</span> <span class="string">"/data/redis/log/redis.log"</span></span><br><span class="line"><span class="string">databases</span> <span class="number">16</span></span><br><span class="line"><span class="string">maxmemory</span> <span class="number">1</span><span class="string">g</span></span><br><span class="line"><span class="string">slaveof</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span> <span class="number">6379</span></span><br><span class="line"><span class="string">masterauth</span> <span class="number">123456</span></span><br><span class="line"><span class="string">requirepass</span> <span class="number">123456</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"><span class="string">repl-ping-slave-period</span> <span class="number">10</span></span><br><span class="line"><span class="string">repl-timeout</span> <span class="number">60</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-backlog-size</span> <span class="number">5</span><span class="string">mb</span></span><br><span class="line"><span class="string">repl-backlog-ttl</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p><p>上面配置相关参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制选项，slave复制对应的master。</span></span><br><span class="line"><span class="string">slaveof</span> <span class="string">&lt;masterip&gt;</span> <span class="string">&lt;masterport&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果master设置了requirepass，那么slave要连上master，需要有master的密码才行。masterauth就是用来配置master的密码，这样可以在连上master后进行认证。</span></span><br><span class="line"><span class="string">masterauth</span> <span class="string">&lt;master-password&gt;</span></span><br><span class="line"><span class="bullet">   -</span><span class="bullet">------------------------------------</span></span><br><span class="line">   <span class="string">如果主库配置了密码，从库没有添加这行数据，会报一下错误：</span></span><br><span class="line">   <span class="comment"># Unexpected reply to PSYNC from master: -NOAUTH Authentication required.</span></span><br><span class="line">   <span class="string">*</span> <span class="string">Retrying</span> <span class="string">with</span> <span class="string">SYNC...</span></span><br><span class="line">   <span class="comment"># MASTER aborted replication with an error: NOAUTH Authentication required.</span></span><br><span class="line"><span class="bullet">   -</span><span class="bullet">------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：1) 如果slave-serve-stale-data设置为yes(默认设置)，从库会继续响应客户端的请求。2) 如果slave-serve-stale-data设置为no，除去INFO和SLAVOF命令之外的任何请求都会返回一个错误”SYNC with master in progress”。</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#作为从服务器，默认情况下是只读的（yes），可以修改成NO，用于写（不建议）。</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否使用socket方式复制数据。目前redis复制提供两种方式，disk和socket。如果新的slave连上来或者重连的slave无法部分同步，就会执行全量同步，master会生成rdb文件。有2种方式：disk方式是master创建一个新的进程把rdb文件保存到磁盘，再把磁盘上的rdb文件传递给slave。socket是master创建一个新的进程，直接把rdb文件以socket的方式发给slave。disk方式的时候，当一个rdb保存的过程中，多个slave都能共享这个rdb文件。socket的方式就的一个个slave顺序复制。在磁盘速度缓慢，网速快的情况下推荐用socket方式。</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#diskless复制的延迟时间，防止设置为0。一旦复制开始，节点不会再接收新slave的复制请求直到下一个rdb传输。所以最好等待一段时间，等更多的slave连上来。</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#slave根据指定的时间间隔向服务器发送ping请求。时间间隔可以通过 repl_ping_slave_period 来设置，默认10秒。</span></span><br><span class="line"><span class="comment"># repl-ping-slave-period 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#复制连接超时时间。master和slave都有超时时间的设置。master检测到slave上次发送的时间超过repl-timeout，即认为slave离线，清除该slave信息。slave检测到上次和master交互的时间超过repl-timeout，则认为master离线。需要注意的是repl-timeout需要设置一个比repl-ping-slave-period更大的值，不然会经常检测到超时。</span></span><br><span class="line"><span class="comment"># repl-timeout 60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否禁止复制tcp链接的tcp nodelay参数，可传递yes或者no。默认是no，即使用tcp nodelay。如果master设置了yes来禁止tcp nodelay设置，在把数据复制给slave的时候，会减少包的数量和更小的网络带宽。但是这也可能带来数据的延迟。默认我们推荐更小的延迟，但是在数据量传输很大的场景下，建议选择yes。</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#复制缓冲区大小，这是一个环形复制缓冲区，用来保存最新复制的命令。这样在slave离线的时候，不需要完全复制master的数据，如果可以执行部分同步，只需要把缓冲区的部分数据复制给slave，就能恢复正常复制状态。缓冲区的大小越大，slave离线的时间可以更长，复制缓冲区只有在有slave连接的时候才分配内存。没有slave的一段时间，内存会被释放出来，默认1m。</span></span><br><span class="line"><span class="comment"># repl-backlog-size 5mb</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master没有slave一段时间会释放复制缓冲区的内存，repl-backlog-ttl用来设置该时间长度。单位为秒。</span></span><br><span class="line"><span class="comment"># repl-backlog-ttl 3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当master不可用，Sentinel会根据slave的优先级选举一个master。最低的优先级的slave，当选master。而配置成0，永远不会被选举。</span></span><br><span class="line"><span class="string">slave-priority</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#redis提供了可以让master停止写入的方式，如果配置了min-slaves-to-write，健康的slave的个数小于N，mater就禁止写入。master最少得有多少个健康的slave存活才能执行写命令。这个配置虽然不能保证N个slave都一定能接收到master的写操作，但是能避免没有足够健康的slave的时候，master不能写入来避免数据丢失。设置为0是关闭该功能。</span></span><br><span class="line"><span class="comment"># min-slaves-to-write 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#延迟小于min-slaves-max-lag秒的slave才认为是健康的slave。</span></span><br><span class="line"><span class="comment"># min-slaves-max-lag 10</span></span><br></pre></td></tr></table></figure></p><h1 id="3、修改哨兵配置文件"><a href="#3、修改哨兵配置文件" class="headerlink" title="3、修改哨兵配置文件"></a>3、修改哨兵配置文件</h1><p>cat sentinel.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">dir <span class="string">"/tmp/sentinel"</span></span><br><span class="line">logfile <span class="string">"/tmp/sentinel.log"</span></span><br><span class="line">daemonize yes</span><br><span class="line">sentinel monitor mymaster 10.0.7.53 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel config-epoch mymaster 2</span><br><span class="line">sentinel leader-epoch mymaster 2</span><br><span class="line">sentinel known-slave mymaster 10.0.7.51 6379</span><br><span class="line">sentinel known-slave mymaster 10.0.7.50 6379</span><br><span class="line">sentinel current-epoch 2</span><br><span class="line">protected-mode no</span><br></pre></td></tr></table></figure></p><p>指定的dir路径若不存在需要手动创建：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/sentinel</span><br></pre></td></tr></table></figure></p><p>sentinel相关配置参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sentinel monitor mymaster 10.0.7.53 6379 2</span></span><br><span class="line"><span class="string">//</span> <span class="string">当前Sentinel节点监控</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:6379</span> <span class="string">这个主节点</span></span><br><span class="line"><span class="string">//</span> <span class="number">2</span><span class="string">代表判断主节点失败至少需要2个Sentinel节点节点同意</span></span><br><span class="line"><span class="string">//</span> <span class="string">mymaster是主节点的别名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel down-after-milliseconds mymaster 30000</span></span><br><span class="line"><span class="string">//每个Sentinel节点都要定期PING命令来判断Redis数据节点和其余Sentinel节点是否可达，如果超过30000毫秒且没有回复，则判定不可达</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel parallel-syncs mymaster 1</span></span><br><span class="line"><span class="string">//当Sentinel节点集合对主节点故障判定达成一致时，Sentinel领导者节点会做故障转移操作，选出新的主节点，原来的从节点会向新的主节点发起复制操作，限制每次向新的主节点发起复制操作的从节点个数为1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel failover-timeout mymaster 180000</span></span><br><span class="line"><span class="string">//故障转移超时时间为180000毫秒</span></span><br></pre></td></tr></table></figure></p><h1 id="4、启动服务"><a href="#4、启动服务" class="headerlink" title="4、启动服务"></a>4、启动服务</h1><p>各服务器启动redis服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-server /data/redis/etc/redis.conf</span><br></pre></td></tr></table></figure></p><p>各服务器启动sentinel服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-sentinel /data/redis/sentinel.conf</span><br></pre></td></tr></table></figure></p><p>查看集群信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-cli -h 127.0.0.1 -p 26379 INFO Sentinel</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Python] python-2.7升级到python-3.7</title>
      <link href="/2018/07/30/python-2.7%E5%8D%87%E7%BA%A7%E5%88%B0python-3.7/"/>
      <url>/2018/07/30/python-2.7%E5%8D%87%E7%BA%A7%E5%88%B0python-3.7/</url>
      <content type="html"><![CDATA[<h1 id="下载、解压python3-7"><a href="#下载、解压python3-7" class="headerlink" title="[下载、解压python3.7]"></a>[下载、解压python3.7]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tar.xz</span><br><span class="line">tar -xvf Python-3.7.0.tar.xz</span><br></pre></td></tr></table></figure><h1 id="安装编译"><a href="#安装编译" class="headerlink" title="[安装编译]"></a>[安装编译]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Python-3.7.0/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python3.7</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h1 id="安装报错"><a href="#安装报错" class="headerlink" title="[安装报错]"></a>[安装报错]</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ModuleNotFoundError:</span> <span class="literal">No</span> <span class="string">module</span> <span class="string">named</span> <span class="string">'_ctypes'</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">***</span> <span class="string">[install]</span> <span class="string">Error</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>解决方法：<br> 安装libffi-devel<br> yum install libffi-devel<br> 重新编译安装<br> make &amp;&amp; make install</p><h1 id="备份旧版本的python"><a href="#备份旧版本的python" class="headerlink" title="[备份旧版本的python]"></a>[备份旧版本的python]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ll /usr/bin/python*</span><br><span class="line">lrwxrwxrwx. 1 root root    7 Apr 10 19:35 /usr/bin/python -&gt; python2</span><br><span class="line">lrwxrwxrwx. 1 root root    9 Apr 10 19:35 /usr/bin/python2 -&gt; python2.7</span><br><span class="line">-rwxr-xr-x. 1 root root 7136 Aug  4  2017 /usr/bin/python2.7</span><br><span class="line">-------------------------</span><br><span class="line">一般自带系统已经做好了python2.7的备份，直接替换掉python即可</span><br><span class="line"></span><br><span class="line">如果没有备份，使用一些命令备份：</span><br><span class="line">mv /usr/bin/python /usr/bin/python_old  <span class="comment">#备份旧的python</span></span><br></pre></td></tr></table></figure><h1 id="新版本python软连接到python"><a href="#新版本python软连接到python" class="headerlink" title="[新版本python软连接到python]"></a>[新版本python软连接到python]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/bin/python <span class="comment">#需要删除旧版的python,否则报错</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/python3.7/bin/python3.7 /usr/bin/python <span class="comment">#添加软连接</span></span><br><span class="line">python -V <span class="comment">#查看python版本</span></span><br><span class="line">2.7版本没有pip,升级到python3.7后，自带有pip,做一个pip的软连接即可</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/python3.7/bin/pip3 /usr/bin/pip</span><br></pre></td></tr></table></figure><h1 id="升级完python之后，yum命令失效，需修改配置文件"><a href="#升级完python之后，yum命令失效，需修改配置文件" class="headerlink" title="[升级完python之后，yum命令失效，需修改配置文件]"></a>[升级完python之后，yum命令失效，需修改配置文件]</h1><p>使用yum命令报以下错误：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span></span><br><span class="line">  <span class="string">File</span> <span class="string">"/usr/bin/yum"</span><span class="string">,</span> <span class="string">line</span> <span class="number">30</span></span><br><span class="line">    <span class="string">except</span> <span class="string">KeyboardInterrupt,</span> <span class="attr">e:</span></span><br><span class="line">                            <span class="string">^</span></span><br><span class="line"><span class="attr">SyntaxError:</span> <span class="string">invalid</span> <span class="string">syntax</span></span><br></pre></td></tr></table></figure></p><p>解决 yum 不可用：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">修改/usr/bin/yum配置文件</span></span><br><span class="line"><span class="comment">#!/usr/bin/python    改成：    #!/usr/bin/python2.7</span></span><br><span class="line"><span class="string">重新测试yum是否正常：</span></span><br><span class="line"><span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span></span><br></pre></td></tr></table></figure></p><h1 id="升级完python之后，yum使用过程中，额外问题："><a href="#升级完python之后，yum使用过程中，额外问题：" class="headerlink" title="[升级完python之后，yum使用过程中，额外问题：]"></a>[升级完python之后，yum使用过程中，额外问题：]</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">tree</span> <span class="bullet">-y</span> </span><br><span class="line"><span class="bullet">-</span><span class="bullet">---------------------------------</span></span><br><span class="line"><span class="string">报错：</span></span><br><span class="line"><span class="string">File</span> <span class="string">"/usr/libexec/urlgrabber-ext-down"</span><span class="string">,</span> <span class="string">line</span> <span class="number">28</span></span><br><span class="line">    <span class="string">except</span> <span class="string">OSError,</span> <span class="attr">e:</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--------------------------------</span></span><br></pre></td></tr></table></figure><p>解决方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">修改/usr/libexec/urlgrabber-ext-down配置文件</span><br><span class="line"><span class="comment">#!/usr/bin/python    改成：    #!/usr/bin/python2.7</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
  
  
    
    <entry>
      <title>About Me</title>
      <link href="/about/index.html"/>
      <url>/about/index.html</url>
      <content type="html"><![CDATA[<blockquote><p>愿你被这个世界温柔以待，即使生活总以刻薄荒芜相欺！</p></blockquote>]]></content>
    </entry>
    
    <entry>
      <title>tags</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      <content type="html"><![CDATA[]]></content>
    </entry>
    
  
</search>
