<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>[Sqlserver] Sqlserver2017数据库导入低版本sqlserver2016数据库</title>
      <link href="/2019/01/14/sqlserver2017%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5sqlserver2016/"/>
      <url>/2019/01/14/sqlserver2017%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5sqlserver2016/</url>
      <content type="html"><![CDATA[<h4 id="1、源库操作"><a href="#1、源库操作" class="headerlink" title="1、源库操作"></a>1、源库操作</h4><p>通过sqlserver manager studio登录sqlserver2017，对要备份的库进行操作：tasks–&gt;Generate scripts<br><img src="https://i.imgur.com/3QLtong.jpg" alt=""><br>点击下一步Next：<br><img src="https://i.imgur.com/TgGqSV7.png" alt=""><br>可以选择要备份整个库，还是只备份这个库的某个对象，我们这里备份整个库：<br><img src="https://i.imgur.com/Qrh498i.png" alt=""><br>点击下一步，点击advanced，进行编辑，将Script for server version修改为要目标库的版本（sqlserver2016）,Type of data to script改为Schema and data：<br><img src="https://i.imgur.com/JKIEDUd.png" alt=""><br>修改备份的路径，点击next:<br><img src="https://i.imgur.com/ncNCo1R.jpg" alt=""><br>开始导出数据：<br><img src="https://i.imgur.com/9iFyYH9.png" alt=""></p><h4 id="2、目标库操作"><a href="#2、目标库操作" class="headerlink" title="2、目标库操作"></a>2、目标库操作</h4><p>数据导出完成之后，将备份的数据拷贝到目标端服务器，目录根据自己需求定义，然后通过management studio登录sqlserver2016数据库（这里安装sqlserver2016的过程中，发现没有自带managerment studio管理软件，需要自己单独安装，sqlserver2016 management studio下载链接，点击<a href="https://download.microsoft.com/download/9/3/3/933EA6DD-58C5-4B78-8BEC-2DF389C72BE0/SSMS-Setup-ENU.exe" target="_blank" rel="noopener">此处</a></p><p>登录management studio打开拷贝过来的脚本，修改脚本：<br>将数据路径和日志路径修改为本地的sqlserver路径，如果database已经建立了，可以把create database参数改为use<br><img src="https://i.imgur.com/3JeTUFi.jpg" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> sqlserver </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] oracle修改字符集</title>
      <link href="/2019/01/09/oracle%20%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86/"/>
      <url>/2019/01/09/oracle%20%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E9%9B%86/</url>
      <content type="html"><![CDATA[<h4 id="0、查看数据库字符集"><a href="#0、查看数据库字符集" class="headerlink" title="0、查看数据库字符集"></a>0、查看数据库字符集</h4><p>1)数据库服务器字符集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from nls_database_parameters;</span><br></pre></td></tr></table></figure></p><p>来源于props$，是表示数据库的字符集。<br>2)客户端字符集环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from nls_instance_parameters;</span><br></pre></td></tr></table></figure></p><p>其来源于v$parameter，表示客户端的字符集的设置，可能是参数文件，环境变量或者是注册表<br>3)会话字符集环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from nls_session_parameters;</span><br></pre></td></tr></table></figure></p><p>来源于v$nls_parameters，表示会话自己的设置，可能是会话的环境变量或者是alter session完成，如果会话没有特殊的设置，将与nls_instance_parameters一致。</p><h4 id="1、字符集由AL32UTF8修改为ZHS16GBK"><a href="#1、字符集由AL32UTF8修改为ZHS16GBK" class="headerlink" title="1、字符集由AL32UTF8修改为ZHS16GBK"></a>1、字符集由AL32UTF8修改为ZHS16GBK</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">13:51:26 SYS@ boston&gt; select * from nls_database_parameters;</span><br><span class="line"></span><br><span class="line">PARAMETER                                                    VALUE</span><br><span class="line">------------------------------------------------------------ --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">NLS_LANGUAGE                                                 AMERICAN</span><br><span class="line">NLS_TERRITORY                                                AMERICA</span><br><span class="line">NLS_CURRENCY                                                 $</span><br><span class="line">NLS_ISO_CURRENCY                                             AMERICA</span><br><span class="line">NLS_NUMERIC_CHARACTERS                                       .,</span><br><span class="line">NLS_CHARACTERSET                                             AL32UTF8</span><br><span class="line">NLS_CALENDAR                                                 GREGORIAN</span><br><span class="line">NLS_DATE_FORMAT                                              DD-MON-RR</span><br><span class="line">NLS_DATE_LANGUAGE                                            AMERICAN</span><br><span class="line">NLS_SORT                                                     BINARY</span><br><span class="line">NLS_TIME_FORMAT                                              HH.MI.SSXFF AM</span><br><span class="line">NLS_TIMESTAMP_FORMAT                                         DD-MON-RR HH.MI.SSXFF AM</span><br><span class="line">NLS_TIME_TZ_FORMAT                                           HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_TIMESTAMP_TZ_FORMAT                                      DD-MON-RR HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_DUAL_CURRENCY                                            $</span><br><span class="line">NLS_COMP                                                     BINARY</span><br><span class="line">NLS_LENGTH_SEMANTICS                                         BYTE</span><br><span class="line">NLS_NCHAR_CONV_EXCP                                          FALSE</span><br><span class="line">NLS_NCHAR_CHARACTERSET                                       AL16UTF16</span><br><span class="line">NLS_RDBMS_VERSION                                            11.2.0.4.0</span><br></pre></td></tr></table></figure><p>提示要修改的新的字符集必须大于旧的字符集才可以<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">13:51:36 SYS@ boston&gt; ALTER DATABASE CHARACTER SET ZHS16GBK;</span><br><span class="line">ALTER DATABASE CHARACTER SET ZHS16GBK</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-12712: new character set must be a superset of old character set</span><br></pre></td></tr></table></figure></p><p>跳过超集的检查<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">13:59:34 SYS@ boston&gt; alter system enable restricted session; </span><br><span class="line">System altered.</span><br><span class="line">Elapsed: 00:00:02.05</span><br><span class="line">13:59:48 SYS@ boston&gt; ALTER DATABASE character set INTERNAL_USE ZHS16GBK;</span><br><span class="line">ALTER DATABASE character set INTERNAL_USE ZHS16GBK</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-12721: operation cannot execute when other sessions are active</span><br></pre></td></tr></table></figure></p><p>查看当前活动的会话<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">14:02:48 SYS@ boston&gt; select sid, serial#,program ,status from v$session;</span><br><span class="line"></span><br><span class="line">       SID    SERIAL# PROGRAM                                                                                          STATUS</span><br><span class="line">---------- ---------- ------------------------------------------------------------------------------------------------ ----------------</span><br><span class="line">         1          1 oracle@dax-mysql-slave (VKTM)                                                                    ACTIVE</span><br><span class="line">         2          1 oracle@dax-mysql-slave (DIA0)                                                                    ACTIVE</span><br><span class="line">         3          1 oracle@dax-mysql-slave (CKPT)                                                                    ACTIVE</span><br><span class="line">         4          3 oracle@dax-mysql-slave (MMNL)                                                                    ACTIVE</span><br><span class="line">         6         11 oracle@dax-mysql-slave (SMCO)                                                                    ACTIVE</span><br><span class="line">       101          1 oracle@dax-mysql-slave (GEN0)                                                                    ACTIVE</span><br><span class="line">       102          1 oracle@dax-mysql-slave (MMAN)                                                                    ACTIVE</span><br><span class="line">       103          1 oracle@dax-mysql-slave (SMON)                                                                    ACTIVE</span><br><span class="line">       105       1603 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              ACTIVE</span><br><span class="line">       201          1 oracle@dax-mysql-slave (PMON)                                                                    ACTIVE</span><br><span class="line">       202          1 oracle@dax-mysql-slave (DIAG)                                                                    ACTIVE</span><br><span class="line">       203          1 oracle@dax-mysql-slave (DBW0)                                                                    ACTIVE</span><br><span class="line">       204          1 oracle@dax-mysql-slave (RECO)                                                                    ACTIVE</span><br><span class="line">       207        145 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              INACTIVE</span><br><span class="line">       301        291 oracle@dax-mysql-slave (W000)                                                                    ACTIVE</span><br><span class="line">       302          1 oracle@dax-mysql-slave (PSP0)                                                                    ACTIVE</span><br><span class="line">       303          1 oracle@dax-mysql-slave (DBRM)                                                                    ACTIVE</span><br><span class="line">       304          1 oracle@dax-mysql-slave (LGWR)                                                                    ACTIVE</span><br><span class="line">       305          3 oracle@dax-mysql-slave (MMON)                                                                    ACTIVE</span><br><span class="line">       306        199 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              INACTIVE</span><br></pre></td></tr></table></figure></p><p>查看当前会话的sid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:02:56 SYS@ boston&gt; select userenv(&apos;sid&apos;) from dual;</span><br><span class="line">USERENV(&apos;SID&apos;)</span><br><span class="line">--------------</span><br><span class="line">           105</span><br></pre></td></tr></table></figure></p><p>尝试杀掉sqlplus连接进来的两个inactive的会话<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">14:06:46 SYS@ boston&gt; alter system kill session &apos;207,145&apos;;</span><br><span class="line">System altered.</span><br><span class="line">Elapsed: 00:00:00.00</span><br><span class="line">14:07:11 SYS@ boston&gt; alter system kill session &apos;306,199&apos;;</span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">14:07:27 SYS@ boston&gt; select sid, serial#,program ,status from v$session;</span><br><span class="line"></span><br><span class="line">       SID    SERIAL# PROGRAM                                                                                          STATUS</span><br><span class="line">---------- ---------- ------------------------------------------------------------------------------------------------ ----------------</span><br><span class="line">         1          1 oracle@dax-mysql-slave (VKTM)                                                                    ACTIVE</span><br><span class="line">         2          1 oracle@dax-mysql-slave (DIA0)                                                                    ACTIVE</span><br><span class="line">         3          1 oracle@dax-mysql-slave (CKPT)                                                                    ACTIVE</span><br><span class="line">         4          3 oracle@dax-mysql-slave (MMNL)                                                                    ACTIVE</span><br><span class="line">         6         11 oracle@dax-mysql-slave (SMCO)                                                                    ACTIVE</span><br><span class="line">       101          1 oracle@dax-mysql-slave (GEN0)                                                                    ACTIVE</span><br><span class="line">       102          1 oracle@dax-mysql-slave (MMAN)                                                                    ACTIVE</span><br><span class="line">       103          1 oracle@dax-mysql-slave (SMON)                                                                    ACTIVE</span><br><span class="line">       105       1603 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              ACTIVE</span><br><span class="line">       201          1 oracle@dax-mysql-slave (PMON)                                                                    ACTIVE</span><br><span class="line">       202          1 oracle@dax-mysql-slave (DIAG)                                                                    ACTIVE</span><br><span class="line">       203          1 oracle@dax-mysql-slave (DBW0)                                                                    ACTIVE</span><br><span class="line">       204          1 oracle@dax-mysql-slave (RECO)                                                                    ACTIVE</span><br><span class="line">       207        145 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              KILLED</span><br><span class="line">       302          1 oracle@dax-mysql-slave (PSP0)                                                                    ACTIVE</span><br><span class="line">       303          1 oracle@dax-mysql-slave (DBRM)                                                                    ACTIVE</span><br><span class="line">       304          1 oracle@dax-mysql-slave (LGWR)                                                                    ACTIVE</span><br><span class="line">       305          3 oracle@dax-mysql-slave (MMON)                                                                    ACTIVE</span><br><span class="line">       306        199 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              KILLED</span><br></pre></td></tr></table></figure></p><p>再次执行仍然提示有活动会话<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">14:07:29 SYS@ boston&gt;  ALTER DATABASE character set INTERNAL_USE ZHS16GBK;</span><br><span class="line"> ALTER DATABASE character set INTERNAL_USE ZHS16GBK</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-12721: operation cannot execute when other sessions are active</span><br></pre></td></tr></table></figure></p><p>重启数据库再次修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">14:10:54 SYS@ boston&gt; shutdown immeidate</span><br><span class="line">SP2-0717: illegal SHUTDOWN option</span><br><span class="line">14:11:02 SYS@ boston&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">14:11:16 SYS@ boston&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1603411968 bytes</span><br><span class="line">Fixed Size                  2253664 bytes</span><br><span class="line">Variable Size             503319712 bytes</span><br><span class="line">Database Buffers         1090519040 bytes</span><br><span class="line">Redo Buffers                7319552 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br><span class="line">14:11:46 SYS@ boston&gt; select sid, serial#,program ,status from v$session;</span><br><span class="line">       SID    SERIAL# PROGRAM                                                                                          STATUS</span><br><span class="line">---------- ---------- ------------------------------------------------------------------------------------------------ ----------------</span><br><span class="line">         1          1 oracle@dax-mysql-slave (VKTM)                                                                    ACTIVE</span><br><span class="line">         2          1 oracle@dax-mysql-slave (DIA0)                                                                    ACTIVE</span><br><span class="line">         3          1 oracle@dax-mysql-slave (CKPT)                                                                    ACTIVE</span><br><span class="line">         4          1 oracle@dax-mysql-slave (MMNL)                                                                    ACTIVE</span><br><span class="line">       101          1 oracle@dax-mysql-slave (GEN0)                                                                    ACTIVE</span><br><span class="line">       102          1 oracle@dax-mysql-slave (MMAN)                                                                    ACTIVE</span><br><span class="line">       103          1 oracle@dax-mysql-slave (SMON)                                                                    ACTIVE</span><br><span class="line">       201          1 oracle@dax-mysql-slave (PMON)                                                                    ACTIVE</span><br><span class="line">       202          1 oracle@dax-mysql-slave (DIAG)                                                                    ACTIVE</span><br><span class="line">       203          1 oracle@dax-mysql-slave (DBW0)                                                                    ACTIVE</span><br><span class="line">       204          1 oracle@dax-mysql-slave (RECO)                                                                    ACTIVE</span><br><span class="line">       301          5 sqlplus@dax-mysql-slave (TNS V1-V3)                                                              ACTIVE</span><br><span class="line">       302          1 oracle@dax-mysql-slave (PSP0)                                                                    ACTIVE</span><br><span class="line">       303          1 oracle@dax-mysql-slave (DBRM)                                                                    ACTIVE</span><br><span class="line">       304          1 oracle@dax-mysql-slave (LGWR)                                                                    ACTIVE</span><br><span class="line">       305          1 oracle@dax-mysql-slave (MMON)                                                                    ACTIVE</span><br><span class="line">16 rows selected.</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.03</span><br><span class="line">14:11:47 SYS@ boston&gt;  alter system enable restricted session; </span><br><span class="line">System altered.</span><br><span class="line">Elapsed: 00:00:02.04</span><br><span class="line">14:12:00 SYS@ boston&gt;  ALTER DATABASE character set INTERNAL_USE ZHS16GBK;</span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure></p><p>修改完成再次重启数据库，（修改完字符集之后关闭数据库会花费很长时间）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">14:12:13 SYS@ boston&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">14:18:21 SYS@ boston&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1603411968 bytes</span><br><span class="line">Fixed Size                  2253664 bytes</span><br><span class="line">Variable Size             503319712 bytes</span><br><span class="line">Database Buffers         1090519040 bytes</span><br><span class="line">Redo Buffers                7319552 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br></pre></td></tr></table></figure></p><p>查看字符集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">14:19:40 SYS@ boston&gt; select * from nls_database_parameters;</span><br><span class="line"></span><br><span class="line">PARAMETER                      VALUE</span><br><span class="line">------------------------------ --------------------------------------------------------------------------------</span><br><span class="line">NLS_LANGUAGE                   AMERICAN</span><br><span class="line">NLS_TERRITORY                  AMERICA</span><br><span class="line">NLS_CURRENCY                   $</span><br><span class="line">NLS_ISO_CURRENCY               AMERICA</span><br><span class="line">NLS_NUMERIC_CHARACTERS         .,</span><br><span class="line">NLS_CHARACTERSET               ZHS16GBK</span><br><span class="line">NLS_CALENDAR                   GREGORIAN</span><br><span class="line">NLS_DATE_FORMAT                DD-MON-RR</span><br><span class="line">NLS_DATE_LANGUAGE              AMERICAN</span><br><span class="line">NLS_SORT                       BINARY</span><br><span class="line">NLS_TIME_FORMAT                HH.MI.SSXFF AM</span><br><span class="line">NLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM</span><br><span class="line">NLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_DUAL_CURRENCY              $</span><br><span class="line">NLS_COMP                       BINARY</span><br><span class="line">NLS_LENGTH_SEMANTICS           BYTE</span><br><span class="line">NLS_NCHAR_CONV_EXCP            FALSE</span><br><span class="line">NLS_NCHAR_CHARACTERSET         AL16UTF16</span><br><span class="line">NLS_RDBMS_VERSION              11.2.0.4.0</span><br><span class="line">20 rows selected.</span><br></pre></td></tr></table></figure></p><p>字符集修改完成,数据库的字符集更改会出现乱码，操作要慎重。</p><h4 id="2、数据库字符集由ZHS16GBK改为AL32UTF8"><a href="#2、数据库字符集由ZHS16GBK改为AL32UTF8" class="headerlink" title="2、数据库字符集由ZHS16GBK改为AL32UTF8"></a>2、数据库字符集由ZHS16GBK改为AL32UTF8</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">15:01:20 SYS@ boston&gt; select * from nls_database_parameters;</span><br><span class="line"></span><br><span class="line">PARAMETER                      VALUE</span><br><span class="line">------------------------------ --------------------------------------------------------------------------------</span><br><span class="line">NLS_LANGUAGE                   AMERICAN</span><br><span class="line">NLS_TERRITORY                  AMERICA</span><br><span class="line">NLS_CURRENCY                   $</span><br><span class="line">NLS_ISO_CURRENCY               AMERICA</span><br><span class="line">NLS_NUMERIC_CHARACTERS         .,</span><br><span class="line">NLS_CHARACTERSET               ZHS16GBK</span><br><span class="line">NLS_CALENDAR                   GREGORIAN</span><br><span class="line">NLS_DATE_FORMAT                DD-MON-RR</span><br><span class="line">NLS_DATE_LANGUAGE              AMERICAN</span><br><span class="line">NLS_SORT                       BINARY</span><br><span class="line">NLS_TIME_FORMAT                HH.MI.SSXFF AM</span><br><span class="line">NLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM</span><br><span class="line">NLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_DUAL_CURRENCY              $</span><br><span class="line">NLS_COMP                       BINARY</span><br><span class="line">NLS_LENGTH_SEMANTICS           BYTE</span><br><span class="line">NLS_NCHAR_CONV_EXCP            FALSE</span><br><span class="line">NLS_NCHAR_CHARACTERSET         AL16UTF16</span><br><span class="line">NLS_RDBMS_VERSION              11.2.0.4.0</span><br><span class="line">20 rows selected.</span><br><span class="line">15:05:51 SYS@ boston&gt; alter system enable restricted session; </span><br><span class="line">System altered.</span><br><span class="line">Elapsed: 00:00:02.06</span><br><span class="line">15:07:05 SYS@ boston&gt; ALTER DATABASE character set  AL32UTF8; </span><br><span class="line">ALTER DATABASE character set  AL32UTF8</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-12712: new character set must be a superset of old character set</span><br><span class="line">Elapsed: 00:00:00.00</span><br></pre></td></tr></table></figure><p>这个报错证明AL32UTF8字符集并不是ZHS16GBK超集。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">15:07:12 SYS@ boston&gt; ALTER DATABASE character set INTERNAL_USE AL32UTF8; </span><br><span class="line">ALTER DATABASE character set INTERNAL_USE AL32UTF8</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-12721: operation cannot execute when other sessions are active</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.01</span><br><span class="line">15:07:23 SYS@ boston&gt; select sid, serial#,program ,status from v$session;</span><br><span class="line"></span><br><span class="line">       SID    SERIAL# PROGRAM                                          STATUS</span><br><span class="line">---------- ---------- ------------------------------------------------ --------</span><br><span class="line">         1          1 oracle@dax-mysql-slave (VKTM)                    ACTIVE</span><br><span class="line">         2          1 oracle@dax-mysql-slave (DIA0)                    ACTIVE</span><br><span class="line">         3          1 oracle@dax-mysql-slave (CKPT)                    ACTIVE</span><br><span class="line">         4          3 oracle@dax-mysql-slave (MMNL)                    ACTIVE</span><br><span class="line">         7          5 oracle@dax-mysql-slave (SMCO)                    ACTIVE</span><br><span class="line">       101          1 oracle@dax-mysql-slave (GEN0)                    ACTIVE</span><br><span class="line">       102          1 oracle@dax-mysql-slave (MMAN)                    ACTIVE</span><br><span class="line">       103          1 oracle@dax-mysql-slave (SMON)                    ACTIVE</span><br><span class="line">       104         27 oracle@dax-mysql-slave (W000)                    ACTIVE</span><br><span class="line">       201          1 oracle@dax-mysql-slave (PMON)                    ACTIVE</span><br><span class="line">       202          1 oracle@dax-mysql-slave (DIAG)                    ACTIVE</span><br><span class="line">       203          1 oracle@dax-mysql-slave (DBW0)                    ACTIVE</span><br><span class="line">       204          1 oracle@dax-mysql-slave (RECO)                    ACTIVE</span><br><span class="line">       205         15 sqlplus@dax-mysql-slave (TNS V1-V3)              INACTIVE</span><br><span class="line">       301         15 sqlplus@dax-mysql-slave (TNS V1-V3)              INACTIVE</span><br><span class="line">       302          1 oracle@dax-mysql-slave (PSP0)                    ACTIVE</span><br><span class="line">       303          1 oracle@dax-mysql-slave (DBRM)                    ACTIVE</span><br><span class="line">       304          1 oracle@dax-mysql-slave (LGWR)                    ACTIVE</span><br><span class="line">       305          3 oracle@dax-mysql-slave (MMON)                    ACTIVE</span><br><span class="line">       306        139 sqlplus@dax-mysql-slave (TNS V1-V3)              ACTIVE</span><br><span class="line"></span><br><span class="line">20 rows selected.</span><br><span class="line">Elapsed: 00:00:00.01</span><br><span class="line">15:07:36 SYS@ boston&gt; shutdown immediate</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">15:07:55 SYS@ boston&gt; startup</span><br><span class="line">ORACLE instance started.</span><br><span class="line"></span><br><span class="line">Total System Global Area 1603411968 bytes</span><br><span class="line">Fixed Size                  2253664 bytes</span><br><span class="line">Variable Size             503319712 bytes</span><br><span class="line">Database Buffers         1090519040 bytes</span><br><span class="line">Redo Buffers                7319552 bytes</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br><span class="line">15:08:38 SYS@ boston&gt; </span><br><span class="line">15:13:24 SYS@ boston&gt; select * from nls_database_parameters;</span><br><span class="line"></span><br><span class="line">PARAMETER                      VALUE</span><br><span class="line">------------------------------ ----------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">NLS_LANGUAGE                   AMERICAN</span><br><span class="line">NLS_TERRITORY                  AMERICA</span><br><span class="line">NLS_CURRENCY                   $</span><br><span class="line">NLS_ISO_CURRENCY               AMERICA</span><br><span class="line">NLS_NUMERIC_CHARACTERS         .,</span><br><span class="line">NLS_CHARACTERSET               AL32UTF8</span><br><span class="line">NLS_CALENDAR                   GREGORIAN</span><br><span class="line">NLS_DATE_FORMAT                DD-MON-RR</span><br><span class="line">NLS_DATE_LANGUAGE              AMERICAN</span><br><span class="line">NLS_SORT                       BINARY</span><br><span class="line">NLS_TIME_FORMAT                HH.MI.SSXFF AM</span><br><span class="line">NLS_TIMESTAMP_FORMAT           DD-MON-RR HH.MI.SSXFF AM</span><br><span class="line">NLS_TIME_TZ_FORMAT             HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_TIMESTAMP_TZ_FORMAT        DD-MON-RR HH.MI.SSXFF AM TZR</span><br><span class="line">NLS_DUAL_CURRENCY              $</span><br><span class="line">NLS_COMP                       BINARY</span><br><span class="line">NLS_LENGTH_SEMANTICS           BYTE</span><br><span class="line">NLS_NCHAR_CONV_EXCP            FALSE</span><br><span class="line">NLS_NCHAR_CHARACTERSET         AL16UTF16</span><br><span class="line">NLS_RDBMS_VERSION              11.2.0.4.0</span><br></pre></td></tr></table></figure></p><p>字符集修改完成</p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] linux操作系统字符集与ssh工具字符集配置问题</title>
      <link href="/2019/01/09/linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8Essh%E5%B7%A5%E5%85%B7%E5%AD%97%E7%AC%A6%E9%9B%86%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/"/>
      <url>/2019/01/09/linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8Essh%E5%B7%A5%E5%85%B7%E5%AD%97%E7%AC%A6%E9%9B%86%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h4 id="1、操作系统字符集设置"><a href="#1、操作系统字符集设置" class="headerlink" title="1、操作系统字符集设置"></a>1、操作系统字符集设置</h4><p>centos6和7的字符集文件位置不同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CentOS6.x 字符集配置文件在/etc/syscconfig/i18n</span><br><span class="line">CentOS7.x 字符集配置文件在/etc/locale.conf</span><br></pre></td></tr></table></figure></p><p>以centos7为例，修改字符集<br>cat /etc/locale.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LANG=&quot;zh_CN.UTF-8&quot;</span><br></pre></td></tr></table></figure></p><p>修改为GBK字符集<br>cat /etc/locale.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">LANG=&quot;zh_CN.GBK&quot;</span><br><span class="line">[root@dax-mysql-slave ~]# locale</span><br><span class="line">LANG=zh_CN.GBK</span><br><span class="line">LC_CTYPE=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_NUMERIC=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_TIME=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_COLLATE=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_MONETARY=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_MESSAGES=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_PAPER=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_NAME=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_ADDRESS=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_TELEPHONE=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_MEASUREMENT=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_IDENTIFICATION=&quot;zh_CN.GBK&quot;</span><br><span class="line">LC_ALL=</span><br></pre></td></tr></table></figure></p><h4 id="2、系统字符集为utf-8，securecrt工具的字符集为gb2312，oracle字符集为ZHS16GBK"><a href="#2、系统字符集为utf-8，securecrt工具的字符集为gb2312，oracle字符集为ZHS16GBK" class="headerlink" title="2、系统字符集为utf-8，securecrt工具的字符集为gb2312，oracle字符集为ZHS16GBK"></a>2、系统字符集为utf-8，securecrt工具的字符集为gb2312，oracle字符集为ZHS16GBK</h4><p><img src="https://i.imgur.com/qiqFOFM.png" alt=""><br><img src="https://i.imgur.com/hnIJGRu.png" alt=""><br>如果使用securtcrt工具，设置该工具字符集为gb2312（小于gbk字符集）<br><img src="https://i.imgur.com/BEZzuce.png" alt=""><br>进入操作系统如果操作系统有中文字符，会出现乱码的情况<br><img src="https://i.imgur.com/sUxX2Hi.png" alt=""><br>分别查看以utf8编码的文件和ansi编码的文件<br><img src="https://i.imgur.com/CAvtn4b.png" alt=""><br>以gb2312字符集连接进来的securecrt工具，查看ansi编码的文件正常，查看utf8编码的文件乱码。<br>使用securecrt工具查看数据库中存在中文的数据：<br><img src="https://i.imgur.com/EjipMxx.png" alt=""></p><h4 id="3、系统字符集为utf-8，securecrt工具的字符集为urf-8，oracle字符集为ZH16GBK"><a href="#3、系统字符集为utf-8，securecrt工具的字符集为urf-8，oracle字符集为ZH16GBK" class="headerlink" title="3、系统字符集为utf-8，securecrt工具的字符集为urf-8，oracle字符集为ZH16GBK"></a>3、系统字符集为utf-8，securecrt工具的字符集为urf-8，oracle字符集为ZH16GBK</h4><p><img src="https://i.imgur.com/Eyu5H7h.png" alt=""><br><img src="https://i.imgur.com/GBmN4p3.png" alt=""><br><img src="https://i.imgur.com/hnIJGRu.png" alt=""><br>进入操作系统如果操作系统有中文字符，显示正常：<br><img src="https://i.imgur.com/OBz5GMU.png" alt=""><br>分别查看以utf8编码的文件和ansi编码的文件<br><img src="https://i.imgur.com/Lt98yEo.png" alt=""><br>以utf-8字符集连接进来的securecrt工具，查看ansi编码的文件乱码，查看utf8编码的文件正常。<br>使用securecrt工具查看数据库中存在中文的数据：<br><img src="https://i.imgur.com/HlJeZs7.png" alt=""><br>查看带有中文的数据全部显示乱码</p><h4 id="4、结论："><a href="#4、结论：" class="headerlink" title="4、结论："></a>4、结论：</h4><p>使用ssh工具连接到服务器是要注意连接工具的字符集，如果只在系统级别操作，要注意保持工具字符集和操作系统字符集的一致性。如果要查询数据库里面带有中文的相关数据，要注意保持工具字符集和操作系统字符集的一致性，否则查询结果会出现乱码。</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql大小写敏感参数</title>
      <link href="/2019/01/09/mysql%E5%A4%A7%E5%B0%8F%E5%86%99%E6%95%8F%E6%84%9F%E5%8F%82%E6%95%B0/"/>
      <url>/2019/01/09/mysql%E5%A4%A7%E5%B0%8F%E5%86%99%E6%95%8F%E6%84%9F%E5%8F%82%E6%95%B0/</url>
      <content type="html"><![CDATA[<h4 id="1、lower-case-file-system"><a href="#1、lower-case-file-system" class="headerlink" title="1、lower_case_file_system"></a>1、lower_case_file_system</h4><p>value=ON|OFF<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">该参数代表mysql数据目录所在的文件系统下的文件名的大小写是否敏感，off代表大小写铭感，on代表大小写不敏感。该变量是个只读参数，只代表一个文件系统属性，进行设置对文件系统没有任何影响。</span><br></pre></td></tr></table></figure></p><h4 id="2、lower-case-table-names"><a href="#2、lower-case-table-names" class="headerlink" title="2、lower_case_table_names"></a>2、lower_case_table_names</h4><p>value=0|1|2<br>不同值代表的含义：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">默认值为0，如果设置为0，表名是被指定存储的并且会进行大小写敏感的比较。</span><br><span class="line">如果设置为1，表名存为小写，不进行大小写敏感的比较。</span><br><span class="line">如果设置为2，表名按指定的存储，但是按小写的方式比较。这个参数同时适用于库名和表别名。</span><br></pre></td></tr></table></figure></p><p>不同操作系统的默认值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果是windows，值默认为1。</span><br><span class="line">如果是macos，值默认是2。</span><br><span class="line">如果是linux默认是0，且不支持设置为2，如果这是为2，服务端会强制用0替代。</span><br></pre></td></tr></table></figure></p><p>使用过程要注意的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1)如果MySQL服务运行在操作系统（windows或者macos）上，mysql的数据目录所在的文件系统是大小写不敏感的，因此不能设置lower_case_table_names为0。这种组合是不被支持的，当执行INSERT INTO...SELECT...FROM tbl_name操作时，因为tb1_name的小写，会导致系统hang主。</span><br><span class="line">2)在myisam表中，使用不同的字母大小写访问表，会引起索引损坏。</span><br><span class="line">3)如果在一个大小写不明感的文件系统上设置lower_case_table_names=0，会打印error信息并退出服务。</span><br><span class="line">4)如果使用innodb引擎表，不管什么平台，都需要设置该参数为1，强制将名称转换为小写。</span><br><span class="line">5)数据库禁止启动的时候使用的lower_case_table_names的值与数据库初始化时的值不一致。这个限制是因为，当数据库初始化时候，数据字典表字段的排序是基于当时的值定义的。如果重启以不同的lower_case_table_names值启动，会导致在标识符的排序和比较引起不一致性。</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] 单实例rman备份异机恢复到rac环境</title>
      <link href="/2018/12/21/%E5%8D%95%E5%AE%9E%E4%BE%8Brman%E5%A4%87%E4%BB%BD%E5%BC%82%E6%9C%BA%E6%81%A2%E5%A4%8D%E5%88%B0rac%E7%8E%AF%E5%A2%83/"/>
      <url>/2018/12/21/%E5%8D%95%E5%AE%9E%E4%BE%8Brman%E5%A4%87%E4%BB%BD%E5%BC%82%E6%9C%BA%E6%81%A2%E5%A4%8D%E5%88%B0rac%E7%8E%AF%E5%A2%83/</url>
      <content type="html"><![CDATA[<h4 id="1、查询DBID信息"><a href="#1、查询DBID信息" class="headerlink" title="1、查询DBID信息"></a>1、查询DBID信息</h4><p>DBID是DataBase IDentifier的缩写，是数据库的唯一标识符。这个DBID在数据文件头和控制文件都是存在的，可以用于标示数据文件的归属。对于不同数据库来说，DBID应当不同，而db_name则可能是相同的。一般在nocatalog模式并且控制文件丢失时才需要这个。<br>查看源库的dbid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@ testcadb&gt; select name,dbid from v$database;</span><br><span class="line">NAMEDBID</span><br><span class="line">--------- ----------</span><br><span class="line">TESTCADB  2313387174</span><br></pre></td></tr></table></figure></p><h4 id="2、查看源库的数据文件路径"><a href="#2、查看源库的数据文件路径" class="headerlink" title="2、查看源库的数据文件路径"></a>2、查看源库的数据文件路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYS@ testcadb&gt; select file_id,file_name from dba_data_files;</span><br><span class="line">FILE_ID FILE_NAME</span><br><span class="line"></span><br><span class="line"> 4 /home/oracle/u01/app/oracle/oradata/testcadb/users01.dbf</span><br><span class="line"> 3 /home/oracle/u01/app/oracle/oradata/testcadb/undotbs01.dbf</span><br><span class="line"> 2 /home/oracle/u01/app/oracle/oradata/testcadb/sysaux01.dbf</span><br><span class="line"> 1 /home/oracle/u01/app/oracle/oradata/testcadb/system01.dbf</span><br><span class="line"> 5 /home/oracle/oradata/orcl/ebank_data.dbf</span><br></pre></td></tr></table></figure><h4 id="3、查看临时表空间数据文件"><a href="#3、查看临时表空间数据文件" class="headerlink" title="3、查看临时表空间数据文件"></a>3、查看临时表空间数据文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYS@ testcadb&gt; select * from dba_temp_files;</span><br><span class="line">FILE_NAME           FILE_ID TABLESPACE_NAME BYTES   BLOCKS STATUS  RELATIVE_FNO AUT   MAXBYTES  MAXBLOCKS INCREMENT_BY USER_BYTES USER_BLOCKS</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">/home/oracle/u01/app/oracle/oradata/testcadb/temp01.dbf          1 TEMP      20971520     2560 ONLINE     1 YES 3.4360E+10 4194302   80199229442432</span><br><span class="line">/home/oracle/oradata/orcl/test_temp01.dbf         2 TEST_TEMP      33554432     4096 ONLINE     1 YES 2147483648  262144 4096325058563968</span><br></pre></td></tr></table></figure><h4 id="4、查看日志文件路径："><a href="#4、查看日志文件路径：" class="headerlink" title="4、查看日志文件路径："></a>4、查看日志文件路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select a.bytes/1024/1024,b.member,b.group#,a.thread# from v$log a,v$logfile b where a.group#=b.group#;</span><br><span class="line">A.BYTES/1024/1024 MEMBER      GROUP#  THREAD#</span><br><span class="line">50 /home/oracle/u01/app/oracle/oradata/testcadb/redo03.log           31</span><br><span class="line">50 /home/oracle/u01/app/oracle/oradata/testcadb/redo02.log           21</span><br><span class="line">50 /home/oracle/u01/app/oracle/oradata/testcadb/redo01.log           11</span><br></pre></td></tr></table></figure><h4 id="5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）"><a href="#5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）" class="headerlink" title="5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）"></a>5、开始备份数据库（非归档模式的数据库需要在mount状态下执行）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mkdir -p /tmp/backup/</span><br><span class="line">shell &gt; rman target /</span><br><span class="line">RMAN&gt; run &#123;</span><br><span class="line"> allocate channel c1 device type disk;  </span><br><span class="line"> backup incremental level 0 format &apos;/tmp/backup/db_full_%U.bkp&apos; tag &apos;2018-12-19-FULL&apos; database plus archivelog;  </span><br><span class="line"> release channel c1;</span><br><span class="line">&#125;</span><br><span class="line">备份控制文件</span><br><span class="line">RMAN&gt; backup current controlfile format &apos;/tmp/backup/control20181219.bak&apos;;</span><br><span class="line">备份pfile文件</span><br><span class="line">RMAN&gt; backup spfile format &apos;/tmp/backup/spfile20181219.bak&apos;;</span><br></pre></td></tr></table></figure><h4 id="6、拷贝源库备份文件到目标库服务器"><a href="#6、拷贝源库备份文件到目标库服务器" class="headerlink" title="6、拷贝源库备份文件到目标库服务器"></a>6、拷贝源库备份文件到目标库服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; scp /tmp/backup/* oracle@hostip*:/home/oracle/backup/</span><br></pre></td></tr></table></figure><h4 id="7、以下操作都是在目标节点上执行"><a href="#7、以下操作都是在目标节点上执行" class="headerlink" title="7、以下操作都是在目标节点上执行"></a>7、以下操作都是在目标节点上执行</h4><h4 id="8、查看文件权限，如果权限不对需要修改"><a href="#8、查看文件权限，如果权限不对需要修改" class="headerlink" title="8、查看文件权限，如果权限不对需要修改"></a>8、查看文件权限，如果权限不对需要修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; chown oracle.oinstall /home/oracle/backup/*</span><br></pre></td></tr></table></figure><h4 id="9、在节点1上执行恢复spfile文件："><a href="#9、在节点1上执行恢复spfile文件：" class="headerlink" title="9、在节点1上执行恢复spfile文件："></a>9、在节点1上执行恢复spfile文件：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">生成临时pfile文件</span><br><span class="line">shell &gt; echo &apos;db_name=testcadb&apos; &gt; $ORACLE_HOME/dbs/inittestcadb1.ora  </span><br><span class="line">声明ORACLE_SID</span><br><span class="line">shell &gt; export ORACLE_SID=testcadb1</span><br><span class="line">shell &gt; rman target /</span><br><span class="line">以临时pfile文件启动库到nomount：</span><br><span class="line">rman &gt; startup nomount  pfile=&apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora&apos;;</span><br><span class="line">设置dbid</span><br><span class="line">rman &gt; set DBID=2313387174;</span><br><span class="line">从备份中恢复spfile文件</span><br><span class="line">rman &gt; restore spfile to &apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/spfileoibs1.ora&apos; from &apos;/home/oracle/backup/spfile20181218.bak&apos;;</span><br></pre></td></tr></table></figure><p>操作结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 backup]$ rman target /</span><br><span class="line">恢复管理器: Release 11.2.0.4.0 - Production on 星期五 9月 23 14:13:35 2016</span><br><span class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</span><br><span class="line">RMAN&gt; startup nomount  pfile=&apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora&apos;;</span><br><span class="line">Oracle instance started</span><br><span class="line">Total System Global Area     371654656 bytes</span><br><span class="line">Fixed Size                     2253304 bytes</span><br><span class="line">Variable Size                314576392 bytes</span><br><span class="line">Database Buffers              50331648 bytes</span><br><span class="line">Redo Buffers                   4493312 bytes</span><br><span class="line"></span><br><span class="line">RMAN&gt; set DBID=2313387174;</span><br><span class="line">executing command: SET DBID</span><br><span class="line"></span><br><span class="line">RMAN&gt; restore spfile to &apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/spfiletestcadb1.ora&apos; from &apos;/home/oracle/backup/spfile20181219.bak&apos;;</span><br><span class="line">Starting restore at 2018:12:19 10:25:18</span><br><span class="line">using target database control file instead of recovery catalog</span><br><span class="line">allocated channel: ORA_DISK_1</span><br><span class="line">channel ORA_DISK_1: SID=134 device type=DISK</span><br><span class="line">channel ORA_DISK_1: restoring spfile from AUTOBACKUP /home/oracle/backup/spfile20181218.bak</span><br><span class="line">channel ORA_DISK_1: SPFILE restore from AUTOBACKUP complete</span><br><span class="line">Finished restore at 2018:12:19 10:25:20</span><br></pre></td></tr></table></figure></p><p>根据生成的spfile文件生成pfile文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 backup]$ sqlplus / as sysdba</span><br><span class="line">sql &gt; create pfile from spfile;</span><br></pre></td></tr></table></figure></p><p>对生成的pfile文件进行修改<br>vim /u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">*.__db_cache_size=969567232</span><br><span class="line">*.__java_pool_size=16777216</span><br><span class="line">*.__large_pool_size=184549376</span><br><span class="line">*.__oracle_base=&apos;/home/oracle/u01/app/oracle&apos;#ORACLE_BASE set from environment</span><br><span class="line">*.__pga_aggregate_target=1617245696</span><br><span class="line">*.__sga_target=1925868544</span><br><span class="line">*.__shared_io_pool_size=0</span><br><span class="line">*.__shared_pool_size=704643072</span><br><span class="line">*.__streams_pool_size=0</span><br><span class="line">*.aq_tm_processes=0</span><br><span class="line">*.audit_file_dest=&apos;/u01/app/oracle/admin/testcadb/adump&apos;</span><br><span class="line">*.audit_trail=&apos;db&apos;</span><br><span class="line">*.compatible=&apos;11.2.0.4.0&apos;</span><br><span class="line">*.control_files=&apos;+DATA1/testcadb/control01.ctl&apos;,&apos;+DATA1/testcadb/control02.ctl&apos;</span><br><span class="line">*.cpu_count=3</span><br><span class="line">*.db_block_size=8192</span><br><span class="line">*.db_domain=&apos;&apos;</span><br><span class="line">*.db_name=&apos;testcadb&apos;</span><br><span class="line">*.db_recovery_file_dest=&apos;+ARCH&apos;</span><br><span class="line">*.db_recovery_file_dest_size=4385144832</span><br><span class="line">*.diagnostic_dest=&apos;/u01/app/oracle&apos;</span><br><span class="line">*.dispatchers=&apos;(PROTOCOL=TCP) (SERVICE=testcadbXDB)&apos;</span><br><span class="line">*.job_queue_processes=0</span><br><span class="line">*.memory_target=3529482752</span><br><span class="line">*.open_cursors=300</span><br><span class="line">*.processes=400</span><br><span class="line">*.remote_login_passwordfile=&apos;EXCLUSIVE&apos;</span><br><span class="line">*.resource_manager_plan=&apos;default_plan&apos;</span><br><span class="line">*.sessions=445</span><br><span class="line">*.log_archive_dest_1=&apos;LOCATION=+ARCH/testcadb/archivelog&apos;</span><br><span class="line">*.log_archive_format=&apos;arch_%t_%s_%r.arc&apos;</span><br><span class="line">testcadb1.instance_name=&apos;testcadb1&apos;</span><br><span class="line">testcadb2.instance_name=&apos;testcadb2&apos;</span><br><span class="line">testcadb1.instance_number=1</span><br><span class="line">testcadb2.instance_number=2</span><br><span class="line">testcadb1.undo_tablespace=&apos;UNDOTBS1&apos;</span><br><span class="line">testcadb2.undo_tablespace=&apos;UNDOTBS2&apos;</span><br><span class="line">testcadb2.thread=2</span><br><span class="line">testcadb1.thread=1</span><br><span class="line">*.remote_listener=&apos;racscan:1521&apos;</span><br></pre></td></tr></table></figure></p><p>停止数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">19:17:48 SYS@ testcadb1&gt; shutdown immediate;</span><br><span class="line">ORA-01507: database not mounted</span><br><span class="line">ORACLE instance shut down.</span><br></pre></td></tr></table></figure></p><p>根据pfile文件中的设置路径,创建相应目录,oracle用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mkdir -p /u01/app/oracle/admin/testcadb/adump</span><br></pre></td></tr></table></figure></p><p>grid用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; asmcmd</span><br><span class="line">asmcmd&gt; mkdir ***</span><br></pre></td></tr></table></figure></p><p>修改完成之后以pfile文件重新启动数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; startup nomount pfile=&apos;/u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora&apos;;</span><br></pre></td></tr></table></figure></p><p>根据pfile文件生成新的spfile文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; create spfile=&apos;+DATA1/testcadb/spfiletestcadb.ora&apos; from pfile;</span><br><span class="line">SQL&gt; shutdown abort</span><br><span class="line">ORACLE instance shut down.</span><br></pre></td></tr></table></figure></p><p>将所有的节点上pfile文件，指向共享文件上的spfile文件<br>rac1节点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 ~]$ echo &quot;SPFILE=&apos;+DATA1/testcadb/spfiletestcadb.ora&apos; &quot; &gt; /u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb1.ora</span><br></pre></td></tr></table></figure></p><p>rac2节点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac2 ~]$ echo &quot;SPFILE=&apos;+DATA1/testcadb/spfiletestcadb.ora&apos; &quot; &gt; /u01/app/oracle/product/11.2.0.4/dbhome_1/dbs/inittestcadb2.ora</span><br></pre></td></tr></table></figure></p><h4 id="10、还原数据库的controlfile"><a href="#10、还原数据库的controlfile" class="headerlink" title="10、还原数据库的controlfile"></a>10、还原数据库的controlfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac2 ~]$ rman target /</span><br><span class="line">rman &gt; startup nomount</span><br></pre></td></tr></table></figure><p>还原控制文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rman &gt; restore controlfile from &apos;/home/oracle/backup/control20181219.bak&apos;;</span><br></pre></td></tr></table></figure></p><p>启动到mount<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rman &gt; alter database mount;</span><br></pre></td></tr></table></figure></p><h4 id="11、还原数据库，指定备份文件到存放路径"><a href="#11、还原数据库，指定备份文件到存放路径" class="headerlink" title="11、还原数据库，指定备份文件到存放路径"></a>11、还原数据库，指定备份文件到存放路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">rman &gt; catalog start with &apos;/home/oracle/backup&apos;;</span><br><span class="line">rman &gt; list backup summary;</span><br><span class="line">执行下列run脚本(根据数据文件的不同作相应修改)</span><br><span class="line">RMAN&gt; run&#123;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/users01.dbf&apos; to &apos;+DATA1/testcadb/users01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/undotbs01.dbf&apos; to &apos;+DATA1/testcadb/undotbs01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/sysaux01.dbf&apos; to &apos;+DATA1/testcadb/sysaux01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/u01/app/oracle/oradata/testcadb/system01.dbf&apos; to &apos;+DATA1/testcadb/system01.dbf&apos;;</span><br><span class="line">set newname for datafile &apos;/home/oracle/oradata/orcl/ebank_data.dbf&apos; to &apos;+DATA1/testcadb/ebank_data.dbf&apos;;</span><br><span class="line">restore database;</span><br><span class="line">switch datafile all;</span><br><span class="line">&#125;</span><br><span class="line">或者：</span><br><span class="line">RMAN&gt; run&#123;</span><br><span class="line">set newname for datafile 1 to &apos;+DATA1/testcadb/users01.dbf&apos;;</span><br><span class="line">set newname for datafile 2 to &apos;+DATA1/testcadb/undotbs01.dbf&apos;;</span><br><span class="line">set newname for datafile 3 to &apos;+DATA1/testcadb/sysaux01.dbf&apos;;</span><br><span class="line">set newname for datafile 4 to &apos;+DATA1/testcadb/system01.dbf&apos;;</span><br><span class="line">set newname for datafile 5 to &apos;+DATA1/testcadb/ebank_data.dbf&apos;;</span><br><span class="line">restore database;</span><br><span class="line">switch datafile all;</span><br><span class="line">&#125;</span><br><span class="line">查看备份的归档（如果是非归档模式的备份没有数据）</span><br><span class="line">RMAN&gt; list backup of archivelog all;</span><br><span class="line">根据scn恢复数据库</span><br><span class="line">RMAN&gt; recover database until scn 2896925;</span><br><span class="line">或者如果没有归档，直接恢复数据库</span><br><span class="line">RMAN&gt; recover database;</span><br></pre></td></tr></table></figure><p>尝试打开数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; sqlplus / as sysdba</span><br><span class="line">sql &gt; alter database open resetlogs;</span><br><span class="line">alter database open resetlogs</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-00344: unable to re-create online log &apos;/home/oracle/u01/app/oracle/oradata/testcadb/redo01.log&apos;</span><br><span class="line">ORA-27040: file create error, unable to create file</span><br><span class="line">Linux-x86_64 Error: 2: No such file or directory</span><br><span class="line">Additional information: 1</span><br></pre></td></tr></table></figure></p><p>提示redolog文件路径错误，重新生成redolog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select group#,thread#,members,archived,status from v$log;</span><br><span class="line"></span><br><span class="line">    GROUP#    THREAD# MEMBERS ARCHIV STATUS</span><br><span class="line">---------- ---------- ---------- ------ --------------------------------</span><br><span class="line"> 1    1       1 NOCLEARING</span><br><span class="line"> 3    1       1 NOCLEARING_CURRENT</span><br><span class="line"> 2    1       1 NOCLEARING</span><br><span class="line">Elapsed: 00:00:00.03</span><br><span class="line">删除原来的logfile</span><br><span class="line">sql &gt; alter database drop logfile group 1;</span><br><span class="line">新增logfile(要保证redolog路径存在)</span><br><span class="line">sql &gt; alter database add logfile group 1 &apos;+ARCH/testcadb/redolog/redo01.log&apos; size 100M;</span><br><span class="line">sql &gt; alter database drop logfile group 2;</span><br><span class="line">sql &gt; alter database add logfile group 2 &apos;+ARCH/testcadb/redolog/redo02.log&apos; size 100M;</span><br><span class="line">sql &gt; alter database drop logfile group 3;</span><br><span class="line">提示日志无法删除</span><br><span class="line">sql &gt; alter database drop logfile group 3;</span><br><span class="line">alter database drop logfile group 3</span><br><span class="line">*</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01623: log 3 is current log for instance testcadb1 (thread 1) - cannot drop</span><br><span class="line">ORA-00312: online log 3 thread 1: &apos;/home/oracle/u01/app/oracle/oradata/testcadb/redo03.log&apos;</span><br><span class="line">对文件进行重命名</span><br><span class="line">sql &gt; alter database rename file &apos;/home/oracle/u01/app/oracle/oradata/testcadb/redo03.log&apos; to &apos;+ARCH/testcadb/redolog/redo03.log&apos;;</span><br><span class="line">sql &gt; alter database clear logfile group 3;</span><br><span class="line">因为日志文件大小还是按原来的大小，需要重新建</span><br><span class="line">sql &gt; alter database drop logfile group 3;</span><br><span class="line">sql &gt; alter database add logfile group 3 &apos;+ARCH/testcadb/redolog/redo03.log&apos; size 100M;</span><br><span class="line">打开数据库</span><br><span class="line">sql &gt; alter database open resetlogs;</span><br><span class="line">如果原库版本不一样（源库11.2.0.3目标库11.2.0.4）需要升级数据库</span><br><span class="line">sql &gt; startup mount;</span><br><span class="line">sql &gt; alter database open upgrade;</span><br><span class="line">sql &gt; select status from v$Instance; </span><br><span class="line">sql &gt; @$ORACLE_HOME/rdbms/admin/catupgrd.sql;</span><br></pre></td></tr></table></figure></p><p>启动库之后临时表空间是不可用的，需要重新配置临时表空间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select * from dba_temp_files;</span><br><span class="line">select * from dba_temp_files</span><br><span class="line">              *</span><br><span class="line">ERROR at line 1:</span><br><span class="line">ORA-01157: cannot identify/lock data file 201 - see DBWR trace file</span><br><span class="line">ORA-01110: data file 201: &apos;/home/oracle/u01/app/oracle/oradata/testcadb/temp01.dbf&apos;</span><br></pre></td></tr></table></figure></p><p>更换临时表空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">创建中转临时表空间</span><br><span class="line">sql &gt; create TEMPORARY TABLESPACE TEMP2 TEMPFILE &apos;+DATA1/testcadb/TEMP02.DBF&apos; SIZE 2048M REUSE AUTOEXTEND ON NEXT 640K MAXSIZE 5120M;</span><br><span class="line">切换默认临时表空间</span><br><span class="line">sql &gt; alter database default temporary tablespace temp2; </span><br><span class="line">sql &gt; </span><br><span class="line">sql &gt; drop tablespace temp including contents and datafiles; </span><br><span class="line">sql &gt; create TEMPORARY TABLESPACE TEMP TEMPFILE &apos;+DATA1/testcadb/TEMP01.DBF&apos; SIZE 2048M REUSE AUTOEXTEND ON NEXT 640K MAXSIZE 5120M; </span><br><span class="line">sql &gt; alter database default temporary tablespace temp; </span><br><span class="line">或者 sql &gt; alter user *** temporary tablespace temp;（修改单独某个用户的临时表空间）</span><br><span class="line"></span><br><span class="line">sql &gt; drop tablespace temp2 including contents and datafiles; </span><br><span class="line">sql &gt; select * from v$log;</span><br><span class="line">    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE  MEMBERS ARCHIV STATUS   FIRST_CHANGE# FIRST_TIME    NEXT_CHANGE# NEXT_TIME</span><br><span class="line">---------- ---------- ---------- ---------- ---------- ---------- ------ -------------------------------- ------------- ------------------- ------------ -------------------</span><br><span class="line"> 1    1      25  104857600   5121 NO INACTIVE       64817466 2018:12:19 14:19:0964828852 2018:12:19 14:21:47</span><br><span class="line"> 2    1      26  104857600   5121 NO CURRENT       64828852 2018:12:19 14:21:47   2.8147E+14</span><br><span class="line"> 3    1      24   52428800   5121 NO INACTIVE       64807090 2018:12:19 14:18:2964817466 2018:12:19 14:19:09</span><br></pre></td></tr></table></figure></p><p>添加thread 2对应的logfile，用于分配给节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; alter database add logfile thread 2 group 4 &apos;+ARCH/testcadb/redolog/redo04.log&apos; size 100m;</span><br><span class="line">sql &gt; alter database add logfile thread 2 group 5 &apos;+ARCH/testcadb/redolog/redo05.log&apos; size 100m;</span><br><span class="line">sql &gt; alter database add logfile thread 2 group 6 &apos;+ARCH/testcadb/redolog/redo06.log&apos; size 100m;</span><br></pre></td></tr></table></figure></p><p>启动thread2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select thread#,status,enabled from v$thread;</span><br><span class="line">   THREAD# STATUSENABLED</span><br><span class="line">---------- ------------ ----------------</span><br><span class="line"> 1 OPEN PUBLIC</span><br><span class="line"> 2 CLOSEDDISABLED</span><br><span class="line">sql &gt; alter database enable thread 2;</span><br></pre></td></tr></table></figure></p><p>配置两个节点信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; alter system set thread=1 scope=spfile sid=&apos;testcadb1&apos;;</span><br><span class="line">sql &gt; alter system set thread=2 scope=spfile sid=&apos;testcadb2&apos;;</span><br><span class="line">sql &gt; alter system set instance_number=1 scope=spfile sid=&apos;testcadb1&apos;;</span><br><span class="line">sql &gt; alter system set instance_number=2 scope=spfile sid=&apos;testcadb2&apos;;</span><br><span class="line">sql &gt; alter system set cluster_database_instances=2 scope=spfile;</span><br><span class="line">sql &gt; alter system set cluster_database=true scope=spfile;</span><br></pre></td></tr></table></figure></p><p>为节点2添加undo表空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; select substr(file_name,1,60) UNDO_FILES from dba_data_files where tablespace_name = &apos;UNDOTBS1&apos; </span><br><span class="line">sql &gt; create undo tablespace undotbs2 datafile &apos;+data1/testcadb/undotbs02.dbf&apos; size 200M;</span><br><span class="line">sql &gt; alter system set undo_tablespace=&apos;undotbs2&apos; scope=spfile sid=&apos;testcadb2&apos;;</span><br></pre></td></tr></table></figure></p><p>关闭节点1并重新启动,如果不重新启动节点1，直接启动节点2报一下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORA-01102: cannot mount database in EXCLUSIVE mode</span><br></pre></td></tr></table></figure></p><p>启动节点2（在节点2操作）<br>节点2：注意audit目录是否存在，不存在手动创建一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mkdir -p /u01/app/oracle/admin/testcadb/adump</span><br><span class="line">shell &gt; export ORACLE_SID=testcadb2</span><br><span class="line">shell &gt; sqlplus / as sysdba</span><br><span class="line">sql &gt; startup nomount;</span><br><span class="line">sql &gt; alter database mount;</span><br><span class="line">sql &gt; alter database open;</span><br></pre></td></tr></table></figure></p><p>至此数据库已经换成完成，但是恢复的数据库还没有注册到集群管理下</p><h4 id="12、将数据库注册到集群下"><a href="#12、将数据库注册到集群下" class="headerlink" title="12、将数据库注册到集群下"></a>12、将数据库注册到集群下</h4><p>在节点1使用oracle用户执行（不要使用grid用户）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 ~]$ srvctl add database -d testcadb -o /u01/app/oracle/product/11.2.0.4/dbhome_1 -p +DATA1/testcadb/spfiletestcadb.ora</span><br><span class="line">[oracle@rac1 ~]$ srvctl add instance -d testcadb -i testcadb1 -n rac1</span><br><span class="line">[oracle@rac1 ~]$ srvctl add instance -d testcadb -i testcadb2 -n rac2</span><br></pre></td></tr></table></figure></p><p>重启数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[oracle@rac1 ~]$ srvctl stop database -d testcadb</span><br><span class="line">#因为启动不是通过srvctl启动的，可能需要进入sqlplus控制台先手动关闭库（两个节点都要运行），然后通过下面命令启动数据库：</span><br><span class="line">[oracle@rac1 ~]$ srvctl start database -d testcadb</span><br></pre></td></tr></table></figure></p><h4 id="13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作"><a href="#13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作" class="headerlink" title="13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作"></a>13、查看监听有没有注册到scanip上，如果没有注册到scanip上继续下面的操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; show parameter remote_listener;</span><br><span class="line">NAME     TYPE VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">remote_listener      string racscan:1521</span><br><span class="line">#grid用户执行：</span><br><span class="line">shell &gt; lsnrctl status LISTENER_SCAN1</span><br><span class="line">#如果没有注册监听信息，按下面方法配置</span><br><span class="line">alter system set remote_listener = &apos;racscan:1521&apos; sid=&apos;*&apos; scope=both;</span><br><span class="line">alter system register;</span><br><span class="line">lsnrctl status LISTENER_SCAN1</span><br></pre></td></tr></table></figure><h4 id="14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题"><a href="#14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题" class="headerlink" title="14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题"></a>14、因为恢复过来的数据库没有passwordfile，存在sys用户远程登录问题</h4><p>查看remote_login_passwordfile设置值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql &gt; show parameter remote_login_passwordfile;</span><br><span class="line">NAME     TYPE VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">remote_login_passwordfile     string EXCLUSIVE</span><br><span class="line"></span><br><span class="line">修改值使用下面方法，修改完成之后，需要重新启动数据库才能生效：</span><br><span class="line">alter system set remote_login_passwordfile=&apos;exclusive&apos; scope=spfile sid=&apos;*&apos;;</span><br></pre></td></tr></table></figure></p><p>查看详细的remote_login_passwordfile配置点击<a href="https://zeven0707.github.io/2018/12/21/remote_login_passwordfile&amp;SQLNET.AUTHENTICATION_SERVICES%E5%8F%82%E6%95%B0/" target="_blank" rel="noopener">此处</a><br>remote_login_passwordfile修改完成之后,生成秘钥文件<br>节点1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orapwd file=orapwtestcadb1 password=oracle entries=100</span><br></pre></td></tr></table></figure></p><p>节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orapwd file=orapwtestcadb2 password=oracle entries=100</span><br></pre></td></tr></table></figure></p><p>现在，数据终于可以正常访问了。</p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] remote_login_passwordfile&amp;SQLNET.AUTHENTICATION_SERVICES参数</title>
      <link href="/2018/12/21/remote_login_passwordfile&amp;SQLNET.AUTHENTICATION_SERVICES%E5%8F%82%E6%95%B0/"/>
      <url>/2018/12/21/remote_login_passwordfile&amp;SQLNET.AUTHENTICATION_SERVICES%E5%8F%82%E6%95%B0/</url>
      <content type="html"><![CDATA[<h4 id="1、remote-login-passwordfile参数"><a href="#1、remote-login-passwordfile参数" class="headerlink" title="1、remote_login_passwordfile参数"></a>1、remote_login_passwordfile参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shared：一个或者多个库都能使用该password file。sys用户不能修改，如果尝试修改sys密码，会提示 &quot;ORA-28046: Password change for SYS disallowed.&quot; ;其他用户有（SYSDBA, SYSOPER, SYSASM, SYSBACKUP, SYSDG, SYSKM）权限的，密码不能更新，如果更新会提示&quot;ORA-01999: password file cannot be updated in SHARED mode.&quot; ;给个别用户授权（SYSDBA, SYSOPER, SYSASM, SYSBACKUP, SYSDG, SYSKM）是不被允许的，否则提示&quot;ORA-01999: password file cannot be updated in SHARED mode.&quot;;如果passwordfile文件不存在，等同于REMOTE_LOGIN_PASSWORDFILE=none.</span><br><span class="line"></span><br><span class="line">exclusive：password file只能被一个库使用，文件可以包含sys和非sys用户。如果password file文件不存在，等同于REMOTE_LOGIN_PASSWORDFILE=none. </span><br><span class="line">remote_login_passwordfile =exclusive时，启用口令文件，允许远程登录；</span><br><span class="line"></span><br><span class="line">none：忽略password file，只能通过本地操作系统验证。</span><br></pre></td></tr></table></figure><p>修改值使用下面方法，因为该值为静态参数，修改完成之后，需要重新启动数据库才能生效：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter system set remote_login_passwordfile=&apos;exclusive&apos; scope=spfile sid=&apos;*&apos;;</span><br></pre></td></tr></table></figure></p><h4 id="2、SQLNET-AUTHENTICATION-SERVICES参数详解"><a href="#2、SQLNET-AUTHENTICATION-SERVICES参数详解" class="headerlink" title="2、SQLNET.AUTHENTICATION_SERVICES参数详解"></a>2、SQLNET.AUTHENTICATION_SERVICES参数详解</h4><h5 id="2-1、值为none时"><a href="#2-1、值为none时" class="headerlink" title="2.1、值为none时"></a>2.1、值为none时</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#本地验证方式失效</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus / as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line">#使用用户名密码方式登录正常：</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle as sysdba</span><br><span class="line">22:51:21 SYS@ boston&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston</span><br><span class="line">22:52:00 TEST@ boston&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@192.168.168.177:1521/boston.us.oracle.com</span><br><span class="line">22:53:02 TEST@ 192.168.168.177:1521/boston.us.oracle.com&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br></pre></td></tr></table></figure><h5 id="2-2、值为all时"><a href="#2-2、值为all时" class="headerlink" title="2.2、值为all时"></a>2.2、值为all时</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">网络服务名方式和service_name方式失效</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus / as sysdba</span><br><span class="line">22:54:21 SYS@ boston&gt; </span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle as sysdba</span><br><span class="line">22:54:45 SYS@ boston&gt; </span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston</span><br><span class="line">ERROR:</span><br><span class="line">ORA-12641: Authentication service failed to initialize</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@192.168.168.177:1521/boston.us.oracle.com</span><br><span class="line">ERROR:</span><br><span class="line">ORA-12641: Authentication service failed to initialize</span><br></pre></td></tr></table></figure><h5 id="2-3、如果SQLNET-AUTHENTICATION-SERVICES-none-的情况下-修改remote-login-passwordfile的值从exclusive改为none-重启数据库使其生效-会报错提示权限不足："><a href="#2-3、如果SQLNET-AUTHENTICATION-SERVICES-none-的情况下-修改remote-login-passwordfile的值从exclusive改为none-重启数据库使其生效-会报错提示权限不足：" class="headerlink" title="2.3、如果SQLNET.AUTHENTICATION_SERVICES=(none)的情况下,修改remote_login_passwordfile的值从exclusive改为none,重启数据库使其生效,会报错提示权限不足："></a>2.3、如果SQLNET.AUTHENTICATION_SERVICES=(none)的情况下,修改remote_login_passwordfile的值从exclusive改为none,重启数据库使其生效,会报错提示权限不足：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">22:58:28 SYS@ boston&gt; alter system set remote_login_passwordfile=&apos;NONE&apos; scope=spfile;</span><br><span class="line">System altered.</span><br><span class="line">22:58:47 SYS@ boston&gt; shutdown immediate;</span><br><span class="line">Database closed.</span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">22:59:15 SYS@ boston&gt; startup </span><br><span class="line">ORA-01031: insufficient privileges</span><br><span class="line">22:59:34 SYS@ boston&gt; exit</span><br><span class="line">Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span><br><span class="line">With the Partitioning, OLAP, Data Mining and Real Application Testing options</span><br><span class="line">尝试重新登录启动数据库</span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle  as sysdba</span><br><span class="line">Connected to an idle instance.</span><br><span class="line">22:59:46 SYS@ boston&gt; startup</span><br><span class="line">ORA-01031: insufficient privileges</span><br><span class="line">22:59:48 SYS@ boston&gt; exit</span><br><span class="line">Disconnected</span><br></pre></td></tr></table></figure><p>只能禁用sqlnet.ora文件中的SQLNET.AUTHENTICATION_SERVICES=(none)参数，否则无法启动数据库。</p><h5 id="2-4、启动数据库之后，再次启用sqlnet-ora文件中的SQLNET-AUTHENTICATION-SERVICES-none-参数，如果在数据库开启的状态下，as-sysdba将无法登录，只能使用网络服务名和service-name登录"><a href="#2-4、启动数据库之后，再次启用sqlnet-ora文件中的SQLNET-AUTHENTICATION-SERVICES-none-参数，如果在数据库开启的状态下，as-sysdba将无法登录，只能使用网络服务名和service-name登录" class="headerlink" title="2.4、启动数据库之后，再次启用sqlnet.ora文件中的SQLNET.AUTHENTICATION_SERVICES=(none)参数，如果在数据库开启的状态下，as sysdba将无法登录，只能使用网络服务名和service_name登录"></a>2.4、启动数据库之后，再次启用sqlnet.ora文件中的SQLNET.AUTHENTICATION_SERVICES=(none)参数，如果在数据库开启的状态下，as sysdba将无法登录，只能使用网络服务名和service_name登录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">oracle@dax-mysql-slave admin]$ sqlplus / as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus sys/oracle as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston as sysdba</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@boston</span><br><span class="line">10:13:30 TEST@ boston&gt; exit</span><br><span class="line"></span><br><span class="line">[oracle@dax-mysql-slave admin]$ sqlplus test/oracle@192.168.168.177:1521/boston.us.oracle.com</span><br><span class="line">10:16:49 TEST@ 192.168.168.177:1521/boston.us.oracle.com&gt; select * from user_role_privs;</span><br><span class="line"></span><br><span class="line">USERNAME       GRANTED_ROLE      ADM DEF OS_</span><br><span class="line">------------------------------ ------------------------------ --- --- ---</span><br><span class="line">TEST       CONNECT      NO  YES NO</span><br><span class="line">TEST       DBA          NO  YES NO</span><br><span class="line">TEST       RESOURCE       NO  YES NO</span><br><span class="line">Elapsed: 00:00:00.02</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控域名证书过期时间</title>
      <link href="/2018/12/17/zabbix%E7%9B%91%E6%8E%A7%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4/"/>
      <url>/2018/12/17/zabbix%E7%9B%91%E6%8E%A7%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4/</url>
      <content type="html"><![CDATA[<h4 id="1、编辑脚本"><a href="#1、编辑脚本" class="headerlink" title="1、编辑脚本"></a>1、编辑脚本</h4><p>more /usr/local/zabbix/script/check_sslcert_expire_script.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#传入第一参数指定输入的域名</span><br><span class="line">domain=$1</span><br><span class="line">#传入的第二个参数指定https的端口</span><br><span class="line">port=$2</span><br><span class="line">#获取证书到期时间</span><br><span class="line">expired_date=`echo |openssl s_client -servername $&#123;domain&#125; -connect $&#123;domain&#125;:$&#123;port&#125; 2&gt;/dev/null | openssl x509 -noout -dates |sed -n &apos;s/notAfter=//p&apos;`</span><br><span class="line">#$&#123;expired_date&#125;参数一定要加上双引号，否则按多个参数处理</span><br><span class="line">#与当前系统日期时间做对比，查看证书过期时间</span><br><span class="line">if [ -n &quot;$&#123;expired_date&#125;&quot; ];then</span><br><span class="line">    expired_seconds=`date &apos;+%s&apos; --date &quot;$&#123;expired_date&#125;&quot;`</span><br><span class="line">    now_seconds=`date &apos;+%s&apos;`</span><br><span class="line">    echo &quot;($&#123;expired_seconds&#125;-$&#123;now_seconds&#125;)/24/3600&quot; | bc</span><br><span class="line">else</span><br><span class="line">  :</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p><h4 id="2、修改zabbix-agentd-conf配置文件，添加下面一行"><a href="#2、修改zabbix-agentd-conf配置文件，添加下面一行" class="headerlink" title="2、修改zabbix_agentd.conf配置文件，添加下面一行"></a>2、修改zabbix_agentd.conf配置文件，添加下面一行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserParameter=check_ssl_cert_expire[*],sh /usr/local/zabbix/script/check_sslcert_expire_script.sh  $1 $2</span><br></pre></td></tr></table></figure><p>重新启动agent</p><h4 id="3、检查获取参数是否正常"><a href="#3、检查获取参数是否正常" class="headerlink" title="3、检查获取参数是否正常"></a>3、检查获取参数是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zabbix/bin/zabbix_get -s 127.0.0.1 -p 10050 -k check_ssl_cert_expire[www.baidu.com,443]</span><br><span class="line">159</span><br><span class="line">/usr/local/zabbix/bin/zabbix_get -s 127.0.0.1 -p 10050 -k check_ssl_cert_expire[www.masterdax.com,443]</span><br><span class="line">85</span><br></pre></td></tr></table></figure><h4 id="4、打开zabbix-web控制台添加模板，监控项"><a href="#4、打开zabbix-web控制台添加模板，监控项" class="headerlink" title="4、打开zabbix,web控制台添加模板，监控项"></a>4、打开zabbix,web控制台添加模板，监控项</h4><p><img src="https://i.imgur.com/jtLWcW3.png" alt=""><br>设置触发器，证书到期时触发报警<br><img src="https://i.imgur.com/OB8yEPD.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] 为oracle-sqlplus安装rlwrap</title>
      <link href="/2018/12/17/oracle%E5%AE%89%E8%A3%85rlwrap/"/>
      <url>/2018/12/17/oracle%E5%AE%89%E8%A3%85rlwrap/</url>
      <content type="html"><![CDATA[<h4 id="1、安装rlwrap-0-42-1-1-x86-64-rpm方式"><a href="#1、安装rlwrap-0-42-1-1-x86-64-rpm方式" class="headerlink" title="1、安装rlwrap-0.42-1.1.x86_64.rpm方式"></a>1、安装rlwrap-0.42-1.1.x86_64.rpm方式</h4><p>下载rlwrap-0.42-1.1.x86_64.rpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/Ledest%3A/misc/CentOS_7/src/rlwrap-0.42-1.1.x86_64.rpm</span><br></pre></td></tr></table></figure></p><h4 id="2、安装rlwarp"><a href="#2、安装rlwarp" class="headerlink" title="2、安装rlwarp"></a>2、安装rlwarp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall rlwrap-0.42-1.1.x86_64.rpm</span><br></pre></td></tr></table></figure><h4 id="3、修改环境变量文件"><a href="#3、修改环境变量文件" class="headerlink" title="3、修改环境变量文件"></a>3、修改环境变量文件</h4><p>grep ‘rlwrap’ ~/.bash_profile<br>alias sql=’rlwrap sqlplus “/ as sysdba”‘<br>alias rman=’rlwrap rman’</p><h4 id="4、如果找不到x86-64类型的文件，下载-rlwrap-0-42-1-1-src-rpm"><a href="#4、如果找不到x86-64类型的文件，下载-rlwrap-0-42-1-1-src-rpm" class="headerlink" title="4、如果找不到x86_64类型的文件，下载 rlwrap-0.42-1.1.src.rpm"></a>4、如果找不到x86_64类型的文件，下载 rlwrap-0.42-1.1.src.rpm</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/Ledest%3A/misc/CentOS_7/src/rlwrap-0.42-1.1.src.rpm</span><br></pre></td></tr></table></figure><h4 id="5、安装依赖"><a href="#5、安装依赖" class="headerlink" title="5、安装依赖"></a>5、安装依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install rpm-build -y</span><br><span class="line">yum install readline* libtermcap-devel* -y</span><br></pre></td></tr></table></figure><h4 id="6、安装rlwarp"><a href="#6、安装rlwarp" class="headerlink" title="6、安装rlwarp"></a>6、安装rlwarp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; rpm -i rlwrap-0.42-1.1.src.rpm </span><br><span class="line">warning: rlwrap-0.42-1.1.src.rpm: Header V3 RSA/SHA1 Signature, key ID 93680782: NOKEY</span><br><span class="line"></span><br><span class="line">shell &gt; cd rpmbuild/SOURCES</span><br><span class="line">shell &gt; tar -zxvf rlwrap-0.42.tar.gz </span><br><span class="line">shell &gt; cd rlwrap-0.42</span><br><span class="line">shell &gt; ls</span><br><span class="line">aclocal.m4  BUGS       completions  configure     COPYING  filters  Makefile.am  NEWS  README  test  tools</span><br><span class="line">AUTHORS     ChangeLog  config.h.in  configure.ac  doc      INSTALL  Makefile.in  PLEA  src     TODO</span><br><span class="line"></span><br><span class="line">shell &gt; ./configure</span><br><span class="line">shell &gt; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">#### 7、之后修改环境变量</span><br></pre></td></tr></table></figure><p>grep ‘rlwrap’ ~/.bash_profile<br>alias sql=’rlwrap sqlplus “/ as sysdba”‘<br>alias rman=’rlwrap rman’<br><code>`</code></p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] centos7安装rac报错ohasd failed to start</title>
      <link href="/2018/12/17/centos7%E5%AE%89%E8%A3%85rac%E6%8A%A5%E9%94%99ohasd%20failed%20to%20start/"/>
      <url>/2018/12/17/centos7%E5%AE%89%E8%A3%85rac%E6%8A%A5%E9%94%99ohasd%20failed%20to%20start/</url>
      <content type="html"><![CDATA[<h4 id="1、具体报错信息"><a href="#1、具体报错信息" class="headerlink" title="1、具体报错信息"></a>1、具体报错信息</h4><p>安装完成grid之后，在执行/u01/app/11.2.0.4/grid/root.sh命令时报以下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ohasd failed to start</span><br><span class="line">Failed to start the Clusterware. Last 20 lines of the alert log follow</span><br></pre></td></tr></table></figure></p><h4 id="2、单独在linux-7中为ohasd设置一个服务。"><a href="#2、单独在linux-7中为ohasd设置一个服务。" class="headerlink" title="2、单独在linux 7中为ohasd设置一个服务。"></a>2、单独在linux 7中为ohasd设置一个服务。</h4><p>1、创建服务ohas.service的服务文件并赋予权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /usr/lib/systemd/system/ohas.service</span><br><span class="line">chmod 777 /usr/lib/systemd/system/ohas.service</span><br></pre></td></tr></table></figure></p><p>2、往ohas.service服务文件添加启动ohasd的相关信息<br>vi /usr/lib/systemd/system/ohas.service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Oracle High Availability Services</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/etc/init.d/init.ohasd run &gt;/dev/null 2&gt;&amp;1 Type=simple</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p><p>3、重新加载守护进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure></p><p>设置守护进程自动启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ohas.service</span><br></pre></td></tr></table></figure></p><p>手工启动ohas服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ohas.service</span><br></pre></td></tr></table></figure></p><p>4、重新运行root.sh脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh root.sh</span><br></pre></td></tr></table></figure></p><p>5：查看ohas服务状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status ohas.service</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] oracle udev配置</title>
      <link href="/2018/12/17/oracle%20udev%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/12/17/oracle%20udev%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h4 id="1、添加裸设备"><a href="#1、添加裸设备" class="headerlink" title="1、添加裸设备"></a>1、添加裸设备</h4><p>增加磁盘vda,vdb,vdc<br>在节点1上分别对vda，vdb，vdc三块盘分区<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/vda</span><br><span class="line">fdisk /dev/vdb</span><br><span class="line">fdisk /dev/vdc</span><br></pre></td></tr></table></figure></p><p>节点1查看设备信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 ~]# ll /dev/vd*</span><br><span class="line">brw-rw---- 1 root disk 252,  0 Dec 14 10:56 /dev/vda</span><br><span class="line">brw-rw---- 1 root disk 252,  1 Dec 14 10:56 /dev/vda1</span><br><span class="line">brw-rw---- 1 root disk 252,  2 Dec 14 10:56 /dev/vda2</span><br><span class="line">brw-rw---- 1 root disk 252, 16 Dec 14 11:41 /dev/vdb</span><br><span class="line">brw-rw---- 1 root disk 252, 17 Dec 14 11:41 /dev/vdb1</span><br><span class="line">brw-rw---- 1 root disk 252, 32 Dec 14 11:34 /dev/vdc</span><br><span class="line">brw-rw---- 1 root disk 252, 33 Dec 14 11:34 /dev/vdc1</span><br><span class="line">brw-rw---- 1 root disk 252, 48 Dec 14 11:34 /dev/vdd</span><br><span class="line">brw-rw---- 1 root disk 252, 49 Dec 14 11:34 /dev/vdd1</span><br></pre></td></tr></table></figure></p><p>节点2查看设备信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@rac2 ~]# ll /dev/vd*</span><br><span class="line">brw-rw---- 1 root disk 252,  0 Dec 14 10:56 /dev/vda</span><br><span class="line">brw-rw---- 1 root disk 252,  1 Dec 14 10:56 /dev/vda1</span><br><span class="line">brw-rw---- 1 root disk 252,  2 Dec 14 10:56 /dev/vda2</span><br><span class="line">brw-rw---- 1 root disk 252, 16 Dec 14 10:56 /dev/vdb</span><br><span class="line">brw-rw---- 1 root disk 252, 32 Dec 14 10:56 /dev/vdc</span><br><span class="line">brw-rw---- 1 root disk 252, 48 Dec 14 10:56 /dev/vdd</span><br></pre></td></tr></table></figure></p><p>major device number可以看作是设备驱动程序，被同一设备驱动程序管理的设备有相同的major device number.这个数字实际是Kernel中device driver table 的索引，这个表保存着不同设备驱动程序。（kvm虚拟机virto的驱动对应的major device number值为252，scsi的驱动对应的major device number值为8，裸设备为162）<br>minor device number用来代表被访问的具体设备。就是说Kernel根据major device number 找到设备驱动程序，然后再从minor device number 获得设备位置等属性。</p><h4 id="2、修改配置文件"><a href="#2、修改配置文件" class="headerlink" title="2、修改配置文件"></a>2、修改配置文件</h4><p>节点1<br>vim /etc/udev/rules.d/60-raw.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdb1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;17&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdc1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;33&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdd1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;49&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %M %m&quot;</span><br><span class="line"></span><br><span class="line">KERNEL==&quot;raw[1-3]&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;640&quot;</span><br></pre></td></tr></table></figure></p><p>节点2<br>vim /etc/udev/rules.d/60-raw.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdb1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;17&quot;,RUN+=&quot;/bin/raw /dev/raw/raw1 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdc1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;33&quot;,RUN+=&quot;/bin/raw /dev/raw/raw2 %M %m&quot;</span><br><span class="line">ACTION==&quot;add&quot;, KERNEL==&quot;/dev/vdd1&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %N&quot;</span><br><span class="line">ACTION==&quot;add&quot;, ENV&#123;MAJOR&#125;==&quot;252&quot;,ENV&#123;MINOR&#125;==&quot;49&quot;,RUN+=&quot;/bin/raw /dev/raw/raw3 %M %m&quot;</span><br><span class="line"></span><br><span class="line">KERNEL==&quot;raw[1-3]&quot;, OWNER=&quot;grid&quot;, GROUP=&quot;oinstall&quot;, MODE=&quot;640&quot;</span><br></pre></td></tr></table></figure></p><p>上述操作需要在双节点执行！且确保在双节点均可以看到裸设备文件，以及grid(或者oracle)用户具有对裸设备的权限</p><h4 id="3、启动udev"><a href="#3、启动udev" class="headerlink" title="3、启动udev"></a>3、启动udev</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">centos6使用start_udev</span><br><span class="line"></span><br><span class="line">centos7之后使用</span><br><span class="line">/sbin/udevadm control --reload-rules</span><br><span class="line">/sbin/udevadm trigger</span><br><span class="line">或者</span><br><span class="line">/sbin/udevadm trigger --type=devices --action=change</span><br><span class="line">查看设备状态：</span><br><span class="line">ll /dev/raw/raw*</span><br><span class="line">在配置过程中，启动udev之后没有看到设备，重启服务器后才生效。</span><br></pre></td></tr></table></figure><h4 id="4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘："><a href="#4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘：" class="headerlink" title="4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘："></a>4、使用scis驱动方式添加磁盘，用udev根据uuid方式绑定磁盘：</h4><p>添加sda，sdb，sdc三块盘，获取共享磁盘的uuid<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 ~]# /usr/lib/udev/scsi_id -g -u /dev/sda</span><br><span class="line">0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0</span><br><span class="line">[root@rac1 ~]# /usr/lib/udev/scsi_id -g -u /dev/sdb</span><br><span class="line">0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2</span><br><span class="line">[root@rac1 ~]# /usr/lib/udev/scsi_id -g -u /dev/sdc</span><br><span class="line">0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1</span><br></pre></td></tr></table></figure></p><h4 id="5、按以下格式写入-etc-udev-rules-d-99-my-asmdevices-rules-文件，每个设备一行，中间不允许换行"><a href="#5、按以下格式写入-etc-udev-rules-d-99-my-asmdevices-rules-文件，每个设备一行，中间不允许换行" class="headerlink" title="5、按以下格式写入[/etc/udev/rules.d/99-my-asmdevices.rules]文件，每个设备一行，中间不允许换行"></a>5、按以下格式写入[/etc/udev/rules.d/99-my-asmdevices.rules]文件，每个设备一行，中间不允许换行</h4><p>节点1：<br>vim /etc/udev/rules.d/99-my-asmdevices.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-vote b  $major $minor; chown grid:asmadmin /dev/asmdisk-vote; chmod 0660 /dev/asmdisk-vote&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-arch b  $major $minor; chown grid:asmadmin /dev/asmdisk-arch; chmod 0660 /dev/asmdisk-arch&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-data b  $major $minor; chown grid:asmadmin /dev/asmdisk-data; chmod 0660 /dev/asmdisk-data&apos;&quot;</span><br></pre></td></tr></table></figure></p><p>节点2：<br>vim /etc/udev/rules.d/99-my-asmdevices.rules<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-0&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-vote b  $major $minor; chown grid:asmadmin /dev/asmdisk-vote; chmod 0660 /dev/asmdisk-vote&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-2&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-arch b  $major $minor; chown grid:asmadmin /dev/asmdisk-arch; chmod 0660 /dev/asmdisk-arch&apos;&quot;</span><br><span class="line">KERNEL==&quot;sd*[!0-9]&quot;, ENV&#123;DEVTYPE&#125;==&quot;disk&quot;, SUBSYSTEM==&quot;block&quot;,  PROGRAM==&quot;/usr/lib/udev/scsi_id -g -u -d $devnode&quot;,  RESULT==&quot;0QEMU_QEMU_HARDDISK_drive-scsi0-0-0-1&quot;, RUN+=&quot;/bin/sh -c &apos;mknod /dev/asmdisk-data b  $major $minor; chown grid:asmadmin /dev/asmdisk-data; chmod 0660 /dev/asmdisk-data&apos;&quot;</span><br></pre></td></tr></table></figure></p><h4 id="6、启动udev"><a href="#6、启动udev" class="headerlink" title="6、启动udev"></a>6、启动udev</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">centos6使用start_udev</span><br><span class="line"></span><br><span class="line">centos7之后使用</span><br><span class="line">/sbin/udevadm control --reload-rules</span><br><span class="line">/sbin/udevadm trigger</span><br><span class="line">或者</span><br><span class="line">/sbin/udevadm trigger --type=devices --action=change</span><br></pre></td></tr></table></figure><p>查看设备状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 ~]# ll /dev/asmdisk-*</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 16 Dec 14 14:18 /dev/asmdisk-arch</span><br><span class="line">brw-rw---- 1 grid asmadmin 8, 32 Dec 14 14:18 /dev/asmdisk-data</span><br><span class="line">brw-rw---- 1 grid asmadmin 8,  0 Dec 14 14:18 /dev/asmdisk-vote</span><br></pre></td></tr></table></figure></p><h4 id="7、使用udevadm查看设备信息"><a href="#7、使用udevadm查看设备信息" class="headerlink" title="7、使用udevadm查看设备信息"></a>7、使用udevadm查看设备信息</h4><p>udevadm info -a -p /sys/block/sda<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">Udevadm info starts with the device specified by the devpath and then</span><br><span class="line">walks up the chain of parent devices. It prints for every device</span><br><span class="line">found, all possible attributes in the udev rules key format.</span><br><span class="line">A rule to match, can be composed by the attributes of the device</span><br><span class="line">and the attributes from one single parent device.</span><br><span class="line"></span><br><span class="line">  looking at device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2/target2:0:0/2:0:0:0/block/sda&apos;:</span><br><span class="line">    KERNEL==&quot;sda&quot;</span><br><span class="line">    SUBSYSTEM==&quot;block&quot;</span><br><span class="line">    DRIVER==&quot;&quot;</span><br><span class="line">    ATTR&#123;ro&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;size&#125;==&quot;41943040&quot;</span><br><span class="line">    ATTR&#123;stat&#125;==&quot;  521604        4   820941  5583621   355886     1462  1263929  7839050        0  9373468 13420933&quot;</span><br><span class="line">    ATTR&#123;range&#125;==&quot;16&quot;</span><br><span class="line">    ATTR&#123;discard_alignment&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;events&#125;==&quot;&quot;</span><br><span class="line">    ATTR&#123;ext_range&#125;==&quot;256&quot;</span><br><span class="line">    ATTR&#123;events_poll_msecs&#125;==&quot;-1&quot;</span><br><span class="line">    ATTR&#123;alignment_offset&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;inflight&#125;==&quot;       0        0&quot;</span><br><span class="line">    ATTR&#123;removable&#125;==&quot;0&quot;</span><br><span class="line">    ATTR&#123;capability&#125;==&quot;50&quot;</span><br><span class="line">    ATTR&#123;events_async&#125;==&quot;&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2/target2:0:0/2:0:0:0&apos;:</span><br><span class="line">    KERNELS==&quot;2:0:0:0&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;scsi&quot;</span><br><span class="line">    DRIVERS==&quot;sd&quot;</span><br><span class="line">    ATTRS&#123;rev&#125;==&quot;1.5.&quot;</span><br><span class="line">    ATTRS&#123;type&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;scsi_level&#125;==&quot;6&quot;</span><br><span class="line">    ATTRS&#123;model&#125;==&quot;QEMU HARDDISK   &quot;</span><br><span class="line">    ATTRS&#123;state&#125;==&quot;running&quot;</span><br><span class="line">    ATTRS&#123;unpriv_sgio&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;queue_type&#125;==&quot;none&quot;</span><br><span class="line">    ATTRS&#123;iodone_cnt&#125;==&quot;0xd660c&quot;</span><br><span class="line">    ATTRS&#123;iorequest_cnt&#125;==&quot;0xd664c&quot;</span><br><span class="line">    ATTRS&#123;device_busy&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_capacity_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;timeout&#125;==&quot;30&quot;</span><br><span class="line">    ATTRS&#123;evt_media_change&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;ioerr_cnt&#125;==&quot;0x18&quot;</span><br><span class="line">    ATTRS&#123;queue_depth&#125;==&quot;128&quot;</span><br><span class="line">    ATTRS&#123;vendor&#125;==&quot;QEMU    &quot;</span><br><span class="line">    ATTRS&#123;evt_soft_threshold_reached&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;device_blocked&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_mode_parameter_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_lun_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;evt_inquiry_change_reported&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;dh_state&#125;==&quot;detached&quot;</span><br><span class="line">    ATTRS&#123;iocounterbits&#125;==&quot;32&quot;</span><br><span class="line">    ATTRS&#123;inquiry&#125;==&quot;&quot;</span><br><span class="line">    ATTRS&#123;vpd_pg83&#125;==&quot;&quot;</span><br><span class="line">    ATTRS&#123;eh_timeout&#125;==&quot;10&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2/target2:0:0&apos;:</span><br><span class="line">    KERNELS==&quot;target2:0:0&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;scsi&quot;</span><br><span class="line">    DRIVERS==&quot;&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5/host2&apos;:</span><br><span class="line">    KERNELS==&quot;host2&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;scsi&quot;</span><br><span class="line">    DRIVERS==&quot;&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0/virtio5&apos;:</span><br><span class="line">    KERNELS==&quot;virtio5&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;virtio&quot;</span><br><span class="line">    DRIVERS==&quot;virtio_scsi&quot;</span><br><span class="line">    ATTRS&#123;device&#125;==&quot;0x0008&quot;</span><br><span class="line">    ATTRS&#123;features&#125;==&quot;0110000000000000000000000000110000000000000000000000000000000000&quot;</span><br><span class="line">    ATTRS&#123;status&#125;==&quot;0x00000007&quot;</span><br><span class="line">    ATTRS&#123;vendor&#125;==&quot;0x1af4&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00/0000:00:0d.0&apos;:</span><br><span class="line">    KERNELS==&quot;0000:00:0d.0&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;pci&quot;</span><br><span class="line">    DRIVERS==&quot;virtio-pci&quot;</span><br><span class="line">    ATTRS&#123;irq&#125;==&quot;10&quot;</span><br><span class="line">    ATTRS&#123;subsystem_vendor&#125;==&quot;0x1af4&quot;</span><br><span class="line">    ATTRS&#123;broken_parity_status&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;class&#125;==&quot;0x010000&quot;</span><br><span class="line">    ATTRS&#123;driver_override&#125;==&quot;(null)&quot;</span><br><span class="line">    ATTRS&#123;consistent_dma_mask_bits&#125;==&quot;64&quot;</span><br><span class="line">    ATTRS&#123;dma_mask_bits&#125;==&quot;64&quot;</span><br><span class="line">    ATTRS&#123;local_cpus&#125;==&quot;ff&quot;</span><br><span class="line">    ATTRS&#123;device&#125;==&quot;0x1004&quot;</span><br><span class="line">    ATTRS&#123;enable&#125;==&quot;1&quot;</span><br><span class="line">    ATTRS&#123;msi_bus&#125;==&quot;&quot;</span><br><span class="line">    ATTRS&#123;local_cpulist&#125;==&quot;0-7&quot;</span><br><span class="line">    ATTRS&#123;vendor&#125;==&quot;0x1af4&quot;</span><br><span class="line">    ATTRS&#123;subsystem_device&#125;==&quot;0x0008&quot;</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;-1&quot;</span><br><span class="line">    ATTRS&#123;d3cold_allowed&#125;==&quot;0&quot;</span><br><span class="line"></span><br><span class="line">  looking at parent device &apos;/devices/pci0000:00&apos;:</span><br><span class="line">    KERNELS==&quot;pci0000:00&quot;</span><br><span class="line">    SUBSYSTEMS==&quot;&quot;</span><br><span class="line">    DRIVERS==&quot;&quot;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-AUTO_INCREMENT参数详解</title>
      <link href="/2018/11/30/mysql-AUTO_INCREMENT%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/11/30/mysql-AUTO_INCREMENT%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h4 id="1、auto-increment的性质就是为新行生成一个唯一标识-例如"><a href="#1、auto-increment的性质就是为新行生成一个唯一标识-例如" class="headerlink" title="1、auto_increment的性质就是为新行生成一个唯一标识,例如"></a>1、auto_increment的性质就是为新行生成一个唯一标识,例如</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建测试表</span><br><span class="line">  CREATE TABLE animals (</span><br><span class="line">     id MEDIUMINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">     name CHAR(30) NOT NULL,</span><br><span class="line">     PRIMARY KEY (id)</span><br><span class="line">);</span><br><span class="line">#插入测试数据:</span><br><span class="line">INSERT INTO animals (name) VALUES</span><br><span class="line">    (&apos;dog&apos;),(&apos;cat&apos;),(&apos;penguin&apos;),</span><br><span class="line">    (&apos;lax&apos;),(&apos;whale&apos;),(&apos;ostrich&apos;);</span><br><span class="line">#查看测试结果：</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="2、上面的auto-increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql-mode中no-auto-value-on-zero被启用时，如果auto-increment列被指定为0，则该值按0处理。"><a href="#2、上面的auto-increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql-mode中no-auto-value-on-zero被启用时，如果auto-increment列被指定为0，则该值按0处理。" class="headerlink" title="2、上面的auto_increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql_mode中no_auto_value_on_zero被启用时，如果auto_increment列被指定为0，则该值按0处理。"></a>2、上面的auto_increment列没有指定插入的值，mysql会自动序列数。也可以显示指定0或者null值来生成序列值，但是当sql_mode中no_auto_value_on_zero被启用时，如果auto_increment列被指定为0，则该值按0处理。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#查看sql_mode模式</span><br><span class="line">show variables like &apos;%sql_mode%&apos;;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                  |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line">#插入数据</span><br><span class="line">insert into animals(id,name) values(0,&apos;pig&apos;);</span><br><span class="line">insert into animals(id,name) values(null,&apos;monkey&apos;);</span><br><span class="line"> [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">|  7 | pig     |</span><br><span class="line">|  8 | monkey  |</span><br><span class="line">+----+---------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line">#自动序列依次递增</span><br><span class="line">#修改sql_mode模式</span><br><span class="line">set @@sql_mode=&apos;NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br><span class="line">show variables like &apos;%sql_mode%&apos;;</span><br><span class="line">+---------------+----------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                                        |</span><br><span class="line">+---------------+----------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | NO_AUTO_VALUE_ON_ZERO,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+----------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#再次插入数据</span><br><span class="line">insert into animals(id,name) values(0,&apos;lion&apos;);</span><br><span class="line">insert into animals(id,name) values(null,&apos;tiger&apos;);</span><br><span class="line">root@db 01:38:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  0 | lion    |</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">|  7 | pig     |</span><br><span class="line">|  8 | monkey  |</span><br><span class="line">|  9 | tiger   |</span><br><span class="line">+----+---------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>当sql_mode中NO_AUTO_VALUE_ON_ZERO为启用状态，插入的数值为0时，按0处理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#再次插入数据提示主键重复。</span><br><span class="line">root@db 01:41:  [aaaa]&gt; insert into animals(id,name) values(0,&apos;giraffe&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;0&apos; for key &apos;PRIMARY&apos;</span><br><span class="line"></span><br><span class="line">#修改sql_mode为原来配置</span><br><span class="line">set @@sql_mode=&apos;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</span><br><span class="line">show variables like &apos;%sql_mode%&apos;;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                  |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><h4 id="3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto-increment对应列的最大值开始，例如："><a href="#3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto-increment对应列的最大值开始，例如：" class="headerlink" title="3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto_increment对应列的最大值开始，例如："></a>3、当向自动增长列插入其他数据，序列值被重置，以便下一个自动生成的值从auto_increment对应列的最大值开始，例如：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO animals (id,name) VALUES(100,&apos;rabbit&apos;);</span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;mouse&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+---------+</span><br><span class="line">| id  | name    |</span><br><span class="line">+-----+---------+</span><br><span class="line">|   0 | lion    |</span><br><span class="line">|   1 | dog     |</span><br><span class="line">|   2 | cat     |</span><br><span class="line">|   3 | penguin |</span><br><span class="line">|   4 | lax     |</span><br><span class="line">|   5 | whale   |</span><br><span class="line">|   6 | ostrich |</span><br><span class="line">|   7 | pig     |</span><br><span class="line">|   8 | monkey  |</span><br><span class="line">|   9 | tiger   |</span><br><span class="line">| 100 | rabbit  |</span><br><span class="line">| 101 | mouse   |</span><br><span class="line">+-----+---------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>当手动插入id为100的值之后，再次默认插入自动增长的值变为101。测试插入位于最小值和最大值之间的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO animals (id,name) VALUES(50,&apos;giraffe&apos;);</span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;tortoise&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   2 | cat      |</span><br><span class="line">|   3 | penguin  |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">+-----+----------+</span><br><span class="line">14 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>手动插入位于最小值和最大值之间的值，对生成的序列值没有任何影响。</p><h4 id="4、更新innodb类型的表中auto-increment的列值，不会重置auto-increment序列，但是myisam和ndb类型的表会重置。"><a href="#4、更新innodb类型的表中auto-increment的列值，不会重置auto-increment序列，但是myisam和ndb类型的表会重置。" class="headerlink" title="4、更新innodb类型的表中auto_increment的列值，不会重置auto_increment序列，但是myisam和ndb类型的表会重置。"></a>4、更新innodb类型的表中auto_increment的列值，不会重置auto_increment序列，但是myisam和ndb类型的表会重置。</h4><p>先以innodb类型表为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">#更新了auto_increment中列的值小于当前最大值</span><br><span class="line">update animals set id=10 where id=2;</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   3 | penguin  |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">+-----+----------+</span><br><span class="line">14 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;donkey&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   3 | penguin  |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">+-----+----------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#更新了auto_increment中列的值大于当前最大值</span><br><span class="line">update animals set id=110 where id=3;</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">| 110 | penguin  |</span><br><span class="line">+-----+----------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line"> SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">| 104 | cow      |</span><br><span class="line">| 110 | penguin  |</span><br><span class="line">+-----+----------+</span><br><span class="line">16 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>auto_increment序列值没有更新，这里面有个大坑，随着序列不断增长，当增长到110是，就会报逐渐重复的错误了，因此自动增长列中的值不要更改。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root@db 02:33:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;110&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 02:36:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(NULL,&apos;cow&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">+-----+----------+</span><br><span class="line">| id  | name     |</span><br><span class="line">+-----+----------+</span><br><span class="line">|   0 | lion     |</span><br><span class="line">|   1 | dog      |</span><br><span class="line">|   4 | lax      |</span><br><span class="line">|   5 | whale    |</span><br><span class="line">|   6 | ostrich  |</span><br><span class="line">|   7 | pig      |</span><br><span class="line">|   8 | monkey   |</span><br><span class="line">|   9 | tiger    |</span><br><span class="line">|  10 | cat      |</span><br><span class="line">|  50 | giraffe  |</span><br><span class="line">| 100 | rabbit   |</span><br><span class="line">| 101 | mouse    |</span><br><span class="line">| 102 | tortoise |</span><br><span class="line">| 103 | donkey   |</span><br><span class="line">| 104 | cow      |</span><br><span class="line">| 105 | cow      |</span><br><span class="line">| 106 | cow      |</span><br><span class="line">| 107 | cow      |</span><br><span class="line">| 108 | cow      |</span><br><span class="line">| 109 | cow      |</span><br><span class="line">| 110 | penguin  |</span><br><span class="line">| 111 | cow      |</span><br><span class="line">+-----+----------+</span><br><span class="line">22 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>下面以myisam类型表为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#创建测试表</span><br><span class="line">CREATE TABLE animals_myisam (</span><br><span class="line">    id MEDIUMINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name CHAR(30) NOT NULL,</span><br><span class="line">    PRIMARY KEY (id)</span><br><span class="line">) ENGINE=MyISAM;</span><br><span class="line">#插入测试数据</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES</span><br><span class="line">    (&apos;dog&apos;),(&apos;cat&apos;),</span><br><span class="line">    (&apos;penguin&apos;),(&apos;lax&apos;),(&apos;whale&apos;),</span><br><span class="line">    (&apos;ostrich&apos;);</span><br><span class="line"></span><br><span class="line">SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">|  3 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line">#更新了auto_increment中列的值小于当前最大值</span><br><span class="line">update animals_myisam set id=10 where id=3;</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES (&apos;mouse&apos;);</span><br><span class="line">SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">| 10 | penguin |</span><br><span class="line">|  4 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">| 11 | mouse   |</span><br><span class="line">+----+---------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">update animals_myisam set id=8 where id=4;</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES (&apos;donkey&apos;);</span><br><span class="line">root@db 03:51:  [aaaa]&gt; SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">| 10 | penguin |</span><br><span class="line">|  8 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">| 11 | mouse   |</span><br><span class="line">| 12 | donkey  |</span><br><span class="line">+----+---------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line">#更新了auto_increment中列的值大于当前最大值</span><br><span class="line">update animals_myisam set id=51 where id=4;</span><br><span class="line">INSERT INTO animals_myisam (name) VALUES (&apos;horse&apos;);</span><br><span class="line">root@db 02:41:  [aaaa]&gt; SELECT * FROM animals_myisam;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  1 | dog     |</span><br><span class="line">|  2 | cat     |</span><br><span class="line">| 10 | penguin |</span><br><span class="line">| 51 | lax     |</span><br><span class="line">|  5 | whale   |</span><br><span class="line">|  6 | ostrich |</span><br><span class="line">| 11 | mouse   |</span><br><span class="line">| 52 | horse   |</span><br><span class="line">+----+---------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>对于myisam类型的表，当对auto_increment列更新时，无论更新后的值大于或者小于当前自增列的值，都按当前列的最大值处理。</p><h4 id="5、可以通过mysql函数last-insert-id查看最后插入的值："><a href="#5、可以通过mysql函数last-insert-id查看最后插入的值：" class="headerlink" title="5、可以通过mysql函数last_insert_id查看最后插入的值："></a>5、可以通过mysql函数last_insert_id查看最后插入的值：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select last_insert_id();</span><br><span class="line">+------------------+</span><br><span class="line">| last_insert_id() |</span><br><span class="line">+------------------+</span><br><span class="line">|               53 |</span><br><span class="line">+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="6、当auto-increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607"><a href="#6、当auto-increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607" class="headerlink" title="6、当auto_increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607"></a>6、当auto_increment列值达到最大值后，再也无法生成后面的值，当再次插入的时候将会报错，提示主键重复。比如MEDIUMINT类型的最大值为8388607</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO animals (id,name) VALUES(8388606,&apos;whale&apos;);</span><br><span class="line">root@db 02:54:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;elephant&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 02:55:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8388607&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 02:55:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8388607&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 02:55:  [aaaa]&gt;  SELECT * FROM animals;</span><br><span class="line">+---------+----------+</span><br><span class="line">| id      | name     |</span><br><span class="line">+---------+----------+</span><br><span class="line">|       0 | lion     |</span><br><span class="line">|       1 | dog      |</span><br><span class="line">|       4 | lax      |</span><br><span class="line">|       5 | whale    |</span><br><span class="line">|       6 | ostrich  |</span><br><span class="line">|       7 | pig      |</span><br><span class="line">|       8 | monkey   |</span><br><span class="line">|       9 | tiger    |</span><br><span class="line">|      10 | cat      |</span><br><span class="line">|      50 | giraffe  |</span><br><span class="line">|     100 | rabbit   |</span><br><span class="line">|     101 | mouse    |</span><br><span class="line">|     102 | tortoise |</span><br><span class="line">|     103 | donkey   |</span><br><span class="line">|     104 | cow      |</span><br><span class="line">|     105 | cow      |</span><br><span class="line">|     106 | cow      |</span><br><span class="line">|     107 | cow      |</span><br><span class="line">|     108 | cow      |</span><br><span class="line">|     109 | cow      |</span><br><span class="line">|     110 | penguin  |</span><br><span class="line">|     111 | cow      |</span><br><span class="line">| 8388606 | whale    |</span><br><span class="line">| 8388607 | elephant |</span><br><span class="line">+---------+----------+</span><br></pre></td></tr></table></figure><p>当插入的值达到8388607值时，没有办法再插入数据了，这时需要修改数据类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">alter table animals modify id int(10) NOT NULL AUTO_INCREMENT;</span><br><span class="line">INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">SELECT * FROM animals;</span><br><span class="line">root@db 02:57:  [aaaa]&gt; INSERT INTO animals (id,name) VALUES(null,&apos;rhinoceros&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 02:58:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+---------+------------+</span><br><span class="line">| id      | name       |</span><br><span class="line">+---------+------------+</span><br><span class="line">|       0 | lion       |</span><br><span class="line">|       1 | dog        |</span><br><span class="line">|       4 | lax        |</span><br><span class="line">|       5 | whale      |</span><br><span class="line">|       6 | ostrich    |</span><br><span class="line">|       7 | pig        |</span><br><span class="line">|       8 | monkey     |</span><br><span class="line">|       9 | tiger      |</span><br><span class="line">|      10 | cat        |</span><br><span class="line">|      50 | giraffe    |</span><br><span class="line">|     100 | rabbit     |</span><br><span class="line">|     101 | mouse      |</span><br><span class="line">|     102 | tortoise   |</span><br><span class="line">|     103 | donkey     |</span><br><span class="line">|     104 | cow        |</span><br><span class="line">|     105 | cow        |</span><br><span class="line">|     106 | cow        |</span><br><span class="line">|     107 | cow        |</span><br><span class="line">|     108 | cow        |</span><br><span class="line">|     109 | cow        |</span><br><span class="line">|     110 | penguin    |</span><br><span class="line">|     111 | cow        |</span><br><span class="line">| 8388606 | whale      |</span><br><span class="line">| 8388607 | elephant   |</span><br><span class="line">| 8388608 | rhinoceros |</span><br><span class="line">+---------+------------+</span><br></pre></td></tr></table></figure></p><p>修改完成之后，再次插入成功,下面是关于数据类型的最小值和最大值的对比<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Type   Storage(Bytes) MinimumValueSignedMinimumValueUnsigned MaximumValueSignedMaximumValueUnsigned</span><br><span class="line">TINYINT    1           -128                   0                127              255</span><br><span class="line">SMALLINT2           -32768               0                32767          65535</span><br><span class="line">MEDIUMINT3           -8388608               0                8388607          16777215</span><br><span class="line">INT        4           -2147483648           0               2147483647      4294967295</span><br><span class="line">BIGINT    8           -2^63               0                2^63-1          2^64-1</span><br></pre></td></tr></table></figure></p><h4 id="7、想要修改auto-increment的起始值，可以找alter-table，比如："><a href="#7、想要修改auto-increment的起始值，可以找alter-table，比如：" class="headerlink" title="7、想要修改auto_increment的起始值，可以找alter table，比如："></a>7、想要修改auto_increment的起始值，可以找alter table，比如：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE animals AUTO_INCREMENT = 100;</span><br></pre></td></tr></table></figure><p>先使用truncate清除表数据,truncate会初始化起始值,delete语句不会初始化,先执行delete操作看一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 02:58:  [aaaa]&gt; delete from animals;</span><br><span class="line">Query OK, 25 rows affected (0.01 sec)</span><br><span class="line">root@db 03:04:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line">root@db 03:04:  [aaaa]&gt; insert into animals (name) values(&apos;dog&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">root@db 03:04:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+---------+------+</span><br><span class="line">| id      | name |</span><br><span class="line">+---------+------+</span><br><span class="line">| 8388609 | dog  |</span><br><span class="line">+---------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>auto_increment的值继续增长，没有从1开始。<br>执行truncate语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:04:  [aaaa]&gt; truncate table animals;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">root@db 03:05:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line">root@db 03:05:  [aaaa]&gt; insert into animals (name) values(&apos;dog&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 03:05:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | dog  |</span><br><span class="line">+----+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>auto_increment序列值从1重新开始计算。<br>下面使用alter table修改auto_increment的起始值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:05:  [aaaa]&gt; truncate table animals;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 03:06:  [aaaa]&gt; alter table animals auto_increment=99;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line">root@db 03:07:  [aaaa]&gt; insert into animals (name) values(&apos;dog&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 03:07:  [aaaa]&gt; insert into animals (name) values(&apos;cat&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">root@db 03:08:  [aaaa]&gt; SELECT * FROM animals;</span><br><span class="line">+-----+------+</span><br><span class="line">| id  | name |</span><br><span class="line">+-----+------+</span><br><span class="line">|  99 | dog  |</span><br><span class="line">| 100 | cat  |</span><br><span class="line">+-----+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>auto_increment起始值从99开始计算。<br>另外使用alter table设置的auto_increment列值，要大于auto_increment列中的最大值才会有效，如果设置的值小于auto_increment列中的最大值，该值会被重置为当前列的最大值+1。<br>如果设置系统级的步长(auto_increment_increment)和初始值(auto_increment_offset)<br>但是auto_increment_offset一定不能大于auto_increment_increment的值，否则auto_increment_offset会被忽略：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:18:  [aaaa]&gt; truncate table animals;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:18:  [aaaa]&gt; set @@auto_increment_offset=5;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:18:  [aaaa]&gt; set @@auto_increment_increment=7;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:19:  [aaaa]&gt; </span><br><span class="line">root@db 04:20:  [aaaa]&gt; </span><br><span class="line">root@db 04:20:  [aaaa]&gt; INSERT INTO animals (name) VALUES</span><br><span class="line">    -&gt;     (&apos;dog&apos;),(&apos;cat&apos;),(&apos;penguin&apos;),</span><br><span class="line">    -&gt;     (&apos;lax&apos;),(&apos;whale&apos;),(&apos;ostrich&apos;);</span><br><span class="line">Query OK, 6 rows affected (0.01 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 04:20:  [aaaa]&gt; select * from animals;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  5 | dog     |</span><br><span class="line">| 12 | cat     |</span><br><span class="line">| 19 | penguin |</span><br><span class="line">| 26 | lax     |</span><br><span class="line">| 33 | whale   |</span><br><span class="line">| 40 | ostrich |</span><br><span class="line">+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h4 id="8、对于myisam中的自增列-如果自增列在复合索引中-自增列会先匹配前缀-根据前缀条件搜索到的结果在自增-计算方法：s-MAX-auto-increment-column-1-WHERE-prefix-given-prefix。例如："><a href="#8、对于myisam中的自增列-如果自增列在复合索引中-自增列会先匹配前缀-根据前缀条件搜索到的结果在自增-计算方法：s-MAX-auto-increment-column-1-WHERE-prefix-given-prefix。例如：" class="headerlink" title="8、对于myisam中的自增列,如果自增列在复合索引中,自增列会先匹配前缀,根据前缀条件搜索到的结果在自增,计算方法：s MAX(auto_increment_column) + 1 WHERE prefix=given-prefix。例如："></a>8、对于myisam中的自增列,如果自增列在复合索引中,自增列会先匹配前缀,根据前缀条件搜索到的结果在自增,计算方法：s MAX(auto_increment_column) + 1 WHERE prefix=given-prefix。例如：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">drop table animals_myisam;</span><br><span class="line">CREATE TABLE animals_myisam (</span><br><span class="line">    grp ENUM(&apos;fish&apos;,&apos;mammal&apos;,&apos;bird&apos;) NOT NULL,</span><br><span class="line">    id MEDIUMINT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name CHAR(30) NOT NULL,</span><br><span class="line">    PRIMARY KEY (grp,id)</span><br><span class="line">) ENGINE=MyISAM;</span><br><span class="line"></span><br><span class="line">INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line"></span><br><span class="line">root@db 03:12:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal |  3 | whale   |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:12:  [aaaa]&gt; INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    -&gt;     (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line">Query OK, 6 rows affected (0.00 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 03:13:  [aaaa]&gt; INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    -&gt;     (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    -&gt;     (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line">Query OK, 6 rows affected (0.00 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 03:13:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal |  3 | whale   |</span><br><span class="line">| mammal |  4 | dog     |</span><br><span class="line">| mammal |  5 | cat     |</span><br><span class="line">| mammal |  6 | whale   |</span><br><span class="line">| mammal |  7 | dog     |</span><br><span class="line">| mammal |  8 | cat     |</span><br><span class="line">| mammal |  9 | whale   |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">18 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>在这种情况下，删除带有包括最大值的增长列，auto_increment序列值会被复用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">delete from animals_myisam where grp=&apos;mammal&apos; and id &gt; 2;</span><br><span class="line">root@db 03:23:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br><span class="line">#再次插入数据</span><br><span class="line">INSERT INTO animals_myisam (grp,name) VALUES (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;);</span><br><span class="line"></span><br><span class="line">root@db 03:23:  [aaaa]&gt; SELECT * FROM animals_myisam ORDER BY grp,id;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal |  3 | dog     |</span><br><span class="line">| mammal |  4 | cat     |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>以上情况是在id没有单独索引的情况下发生的，如果id单独的索引，那么插入的值会变成单一的值，不会跟grp列有任何关系。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">create index id_ind on animals_myisam(id);</span><br><span class="line">INSERT INTO animals_myisam (grp,name) VALUES</span><br><span class="line">    (&apos;mammal&apos;,&apos;dog&apos;),(&apos;mammal&apos;,&apos;cat&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;penguin&apos;),(&apos;fish&apos;,&apos;lax&apos;),(&apos;mammal&apos;,&apos;whale&apos;),</span><br><span class="line">    (&apos;bird&apos;,&apos;ostrich&apos;);</span><br><span class="line">select * from animals_myisam order by mammal;</span><br><span class="line">root@db 03:29:  [aaaa]&gt; select * from animals_myisam order by grp;</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| grp    | id | name    |</span><br><span class="line">+--------+----+---------+</span><br><span class="line">| fish   | 10 | lax     |</span><br><span class="line">| fish   |  1 | lax     |</span><br><span class="line">| fish   |  2 | lax     |</span><br><span class="line">| fish   |  3 | lax     |</span><br><span class="line">| mammal |  2 | cat     |</span><br><span class="line">| mammal | 11 | whale   |</span><br><span class="line">| mammal |  8 | cat     |</span><br><span class="line">| mammal |  7 | dog     |</span><br><span class="line">| mammal |  3 | dog     |</span><br><span class="line">| mammal |  4 | cat     |</span><br><span class="line">| mammal |  1 | dog     |</span><br><span class="line">| bird   |  5 | penguin |</span><br><span class="line">| bird   |  6 | ostrich |</span><br><span class="line">| bird   |  4 | ostrich |</span><br><span class="line">| bird   |  3 | penguin |</span><br><span class="line">| bird   |  2 | ostrich |</span><br><span class="line">| bird   |  9 | penguin |</span><br><span class="line">| bird   |  1 | penguin |</span><br><span class="line">| bird   | 12 | ostrich |</span><br><span class="line">+--------+----+---------+</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] optimize table运行是否支持online ddl</title>
      <link href="/2018/11/27/optimize%20table%E8%BF%90%E8%A1%8C%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81online%20ddl/"/>
      <url>/2018/11/27/optimize%20table%E8%BF%90%E8%A1%8C%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81online%20ddl/</url>
      <content type="html"><![CDATA[<h4 id="0、相应官方文档"><a href="#0、相应官方文档" class="headerlink" title="0、相应官方文档"></a>0、相应官方文档</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（online ddl）官方文档提示当存在fulltext索引表进行优化表操作(optimize table)时是不支持online ddl的</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html#online-ddl-table-operations</span><br><span class="line">（optimize table）官方文档提示当存在索引时，对表进行优化不支持在线ddl</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/optimize-table.html</span><br></pre></td></tr></table></figure><p>下面分别对有主键索引、fulltext索引、无索引情况先查看是否支持online ddl;</p><h4 id="1、带有主键索引"><a href="#1、带有主键索引" class="headerlink" title="1、带有主键索引"></a>1、带有主键索引</h4><p>查看表结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:44:  [aaaa]&gt; show create table optimize_tb;</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table       | Create Table                                                                                                                                                                                     |</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb | CREATE TABLE `optimize_tb` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:44:  [aaaa]&gt; insert into optimize_tb (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (42.98 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:46:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.28 sec)</span><br></pre></td></tr></table></figure></p><p>查看文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]#  ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:44 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 15:46 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p><p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:47:  [aaaa]&gt; delete from optimize_tb limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (8.72 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:47:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.11 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件没有任何变化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:44 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 15:47 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p><p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:48:  [aaaa]&gt;  optimize table optimize_tb;</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table            | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb | optimize | status   | OK                                                                |</span><br><span class="line">+------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (16.34 sec)</span><br></pre></td></tr></table></figure></p><p>session2执行插入语句操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:47:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.18 sec)</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;8166638&apos; for key &apos;PRIMARY&apos;</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166639,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.25 sec)</span><br><span class="line">root@db 15:48:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166640,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.25 sec)</span><br></pre></td></tr></table></figure></p><p>最后查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:48 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  28M 11月 27 15:48 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p><p>数据插入成功，在有主键的情况下，使用optimize table可支持online ddl。</p><h4 id="2、带有fulltext索引"><a href="#2、带有fulltext索引" class="headerlink" title="2、带有fulltext索引"></a>2、带有fulltext索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:53:  [aaaa]&gt; create table optimize_tb1 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.65 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:53:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.04 sec)</span><br></pre></td></tr></table></figure></p><p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:53:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">ERROR 1075 (42000): Incorrect table definition; there can be only one auto column and it must be defined as a key</span><br></pre></td></tr></table></figure></p><p>因为存在自增约束，报错，需要删除约束<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:54:  [aaaa]&gt; alter table optimize_tb1 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (2.84 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:54:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.45 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:54:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:55:  [aaaa]&gt; insert into optimize_tb1 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (26.04 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 15:56:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.48 sec)</span><br></pre></td></tr></table></figure></p><p>创建fulltext 索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:56:  [aaaa]&gt; create fulltext index name_fullind on optimize_tb1(name);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (1 min 12.58 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 1</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:56 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 15:58 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p><p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:58:  [aaaa]&gt; delete from optimize_tb1 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (1 min 13.37 sec)</span><br><span class="line"></span><br><span class="line">root@db 15:59:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.50 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 15:56 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 15:59 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p><p>session1对表进行优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:59:  [aaaa]&gt; optimize table optimize_tb1;</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table             | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb1 | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb1 | optimize | status   | OK                                                                |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (1 min 13.65 sec)</span><br></pre></td></tr></table></figure></p><p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:00:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session3查看数据库线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:00:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |   41 | copy to tmp table               | optimize table optimize_tb1                                      |</span><br><span class="line">|  7 | root | localhost | aaaa | Query   |   40 | Waiting for table metadata lock | insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">|  8 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:00 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:02 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p><p>当表存在fulltext索引是，执行optimize table会锁表，其他会话连接进来无法做增删改操作。</p><h4 id="3、表不存在任何索引"><a href="#3、表不存在任何索引" class="headerlink" title="3、表不存在任何索引"></a>3、表不存在任何索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; create table optimize_tb2 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.60 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; alter table optimize_tb2 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.60 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; alter table optimize_tb2 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (3.07 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:04:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:04:  [aaaa]&gt; insert into optimize_tb2 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (11.85 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:06:  [aaaa]&gt; </span><br><span class="line">root@db 16:07:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.41 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:04 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:06 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p><p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:07:  [aaaa]&gt; delete from optimize_tb2 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (2.50 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:11:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.29 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:04 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:11 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p><p>session1对表进行优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:11:  [aaaa]&gt; optimize table optimize_tb2;</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| Table             | Op       | Msg_type | Msg_text                                                          |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">| aaaa.optimize_tb2 | optimize | note     | Table does not support optimize, doing recreate + analyze instead |</span><br><span class="line">| aaaa.optimize_tb2 | optimize | status   | OK                                                                |</span><br><span class="line">+-------------------+----------+----------+-------------------------------------------------------------------+</span><br><span class="line">2 rows in set (22.04 sec</span><br></pre></td></tr></table></figure></p><p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.35 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.44 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.24 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.38 sec)</span><br><span class="line">root@db 16:11:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">Query OK, 1 row affected (0.20 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:11 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  32M 11月 27 16:12 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p><p>在没有任何索引的情况下，insert语句成功。</p><h4 id="4、当mysql环境变量-old-alter-table为enabled（默认为off）或者-mysql启动参数添加了skip-new选项时，运行optimize-table命令，会使用table-copy的方式重建表，此时online-ddl是不可用的，下面添加skip-new参数重新进行测试。"><a href="#4、当mysql环境变量-old-alter-table为enabled（默认为off）或者-mysql启动参数添加了skip-new选项时，运行optimize-table命令，会使用table-copy的方式重建表，此时online-ddl是不可用的，下面添加skip-new参数重新进行测试。" class="headerlink" title="4、当mysql环境变量 old_alter_table为enabled（默认为off）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，此时online ddl是不可用的，下面添加skip-new参数重新进行测试。"></a>4、当mysql环境变量 old_alter_table为enabled（默认为off）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，此时online ddl是不可用的，下面添加skip-new参数重新进行测试。</h4><p>在/etc/my.cnf添加参数skip-new，重新启动mysql：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# more /etc/my.cnf|grep skip-new</span><br><span class="line">skip-new</span><br><span class="line">[root@dax-mysql-master aaaa]# /etc/init.d/mysql restart</span><br><span class="line">Shutting down MySQL....... SUCCESS! </span><br><span class="line">Starting MySQL..... SUCCESS!</span><br></pre></td></tr></table></figure></p><p>删除上面的测试表，再次进行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:21:  [aaaa]&gt; drop table optimize_tb,optimize_tb1,optimize_tb2;</span><br><span class="line">Query OK, 0 rows affected (1.58 sec)</span><br></pre></td></tr></table></figure></p><h4 id="5、带有主键索引"><a href="#5、带有主键索引" class="headerlink" title="5、带有主键索引"></a>5、带有主键索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:23:  [aaaa]&gt; create table optimize_tb like testfororder;</span><br><span class="line">Query OK, 0 rows affected (1.29 sec)</span><br></pre></td></tr></table></figure></p><p>插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:23:  [aaaa]&gt; insert into optimize_tb (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (33.65 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:24:  [aaaa]&gt; show create table optimize_tb;</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table       | Create Table                                                                                                                                                                                                            |</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb | CREATE TABLE `optimize_tb` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=8166638 DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:25:  [aaaa]&gt;  select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.25 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:23 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:24 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p><p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:26:  [aaaa]&gt; delete from optimize_tb limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (9.18 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:26:  [aaaa]&gt; select count(*) from optimize_tb;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.13 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:23 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:26 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p><p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; optimize table optimize_tb;</span><br><span class="line">Query OK, 500000 rows affected (26.01 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>session2执行插入操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                            |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |   19 | copy to tmp table               | optimize table optimize_tb                                      |</span><br><span class="line">|  3 | root | localhost | aaaa | Query   |   11 | Waiting for table metadata lock | insert into optimize_tb(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:27 optimize_tb.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  28M 11月 27 16:27 optimize_tb.ibd</span><br></pre></td></tr></table></figure></p><p>在存在主键索引的情况下，数据插入失败，提示锁等待超时。</p><h4 id="6、表中带有fulltext索引"><a href="#6、表中带有fulltext索引" class="headerlink" title="6、表中带有fulltext索引"></a>6、表中带有fulltext索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:31:  [aaaa]&gt; create table optimize_tb1 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (1.07 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>删除主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:31:  [aaaa]&gt; alter table optimize_tb1 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.13 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; alter table optimize_tb1 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.41 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:31:  [aaaa]&gt; show create table optimize_tb1;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb1 | CREATE TABLE `optimize_tb1` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:32:  [aaaa]&gt; insert into optimize_tb1 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (14.49 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:32:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.44 sec)</span><br></pre></td></tr></table></figure></p><p>创建fulltext 索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:33:  [aaaa]&gt; create fulltext index name_fullind on optimize_tb1(name);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (57.22 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 1</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:33 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 16:34 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p><p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:34:  [aaaa]&gt; delete from optimize_tb1 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (59.90 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:35:  [aaaa]&gt; select count(*) from optimize_tb1;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.69 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:33 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  92M 11月 27 16:36 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p><p>session1执行对表进行优化操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:36:  [aaaa]&gt; optimize table optimize_tb1;</span><br><span class="line">Query OK, 500000 rows affected (55.85 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>session2对表插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:37:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 16:37:  [aaaa]&gt; insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:37:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |    9 | copy to tmp table               | optimize table optimize_tb1                                      |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |    8 | Waiting for table metadata lock | insert into optimize_tb1(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb1</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:37 optimize_tb1.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  48M 11月 27 16:38 optimize_tb1.ibd</span><br></pre></td></tr></table></figure></p><p>在存在fulltext索引的情况下，数据插入失败，提示锁等待超时。</p><h4 id="7、表中没有任何索引"><a href="#7、表中没有任何索引" class="headerlink" title="7、表中没有任何索引"></a>7、表中没有任何索引</h4><p>创建测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:38:  [aaaa]&gt; create table optimize_tb2 like optimize_tb;</span><br><span class="line">Query OK, 0 rows affected (0.44 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:39:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                                                      |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; alter table optimize_tb2 modify id int(7);</span><br><span class="line">Query OK, 0 rows affected (1.39 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; alter table optimize_tb2 drop primary key;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:40:  [aaaa]&gt; show create table optimize_tb2;</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table        | Create Table                                                                                                                                                 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| optimize_tb2 | CREATE TABLE `optimize_tb2` (</span><br><span class="line">  `id` int(7) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:40:  [aaaa]&gt; insert into optimize_tb2 (select * from testfororder limit 1000000);</span><br><span class="line">Query OK, 1000000 rows affected (16.74 sec)</span><br><span class="line">Records: 1000000  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 16:41:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  1000000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.49 sec)</span><br></pre></td></tr></table></figure></p><p>查看数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:40 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:41 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p><p>删除前50万数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:42:  [aaaa]&gt; delete from optimize_tb2 limit 500000;</span><br><span class="line">Query OK, 500000 rows affected (3.96 sec)</span><br><span class="line"></span><br><span class="line">root@db 16:42:  [aaaa]&gt; select count(*) from optimize_tb2;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|   500000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.32 sec)</span><br></pre></td></tr></table></figure></p><p>数据文件大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master aaaa]# ls -lhtr|grep optimize_tb2</span><br><span class="line">-rw-r-----. 1 mysql mysql 8.5K 11月 27 16:40 optimize_tb2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  56M 11月 27 16:42 optimize_tb2.ibd</span><br></pre></td></tr></table></figure></p><p>session1执行优化表操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:42:  [aaaa]&gt; optimize table optimize_tb2;</span><br><span class="line">Query OK, 500000 rows affected (23.61 sec)</span><br><span class="line">Records: 500000  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>session2执行插入数据操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:43:  [aaaa]&gt; insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session3查看mysql线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:43:  [(none)]&gt; show processlist;</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info                                                             |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">|  2 | root | localhost | aaaa | Query   |    7 | copy to tmp table               | optimize table optimize_tb2                                      |</span><br><span class="line">|  4 | root | localhost | NULL | Query   |    0 | starting                        | show processlist                                                 |</span><br><span class="line">|  5 | root | localhost | aaaa | Query   |    6 | Waiting for table metadata lock | insert into optimize_tb2(id,name,age) values(8166638,&apos;lucy1&apos;,24) |</span><br><span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------------------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>在没有任何索引的情况下，插入数据锁等待</p><h4 id="8、结论"><a href="#8、结论" class="headerlink" title="8、结论"></a>8、结论</h4><p>当mysql环境变量 old_alter_table为enabled（默认为disabled）或者 mysql启动参数添加了skip-new选项时，运行optimize table命令，会使用table copy的方式重建表，无论表中有无索引，此时online ddl是不可用的；<br>当mysql环境变量old_alter_table为disabled（默认为disabled）或者 mysql启动参数没有添加了skip-new选项时，运行optimize table命令，当表中不存在fulltext索引时，online ddl可用，当表中存在fulltext索引是，online ddl不可用。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mgr模拟the master has purged binary logs containing GTIDs that the slave requires.&#39;, Error_code: 1236</title>
      <link href="/2018/11/25/mysql-mgr%E6%A8%A1%E6%8B%9Fthe%20master%20has%20purged%20binary%20logs%20containing%20GTIDs%20that%20the%20slave%20requires/"/>
      <url>/2018/11/25/mysql-mgr%E6%A8%A1%E6%8B%9Fthe%20master%20has%20purged%20binary%20logs%20containing%20GTIDs%20that%20the%20slave%20requires/</url>
      <content type="html"><![CDATA[<h4 id="0、实验环境介绍："><a href="#0、实验环境介绍：" class="headerlink" title="0、实验环境介绍："></a>0、实验环境介绍：</h4><p>mysql-mgr单主模式主节点1、从节点1、从节点2</p><h4 id="1、实验一，手动删除主库binlog日志文件"><a href="#1、实验一，手动删除主库binlog日志文件" class="headerlink" title="1、实验一，手动删除主库binlog日志文件"></a>1、实验一，手动删除主库binlog日志文件</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行stop group_replication;</span><br></pre></td></tr></table></figure></p><p>主库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#切换日志，创建表gtid_test10,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test10 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 05:48:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000029 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-27 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#切换日志，创建表gtid_test10,并查看当前的binlog日志文件：</span><br><span class="line">root@db 05:48:  [test]&gt; flush logs;create table gtid_test11 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">root@db 05:48:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000030 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-28 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#主库手动移除binlog文件：</span><br><span class="line">mv mysql-binlog.000029 /tmp/</span><br></pre></td></tr></table></figure></p><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">执行start group_replication;</span><br><span class="line">#查看从库2的日志</span><br><span class="line">2018-09-18T05:49:55.983888Z 93 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T05:49:55.984034Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:31.&apos;</span><br><span class="line">2018-09-18T05:49:56.054981Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:56.144944Z 93 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T05:49:56.155058Z 95 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T05:49:56.157141Z 95 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T05:49:56.179441Z 96 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T05:49:56.326072Z 95 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: Could not open log file (server_errno=1236)</span><br><span class="line">2018-09-18T05:49:56.326236Z 95 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;Could not open log file&apos;, Error_code: 1236</span><br><span class="line">#因为已经手动删除了binlog文件，从库2无法从主库获取到binlog文件，报错</span><br><span class="line">2018-09-18T05:49:56.326310Z 95 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000029&apos;, position 4</span><br><span class="line">2018-09-18T05:49:56.326422Z 93 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T05:49:56.347776Z 96 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T05:49:56.438760Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:56.510091Z 93 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</span><br><span class="line">2018-09-18T05:49:56.572561Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从库2开始尝试从从库1节点获取binlog文件，因为只是删除了主库节点的binlog文件，从库1的文件未删除，从库2获取到所需要的文件，开始进行同步。</span><br><span class="line">2018-09-18T05:49:56.643413Z 93 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T05:49:56.643906Z 99 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T05:49:56.646363Z 99 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T05:49:56.666439Z 100 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T05:49:56.882987Z 93 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T05:49:56.905507Z 99 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T05:49:56.905535Z 99 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000005&apos;, position 10512</span><br><span class="line">2018-09-18T05:49:56.999936Z 93 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T05:49:57.084035Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p><p>同步完成。</p><h4 id="2、实验二，使用purge命令删除主库binlog文件"><a href="#2、实验二，使用purge命令删除主库binlog文件" class="headerlink" title="2、实验二，使用purge命令删除主库binlog文件"></a>2、实验二，使用purge命令删除主库binlog文件</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication:</span><br></pre></td></tr></table></figure></p><p>主库1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#切换日志，创建表gtid_test12,并查看当前的binlog日志文件：</span><br><span class="line">root@db 06:04:  [test]&gt; flush logs;create table gtid_test12 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 06:04:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000033 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-30 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#切换日志，创建表gtid_test13,并查看当前的binlog日志文件：</span><br><span class="line">root@db 06:04:  [test]&gt; flush logs;create table gtid_test13 (ID int) engine=innodb;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">root@db 06:04:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                         |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000034 |      493 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-31 |</span><br><span class="line">+---------------------+----------+--------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#主库清除mysql-binlog.000034之前的所有binlog日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000034&apos;;</span><br><span class="line">#查看日志log目录下的34之前的日志已经全部清除：</span><br><span class="line">ll mysql-binlog.*</span><br><span class="line">-rw-r----- 1 mysql mysql 493 Sep 18 06:04 mysql-binlog.000034</span><br><span class="line">-rw-r----- 1 mysql mysql  36 Sep 18 06:22 mysql-binlog.index</span><br><span class="line"></span><br><span class="line">#查看主库gtid信息，gtid_purged已经有记录：</span><br><span class="line">show global variables like &apos;%gtid%&apos;;</span><br><span class="line">root@db 06:37:  [test]&gt; show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                                                                                                                                                     |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery                       | ON                                                                                                                                                                        |</span><br><span class="line">| enforce_gtid_consistency                          | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_allow_local_disjoint_gtids_join | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_gtid_assignment_block_size      | 1000000                                                                                                                                                                   |</span><br><span class="line">| gtid_executed                                     | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-31 |</span><br><span class="line">| gtid_executed_compression_period                  | 1000                                                                                                                                                                      |</span><br><span class="line">| gtid_mode                                         | ON                                                                                                                                                                        |</span><br><span class="line">| gtid_owned                                        |                                                                                                                                                                           |</span><br><span class="line">| gtid_purged                                       | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-30 |</span><br><span class="line">| session_track_gtids                               | OFF                                                                                                                                                                       |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>从节点2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p><p>查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T06:38:36.664372Z 107 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2&quot;; group_replication_local_address: &quot;dax-mysql-slave2:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-slave:24901,dax-mysql-master:24901,dax-mysql-slave2:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-09-18T06:38:36.664408Z 107 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-09-18T06:38:36.664428Z 107 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-09-18T06:38:36.664457Z 107 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;c6ac9ccd-b80b-11e8-b968-000d3a801bf4&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-09-18T06:38:36.664812Z 109 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 493, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:38:36.736702Z 107 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-09-18T06:38:36.736749Z 107 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-09-18T06:38:36.736774Z 107 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-09-18T06:38:36.736708Z 112 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000014&apos; position: 4</span><br><span class="line">2018-09-18T06:38:36.737167Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-09-18T06:38:36.737227Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-09-18T06:38:38.815550Z 107 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address dax-mysql-master:3306.&apos;</span><br><span class="line">2018-09-18T06:38:38.815711Z 0 [ERROR] Plugin group_replication reported: &apos;Group contains 3 members which is greater than group_replication_auto_increment_increment value of 1. This can lead to an higher rate of transactional aborts.&apos;</span><br><span class="line">2018-09-18T06:38:38.816035Z 117 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T06:38:38.816125Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:33.&apos;</span><br><span class="line">2018-09-18T06:38:38.881138Z 117 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从节点2选择从从节点1获取binlog文件，因为从节点1文件没有删除，获取binlog文件正常。</span><br><span class="line">2018-09-18T06:38:38.959786Z 117 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T06:38:38.960147Z 119 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T06:38:38.962244Z 119 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T06:38:38.982193Z 120 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T06:38:39.194864Z 117 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T06:38:39.218168Z 119 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T06:38:39.218197Z 119 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000005&apos;, position 11362</span><br><span class="line">2018-09-18T06:38:39.313623Z 117 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:38:39.400236Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p><p>同步完成。</p><h4 id="3、实验三，删除主库节点和从节点1的binlog文件。"><a href="#3、实验三，删除主库节点和从节点1的binlog文件。" class="headerlink" title="3、实验三，删除主库节点和从节点1的binlog文件。"></a>3、实验三，删除主库节点和从节点1的binlog文件。</h4><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br></pre></td></tr></table></figure></p><p>主库1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">3切换日志，创建表gtid_test14,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test14 (ID int) engine=innodb;</span><br><span class="line">show master status;</span><br><span class="line">#切换日志，创建表gtid_test15,并查看当前的binlog日志文件：</span><br><span class="line">flush logs;create table gtid_test15 (ID int) engine=innodb;</span><br><span class="line">show master status;</span><br><span class="line">#清除mysql-binlog.000036之前的日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000036&apos;;</span><br><span class="line">[root@dax-mysql-master log]# ll mysql-binlog.*</span><br><span class="line">-rw-r----- 1 mysql mysql 493 Sep 18 06:53 mysql-binlog.000036</span><br><span class="line">-rw-r----- 1 mysql mysql  36 Sep 18 06:56 mysql-binlog.index</span><br></pre></td></tr></table></figure></p><p>从库1删除binlog日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                                                 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000005 |    11728 |              |                  | 324a6fd1-ba55-11e8-b3ff-000d3a800ed3:1,</span><br><span class="line">8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-34 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">#切换binlog日志：</span><br><span class="line">flush logs;</span><br><span class="line">show master status;</span><br><span class="line">root@db 06:57:  [test]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                                                 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000006 |      350 |              |                  | 324a6fd1-ba55-11e8-b3ff-000d3a800ed3:1,</span><br><span class="line">8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-34 |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">[root@dax-mysql-slave log]# ll </span><br><span class="line">total 96</span><br><span class="line">-rw-r----- 1 mysql mysql 53478 Sep 18 06:49 error.log</span><br><span class="line">-rw-r----- 1 mysql mysql   177 Sep 17 08:39 mysql-binlog.000001</span><br><span class="line">-rw-r----- 1 mysql mysql   437 Sep 17 09:21 mysql-binlog.000002</span><br><span class="line">-rw-r----- 1 mysql mysql   217 Sep 17 09:25 mysql-binlog.000003</span><br><span class="line">-rw-r----- 1 mysql mysql   209 Sep 17 09:26 mysql-binlog.000004</span><br><span class="line">-rw-r----- 1 mysql mysql 11774 Sep 18 06:57 mysql-binlog.000005</span><br><span class="line">-rw-r----- 1 mysql mysql   350 Sep 18 06:57 mysql-binlog.000006</span><br><span class="line">-rw-r----- 1 mysql mysql   216 Sep 18 06:57 mysql-binlog.index</span><br><span class="line">-rw-r--r-- 1 mysql mysql     0 Sep 17 08:36 mysqld.log</span><br><span class="line">-rw-r----- 1 mysql mysql  1968 Sep 18 06:57 slow.log</span><br><span class="line">#删除mysql-binlog.000006之前的所有日志：</span><br><span class="line">purge binary logs to &apos;mysql-binlog.000006&apos;;</span><br><span class="line">[root@dax-mysql-slave log]# ll </span><br><span class="line">total 68</span><br><span class="line">-rw-r----- 1 mysql mysql 53478 Sep 18 06:49 error.log</span><br><span class="line">-rw-r----- 1 mysql mysql   350 Sep 18 06:57 mysql-binlog.000006</span><br><span class="line">-rw-r----- 1 mysql mysql    36 Sep 18 06:58 mysql-binlog.index</span><br><span class="line">-rw-r--r-- 1 mysql mysql     0 Sep 17 08:36 mysqld.log</span><br><span class="line">-rw-r----- 1 mysql mysql  1968 Sep 18 06:57 slow.log</span><br></pre></td></tr></table></figure></p><p>从库2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start group_replicatinon;</span><br></pre></td></tr></table></figure></p><p>查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T06:59:20.236425Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</span><br><span class="line">2018-09-18T06:59:20.309947Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:59:20.391623Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T06:59:20.391891Z 142 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T06:59:20.394226Z 142 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T06:59:20.416722Z 143 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T06:59:20.424400Z 142 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T06:59:20.424467Z 142 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T06:59:20.424488Z 142 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T06:59:20.424640Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T06:59:20.436806Z 143 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T06:59:20.522269Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T06:59:20.603837Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 3/10&apos;</span><br><span class="line">2018-09-18T07:00:20.679461Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:00:20.762021Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 66d67181-ba5b-11e8-9c54-000d3a800ed3 at dax-mysql-slave port: 3306.&apos;</span><br><span class="line">2018-09-18T07:00:20.762368Z 146 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:00:20.764842Z 146 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-slave:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:00:20.787728Z 147 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:00:20.794590Z 146 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T07:00:20.794623Z 146 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T07:00:20.794635Z 146 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T07:00:20.794786Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:00:20.807977Z 147 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T07:00:20.895774Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-slave&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">#从库2多次尝试从从库1获取binlog日志，没有成功，切换master_host节点，尝试从主库获取binlog日志文件：</span><br><span class="line">2018-09-18T07:00:20.980112Z 136 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 4/10&apos;</span><br><span class="line">2018-09-18T07:00:21.052930Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:00:21.141126Z 136 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T07:00:21.141498Z 150 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:00:21.143773Z 150 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:00:21.166993Z 151 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:00:21.171461Z 150 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-09-18T07:00:21.171518Z 150 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-09-18T07:00:21.171528Z 150 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-09-18T07:00:21.171645Z 136 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:00:21.186565Z 151 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-09-18T07:00:21.271867Z 136 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">....</span><br><span class="line">[ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br></pre></td></tr></table></figure></p><p>因为主库1和从库1的binlog文件都删除，从库2无法同步，最后退出集群。</p><h4 id="4、查看主库清除的日志"><a href="#4、查看主库清除的日志" class="headerlink" title="4、查看主库清除的日志"></a>4、查看主库清除的日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> show global variables like &apos;%gtid%&apos;;</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                                                                                                                                                     |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery                       | ON                                                                                                                                                                        |</span><br><span class="line">| enforce_gtid_consistency                          | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_allow_local_disjoint_gtids_join | ON                                                                                                                                                                        |</span><br><span class="line">| group_replication_gtid_assignment_block_size      | 1000000                                                                                                                                                                   |</span><br><span class="line">| gtid_executed                                     | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-35 |</span><br><span class="line">| gtid_executed_compression_period                  | 1000                                                                                                                                                                      |</span><br><span class="line">| gtid_mode                                         | ON                                                                                                                                                                        |</span><br><span class="line">| gtid_owned                                        |                                                                                                                                                                           |</span><br><span class="line">| gtid_purged                                       | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33 |</span><br><span class="line">| session_track_gtids                               | OFF                                                                                                                                                                       |</span><br><span class="line">+---------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>从库2尝试过滤掉缺失的那部分日志，然后重新加入集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">reset master;</span><br><span class="line">set global GTID_PURGED=&quot;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,d240752c-b809-11e8-8947-000d3a800ed3:1,dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&quot;;</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p><p>再次查看从库2的日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">2018-09-18T07:08:05.524626Z 125 [Note] @@GLOBAL.GTID_PURGED was changed from &apos;&apos; to &apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&apos;.</span><br><span class="line">2018-09-18T07:08:05.524661Z 125 [Note] @@GLOBAL.GTID_EXECUTED was changed from &apos;&apos; to &apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-33&apos;.</span><br><span class="line">2018-09-18T07:08:20.457841Z 125 [Note] Plugin group_replication reported: &apos;Group communication SSL configuration: group_replication_ssl_mode: &quot;DISABLED&quot;&apos;</span><br><span class="line">2018-09-18T07:08:20.457971Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 10.0.7.51/24,127.0.0.1/8 to the whitelist&apos;</span><br><span class="line">2018-09-18T07:08:20.458188Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Translated &apos;dax-mysql-slave2&apos; to 10.0.7.51&apos;</span><br><span class="line">2018-09-18T07:08:20.458321Z 125 [Warning] Plugin group_replication reported: &apos;[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.&apos;</span><br><span class="line">2018-09-18T07:08:20.458401Z 125 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</span><br><span class="line">2018-09-18T07:08:20.458433Z 125 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2&quot;; group_replication_local_address: &quot;dax-mysql-slave2:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-slave:24901,dax-mysql-master:24901,dax-mysql-slave2:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-09-18T07:08:20.458473Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-09-18T07:08:20.458480Z 125 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-09-18T07:08:20.458503Z 125 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;c6ac9ccd-b80b-11e8-b968-000d3a801bf4&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-09-18T07:08:20.458664Z 181 [Note] Plugin group_replication reported: &apos;Detected previous RESET MASTER invocation or an issue exists in the group replication applier relay log. Purging existing applier logs.&apos;</span><br><span class="line">2018-09-18T07:08:20.531810Z 181 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:20.632692Z 125 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-09-18T07:08:20.632736Z 125 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-09-18T07:08:20.632758Z 125 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-09-18T07:08:20.632694Z 184 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:08:20.632947Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-09-18T07:08:20.632977Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-09-18T07:08:22.329812Z 125 [Note] Plugin group_replication reported: &apos;This server is working as secondary member with primary member address dax-mysql-master:3306.&apos;</span><br><span class="line">2018-09-18T07:08:22.329901Z 0 [ERROR] Plugin group_replication reported: &apos;Group contains 3 members which is greater than group_replication_auto_increment_increment value of 1. This can lead to an higher rate of transactional aborts.&apos;</span><br><span class="line">2018-09-18T07:08:22.330145Z 189 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</span><br><span class="line">2018-09-18T07:08:22.330221Z 0 [Note] Plugin group_replication reported: &apos;Group membership changed to dax-mysql-slave:3306, dax-mysql-master:3306, dax-mysql-slave2:3306 on view 15371510730966421:37.&apos;</span><br><span class="line">2018-09-18T07:08:22.394512Z 189 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:22.468142Z 189 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 8182e5ae-af54-11e8-af0e-000d3a801ae2 at dax-mysql-master port: 3306.&apos;</span><br><span class="line">2018-09-18T07:08:22.468378Z 191 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-09-18T07:08:22.470340Z 191 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@dax-mysql-master:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-09-18T07:08:22.490866Z 192 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-09-18T07:08:22.632774Z 189 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-09-18T07:08:22.653083Z 191 [Note] Slave I/O thread killed while reading event for channel &apos;group_replication_recovery&apos;</span><br><span class="line">2018-09-18T07:08:22.653098Z 191 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;mysql-binlog.000036&apos;, position 1381</span><br><span class="line">2018-09-18T07:08:22.734186Z 189 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;dax-mysql-master&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-09-18T07:08:22.808784Z 0 [Note] Plugin group_replication reported: &apos;This server was declared online within the replication group&apos;</span><br></pre></td></tr></table></figure></p><p>此时从库2与主库、从库1的数据是不一致的，gtid_test14表时不存在的，因此需要使用pt-table-checksum和pt-table-sync去同步，但是该方法在mysql-mgr环境下测试没有成功。<br>另一种方法是直接备份一份主节点的最新备份数据，在从库2上恢复。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] GlusterFS部署详解</title>
      <link href="/2018/11/25/GlusterFS/"/>
      <url>/2018/11/25/GlusterFS/</url>
      <content type="html"><![CDATA[<h4 id="0、安装之前须知："><a href="#0、安装之前须知：" class="headerlink" title="0、安装之前须知："></a>0、安装之前须知：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">推荐使用xfs，没用xfs推荐使用ext4，其他文件系统也可兼容；</span><br><span class="line">生产环境DNS NTP服务必须安装,DNS服务配置可点击[此处](https://zeven0707.github.io/2018/11/22/DNS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/)；</span><br><span class="line">如果是虚拟机环境最少1G内存；</span><br><span class="line">最好配置2个网卡，一个管理接口，一个数据传输接口；</span><br><span class="line">如果使用vm克隆额外的机器，确保glusterfs没有安装，如果安装了Gluster,会在每个系统上生产一个uuid，因此如果克隆了一个已经安装了gluster的系统，后面会报错；</span><br><span class="line">如果使用物理服务器，建议最低配置（2 CPU’s, 2GB of RAM, 1GBE），板载组件不如附加组件强大；</span><br><span class="line">安装官方文档，点击[此处](https://docs.gluster.org/en/latest/Install-Guide/Install/)</span><br><span class="line">centos7快速安装指南，点击[此处](https://wiki.centos.org/SpecialInterestGroup/Storage/gluster-Quickstart)</span><br><span class="line">/var/log目录最好单独挂在，一旦日志目录无法写入信息，gluster fs会出现古怪现象</span><br></pre></td></tr></table></figure><h4 id="1、配置yum源"><a href="#1、配置yum源" class="headerlink" title="1、配置yum源"></a>1、配置yum源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-gluster</span><br></pre></td></tr></table></figure><h4 id="2、在两个节点上添加磁盘，格式化-并挂在目录"><a href="#2、在两个节点上添加磁盘，格式化-并挂在目录" class="headerlink" title="2、在两个节点上添加磁盘，格式化,并挂在目录"></a>2、在两个节点上添加磁盘，格式化,并挂在目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#格式化磁盘，创建相应的挂在目录</span><br><span class="line">mkfs.xfs -i size=512 /dev/sdb1</span><br><span class="line">mkdir -p /gfs/test1</span><br><span class="line">#将挂在配置信息写入fstab配置文件，以便重启自动挂载</span><br><span class="line">vi /etc/fstab</span><br><span class="line">/dev/sdb1 /gfs/test1 xfs defaults 1 2</span><br><span class="line">#加载修改的配置信息</span><br><span class="line">mount -a &amp;&amp; mount</span><br></pre></td></tr></table></figure><p>Note: 在CentOS 6操作系统,需要安装xfs文件系统：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xfsprogs</span><br></pre></td></tr></table></figure></p><h4 id="3、安装、配置glusterd服务"><a href="#3、安装、配置glusterd服务" class="headerlink" title="3、安装、配置glusterd服务"></a>3、安装、配置glusterd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install glusterfs-server</span><br></pre></td></tr></table></figure><p>启动GlusterFS 管理进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#加入开机启动</span><br><span class="line">systemctl enable glusterd</span><br><span class="line">ln -s &apos;/usr/lib/systemd/system/glusterd.service&apos; &apos;/etc/systemd/system/multi-user.target.wants/glusterd.service&apos;</span><br><span class="line">#启动glusterd</span><br><span class="line">systemctl start glusterd</span><br><span class="line">#查看glusterd状态信息</span><br><span class="line">systemctl status glusterd</span><br><span class="line">● glusterd.service - GlusterFS, a clustered file-system server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/glusterd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-11-15 12:08:54 EST; 15s ago</span><br><span class="line">  Process: 2808 ExecStart=/usr/sbin/glusterd -p /var/run/glusterd.pid --log-level $LOG_LEVEL $GLUSTERD_OPTIONS (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 2810 (glusterd)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   CGroup: /system.slice/glusterd.service</span><br><span class="line">           └─2810 /usr/sbin/glusterd -p /var/run/glusterd.pid --log-level INFO</span><br><span class="line"></span><br><span class="line">Nov 15 12:08:53 node1 systemd[1]: Starting GlusterFS, a clustered file-system server...</span><br><span class="line">Nov 15 12:08:54 node1 systemd[1]: Started GlusterFS, a clustered file-system server.</span><br></pre></td></tr></table></figure></p><h4 id="4、防火墙配置"><a href="#4、防火墙配置" class="headerlink" title="4、防火墙配置"></a>4、防火墙配置</h4><p>默认glusted监听tcp/24007 ，但是你增加一个brick，会开启一个新的端口，通过命令”gluster volume status”可以查询到<br>，因此如果各个节点配置了防火墙，新增一个brick之后，需要注意修改防火墙的端口限制，不然下面的配置受信任池会报错。</p><h4 id="5、配置受信任池"><a href="#5、配置受信任池" class="headerlink" title="5、配置受信任池"></a>5、配置受信任池</h4><p>node1操作，将node2添加到受信任池：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: success.</span><br></pre></td></tr></table></figure></p><p>如果防火墙开启可能会提示下面错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: failed: Probe returned with Transport endpoint is not connected</span><br></pre></td></tr></table></figure></p><p>node2操作，将node1添加到受信任池<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# gluster peer probe node1</span><br><span class="line">peer probe: success. Host node1 port 24007 already in peer list</span><br></pre></td></tr></table></figure></p><h4 id="6、建立GlusterFS-volume"><a href="#6、建立GlusterFS-volume" class="headerlink" title="6、建立GlusterFS volume"></a>6、建立GlusterFS volume</h4><p>node1 and node2操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /gfs/test1/gv0</span><br></pre></td></tr></table></figure></p><p>在任意一个节点上执行即可，不需要重复执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv0 replica 2 node1:/gfs/test1/gv0 node2:/gfs/test1/gv0</span><br><span class="line">[root@node1 ~]# gluster volume create gv0 replica 2 node1:/gfs/test1/gv0 node2:/gfs/test1/gv0</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">volume create: gv0: success: please start the volume to access data</span><br></pre></td></tr></table></figure></p><p>提示只有2个副本有可能出现脑裂的情况，创建带有仲裁节点以上的gluserfs volume至少三个节点，因此两个节点的副本集可以只能忽略这个问题。<br>下面启动创建的gv0卷<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume start gv0</span><br><span class="line">[root@node1 ~]# gluster volume start gv0</span><br><span class="line">volume start: gv0: success</span><br><span class="line">Confirm that the volume shows &quot;Started&quot;:</span><br></pre></td></tr></table></figure></p><p>查看启动的gv0卷信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume info</span><br><span class="line">[root@node1 ~]# gluster volume info</span><br><span class="line"> </span><br><span class="line">Volume Name: gv0</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: 79c81f10-0cb8-4f26-a7ab-d21fe19f0bbf</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x 2 = 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv0</span><br><span class="line">Brick2: node2:/gfs/test1/gv0</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure></p><p>/var/log/glusterfs如果没有正常启动，可以查看日志</p><h4 id="7、测试Glusterfs-volume-gv0副本集是否生效"><a href="#7、测试Glusterfs-volume-gv0副本集是否生效" class="headerlink" title="7、测试Glusterfs volume gv0副本集是否生效"></a>7、测试Glusterfs volume gv0副本集是否生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#挂在到任意空目录</span><br><span class="line">mount -t glusterfs node1:/gv0 /mnt</span><br><span class="line">#创造测试数据</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#查看生成数据的数量</span><br><span class="line">ls  /mnt | wc -l</span><br><span class="line">#在node1和node2的/gfs/test1/gv0目录下均生成了100个文件</span><br><span class="line">ls /gfs/test1/gv0 |wc -l</span><br></pre></td></tr></table></figure><p>[root@node1 ~]# gluster volume create gv1 disperse 2 node1:/gfs/test1/gv1 node2:/gfs/test1/gv1<br>disperse count must be greater than 2<br>disperse option given twice</p><p>Usage:<br>volume create <new-volname> [stripe <count>] [replica <count> [arbiter <count>]] [disperse [<count>]] [disperse-data <count>] [redundancy <count>] [transport &lt;tcp|rdma|tcp,rdma&gt;] <new-brick>?&lt;vg_name&gt;… [force]</new-brick></count></count></count></count></count></count></new-volname></p><h4 id="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"><a href="#8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来" class="headerlink" title="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"></a>8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node3</span><br><span class="line">[root@node1 ~]# gluster peer status</span><br><span class="line">Number of Peers: 2</span><br><span class="line"></span><br><span class="line">Hostname: node2</span><br><span class="line">Uuid: 588d2f92-f085-4e74-ab63-c6f5aa6ffb24</span><br><span class="line">State: Peer in Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: node3</span><br><span class="line">Uuid: 3495bc9c-7330-4038-ac94-1777ba0286f5</span><br><span class="line">State: Peer in Cluster (Connected)</span><br></pre></td></tr></table></figure><h4 id="9、创建2节点分布式volume"><a href="#9、创建2节点分布式volume" class="headerlink" title="9、创建2节点分布式volume"></a>9、创建2节点分布式volume</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建卷不添加任何参数的情况下，默认模式为分布式：</span><br><span class="line">#gluster volume create gv3 node1:/gfs/test1/gv3 node2:/gfs/test1/gv3</span><br><span class="line">[root@node1 ~]# gluster volume create gv3 node1:/gfs/test1/gv3 node2:/gfs/test1/gv3</span><br><span class="line">volume create: gv1: success: please start the volume to access data</span><br><span class="line"># 启动gv3</span><br><span class="line"># gluster volume start gv3</span><br><span class="line">[root@node1 ~]# gluster volume start gv3</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# gluster volume info gv3</span><br><span class="line"></span><br><span class="line">Volume Name: gv3</span><br><span class="line">Type: Distribute</span><br><span class="line">Volume ID: 02e3163b-1c69-402f-aad5-9cf4dba3267c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv3</span><br><span class="line">Brick2: node2:/gfs/test1/gv3</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br></pre></td></tr></table></figure><h4 id="10、测试Glusterfs-volume-gv3"><a href="#10、测试Glusterfs-volume-gv3" class="headerlink" title="10、测试Glusterfs volume gv3"></a>10、测试Glusterfs volume gv3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:/gv3 /mnt</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#node1查看数据：</span><br><span class="line">[root@node1 gv3]# ls  /mnt | wc -l</span><br><span class="line">100</span><br><span class="line">#node1:查看文件实际位置下的数据：</span><br><span class="line">[root@node1 gv3]# ls /gfs/test1/gv3/ |wc -l</span><br><span class="line">50</span><br><span class="line">#node2：查看文件实际位置下的数据：</span><br><span class="line">[root@node2 gv3]# ls /gfs/test1/gv3/ |wc -l</span><br><span class="line">50</span><br><span class="line">#虽然在节点3没有生成集群卷，在节点3上挂在/gv3也可以看到数据：</span><br><span class="line">mount -t glusterfs 127.0.0.1:/gv3 /mnt</span><br><span class="line">[root@node3 mnt]# ls /mnt/ |wc -l</span><br><span class="line">100</span><br></pre></td></tr></table></figure><h4 id="11、创建分布式副本"><a href="#11、创建分布式副本" class="headerlink" title="11、创建分布式副本"></a>11、创建分布式副本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 node4:/gfs/test1/gv4</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 </span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">number of bricks is not a multiple of replica count</span><br><span class="line">#创建副本的节点数要和副本个数成倍数关系</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:/gfs/test1/gv4 node2:/gfs/test1/gv4 node3:/gfs/test1/gv4 node4:/gfs/test1/gv4</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">volume create: gv4: success: please start the volume to access data</span><br><span class="line">[root@node1 test1]# gluster volume start gv4</span><br><span class="line">[root@node1 test1]# gluster volume info gv4</span><br><span class="line">Volume Name: gv4</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: e8556b2e-462d-4407-99c4-a6e622754e6c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2 x 2 = 4</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv4</span><br><span class="line">Brick2: node2:/gfs/test1/gv4</span><br><span class="line">Brick3: node3:/gfs/test1/gv4</span><br><span class="line">Brick4: node4:/gfs/test1/gv4</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure><h4 id="12、测试Glusterfs-volume-gv4"><a href="#12、测试Glusterfs-volume-gv4" class="headerlink" title="12、测试Glusterfs volume gv4:"></a>12、测试Glusterfs volume gv4:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:/gv4 /mnt</span><br><span class="line">for i in `seq -w 1 100`; do cp -rp /var/log/messages /mnt/copy-test-$i; done</span><br><span class="line">#查看数据分布，node1与node2数据相同，node3和node4存储另一半信息</span><br><span class="line">[root@node1 test1]# ls /gfs/test1/gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node2 gv0]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node3 test]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node4 ~]#  ls /gfs/test1/gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br></pre></td></tr></table></figure><h4 id="13、创建带有仲裁的副本集"><a href="#13、创建带有仲裁的副本集" class="headerlink" title="13、创建带有仲裁的副本集"></a>13、创建带有仲裁的副本集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test1]# gluster volume create gv5 replica 2 arbiter 2 transport tcp node1:/gfs/test1/gv5 node2:/gfs/test1/gv5 node3:/gfs/test1/gv5</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y/n) y</span><br><span class="line">For arbiter configuration, replica count must be 3 and arbiter count must be 1. The 3rd brick of the replica will be the arbiter</span><br><span class="line">#提示创建仲裁必须是三个副本集</span><br><span class="line">[root@node1 test1]# gluster volume create gv5 replica 3 arbiter 1 transport tcp node1:/gfs/test1/gv5 node2:/gfs/test1/gv5 node3:/gfs/test1/gv5</span><br><span class="line">#启动gv5</span><br><span class="line">[root@node1 test1]# gluster volume start gv5</span><br><span class="line">[root@node1 test1]# gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: fd4fca20-1bb3-480b-9c24-703dd3e8b508</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) = 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv5</span><br><span class="line">Brick2: node2:/gfs/test1/gv5</span><br><span class="line">Brick3: node3:/gfs/test1/gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure><h4 id="14、GlusterFS的常见的卷介绍"><a href="#14、GlusterFS的常见的卷介绍" class="headerlink" title="14、GlusterFS的常见的卷介绍"></a>14、GlusterFS的常见的卷介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Distributed：分布式卷，文件通过 hash 算法随机分布到由 bricks 组成的卷上。</span><br><span class="line">Replicated: 复制式卷，类似 RAID 1，replica 数必须等于 volume 中 brick 所包含的存储服务器数，可用性高。</span><br><span class="line">Striped: 条带式卷，类似 RAID 0，stripe 数必须等于 volume 中 brick 所包含的存储服务器数，文件被分成数据块，以 Round Robin 的方式存储在 bricks 中，并发粒度是数据块，大文件性能好。</span><br><span class="line">Distributed Striped: 分布式的条带卷，volume中 brick 所包含的存储服务器数必须是 stripe 的倍数（&gt;=2倍），兼顾分布式和条带式的功能。</span><br><span class="line">Distributed Replicated: 分布式的复制卷，volume 中 brick 所包含的存储服务器数必须是 replica 的倍数（&gt;=2倍），兼顾分布式和复制式的功能。</span><br><span class="line">分布式复制卷的brick顺序决定了文件分布的位置，一般来说，先是两个brick形成一个复制关系，然后两个复制关系形成分布。</span><br><span class="line">企业一般用后两种，大部分会用分布式复制（可用容量为 总容量/复制份数），通过网络传输的话最好用万兆交换机，万兆网卡来做。这样就会优化一部分性能。它们的数据都是通过网络来传输的。</span><br><span class="line"></span><br><span class="line">查看官方提供的gluster volume，点击[此处](https://docs.gluster.org/en/latest/Administrator%20Guide/Setting%20Up%20Volumes/)</span><br></pre></td></tr></table></figure><h4 id="15、删除卷"><a href="#15、删除卷" class="headerlink" title="15、删除卷"></a>15、删除卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#先停止要删除的卷</span><br><span class="line">[root@node01 ~]# gluster volume stop gv1</span><br><span class="line">[root@node01 ~]# gluster volume delete gv</span><br></pre></td></tr></table></figure><h4 id="16、监控负载"><a href="#16、监控负载" class="headerlink" title="16、监控负载"></a>16、监控负载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">volume profile &lt;VOLNAME&gt; &#123;start|info [peek|incremental [peek]|cumulative|clear]|stop&#125; [nfs]</span><br><span class="line">#启动性能分析：</span><br><span class="line">gluster volume profile gv5 start</span><br><span class="line">#显示io信息：</span><br><span class="line">gluster volume profile gv5 info</span><br><span class="line">#停止性能分析：</span><br><span class="line">gluster volume profile gv5 stop</span><br><span class="line"></span><br><span class="line">#使用top命令查看读取，写入，文件打开调用，读取调用，写入调用等指标：</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;open|read|write|opendir|readdir|clear&#125; [nfs|brick &lt;brick&gt;] [list-cnt &lt;value&gt;] |</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;read-perf|write-perf&#125; [bs &lt;size&gt; count &lt;count&gt;] [brick &lt;brick&gt;] [list-cnt &lt;value&gt;]</span><br><span class="line">#查看fd的当前打开数，和最大打开数</span><br><span class="line">gluster volume top gv5  open brick node1:/gfs/test1/gv5 list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Current open fds: 0, Max open fds: 1, Max openfd time: 2018-11-21 14:10:02.279118</span><br><span class="line"></span><br><span class="line">#显示文件读取调用数量：</span><br><span class="line">gluster volume top gv5  read brick node1:/gfs/test1/gv5 list-cnt  10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Countfilename</span><br><span class="line">=======================</span><br><span class="line">1/copy-test-002</span><br><span class="line">1/copy-test-001</span><br><span class="line"></span><br><span class="line">#每个brick下面文件被写入的数量列表</span><br><span class="line">gluster volume top gv5  write brick node1:/gfs/test1/gv5 list-cnt  10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Countfilename</span><br><span class="line">=======================</span><br><span class="line">12/copy-test-100</span><br><span class="line">12/copy-test-099</span><br><span class="line">12/copy-test-098</span><br><span class="line">12/copy-test-097</span><br><span class="line">12/copy-test-096</span><br><span class="line">12/copy-test-095</span><br><span class="line">12/copy-test-094</span><br><span class="line">12/copy-test-093</span><br><span class="line">12/copy-test-092</span><br><span class="line">12/copy-test-091</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被打开的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  opendir brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Countfilename</span><br><span class="line">=======================</span><br><span class="line">1/test</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被读的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  readdir brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Countfilename</span><br><span class="line">=======================</span><br><span class="line">2/test</span><br><span class="line"></span><br><span class="line">#查看brick的读性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5 read-perf bs 256  count 1 brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Throughput 51.20 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">==== ========                                        ====                      </span><br><span class="line">   0 /copy-test-001                                  2018-11-21 16:14:30.512003</span><br><span class="line">   0 /copy-test-003                                  2018-11-21 16:13:32.481649</span><br><span class="line">   0 /copy-test-002                                  2018-11-21 16:06:19.696071</span><br><span class="line">#查看brick的写性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  write-perf bs 256  count 1 brick node1:/gfs/test1/gv5  list-cnt 10</span><br><span class="line">Brick: node1:/gfs/test1/gv5</span><br><span class="line">Throughput 10.67 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">==== ========                                        ====                      </span><br><span class="line">   0 /.copy-test-001.swp                             2018-11-21 16:14:53.514516</span><br><span class="line">   0 /copy-test-001                                  2018-11-21 16:14:53.489068</span><br><span class="line">   0 /.copy-test-001.swp                             2018-11-21 16:14:30.483696</span><br><span class="line">   0 /.copy-test-003.swp                             2018-11-21 16:12:46.331094</span><br><span class="line">   0 /copy-test-100                                  2018-11-21 14:10:06.65163 </span><br><span class="line">   0 /copy-test-099                                  2018-11-21 14:10:05.953871</span><br><span class="line">   0 /copy-test-098                                  2018-11-21 14:10:05.773626</span><br><span class="line">   0 /copy-test-097                                  2018-11-21 14:10:05.620743</span><br><span class="line">   0 /copy-test-096                                  2018-11-21 14:10:05.591005</span><br><span class="line">   0 /copy-test-095                                  2018-11-21 14:10:05.555036</span><br><span class="line">#查看单个卷的信息：</span><br><span class="line">gluster volume info &lt;VOLNAME&gt;</span><br><span class="line"></span><br><span class="line">gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: e12e23f5-7347-4049-8d77-53cef76b0633</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) = 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:/gfs/test1/gv5</span><br><span class="line">Brick2: node2:/gfs/test1/gv5</span><br><span class="line">Brick3: node3:/gfs/test1/gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br><span class="line"></span><br><span class="line">#查看所有卷的信息：</span><br><span class="line">gluster volume info all</span><br><span class="line"></span><br><span class="line">#查看卷状态：</span><br><span class="line">gluster volume status [all| []] [detail|clients|mem|inode|fd|callpool]</span><br><span class="line">#显示所有卷的状态</span><br><span class="line">gluster volume status all</span><br><span class="line">#显示卷额外的信息：</span><br><span class="line">gluster volume status gv5  detail</span><br><span class="line">#显示客户端列表：</span><br><span class="line">gluster volume status gv5  clients</span><br><span class="line">#显示内存使用情况：</span><br><span class="line">gluster volume status gv5  mem</span><br><span class="line">#显示卷的inode表</span><br><span class="line">gluster volume status gv5  inode</span><br><span class="line">#显示卷打开的fd表</span><br><span class="line">gluster volume status gv5  fd</span><br><span class="line">#显示卷的挂起调用</span><br><span class="line">gluster volume status gv5  callpool</span><br></pre></td></tr></table></figure><h4 id="17、glusterfs其他信息查看"><a href="#17、glusterfs其他信息查看" class="headerlink" title="17、glusterfs其他信息查看"></a>17、glusterfs其他信息查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#看下节点有没有在线</span><br><span class="line">gluster volume status nfsp</span><br><span class="line">#启动完全修复</span><br><span class="line">gluster volume heal gv2 full</span><br><span class="line">#查看需要修复的文件</span><br><span class="line">gluster volume heal gv2 info</span><br><span class="line">#查看修复成功的文件</span><br><span class="line">gluster volume heal gv2 info healed</span><br><span class="line">#查看修复失败的文件</span><br><span class="line">gluster volume heal gv2 heal-failed</span><br><span class="line">#查看脑裂的文件</span><br><span class="line">gluster volume heal gv2 info split-brain</span><br><span class="line">#激活quota功能</span><br><span class="line">gluster volume quota gv2 enable</span><br><span class="line">#关闭quota功能</span><br><span class="line">gulster volume quota gv2 disable</span><br><span class="line">#目录限制（卷中文件夹的大小）</span><br><span class="line">gluster volume quota limit-usage /data/30MB --/gv2/data</span><br><span class="line">#quota信息列表</span><br><span class="line">gluster volume quota gv2 list</span><br><span class="line">#限制目录的quota信息</span><br><span class="line">gluster volume quota gv2 list /data</span><br><span class="line">#设置信息的超时时间</span><br><span class="line">gluster volume set gv2 features.quota-timeout 5</span><br><span class="line">#删除某个目录的quota设置</span><br><span class="line">gluster volume quota gv2 remove /data</span><br><span class="line">备注：quota功能，主要是对挂载点下的某个目录进行空间限额。如：/mnt/gulster/data目录，而不是对组成卷组的空间进行限制。</span><br></pre></td></tr></table></figure><h4 id="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"><a href="#18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。" class="headerlink" title="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"></a>18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gfszabbix监控</span><br><span class="line">https://github.com/MrCirca/zabbix-glusterfs</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] vsftp启用虚拟用户功能</title>
      <link href="/2018/11/23/vsftp%E5%90%AF%E7%94%A8%E8%99%9A%E6%8B%9F%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD/"/>
      <url>/2018/11/23/vsftp%E5%90%AF%E7%94%A8%E8%99%9A%E6%8B%9F%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD/</url>
      <content type="html"><![CDATA[<h4 id="0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处"><a href="#0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处" class="headerlink" title="0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处"></a>0、部署vsftp-server，请先跳转到<a href="https://zeven0707.github.io/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/" target="_blank" rel="noopener">此处</a>，部署vsfpt-ssl功能，点击<a href="https://zeven0707.github.io/2018/11/12/vsftpd%E9%85%8D%E7%BD%AEssl/" target="_blank" rel="noopener">此处</a></h4><h4 id="1、在-etc-vsftpd-conf配置文件添加以下内容"><a href="#1、在-etc-vsftpd-conf配置文件添加以下内容" class="headerlink" title="1、在/etc/vsftpd.conf配置文件添加以下内容"></a>1、在/etc/vsftpd.conf配置文件添加以下内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启虚拟用户的功能</span><br><span class="line">guest_enable=YES</span><br><span class="line">#指定虚拟用户的宿主用户</span><br><span class="line">guest_username=vir</span><br><span class="line">#指定虚拟用户配置文件的存放路径</span><br><span class="line">user_config_dir=/etc/vsftpd/vuser_conf</span><br><span class="line">#虚拟用户和本地用户有相同的权限</span><br><span class="line">virtual_use_local_privs=YES</span><br></pre></td></tr></table></figure><h4 id="2、建立虚拟用户名文件"><a href="#2、建立虚拟用户名文件" class="headerlink" title="2、建立虚拟用户名文件"></a>2、建立虚拟用户名文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/vsftpd/vsftpd_users.conf</span><br><span class="line">#输入奇数行为账号，偶数行为密码</span><br><span class="line">f1</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><h4 id="3、生成认证文件-如果db-load命令不存在先安装-yum-install-db4-db4-utils"><a href="#3、生成认证文件-如果db-load命令不存在先安装-yum-install-db4-db4-utils" class="headerlink" title="3、生成认证文件,如果db_load命令不存在先安装(yum install db4 db4-utils)"></a>3、生成认证文件,如果db_load命令不存在先安装(yum install db4 db4-utils)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# db_load -T -t hash -f /etc/vsftpd/vsftpd_users.conf /etc/vsftpd/vsftpd_users.db</span><br></pre></td></tr></table></figure><h4 id="4、文件生成之后，修改文件权限"><a href="#4、文件生成之后，修改文件权限" class="headerlink" title="4、文件生成之后，修改文件权限"></a>4、文件生成之后，修改文件权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chmod 600 /etc/vsftpd/vsftpd_users.db</span><br></pre></td></tr></table></figure><h4 id="5、编辑认证文件-将其余行注释，只保留第一行和最后两行"><a href="#5、编辑认证文件-将其余行注释，只保留第一行和最后两行" class="headerlink" title="5、编辑认证文件,将其余行注释，只保留第一行和最后两行"></a>5、编辑认证文件,将其余行注释，只保留第一行和最后两行</h4><p>“/etc/vsftpd/vsftpd_users”根据自己配置的文件设置，.db后缀无需添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost f2]# more /etc/pam.d/vsftpd</span><br><span class="line">#%PAM-1.0</span><br><span class="line">#session    optional     pam_keyinit.so    force revoke</span><br><span class="line">#auth       requiredpam_listfile.so item=user sense=deny file=/etc/vsftpd/ftpusers onerr=succeed</span><br><span class="line">#auth       requiredpam_shells.so</span><br><span class="line">#auth       includepassword-auth</span><br><span class="line">#account    includepassword-auth</span><br><span class="line">#session    required     pam_loginuid.so</span><br><span class="line">#session    includepassword-auth</span><br><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_users</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_users</span><br></pre></td></tr></table></figure></p><h4 id="6、建立虚拟用户配置文件存放位置"><a href="#6、建立虚拟用户配置文件存放位置" class="headerlink" title="6、建立虚拟用户配置文件存放位置"></a>6、建立虚拟用户配置文件存放位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /etc/vsftpd/vuser_conf/</span><br><span class="line">[root@localhost ~]# vim /etc/vsftpd/vuser_conf/f1</span><br><span class="line">#添加以下内容</span><br><span class="line">local_root=/var/ftp/f1</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br></pre></td></tr></table></figure><h4 id="7、将f1用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f1用户登录"><a href="#7、将f1用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f1用户登录" class="headerlink" title="7、将f1用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f1用户登录"></a>7、将f1用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f1用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/chroot_list |grep f1</span><br><span class="line">f1</span><br><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/vsftpd.user_list |grep f1</span><br><span class="line">f1</span><br></pre></td></tr></table></figure><h4 id="8、重新启动vsftp"><a href="#8、重新启动vsftp" class="headerlink" title="8、重新启动vsftp"></a>8、重新启动vsftp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl vsftpd restart</span><br></pre></td></tr></table></figure><h4 id="9、测试用户能否正常登录："><a href="#9、测试用户能否正常登录：" class="headerlink" title="9、测试用户能否正常登录："></a>9、测试用户能否正常登录：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# ./sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL/TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f1</span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">Connection problem SSLTCP:525:ssl_read tcp:-1000:SSL failure. (SSL_ERROR_SSL):error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number</span><br><span class="line">Channel open, login Failed!</span><br></pre></td></tr></table></figure><p>提示的错误没找到任何相关文档，尝试用tcpdump抓包看看交互情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15:50:39.932746 IP 192.168.168.120.21 &gt; 192.168.168.121.39398: Flags [P.], seq 1806:1816, ack 772, win 243, options [nop,nop,TS val 513318660 ecr 1441172002], length 10: FTP: 500 OOPS: [!ftp]</span><br><span class="line">15:50:39.932769 IP 192.168.168.120.21 &gt; 192.168.168.121.39398: Flags [P.], seq 1816:1851, ack 772, win 243, options [nop,nop,TS val 513318660 ecr 1441172002], length 35: FTP: cannot change directory:/var/ftp/f1[!ftp]</span><br></pre></td></tr></table></figure></p><p>提示f1的目录不存在，尝试创建f1的目录，并修改权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/ftp/f1</span><br><span class="line">chown ftp1.ftp1 /var/ftp/f1</span><br></pre></td></tr></table></figure></p><p>再次登录，正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# ./sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL/TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f1</span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">230 Login successful.</span><br><span class="line">Type in &quot;save&quot; to save login details to /root/.netrc</span><br><span class="line">sslftp&gt; ls</span><br><span class="line">226 Directory send OK.</span><br><span class="line">sslftp&gt; exit</span><br><span class="line">221 Goodbye.</span><br><span class="line">Channel Closed.</span><br></pre></td></tr></table></figure></p><h4 id="10、新增f2用户，修改vsftpd-users-conf配置文件，添加f2用户"><a href="#10、新增f2用户，修改vsftpd-users-conf配置文件，添加f2用户" class="headerlink" title="10、新增f2用户，修改vsftpd_users.conf配置文件，添加f2用户"></a>10、新增f2用户，修改vsftpd_users.conf配置文件，添加f2用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/vsftpd/vsftpd_users.conf</span><br><span class="line">#输入奇数行为账号，偶数行为密码</span><br><span class="line">f1</span><br><span class="line">123456</span><br><span class="line">f2</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><h4 id="11、重新生成认证文件"><a href="#11、重新生成认证文件" class="headerlink" title="11、重新生成认证文件"></a>11、重新生成认证文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# db_load -T -t hash -f /etc/vsftpd/vsftpd_users.conf /etc/vsftpd/vsftpd_users.db</span><br></pre></td></tr></table></figure><h4 id="12、将f2用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f2用户登录"><a href="#12、将f2用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f2用户登录" class="headerlink" title="12、将f2用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f2用户登录"></a>12、将f2用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f2用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/chroot_list |grep -E &quot;f1|f2&quot;</span><br><span class="line">f1</span><br><span class="line">f2</span><br><span class="line">[root@localhost vsftpd]# more /etc/vsftpd/vsftpd.user_list |grep -E &quot;f1|f2&quot;</span><br><span class="line">f1</span><br><span class="line">f2</span><br></pre></td></tr></table></figure><h4 id="13、添加f2配置文件"><a href="#13、添加f2配置文件" class="headerlink" title="13、添加f2配置文件"></a>13、添加f2配置文件</h4><p>vim /etc/vsftpd/vuser_conf/f2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local_root=/var/ftp/f2</span><br><span class="line">write_enable=YES</span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br></pre></td></tr></table></figure></p><h4 id="14、创建f2目录，并修改权限"><a href="#14、创建f2目录，并修改权限" class="headerlink" title="14、创建f2目录，并修改权限"></a>14、创建f2目录，并修改权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/ftp/f2</span><br><span class="line">chown ftp1.ftp1 /var/ftp/f2</span><br></pre></td></tr></table></figure><h4 id="15、重新启动vsftpd"><a href="#15、重新启动vsftpd" class="headerlink" title="15、重新启动vsftpd"></a>15、重新启动vsftpd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl vsftpd restart</span><br></pre></td></tr></table></figure><h4 id="16、测试登录vsftpd是否正常"><a href="#16、测试登录vsftpd是否正常" class="headerlink" title="16、测试登录vsftpd是否正常"></a>16、测试登录vsftpd是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# ./sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL/TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f2 </span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">230 Login successful.</span><br><span class="line">Type in &quot;save&quot; to save login details to /root/.netrc</span><br><span class="line">sslftp&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] DNS服务部署(单点&amp;主从)</title>
      <link href="/2018/11/22/DNS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/11/22/DNS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h3 id="1、关闭防火墙开启相应的服务"><a href="#1、关闭防火墙开启相应的服务" class="headerlink" title="1、关闭防火墙开启相应的服务"></a>1、关闭防火墙开启相应的服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost  ~]#setenforce  0</span><br><span class="line">[root@localhost  ~]#iptables  -F</span><br></pre></td></tr></table></figure><h3 id="2、主节点安装dns"><a href="#2、主节点安装dns" class="headerlink" title="2、主节点安装dns"></a>2、主节点安装dns</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure><h4 id="3、修改配置文件"><a href="#3、修改配置文件" class="headerlink" title="3、修改配置文件"></a>3、修改配置文件</h4><h5 id="3-1、-etc-named-conf—–主配置文件-服务器主要运行参数"><a href="#3-1、-etc-named-conf—–主配置文件-服务器主要运行参数" class="headerlink" title="3.1、/etc/named.conf—–主配置文件,服务器主要运行参数"></a>3.1、/etc/named.conf—–主配置文件,服务器主要运行参数</h5><p>修改dns主配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 10.0.30.95;127.0.0.1 &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;/var/named&quot;;</span><br><span class="line">        dump-file       &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line">        forwarders &#123; 8.8.8.8; &#125;;</span><br></pre></td></tr></table></figure></p><h5 id="3-2、-etc-named-rfc1912-zones—–区域文件，主要指定要解析哪个域名"><a href="#3-2、-etc-named-rfc1912-zones—–区域文件，主要指定要解析哪个域名" class="headerlink" title="3.2、/etc/named.rfc1912.zones—–区域文件，主要指定要解析哪个域名"></a>3.2、/etc/named.rfc1912.zones—–区域文件，主要指定要解析哪个域名</h5><p>vim /etc/named.rfc1912.zones<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 首先对文件中正向解析的区域进行修改</span><br><span class="line">zone &quot;node&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;node.conf&quot;;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">// 设置好域名格式以及相应的数据文件接下来进行反向解析区域的配置</span><br><span class="line">zone  &quot;30.0.10.in -addr.arpa&quot;  IN&#123;</span><br><span class="line">          type master;</span><br><span class="line">          file &quot;node.txt&quot;;</span><br><span class="line">          allow-update &#123; none; &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h5 id="3-3、配置完成之后校验一下文件配置是否正确："><a href="#3-3、配置完成之后校验一下文件配置是否正确：" class="headerlink" title="3.3、配置完成之后校验一下文件配置是否正确："></a>3.3、配置完成之后校验一下文件配置是否正确：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# named-checkconf</span><br><span class="line">[root@node4 named]# </span><br><span class="line">没有任何输出表示 /etc/named.conf没有语法错误</span><br></pre></td></tr></table></figure><h5 id="3-4、-var-named-xxx-xx-——-数据文件，用来正向和反向的解析"><a href="#3-4、-var-named-xxx-xx-——-数据文件，用来正向和反向的解析" class="headerlink" title="3.4、/var/named/xxx.xx ——-数据文件，用来正向和反向的解析"></a>3.4、/var/named/xxx.xx ——-数据文件，用来正向和反向的解析</h5><p>主文件及区域文件修改完成后接下来进行数据文件的修改,切换到/var/named目录下,对数据文件进行相应的选项配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/named/</span><br><span class="line">cp named.empty  node.conf</span><br></pre></td></tr></table></figure></p><p>首先对其正向解析的数据文件进行配置<br>vim node.com<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@IN SOA gfs.com rname.invalid. (</span><br><span class="line">0; serial</span><br><span class="line">1D; refresh</span><br><span class="line">1H; retry</span><br><span class="line">1W; expire</span><br><span class="line">3H ); minimum</span><br><span class="line">                NSdns.gfs.com.</span><br><span class="line">dns.gfs.com    A 10.0.30.95</span><br><span class="line">node1.gfs.com 1 A 10.0.30.51</span><br><span class="line">           AAAA::1</span><br></pre></td></tr></table></figure></p><p>对反向解析的数据文件进行配置，反向解析数据文件里面只有SOA、NS、PTR资源记录，所有A记录都要改为PTR记录，名称为IP地址，IP地址可以写全也可以简写，如果写全则是IP地址反写加上.in-addr.arpa.例如：116.2.16.172.in-addr.arpa. PTR资源记录的值为域名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp named.empty  node.txt</span><br></pre></td></tr></table></figure></p><p>vim node.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@IN SOA gfs.com rname.invalid. (</span><br><span class="line">0; serial</span><br><span class="line">1D; refresh</span><br><span class="line">1H; retry</span><br><span class="line">1W; expire</span><br><span class="line">3H ); minimum</span><br><span class="line">     NSdns.gfs.com.</span><br><span class="line">95PTR dns.gfs.com.</span><br><span class="line">51  PTR node1.gfs.com.</span><br></pre></td></tr></table></figure></p><h5 id="3-5、解析文件参数详解"><a href="#3-5、解析文件参数详解" class="headerlink" title="3.5、解析文件参数详解"></a>3.5、解析文件参数详解</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">区域解析库文件第一个记录必须是SOA记录，必须有NS记录并且正解区域要有NS记录的A记录，反解则不需要有NS记录对应的A记录。</span><br><span class="line">$TTL表示宏定义，TTL(Time- To-Live)，dns记录在本地DNS服务器上保留的时间</span><br><span class="line">@符号可代表区域文件/etc/named.conf里面定义的区域名称，即：&quot;gfs.com.&quot;。</span><br><span class="line">2018030422 ;标识序列号，十进制数字，不能超过10位，通常使用日期</span><br><span class="line">2H ;刷新时间，即每隔多久到主服务器检查一次，此处为2小时，实验环境可以设置小一点</span><br><span class="line">4M ;重试时间，应该小于刷新时间，此处为4分钟，实验环境可以设置小一点</span><br><span class="line">1D ;过期时间，此处为1天</span><br><span class="line">2D ;主服务器挂后，从服务器至多工作的时间，此处为2天)</span><br><span class="line">这个文件里所有的域名结尾的点号一定不能省略。</span><br><span class="line">区域解析库文件是放在/var/named目录下，由named进程是以named用户运行，因此区域解析库文件的属组应设置为named。</span><br><span class="line"></span><br><span class="line">（1）A记录（Address）正向解析</span><br><span class="line">A记录是将一个主机名（全称域名FQDN）和一个IP地址关联起来。这也是大多数客户端程序默认的查询类型。</span><br><span class="line">（2）PTR记录（Pointer）反向解析</span><br><span class="line">PTR记录将一个IP地址对应到主机名（全称域名FQDN）。这些记录保存在in-addr.arpa域中。</span><br><span class="line">（3）CNAME记录(Canonical Name)别名</span><br><span class="line">别名记录，也称为规范名字(Canonical Name)。这种记录允许您将多个名字映射到同一台计算机。</span><br><span class="line">（4）MX记录（Mail eXchange）</span><br><span class="line">MX记录是邮件交换记录，它指向一个邮件服务器，用于电子邮件系统发邮件时根据 收信人的地址后缀来定位邮件服务器。MX记录也叫做邮件路由记录，用户可以将该域名下的邮件服务器指向到自己的mail server上，然后即可自行操控所有的邮箱设置。</span><br><span class="line">当有多个MX记录（即有多个邮件服务器）时，则需要设置数值来确定其优先级。通过设置优先级数字来指明首选服务器，数字越小表示优先级越高。</span><br><span class="line">（5）NS记录（Name Server）</span><br><span class="line">NS（Name Server）记录是域名服务器记录，也称为授权服务器，用来指定该域名由哪个DNS服务器来进行解析。</span><br><span class="line">将网站的NS记录指向到目标地址，在设置NS记录的同时还需要设置目标网站的指向，否则NS记录将无法正常解析</span><br><span class="line">NS记录优先于A记录。即，如果一个主机地址同时存在NS记录和A记录，则A记录不生效。</span><br><span class="line">（6）AAAA记录 IPV6解析记录</span><br><span class="line">该记录是将域名解析到一个指定的IPV6的IP上。</span><br></pre></td></tr></table></figure><h5 id="3-6、相应的数据配置文件完成后对数据文件的属主进行修改"><a href="#3-6、相应的数据配置文件完成后对数据文件的属主进行修改" class="headerlink" title="3.6、相应的数据配置文件完成后对数据文件的属主进行修改"></a>3.6、相应的数据配置文件完成后对数据文件的属主进行修改</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost  named]#chown  named  node.*</span><br><span class="line">[root@node4 named]# ll node.*</span><br><span class="line">-rw-r-----. 1 named root 286 Nov 22 16:12 node.conf</span><br><span class="line">-rw-r-----. 1 named root 310 Nov 22 16:12 node.txt</span><br></pre></td></tr></table></figure><h5 id="3-7、配置完成后检测解析文件是否正确"><a href="#3-7、配置完成后检测解析文件是否正确" class="headerlink" title="3.7、配置完成后检测解析文件是否正确"></a>3.7、配置完成后检测解析文件是否正确</h5><p>[root@node4 named]# named-checkzone “gfs.com” node.conf<br>zone gfs.com/IN: loaded serial 0<br>OK</p><h5 id="3-8、检测反向解析库配置有没有错误"><a href="#3-8、检测反向解析库配置有没有错误" class="headerlink" title="3.8、检测反向解析库配置有没有错误"></a>3.8、检测反向解析库配置有没有错误</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# named-checkzone &quot;30.0.10.in-addr.arpa&quot; node.txt</span><br><span class="line">zone 30.0.10.in-addr.arpa/IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h4 id="4、修改完成后启动dns服务"><a href="#4、修改完成后启动dns服务" class="headerlink" title="4、修改完成后启动dns服务"></a>4、修改完成后启动dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named.service</span><br></pre></td></tr></table></figure><h4 id="5、在客户端配置dns信息"><a href="#5、在客户端配置dns信息" class="headerlink" title="5、在客户端配置dns信息"></a>5、在客户端配置dns信息</h4><h5 id="5-1、修改-etc-NetworkManager-NetworkManager-conf-文件，防止重启网卡后dns被重置，在main部分添加-“dns-none”-选项"><a href="#5-1、修改-etc-NetworkManager-NetworkManager-conf-文件，防止重启网卡后dns被重置，在main部分添加-“dns-none”-选项" class="headerlink" title="5.1、修改 /etc/NetworkManager/NetworkManager.conf 文件，防止重启网卡后dns被重置，在main部分添加 “dns=none” 选项"></a>5.1、修改 /etc/NetworkManager/NetworkManager.conf 文件，防止重启网卡后dns被重置，在main部分添加 “dns=none” 选项</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">plugins=ifcfg-rh</span><br><span class="line">dns=none</span><br></pre></td></tr></table></figure><h5 id="5-2、NetworkManager重新装载上面修改的配置"><a href="#5-2、NetworkManager重新装载上面修改的配置" class="headerlink" title="5.2、NetworkManager重新装载上面修改的配置"></a>5.2、NetworkManager重新装载上面修改的配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart NetworkManager.service</span><br></pre></td></tr></table></figure><h5 id="5-3、之后修改-etc-resolv-conf配置文件："><a href="#5-3、之后修改-etc-resolv-conf配置文件：" class="headerlink" title="5.3、之后修改/etc/resolv.conf配置文件："></a>5.3、之后修改/etc/resolv.conf配置文件：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">[root@node2 ~]# /etc/init.d/network restart</span><br><span class="line">Restarting network (via systemctl):                        [  OK  ]</span><br><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 202.106.0.20</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# ls</span><br><span class="line">anaconda-ks.cfg  Desktop  Documents  Downloads  initial-setup-ks.cfg  Music  Pictures  Public  Templates  Videos</span><br><span class="line">[root@node2 ~]# vim /etc/NetworkManager/NetworkManager.conf </span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# systemctl restart NetworkManager.service</span><br><span class="line">[root@node2 ~]# vim /etc/resolv.conf</span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">[root@node2 ~]# /etc/init.d/network restart</span><br><span class="line">Restarting network (via systemctl):                        [  OK  ]</span><br><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br></pre></td></tr></table></figure><h5 id="5-4、测试dns是否能正常解析："><a href="#5-4、测试dns是否能正常解析：" class="headerlink" title="5.4、测试dns是否能正常解析："></a>5.4、测试dns是否能正常解析：</h5><p>正向解析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 30794</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.10800INA10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.10800INNSdns1.gfs.com.</span><br><span class="line">gfs.com.10800INNSdns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.10800INA10.0.30.95</span><br><span class="line">dns2.gfs.com.10800INA10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 17:44:35 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure></p><p>反向解析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -x 10.0.30.51 </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -x 10.0.30.51</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 50154</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;51.30.0.10.in-addr.arpa.INPTR</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">51.30.0.10.in-addr.arpa. 10800INPTRnode1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">30.0.10.in-addr.arpa.10800INNSdns2.gfs.com.</span><br><span class="line">30.0.10.in-addr.arpa.10800INNSdns1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.10800INA10.0.30.95</span><br><span class="line">dns2.gfs.com.10800INA10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 17:44:47 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 149</span><br></pre></td></tr></table></figure></p><p>上面单节点的dns配置完成，下面配置dns主从，从节点实时同步主节点更新的数据。</p><h4 id="6、主节点修改-etc-named-rfc1912-zones"><a href="#6、主节点修改-etc-named-rfc1912-zones" class="headerlink" title="6、主节点修改/etc/named.rfc1912.zones"></a>6、主节点修改/etc/named.rfc1912.zones</h4><p>allow-transfer { 10.0.30.117; }; #指定允许转发的目标主机，即从服务器<br>also-notify:主动通知从域名服务器进行更新，在主域名服务器进行更新后，而不需要在等规定的时间后才通知从域名服务器进行更新<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;gfs.com&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;node.conf&quot;;</span><br><span class="line">        allow-transfer &#123; 10.0.30.117; &#125;;</span><br><span class="line">        also-notify &#123; 10.0.30.117; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  &quot;30.0.10.in-addr.arpa&quot;  IN&#123;</span><br><span class="line">          type master;</span><br><span class="line">          file &quot;node.txt&quot;;</span><br><span class="line">          also-notify &#123; 10.0.30.117; &#125;;</span><br><span class="line">          allow-transfer &#123; 10.0.30.117; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h4 id="7、修改主节点正向解析文件"><a href="#7、修改主节点正向解析文件" class="headerlink" title="7、修改主节点正向解析文件"></a>7、修改主节点正向解析文件</h4><p>[root@node4 named]# more node.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@IN SOAgfs.com. rname.invalid. (</span><br><span class="line">2; serial</span><br><span class="line">1D; refresh</span><br><span class="line">1H; retry</span><br><span class="line">1W; expire</span><br><span class="line">3H ); minimum</span><br><span class="line">NSdns1.gfs.com.</span><br><span class="line">    NS  dns2.gfs.com.</span><br><span class="line">dns1 A 10.0.30.95</span><br><span class="line">dns2 A 10.0.30.117</span><br><span class="line">node1  A 10.0.30.51</span><br><span class="line">node2  A 10.0.30.35</span><br><span class="line">node3  A 10.0.30.117</span><br><span class="line">AAAA::1</span><br></pre></td></tr></table></figure></p><h4 id="8、修改主节点反向解析文件"><a href="#8、修改主节点反向解析文件" class="headerlink" title="8、修改主节点反向解析文件"></a>8、修改主节点反向解析文件</h4><p>[root@node4 named]# more node.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@IN SOA gfs.com. rname.invalid. (</span><br><span class="line">2; serial</span><br><span class="line">1D; refresh</span><br><span class="line">1H; retry</span><br><span class="line">1W; expire</span><br><span class="line">3H ); minimum</span><br><span class="line">      NS  dns1.gfs.com.</span><br><span class="line">      NS  dns2.gfs.com.</span><br><span class="line">95   PTR dns1.gfs.com.</span><br><span class="line">117  PTR dns2.gfs.com.</span><br><span class="line">51   PTR node1.gfs.com.</span><br><span class="line">35   PTR node2.gfs.com.</span><br><span class="line">117  PTR node3.gfs.com.</span><br></pre></td></tr></table></figure></p><h4 id="9、重新启动dns服务器"><a href="#9、重新启动dns服务器" class="headerlink" title="9、重新启动dns服务器"></a>9、重新启动dns服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named.service</span><br></pre></td></tr></table></figure><h4 id="10、在从服务器上安装dns服务"><a href="#10、在从服务器上安装dns服务" class="headerlink" title="10、在从服务器上安装dns服务"></a>10、在从服务器上安装dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure><h4 id="11、修改从节点-etc-named-conf配置文件"><a href="#11、修改从节点-etc-named-conf配置文件" class="headerlink" title="11、修改从节点/etc/named.conf配置文件"></a>11、修改从节点/etc/named.conf配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">listen-on port 53 &#123; 10.0.30.117;127.0.0.1; &#125;;</span><br><span class="line">listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">directory &quot;/var/named&quot;;</span><br><span class="line">dump-file &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">allow-query     &#123; any; &#125;;</span><br><span class="line">forwarders &#123; 8.8.8.8; &#125;;</span><br></pre></td></tr></table></figure><h4 id="12、修改-etc-named-rfc1912-zones"><a href="#12、修改-etc-named-rfc1912-zones" class="headerlink" title="12、修改/etc/named.rfc1912.zones"></a>12、修改/etc/named.rfc1912.zones</h4><p>allow-notify 接受这个网段内的主机发送来的通知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;gfs.com&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        masters &#123; 10.0.30.95; &#125;;</span><br><span class="line">        allow-notify &#123; 10.0.30.95; &#125;;</span><br><span class="line">        file &quot;slaves/node.conf&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  &quot;30.0.10.in-addr.arpa&quot;  IN&#123;</span><br><span class="line">          type slave;</span><br><span class="line">          masters &#123; 10.0.30.95; &#125;;</span><br><span class="line">          allow-notify &#123; 10.0.30.95; &#125;;</span><br><span class="line">          file &quot;slaves/node.txt&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h4 id="13、从服务器启动dns服务"><a href="#13、从服务器启动dns服务" class="headerlink" title="13、从服务器启动dns服务"></a>13、从服务器启动dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named.service</span><br></pre></td></tr></table></figure><h4 id="14、查看-var-named-slaves目录下已经多出了node-的两个文件"><a href="#14、查看-var-named-slaves目录下已经多出了node-的两个文件" class="headerlink" title="14、查看/var/named/slaves目录下已经多出了node.*的两个文件"></a>14、查看/var/named/slaves目录下已经多出了node.*的两个文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# pwd</span><br><span class="line">/var/named/slaves</span><br><span class="line">[root@node3 slaves]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 416 Nov 22 16:12 node.conf</span><br><span class="line">-rw-r--r--. 1 named named 514 Nov 22 16:12 node.txt</span><br></pre></td></tr></table></figure><h4 id="15、测试主从文件能否正常同步，修改主节点node-配置文件"><a href="#15、测试主从文件能否正常同步，修改主节点node-配置文件" class="headerlink" title="15、测试主从文件能否正常同步，修改主节点node.*配置文件"></a>15、测试主从文件能否正常同步，修改主节点node.*配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# vim node.conf </span><br><span class="line">[root@node4 named]# vim node.txt </span><br><span class="line">[root@node4 named]# </span><br><span class="line">[root@node4 named]# ll node.*</span><br><span class="line">-rw-r-----. 1 named root 265 Nov 22 18:48 node.conf</span><br><span class="line">-rw-r-----. 1 named root 272 Nov 22 18:48 node.txt</span><br></pre></td></tr></table></figure><p>***注意修改配置文件的时候一定要修改配置文件中serial那一行，只有该行的数值大于前一个值，才会同步到从节点。</p><h4 id="16、主节点重新加载dns"><a href="#16、主节点重新加载dns" class="headerlink" title="16、主节点重新加载dns"></a>16、主节点重新加载dns</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload named.service</span><br></pre></td></tr></table></figure><h4 id="17、查看从节点日志信息"><a href="#17、查看从节点日志信息" class="headerlink" title="17、查看从节点日志信息"></a>17、查看从节点日志信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Nov 22 18:48:55 node3 named[98442]: client 10.0.30.95#52505: received notify for zone &apos;gfs.com&apos;</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com/IN: Transfer started.</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;gfs.com/IN&apos; from 10.0.30.95#53: connected using 10.0.30.117#58148</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com/IN: transferred serial 3</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;gfs.com/IN&apos; from 10.0.30.95#53: Transfer completed: 1 messages, 9 records, 252 bytes, 0.008 secs (31500 bytes/sec)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com/IN: sending notifies (serial 3)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: client 10.0.30.95#54023: received notify for zone &apos;30.0.10.in-addr.arpa&apos;</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa/IN: Transfer started.</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;30.0.10.in-addr.arpa/IN&apos; from 10.0.30.95#53: connected using 10.0.30.117#51530</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa/IN: transferred serial 3</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &apos;30.0.10.in-addr.arpa/IN&apos; from 10.0.30.95#53: Transfer completed: 1 messages, 8 records, 249 bytes, 0.002 secs (124500 bytes/sec)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa/IN: sending notifies (serial 3)</span><br></pre></td></tr></table></figure><h4 id="18、查看从节点配置文件信息"><a href="#18、查看从节点配置文件信息" class="headerlink" title="18、查看从节点配置文件信息"></a>18、查看从节点配置文件信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 375 Nov 22 18:48 node.conf</span><br><span class="line">-rw-r--r--. 1 named named 433 Nov 22 18:48 node.txt</span><br></pre></td></tr></table></figure><p>从节点文件已和主节点正常同步</p><h4 id="19、客户端测试主节点dns服务器挂掉从节点能否正常使用"><a href="#19、客户端测试主节点dns服务器挂掉从节点能否正常使用" class="headerlink" title="19、客户端测试主节点dns服务器挂掉从节点能否正常使用"></a>19、客户端测试主节点dns服务器挂掉从节点能否正常使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# more /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">nameserver 10.0.30.117</span><br></pre></td></tr></table></figure><h4 id="20、测试正向解析是否正常"><a href="#20、测试正向解析是否正常" class="headerlink" title="20、测试正向解析是否正常"></a>20、测试正向解析是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 55761</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.10800INA10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.10800INNSdns1.gfs.com.</span><br><span class="line">gfs.com.10800INNSdns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.10800INA10.0.30.95</span><br><span class="line">dns2.gfs.com.10800INA10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 18:54:03 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure><h4 id="21、主节点停掉dns服务："><a href="#21、主节点停掉dns服务：" class="headerlink" title="21、主节点停掉dns服务："></a>21、主节点停掉dns服务：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# systemctl stop named.service</span><br><span class="line">[root@node4 named]# systemctl status named.service</span><br><span class="line">● named.service - Berkeley Internet Name Domain (DNS)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line"></span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: zone 30.0.10.in-addr.arpa/IN: sending notifies (serial 3)</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#58148 (gfs.com): transfer of &apos;gfs.com/IN&apos;: AXFR-style IXFR started</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#58148 (gfs.com): transfer of &apos;gfs.com/IN&apos;: AXFR-style IXFR ended</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#28664: received notify for zone &apos;gfs.com&apos;</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#51530 (30.0.10.in-addr.arpa): transfer of &apos;30.0.10.in-addr.arpa/IN&apos;: AXFR-style IXFR started</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#51530 (30.0.10.in-addr.arpa): transfer of &apos;30.0.10.in-addr.arpa/IN&apos;: AXFR-style IXFR ended</span><br><span class="line">Nov 22 18:48:56 node4 named[10366]: client 10.0.30.117#41288: received notify for zone &apos;30.0.10.in-addr.arpa&apos;</span><br><span class="line">Nov 22 18:59:26 node4 systemd[1]: Stopping Berkeley Internet Name Domain (DNS)...</span><br><span class="line">Nov 22 18:59:26 node4 named[10366]: received control channel command &apos;stop&apos;</span><br><span class="line">Nov 22 18:59:26 node4 systemd[1]: Stopped Berkeley Internet Name Domain (DNS).</span><br></pre></td></tr></table></figure><h4 id="22、客户端解析仍然正常"><a href="#22、客户端解析仍然正常" class="headerlink" title="22、客户端解析仍然正常"></a>22、客户端解析仍然正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39672</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.10800INA10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.10800INNSdns2.gfs.com.</span><br><span class="line">gfs.com.10800INNSdns1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.10800INA10.0.30.95</span><br><span class="line">dns2.gfs.com.10800INA10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.117#53(10.0.30.117)</span><br><span class="line">;; WHEN: Thu Nov 22 18:59:48 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure><h4 id="23、指定dns为主节点，解析失败"><a href="#23、指定dns为主节点，解析失败" class="headerlink" title="23、指定dns为主节点，解析失败"></a>23、指定dns为主节点，解析失败</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com @10.0.30.95</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com @10.0.30.95</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure><h4 id="24、指定为从节点，解析正常"><a href="#24、指定为从节点，解析正常" class="headerlink" title="24、指定为从节点，解析正常"></a>24、指定为从节点，解析正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com @10.0.30.117</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com @10.0.30.117</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 53270</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.10800INA10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.10800INNSdns1.gfs.com.</span><br><span class="line">gfs.com.10800INNSdns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.10800INA10.0.30.95</span><br><span class="line">dns2.gfs.com.10800INA10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.117#53(10.0.30.117)</span><br><span class="line">;; WHEN: Thu Nov 22 19:01:30 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure><h4 id="25、把从节点dns服务也关掉"><a href="#25、把从节点dns服务也关掉" class="headerlink" title="25、把从节点dns服务也关掉"></a>25、把从节点dns服务也关掉</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# systemctl stop named.service</span><br></pre></td></tr></table></figure><h4 id="26、解析域名报错"><a href="#26、解析域名报错" class="headerlink" title="26、解析域名报错"></a>26、解析域名报错</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure><h4 id="27、额外参考信息"><a href="#27、额外参考信息" class="headerlink" title="27、额外参考信息"></a>27、额外参考信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DNS服务器监听端口:</span><br><span class="line">PORT: udp/tcp  53   ---&gt; 服务端口</span><br><span class="line">PORT: udp/tcp 953  ---&gt; 主从连接端口</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns各参数详解，点击[此处](https://blog.csdn.net/bpingchang/article/details/38427113)跳转</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-show table status语法</title>
      <link href="/2018/11/14/mysql-show%20table%20status%E8%AF%AD%E6%B3%95/"/>
      <url>/2018/11/14/mysql-show%20table%20status%E8%AF%AD%E6%B3%95/</url>
      <content type="html"><![CDATA[<h4 id="1、使用方法："><a href="#1、使用方法：" class="headerlink" title="1、使用方法："></a>1、使用方法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show table status from aaaa like &apos;test_order&apos;;</span><br><span class="line">或</span><br><span class="line">show table status in aaaa like &apos;test_order&apos;;</span><br></pre></td></tr></table></figure><p>结果显示如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: test_order</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 84052104</span><br><span class="line"> Avg_row_length: 372</span><br><span class="line">    Data_length: 31321817088</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 25528303616</span><br><span class="line">      Data_free: 7340032</span><br><span class="line"> Auto_increment: 86709693</span><br><span class="line">    Create_time: 2018-11-02 16:20:25</span><br><span class="line">    Update_time: NULL</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: utf8mb4_general_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h4 id="2、具体参数详解："><a href="#2、具体参数详解：" class="headerlink" title="2、具体参数详解："></a>2、具体参数详解：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Name:表名</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine:表使用的存储引擎</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Version：该列在8.0版本已经废弃，在5.7版本下显示硬编码10</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Row_format：行存储格式（Fixed, Dynamic, Compressed, Redundant, Compact）。对于myisam表，Dynamic值与 myisamchk -dvv查询出来的Packed值相对应。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rows:对于myisam存储引擎，显示实际行数。对于其他引擎，比如innodb，值是近似的(粗略估计），和实际值可能相差40%至50%之间，想要获取准确的值使用select count(*)。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Avg_row_length：平均行长度。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Data_length：对于Myisam表，该值以字节为单位显示数据文件的长度；对于Innodb,该值以字节为单位显示为聚簇索引分配内存的值（近似）。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Max_data_length：对于Myisam表，该值显示数据文件的最大长度。这是可以存储在表中的数据的总字节数，该表给定使用的数据指针大小。对于Innodb，该值已弃用。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Index_length：对于Myisam，该值为索引文件的长度（以字节为单位）。对于Innodb，该值显示内存为非聚簇索引分配的数量（以字节为单位），它是内存页中非聚簇索引大小的总和与</span><br><span class="line">Innodb内存页大小的乘积。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Data_free：已分配但未使用的字节数。Innodb-tables代表当前表所属表空间的可用空间。如果该表位于共享表空间，该值代表共享表空间的剩余空间。如果使用多个表空间，每个表拥有自己的表空间，该值仅代表当前表的剩余空间。剩余空间的意思就是当前完全空闲的区字节数减去一个安全的边界值。即使该值为0，只要新的区可以被分配插入数据也是正常的。</span><br><span class="line">对于NDB集群，该值显示磁盘分配的空间，但是还没有被磁盘数据表或者磁盘数据碎片使用的空间。</span><br><span class="line">对于分区表，该值只是估计值并不准确。想要获取更加准确的方法使用下面方法查询：</span><br><span class="line">SELECT SUM(DATA_FREE) FROM  INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA = &apos;mydb&apos; AND TABLE_NAME = &apos;mytable&apos;;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Auto_increment：下一个自动增长值。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Create_time：表创建时间。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Update_time：数据文件最后更新时间。对于一些存储引擎，该是为null。例如，Innodb存储多个表在系统表空间而且数据文件时间戳没有应用。Innodb表是使用file-per-table模式，每个表都有他自己的.ibd文件，内存buffer写入数据文件存在延迟，因而文件修改时间与最后的插入、更新、删除修改时间是不同的。对于Myisam表，数据文件时间戳是可用的，但是在window系统上，更新并不会更新时间戳，因此该值是不准确的。</span><br><span class="line">对于非分区的Innodb表，该值显示最后update、insert、delete的时间戳的值。对于MVCC，时间戳的值代表commit的时间。如果服务器重启或者该表被数据字典缓存清除，时间戳不会保留。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Check_time：表最后一次检查时间。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collation：表默认的排序规则。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Checksum：校验值。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Create_options：创建表时的额外选项。当执行create table时被保留的原始选项，这些选项与活动表的设置和选项不同。</span><br><span class="line">对于Innodb表，该值显示row_format和key_block_size选项。如果表示分区表，该值会显示partitioned。当创建或者修改一个file-per-table表空间为加密模式时，该值会显示为ENCRYPTIONG(general tablespace除外)。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Comment：创建表空间添加的注释。</span><br></pre></td></tr></table></figure><h4 id="3、测试对innodb表添加encryption功能："><a href="#3、测试对innodb表添加encryption功能：" class="headerlink" title="3、测试对innodb表添加encryption功能："></a>3、测试对innodb表添加encryption功能：</h4><p>3.1、安装插件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN keyring_file  soname &apos;keyring_file.so&apos;;</span><br></pre></td></tr></table></figure></p><p>3.2、创建密钥文件目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mysql/keyfile</span><br><span class="line">chown mysql.mysql -R /data/mysql/keyfile</span><br></pre></td></tr></table></figure></p><p>3.3、设置key文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set global keyring_file_data=&apos;/data/mysql/keyfile/key01&apos;;</span><br><span class="line">show global variables like &apos;%keyring_file_data%&apos;;</span><br><span class="line">root@db 16:28:  [aaaa]&gt; show global variables like &apos;%keyring_file_data%&apos;;</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">| Variable_name     | Value                     |</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">| keyring_file_data | /data/mysql/keyfile/key01 |</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>3.4、查看插件状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; SELECT PLUGIN_NAME, PLUGIN_STATUS</span><br><span class="line">    -&gt;        FROM INFORMATION_SCHEMA.PLUGINS</span><br><span class="line">    -&gt;        WHERE PLUGIN_NAME LIKE &apos;keyring%&apos;;</span><br><span class="line">+--------------+---------------+</span><br><span class="line">| PLUGIN_NAME  | PLUGIN_STATUS |</span><br><span class="line">+--------------+---------------+</span><br><span class="line">| keyring_file | ACTIVE        |</span><br><span class="line">+--------------+---------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>3.5、表aa未加密时，查看表状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:29:  [aaaa]&gt; show table status from aaaa like &apos;aa&apos;;</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time | Check_time | Collation          | Checksum | Create_options | Comment |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| aa   | InnoDB |      10 | Dynamic    |   12 |           1365 |       16384 |               0 |            0 |         0 |           NULL | 2018-10-29 17:30:47 | NULL        | NULL       | utf8mb4_general_ci |     NULL |                |         |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>3.6、对表aa进行加密：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:29:  [aaaa]&gt; alter table aa encryption=&apos;Y&apos;;</span><br><span class="line">Query OK, 12 rows affected (5.13 sec)</span><br><span class="line">Records: 12  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>3.7、再次查看表aa状态：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:30:  [aaaa]&gt; show table status from aaaa like &apos;aa&apos;;</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation          | Checksum | Create_options | Comment |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| aa   | InnoDB |      10 | Dynamic    |   12 |           1365 |       16384 |               0 |            0 |         0 |           NULL | 2018-11-14 16:30:16 | 2018-11-14 16:30:14 | NULL       | utf8mb4_general_ci |     NULL | ENCRYPTION=&quot;Y&quot; |         |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><h4 id="4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下："><a href="#4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下：" class="headerlink" title="4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下："></a>4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此<a href="http://en.latindevelopers.com/ivancp/2012/a-better-show-table-status/" target="_blank" rel="noopener">跳转</a>至原文，具体内容如下：</h4><p>4.1、存储过程所在的aaaa数据库，可根据自己数据库情况自行修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">DROP PROCEDURE IF EXISTS `aaaa`.`sp_status` $$</span><br><span class="line">CREATE PROCEDURE `aaaa`.`sp_status`(dbname VARCHAR(50))</span><br><span class="line">BEGIN </span><br><span class="line">-- Obtaining tables and views</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">     TABLE_NAME AS `Table Name`, </span><br><span class="line">     ENGINE AS `Engine`,</span><br><span class="line">     TABLE_ROWS AS `Rows`,</span><br><span class="line">     CONCAT(</span><br><span class="line">        (FORMAT((DATA_LENGTH + INDEX_LENGTH) / POWER(1024,2),2))</span><br><span class="line">        , &apos; Mb&apos;)</span><br><span class="line">       AS `Size`,</span><br><span class="line">     TABLE_COLLATION AS `Collation`</span><br><span class="line">    FROM information_schema.TABLES</span><br><span class="line">    WHERE TABLES.TABLE_SCHEMA = dbname</span><br><span class="line">          AND TABLES.TABLE_TYPE = &apos;BASE TABLE&apos;</span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">     TABLE_NAME AS `Table Name`, </span><br><span class="line">     &apos;[VIEW]&apos; AS `Engine`,</span><br><span class="line">     &apos;-&apos; AS `Rows`,</span><br><span class="line">     &apos;-&apos; `Size`,</span><br><span class="line">     &apos;-&apos; AS `Collation`</span><br><span class="line">    FROM information_schema.TABLES</span><br><span class="line">    WHERE TABLES.TABLE_SCHEMA = dbname </span><br><span class="line">          AND TABLES.TABLE_TYPE = &apos;VIEW&apos;</span><br><span class="line">)</span><br><span class="line">ORDER BY 1;</span><br><span class="line">-- Obtaining functions, procedures and triggers</span><br><span class="line">(</span><br><span class="line">    SELECT ROUTINE_NAME AS `Routine Name`, </span><br><span class="line">     ROUTINE_TYPE AS `Type`,</span><br><span class="line">     &apos;&apos; AS `Comment`</span><br><span class="line">    FROM information_schema.ROUTINES</span><br><span class="line">    WHERE ROUTINE_SCHEMA = dbname</span><br><span class="line">    ORDER BY ROUTINES.ROUTINE_TYPE, ROUTINES.ROUTINE_NAME</span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">(</span><br><span class="line">    SELECT TRIGGER_NAME,&apos;TRIGGER&apos; AS `Type`, </span><br><span class="line">    concat(&apos;On &apos;,EVENT_MANIPULATION,&apos;: &apos;,EVENT_OBJECT_TABLE) AS `Comment`</span><br><span class="line">    FROM information_schema.TRIGGERS</span><br><span class="line">    WHERE EVENT_OBJECT_SCHEMA = dbname</span><br><span class="line">)</span><br><span class="line">ORDER BY 2,1;</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></p><p>4.2、执行存储过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call aaaa.sp_status(&apos;aaaa&apos;);</span><br></pre></td></tr></table></figure></p><p>4.3、结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:58:  [aaaa]&gt; call aaaa.sp_status(&apos;aaaa&apos;);</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br><span class="line">| Table Name   | Engine | Rows     | Size         | Collation          |</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br><span class="line">| aa           | InnoDB | 12       | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| sequence     | InnoDB | 12292293 | 515.98 Mb    | utf8mb4_general_ci |</span><br><span class="line">| test         | InnoDB | 0        | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| test1        | InnoDB | 6        | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| test_order  | InnoDB | 84052104 | 54,216.50 Mb | utf8mb4_general_ci |</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] vsftpd配置ssl</title>
      <link href="/2018/11/12/vsftpd%E9%85%8D%E7%BD%AEssl/"/>
      <url>/2018/11/12/vsftpd%E9%85%8D%E7%BD%AEssl/</url>
      <content type="html"><![CDATA[<h4 id="0、如果还没有部署vsftp-server，请先跳转到此处"><a href="#0、如果还没有部署vsftp-server，请先跳转到此处" class="headerlink" title="0、如果还没有部署vsftp-server，请先跳转到此处"></a>0、如果还没有部署vsftp-server，请先跳转到<a href="https://zeven0707.github.io/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/" target="_blank" rel="noopener">此处</a></h4><h4 id="1、查询vsftpd软件是否支持SSL"><a href="#1、查询vsftpd软件是否支持SSL" class="headerlink" title="1、查询vsftpd软件是否支持SSL"></a>1、查询vsftpd软件是否支持SSL</h4><p>ldd /usr/sbin/vsftpd | grep ssl<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libssl.so.10 =&gt; /lib64/libssl.so.10 (0x00007f6cfc4a6000)</span><br></pre></td></tr></table></figure></p><h4 id="2、生成vsftpd-pem-证书"><a href="#2、生成vsftpd-pem-证书" class="headerlink" title="2、生成vsftpd.pem 证书"></a>2、生成vsftpd.pem 证书</h4><p>[root@localhost vsftpd]# openssl req -x509 -nodes -days 365 -newkey rsa:1024 -keyout /etc/vsftpd/vsftpd.pem -out /etc/vsftpd/vsftpd.pem<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">..................................++++++</span><br><span class="line">.........++++++</span><br><span class="line">writing new private key to &apos;/etc/vsftpd/vsftpd.pem&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:goopal</span><br><span class="line">Organizational Unit Name (eg, section) []:goopal</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:zeven</span><br><span class="line">Email Address []:test@goopal.com</span><br></pre></td></tr></table></figure></p><p>查看生成vsftpd.pem是否成功<br>ls -l /etc/vsftpd/|grep vsftpd.pem<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- 1 root root 1982 11月  9 14:20 vsftpd.pem</span><br></pre></td></tr></table></figure></p><h4 id="3、修改主配置文件-etc-vsftpd-vsftpd-conf"><a href="#3、修改主配置文件-etc-vsftpd-vsftpd-conf" class="headerlink" title="3、修改主配置文件/etc/vsftpd/vsftpd.conf"></a>3、修改主配置文件/etc/vsftpd/vsftpd.conf</h4><p>下面是ssl参数一些定义，根据自己需求去修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ssl_enable=yes/no             是否启用 SSL,默认为no</span><br><span class="line">allow_anon_ssl=yes/no         是否允许匿名用户使用SSL,默认为no</span><br><span class="line">rsa_cert_file=/path/to/file       rsa证书的位置</span><br><span class="line">dsa_cert_file=/path/to/file      dsa证书的位置</span><br><span class="line">force_local_logins_ssl=yes/no    非匿名用户登陆时是否加密,默认为yes</span><br><span class="line">force_local_data_ssl=yes/no     非匿名用户传输数据时是否加密,默认为yes</span><br><span class="line">force_anon_logins_ssl=yes/no    匿名用户登录时是否加密,默认为no</span><br><span class="line">force_anon_data_ssl=yes/no     匿名用户数据传输时是否加密,默认为no</span><br><span class="line">ssl_sslv2=yes/no               是否激活sslv2加密,默认no</span><br><span class="line">ssl_sslv3=yes/no                是否激活sslv3加密,默认no</span><br><span class="line">ssl_tlsv1=yes/no                是否激活tls v1加密,默认yes</span><br><span class="line">ssl_ciphers=加密方法            默认是DES-CBC3-SHA</span><br><span class="line">require_ssl_reuse=no 需要数据与控制流使用相同的ssl通道，程序是另起一个ssl通道，选no</span><br><span class="line">#使用ftps的情况下，主动模式是不能用的，必须使用别动模式，为考虑安全问题，可以指定被动端口范围：</span><br><span class="line">pasv_enable=YES</span><br><span class="line">pasv_min_port=20000</span><br><span class="line">pasv_max_port=20001</span><br></pre></td></tr></table></figure></p><p>修改vsftpd的主配置文件vsftpd.conf添加如下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ssl_enable=YES</span><br><span class="line">allow_anon_ssl=YES</span><br><span class="line">force_anon_logins_ssl=YES</span><br><span class="line">force_anon_data_ssl=YES</span><br><span class="line">force_local_logins_ssl=YES</span><br><span class="line">force_local_data_ssl=YES</span><br><span class="line">ssl_tlsv1=YES</span><br><span class="line">ssl_sslv2=NO</span><br><span class="line">ssl_sslv3=NO</span><br><span class="line">rsa_cert_file=/etc/vsftpd/vsftpd.pem</span><br><span class="line">require_ssl_reuse=no</span><br><span class="line">pasv_enable=YES</span><br><span class="line">pasv_min_port=20000</span><br><span class="line">pasv_max_port=20001</span><br></pre></td></tr></table></figure></p><h4 id="4、重启vsftpd服务"><a href="#4、重启vsftpd服务" class="headerlink" title="4、重启vsftpd服务"></a>4、重启vsftpd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd</span><br></pre></td></tr></table></figure><h4 id="5、默认linux自带的ftp-client不支持ssl协议，如果配置了ssl，使用ftp-client连接会报错"><a href="#5、默认linux自带的ftp-client不支持ssl协议，如果配置了ssl，使用ftp-client连接会报错" class="headerlink" title="5、默认linux自带的ftp client不支持ssl协议，如果配置了ssl，使用ftp client连接会报错"></a>5、默认linux自带的ftp client不支持ssl协议，如果配置了ssl，使用ftp client连接会报错</h4><p><img src="https://i.imgur.com/gklzknf.png" alt=""><br>可以使用第三方的surgeftp测试，下载方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.netwinsite.com/pub/surgeftp/surgeftp_23f2_linux64.tar.gz</span><br></pre></td></tr></table></figure></p><p>解压之后，测试连接是否正常：<br><img src="https://i.imgur.com/8blhpQc.png" alt=""><br>也可以使用windows下的ftp软件测试，如FileZilla，配置方法如下：<br><img src="https://i.imgur.com/UUcMQL8.png" alt=""></p><h4 id="6、配置过程终于到的问题："><a href="#6、配置过程终于到的问题：" class="headerlink" title="6、配置过程终于到的问题："></a>6、配置过程终于到的问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">522 SSL connection failed; session reuse required: see require_ssl_reuse option in vsftpd.conf man page</span><br><span class="line">解决方法：</span><br><span class="line">查看vsftpd.conf配置文件是否配置了下面参数</span><br><span class="line">require_ssl_reuse=no</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mgr解散集群并重新加入集群</title>
      <link href="/2018/11/09/mysql-mgr%E8%A7%A3%E6%95%A3%E9%9B%86%E7%BE%A4%E5%B9%B6%E9%87%8D%E6%96%B0%E6%B7%BB%E5%8A%A0/"/>
      <url>/2018/11/09/mysql-mgr%E8%A7%A3%E6%95%A3%E9%9B%86%E7%BE%A4%E5%B9%B6%E9%87%8D%E6%96%B0%E6%B7%BB%E5%8A%A0/</url>
      <content type="html"><![CDATA[<h4 id="1、查看集群状态"><a href="#1、查看集群状态" class="headerlink" title="1、查看集群状态"></a>1、查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、解散集群："><a href="#2、解散集群：" class="headerlink" title="2、解散集群："></a>2、解散集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.dissolve()</span><br><span class="line">The cluster still has active ReplicaSets.</span><br><span class="line">Please use cluster.dissolve(&#123;force: true&#125;) to deactivate replication</span><br><span class="line">and unregister the ReplicaSets from the cluster.</span><br><span class="line"></span><br><span class="line">The following replicasets are currently registered:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;topology&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.dissolve(&#123;force: true&#125;)</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The cluster was successfully dissolved.</span><br><span class="line">Replication was disabled but user data was left intact.</span><br></pre></td></tr></table></figure><h4 id="3、查看集群信息已经被删掉了："><a href="#3、查看集群信息已经被删掉了：" class="headerlink" title="3、查看集群信息已经被删掉了："></a>3、查看集群信息已经被删掉了：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:54:  [mysql_innodb_cluster_metadata]&gt; select * from clusters;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4、重新建立集群："><a href="#4、重新建立集群：" class="headerlink" title="4、重新建立集群："></a>4、重新建立集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; var cluster = dba.createCluster(&apos;prodCluster&apos;);</span><br><span class="line">A new InnoDB cluster will be created on instance &apos;repl@dax-mysql-master:3306&apos;.</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-master:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-master</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;repl@dax-mysql-master:3306&apos;...</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">Adding Seed Instance...</span><br><span class="line"></span><br><span class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</span><br><span class="line">At least 3 instances are needed for the cluster to be able to withstand up to</span><br><span class="line">one server failure.</span><br></pre></td></tr></table></figure><h4 id="5、-查看集群状态，现在只有一个节点信息"><a href="#5、-查看集群状态，现在只有一个节点信息" class="headerlink" title="5、 查看集群状态，现在只有一个节点信息"></a>5、 查看集群状态，现在只有一个节点信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、添加新的节点："><a href="#6、添加新的节点：" class="headerlink" title="6、添加新的节点："></a>6、添加新的节点：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &apos;root@dax-mysql-slave:3306&apos;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &apos;root@dax-mysql-slave:3306&apos; was successfully added to the cluster.</span><br></pre></td></tr></table></figure><h4 id="7、查看集群状态，可以看到两个节点了："><a href="#7、查看集群状态，可以看到两个节点了：" class="headerlink" title="7、查看集群状态，可以看到两个节点了："></a>7、查看集群状态，可以看到两个节点了：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@db 17:14:  [mysql_innodb_cluster_metadata]&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 17:14:  [mysql_innodb_cluster_metadata]&gt; show status like &apos;%primary%&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mgr单主模式切换为多主，多主切换为单主</title>
      <link href="/2018/11/09/mysql-mgr%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F%E5%88%87%E6%8D%A2%E4%B8%BA%E5%A4%9A%E4%B8%BB/"/>
      <url>/2018/11/09/mysql-mgr%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F%E5%88%87%E6%8D%A2%E4%B8%BA%E5%A4%9A%E4%B8%BB/</url>
      <content type="html"><![CDATA[<h4 id="1、停止组复制-所有节点执行-："><a href="#1、停止组复制-所有节点执行-：" class="headerlink" title="1、停止组复制(所有节点执行)："></a>1、停止组复制(所有节点执行)：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop group_replication; </span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode=OFF; </span><br><span class="line">mysql&gt; set global group_replication_enforce_update_everywhere_checks=ON;</span><br></pre></td></tr></table></figure><h4 id="2、随便选择某个节点执行"><a href="#2、随便选择某个节点执行" class="headerlink" title="2、随便选择某个节点执行"></a>2、随便选择某个节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON; </span><br><span class="line">mysql&gt; START GROUP_REPLICATION; </span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</span><br></pre></td></tr></table></figure><h4 id="3、其他节点执行"><a href="#3、其他节点执行" class="headerlink" title="3、其他节点执行"></a>3、其他节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure><p>查看节点启动报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018-11-08T14:00:52.098660Z 56 [ERROR] Plugin group_replication reported: &apos;There was an error when connecting to the donor server. Please check that group_replication_recovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.&apos;</span><br><span class="line">2018-11-08T14:00:52.098689Z 56 [ERROR] Plugin group_replication reported: &apos;For details please check performance_schema.replication_connection_status table and error log messages of Slave I/O for channel group_replication_recovery.&apos;</span><br></pre></td></tr></table></figure></p><p>手动配置复制信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_user=&apos;repl&apos;,master_password=&apos;12345678&apos; for channel &apos;group_replication_recovery&apos;;</span><br></pre></td></tr></table></figure></p><p>再次启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure></p><h4 id="4、查看组信息，所有节点的信息正常，所有节点均为主："><a href="#4、查看组信息，所有节点的信息正常，所有节点均为主：" class="headerlink" title="4、查看组信息，所有节点的信息正常，所有节点均为主："></a>4、查看组信息，所有节点的信息正常，所有节点均为主：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br></pre></td></tr></table></figure><h4 id="5、查看集群状态"><a href="#5、查看集群状态" class="headerlink" title="5、查看集群状态"></a>5、查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Single-Master) does not match the current Group Replication configuration (Multi-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure><p>提示cluster 拓扑类型为单主与当前的mgr(多主)不匹配，使用cluster.rescan()参数重新扫描：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan()</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>再次查看集群状态仍然报错：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Single-Master) does not match the current Group Replication configuration (Multi-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure></p><p>尝试删除集群元数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dba.dropMetadataSchema();</span><br><span class="line">Are you sure you want to remove the Metadata? [y/N]: y</span><br><span class="line">Metadata Schema successfully removed.</span><br></pre></td></tr></table></figure></p><p>重新创建集群<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true ,force: true&#125;);</span><br></pre></td></tr></table></figure></p><p>报错提示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Plugin group_replication reported: &apos;Table instances has a foreign key with &apos;CASCADE&apos; clause. This is not compatible with Group Replication&apos;</span><br></pre></td></tr></table></figure></p><p>创建集群会在mysql_innodb_cluster_metadata库下建立一个instances的表，在单主模式下创建集群没有外键级联的报错问题，在多主模式下提示有外键级联的问题，表内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `instances` (</span><br><span class="line">  `instance_id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `host_id` int(10) unsigned NOT NULL,</span><br><span class="line">  `replicaset_id` int(10) unsigned DEFAULT NULL,</span><br><span class="line">  `mysql_server_uuid` varchar(40) NOT NULL,</span><br><span class="line">  `instance_name` varchar(256) NOT NULL,</span><br><span class="line">  `role` enum(&apos;HA&apos;,&apos;readScaleOut&apos;) NOT NULL,</span><br><span class="line">  `weight` float DEFAULT NULL,</span><br><span class="line">  `addresses` json NOT NULL,</span><br><span class="line">  `attributes` json DEFAULT NULL,</span><br><span class="line">  `version_token` int(10) unsigned DEFAULT NULL,</span><br><span class="line">  `description` text,</span><br><span class="line">  PRIMARY KEY (`instance_id`),</span><br><span class="line">  UNIQUE KEY `mysql_server_uuid` (`mysql_server_uuid`),</span><br><span class="line">  UNIQUE KEY `instance_name` (`instance_name`),</span><br><span class="line">  KEY `host_id` (`host_id`),</span><br><span class="line">  KEY `instances_ibfk_2` (`replicaset_id`),</span><br><span class="line">  CONSTRAINT `instances_ibfk_1` FOREIGN KEY (`host_id`) REFERENCES `hosts` (`host_id`),</span><br><span class="line">  CONSTRAINT `instances_ibfk_2` FOREIGN KEY (`replicaset_id`) REFERENCES `replicasets` (`replicaset_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br></pre></td></tr></table></figure></p><p>查阅官方文档有提示说多主模式下存在这个<a href="https://bugs.mysql.com/bug.php?id=91972" target="_blank" rel="noopener">bug</a>，将该表下的外键约束去掉：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` DROP FOREIGN KEY `instances_ibfk_1`;</span><br><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` DROP FOREIGN KEY `instances_ibfk_2`;</span><br></pre></td></tr></table></figure></p><p>重建添加外键使用下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` ADD CONSTRAINT `instances_ibfk_1` FOREIGN KEY (`host_id`) REFERENCES `hosts` (`host_id`);</span><br><span class="line">ALTER TABLE `mysql_innodb_cluster_metadata`.`instances` ADD CONSTRAINT `instances_ibfk_2` </span><br><span class="line">FOREIGN KEY (`replicaset_id`) REFERENCES `replicasets` (`replicaset_id`);</span><br></pre></td></tr></table></figure></p><p>将外键约束删除之后，重新创建集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true ,force: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &apos;repl@dax-mysql-master:3306&apos;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;repl@dax-mysql-master:3306&apos;...</span><br><span class="line">Adding Instance &apos;dax-mysql-slave:3306&apos;...</span><br><span class="line">Adding Instance &apos;dax-mysql-master:3306&apos;...</span><br><span class="line"></span><br><span class="line">Cluster successfully created based on existing replication group.</span><br></pre></td></tr></table></figure></p><p>集群创建成功，查看集群状态,两个节点均为读写模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主："><a href="#6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主：" class="headerlink" title="6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主："></a>6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主：</h4><h4 id="7、所有节点执行"><a href="#7、所有节点执行" class="headerlink" title="7、所有节点执行"></a>7、所有节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop group_replication; </span><br><span class="line">mysql&gt; set global group_replication_enforce_update_everywhere_checks=OFF; </span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode=ON;</span><br></pre></td></tr></table></figure><h4 id="8、主节点（dax-mysql-master）执行"><a href="#8、主节点（dax-mysql-master）执行" class="headerlink" title="8、主节点（dax-mysql-master）执行"></a>8、主节点（dax-mysql-master）执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL group_replication_bootstrap_group=ON; </span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br></pre></td></tr></table></figure><h4 id="9、从节点执行："><a href="#9、从节点执行：" class="headerlink" title="9、从节点执行："></a>9、从节点执行：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure><h4 id="10、查看MGR组信息-所有节点同步正常："><a href="#10、查看MGR组信息-所有节点同步正常：" class="headerlink" title="10、查看MGR组信息,所有节点同步正常："></a>10、查看MGR组信息,所有节点同步正常：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br></pre></td></tr></table></figure><p>查看当前主节点信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show status like &apos;%primary%&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><h4 id="11、登录mysql-shell查看集群信息："><a href="#11、登录mysql-shell查看集群信息：" class="headerlink" title="11、登录mysql-shell查看集群信息："></a>11、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Multi-Master) does not match the current Group Replication configuration (Single-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan()</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Multi-Master) does not match the current Group Replication configuration (Single-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure><p>跟多主切换为单主报错相同，尝试删除集群元数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dba.dropMetadataSchema();</span><br><span class="line">Are you sure you want to remove the Metadata? [y/N]: y</span><br><span class="line">Metadata Schema successfully removed.</span><br></pre></td></tr></table></figure></p><p>重新创建集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &apos;repl@dax-mysql-master:3306&apos;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;repl@dax-mysql-master:3306&apos;...</span><br><span class="line">Adding Seed Instance...</span><br><span class="line">Adding Instance &apos;dax-mysql-slave:3306&apos;...</span><br><span class="line"></span><br><span class="line">Cluster successfully created based on existing replication group.</span><br></pre></td></tr></table></figure></p><p>集群创建成功，查看集群状态为一主一从模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt;  cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mgr（双节点)依次修改server-id</title>
      <link href="/2018/11/09/mysql-mgr%EF%BC%88%E5%8F%8C%E8%8A%82%E7%82%B9%E4%BE%9D%E6%AC%A1%E4%BF%AE%E6%94%B9server-id)/"/>
      <url>/2018/11/09/mysql-mgr%EF%BC%88%E5%8F%8C%E8%8A%82%E7%82%B9%E4%BE%9D%E6%AC%A1%E4%BF%AE%E6%94%B9server-id)/</url>
      <content type="html"><![CDATA[<h4 id="1、查看从节点server-id信息："><a href="#1、查看从节点server-id信息：" class="headerlink" title="1、查看从节点server-id信息："></a>1、查看从节点server-id信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:55:  [(none)]&gt; show variables like &quot;%server%&quot;;</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| character_set_server                              | utf8mb4                              |</span><br><span class="line">| collation_server                                  | utf8mb4_general_ci                   |</span><br><span class="line">| group_replication_recovery_ssl_verify_server_cert | OFF                                  |</span><br><span class="line">| innodb_ft_server_stopword_table                   |                                      |</span><br><span class="line">| server_id                                         | 3306102                              |</span><br><span class="line">| server_id_bits                                    | 32                                   |</span><br><span class="line">| server_uuid                                       | bddd9c32-8fee-11e8-ac79-525400edbe8d |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><h4 id="2、登录mysql-shell查看集群信息："><a href="#2、登录mysql-shell查看集群信息：" class="headerlink" title="2、登录mysql-shell查看集群信息："></a>2、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将从节点移除集群：<br>MySQL  dax-mysql-master:3306  JS &gt; cluster.removeInstance(‘dax-mysql-slave:3306’)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">The instance will be removed from the InnoDB cluster. Depending on the </span><br><span class="line">instance being the Seed or not, the Metadata session might become invalid. </span><br><span class="line">If so, please start a new session to the Metadata Storage R/W instance.</span><br><span class="line"></span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The instance &apos;dax-mysql-slave:3306&apos; was successfully removed from the cluster.</span><br><span class="line"></span><br><span class="line">WARNING: The &apos;group_replication_start_on_boot&apos; variable must be set to &apos;OFF&apos; in the server configuration file, otherwise it might silently rejoin the cluster upon restart.</span><br></pre></td></tr></table></figure></p><p>重新扫描集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan();</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、从节点修改server-id，并重启库，之后将从节点加入集群："><a href="#3、从节点修改server-id，并重启库，之后将从节点加入集群：" class="headerlink" title="3、从节点修改server-id，并重启库，之后将从节点加入集群："></a>3、从节点修改server-id，并重启库，之后将从节点加入集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql-shell &gt; cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &apos;root@dax-mysql-slave:3306&apos;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &apos;root@dax-mysql-slave:3306&apos; was successfully added to the cluster.</span><br></pre></td></tr></table></figure><p>查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>其他节点修改方法如上。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] oracle本地表空间在uniform、system等不同模式下分配extent方式</title>
      <link href="/2018/11/07/oracle%E6%9C%AC%E5%9C%B0%E8%A1%A8%E7%A9%BA%E9%97%B4%E5%9C%A8uniform%E3%80%81system%E7%AD%89%E4%B8%8D%E5%90%8C%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%88%86%E9%85%8Dextent%E6%96%B9%E5%BC%8F/"/>
      <url>/2018/11/07/oracle%E6%9C%AC%E5%9C%B0%E8%A1%A8%E7%A9%BA%E9%97%B4%E5%9C%A8uniform%E3%80%81system%E7%AD%89%E4%B8%8D%E5%90%8C%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%88%86%E9%85%8Dextent%E6%96%B9%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h4 id="1、表空间和表都使用oracle默认参数"><a href="#1、表空间和表都使用oracle默认参数" class="headerlink" title="1、表空间和表都使用oracle默认参数"></a>1、表空间和表都使用oracle默认参数</h4><p>查看scott用户默认表空间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select username,default_tablespace from dba_users where username=&apos;SCOTT&apos;;</span><br><span class="line">USERNAME       DEFAULT_TABLESPACE</span><br><span class="line">------------------------------ ------------------------------</span><br><span class="line">SCOTT       USERS</span><br></pre></td></tr></table></figure></p><p>查看users表空间初始化extent大小：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select TABLESPACE_NAME,BLOCK_SIZE,INITIAL_EXTENT,NEXT_EXTENT,MIN_EXTENTS,MAX_EXTENTS,EXTENT_MANAGEMENT,ALLOCATION_TYPE from user_tablespaces where tablespace_name=&apos;USERS&apos;;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME        BLOCK_SIZE INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS EXTENT_MAN ALLOCATIO</span><br><span class="line">------------------------------ ---------- -------------- ----------- ----------- ----------- ---------- ---------</span><br><span class="line">USERS     8192   65536       1  2147483645 LOCALSYSTEM</span><br></pre></td></tr></table></figure></p><p>查看当前数据库块大小：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show parameter db_block_size;</span><br><span class="line"></span><br><span class="line">NAME     TYPE VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">db_block_size     integer 8192</span><br></pre></td></tr></table></figure></p><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11:43:49 SCOTT@ boston&gt;  create table t1 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line">表数据为空，查看是否有extent区在：</span><br><span class="line">11:43:54 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p><p>向t1表内插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">11:43:50 SCOTT@ boston&gt;  insert into t1  select * from emp;</span><br><span class="line">14 rows created.</span><br></pre></td></tr></table></figure></p><p>查看已分配出一个8个block的extent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">11:43:55 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      4        176    8</span><br><span class="line">Elapsed: 00:00:00.50</span><br></pre></td></tr></table></figure></p><p>因数据量太小，只分配了一个区，需插入大量数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12:00:40 SCOTT@ boston&gt;  insert into t1  select * from t1;</span><br><span class="line">42 rows created.</span><br><span class="line">...</span><br><span class="line">12:00:57 SCOTT@ boston&gt; /</span><br><span class="line">2688 rows created.</span><br><span class="line">Elapsed: 00:00:00.02</span><br></pre></td></tr></table></figure></p><p>再次查看extent，当分配16个extent之后，数据量达到了16<em>8</em>8/1024=1M，当达到1m之后，在分配下一个extent会直接分配128个块，大小分为128*8/1024=1M：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">12:01:01 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      4        176    8</span><br><span class="line">...</span><br><span class="line">T1  15      4        296    8</span><br><span class="line">T1  16      4        384  128</span><br></pre></td></tr></table></figure></p><p>再次插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12:28:36 SCOTT@ boston&gt; /</span><br><span class="line">5376 rows created.</span><br><span class="line">Elapsed: 00:00:00.02</span><br><span class="line">....</span><br><span class="line">12:30:11 SCOTT@ boston&gt; /</span><br><span class="line">688128 rows created.</span><br></pre></td></tr></table></figure></p><p>查看extent情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">12:30:14 SYS@ boston&gt;select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      4        176    8</span><br><span class="line">....</span><br><span class="line">T1  15      4        296    8</span><br><span class="line">T1  16      4        384  128</span><br><span class="line">...</span><br><span class="line">T1  78      4       8320  128</span><br><span class="line">T1  79      4       8448 1024</span><br><span class="line">80 rows selected.</span><br></pre></td></tr></table></figure></p><p>当表数据量达到64M的时候，再次分配下一个extent会直接分配1024个block，大小为64M。</p><p>手动对表t1分配extent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">13:35:52 SCOTT@ boston&gt; alter table t1 allocate extent;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.49</span><br><span class="line">14:18:45 SCOTT@ boston&gt; /</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.07</span><br><span class="line">14:19:28 SCOTT@ boston&gt; /</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.06</span><br></pre></td></tr></table></figure></p><p>查看extent情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">14:19:06 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      4        176    8</span><br><span class="line">...</span><br><span class="line">T1  15      4        296    8</span><br><span class="line">T1  16      4        384  128</span><br><span class="line">...</span><br><span class="line">T1  78      4       8320  128</span><br><span class="line">T1  79      4       8448 1024</span><br><span class="line">T1  80      4       9472  128</span><br><span class="line">T1  81      4       9600  128</span><br><span class="line">T1  82      4       9728  128</span><br><span class="line">83 rows selected.</span><br><span class="line">Elapsed: 00:00:00.45</span><br></pre></td></tr></table></figure></p><p>使用alter table ** allocate extent手动分配的区大小为1M。</p><p>再次对表插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">14:19:30 SCOTT@ boston&gt;  insert into t1  select * from t1;</span><br><span class="line">1376256 rows created.</span><br><span class="line">Elapsed: 00:00:12.03</span><br></pre></td></tr></table></figure></p><p>查看extent情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">14:20:34 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      4        176    8</span><br><span class="line">...</span><br><span class="line">T1  15      4        296    8</span><br><span class="line">T1  16      4        384  128</span><br><span class="line">...</span><br><span class="line">T1  78      4       8320  128</span><br><span class="line">T1  79      4       8448 1024</span><br><span class="line">T1  80      4       9472  128</span><br><span class="line">T1  81      4       9600  128</span><br><span class="line">T1  82      4       9728  128</span><br><span class="line">T1  83      4       9856 1024</span><br><span class="line">...</span><br><span class="line">T1  88      4      14976 1024</span><br><span class="line">89 rows selected.</span><br></pre></td></tr></table></figure></p><p>插入数据分配的extent大小均为64M。</p><h4 id="2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）："><a href="#2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）：" class="headerlink" title="2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）："></a>2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）：</h4><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table t2 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t2 MOVE STORAGE ( INITIAL 20k NEXT 40k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure></p><p>查看表参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name = &apos;T2&apos;;</span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line"> 24576     40960</span><br></pre></td></tr></table></figure></p><p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p><p>向表空插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from emp;</span><br><span class="line">insert into t2 select * from t2;</span><br></pre></td></tr></table></figure></p><p>查看extent情况:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2   0      4        168    8</span><br></pre></td></tr></table></figure></p><p>分配出来的extent最少8个块。<br>多次插入数据查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2   0      4        168    8</span><br><span class="line">...</span><br><span class="line">T2  15      4      17184    8</span><br><span class="line">T2  16      4      17280  128</span><br><span class="line">...</span><br><span class="line">T2  78      4       7936  128</span><br><span class="line">T2  79      4       8064 1024</span><br><span class="line">T2  80      4       9088 1024</span><br><span class="line">T2  81      4      10112 1024</span><br><span class="line">T2  82      4      11136 1024</span><br></pre></td></tr></table></figure></p><p>extent分配增长情况为（64k-1m-64m-…)。</p><h4 id="3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）："><a href="#3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）：" class="headerlink" title="3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）："></a>3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）：</h4><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> create table t3 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t3 MOVE STORAGE ( INITIAL 100k NEXT 40k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure></p><p>查看表参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name = &apos;T3&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">106496     40960</span><br></pre></td></tr></table></figure></p><p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T3&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p><p>向表空插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t3 select * from emp;</span><br></pre></td></tr></table></figure></p><p>一次分配出来两个extent，每个extent8个block：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T3&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T3   0      4        176    8</span><br><span class="line">T3   1      4        184    8</span><br></pre></td></tr></table></figure></p><p>再次插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t3 select * from t3;</span><br></pre></td></tr></table></figure></p><p>不要插入太多数据，查看下一次分配的extent为1个，占8个块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T3&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T3   0      4        208    8</span><br><span class="line">T3   1      4        216    8</span><br><span class="line">T3   2      4        224    8</span><br></pre></td></tr></table></figure></p><p>再次插入数据，extent增长情况（64k-1m-64m）</p><h4 id="4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）："><a href="#4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）：" class="headerlink" title="4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）："></a>4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）：</h4><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> create table t4 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t4 MOVE STORAGE ( INITIAL 100k NEXT 140k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure></p><p>查看表参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">14:31:43 SCOTT@ boston&gt; SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name = &apos;T4&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">106496    147456</span><br></pre></td></tr></table></figure></p><p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T4&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p><p>向表空插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t4 select * from emp;</span><br></pre></td></tr></table></figure></p><p>一次分配出来两个extent，每个extent8个block：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T4&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T4   0      4        176    8</span><br><span class="line">T4   1      4        184    8</span><br></pre></td></tr></table></figure></p><p>再次插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t4 select * from t4;</span><br></pre></td></tr></table></figure></p><p>不要插入太多数据，查看下一次分配的extent为1个，占8个块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T4&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T4   0      4        176    8</span><br><span class="line">T4   1      4        184    8</span><br><span class="line">T4   2      4        192    8</span><br></pre></td></tr></table></figure></p><p>再次插入数据，extent增长情况（64k-1m-64m）</p><h4 id="5、创建表空间使用并设置extent大小，统一为2m："><a href="#5、创建表空间使用并设置extent大小，统一为2m：" class="headerlink" title="5、创建表空间使用并设置extent大小，统一为2m："></a>5、创建表空间使用并设置extent大小，统一为2m：</h4><p>创建测试表空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create tablespace test datafile &apos;/data/u01/app/oracle/oradata/boston/test01.dbf&apos; size 100M extent management local uniform size 2m;</span><br></pre></td></tr></table></figure></p><p>查看表空间参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15:28:39 SYS@ boston&gt; select TABLESPACE_NAME,BLOCK_SIZE,INITIAL_EXTENT,NEXT_EXTENT,MIN_EXTENTS,MAX_EXTENTS,EXTENT_MANAGEMENT,ALLOCATION_TYPE from user_tablespaces where tablespace_name=&apos;TEST&apos;;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME        BLOCK_SIZE INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS EXTENT_MAN ALLOCATIO</span><br><span class="line">------------------------------ ---------- -------------- ----------- ----------- ----------- ---------- ---------</span><br><span class="line">TEST     8192 2097152     2097152       1  2147483645 LOCALUNIFORM</span><br></pre></td></tr></table></figure></p><h5 id="6、表空间使用上面创建的test表空间，表参数默认："><a href="#6、表空间使用上面创建的test表空间，表参数默认：" class="headerlink" title="6、表空间使用上面创建的test表空间，表参数默认："></a>6、表空间使用上面创建的test表空间，表参数默认：</h5><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t1;</span><br><span class="line">create table t1 as select * from emp where 0=1;</span><br><span class="line">alter table t1 move tablespace test;</span><br></pre></td></tr></table></figure></p><p>查看表t1参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent,next_extent,min_extents,max_extents,pct_increase,blocks,sample_size FROM user_tables WHERE  table_name = &apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">       2097152   2097152     12147483645      0</span><br></pre></td></tr></table></figure></p><p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">15:32:51 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">no rows selected</span><br><span class="line">Elapsed: 00:00:00.04</span><br></pre></td></tr></table></figure></p><p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15:33:16 SCOTT@ boston&gt; insert into t1  select * from emp;</span><br><span class="line">14 rows created.</span><br></pre></td></tr></table></figure></p><p>为t1表分配了一个2m大小的extent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:32:54 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      5        128  256</span><br></pre></td></tr></table></figure></p><p>批量插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">15:48:07 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1   0      5        128  256</span><br><span class="line">...</span><br><span class="line">T1  80      5      20608  256</span><br><span class="line">81 rows selected.</span><br></pre></td></tr></table></figure></p><p>不管插入多少数据，因为设置了统一大小为2m，一个extent永远都是256个块。</p><h5 id="7、表空间使用上面创建的test表空间，表参数自定义："><a href="#7、表空间使用上面创建的test表空间，表参数自定义：" class="headerlink" title="7、表空间使用上面创建的test表空间，表参数自定义："></a>7、表空间使用上面创建的test表空间，表参数自定义：</h5><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t2;</span><br><span class="line">create table t2 as select * from emp where 0=1;</span><br><span class="line">ALTER TABLE t2 MOVE STORAGE ( INITIAL 5m NEXT 5m) TABLESPACE test;</span><br></pre></td></tr></table></figure></p><p>查看表t2参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent,next_extent,min_extents,max_extents,pct_increase,blocks,sample_size FROM user_tables WHERE  table_name = &apos;T2&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">       5242880   5242880</span><br></pre></td></tr></table></figure></p><p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">no rows selected</span><br><span class="line">Elapsed: 00:00:00.11</span><br></pre></td></tr></table></figure></p><p>插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from emp;</span><br></pre></td></tr></table></figure></p><p>因为初始化设置为5m，而每个extent大小统一为2m，因此分配出三个extent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2   0      5       1920  256</span><br><span class="line">T2   1      5       2176  256</span><br><span class="line">T2   2      5       2432  256</span><br></pre></td></tr></table></figure></p><p>再次插入数据，一次性不要插入太多：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from t2;</span><br><span class="line">...</span><br><span class="line">insert into t2 (select * from t2 where rownum &lt; 10000);</span><br></pre></td></tr></table></figure></p><p>当前三个extent用满之后再次分配extent时，分配1个extent，大小为2m。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">SEGMENT_NAME   EXTENT_IDFILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2   0      5        640  256</span><br><span class="line">T2   1      5        896  256</span><br><span class="line">T2   2      5       1152  256</span><br><span class="line">T2   3      5       1408  256</span><br></pre></td></tr></table></figure></p><h4 id="8、测试总结"><a href="#8、测试总结" class="headerlink" title="8、测试总结"></a>8、测试总结</h4><p>在本地管理表空间的模式下，oracle分配extent，会根据initial指定的参数分配（按相应的倍数），但是next指定的值会被忽略。官方文档如下所示：<br><img src="https://i.imgur.com/ZsQ7zP1.png" alt=""><br><img src="https://i.imgur.com/hcElxSO.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] centos安装vsftp</title>
      <link href="/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/"/>
      <url>/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/</url>
      <content type="html"><![CDATA[<h4 id="1、检查vsftp是否安装，如果没有yum安装vsftp："><a href="#1、检查vsftp是否安装，如果没有yum安装vsftp：" class="headerlink" title="1、检查vsftp是否安装，如果没有yum安装vsftp："></a>1、检查vsftp是否安装，如果没有yum安装vsftp：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa| grep vsftpd</span><br><span class="line">yum install vsftpd -y</span><br></pre></td></tr></table></figure><h4 id="2、创建用户："><a href="#2、创建用户：" class="headerlink" title="2、创建用户："></a>2、创建用户：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adduser -s /sbin/nologin -d /var/ftp/ftp1 ftp1 </span><br><span class="line">修改用户名：</span><br><span class="line">passwd ftp1</span><br></pre></td></tr></table></figure><h4 id="3、修改配置文件："><a href="#3、修改配置文件：" class="headerlink" title="3、修改配置文件："></a>3、修改配置文件：</h4><p>cat /etc/vsftpd/vsftpd.conf |grep -v ‘^#’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#禁止匿名用户登录</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">#不允许chroot_list下的用户访问其他目录：</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">listen=NO</span><br><span class="line">listen_ipv6=YES</span><br><span class="line"></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">#只允许vsftpd.user_list文件下的用户登录：</span><br><span class="line">userlist_enable=YES</span><br><span class="line">userlist_deny=NO</span><br><span class="line">userlist_file=/etc/vsftpd/vsftpd.user_list</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure></p><h4 id="4、添加访问用户："><a href="#4、添加访问用户：" class="headerlink" title="4、添加访问用户："></a>4、添加访问用户：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/vsftpd/vsftpd.user_list</span><br><span class="line">ftp1</span><br><span class="line"></span><br><span class="line">cat /etc/vsftpd/chroot_list</span><br><span class="line">ftp1</span><br></pre></td></tr></table></figure><h4 id="5、启动，查看ftp服务状态"><a href="#5、启动，查看ftp服务状态" class="headerlink" title="5、启动，查看ftp服务状态"></a>5、启动，查看ftp服务状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd status</span><br><span class="line">service vsftpd start</span><br><span class="line">service vsftpd stop</span><br><span class="line">service vsftpd restart</span><br></pre></td></tr></table></figure><h4 id="6、客户端安装ftp："><a href="#6、客户端安装ftp：" class="headerlink" title="6、客户端安装ftp："></a>6、客户端安装ftp：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ftp</span><br></pre></td></tr></table></figure><p>连接到ftp-server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; ftp *.*.*.*</span><br></pre></td></tr></table></figure></p><h4 id="7、配置过程遇到的问题："><a href="#7、配置过程遇到的问题：" class="headerlink" title="7、配置过程遇到的问题："></a>7、配置过程遇到的问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">500 OOPS: vsftpd: refusing to run with writable root inside chroot ()</span><br><span class="line">查看配置文件该行参数是否配置：</span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">500 OOPS: chroot</span><br><span class="line">Login failed.</span><br><span class="line">421 Service not available, remote server has closed connection</span><br><span class="line">检查selinux是否为enforcing状态，并修改：</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ftp vsftpd 530 login incorrect</span><br><span class="line">解决方法：</span><br><span class="line">1.检查密码是否正常。</span><br><span class="line">2.检查/etc/vsftpd/vsftpd.conf配置：</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">userlist_deny=NO</span><br><span class="line">userlist_file=/etc/vsftpd/vsftpd.user_list</span><br><span class="line">3.检查/etc/pam.d/vsftpd配置：</span><br><span class="line">#%PAM-1.0</span><br><span class="line">session    optional     pam_keyinit.so    force revoke</span><br><span class="line">auth       requiredpam_listfile.so item=user sense=deny file=/etc/vsftpd/ftpusers onerr=succeed</span><br><span class="line">auth       requiredpam_shells.so</span><br><span class="line">auth       includepassword-auth</span><br><span class="line">account    includepassword-auth</span><br><span class="line">session    required     pam_loginuid.so</span><br><span class="line">session    includepassword-auth</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql意外drop表之后，使用innobackupex恢复</title>
      <link href="/2018/11/06/mysql%E6%84%8F%E5%A4%96drop%E8%A1%A8%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BD%BF%E7%94%A8innobackupex%E6%81%A2%E5%A4%8D/"/>
      <url>/2018/11/06/mysql%E6%84%8F%E5%A4%96drop%E8%A1%A8%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BD%BF%E7%94%A8innobackupex%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<h4 id="1、使用innodbackupex备份测试删除表："><a href="#1、使用innodbackupex备份测试删除表：" class="headerlink" title="1、使用innodbackupex备份测试删除表："></a>1、使用innodbackupex备份测试删除表：</h4><p>innobackupex备份某以一张表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./innobackupex --defaults-file=/etc/my.cnf --databases=&quot;aaaa.test_order&quot; --user=root --password=12345678 --port=3306 /tmp</span><br></pre></td></tr></table></figure></p><p>如果要备份多个表，使用以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./innobackupex --defaults-file=/etc/my.cnf --databases=&quot;aaaa.test_order aaaa.test1&quot; --user=root --password=12345678 --port=3306 /tmp</span><br></pre></td></tr></table></figure></p><p>使用innobackupex备份出来的的数据在aaaa文件下面会存在table_name.frm和table_name.ibd两个文件。</p><h4 id="2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该链接，对表结构进行恢复"><a href="#2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该链接，对表结构进行恢复" class="headerlink" title="2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该链接，对表结构进行恢复"></a>2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该<a href="https://zeven0707.github.io/2018/11/01/mysql%E4%BD%BF%E7%94%A8%E5%A4%87%E4%BB%BD%E7%9A%84.frm%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E8%A1%A8%E7%BB%93%E6%9E%84/" target="_blank" rel="noopener">链接</a>，对表结构进行恢复</h4><h4 id="3、恢复完表结构之后，开始恢复数据，丢弃表空间："><a href="#3、恢复完表结构之后，开始恢复数据，丢弃表空间：" class="headerlink" title="3、恢复完表结构之后，开始恢复数据，丢弃表空间："></a>3、恢复完表结构之后，开始恢复数据，丢弃表空间：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#为防止新的数据写入，对表加锁：</span><br><span class="line">root@db 16:20:  [aaaa]&gt; lock tables tb1 write;</span><br><span class="line"></span><br><span class="line">root@db 16:20:  [aaaa]&gt; alter table test_order discard tablespace; </span><br><span class="line">Query OK, 0 rows affected (0.54 sec)</span><br></pre></td></tr></table></figure><p>将对应的ibd文件拷入对应的数据目录,修改数据文件权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; cp test_order.ibd /data/mysql/data/aaaa/</span><br><span class="line">shell &gt; chown mysql.mysql test_order.ibd</span><br></pre></td></tr></table></figure></p><p>载入表空间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:24:  [aaaa]&gt; alter table test_order import tablespace;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (1 min 53.51 sec)</span><br></pre></td></tr></table></figure></p><p>查看有无报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show warnings;</span><br></pre></td></tr></table></figure></p><h4 id="4、对备份之后的数据进行恢复，查看备份开始的时间点"><a href="#4、对备份之后的数据进行恢复，查看备份开始的时间点" class="headerlink" title="4、对备份之后的数据进行恢复，查看备份开始的时间点"></a>4、对备份之后的数据进行恢复，查看备份开始的时间点</h4><p>cat xtrabackup_binlog_info<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql-binlog.000489748512183</span><br></pre></td></tr></table></figure></p><p>然后查找drop的pos点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog  -v --base64-output=DECODE-ROWS /data/mysql/log/mysql-binlog.000489 | grep -C 10 -i  &quot;DROP&quot;</span><br></pre></td></tr></table></figure></p><p>找到删除的pos点，如果不在该log文件下，需要根据（show master status)的位置向前依次筛选,找到drop表的记录，内容如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server id 1  end_log_pos 748512209 CRC32 0x3fa6b448   Query   thread_id=27    </span><br><span class="line">DROP TABLE `test_order` /* generated by server */</span><br><span class="line">/*!*/;</span><br></pre></td></tr></table></figure></p><p>找到表删除的pos点（748512209），利用binlog2sql生成中间发生sql语句，（binlog2sql方法详解<a href="https://github.com/danfengcao/binlog2sql">此处</a>）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python binlog2sql.py  -uroot -p12345678 -daaaa -ttest_order --start-position=748512183 --stop-position=748512209 --start-file=&apos;mysql-binlog.000489&apos;  &gt; /tmp/re_aaaa_test_order.sql</span><br></pre></td></tr></table></figure></p><p>生成的sql内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@dax-mysql-master binlog2sql]# cat /tmp/re_aaaa_test_order.sql</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (12); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (11); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (10); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (9); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (8); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (7); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (6); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (5); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (4); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (2); #start 2804 end 2949 time 2018-11-06 18:45:45</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=12 LIMIT 1; #start 2571 end 2716 time 2018-11-06 18:45:39</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=11 LIMIT 1; #start 2338 end 2483 time 2018-11-06 18:45:33</span><br></pre></td></tr></table></figure></p><p>生成的sql顺序是倒序的，需要重新调整（github上关于binlog2sql的用法未有关于顺序的说明）：<br>sed -i ‘1!G;h;$!d’ /tmp/re_aaaa_test_order.sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master binlog2sql]#  sed -i &apos;1!G;h;$!d&apos; /tmp/re_aaaa_test_order.sql</span><br><span class="line">[root@dax-mysql-master binlog2sql]# cat /tmp/re_aaaa_test_order.sql</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=11 LIMIT 1; #start 2338 end 2483 time 2018-11-06 18:45:33</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=12 LIMIT 1; #start 2571 end 2716 time 2018-11-06 18:45:39</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (2); #start 2804 end 2949 time 2018-11-06 18:45:45</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (4); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (5); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (6); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (7); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (8); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (9); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (10); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (11); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (12); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br></pre></td></tr></table></figure></p><h4 id="5、把这sql文件进入导入即可进行备份后的数据恢复"><a href="#5、把这sql文件进入导入即可进行备份后的数据恢复" class="headerlink" title="5、把这sql文件进入导入即可进行备份后的数据恢复"></a>5、把这sql文件进入导入即可进行备份后的数据恢复</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master binlog2sql]# mysql -u root -p12345678 aaaa &lt; /tmp/re_aaaa_test_order.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1205 (HY000) at line 1: Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure><p>需要先解锁表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure></p><p>解锁完成在重新导入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master binlog2sql]# mysql -u root -p12345678 aaaa &lt; /tmp/re_aaaa_test_order.sql</span><br></pre></td></tr></table></figure></p><p>导入成功。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] Can&#39;t start group replication on secondary member with single primary-mode while asynchronous replication channels are running</title>
      <link href="/2018/11/01/mysql-Can&#39;t%20start%20group%20replication%20on%20secondary%20member%20with%20single%20primary-mode%20while%20asynchronous%20replication%20channels%20are%20running/"/>
      <url>/2018/11/01/mysql-Can&#39;t%20start%20group%20replication%20on%20secondary%20member%20with%20single%20primary-mode%20while%20asynchronous%20replication%20channels%20are%20running/</url>
      <content type="html"><![CDATA[<h4 id="0、mysql-mgr双节点集群，节点信息如下："><a href="#0、mysql-mgr双节点集群，节点信息如下：" class="headerlink" title="0、mysql-mgr双节点集群，节点信息如下："></a>0、mysql-mgr双节点集群，节点信息如下：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">dax-mysql-master为主节点：</span><br><span class="line"> SHOW STATUS LIKE &apos;group_replication_primary_member&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><h4 id="1、因某种需要需要重启数据库，先后停止从节点group-replication"><a href="#1、因某种需要需要重启数据库，先后停止从节点group-replication" class="headerlink" title="1、因某种需要需要重启数据库，先后停止从节点group_replication;"></a>1、因某种需要需要重启数据库，先后停止从节点group_replication;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">停止数据库：</span><br><span class="line">/etc/init.d/mysql stop</span><br></pre></td></tr></table></figure><p>停止主节点group_replication;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">重启数据库</span><br><span class="line">/etc/init.d/mysql restart</span><br><span class="line">启动组复制：</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</span><br></pre></td></tr></table></figure><p>error.log日志报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T06:57:09.766303Z 6 [Note] Plugin group_replication reported: &apos;Group communication SSL configuration: group_replication_ssl_mode: &quot;DISABLED&quot;&apos;</span><br><span class="line">2018-11-01T06:57:09.768075Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 127.0.0.1/8,192.168.168.178/24 to the whitelist&apos;</span><br><span class="line">2018-11-01T06:57:09.769536Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Translated &apos;dax-mysql-master&apos; to 192.168.168.178&apos;</span><br><span class="line">2018-11-01T06:57:09.770000Z 6 [Warning] Plugin group_replication reported: &apos;[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.&apos;</span><br><span class="line">2018-11-01T06:57:09.770200Z 6 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</span><br><span class="line">2018-11-01T06:57:09.770253Z 6 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;740442c0-cc67-11e8-993e-525400578639&quot;; group_replication_local_address: &quot;dax-mysql-master:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-master:24901,dax-mysql-slave:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-11-01T06:57:09.770341Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-11-01T06:57:09.770356Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-11-01T06:57:09.770494Z 6 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306103; member_uuid: &quot;d5bd8edd-9a1d-11e8-993e-525400578639&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 7; &apos;</span><br><span class="line">2018-11-01T06:57:09.770589Z 6 [ERROR] Plugin group_replication reported: &apos;Can&apos;t start group replication on secondary member with single primary-mode while asynchronous replication channels are running.&apos;</span><br><span class="line">2018-11-01T06:57:09.770682Z 6 [Note] Plugin group_replication reported: &apos;Requesting to leave the group despite of not being a member&apos;</span><br><span class="line">2018-11-01T06:57:09.770696Z 6 [ERROR] Plugin group_replication reported: &apos;[GCS] The member is leaving a group without being on one.&apos;</span><br></pre></td></tr></table></figure></p><p>尝试重启dax-mysql-slave节点组复制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> start group_replication;</span><br><span class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</span><br></pre></td></tr></table></figure></p><p>error.log日志报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T06:59:20.617005Z 114 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 128090715, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-11-01T06:59:21.516164Z 111 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-11-01T06:59:21.516264Z 117 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000002&apos; position: 4</span><br><span class="line">2018-11-01T06:59:21.516277Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 7&apos;</span><br><span class="line">2018-11-01T06:59:21.516298Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306102&apos;</span><br><span class="line">2018-11-01T06:59:21.553616Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-11-01T06:59:21.553718Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-11-01T06:59:21.620998Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.621468Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.621794Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.621988Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622185Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622379Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622658Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622875Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.623043Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.623201Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.623220Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error connecting to all peers. Member join failed. Local port: 24901&apos;</span><br><span class="line">2018-11-01T06:59:21.624544Z 0 [Warning] Plugin group_replication reported: &apos;read failed&apos;</span><br><span class="line">2018-11-01T06:59:21.656139Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] The member was unable to join the group. Local port: 24901&apos;</span><br><span class="line">2018-11-01T07:00:21.516998Z 111 [ERROR] Plugin group_replication reported: &apos;Timeout on wait for view after joining group&apos;</span><br><span class="line">2018-11-01T07:00:21.517630Z 111 [Note] Plugin group_replication reported: &apos;Requesting to leave the group despite of not being a member&apos;</span><br><span class="line">2018-11-01T07:00:21.517820Z 111 [ERROR] Plugin group_replication reported: &apos;[GCS] The member is leaving a group without being on one.&apos;</span><br><span class="line">2018-11-01T07:00:21.519413Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_increment is reset to 1&apos;</span><br><span class="line">2018-11-01T07:00:21.519442Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_offset is reset to 1&apos;</span><br><span class="line">2018-11-01T07:00:21.521022Z 117 [Note] Error reading relay log event for channel &apos;group_replication_applier&apos;: slave SQL thread was killed</span><br><span class="line">2018-11-01T07:00:21.595775Z 114 [Note] Plugin group_replication reported: &apos;The group replication applier thread was killed&apos;</span><br><span class="line">2018-11-01T07:10:22.699429Z 111 [Note] Aborted connection 111 to db: &apos;unconnected&apos; user: &apos;root&apos; host: &apos;localhost&apos; (Got timeout reading communication packets)</span><br></pre></td></tr></table></figure></p><p>使用mysql-shell查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/mysql-shell/bin/mysqlsh --uri repl@dax-mysql-master:3306</span><br></pre></td></tr></table></figure></p><p>尝试查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">Dba.getCluster: This function is not available through a session to a standalone instance (metadata exists, but GR is not active) (RuntimeError)</span><br></pre></td></tr></table></figure></p><p>提示集群系统没有激活，尝试重启集群系统：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">dba.rebootClusterFromCompleteOutage(&apos;prodCluster&apos;)</span><br><span class="line">Reconfiguring the cluster &apos;prodCluster&apos; from complete outage...</span><br><span class="line">The instance &apos;dax-mysql-slave:3306&apos; was part of the cluster configuration.</span><br><span class="line">Would you like to rejoin it to the cluster? [y/N]: y</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The cluster was successfully rebooted.</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>集群状态恢复正常。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql使用备份的.frm文件恢复表结构</title>
      <link href="/2018/11/01/mysql%E4%BD%BF%E7%94%A8%E5%A4%87%E4%BB%BD%E7%9A%84.frm%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E8%A1%A8%E7%BB%93%E6%9E%84/"/>
      <url>/2018/11/01/mysql%E4%BD%BF%E7%94%A8%E5%A4%87%E4%BB%BD%E7%9A%84.frm%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E8%A1%A8%E7%BB%93%E6%9E%84/</url>
      <content type="html"><![CDATA[<h4 id="0、例如备份的表为test-order-则备份出来的-frm文件为test-order-frm"><a href="#0、例如备份的表为test-order-则备份出来的-frm文件为test-order-frm" class="headerlink" title="0、例如备份的表为test_order,则备份出来的.frm文件为test_order.frm"></a>0、例如备份的表为test_order,则备份出来的.frm文件为test_order.frm</h4><h4 id="1、在只知道表名的情况下，随意创建一个表名为test-order的表："><a href="#1、在只知道表名的情况下，随意创建一个表名为test-order的表：" class="headerlink" title="1、在只知道表名的情况下，随意创建一个表名为test_order的表："></a>1、在只知道表名的情况下，随意创建一个表名为test_order的表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table test_order (id1 int(2));</span><br></pre></td></tr></table></figure><p>替换test_order.frm文件，替换完成之后重启mysql数据库,查看表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:29:  [test]&gt; desc test_order;</span><br><span class="line">ERROR 1146 (42S02): Table &apos;test.test_order&apos; doesn&apos;t exist</span><br><span class="line">root@db 11:29:  [test]&gt; show create table test_order;</span><br><span class="line">ERROR 1146 (42S02): Table &apos;test.test_order&apos; doesn&apos;t exist</span><br></pre></td></tr></table></figure></p><p>报错提示表不存在，之后查看error.log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T11:29:10.359514Z 2 [Warning] InnoDB: Table test/test_order contains 1 user defined columns in InnoDB, but 25 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-11-01T11:29:10.359631Z 2 [Warning] InnoDB: Cannot open table test/test_order from the internal data dictionary of InnoDB though the .frm file for the table exists. Please refer to http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-11-01T11:29:25.514189Z 2 [Note] InnoDB: Table `test`.`test_order` is corrupted. Please drop the table and recreate it</span><br><span class="line">2018-11-01T11:29:25.514313Z 2 [Warning] InnoDB: Cannot open table test/test_order from the internal data dictionary of InnoDB though the .frm file for the table exists. Please refer to http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br></pre></td></tr></table></figure></p><p>报错提示手动创建的表只有1列，但是mysql中记录的表有25列</p><h4 id="2、删除test-order表，并创建一个25列的test-order表："><a href="#2、删除test-order表，并创建一个25列的test-order表：" class="headerlink" title="2、删除test_order表，并创建一个25列的test_order表："></a>2、删除test_order表，并创建一个25列的test_order表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:40:  [test]&gt; drop table test_order;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">root@db 11:40:  [test]&gt; create table test_order (id1 int(2),id2 int(2),id3 int(2),id4 int(2),id5 int(2),id6 int(2),id7 int(2),id8 int(2),id9 int(2),id10 int(2),id11 int(2),id12 int(2),id13 int(2),id14 int(2),id15 int(2),id16 int(2),id17 int(2),id18 int(2),id19 int(2),id20 int(2),id21 int(2),id22 int(2),id23 int(2),id24 int(2),id25  int(2));</span><br></pre></td></tr></table></figure><p>替换test_order.frm文件，替换完成之后重启mysql数据库,查看表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:41:  [test]&gt; desc test_order;</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">root@db 11:42:  [test]&gt; show create table test_order;</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    2</span><br><span class="line">Current database: test</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br></pre></td></tr></table></figure></p><p>查看error.log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T11:42:25.566095Z 2 [ERROR] Build InnoDB index translation table for Table ./test/test_order failed</span><br><span class="line">2018-11-01T11:42:25.566445Z 2 [ERROR] Table ./test/test_order has no primary key in InnoDB data dictionary, but has one in MySQL! If you created the table with a MySQL version &lt; 3.23.54 and did not define a primary key, but defined a unique key with all non-NULL columns, then MySQL internally treats that key as the primary key. You can fix this error by dump + DROP + CREATE + reimport of the table.</span><br><span class="line">2018-11-01T11:42:25.566519Z 2 [Warning] Table ./test/test_order key_used_on_scan is 0 even though there is no primary key inside InnoDB.</span><br><span class="line">2018-11-01T11:42:25.566576Z 2 [ERROR] InnoDB could not find key no 0 with name PRIMARY from dict cache for table test/test_order</span><br><span class="line">11:42:25 UTC - mysqld got signal 11 ;</span><br><span class="line">This could be because you hit a bug. It is also possible that this binary</span><br><span class="line">or one of the libraries it was linked against is corrupt, improperly built,</span><br><span class="line">or misconfigured. This error can also be caused by malfunctioning hardware.</span><br><span class="line">Attempting to collect some information that could help diagnose the problem.</span><br><span class="line">As this is a crash and something is definitely wrong, the information</span><br><span class="line">collection process might fail.</span><br></pre></td></tr></table></figure></p><p>报错提示test_order表没有主键</p><h4 id="3、删除test-order表，并创建一个25列的带有主键的test-order表："><a href="#3、删除test-order表，并创建一个25列的带有主键的test-order表：" class="headerlink" title="3、删除test_order表，并创建一个25列的带有主键的test_order表："></a>3、删除test_order表，并创建一个25列的带有主键的test_order表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:45:  [test]&gt; drop table test_order;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">root@db 11:45:  [test]&gt; create table test_order (id1 int(2) primary key,id2 int(2),id3 int(2),id4 int(2),id5 int(2),id6 int(2),id7 int(2),id8 int(2),id9 int(2),id10 int(2),id11 int(2),id12 int(2),id13 int(2),id14 int(2),id15 int(2),id16 int(2),id17 int(2),id18 int(2),id19 int(2),id20 int(2),id21 int(2),id22 int(2),id23 int(2),id24 int(2),id25  int(2));</span><br></pre></td></tr></table></figure><p>替换test_order.frm文件，替换完成之后重启mysql数据库,查看表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:46:  [test]&gt; desc test_order;</span><br><span class="line">+-----------------+----------------+------+-----+---------+----------------+</span><br><span class="line">| Field           | Type           | Null | Key | Default | Extra          |</span><br><span class="line">+-----------------+----------------+------+-----+---------+----------------+</span><br><span class="line">| id              | bigint(20)     | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| order_no        | varchar(24)    | NO   | UNI | NULL    |                |</span><br><span class="line">| broker_id       | varchar(24)    | NO   | MUL | NULL    |                |</span><br><span class="line">| broker_uid      | bigint(20)     | NO   |     | NULL    |                |</span><br><span class="line">| plat_id         | varchar(24)    | NO   |     | NULL    |                |</span><br><span class="line">| price_asset     | varchar(8)     | NO   |     | NULL    |                |</span><br><span class="line">| test_type      | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| order_type      | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| price           | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| number          | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| test_asset     | varchar(8)     | NO   | MUL | NULL    |                |</span><br><span class="line">| testd_number   | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| over_number     | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| testd_money    | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| fee_asset       | varchar(8)     | NO   |     | NULL    |                |</span><br><span class="line">| fee             | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| broker_fee      | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| cloud_fee       | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| client_order_no | varchar(36)    | NO   |     | NULL    |                |</span><br><span class="line">| state           | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| send_state      | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| error_code      | varchar(24)    | YES  |     | NULL    |                |</span><br><span class="line">| error_msg       | varchar(64)    | YES  |     | NULL    |                |</span><br><span class="line">| create_time     | datetime       | NO   |     | NULL    |                |</span><br><span class="line">| update_time     | datetime       | NO   |     | NULL    |                |</span><br><span class="line">+-----------------+----------------+------+-----+---------+----------------+</span><br><span class="line">25 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 11:46:  [test]&gt; show create table test_order\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: test_order</span><br><span class="line">Create Table: CREATE TABLE `test_order` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `order_no` varchar(24) NOT NULL,</span><br><span class="line">  `broker_id` varchar(24) NOT NULL,</span><br><span class="line">  `broker_uid` bigint(20) NOT NULL,</span><br><span class="line">  `plat_id` varchar(24) NOT NULL,</span><br><span class="line">  `price_asset` varchar(8) NOT NULL,</span><br><span class="line">  `test_type` varchar(16) NOT NULL,</span><br><span class="line">  `order_type` varchar(16) NOT NULL,</span><br><span class="line">  `price` decimal(32,20) NOT NULL,</span><br><span class="line">  `number` decimal(32,20) NOT NULL,</span><br><span class="line">  `test_asset` varchar(8) NOT NULL,</span><br><span class="line">  `testd_number` decimal(32,20) NOT NULL,</span><br><span class="line">  `over_number` decimal(32,20) NOT NULL,</span><br><span class="line">  `testd_money` decimal(32,20) NOT NULL,</span><br><span class="line">  `fee_asset` varchar(8) NOT NULL,</span><br><span class="line">  `fee` decimal(32,20) NOT NULL,</span><br><span class="line">  `broker_fee` decimal(32,20) NOT NULL,</span><br><span class="line">  `cloud_fee` decimal(32,20) NOT NULL,</span><br><span class="line">  `client_order_no` varchar(36) NOT NULL,</span><br><span class="line">  `state` varchar(16) NOT NULL,</span><br><span class="line">  `send_state` varchar(16) NOT NULL,</span><br><span class="line">  `error_code` varchar(24) DEFAULT NULL,</span><br><span class="line">  `error_msg` varchar(64) DEFAULT NULL,</span><br><span class="line">  `create_time` datetime NOT NULL,</span><br><span class="line">  `update_time` datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `test_order_order_no_uindex` (`order_no`),</span><br><span class="line">  UNIQUE KEY `test_order_broker_id_client_order_no_uindex` (`broker_id`,`client_order_no`),</span><br><span class="line">  KEY `multi_price_test_id_uid_state_index` (`test_asset`,`price_asset`,`broker_uid`,`broker_id`,`state`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>查看error.log有无其他报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T11:45:09.272752Z 2 [ERROR] Build InnoDB index translation table for Table ./test/test_order failed</span><br><span class="line">2018-11-01T11:45:09.272904Z 2 [ERROR] InnoDB: MySQL and InnoDB data dictionaries are out of sync. Unable to find the AUTOINC column id in the InnoDB table `test`.`test_order`. We set the next AUTOINC column value to 0, in effect disabling the AUTOINC next value generation.</span><br><span class="line">2018-11-01T11:45:09.272935Z 2 [Note] InnoDB: You can either set the next AUTOINC value explicitly using ALTER TABLE or fix the data dictionary by recreating the table.</span><br><span class="line">2018-11-01T11:45:09.272959Z 2 [ERROR] InnoDB: Table test/test_order contains 1 indexes inside InnoDB, which is different from the number of indexes 4 defined in MySQL</span><br><span class="line">2018-11-01T11:45:09.272976Z 2 [ERROR] InnoDB could not find key no 1 with name test_order_order_no_uindex from dict cache for table test/test_order</span><br><span class="line">2018-11-01T11:45:09.272988Z 2 [ERROR] Table test/test_order contains fewer indexes inside InnoDB than are defined in the MySQL .frm file. Have you mixed up .frm files from different installations? Please refer to http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br></pre></td></tr></table></figure></p><p>log日志依旧有报错，提示innodb只有一个索引，但mysql下存在4个索引，但是已经通过show create table test_order获取到了建表的语句，因此可以通过上面的建表语句，重新创建test_order表了。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] 使用certbot为域名生成免费证书(nginx版)</title>
      <link href="/2018/10/31/nginx%20https%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/10/31/nginx%20https%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h4 id="1、下载letencrypt-用于生产免费证书工具："><a href="#1、下载letencrypt-用于生产免费证书工具：" class="headerlink" title="1、下载letencrypt,用于生产免费证书工具："></a>1、下载letencrypt,用于生产免费证书工具：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft</span><br><span class="line">wget https://dl.eff.org/certbot-auto</span><br><span class="line">chmod a+x certbot-auto</span><br></pre></td></tr></table></figure><h4 id="2、修改域名对应的配置文件，添加下面内容"><a href="#2、修改域名对应的配置文件，添加下面内容" class="headerlink" title="2、修改域名对应的配置文件，添加下面内容"></a>2、修改域名对应的配置文件，添加下面内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  test.com;</span><br><span class="line">    ...</span><br><span class="line">    location ~ /.well-known &#123;</span><br><span class="line">        root /data/soft;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面配置的 root /data/soft<br>信息目录最好不要与其他location指定的目录相同,且确保各个目录存在目录,如果目录相同的情况下可能会遇到以下问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[quote]Failed authorization procedure. test.com (http-01): urn:ietf:params:acme:error:unauthorized :: The client lacks sufficient authorization :: Invalid response from http://mydomain.fr/.well-known/acme-challenge/Xefe-sxGfexdcdezDEUJZRfexjfeeloekcdsesx [2001:1600:4:1::b]: 404</span><br><span class="line">IMPORTANT NOTES:</span><br><span class="line">The following errors were reported by the server:</span><br><span class="line">Domain: test.com</span><br><span class="line">Type: unauthorized</span><br><span class="line">Detail: Invalid response from</span><br><span class="line">http://mydomain.fr/.well-known/acme-challenge/Xefe-sxGfexdcdezDEUJZRfexjfeeloekcdsesx</span><br><span class="line">[2001:1600:4:1::b]: 404</span><br><span class="line">To fix these errors, please make sure that your domain name was</span><br><span class="line">entered correctly and the DNS A/AAAA record(s) for that domain</span><br><span class="line">contain(s) the right IP address.[/quote]</span><br></pre></td></tr></table></figure></p><p>如果服务器的80端口被限制，会提示如下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://demo.broker.masterdax.com/.well-known/acme-challenge/pIV-Rh1355xsh8xJFHhB0llri6HS8S2yOSYRE9N5D5I:</span><br><span class="line">   Timeout during connect (likely firewall problem)</span><br></pre></td></tr></table></figure></p><h4 id="3、执行生成证书命令："><a href="#3、执行生成证书命令：" class="headerlink" title="3、执行生成证书命令："></a>3、执行生成证书命令：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/certbot-auto certonly --email 123456@qq.com --agree-tos --webroot -w /data/soft/ -d test.com --dry-run</span><br></pre></td></tr></table></figure><p>第一次尝试生成证书最好加上–dry-run参数，如果le生成证书次数（包括报错的次数）每天有上限，添加–dry-run调试没有问题之后再真正生成证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/certbot-auto certonly --email 123456@qq.com --agree-tos --webroot -w /data/soft/ -d test.com</span><br></pre></td></tr></table></figure></p><h4 id="4、查看生成的证书"><a href="#4、查看生成的证书" class="headerlink" title="4、查看生成的证书"></a>4、查看生成的证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/certbot-auto certificates</span><br></pre></td></tr></table></figure><h4 id="5、修改nginx配置文件，添加https相关配置信息-http相关配置加上跳转到https："><a href="#5、修改nginx配置文件，添加https相关配置信息-http相关配置加上跳转到https：" class="headerlink" title="5、修改nginx配置文件，添加https相关配置信息,http相关配置加上跳转到https："></a>5、修改nginx配置文件，添加https相关配置信息,http相关配置加上跳转到https：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  test.com;</span><br><span class="line">    rewrite ^(.*)$  https://$server_name$1 permanent;</span><br><span class="line">    ...</span><br><span class="line">    location ~ /.well-known &#123;</span><br><span class="line">        root /data/soft;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl; </span><br><span class="line">    server_name test.com;</span><br><span class="line">    ....</span><br><span class="line">    ssl_certificate ssl/fullchain.pem;</span><br><span class="line">    ssl_certificate_key ssl/privkey.pem;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、将生成的证书添加软连接到nginx配置文件指定的路径："><a href="#6、将生成的证书添加软连接到nginx配置文件指定的路径：" class="headerlink" title="6、将生成的证书添加软连接到nginx配置文件指定的路径："></a>6、将生成的证书添加软连接到nginx配置文件指定的路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/letsencrypt/live/test.com/fullchain.pem /usr/local/openresty/nginx/conf/ssl/fullchain.pem</span><br><span class="line">ln -s /etc/letsencrypt/live/test.com/privkey.pem /usr/local/openresty/nginx/conf/ssl/privkey.pem</span><br></pre></td></tr></table></figure><h4 id="7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新："><a href="#7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新：" class="headerlink" title="7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新："></a>7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新：</h4><p>cat /data/soft/cron-cerbot.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">/data/soft/certbot-auto renew</span><br></pre></td></tr></table></figure></p><p>授权文件执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /data/soft/cron-cerbot.sh</span><br></pre></td></tr></table></figure></p><p>添加到crontab,每周日凌晨定期更新<br>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * 0 /data/soft/cron-cerbot.sh</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] oracle 静默安装</title>
      <link href="/2018/10/31/oracle%20%E9%9D%99%E9%BB%98%E5%AE%89%E8%A3%85/"/>
      <url>/2018/10/31/oracle%20%E9%9D%99%E9%BB%98%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<h4 id="1、安装数据库所需依赖包"><a href="#1、安装数据库所需依赖包" class="headerlink" title="1、安装数据库所需依赖包"></a>1、安装数据库所需依赖包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc*</span><br><span class="line">yum install -y glibc*</span><br><span class="line">yum install -y compat-libstdc++-33 elfutils-libelf-devel libaio-devel compat-libcap1</span><br><span class="line">yum install -y sysstat</span><br><span class="line">yum install -y smartmontools</span><br></pre></td></tr></table></figure><h4 id="2、创建用户-并修改用户名密码"><a href="#2、创建用户-并修改用户名密码" class="headerlink" title="2、创建用户,并修改用户名密码"></a>2、创建用户,并修改用户名密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/groupadd -g 505 oinstall</span><br><span class="line">/usr/sbin/groupadd -g 502 dba</span><br><span class="line">/usr/sbin/groupadd -g 503 oper</span><br><span class="line">/usr/sbin/useradd -u 506 -g oinstall -G dba,oper oracle</span><br></pre></td></tr></table></figure><p>配置用户名密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd oracle</span><br></pre></td></tr></table></figure></p><h4 id="3、配置相关数据库目录权限"><a href="#3、配置相关数据库目录权限" class="headerlink" title="3、配置相关数据库目录权限"></a>3、配置相关数据库目录权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/u01/app/oracle</span><br><span class="line">chown oracle.oinstall -R /data/u01/app/oracle</span><br><span class="line">chmod 775 /data/u01/app/oracle</span><br><span class="line">mkdir -p /data/u01/app/oracle/product/11.2.0.4/dbhome_1/</span><br><span class="line">chown oracle.oinstall -R /data/u01/app/oracle/product/11.2.0.4/dbhome_1/</span><br><span class="line">chmod 775 /data/u01/app/oracle/product/11.2.0.4/dbhome_1/</span><br><span class="line">chown oracle.oinstall -R /data/u01</span><br></pre></td></tr></table></figure><h4 id="4、修改系统参数："><a href="#4、修改系统参数：" class="headerlink" title="4、修改系统参数："></a>4、修改系统参数：</h4><p>4.1、关闭selinux<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure></p><p>4.2、关闭防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure></p><p>4.3、设置用户连接限制<br>cat /etc/security/limits.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">oracle soft nproc 16384</span><br><span class="line">oracle hard nproc 16384</span><br><span class="line">oracle soft nofile 65536</span><br><span class="line">oracle hard nofile 65536</span><br><span class="line">oracle soft memlock 8088608</span><br><span class="line">oracle hard memlock 8088608</span><br><span class="line">oracle hard stack 10240</span><br><span class="line">grid soft nproc 16384</span><br><span class="line">grid hard nproc 16384</span><br><span class="line">grid soft nofile 65536</span><br><span class="line">grid hard nofile 65536</span><br><span class="line">grid soft memlock 8088608</span><br><span class="line">grid hard memlock 8088608</span><br><span class="line">grid hard stack 10240</span><br></pre></td></tr></table></figure></p><p>oracle用户最大能开启的进程数不超过16384，最大能打开的文件数不超过65536。至于soft和hard的区别，不同于磁盘配额中的软限制和硬限制。普通用户可以调整自己的softlimit但最高不能超过hardlimit，而且除了root以外的普通用户也不能够随意更改hard limit。该调整完成之后一般可以使用ulimit命令查看。<br>针对nofile，这个只是基于用户层面的限制和调整方法。基于系统层面的限制和调整方法是修改/etc/sysctl.conf文件，直接改fs.file-max参数，调整之后sysctl –p生效<br>memlock参数随着服务器内存不同，进行调整，该参数要偏小于实际的物理内存，本文以（8g内存为例）</p><p>4.4、为使/etc/security/limits.conf文件配置生效，需要确保pam模块pam_limits.so被加入到启动文件中：<br>grep ‘pam_limits.so’ /etc/pam.d/login<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session    required     pam_limits.so</span><br></pre></td></tr></table></figure></p><p>pam_limits.so模块对用户使用系统资源的情况进行限制,也可以使用在对一般应用程序使用的资源限制方面。举例来说，如果需要在SSH服务器上对来自不同用户的ssh访问进行限制，就可以调用该模块来实现相关功能。例如，当需要限制用户admin登录到SSH服务器时的最大连接数（防止同一个用户开启过多的登录进程），就可以在/etc/pam.d/sshd 文件中增加一行对 pam_limits.so 模块的调用:<br>然后在/etc/security/limits.conf文件中增加一行对admin用户产生的连接数进行限定:<br>admin      hard        maxlogins       2<br>完成之后重启服务器端的sshd服务。<br>之后我们可以看到，从客户端以admin身份登录SSH服务器时，在客户端上可以打开两个控制台登录。但当客户端开启第三个登录窗口的时候会被服务器拒绝，但其它用户不会受到限制。</p><p>4.5、设置用户最大进程数和进程可以打开的最大文件描述符的数量：<br>cat /etc/profile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if [ $USER = &quot;oracle&quot; -o $USER = &quot;grid&quot; ]; then</span><br><span class="line">  if [ $SHELL = &quot;/bin/ksh&quot; ]; then</span><br><span class="line">    ulimit -p 16384</span><br><span class="line">    ulimit -n 65536</span><br><span class="line">  else</span><br><span class="line">    ulimit -u 16384 -n 65536</span><br><span class="line">  fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p><p>4.6、设置内核参数<br>cat /etc/sysctl.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kernel.shmmax = 7730941132</span><br><span class="line">kernel.shmall = 15586574</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.sem = 250 32000 100 128</span><br><span class="line">fs.file-max = 6815744</span><br><span class="line">fs.aio-max-nr = 1048576</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500</span><br><span class="line">net.core.rmem_default = 1048576</span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line">net.core.wmem_max = 1048576</span><br><span class="line">vm.min_free_kbytes = 524288</span><br><span class="line">vm.swappiness = 60</span><br></pre></td></tr></table></figure></p><p>使配置生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p><p>安装过程中shmmax,shmall参数设置过小，导致dbca创建数据库的时候报错ORA-12547：TNS：lost contact<br>图形化安装，oracle有一个runfix脚本，调整这些参数，参考response下的文件，如果文件里面的参数小于参考文件的参数，会进行调整，如果文件参数大于参考文件参数，则不会进行调整。</p><p>SHMMAX应该比SGA区大,否则会引发性能的下降,shmmax 指的是单个共享内存段的最大尺寸， 设置shmmax=1G，sga分配了1.2G，当启动实例的时候就分配 2 块共享内存给Oracle</p><p>kernel.shmall=（SHMMAX/PAGE_SIZE）：共享内存总量，以页为单位。Linux 共享内存页大小为4KB, 共享内<br>存段的大小都是共享内存页大小的整数倍。一个共享内存段的最大大小是16G，那么需<br>要共享内存页数是 16GB/4KB=16777216KB/4KB=4194304 （页），也就是64Bit 系统下<br>16GB 物理内存，设置 kernel.shmall = 4194304 才符合要求</p><p>SHMMIN= 最小的内存段的大小 </p><p>kernel.shmmni：共享内存段的最大数量，shmmni 缺省值 4096 ，一般肯定是够用了</p><p>kernel.sem(SEMMSL SEMMNS SEMOPM SEMMNI)：<br>SEMMSL，每个信号量集中的最大信号量数，应该设置为服务器中各个实例中PROCESSES参数的和+10；SEMMNS，系统中信号量的最大数，参数应设置为SEMMSL*SEMMNI。<br>SEMOPM，每个信号量调用所包含的最大操作数。<br>SEMMNI：系统中信号量集的最大数。<br>swappiness的值的大小对如何使用swap分区是有着很大的联系的。swappiness=0的时候表示最大限度使用物理内存，然后才是 swap空间，swappiness＝100的时候表示积极的使用swap分区，并且把内存上的数据及时的搬运到swap空间里面。linux的基本默认设置为60</p><h5 id="5、修改oracle用户环境变量"><a href="#5、修改oracle用户环境变量" class="headerlink" title="5、修改oracle用户环境变量"></a>5、修改oracle用户环境变量</h5><p>su - oracle<br>vim ~/.bash_profile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># .bash_profile</span><br><span class="line"># Get the aliases and functions</span><br><span class="line">if [ -f ~/.bashrc ]; then</span><br><span class="line">        . ~/.bashrc</span><br><span class="line">fi</span><br><span class="line"># User specific environment and startup programs</span><br><span class="line">PATH=$PATH:$HOME/bin</span><br><span class="line">export PATH</span><br><span class="line">export THREADS_FLAG=native</span><br><span class="line">export ORACLE_BASE=/data/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0.4/dbhome_1</span><br><span class="line">export PATH=$ORACLE_HOME/bin:$ORACLE_HOME/OPatch:$PATH:/usr/sbin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib</span><br><span class="line">export ORACLE_SID=boston</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line">export NLS_DATE_FORMAT=&quot;YYYY:MM:DD HH24:MI:SS&quot;</span><br><span class="line">export EDITOR=vi</span><br><span class="line">set -o vi</span><br><span class="line">umask 022</span><br><span class="line">alias bdump=&quot;cd $ORACLE_BASE/diag/rdbms/otcdb/$&#123;ORACLE_SID&#125;/trace&quot;</span><br><span class="line">alias sql=&apos;sqlplus &quot;/ as sysdba&quot;&apos;</span><br></pre></td></tr></table></figure></p><p>使环境变量生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure></p><h4 id="6、解压软件包，在database-response目录下找到db-install-rsp文件"><a href="#6、解压软件包，在database-response目录下找到db-install-rsp文件" class="headerlink" title="6、解压软件包，在database/response目录下找到db_install.rsp文件"></a>6、解压软件包，在database/response目录下找到db_install.rsp文件</h4><p>编辑db_install.rsp文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#选择安装类型：1.INSTALL_DB_SWONLY只装数据库软件 2.INSTALL_DB_AND_CONFIG安装数据库软件并建库 3.UPGRADE_DB升级数据库</span><br><span class="line">oracle.install.option=INSTALL_DB_SWONLY</span><br><span class="line">#指定操作系统主机名，通过hostname命令获得</span><br><span class="line">ORACLE_HOSTNAME=dax-mysql-slave</span><br><span class="line">#指定oracle inventory目录的所有者，通常会是oinstall或者dba</span><br><span class="line">UNIX_GROUP_NAME=oinstall</span><br><span class="line">#指定产品清单oracle inventory目录的路径,如果是Win平台下可以省略</span><br><span class="line">INVENTORY_LOCATION=/data/u01/app/oracle/oraInventory</span><br><span class="line">#指定数据库语言，可以选择多个，用逗号隔开。选择en, zh_CN(英文和简体中文)</span><br><span class="line">SELECTED_LANGUAGES=en,zh_CN</span><br><span class="line"># Specify the complete path of the OracleHome.设置ORALCE_HOME的路径</span><br><span class="line">ORACLE_HOME=/data/u01/app/oracle/product/11.2.0.4/dbhome_1</span><br><span class="line"># Specify the complete path of the OracleBase. 设置ORALCE_BASE的路径</span><br><span class="line">ORACLE_BASE=/data/u01/app/oracle</span><br><span class="line">#选择Oracle安装数据库软件的版本（企业版，标准版，标准版1），不同的版本功能不同</span><br><span class="line">oracle.install.db.InstallEdition=EE</span><br><span class="line">#是否自定义Oracle的组件，如果选择false，则会使用默认的组件</span><br><span class="line">#如果选择true否则需要自己在下面一条参数将要安装的组件一一列出。</span><br><span class="line">#安装相应版权后会安装所有的组件，后期如果缺乏某个组件，再次安装会非常的麻烦。</span><br><span class="line">oracle.install.db.EEOptionsSelection=false</span><br><span class="line"># oracle.install.db.EEOptionsSelection=true的话下面的安装组件会安装</span><br><span class="line">oracle.install.db.optionalComponents=oracle.rdbms.partitioning:11.2.0.4.0,oracle.oraolap:11.2.0.4.0,oracle.rdbms.dm:11.2.0.4.0,oracle.rdbms.dv:11.2.0.4.0,oracle.rdbms.lbac:11.2.0.4.0,oracle.rdbms.rat:11.2.0.4.0</span><br><span class="line">#指定拥有OSDBA、OSOPER权限的用户组，通常会是dba组</span><br><span class="line">oracle.install.db.DBA_GROUP=dba</span><br><span class="line">oracle.install.db.OPER_GROUP=oinstall</span><br><span class="line">#如果是RAC的安装，在这里指定所有的节点</span><br><span class="line">oracle.install.db.CLUSTER_NODES=</span><br><span class="line">oracle.install.db.isRACOneInstall=</span><br><span class="line">oracle.install.db.isRACOneInstall=</span><br><span class="line">--------安装数据库选项</span><br><span class="line">#选择数据库的用途，一般用途/事物处理，数据仓库</span><br><span class="line">oracle.install.db.config.starterdb.type=GENERAL_PURPOSE</span><br><span class="line"># Specify the Starter Database GlobalDatabase Name. 指定GlobalName</span><br><span class="line">oracle.install.db.config.starterdb.globalDBName=boston</span><br><span class="line"># Specify the Starter Database SID.指定SID</span><br><span class="line">oracle.install.db.config.starterdb.SID=boston</span><br><span class="line">#选择字符集。不正确的字符集会给数据显示和存储带来麻烦无数。</span><br><span class="line">#通常中文选择的有ZHS16GBK简体中文库，建议选择unicode的AL32UTF8国际字符集</span><br><span class="line">oracle.install.db.config.starterdb.characterSet=AL32UTF8</span><br><span class="line">#11g的新特性自动内存管理，也就是SGA_TARGET和PAG_AGGREGATE_TARGET都#不用设置了，Oracle会自动调配两部分大小。</span><br><span class="line">oracle.install.db.config.starterdb.memoryOption=true</span><br><span class="line">#指定Oracle自动管理内存的大小，最小是256MB</span><br><span class="line">oracle.install.db.config.starterdb.memoryLimit=5120</span><br><span class="line">#是否载入模板示例</span><br><span class="line">oracle.install.db.config.starterdb.installExampleSchemas=false</span><br><span class="line"># These settings may also be disabled.   是否启用安全设置</span><br><span class="line">oracle.install.db.config.starterdb.enableSecuritySettings=true</span><br><span class="line">#设置数据库用户密码</span><br><span class="line">oracle.install.db.config.starterdb.password.ALL=oracle</span><br><span class="line">#数据库本地管理工具DB_CONTROL，远程集中管理工具GRID_CONTROL</span><br><span class="line">oracle.install.db.config.starterdb.control=DB_CONTROL</span><br><span class="line">#.设置自动备份，和OUI里的自动备份一样。</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.enable=false</span><br><span class="line">#自动备份会启动一个job，指定启动JOB的系统用户ID</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.osuid=</span><br><span class="line">#自动备份会开启一个job，需要指定OSUser的密码</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.ospwd=</span><br><span class="line">#自动备份，要求指定使用的文件系统存放数据库文件还是ASM</span><br><span class="line">oracle.install.db.config.starterdb.storageType=</span><br><span class="line">#使用文件系统存放数据库文件才需要指定数据文件、控制文件、Redo log的存放目录</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.dataLocation=</span><br><span class="line">#使用文件系统存放数据库文件才需要指定备份恢复目录</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.recoveryLocation=</span><br><span class="line">#使用ASM存放数据库文件才需要指定存放的磁盘组</span><br><span class="line">oracle.install.db.config.asm.diskGroup=</span><br><span class="line">#使用ASM存放数据库文件才需要指定ASM实例密码</span><br><span class="line">oracle.install.db.config.asm.ASMSNMPPassword=</span><br><span class="line">#指定metalink账户用户名</span><br><span class="line">MYORACLESUPPORT_USERNAME=</span><br><span class="line"># 指定metalink账户密码</span><br><span class="line">MYORACLESUPPORT_PASSWORD=</span><br><span class="line"># 用户是否可以设置metalink密码</span><br><span class="line">SECURITY_UPDATES_VIA_MYORACLESUPPORT=</span><br><span class="line"># False表示不需要设置安全更新，注意，在11.2的静默安装中疑似有一个BUG</span><br><span class="line">******# Response File中必须指定为true，否则会提示错误,不管是否正确填写了邮件地址</span><br><span class="line">DECLINE_SECURITY_UPDATES=true</span><br><span class="line">#代理服务器名</span><br><span class="line">PROXY_HOST=</span><br><span class="line">#代理服务器端口</span><br><span class="line">PROXY_PORT=</span><br><span class="line">#代理服务器用户名</span><br><span class="line">PROXY_USER=</span><br><span class="line">#代理服务器密码</span><br><span class="line">PROXY_PWD=</span><br></pre></td></tr></table></figure></p><p>开始安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./runInstaller -silent -responseFile /data/soft/database/response/db_install.rsp</span><br></pre></td></tr></table></figure></p><p>如果是测试环境可能碰到下面的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Checking swap space: 0 MB available, 150 MB required.    Failed &lt;&lt;&lt;&lt;</span><br><span class="line">解决方法：</span><br><span class="line">dd if=/dev/zero of=/data/swapfile bs=1M count=1024</span><br><span class="line">mkswap /data/swapfile</span><br><span class="line">swapon /data/swapfile</span><br><span class="line"></span><br><span class="line">在/etc/fstab添加下面内容</span><br><span class="line">/data/swapfile swap swap defaults 0 0</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p><p>oracle安装到最后提示，使用root用户执行以下两个脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/u01/app/oracle/oraInventory/orainstRoot.sh</span><br><span class="line">/data/u01/app/oracle/product/11.2.0.4/dbhome_1/root.sh</span><br></pre></td></tr></table></figure></p><h4 id="7、静默配置监听"><a href="#7、静默配置监听" class="headerlink" title="7、静默配置监听"></a>7、静默配置监听</h4><p>通过response文件运行netca, 生成sqlnet.ora和listener.ora文件, 位于$ORACLE_HOME/network/admin目录下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># su - oracle</span><br><span class="line">$ORACLE_HOME/bin/netca -silent -responsefile /data/soft/database/response/netca.rsp</span><br><span class="line">ll $ORACLE_HOME/network/admin/*.ora</span><br><span class="line">lsnrctl status</span><br></pre></td></tr></table></figure></p><h4 id="8、创建数据库"><a href="#8、创建数据库" class="headerlink" title="8、创建数据库"></a>8、创建数据库</h4><p>修改配置文件dbca.rsp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[GENERAL]</span><br><span class="line">RESPONSEFILE_VERSION = &quot;11.2.0&quot;</span><br><span class="line">OPERATION_TYPE = &quot;createDatabase&quot;</span><br><span class="line">[CREATEDATABASE]</span><br><span class="line">GDBNAME = &quot;boston.us.oracle.com&quot;</span><br><span class="line">TEMPLATENAME = &quot;General_Purpose.dbc&quot;</span><br><span class="line">SID = &quot;boston&quot;</span><br><span class="line">SYSPASSWORD = &quot;oracle&quot;</span><br><span class="line">SYSTEMPASSWORD = &quot;oracle&quot;</span><br><span class="line">SYSMANPASSWORD = &quot;oracle&quot;</span><br><span class="line">DBSNMPPASSWORD = &quot;oracle&quot;</span><br><span class="line">CHARACTERSET = &quot;ZHS16GBK&quot;</span><br><span class="line">TOTALMEMORY = &quot;2048&quot;</span><br></pre></td></tr></table></figure></p><p>运行命令开始创建数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbca -silent -createDatabase -responseFile /data/soft/database/response/createdbca.rsp</span><br></pre></td></tr></table></figure></p><p>如果不适用配置文件，也可使用下面命令直接指定参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">##dbca -silent -createDatabase -templateName $ORACLE_HOME/assistants/dbca/templates/General_Purpose.dbc -gdbName orcogg -sid orcogg  -sysPassword oracle -systemPassword oracle -datafileDestination /u01/app/oradata/orcogg -characterSet GBK16 -TOTALMEMORY 2048</span><br></pre></td></tr></table></figure></p><p>各参数含义如下:<br>-silent 表示以静默方式安装<br>-responseFile 表示使用哪个响应文件,必需使用绝对路径<br>RESPONSEFILE_VERSION 响应文件模板的版本,该参数不要更改<br>OPERATION_TYPE 安装类型,该参数不要更改<br>GDBNAME 全局数据库名,点号前面默认是db_name,点号后面默认就是db_domain<br>TEMPLATENAME 建库模板名,参考各模板定义:$ORACLE_HOME/assistants/dbca/templates/*.dbc<br>CHARACTERSET 字符集,默认是WE8MSWIN1252<br>TOTALMEMORY 实例内存,默认是服务器物理内存的40%</p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 测试mysql where条件执行顺序对sql查询效率的影响</title>
      <link href="/2018/10/30/%E6%B5%8B%E8%AF%95mysql%20where%E6%9D%A1%E4%BB%B6%E9%A1%BA%E5%BA%8F%E5%AF%B9sql%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D/"/>
      <url>/2018/10/30/%E6%B5%8B%E8%AF%95mysql%20where%E6%9D%A1%E4%BB%B6%E9%A1%BA%E5%BA%8F%E5%AF%B9sql%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D/</url>
      <content type="html"><![CDATA[<h4 id="1、创建基表测试数据"><a href="#1、创建基表测试数据" class="headerlink" title="1、创建基表测试数据"></a>1、创建基表测试数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into test1(name,age) values(&apos;lucy&apos;,10),(&apos;bobo&apos;,18),(&apos;david&apos;,20),(&apos;tom&apos;,21),(&apos;dobu&apos;,22),(&apos;dali&apos;,12);</span><br></pre></td></tr></table></figure><h4 id="2、创建中间表"><a href="#2、创建中间表" class="headerlink" title="2、创建中间表"></a>2、创建中间表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> CREATE TABLE `testfororder` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=14699990 DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure><p>创建存储过程对中间表插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists test;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure test()</span><br><span class="line"> begin</span><br><span class="line">  declare i int;</span><br><span class="line">  set i=0;</span><br><span class="line">  while i&lt;300000 do</span><br><span class="line">   insert into testfororder(newid,name,age) select concat(i,name),FLOOR(18 + (RAND() * 12)) from test1;</span><br><span class="line">   set i=i+1;</span><br><span class="line">  end while;</span><br><span class="line"> end//</span><br><span class="line"> delimiter ;</span><br><span class="line">调用存储过程：</span><br><span class="line">call test();</span><br></pre></td></tr></table></figure></p><h4 id="3、创建测试表："><a href="#3、创建测试表：" class="headerlink" title="3、创建测试表："></a>3、创建测试表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `sequence` (</span><br><span class="line">  `id` int(10) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `newid` int(10) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=89179437 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into sequence(newid,name,age) select * from testfororder;</span><br></pre></td></tr></table></figure><p>数据量根据自己需求可以多次导入</p><h4 id="4、查看sequence测试表数据："><a href="#4、查看sequence测试表数据：" class="headerlink" title="4、查看sequence测试表数据："></a>4、查看sequence测试表数据：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">| 12600000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (2.83 sec)</span><br></pre></td></tr></table></figure><p>age条件筛选数据量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence where age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  7341992 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (3.82 sec)</span><br></pre></td></tr></table></figure></p><p>newid条件筛选数量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence where newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       56 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (3.28 sec)</span><br></pre></td></tr></table></figure></p><h4 id="5、where条件-age-newid-在没有创建索引的情况下："><a href="#5、where条件-age-newid-在没有创建索引的情况下：" class="headerlink" title="5、where条件(age,newid)在没有创建索引的情况下："></a>5、where条件(age,newid)在没有创建索引的情况下：</h4><p>age在前，newid在后，查看执行计划：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 12292293 |    25.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (5.36 sec)</span><br></pre></td></tr></table></figure></p><p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 12292293 |    25.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (4.47 sec)</span><br></pre></td></tr></table></figure></p><p>没有任何索引的情况下，where后面跟的条件从左到右，返回数据越小的条件在前面，效率会优于返回数据较大的条件在前面。</p><h4 id="6、where条件-age-在没有创建索引，newid创建索引的情况下："><a href="#6、where条件-age-在没有创建索引，newid创建索引的情况下：" class="headerlink" title="6、where条件(age)在没有创建索引，newid创建索引的情况下："></a>6、where条件(age)在没有创建索引，newid创建索引的情况下：</h4><p>创建newid的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index newid_ind on sequence(newid);</span><br></pre></td></tr></table></figure></p><p>age在前，newid在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key       | key_len | ref  | rows | filtered | Extra                              |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_ind     | newid_ind | 4       | NULL |   56 |    50.00 | Using index condition; Using where |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key       | key_len | ref  | rows | filtered | Extra                              |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_ind     | newid_ind | 4       | NULL |   56 |    50.00 | Using index condition; Using where |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>在newid创建索引的情况下，where后面的查询条件前后顺序对查询效率影响不大。</p><h4 id="7、where条件-newid-在没有创建索引，age创建索引的情况下："><a href="#7、where条件-newid-在没有创建索引，age创建索引的情况下：" class="headerlink" title="7、where条件(newid)在没有创建索引，age创建索引的情况下："></a>7、where条件(newid)在没有创建索引，age创建索引的情况下：</h4><p>删除newid的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop index newid_ind on sequence;</span><br></pre></td></tr></table></figure></p><p>创建age的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index age_ind on sequence(age);</span><br></pre></td></tr></table></figure></p><p>age在前，newid在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | age_ind       | NULL | NULL    | NULL | 12292293 |    50.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (4.97 sec)</span><br></pre></td></tr></table></figure></p><p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | age_ind       | NULL | NULL    | NULL | 12292293 |    50.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (4.82 sec)</span><br></pre></td></tr></table></figure></p><p>创建age索引之后，执行计划会默认使用索引执行，但是因为age的筛选出来的数据量比较大，使用索引也不是特别理想。</p><h4 id="8、where条件-newid-age-创建联合索引的情况下："><a href="#8、where条件-newid-age-创建联合索引的情况下：" class="headerlink" title="8、where条件(newid,age)创建联合索引的情况下："></a>8、where条件(newid,age)创建联合索引的情况下：</h4><p>删除age索引，创建newid，age的联合索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drop index age_ind on sequence;</span><br><span class="line">create index newid_age_ind on sequence(newid,age);</span><br></pre></td></tr></table></figure></p><p>age在前，newid在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_age_ind | newid_age_ind | 9       | NULL |   98 |   100.00 | Using index condition |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line"></span><br><span class="line"> select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_age_ind | newid_age_ind | 9       | NULL |   98 |   100.00 | Using index condition |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>联合索引存在的情况下，where后面的查询条件前后顺序对查询效率影响不大，但是创建了联合索引之后要注意查询条件问题，如果是以（newid，age）的顺序创建的联合索引，如果where查询条件后面有newid会使用联合索引，但是如果where查询条件后面之后age则不会引用联合索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_age_ind | newid_age_ind | 4       | NULL |   56 |   100.00 | Using index condition |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 12292293 |    50.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 测试mysql or和in对sql查询效率的影响</title>
      <link href="/2018/10/30/%E6%B5%8B%E8%AF%95mysql%20or%E5%92%8Cin%E5%AF%B9sql%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D/"/>
      <url>/2018/10/30/%E6%B5%8B%E8%AF%95mysql%20or%E5%92%8Cin%E5%AF%B9sql%E6%9F%A5%E8%AF%A2%E6%95%88%E7%8E%87%E7%9A%84%E5%BD%B1%E5%93%8D/</url>
      <content type="html"><![CDATA[<h4 id="1、创建基表测试数据"><a href="#1、创建基表测试数据" class="headerlink" title="1、创建基表测试数据"></a>1、创建基表测试数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into test1(name,age) values(&apos;lucy&apos;,10),(&apos;bobo&apos;,18),(&apos;david&apos;,20),(&apos;tom&apos;,21),(&apos;dobu&apos;,22),(&apos;dali&apos;,12);</span><br></pre></td></tr></table></figure><h4 id="2、创建中间表"><a href="#2、创建中间表" class="headerlink" title="2、创建中间表"></a>2、创建中间表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> CREATE TABLE `testfororder` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=14699990 DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure><p>创建存储过程对中间表插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists test;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure test()</span><br><span class="line"> begin</span><br><span class="line">  declare i int;</span><br><span class="line">  set i=0;</span><br><span class="line">  while i&lt;300000 do</span><br><span class="line">   insert into testfororder(newid,name,age) select concat(i,name),FLOOR(18 + (RAND() * 12)) from test1;</span><br><span class="line">   set i=i+1;</span><br><span class="line">  end while;</span><br><span class="line"> end//</span><br><span class="line"> delimiter ;</span><br><span class="line">调用存储过程：</span><br><span class="line">call test();</span><br></pre></td></tr></table></figure></p><h4 id="3、创建测试表："><a href="#3、创建测试表：" class="headerlink" title="3、创建测试表："></a>3、创建测试表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `sequence` (</span><br><span class="line">  `id` int(10) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `newid` int(10) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=89179437 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into sequence(newid,name,age) select * from testfororder;</span><br></pre></td></tr></table></figure><p>数据量根据自己需求可以多次导入</p><h4 id="4、查看sequence测试表数据："><a href="#4、查看sequence测试表数据：" class="headerlink" title="4、查看sequence测试表数据："></a>4、查看sequence测试表数据：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">| 12600000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (2.83 sec)</span><br></pre></td></tr></table></figure><h4 id="5、在newid没有索引的情况下，in和or的对比："><a href="#5、在newid没有索引的情况下，in和or的对比：" class="headerlink" title="5、在newid没有索引的情况下，in和or的对比："></a>5、在newid没有索引的情况下，in和or的对比：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">repl@db 16:14:  [aaaa]&gt; select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (4.47 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid =116670 or newid = 116677 or newid = 116684 or newid =116691 or newid = 116698 or newid=116705 or newid=116719 or newid=116726;</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (6.77 sec)</span><br></pre></td></tr></table></figure><p>没有索引的情况下使用in查询效率高于or</p><h4 id="6、创建newid索引，再次进行测试："><a href="#6、创建newid索引，再次进行测试：" class="headerlink" title="6、创建newid索引，再次进行测试："></a>6、创建newid索引，再次进行测试：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> create index newid_ind on sequence(newid);</span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid =116670 or newid = 116677 or newid = 116684 or newid =116691 or newid = 116698 or newid=116705 or newid=116719 or newid=116726;</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>在newid存在索引的情况下，使用or和in查询对sql查询效率影响较小。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] Old incarnation found while trying to add node</title>
      <link href="/2018/10/28/Old%20incarnation%20found%20while%20trying%20to%20add%20node/"/>
      <url>/2018/10/28/Old%20incarnation%20found%20while%20trying%20to%20add%20node/</url>
      <content type="html"><![CDATA[<h4 id="0、集群环境介绍"><a href="#0、集群环境介绍" class="headerlink" title="0、集群环境介绍"></a>0、集群环境介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql-mgr单主集群：</span><br><span class="line">mw-mysql-1：primary（节点1）</span><br><span class="line">mw-mysql-2：second （节点2）</span><br><span class="line">mw-mysql-3：second （节点3）</span><br></pre></td></tr></table></figure><h4 id="1、收到zabbix报警mysql-mgr集群有一个节点down，查看节点信息，内容如下"><a href="#1、收到zabbix报警mysql-mgr集群有一个节点down，查看节点信息，内容如下" class="headerlink" title="1、收到zabbix报警mysql-mgr集群有一个节点down，查看节点信息，内容如下"></a>1、收到zabbix报警mysql-mgr集群有一个节点down，查看节点信息，内容如下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 77039511-8e42-11e8-b6d4-000d3aa1a189 | mw-mysql-1  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 81143c99-8e3d-11e8-a501-000d3aa1b575 | mw-mysql-2  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 8bab920f-8e3d-11e8-a045-000d3aa09b70 | mw-mysql-3  |        3306 | UNREACHABLE  |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br></pre></td></tr></table></figure><p>因为还有两个节点节点存活，表示集群还是可用的。（后面才发现只依靠这个信息是错误的）</p><h4 id="2、节点3集群状态变为不可达，查看节点3的日志："><a href="#2、节点3集群状态变为不可达，查看节点3的日志：" class="headerlink" title="2、节点3集群状态变为不可达，查看节点3的日志："></a>2、节点3集群状态变为不可达，查看节点3的日志：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> waited (count) when Workers occupied = 590 waited when Workers occupied = 11412795300</span><br><span class="line">2018-10-27T06:56:10.116159Z 0 [Warning] Plugin group_replication reported: &apos;The member with address mw-mysql-2:3306 has already sent the stable set. Therefore discarding the second message.&apos;</span><br><span class="line">xdr_bytes: out of memory</span><br><span class="line">xdr_bytes: out of memory</span><br><span class="line">xdr_bytes: out of memory</span><br><span class="line">2018-10-27T06:58:03.284079Z 0 [Note] Plugin group_replication reported: &apos;dispatch_op /export/home/pb2/build/sb_0-27500212-1520171728.22/mysql-5.7.22/rapid/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/xcom_base.c:3810 die_op executed_msg=&#123;53f6a873 47559528 0&#125; delivered_msg=&#123;53f6a873 47559528 0&#125; p-&gt;synode=&#123;53f6a873 47559501 0&#125; p-&gt;delivered_msg=&#123;53f6a873 47559525 0&#125; p-&gt;max_synode=&#123;53f6a873 47559528 1&#125; &apos;</span><br><span class="line">2018-10-27T06:58:03.285626Z 0 [Note] Plugin group_replication reported: &apos;dispatch_op /export/home/pb2/build/sb_0-27500212-1520171728.22/mysql-5.7.22/rapid/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/xcom_base.c:3810 die_op executed_msg=&#123;53f6a873 47559528 0&#125; delivered_msg=&#123;53f6a873 47559528 0&#125; p-&gt;synode=&#123;53f6a873 47559501 0&#125; p-&gt;delivered_msg=&#123;53f6a873 47559525 0&#125; p-&gt;max_synode=&#123;53f6a873 47559528 2&#125; &apos;</span><br></pre></td></tr></table></figure><h4 id="3、节点3因为内存不足导致节点集群进程down掉，重新启动mysql，尝试将节点3加入集群，提示加入失败："><a href="#3、节点3因为内存不足导致节点集群进程down掉，重新启动mysql，尝试将节点3加入集群，提示加入失败：" class="headerlink" title="3、节点3因为内存不足导致节点集群进程down掉，重新启动mysql，尝试将节点3加入集群，提示加入失败："></a>3、节点3因为内存不足导致节点集群进程down掉，重新启动mysql，尝试将节点3加入集群，提示加入失败：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2018-10-27T07:49:40.493156Z 33 [Note] Plugin group_replication reported: &apos;Group communication SSL configuration: group_replication_ssl_mode: &quot;DISABLED&quot;&apos;</span><br><span class="line">2018-10-27T07:49:40.493724Z 33 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 10.1.150.12/24,10.1.150.16/24,127.0.0.1/8 to the whitelist&apos;</span><br><span class="line">2018-10-27T07:49:40.494212Z 33 [Note] Plugin group_replication reported: &apos;[GCS] Translated &apos;mw-mysql-3&apos; to 10.1.150.16&apos;</span><br><span class="line">2018-10-27T07:49:40.494374Z 33 [Warning] Plugin group_replication reported: &apos;[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.&apos;</span><br><span class="line">2018-10-27T07:49:40.494426Z 33 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</span><br><span class="line">2018-10-27T07:49:40.494453Z 33 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;9275d4e4-8e42-11e8-b217-000d3aa1a189&quot;; group_replication_local_address: &quot;mw-mysql-3:24901&quot;; group_replication_group_seeds: &quot;mw-mysql-1:24901,mw-mysql-2:24901,mw-mysql-3:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-10-27T07:49:40.494471Z 33 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-10-27T07:49:40.494476Z 33 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-10-27T07:49:40.494526Z 33 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306101; member_uuid: &quot;8bab920f-8e3d-11e8-a045-000d3aa09b70&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 1; &apos;</span><br><span class="line">2018-10-27T07:49:40.494937Z 94 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-10-27T07:49:40.545004Z 97 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000508&apos; position: 4</span><br><span class="line">2018-10-27T07:49:40.545034Z 33 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-10-27T07:49:40.545059Z 33 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 1&apos;</span><br><span class="line">2018-10-27T07:49:40.545063Z 33 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306101&apos;</span><br><span class="line">2018-10-27T07:49:40.545486Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-10-27T07:49:40.545513Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-10-27T07:49:40.762663Z 0 [Warning] Plugin group_replication reported: &apos;read failed&apos;</span><br><span class="line">2018-10-27T07:49:40.780216Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] The member was unable to join the group. Local port: 24901&apos;</span><br></pre></td></tr></table></figure><h4 id="4、因为在节点3查不到任何有用的报错信息，尝试在节点1查看有没有其他报错，看到一条比较奇怪的报错："><a href="#4、因为在节点3查不到任何有用的报错信息，尝试在节点1查看有没有其他报错，看到一条比较奇怪的报错：" class="headerlink" title="4、因为在节点3查不到任何有用的报错信息，尝试在节点1查看有没有其他报错，看到一条比较奇怪的报错："></a>4、因为在节点3查不到任何有用的报错信息，尝试在节点1查看有没有其他报错，看到一条比较奇怪的报错：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] Plugin group_replication reported: &apos;Old incarnation found while trying to add node mw-mysql-3:24901 15406269616484810.&apos;</span><br></pre></td></tr></table></figure><p>官方文档没有关于这个信息的任何提示，在这个链接<a href="https://dba.stackexchange.com/questions/214779/how-to-delete-previous-incarnation-in-mysql-w-group-replication查到碰到这个问题只能重启集群。" target="_blank" rel="noopener">https://dba.stackexchange.com/questions/214779/how-to-delete-previous-incarnation-in-mysql-w-group-replication查到碰到这个问题只能重启集群。</a></p><h4 id="5、查看节点2的信息，error-log没有任何更新，正常情况下如果集群节点正常应该会每个120s左右，会刷新一下信息："><a href="#5、查看节点2的信息，error-log没有任何更新，正常情况下如果集群节点正常应该会每个120s左右，会刷新一下信息：" class="headerlink" title="5、查看节点2的信息，error.log没有任何更新，正常情况下如果集群节点正常应该会每个120s左右，会刷新一下信息："></a>5、查看节点2的信息，error.log没有任何更新，正常情况下如果集群节点正常应该会每个120s左右，会刷新一下信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] Multi-threaded slave statistics for channel &apos;group_replication_applier&apos;: seconds elapsed = 131; events assigned = 3687425; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 0; waited at clock conflicts = 65388998400 waited (count) when Workers occupied = 25728 waited when Workers occupied = 124142987600</span><br></pre></td></tr></table></figure><h4 id="6、查看节点1应用连接是正常的，但是dml操作一直hang主，没有任何结果，重新启动应用程序问题照旧。感觉集群状态虽然查询正常，但是已经不能提供对外服务了，最后决定把所有的库stop，重新集群系统，最后集群恢复正常，对外提供服务正常，查询集群服务正常："><a href="#6、查看节点1应用连接是正常的，但是dml操作一直hang主，没有任何结果，重新启动应用程序问题照旧。感觉集群状态虽然查询正常，但是已经不能提供对外服务了，最后决定把所有的库stop，重新集群系统，最后集群恢复正常，对外提供服务正常，查询集群服务正常：" class="headerlink" title="6、查看节点1应用连接是正常的，但是dml操作一直hang主，没有任何结果，重新启动应用程序问题照旧。感觉集群状态虽然查询正常，但是已经不能提供对外服务了，最后决定把所有的库stop，重新集群系统，最后集群恢复正常，对外提供服务正常，查询集群服务正常："></a>6、查看节点1应用连接是正常的，但是dml操作一直hang主，没有任何结果，重新启动应用程序问题照旧。感觉集群状态虽然查询正常，但是已经不能提供对外服务了，最后决定把所有的库stop，重新集群系统，最后集群恢复正常，对外提供服务正常，查询集群服务正常：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 77039511-8e42-11e8-b6d4-000d3aa1a189 | mw-mysql-1  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 81143c99-8e3d-11e8-a501-000d3aa1b575 | mw-mysql-2  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 8bab920f-8e3d-11e8-a045-000d3aa09b70 | mw-mysql-3  |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] yum安装mysql-client客户端(centos7)</title>
      <link href="/2018/10/25/%E5%AE%89%E8%A3%85mysqlclient%E5%AE%A2%E6%88%B7%E7%AB%AF/"/>
      <url>/2018/10/25/%E5%AE%89%E8%A3%85mysqlclient%E5%AE%A2%E6%88%B7%E7%AB%AF/</url>
      <content type="html"><![CDATA[<h4 id="1、配置yum源"><a href="#1、配置yum源" class="headerlink" title="1、配置yum源"></a>1、配置yum源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;[mysql80-community]</span><br><span class="line">name=MySQL 8.0 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-8.0-community/el/7/\$basearch/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql&quot; &gt; /etc/yum.repos.d/mysql-community.repo</span><br></pre></td></tr></table></figure><h4 id="2、查看配置文件是否正确"><a href="#2、查看配置文件是否正确" class="headerlink" title="2、查看配置文件是否正确:"></a>2、查看配置文件是否正确:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">more /etc/yum.repos.d/mysql-community.repo</span><br></pre></td></tr></table></figure><h4 id="3、安装mysql-client："><a href="#3、安装mysql-client：" class="headerlink" title="3、安装mysql-client："></a>3、安装mysql-client：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum install mysql-community-client</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql数据库使用innobackupex和mysqldump备份恢复的对比</title>
      <link href="/2018/10/25/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8innobackupex%E5%92%8Cmysqldump%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E7%9A%84%E5%AF%B9%E6%AF%94/"/>
      <url>/2018/10/25/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8innobackupex%E5%92%8Cmysqldump%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E7%9A%84%E5%AF%B9%E6%AF%94/</url>
      <content type="html"><![CDATA[<h4 id="1、查看原库数据文件大小："><a href="#1、查看原库数据文件大小：" class="headerlink" title="1、查看原库数据文件大小："></a>1、查看原库数据文件大小：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">du -sh *|grep data</span><br><span class="line">23Gdata</span><br></pre></td></tr></table></figure><h4 id="2、使用innodbackex备份数据"><a href="#2、使用innodbackex备份数据" class="headerlink" title="2、使用innodbackex备份数据"></a>2、使用innodbackex备份数据</h4><p>在percona官方下载xtrabackup软件，并解压<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.9/binary/tarball/percona-xtrabackup-2.4.9-Linux-x86_64.tar.gz</span><br><span class="line">tar -zxvf percona-xtrabackup-2.4.9-Linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p><p>开始执行备份，指定配置文件、用户名、密码、端口、备份的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./innobackupex --defaults-file=/etc/my.cnf --user=root --password=12345678 --port=3306 /data/</span><br></pre></td></tr></table></figure></p><p>（总体耗时25分钟左右，备份文件大小23G）</p><h4 id="3、采用innodbackex备份出来的数据去恢复-将数据文件拷贝到节点1-执行恢复操作"><a href="#3、采用innodbackex备份出来的数据去恢复-将数据文件拷贝到节点1-执行恢复操作" class="headerlink" title="3、采用innodbackex备份出来的数据去恢复,将数据文件拷贝到节点1,执行恢复操作:"></a>3、采用innodbackex备份出来的数据去恢复,将数据文件拷贝到节点1,执行恢复操作:</h4><p>先把事务日志恢复（–apply-log）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/percona-xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --user=root --password=12345678 --port=3306 --apply-log /data/2018-09-14_13-34-38</span><br></pre></td></tr></table></figure></p><p>恢复数据之前需要清除数据目录下的所有数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /data/mysql/data/*</span><br></pre></td></tr></table></figure></p><p>开始恢复数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/percona-xtrabackup/bin/innobackupex --defaults-file=/etc/my.cnf --user=root --password=12345678 --port=3306 --copy-back --rsync /data/2018-09-14_13-34-38</span><br></pre></td></tr></table></figure></p><p>数据恢复完成之后，删除datadir下的事务日志log文件（innodb引擎才会有）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; cd /data/mysql/data</span><br><span class="line">shell &gt; rm -rf ib_logfile*</span><br></pre></td></tr></table></figure></p><p>设置数据目录权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; chown -R mysql:mysql /data/mysql/data</span><br><span class="line">shell &gt; /data/mysql/bin/mysqld_safe --defaults-file=/data/mysql/etc/my.cnf &amp;</span><br></pre></td></tr></table></figure></p><p>启动节点1的mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br></pre></td></tr></table></figure></p><p>恢复总体耗时（35分钟）</p><h4 id="4、原库使用mysqldump方法备份一份数据，用于恢复节点2："><a href="#4、原库使用mysqldump方法备份一份数据，用于恢复节点2：" class="headerlink" title="4、原库使用mysqldump方法备份一份数据，用于恢复节点2："></a>4、原库使用mysqldump方法备份一份数据，用于恢复节点2：</h4><p>原库操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqldump --all-databases --set-gtid-purged=ON --single-transaction -uroot -p12345678 &gt; /db/test.dump</span><br></pre></td></tr></table></figure></p><p>备份需要指定–set-gtid-purged=ON参数在备份文件中输出global.gtid_purged信息，<br>指定–single-transaction参数避免备份过程中产生锁<br>（备份耗时10分钟，备份文件大小11G）</p><h4 id="5、将mysqldump备份出的数据拷贝到节点2，节点2进行恢复操作："><a href="#5、将mysqldump备份出的数据拷贝到节点2，节点2进行恢复操作：" class="headerlink" title="5、将mysqldump备份出的数据拷贝到节点2，节点2进行恢复操作："></a>5、将mysqldump备份出的数据拷贝到节点2，节点2进行恢复操作：</h4><p> 如果从库@@GLOBAL.GTID_EXECUTED值不为空需要执行reset master;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:55:  [(none)]&gt; stop group_replication;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">root@db 07:55:  [(none)]&gt; reset master;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br></pre></td></tr></table></figure></p><p>开始执行恢复<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-mha bin]# mysql -u root -p12345678 &lt; /data/test.dump</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure></p><p>总体耗时（60分钟左右）</p><h4 id="6、关于使用mysqldump备份恢复和innobackupex备份恢复的比较："><a href="#6、关于使用mysqldump备份恢复和innobackupex备份恢复的比较：" class="headerlink" title="6、关于使用mysqldump备份恢复和innobackupex备份恢复的比较："></a>6、关于使用mysqldump备份恢复和innobackupex备份恢复的比较：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">数据文件目录大小23G情况下，mysqldump逻辑备份出来数据大小11G，备份耗时十分钟，恢复耗时一小时；</span><br><span class="line">innobackupex物理备份备份出来数据大小23G，备份耗时25分钟，恢复耗时35分钟。</span><br><span class="line">使用物理备份备份时间比逻辑备份时间较长，但恢复时间会小于逻辑备份时间,数据量比较大的情况下使用innobackupex会更好一点。</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-MGR集群配置</title>
      <link href="/2018/10/25/mysql-MGR%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/10/25/mysql-MGR%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h4 id="前提须知：mgr限制条件"><a href="#前提须知：mgr限制条件" class="headerlink" title="前提须知：mgr限制条件"></a>前提须知：mgr限制条件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">仅支持InnoDB表，并且每张表一定要有一个主键，用于做write set的冲突检测；必须打开GTID特性，二进制日志格式必须设置为ROW，用于选主与write set</span><br><span class="line">COMMIT可能会导致失败，类似于快照事务隔离级别的失败场景</span><br><span class="line">目前一个MGR集群最多支持9个节点</span><br><span class="line">不支持外键于save point特性，无法做全局间的约束检测与部分部分回滚</span><br><span class="line">二进制日志不支持binlog event checksum</span><br></pre></td></tr></table></figure><h4 id="0、修改每个节点hosts文件，如下面所示-三个节点均需修改"><a href="#0、修改每个节点hosts文件，如下面所示-三个节点均需修改" class="headerlink" title="0、修改每个节点hosts文件，如下面所示(三个节点均需修改)"></a>0、修改每个节点hosts文件，如下面所示(三个节点均需修改)</h4><p>[root@dax-mysql-master log]# cat /etc/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.0.7.53   dax-mysql-master</span><br><span class="line">10.0.7.50   dax-mysql-slave</span><br><span class="line">10.0.7.51   dax-mysql-mha</span><br></pre></td></tr></table></figure></p><h4 id="1、修改三个节点的my-cnf配置文件，在-mysqld-后添加如下信息，local-address这一行配置为自己的ip地址，其他不变"><a href="#1、修改三个节点的my-cnf配置文件，在-mysqld-后添加如下信息，local-address这一行配置为自己的ip地址，其他不变" class="headerlink" title="1、修改三个节点的my.cnf配置文件，在[mysqld]后添加如下信息，local_address这一行配置为自己的ip地址，其他不变"></a>1、修改三个节点的my.cnf配置文件，在[mysqld]后添加如下信息，local_address这一行配置为自己的ip地址，其他不变</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">master_info_repository = &quot;TABLE&quot;</span><br><span class="line">relay_log_info_repository = &quot;TABLE&quot;</span><br><span class="line">transaction_write_set_extraction = &quot;XXHASH64&quot;</span><br><span class="line">slave_parallel_workers = 2</span><br><span class="line">slave_preserve_commit_order = 1</span><br><span class="line">slave_parallel_type = &quot;LOGICAL_CLOCK&quot;</span><br><span class="line">binlog_checksum = NONE</span><br><span class="line">#group_replication_allow_local_disjoint_gtids_join = ON</span><br><span class="line">#group_replication_auto_increment_increment = 1</span><br><span class="line">loose-group_replication_group_name = &quot;867fee38-746b-11e8-b006-000d3a800ed3&quot;</span><br><span class="line">loose-group_replication_start_on_boot = off</span><br><span class="line">loose-group_replication_local_address = &quot;dax-mysql-mha:24901&quot;</span><br><span class="line">loose-group_replication_group_seeds = &quot;dax-mysql-master:24901,dax-mysql-slave:24901,dax-mysql-mha:24901&quot;</span><br><span class="line">loose-group_replication_bootstrap_group = off</span><br></pre></td></tr></table></figure><p>集群参数详解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#group_replication_auto_increment_increment = 1 单主模式下可以设置为1（每个节点都要设置，不设置默认仍然为7）</span><br><span class="line">#loose-用于上述group_replication变量 的前缀 指示服务器在服务器启动时尚未加载组复制插件时继续启动。</span><br><span class="line">#配置会 transaction_write_set_extraction 指示服务器为每个事务处理它必须收集写入集并使用XXHASH64散列算法将其编码为 散列。</span><br><span class="line">#配置会 group_replication_group_name 告诉插件它正在加入或创建的组名为“aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa”。</span><br><span class="line">#值 group_replication_group_name 必须是有效的UUID。在二进制日志中为组复制事件设置GTID时，此UUID在内部使用。使用SELECT UUID();生成一个UUID。</span><br><span class="line">#配置 group_replication_start_on_boot 指示插件在服务器启动时不自动启动操作。这在设置组复制时很重要，因为它可以确保您可以在手动启动#插件之前配置服务器。成员配置完成后，您可以将其设置 group_replication_start_on_boot 为开启，以便在服务器引导时自动启动组复制。</span><br><span class="line">#配置 group_replication_local_address 告诉插件使用网络地址127.0.0.1和端口24901与组中的其他成员进行内部通信。</span><br></pre></td></tr></table></figure></p><p>添加完参数之后重启数据库（三个节点均需重启）</p><h4 id="2、主节点1-dax-mysql-master-执行："><a href="#2、主节点1-dax-mysql-master-执行：" class="headerlink" title="2、主节点1(dax-mysql-master)执行："></a>2、主节点1(dax-mysql-master)执行：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; </span><br><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER repl@&apos;%&apos; IDENTIFIED BY &apos;12345678&apos;;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO repl@&apos;%&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&apos;repl&apos;, MASTER_PASSWORD=&apos;12345678&apos; FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br><span class="line">#安装组复制插件</span><br><span class="line">INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">#查看插件是否安装成功</span><br><span class="line">SHOW PLUGINS;</span><br></pre></td></tr></table></figure><p>插件安装完成之后，将配置文件注释的那两行#去掉，重启数据库，并启动组复制进程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#启动组复制</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">START GROUP_REPLICATION;</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line">#查看组成员</span><br><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br></pre></td></tr></table></figure></p><h5 id="2-1、创建数据，可在添加其他节点之前加，或者之后加（测试在节点之前加，添加其他节点后，会自动同步）-该步骤可选择性执行"><a href="#2-1、创建数据，可在添加其他节点之前加，或者之后加（测试在节点之前加，添加其他节点后，会自动同步）-该步骤可选择性执行" class="headerlink" title="2.1、创建数据，可在添加其他节点之前加，或者之后加（测试在节点之前加，添加其他节点后，会自动同步）(该步骤可选择性执行)"></a>2.1、创建数据，可在添加其他节点之前加，或者之后加（测试在节点之前加，添加其他节点后，会自动同步）(该步骤可选择性执行)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;</span><br><span class="line">CREATE DATABASE test1;</span><br><span class="line">USE test;</span><br><span class="line">CREATE TABLE t4 (c1 INT PRIMARY KEY, c2 TEXT NOT NULL);</span><br><span class="line">INSERT INTO t4 VALUES (1, &apos;Luis&apos;);</span><br><span class="line">检查表t1和二进制日志的内容。</span><br><span class="line">SELECT * FROM t4;</span><br><span class="line">SHOW BINLOG EVENTS;</span><br></pre></td></tr></table></figure><h4 id="3、从节点2（dax-mysql-slave）执行"><a href="#3、从节点2（dax-mysql-slave）执行" class="headerlink" title="3、从节点2（dax-mysql-slave）执行:"></a>3、从节点2（dax-mysql-slave）执行:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER repl@&apos;%&apos; IDENTIFIED BY &apos;12345678&apos;;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO repl@&apos;%&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&apos;repl&apos;, MASTER_PASSWORD=&apos;12345678&apos; FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br><span class="line">INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">show plugins;</span><br></pre></td></tr></table></figure><p>将配置文件注释的那两行#去掉，重启数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure></p><h4 id="4、从节点3-dax-mysql-mha-执行"><a href="#4、从节点3-dax-mysql-mha-执行" class="headerlink" title="4、从节点3(dax-mysql-mha)执行:"></a>4、从节点3(dax-mysql-mha)执行:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER repl@&apos;%&apos; IDENTIFIED BY &apos;12345678&apos;;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO repl@&apos;%&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&apos;repl&apos;, MASTER_PASSWORD=&apos;12345678&apos; FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br><span class="line">INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">show plugins;</span><br></pre></td></tr></table></figure><p>将配置文件注释的那两行#去掉，重启数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure></p><h4 id="5、安装mysql-shell-只在主节点执行便可"><a href="#5、安装mysql-shell-只在主节点执行便可" class="headerlink" title="5、安装mysql-shell(只在主节点执行便可)"></a>5、安装mysql-shell(只在主节点执行便可)</h4><p>下载mysql-shell<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-Shell/mysql-shell-8.0.11-linux-glibc2.12-x86-64bit.tar.gz</span><br></pre></td></tr></table></figure></p><p>MySQL Shell用来配置服务器以供InnoDB集群使用的供应脚本需要访问Python版本2.7。对于沙箱部署，在用于部署的单台机器上需要Python，生产部署需要在每个服务器实例上使用Python。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-shell-8.0.11-linux-glibc2.12-x86-64bit.tar.gz</span><br><span class="line">mv mysql-shell-8.0.11-linux-glibc2.12-x86-64bit mysql-shell</span><br></pre></td></tr></table></figure></p><p>主节点1（dax-mysql-master),连接主节点,授权repl用户集群管理权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON mysql_innodb_cluster_metadata.* TO repl@&apos;%&apos; identified by &apos;12345678&apos; WITH GRANT OPTION;</span><br><span class="line">GRANT RELOAD, SHUTDOWN, PROCESS, FILE, SUPER, REPLICATION SLAVE, REPLICATION CLIENT, CREATE USER ON *.* TO repl@&apos;%&apos; identified by &apos;12345678&apos; WITH GRANT OPTION;</span><br><span class="line">GRANT SELECT ON *.* TO repl@&apos;%&apos; identified by &apos;12345678&apos; WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p><p>通过mysql-shell连接到主节点1配置集群:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/mysql-shell/bin/mysqlsh --uri repl@dax-mysql-master:3306</span><br><span class="line">&lt;输入用户名</span><br><span class="line">mysql-shell&gt;dba.verbose=2</span><br><span class="line">创建集群</span><br><span class="line">mysql-shell&gt;var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true&#125;);</span><br><span class="line">查看集群状态</span><br><span class="line">mysql-shell&gt;cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">mysql-shell&gt;cluster.status()</span><br></pre></td></tr></table></figure></p><h4 id="6、在应用端安装mysql-router"><a href="#6、在应用端安装mysql-router" class="headerlink" title="6、在应用端安装mysql-router"></a>6、在应用端安装mysql-router</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo bash</span><br><span class="line">mkdir -p /data/soft</span><br><span class="line">cd /data/soft</span><br><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-Router/mysql-router-8.0.11-linux-glibc2.12-x86-64bit.tar.gz</span><br><span class="line">tar -zxvf mysql-router-8.0.11-linux-glibc2.12-x86-64bit.tar.gz</span><br><span class="line">mv  mysql-router-8.0.11-linux-glibc2.12-x86-64bit  mysql-router</span><br></pre></td></tr></table></figure><p>配置mysqlrouter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/mysql-router/bin/mysqlrouter --bootstrap repl@10.5.0.6:3306 --directory /data/soft/myrouter --user=root --conf-use-sockets --force</span><br></pre></td></tr></table></figure></p><p>在/data/soft/myrouter目录下生成关于mysqlrouter的配置文件，用于记录用于连接到mgr集群<br>其中mysqlrouter.conf配置文件内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[metadata_cache:prodCluster]</span><br><span class="line">router_id=7</span><br><span class="line">bootstrap_server_addresses=mysql://dax-mysql-slave:3306,mysql://dax-mysql-master</span><br><span class="line">:3306,mysql://dax-mysql-mha:3306</span><br><span class="line">user=mysql_router7_umuf7ikos8fp</span><br><span class="line">metadata_cluster=prodCluster</span><br><span class="line">ttl=5</span><br><span class="line"></span><br><span class="line">[routing:prodCluster_default_rw]</span><br><span class="line">bind_address=0.0.0.0</span><br><span class="line">bind_port=6446</span><br><span class="line">socket=/tmp/myrouter/mysql.sock</span><br><span class="line">destinations=metadata-cache://prodCluster/default?role=PRIMARY</span><br><span class="line">routing_strategy=round-robin</span><br><span class="line">protocol=classic</span><br><span class="line"></span><br><span class="line">[routing:prodCluster_default_ro]</span><br><span class="line">bind_address=0.0.0.0</span><br><span class="line">bind_port=6447</span><br><span class="line">socket=/tmp/myrouter/mysqlro.sock</span><br><span class="line">destinations=metadata-cache://prodCluster/default?role=SECONDARY</span><br><span class="line">routing_strategy=round-robin</span><br><span class="line">protocol=classic</span><br><span class="line"></span><br><span class="line">[routing:prodCluster_default_x_rw]</span><br><span class="line">bind_address=0.0.0.0</span><br><span class="line">bind_port=64460</span><br><span class="line">socket=/tmp/myrouter/mysqlx.sock</span><br><span class="line">destinations=metadata-cache://prodCluster/default?role=PRIMARY</span><br><span class="line">routing_strategy=round-robin</span><br><span class="line">protocol=x</span><br><span class="line"></span><br><span class="line">[routing:prodCluster_default_x_ro]</span><br><span class="line">bind_address=0.0.0.0</span><br><span class="line">bind_port=64470</span><br><span class="line">socket=/tmp/myrouter/mysqlxro.sock</span><br><span class="line">destinations=metadata-cache://prodCluster/default?role=SECONDARY</span><br><span class="line">routing_strategy=round-robin</span><br><span class="line">protocol=x</span><br></pre></td></tr></table></figure></p><p>启动mysqlrouter命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/myrouter/start.sh</span><br><span class="line">netstat -tunlp|grep mysql</span><br></pre></td></tr></table></figure></p><p>加入开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;</span><br><span class="line">rm -rf /data/soft/myrouter/mysqlrouter.pid </span><br><span class="line">/data/soft/myrouter/start.sh &quot; &gt;&gt; /etc/rc.local</span><br><span class="line">cat /etc/rc.local</span><br></pre></td></tr></table></figure></p><p>授权脚本执行权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line">ll /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></p><p>####7、测试连接库是否有问题，并查看连接的库是主还是从<br>连接读写库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -h 127.0.0.1 -P 6446 -p</span><br></pre></td></tr></table></figure></p><p>连接只读库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -h 127.0.0.1 -P 6447 -p</span><br></pre></td></tr></table></figure></p><h4 id="8、查看集群状态"><a href="#8、查看集群状态" class="headerlink" title="8、查看集群状态"></a>8、查看集群状态</h4><p>查看组成员<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br></pre></td></tr></table></figure></p><p>查看主节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE &apos;group_replication_primary_member&apos;;</span><br></pre></td></tr></table></figure></p><p>或者使用如下方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global show_compatibility_56 = on;</span><br><span class="line">select MEMBER_HOST from performance_schema.replication_group_members where MEMBER_ID=(select VARIABLE_VALUE from information_schema.global_status where variable_name=&apos;GROUP_REPLICATION_PRIMARY_MEMBER&apos;);</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 一台服务器安装多个mysql数据库程序</title>
      <link href="/2018/10/25/%E4%B8%80%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85%E5%A4%9A%E4%B8%AAmysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A8%8B%E5%BA%8F/"/>
      <url>/2018/10/25/%E4%B8%80%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85%E5%A4%9A%E4%B8%AAmysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A8%8B%E5%BA%8F/</url>
      <content type="html"><![CDATA[<h4 id="1、已安装第一个mysql程序的相关信息："><a href="#1、已安装第一个mysql程序的相关信息：" class="headerlink" title="1、已安装第一个mysql程序的相关信息："></a>1、已安装第一个mysql程序的相关信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">端口：3306</span><br><span class="line">目录：/data/mysql/</span><br><span class="line">配置文件:/etc/my.cnf</span><br></pre></td></tr></table></figure><h4 id="2、新建用于第二个mysql程序的目录："><a href="#2、新建用于第二个mysql程序的目录：" class="headerlink" title="2、新建用于第二个mysql程序的目录："></a>2、新建用于第二个mysql程序的目录：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/twomysql</span><br></pre></td></tr></table></figure><p>将安装包解压到twomysql目录（下载地址<a href="https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz）" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz）</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /data/twomysql</span><br><span class="line">cd /data/twomysql</span><br><span class="line">mv mysql-5.7.22-linux-glibc2.12-x86_64 twomysql</span><br></pre></td></tr></table></figure></p><p>创建相关数据、日志、配置文件目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/twomysql/twomysql/log</span><br><span class="line">touch /data/twomysql/twomysql/log/mysqld.log</span><br><span class="line">chown -R mysql.mysql /data/twomysql/twomysql/log</span><br><span class="line">mkdir -p /data/twomysql/twomysql/data</span><br><span class="line">chown -R mysql.mysql /data/twomysql/twomysql/data</span><br><span class="line">mkdir -p /data/twomysql/twomysql/tmp</span><br><span class="line">chown -R mysql.mysql /data/twomysql/twomysql/tmp</span><br><span class="line">mkdir -p /data/twomysql/twomysql/etc</span><br><span class="line">chown -R mysql.mysql /data/twomysql/twomysql/etc</span><br><span class="line">cd /data/twomysql/twomysql/etc</span><br></pre></td></tr></table></figure></p><p>配置文件信息如下，端口设为3307，目录设置跟上面创建的目录匹配：<br>vim my.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port    = 3307</span><br><span class="line">socket    = /data/twomysql/twomysql/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=&quot;\u@db \R:\m:\s [\d]&gt; &quot;</span><br><span class="line">no-auto-rehash</span><br><span class="line">[mysqld]</span><br><span class="line">user    = mysql</span><br><span class="line">port    = 3307</span><br><span class="line">basedir    = /data/twomysql/twomysql</span><br><span class="line">datadir    = /data/twomysql/twomysql/data</span><br><span class="line">socket    = /data/twomysql/twomysql/tmp/mysql.sock</span><br><span class="line">pid-file = /data/twomysql/twomysql/tmp/mysql.pid</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">open_files_limit    = 65535</span><br><span class="line">back_log = 1024</span><br><span class="line">max_connections = 2000</span><br><span class="line">max_connect_errors = 100</span><br><span class="line">net_read_timeout = 30</span><br><span class="line">net_write_timeout = 60</span><br><span class="line">slave_net_timeout = 90</span><br><span class="line">table_open_cache = 1024</span><br><span class="line">table_definition_cache = 1024</span><br><span class="line">table_open_cache_instances = 64</span><br><span class="line">thread_stack = 512K</span><br><span class="line">external-locking = FALSE</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">sort_buffer_size = 4M</span><br><span class="line">join_buffer_size = 4M</span><br><span class="line">thread_cache_size = 768</span><br><span class="line">query_cache_size = 0</span><br><span class="line">query_cache_type = 0</span><br><span class="line">interactive_timeout = 600</span><br><span class="line">wait_timeout = 600</span><br><span class="line">tmp_table_size = 32M</span><br><span class="line">max_heap_table_size = 32M</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /data/twomysql/twomysql/log/slow.log</span><br><span class="line">log-error = /data/twomysql/twomysql/log/error.log</span><br><span class="line">long_query_time = 0.1</span><br><span class="line">server-id = 3306101</span><br><span class="line">log-bin = /data/twomysql/twomysql/log/mysql-binlog</span><br><span class="line">sync_binlog = 1</span><br><span class="line">binlog_cache_size = 4M</span><br><span class="line">max_binlog_cache_size = 1G</span><br><span class="line">max_binlog_size = 1G</span><br><span class="line">expire_logs_days = 7</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line">binlog_format = row</span><br><span class="line">relay_log_recovery = 1</span><br><span class="line">relay-log = relay-log</span><br><span class="line">relay-log-purge = 1</span><br><span class="line">key_buffer_size = 32M</span><br><span class="line">read_buffer_size = 8M</span><br><span class="line">read_rnd_buffer_size = 4M</span><br><span class="line">bulk_insert_buffer_size = 64M</span><br><span class="line">lock_wait_timeout = 60</span><br><span class="line">explicit_defaults_for_timestamp = 1</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_sync_spin_loops = 100</span><br><span class="line">innodb_spin_wait_delay = 30</span><br><span class="line">transaction_isolation = REPEATABLE-READ</span><br><span class="line">innodb_buffer_pool_size = 2048M</span><br><span class="line">innodb_buffer_pool_instances = 8</span><br><span class="line">innodb_buffer_pool_load_at_startup = 1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown = 1</span><br><span class="line">innodb_data_file_path = ibdata1:1G:autoextend</span><br><span class="line">innodb_flush_log_at_trx_commit = 1</span><br><span class="line">innodb_log_buffer_size = 32M</span><br><span class="line">innodb_log_file_size = 1G</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_max_undo_log_size = 4G</span><br><span class="line">innodb_io_capacity = 4000</span><br><span class="line">innodb_io_capacity_max = 8000</span><br><span class="line">innodb_flush_neighbors = 0</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_purge_threads = 4</span><br><span class="line">innodb_page_cleaners = 4</span><br><span class="line">innodb_open_files = 65535</span><br><span class="line">innodb_max_dirty_pages_pct = 50</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_lru_scan_depth = 4000</span><br><span class="line">innodb_checksum_algorithm = crc32</span><br><span class="line">innodb_lock_wait_timeout = 30</span><br><span class="line">innodb_rollback_on_timeout = 1</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_online_alter_log_max_size = 4G</span><br><span class="line">internal_tmp_disk_storage_engine = InnoDB</span><br><span class="line">innodb_stats_on_metadata = 0</span><br><span class="line">innodb_status_file = 1</span><br><span class="line">innodb_status_output = 0</span><br><span class="line">innodb_status_output_locks = 0</span><br><span class="line">performance_schema = 1</span><br><span class="line">performance_schema_instrument = &apos;%=on&apos;</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">explicit_defaults_for_timestamp = off</span><br><span class="line">sql_mode = STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">[mysql.server]</span><br><span class="line">basedir=/data/twomysql/twomysql</span><br></pre></td></tr></table></figure></p><h4 id="3、初始化数据库"><a href="#3、初始化数据库" class="headerlink" title="3、初始化数据库"></a>3、初始化数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /data/twomysql/twomysql/mysql-files</span><br><span class="line">sudo chown mysql:mysql /data/twomysql/twomysql/mysql-files</span><br><span class="line">sudo chmod 750 /data/twomysql/twomysql/mysql-files</span><br></pre></td></tr></table></figure><p>设置无密码登录，在后面在重新创建密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/twomysql/twomysql/bin/mysqld  --defaults-file=/data/twomysql/twomysql/etc/my.cnf --initialize-insecure --user=mysql </span><br><span class="line">sudo /data/twomysql/twomysql/bin/mysql_ssl_rsa_setup</span><br></pre></td></tr></table></figure></p><h4 id="4、初始化完成之后，启动数据库："><a href="#4、初始化完成之后，启动数据库：" class="headerlink" title="4、初始化完成之后，启动数据库："></a>4、初始化完成之后，启动数据库：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/twomysql/twomysql/bin/mysqld_safe --defaults-file=/data/twomysql/twomysql/etc/my.cnf &amp;</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/U6azYpM.png" alt=""><br><img src="https://i.imgur.com/hHEuSC0.png" alt=""></p><h4 id="5、修改用户密码"><a href="#5、修改用户密码" class="headerlink" title="5、修改用户密码"></a>5、修改用户密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/twomysql/twomysql/bin/mysqladmin -u root -P 3307  -S /data/twomysql/twomysql/tmp/mysql.sock password 123456</span><br></pre></td></tr></table></figure><h4 id="6、登录mysql，需要输入密码："><a href="#6、登录mysql，需要输入密码：" class="headerlink" title="6、登录mysql，需要输入密码："></a>6、登录mysql，需要输入密码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/twomysql/twomysql/bin/mysql --socket=/data/twomysql/twomysql/tmp/mysql.sock --port=3307 -p</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控hp-switch</title>
      <link href="/2018/10/24/hp%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%90%AF%E7%94%A8snmp%EF%BC%8C%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0zabbix%E7%9B%91%E6%8E%A7/"/>
      <url>/2018/10/24/hp%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%90%AF%E7%94%A8snmp%EF%BC%8C%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0zabbix%E7%9B%91%E6%8E%A7/</url>
      <content type="html"><![CDATA[<h4 id="1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式"><a href="#1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式" class="headerlink" title="1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式"></a>1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># system-view</span><br></pre></td></tr></table></figure><h4 id="2、配置snmp服务，设置版本、联系人信息、设备位置、团体名"><a href="#2、配置snmp服务，设置版本、联系人信息、设备位置、团体名" class="headerlink" title="2、配置snmp服务，设置版本、联系人信息、设备位置、团体名"></a>2、配置snmp服务，设置版本、联系人信息、设备位置、团体名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># snmp-agent</span><br><span class="line"># snmp-agent sys-info version v2c</span><br><span class="line"># snmp-agent sys-info contact Zamasu &lt;zamasu@dbsuper.com&gt;</span><br><span class="line"># snmp-agent sys-info location Universe10 - IT Room</span><br><span class="line"># snmp-agent community read GokuBlack</span><br></pre></td></tr></table></figure><h4 id="3、保存配置信息："><a href="#3、保存配置信息：" class="headerlink" title="3、保存配置信息："></a>3、保存配置信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#save</span><br></pre></td></tr></table></figure><h4 id="4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务："><a href="#4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务：" class="headerlink" title="4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务："></a>4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install snmp(apt-get install snmp)</span><br><span class="line"># snmpwalk -v2c -c GokuBlack 192.168.0.200</span><br></pre></td></tr></table></figure><p>192.168.0.200为hp交换机的地址<br>下面为snmpwalk输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SNMPv2-MIB::sysDescr.0 = STRING: HPE V1910-48G Switch Software Version 5.20, Release 1519P03</span><br><span class="line">Copyright(c) 2010-2017 Hewlett Packard Enterprise Development, L.P.</span><br><span class="line">SNMPv2-MIB::sysObjectID.0 = OID: SNMPv2-SMI::enterprises.25506.11.1.85</span><br><span class="line">DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (197804302) 22 days, 21:27:23.02</span><br><span class="line">SNMPv2-MIB::sysContact.0 = STRING: Zamasu &lt;zamasu@dbsuper.com&gt;</span><br><span class="line">SNMPv2-MIB::sysName.0 = STRING: TECH-SW01</span><br><span class="line">SNMPv2-MIB::sysLocation.0 = STRING: Universe10 - IT Room</span><br></pre></td></tr></table></figure></p><h4 id="5、配置zabbix仪表板："><a href="#5、配置zabbix仪表板：" class="headerlink" title="5、配置zabbix仪表板："></a>5、配置zabbix仪表板：</h4><p>创建主机<br><img src="https://i.imgur.com/zOCoL44.png" alt=""><br><img src="https://i.imgur.com/wknK4aG.jpg" alt=""><br>下面配置snmp团体名用于zabbix连接hp交换机<br><img src="https://i.imgur.com/THDB2A8.jpg" alt=""><br>根据对应的交换机型号，去zabbix官网下载对应得模板：<br><a href="http://www.zabbix.org/wiki/Zabbix_Templates，点击[跳转](http://www.zabbix.org/wiki/Zabbix_Templates)" target="_blank" rel="noopener">http://www.zabbix.org/wiki/Zabbix_Templates，点击[跳转](http://www.zabbix.org/wiki/Zabbix_Templates)</a></p>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] oracle 定期删除trace文件</title>
      <link href="/2018/10/22/oracle%20%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4trace%E6%96%87%E4%BB%B6/"/>
      <url>/2018/10/22/oracle%20%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4trace%E6%96%87%E4%BB%B6/</url>
      <content type="html"><![CDATA[<h4 id="oracle-定期删除trace文件"><a href="#oracle-定期删除trace文件" class="headerlink" title="oracle 定期删除trace文件"></a>oracle 定期删除trace文件</h4><p>cat del_trace.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#oracle 11gR2 rdbms</span><br><span class="line"></span><br><span class="line">#声明oracle环境变量</span><br><span class="line">export ORACLE_BASE=/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0.4/dbhome_1</span><br><span class="line">#声明主机名</span><br><span class="line">export HOST_NAME=`hostname`</span><br><span class="line">#声明日期，用于删除几天前的文件</span><br><span class="line">export DAYS=7</span><br><span class="line"></span><br><span class="line">#一台服务器装有多个实例，可使用循环进行删除</span><br><span class="line">for dbname in instancea instanceb</span><br><span class="line">do</span><br><span class="line">export DB_NAME=$dbname</span><br><span class="line">export DB_UNIQUE_NAME=$&#123;DB_NAME&#125;</span><br><span class="line">export ORACLE_SID=$&#123;DB_NAME&#125;</span><br><span class="line">#当前实例为rac模式节点1，启用该变量</span><br><span class="line">#export ORACLE_SID=$&#123;DB_NAME&#125;1</span><br><span class="line">#当前实例为rac模式节点2，启用该变量</span><br><span class="line">#export ORACLE_SID=$&#123;DB_NAME&#125;2</span><br><span class="line"></span><br><span class="line">#指定存放日志的路径</span><br><span class="line">DIAGNOSTIC_DEST=$&#123;ORACLE_BASE&#125;</span><br><span class="line"></span><br><span class="line">#如果audit_trail_dest的一个默认值不生效，会使用下面第二个默认值：</span><br><span class="line">AUDIT_FILE_DEST=$&#123;ORACLE_BASE&#125;/admin/$&#123;DB_NAME&#125;/adump</span><br><span class="line"></span><br><span class="line">#删除audit_trail_dest第一个默认值下的审计日志，并删除7天前的日志</span><br><span class="line">find $&#123;ORACLE_HOME&#125;/rdbms/audit -name &quot;$&#123;ORACLE_SID&#125;_*.aud&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">#如果audit_trail_dest的一个默认值不生效，查找第二个默认值下的审计日志，并删除7天前的日志：</span><br><span class="line">find $&#123;AUDIT_FILE_DEST&#125; -name &quot;$&#123;ORACLE_SID&#125;_*.aud&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">#删除指定路径alert下的文件</span><br><span class="line">find $&#123;DIAGNOSTIC_DEST&#125;/diag/rdbms/$&#123;DB_UNIQUE_NAME&#125;/$&#123;ORACLE_SID&#125;/alert -name &quot;log_[0-9]*.xml&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">#删除指定路径trace下的文件</span><br><span class="line">find $&#123;DIAGNOSTIC_DEST&#125;/diag/rdbms/$&#123;DB_UNIQUE_NAME&#125;/$&#123;ORACLE_SID&#125;/trace -name &quot;$&#123;ORACLE_SID&#125;_*.tr[c|m]&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">find $&#123;DIAGNOSTIC_DEST&#125;/diag/rdbms/$&#123;DB_UNIQUE_NAME&#125;/$&#123;ORACLE_SID&#125;/trace -name &quot;cdmp_*&quot; -mtime +$&#123;DAYS&#125; -exec rm -rf &#123;&#125; \;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p><p>将该脚本，添加到cron下每日定期删除</p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Oracle] oracle-audit_file_dest和audit_trail参数详解</title>
      <link href="/2018/10/22/oracle-audit_file_dest%E5%92%8Caudit_trail%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/10/22/oracle-audit_file_dest%E5%92%8Caudit_trail%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h4 id="1、AUDIT-FILE-DEST参数："><a href="#1、AUDIT-FILE-DEST参数：" class="headerlink" title="1、AUDIT_FILE_DEST参数："></a>1、AUDIT_FILE_DEST参数：</h4><p>当AUDIT_TRAIL初始化参数被设置为os, xml, or xml,extended，AUDIT_FILE_DEST指定操作系统目录，用于记录跟踪审计。<br>AUDIT_FILE_DEST的第一个默认值为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORACLE_BASE/admin/ORACLE_SID/adump</span><br></pre></td></tr></table></figure></p><p>如果第一个值指定的目录不存在或者该值不可用，会启用第二个默认值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORACLE_HOME/rdbms/audit</span><br></pre></td></tr></table></figure></p><p>这两个默认值只适用于unix系统，其他平台系统默认值不同。<br>在多租户cdb模式下,默认值会被追加pdb的guid，用于存储属于pdb的审计记录。<br>例如，pdb的guid为03E1F908EE04252CE053B280E80AAAA3，第一个默认目录是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORACLE_BASE/admin/ORACLE_SID/adump/03E1F908EE04252CE053B280E80AAAA3</span><br></pre></td></tr></table></figure></p><p>关于pdb的guid可以通过V$CONTAINERS视图参看。</p><p>如果AUDIT_TRAIL参数设置为xml, or xml,extended，审计记录会以xml的格式存储。如果AUDIT_SYS_OPERATIONS参数启用，用于审计sys用户的记录，审计信息也会强制写入这个位置。<br>在多租户容器数据库，audit_file_dest的值设置范围是cdb。虽然审计记录是每个pdb提供的，但是每个pdb不能修改该初始化参数。</p><h4 id="2、audit-trail参数"><a href="#2、audit-trail参数" class="headerlink" title="2、audit_trail参数"></a>2、audit_trail参数</h4><p>value值详解：<br>none：禁用数据库审计<br>os：开启数据库审计，并将所有审计记录定向到操作系统的审计跟踪。<br>db：开启数据库审计，并将所有审计记录定向到数据库审计跟踪（sys.aud$)<br>db, extended:开启数据库审计，并将所有审计记录定向到数据库审计跟踪（sys.aud$),另外，sys.aud$表中类型为clob的两列（sqlbind和sqltext会被写入数据）<br>xml：开启数据库审计，并将所有审计记录以xml格式写入操作系统文件<br>xml,extended:开启数据库审计，并打印所有的审计记录列，包括SqlText和SqlBind字段</p>]]></content>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] linux区分当前服务器是物理机还是虚拟机方法</title>
      <link href="/2018/10/18/linux%E5%8C%BA%E5%88%86%E5%BD%93%E5%89%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E7%89%A9%E7%90%86%E6%9C%BA%E8%BF%98%E6%98%AF%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
      <url>/2018/10/18/linux%E5%8C%BA%E5%88%86%E5%BD%93%E5%89%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E7%89%A9%E7%90%86%E6%9C%BA%E8%BF%98%E6%98%AF%E8%99%9A%E6%8B%9F%E6%9C%BA/</url>
      <content type="html"><![CDATA[<h3 id="1、查看系统产品名称："><a href="#1、查看系统产品名称：" class="headerlink" title="1、查看系统产品名称："></a>1、查看系统产品名称：</h3><p>dmidecode -s system-product-name<br>物理机：<br><img src="https://i.imgur.com/fV68YVX.png" alt=""><br>Azure微软云服务器<br><img src="https://i.imgur.com/zlsbp4u.png" alt=""><br>aws亚马逊云服务器<br><img src="https://i.imgur.com/5iOdIf3.png" alt=""><br>阿里云服务器<br><img src="https://i.imgur.com/AlWSFW0.png" alt=""><br>使用vmware建立的虚拟机<br><img src="https://i.imgur.com/TpzQH8s.png" alt=""><br>使用kvm建立的虚拟机<br><img src="https://i.imgur.com/Q7h1vEC.png" alt=""></p><h3 id="2、查看scsi供应商："><a href="#2、查看scsi供应商：" class="headerlink" title="2、查看scsi供应商："></a>2、查看scsi供应商：</h3><p>cat /proc/scsi/scsi|grep Vendor<br>物理机：<br><img src="https://i.imgur.com/3ID5hHz.png" alt=""><br>Azure微软云服务器<br><img src="https://i.imgur.com/A9HEqR5.png" alt=""><br>aws亚马逊云服务器（看不到任何信息）<br><img src="https://i.imgur.com/x2Eandx.png" alt=""><br>阿里云服务器<br><img src="https://i.imgur.com/5wt4HXK.png" alt=""><br>使用vmware建立的虚拟机<br><img src="https://i.imgur.com/X1v9alH.png" alt=""><br>使用kvm建立的虚拟机<br><img src="https://i.imgur.com/rFMO9XJ.png" alt=""></p><h3 id="3、查看内核缓冲信息："><a href="#3、查看内核缓冲信息：" class="headerlink" title="3、查看内核缓冲信息："></a>3、查看内核缓冲信息：</h3><p>dmesg | grep -i virtual<br>物理机：<br><img src="https://i.imgur.com/lfLe8yz.png" alt=""><br>Azure微软云服务器<br><img src="https://i.imgur.com/ZP2vlPq.png" alt=""><br>aws亚马逊云服务器<br><img src="https://i.imgur.com/CJijhJv.png" alt=""><br>阿里云服务器<br><img src="https://i.imgur.com/Wy7zTE3.png" alt=""><br>使用vmware建立的虚拟机<br><img src="https://i.imgur.com/8SEgcjn.png" alt=""><br>使用kvm建立的虚拟机<br><img src="https://i.imgur.com/7IacEIc.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql忘记root密码，修改密码方法</title>
      <link href="/2018/10/18/mysql%E5%BF%98%E8%AE%B0root%E5%AF%86%E7%A0%81%EF%BC%8C%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E6%96%B9%E6%B3%95/"/>
      <url>/2018/10/18/mysql%E5%BF%98%E8%AE%B0root%E5%AF%86%E7%A0%81%EF%BC%8C%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E6%96%B9%E6%B3%95/</url>
      <content type="html"><![CDATA[<h3 id="1、修改my-cnf文件，在-mysqld-下添加’skip-grant-tables’参数："><a href="#1、修改my-cnf文件，在-mysqld-下添加’skip-grant-tables’参数：" class="headerlink" title="1、修改my.cnf文件，在[mysqld]下添加’skip-grant-tables’参数："></a>1、修改my.cnf文件，在[mysqld]下添加’skip-grant-tables’参数：</h3><p>cat /usr/local/mysql/etc/my.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">!include /usr/local/mysql/etc/mysqld.cnf</span><br><span class="line">port            = 3306</span><br><span class="line">basedir         = /usr/local/mysql/</span><br><span class="line">socket          = /usr/local/mysql/tmp/mysql.sock</span><br><span class="line">pid-file        = /usr/local/mysql/var/mysql.pid</span><br><span class="line">datadir         = /usr/local/mysql/var/</span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure></p><h3 id="2、重启mysql进程："><a href="#2、重启mysql进程：" class="headerlink" title="2、重启mysql进程："></a>2、重启mysql进程：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br></pre></td></tr></table></figure><h3 id="3、进入mysql控制台，修改mysql密码："><a href="#3、进入mysql控制台，修改mysql密码：" class="headerlink" title="3、进入mysql控制台，修改mysql密码："></a>3、进入mysql控制台，修改mysql密码：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; USE mysql ; </span><br><span class="line">Database changed</span><br><span class="line">mysql&gt;  UPDATE user SET Password = password ( &apos;12345678&apos; ) WHERE User = &apos;root&apos; ; </span><br><span class="line">Query OK, 1 row affected (0.06 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">mysql&gt; flush privileges ; </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure><h3 id="4、注释掉my-cnf配置文件下的skip-grant-tables这行参数，重新启动mysql："><a href="#4、注释掉my-cnf配置文件下的skip-grant-tables这行参数，重新启动mysql：" class="headerlink" title="4、注释掉my.cnf配置文件下的skip-grant-tables这行参数，重新启动mysql："></a>4、注释掉my.cnf配置文件下的skip-grant-tables这行参数，重新启动mysql：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br></pre></td></tr></table></figure><h3 id="5、测试密码是否修改成功-能否正常登陆控制台："><a href="#5、测试密码是否修改成功-能否正常登陆控制台：" class="headerlink" title="5、测试密码是否修改成功,能否正常登陆控制台："></a>5、测试密码是否修改成功,能否正常登陆控制台：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</title>
      <link href="/2018/10/17/mysql--The%20table%20is%20probably%20corrupted/"/>
      <url>/2018/10/17/mysql--The%20table%20is%20probably%20corrupted/</url>
      <content type="html"><![CDATA[<h3 id="1、从mysql5-6-msyqldump全备出来数据，导入到mysql5-7的库，导入导出均正常，在5-7的库新增用户时，提示以下错误："><a href="#1、从mysql5-6-msyqldump全备出来数据，导入到mysql5-7的库，导入导出均正常，在5-7的库新增用户时，提示以下错误：" class="headerlink" title="1、从mysql5.6 msyqldump全备出来数据，导入到mysql5.7的库，导入导出均正常，在5.7的库新增用户时，提示以下错误："></a>1、从mysql5.6 msyqldump全备出来数据，导入到mysql5.7的库，导入导出均正常，在5.7的库新增用户时，提示以下错误：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:21:  [(none)]&gt; grant select,update,delete,insert on *.* to &apos;clevergo&apos;@&apos;%&apos; identified by &apos;123123&apos;;</span><br><span class="line">ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span><br></pre></td></tr></table></figure><h3 id="2、造成该问题是因为把5-6的库数据，全部导入5-7造成的，因此需要使用mysql-upgrade将库升级到最新版本："><a href="#2、造成该问题是因为把5-6的库数据，全部导入5-7造成的，因此需要使用mysql-upgrade将库升级到最新版本：" class="headerlink" title="2、造成该问题是因为把5.6的库数据，全部导入5.7造成的，因此需要使用mysql_upgrade将库升级到最新版本："></a>2、造成该问题是因为把5.6的库数据，全部导入5.7造成的，因此需要使用mysql_upgrade将库升级到最新版本：</h3><p>/data/mysql/bin/mysql_upgrade -uroot -p123456<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysql_upgrade: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Checking if update is needed.</span><br><span class="line">Checking server version.</span><br><span class="line">Running queries to upgrade MySQL server.</span><br><span class="line">Checking system database.</span><br><span class="line">mysql.columns_priv                                 OK</span><br><span class="line">mysql.db                                           OK</span><br><span class="line">mysql.engine_cost                                  OK</span><br><span class="line">mysql.event                                        OK</span><br><span class="line">mysql.func                                         OK</span><br><span class="line">mysql.general_log                                  OK</span><br><span class="line">mysql.gtid_executed                                OK</span><br><span class="line">mysql.help_category                                OK</span><br><span class="line">mysql.help_keyword                                 OK</span><br><span class="line">mysql.help_relation                                OK</span><br><span class="line">mysql.help_topic                                   OK</span><br><span class="line">mysql.innodb_index_stats                           OK</span><br><span class="line">mysql.innodb_table_stats                           OK</span><br><span class="line">mysql.ndb_binlog_index                             OK</span><br><span class="line">mysql.plugin                                       OK</span><br><span class="line">mysql.proc                                         OK</span><br><span class="line">mysql.procs_priv                                   OK</span><br><span class="line">mysql.proxies_priv                                 OK</span><br><span class="line">mysql.server_cost                                  OK</span><br><span class="line">mysql.servers                                      OK</span><br><span class="line">mysql.slave_master_info                            OK</span><br><span class="line">mysql.slave_relay_log_info                         OK</span><br><span class="line">mysql.slave_worker_info                            OK</span><br><span class="line">mysql.slow_log                                     OK</span><br><span class="line">mysql.tables_priv                                  OK</span><br><span class="line">mysql.time_zone                                    OK</span><br><span class="line">mysql.time_zone_leap_second                        OK</span><br><span class="line">mysql.time_zone_name                               OK</span><br><span class="line">mysql.time_zone_transition                         OK</span><br><span class="line">mysql.time_zone_transition_type                    OK</span><br><span class="line">mysql.user                                         OK</span><br><span class="line">The sys schema is already up to date (version 1.5.1).</span><br><span class="line">Found 0 sys functions, but expected 22. Re-installing the sys schema.</span><br><span class="line">Upgrading the sys schema.</span><br><span class="line">Checking databases.</span><br><span class="line">t.t_test                                           OK</span><br><span class="line">Upgrade process completed successfully.</span><br><span class="line">Checking if update is needed.</span><br></pre></td></tr></table></figure></p><h3 id="3、进入mysql，再次执行创建用户："><a href="#3、进入mysql，再次执行创建用户：" class="headerlink" title="3、进入mysql，再次执行创建用户："></a>3、进入mysql，再次执行创建用户：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:26:  [(none)]&gt; grant select,update,delete,insert on *.* to &apos;clevergo&apos;@&apos;%&apos; identified by &apos;123123&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; select host,user from mysql.user;</span><br><span class="line">+-----------+----------------+</span><br><span class="line">| host      | user           |</span><br><span class="line">+-----------+----------------+</span><br><span class="line">| %         | clevergo       |</span><br><span class="line">| localhost | mysql.session  |</span><br><span class="line">| localhost | mysql.sys      |</span><br><span class="line">| localhost | root           |</span><br><span class="line">+-----------+----------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure><p>执行成功。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 使用mysqldiff和mysqldbcompare检查数据一致性</title>
      <link href="/2018/10/08/%E4%BD%BF%E7%94%A8mysqldiff%E5%92%8Cmysqldbcompare%E6%AF%94%E8%BE%83%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B7%AE%E5%BC%82/"/>
      <url>/2018/10/08/%E4%BD%BF%E7%94%A8mysqldiff%E5%92%8Cmysqldbcompare%E6%AF%94%E8%BE%83%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B7%AE%E5%BC%82/</url>
      <content type="html"><![CDATA[<h3 id="1、官网下载mysql-utilities工具"><a href="#1、官网下载mysql-utilities工具" class="headerlink" title="1、官网下载mysql-utilities工具"></a>1、官网下载mysql-utilities工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com/archives/mysql-utilities/mysql-utilities-1.6.5.tar.gz</span><br></pre></td></tr></table></figure><h3 id="2、解压mysql-utilities工具："><a href="#2、解压mysql-utilities工具：" class="headerlink" title="2、解压mysql-utilities工具："></a>2、解压mysql-utilities工具：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-utilities-1.6.5.tar.gz</span><br><span class="line">cd mysql-utilities-1.6.5/</span><br><span class="line">cd scripts/</span><br><span class="line">[root@dax-mysql-slave scripts]# ls</span><br><span class="line">mysqlauditadmin.py  mysqlbinlogpurge.py   mysqldbcopy.py    mysqldiff.py       mysqlfrm.py         mysqlmetagrep.py   mysqlrpladmin.py  mysqlrplshow.py      mysqlserverinfo.py  mysqluserclone.py</span><br><span class="line">mysqlauditgrep.py   mysqlbinlogrotate.py  mysqldbexport.py  mysqldiskusage.py  mysqlgrants.py      mysqlprocgrep.py   mysqlrplcheck.py  mysqlrplsync.py      mysqlslavetrx.py</span><br><span class="line">mysqlbinlogmove.py  mysqldbcompare.py     mysqldbimport.py  mysqlfailover.py   mysqlindexcheck.py  mysqlreplicate.py  mysqlrplms.py     mysqlserverclone.py  mysqluc.py</span><br></pre></td></tr></table></figure><p>在scripts目录下存在mysqldiff和mysqldbcompare用于比对数据的脚本</p><h3 id="3、使用mysqldbcompare需要安装connector-python依赖关系："><a href="#3、使用mysqldbcompare需要安装connector-python依赖关系：" class="headerlink" title="3、使用mysqldbcompare需要安装connector-python依赖关系："></a>3、使用mysqldbcompare需要安装connector-python依赖关系：</h3><p>官网下载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com/archives/mysql-connector-python-2.2/mysql-connector-python-2.2.3-0.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mysql-connector-python-2.2.3-0.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p><h3 id="4、安装完成之后测试mysqldbcompare能否正常使用："><a href="#4、安装完成之后测试mysqldbcompare能否正常使用：" class="headerlink" title="4、安装完成之后测试mysqldbcompare能否正常使用："></a>4、安装完成之后测试mysqldbcompare能否正常使用：</h3><p> ./mysqldbcompare.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;./mysqldbcompare.py&quot;, line 28, in &lt;module&gt;</span><br><span class="line">    from mysql.utilities.common.tools import check_python_version</span><br><span class="line">ImportError: No module named utilities.common.tools</span><br></pre></td></tr></table></figure></p><p>将python2.7下的模块，软连接到lib64目录下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/lib/python2.7/site-packages/mysql/utilities /usr/lib64/python2.7/site-packages/mysql/utilities</span><br></pre></td></tr></table></figure></p><p>重新测试mysqldbcompare能否正常使用：<br>./mysqldbcompare.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Usage: mysqldbcompare --server1=user:pass@host:port:socket --server2=user:pass@host:port:socket db1:db2</span><br><span class="line"></span><br><span class="line">mysqldbcompare: error: You must specify at least one database to compare or use the --all option to compare all databases.</span><br></pre></td></tr></table></figure></p><p>提示需要指定对表的库：<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306:/data/mysql/tmp/mysql.sock –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306:/data/mysql/tmp/mysql.sock test:test<br>或者<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test:test<br>执行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test on server1 and test on server2</span><br><span class="line">#</span><br><span class="line">ERROR: The list of objects differs among database test and test.</span><br></pre></td></tr></table></figure></p><h3 id="5、准备测试数据："><a href="#5、准备测试数据：" class="headerlink" title="5、准备测试数据："></a>5、准备测试数据：</h3><p>server1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:40:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">|  6 |</span><br><span class="line">+----+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:40:  [test1]&gt; show create table test;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test  | CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>server2:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:37:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line"></span><br><span class="line">root@db 06:20:  [test1]&gt; show create table test</span><br><span class="line">    -&gt; ;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test  | CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h3 id="6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来："><a href="#6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来：" class="headerlink" title="6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来："></a>6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来：</h3><p>./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1:test1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing `test1` to `test1`                                     [PASS]</span><br><span class="line"># Comparing `test1`.`aa` to `test1`.`aa`                           [PASS]</span><br><span class="line"># Comparing `test1`.`test` to `test1`.`test`                       [PASS]</span><br><span class="line"># Success. All objects are the same.</span><br></pre></td></tr></table></figure></p><p>单独对比某一张表：<br>./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1.test:test1.test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing test1.test to test1.test                               [PASS]</span><br><span class="line"># Success. All objects are the same.</span><br></pre></td></tr></table></figure></p><h3 id="7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测："><a href="#7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测：" class="headerlink" title="7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测："></a>7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测：</h3><p>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    ERROR: Row counts are not the same among `test1`.`test` and `test1`.`test`.</span><br><span class="line">#</span><br></pre></td></tr></table></figure></p><p>提示test1库下面的test表数据不一致。</p><h3 id="8、创建测试数据，表结构不同，数据内容相同："><a href="#8、创建测试数据，表结构不同，数据内容相同：" class="headerlink" title="8、创建测试数据，表结构不同，数据内容相同："></a>8、创建测试数据，表结构不同，数据内容相同：</h3><p>server1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table test1 (id int(10) primary key);</span><br><span class="line">insert into test1 values (1),(2),(3),(4),(5);</span><br><span class="line">select * from test1;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure></p><p>server2:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table test1 (id bigint(20));</span><br><span class="line">insert into test1 values (1),(2),(3),(4),(5);</span><br><span class="line">root@db 06:28:  [test1]&gt; select * from test1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">|    5 |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure></p><h3 id="9、使用mysqldiff检测："><a href="#9、使用mysqldiff检测：" class="headerlink" title="9、使用mysqldiff检测："></a>9、使用mysqldiff检测：</h3><p> ./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1.test1:test1.test1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing test1.test1 to test1.test1                             [FAIL]</span><br><span class="line"># Object definitions differ. (--changes-for=server1)</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">--- test1.test1</span><br><span class="line">+++ test1.test1</span><br><span class="line">@@ -1,4 +1,3 @@</span><br><span class="line"> CREATE TABLE `test1` (</span><br><span class="line">-  `id` int(10) NOT NULL,</span><br><span class="line">-  PRIMARY KEY (`id`)</span><br><span class="line">+  `id` bigint(20) DEFAULT NULL</span><br><span class="line"> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line"># Compare failed. One or more differences found.</span><br></pre></td></tr></table></figure></p><p>提示表结构存在差异。</p><h3 id="10、使用mysqldbcompare检测："><a href="#10、使用mysqldbcompare检测：" class="headerlink" title="10、使用mysqldbcompare检测："></a>10、使用mysqldbcompare检测：</h3><p>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    ERROR: Row counts are not the same among `test1`.`test` and `test1`.`test`.</span><br><span class="line">#</span><br></pre></td></tr></table></figure></p><p>当检测到异常之后会直接退出，不进行下面的比较，因此未检测到test1表的内容，加上-t（-t, –run-all-tests   do not abort when a diff test fails）参数，运行测试模式，遇到异常之后仍然执行下面的比较：<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql -t<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    -       </span><br><span class="line">#           - Compare table checksum                                FAIL    </span><br><span class="line">#           - Find row differences                                  FAIL    </span><br><span class="line">#</span><br><span class="line"># Row counts are not the same among `test1`.`test` and `test1`.`test`.</span><br><span class="line">#</span><br><span class="line"># Transformation for --changes-for=server1:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">DELETE FROM `test1`.`test` WHERE `ID` = &apos;6&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># TABLE     test1                                   FAIL    pass    -       </span><br><span class="line">#           - Compare table checksum                                FAIL    </span><br><span class="line">#           - Find row differences                                  SKIP    </span><br><span class="line">#</span><br><span class="line"># Transformation for --changes-for=server1:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">ALTER TABLE `test1`.`test1` </span><br><span class="line">  DROP PRIMARY KEY, </span><br><span class="line">  CHANGE COLUMN id id bigint(20) NULL;</span><br><span class="line"></span><br><span class="line"># The table test1 does not have an usable Index or primary key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Database consistency check failed.</span><br><span class="line">#</span><br><span class="line"># ...done</span><br></pre></td></tr></table></figure></p><h3 id="11、创建两个test库，server1比server2实例多一个gtid-test14的表："><a href="#11、创建两个test库，server1比server2实例多一个gtid-test14的表：" class="headerlink" title="11、创建两个test库，server1比server2实例多一个gtid_test14的表："></a>11、创建两个test库，server1比server2实例多一个gtid_test14的表：</h3><p>server1:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| articles       |</span><br><span class="line">| gtid_test10    |</span><br><span class="line">| gtid_test11    |</span><br><span class="line">| gtid_test12    |</span><br><span class="line">| gtid_test13    |</span><br><span class="line">| gtid_test14    |</span><br><span class="line">| gtid_test15    |</span><br><span class="line">| gtid_test2     |</span><br><span class="line">| gtid_test3     |</span><br><span class="line">| gtid_test4     |</span><br><span class="line">| gtid_test5     |</span><br><span class="line">| gtid_test6     |</span><br><span class="line">| gtid_test7     |</span><br><span class="line">| gtid_test8     |</span><br><span class="line">| gtid_test9     |</span><br><span class="line">| ratings        |</span><br><span class="line">+----------------+</span><br><span class="line">16 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>server2:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| articles       |</span><br><span class="line">| gtid_test10    |</span><br><span class="line">| gtid_test11    |</span><br><span class="line">| gtid_test12    |</span><br><span class="line">| gtid_test13    |</span><br><span class="line">| gtid_test15    |</span><br><span class="line">| gtid_test2     |</span><br><span class="line">| gtid_test3     |</span><br><span class="line">| gtid_test4     |</span><br><span class="line">| gtid_test5     |</span><br><span class="line">| gtid_test6     |</span><br><span class="line">| gtid_test7     |</span><br><span class="line">| gtid_test8     |</span><br><span class="line">| gtid_test9     |</span><br><span class="line">| ratings        |</span><br><span class="line">+----------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h3 id="12、使用mysqldiff测试："><a href="#12、使用mysqldiff测试：" class="headerlink" title="12、使用mysqldiff测试："></a>12、使用mysqldiff测试：</h3><p> ./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test:test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># WARNING: Objects in server1.test but not in server2.test:</span><br><span class="line">#        TABLE: gtid_test14</span><br><span class="line"># Compare failed. One or more differences found.</span><br></pre></td></tr></table></figure></p><p>提示server2.test库下不存在gtid_test14表。</p><h3 id="13、使用mysqldbcompare测试："><a href="#13、使用mysqldbcompare测试：" class="headerlink" title="13、使用mysqldbcompare测试："></a>13、使用mysqldbcompare测试：</h3><p> ./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test on server1 and test on server2</span><br><span class="line">#</span><br><span class="line">ERROR: The list of objects differs among database test and test.</span><br></pre></td></tr></table></figure></p><p>只会提示两个实例的test库有差异，并没有列出详细信息。在对比数据时可先使用mysqldiff工具检测两个server端的表结构是否一致，如果没有差异，再使用mysqldbcompare工具去检测表数据是否一致。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] 使用certbot为域名生成免费证书(apache版)</title>
      <link href="/2018/09/28/%E4%BD%BF%E7%94%A8certbot%E4%B8%BA%E5%9F%9F%E5%90%8D%E7%94%9F%E6%88%90%E5%85%8D%E8%B4%B9%E8%AF%81%E4%B9%A6(apache%E7%89%88)/"/>
      <url>/2018/09/28/%E4%BD%BF%E7%94%A8certbot%E4%B8%BA%E5%9F%9F%E5%90%8D%E7%94%9F%E6%88%90%E5%85%8D%E8%B4%B9%E8%AF%81%E4%B9%A6(apache%E7%89%88)/</url>
      <content type="html"><![CDATA[<h4 id="1、下载certbot"><a href="#1、下载certbot" class="headerlink" title="1、下载certbot"></a>1、下载certbot</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft</span><br><span class="line">wget https://dl.eff.org/certbot-auto</span><br><span class="line">chmod a+x certbot-auto</span><br></pre></td></tr></table></figure><h4 id="2、生成证书"><a href="#2、生成证书" class="headerlink" title="2、生成证书"></a>2、生成证书</h4><p>/data/soft/certbot-auto –apache certonly<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Could not choose appropriate plugin: The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Cannot find Apache executable apachectl&apos;,)</span><br><span class="line">The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Cannot find Apache executable apachectl&apos;,)</span><br></pre></td></tr></table></figure></p><h4 id="3、上面报错提示找不到执行路径，需要指定apache的路径"><a href="#3、上面报错提示找不到执行路径，需要指定apache的路径" class="headerlink" title="3、上面报错提示找不到执行路径，需要指定apache的路径"></a>3、上面报错提示找不到执行路径，需要指定apache的路径</h4><p>sudo env PATH=$PATH:/usr/local/apache2/bin ./certbot-auto –apache certonly<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Could not choose appropriate plugin: The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Could not find configuration root&apos;,)</span><br><span class="line">The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Could not find configuration root&apos;,)</span><br></pre></td></tr></table></figure></p><h4 id="4、上面报错提示找不到配置目录，需要指定–apache-server-root"><a href="#4、上面报错提示找不到配置目录，需要指定–apache-server-root" class="headerlink" title="4、上面报错提示找不到配置目录，需要指定–apache-server-root"></a>4、上面报错提示找不到配置目录，需要指定–apache-server-root</h4><p> sudo env PATH=$PATH:/usr/local/apache2/bin ./certbot-auto –apache –apache-server-root /usr/local/apache2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Plugins selected: Authenticator apache, Installer apache</span><br><span class="line">No names were found in your configuration files. Please enter in your domain</span><br><span class="line">name(s) (comma and/or space separated)  (Enter &apos;c&apos; to cancel): www.test.com</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">http-01 challenge for www.test.com</span><br><span class="line">Cleaning up challenges</span><br><span class="line">Unable to find a virtual host listening on port 80 which is currently needed for Certbot to prove to the CA that you control your domain. Please add a virtual host for port 80.</span><br></pre></td></tr></table></figure></p><h4 id="5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd-conf配置文件，添加上80端口，并重启apache"><a href="#5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd-conf配置文件，添加上80端口，并重启apache" class="headerlink" title="5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd.conf配置文件，添加上80端口，并重启apache"></a>5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd.conf配置文件，添加上80端口，并重启apache</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Listen 80</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;  </span><br><span class="line">    ServerAdmin test@test.example.com</span><br><span class="line">    ServerName  www.test.com</span><br><span class="line">    ServerAlias test</span><br><span class="line">    DocumentRoot /var/www/html </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><h4 id="6、重新生成证书，成功之后会在-etc-letsencrypt-live-ebank-cbibank-com目录下生成四个文件-pem文件和一个README文件"><a href="#6、重新生成证书，成功之后会在-etc-letsencrypt-live-ebank-cbibank-com目录下生成四个文件-pem文件和一个README文件" class="headerlink" title="6、重新生成证书，成功之后会在/etc/letsencrypt/live/ebank.cbibank.com目录下生成四个文件.pem文件和一个README文件"></a>6、重新生成证书，成功之后会在/etc/letsencrypt/live/ebank.cbibank.com目录下生成四个文件.pem文件和一个README文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</span><br></pre></td></tr></table></figure><h4 id="7、修改conf-httpd-conf文件"><a href="#7、修改conf-httpd-conf文件" class="headerlink" title="7、修改conf/httpd.conf文件"></a>7、修改conf/httpd.conf文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Include conf/extra/httpd-ssl.conf</span><br><span class="line">#LoadModule ssl_module modules/mod_ssl.so</span><br></pre></td></tr></table></figure><p>将这两行的#去掉</p><h4 id="8、配置conf-extra-httpd-ssl-conf文件，修改对应的域名和证书路径："><a href="#8、配置conf-extra-httpd-ssl-conf文件，修改对应的域名和证书路径：" class="headerlink" title="8、配置conf/extra/httpd-ssl.conf文件，修改对应的域名和证书路径："></a>8、配置conf/extra/httpd-ssl.conf文件，修改对应的域名和证书路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">DocumentRoot &quot;/var/www/html&quot;</span><br><span class="line">ServerName ebank.cbibank.com</span><br><span class="line">SSLEngine on</span><br><span class="line">SSLCertificateFile /etc/letsencrypt/live/ebank.cbibank.com/cert.pem</span><br><span class="line">SSLCertificateKeyFile /etc/letsencrypt/live/ebank.cbibank.com/privkey.pem</span><br><span class="line">SSLCertificateChainFile /etc/letsencrypt/live/ebank.cbibank.com/chain.pem</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><h4 id="9、修改完成后重启apache："><a href="#9、修改完成后重启apache：" class="headerlink" title="9、修改完成后重启apache："></a>9、修改完成后重启apache：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache2/bin/apachectl restart</span><br></pre></td></tr></table></figure><p>重启过程报错，无法关闭apache提示以下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p><p>在/usr/lib64/下面没有httpd的模块，yum安装mod_ssl：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mod_ssl</span><br></pre></td></tr></table></figure></p><p>安装完成之后在/usr/lib64/httpd/modules/下面会有mod_ssl.so<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib64/httpd/modules/mod_ssl.so</span><br><span class="line">ln -s /usr/lib64/httpd/modules/mod_ssl.so /usr/local/apache2/modules/mod_ssl.so</span><br></pre></td></tr></table></figure></p><p>再次尝试重启apache，报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so:undefined symbol: ap_global_mutex_create</span><br></pre></td></tr></table></figure></p><p>google了一下，有说yum安装的mod_ssl与apache的安装版本不兼容的问题，因此尝试使用对应版本的tar包将模块文件拷过去:<br>拷贝modules目录下的ssl目录和loggers的内容到/usr/local/apache2/modules/ssl目录下、拷贝include目录下的内容到/usr/local/apache2/modules/ssl目录下，拷贝完之后，在/usr/local/apache2/modules/ssl目录下执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache2/bin/apxs -a -i -c mod_ssl.c</span><br></pre></td></tr></table></figure></p><p>执行完成之后再次重启apache，依旧报错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so: undefined symbol: ssl_cmd_SSLPassPhraseDialog</span><br></pre></td></tr></table></figure></p><p>需要指定openssl路径，执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache2/bin/apxs -a -i -c -L/usr/lib/openssl/engines/lib -c *.c -lcrypto -lssl -ldl</span><br></pre></td></tr></table></figure></p><p>再次重启apache<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so:undefined symbol: ap_global_mutex_create</span><br></pre></td></tr></table></figure></p><p>重启apache依旧报错undefinedsymbol:ap_global_mutex_create，没找到任何解决办法，最后只能添加-enable-ssl参数，重新编译安装apache。</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql勿操作drop table之后，利用mysqldump备份和binlog恢复</title>
      <link href="/2018/09/26/mysql%20%E5%8B%BF%E6%93%8D%E4%BD%9Cdrop%20table%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%88%A9%E7%94%A8mysqldump%E5%A4%87%E4%BB%BD%E5%92%8Cbinlog%E5%8E%BB%E6%81%A2%E5%A4%8D/"/>
      <url>/2018/09/26/mysql%20%E5%8B%BF%E6%93%8D%E4%BD%9Cdrop%20table%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%88%A9%E7%94%A8mysqldump%E5%A4%87%E4%BB%BD%E5%92%8Cbinlog%E5%8E%BB%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<p>1、查看备份表数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:30:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure></p><p>2、查看当前binlog位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                       |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000036 |    80147 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-195:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>3、开始备份test1数据库下的test数据表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p12345678 test1 test --master-data=2 --single-transaction &gt; /data/test.dump</span><br></pre></td></tr></table></figure></p><p>4、查看备份数据文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> more /data/test.dump</span><br><span class="line">-- MySQL dump 10.13  Distrib 5.7.22, for linux-glibc2.12 (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost    Database: test1</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version5.7.22-log</span><br><span class="line"></span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!40101 SET NAMES utf8 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&apos;+00:00&apos; */;</span><br><span class="line">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&apos;NO_AUTO_VALUE_ON_ZERO&apos; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line">SET @MYSQLDUMP_TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;</span><br><span class="line">SET @@SESSION.SQL_LOG_BIN= 0;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- GTID state at the beginning of the backup </span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">SET @@GLOBAL.GTID_PURGED=&apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-195:1000036-1000040&apos;;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Position to start replication or point-in-time recovery from</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-binlog.000036&apos;, MASTER_LOG_POS=80147;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Table structure for table `test`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `test`;</span><br><span class="line">/*!40101 SET @saved_cs_client     = @@character_set_client */;</span><br><span class="line">/*!40101 SET character_set_client = utf8 */;</span><br><span class="line">CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Dumping data for table `test`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">LOCK TABLES `test` WRITE;</span><br><span class="line">/*!40000 ALTER TABLE `test` DISABLE KEYS */;</span><br><span class="line">INSERT INTO `test` VALUES (1),(2),(3);</span><br><span class="line">/*!40000 ALTER TABLE `test` ENABLE KEYS */;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">SET @@SESSION.SQL_LOG_BIN = @MYSQLDUMP_TEMP_LOG_BIN;</span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line"></span><br><span class="line">-- Dump completed on 2018-09-25  7:32:05</span><br></pre></td></tr></table></figure></p><p>5、备份完成之后插入新的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:34:  [test1]&gt; insert into test values(4);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>6、刷新binlog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; flush binary logs;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure></p><p>7、查看binlog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                          |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000037 |      326 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-196:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>8、在新的binlog文件里面再次插入一条数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; insert into test values(5);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure></p><p>9、查看当前测试的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:45:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>10、再次刷新binlog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:45:  [test1]&gt; flush binary logs;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@db 07:49:  [test1]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                          |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000038 |      326 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-197:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>11、删除测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:49:  [test1]&gt; drop table test;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure></p><p>12、根据备份文件获取测试表test的创建语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e&apos;/./&#123;H;$!d;&#125;&apos; -e &apos;x;/CREATE TABLE `test`/!d;q&apos; /data/test.dump</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `test`;</span><br><span class="line">/*!40101 SET @saved_cs_client     = @@character_set_client */;</span><br><span class="line">/*!40101 SET character_set_client = utf8 */;</span><br><span class="line">CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br></pre></td></tr></table></figure><p>13、获取测试表test的数据，并指定到数据文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &apos;INSERT INTO `test`&apos; /data/test.dump &gt; insert.sql</span><br></pre></td></tr></table></figure></p><p>cat insert.sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `test` VALUES (1),(2),(3);</span><br></pre></td></tr></table></figure></p><p>14、根据test.dump备份文件记录的log-file文件位置和log-pos参数，去获取未备份的关于test表的增删改数据：<br>从mysql-binlog.000036文件开始，–start-position=80147：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog  -v --base64-output=decode-rows --set-charset=UTF-8 --database=test1 --start-position=80147  mysql-binlog.000036  &gt; restore.sql</span><br></pre></td></tr></table></figure></p><p>15、获取test表被删除是的pos，文件为mysql-binlog.000038，位置为507：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS --set-charset=UTF-8  /data/mysql/log/mysql-binlog.000038 |grep DROP  -A15 -B15</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># at 326</span><br><span class="line">#180925  7:49:39 server id 3306101  end_log_pos 387 GTIDlast_committed=0sequence_number=1rbr_only=no</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:198&apos;/*!*/;</span><br><span class="line"># at 387</span><br><span class="line">#180925  7:49:39 server id 3306101  end_log_pos 507 Querythread_id=267exec_time=0error_code=0</span><br><span class="line">use `test1`/*!*/;</span><br><span class="line">SET TIMESTAMP=1537861779/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=267/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=0/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=29301/*!*/;</span><br><span class="line">/*!\C utf8 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=45/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">DROP TABLE `test` /* generated by server */</span><br><span class="line">/*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;AUTOMATIC&apos; /* added by mysqlbinlog */ /*!*/;</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure><p>16、在备份开始binlog文件和记录drop操作的binlog文件之间还存在一个mysql-binlog.000037文件，需要将该文件内记录的信息都导出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS --set-charset=UTF-8 mysql-binlog.000037 &gt;&gt; restore.sql</span><br></pre></td></tr></table></figure></p><p>17：将记录drop操作的binlog文件里面drop之前的信息导出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS --set-charset=UTF-8 --stop-position=507 mysql-binlog.000038 &gt;&gt; restore.sql</span><br></pre></td></tr></table></figure></p><p>18:对导出的文件进行筛选，过滤出test表的相关信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">more restore.sql |grep  --ignore-case -E &apos;insert|update|delete&apos; -A3|grep &apos;`test1`.`test`&apos; -A2</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">### INSERT INTO `test1`.`test`</span><br><span class="line">### SET</span><br><span class="line">###   @1=4</span><br><span class="line">--</span><br><span class="line">### INSERT INTO `test1`.`test`</span><br><span class="line">### SET</span><br><span class="line">###   @1=5</span><br></pre></td></tr></table></figure><p>将过滤出来的内容进行编辑，@1为第一列的列名，建议使用sublime或者vim进行批量编辑 ：<br>cat test_insert.sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `test1`.`test` SET   id=4  ;</span><br><span class="line">INSERT INTO `test1`.`test` SET   id=5  ;</span><br></pre></td></tr></table></figure></p><p>19、执行create table语句，并引用insert.sql和test_insert.sql文件，至此drop掉的test表被恢复。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Cassandra] cassandra安装部署及日常使用命令</title>
      <link href="/2018/09/14/cassandra%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/09/14/cassandra%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h3 id="1、添加yum源"><a href="#1、添加yum源" class="headerlink" title="1、添加yum源"></a>1、添加yum源</h3><p>vim /etc/yum.repos.d/cassandra.repo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[cassandra]</span><br><span class="line">name=Apache Cassandra</span><br><span class="line">baseurl=https://www.apache.org/dist/cassandra/redhat/311x/</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://www.apache.org/dist/cassandra/KEYS</span><br></pre></td></tr></table></figure></p><h3 id="2、安装cassandra数据库"><a href="#2、安装cassandra数据库" class="headerlink" title="2、安装cassandra数据库"></a>2、安装cassandra数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install cassandra -y</span><br></pre></td></tr></table></figure><h3 id="3、修改配置文件-etc-cassandra-conf-cassandra-yaml"><a href="#3、修改配置文件-etc-cassandra-conf-cassandra-yaml" class="headerlink" title="3、修改配置文件/etc/cassandra/conf/cassandra.yaml"></a>3、修改配置文件/etc/cassandra/conf/cassandra.yaml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cluster_name: &apos;My Cluster&apos;</span><br><span class="line">hints_directory: /data/cassandra/hints</span><br><span class="line">data_file_directories:     </span><br><span class="line">        - /data/cassandra/dbdata</span><br><span class="line">commitlog_directory: /data/cassandra/commitlog</span><br><span class="line">saved_caches_directory: /data/cassandra/caches</span><br><span class="line"></span><br><span class="line">         - seeds: &quot;10.10.8.3,10.10.8.4,10.10.8.5&quot;</span><br><span class="line">listen_address: dax-mysql-mha</span><br><span class="line">rpc_address: dax-mysql-mha</span><br></pre></td></tr></table></figure><p>每个节点需要修改的基本参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster_name:修改集群名称</span><br><span class="line">修改存放目录hint、data、log</span><br><span class="line">seeds:添加节点ip</span><br><span class="line">listen_address：修改为本地ip地址</span><br><span class="line">rpc_address：修改为本地ip地址</span><br></pre></td></tr></table></figure></p><p>配置文件部分参数解释：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cluster_name: &apos;Test Cluster&apos;</span><br><span class="line">storage_port: 7000</span><br><span class="line">listen_address: dax-mysql-mha</span><br><span class="line">start_native_transport: true              #开启native协议 </span><br><span class="line">native_transport_port: 9042              #客户端的交互端口 </span><br><span class="line">data_file_directories:</span><br><span class="line">    - /data/cassandra/dbdata              # 数据位置，多盘的话可以写多个目录 </span><br><span class="line">commitlog_directory:</span><br><span class="line">    - /data/cassandra/commitlog          #commitlog的路径，与data目录分开磁盘，提高性能</span><br><span class="line">saved_caches_directory:</span><br><span class="line">    - /data/cassandra/caches              #缓存数据目录 </span><br><span class="line">commitlog_sync: batch                    #批量记录commitlog，每隔一段时间将数据commitlog</span><br><span class="line">commitlog_sync_batch_window_in_ms: 2      #batch模式下，批量操作缓存的时间间隔</span><br><span class="line">#commitlog_sync: periodic                #周期记录commitlog，每一次有数据更新都commitlog</span><br><span class="line">#commitlog_sync_period_in_ms: 10000      #periodic模式，刷新commitlog的时间间隔</span><br><span class="line"> rpc_address: dax-mysql-mha</span><br></pre></td></tr></table></figure></p><h3 id="4、创建配置文件内指定的相关目录："><a href="#4、创建配置文件内指定的相关目录：" class="headerlink" title="4、创建配置文件内指定的相关目录："></a>4、创建配置文件内指定的相关目录：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/cassandra/hints</span><br><span class="line">mkdir -p /data/cassandra/dbdata</span><br><span class="line">mkdir -p /data/cassandra/commitlog</span><br><span class="line">mkdir -p /data/cassandra/caches</span><br><span class="line">chmod 777 -R /data/cassandra</span><br></pre></td></tr></table></figure><h3 id="5、启动数据库，并添加到开机启动："><a href="#5、启动数据库，并添加到开机启动：" class="headerlink" title="5、启动数据库，并添加到开机启动："></a>5、启动数据库，并添加到开机启动：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service cassandra start</span><br><span class="line">chkconfig cassandra on</span><br></pre></td></tr></table></figure><p>查看运行状态<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodetool status</span><br></pre></td></tr></table></figure></p><p>进入控制台,9042端口为默认控制台端口，可自行修改配置文件设置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cqlsh ip 9042</span><br></pre></td></tr></table></figure></p><h3 id="6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改："><a href="#6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改：" class="headerlink" title="6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改："></a>6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">进入控制台：</span><br><span class="line">UPDATE system.local SET cluster_name = &apos;daxcluster&apos; where key=&apos;local&apos;;</span><br><span class="line">bash $ ./nodetool flush</span><br><span class="line">修改cassandra.yaml配置文件cluster配置参数</span><br><span class="line">cluster_name: &apos;daxcluster&apos;</span><br><span class="line">重启cassandra</span><br><span class="line">/etc/init.d/cassandra restart</span><br></pre></td></tr></table></figure><h3 id="7、给数据库设置用户名密码"><a href="#7、给数据库设置用户名密码" class="headerlink" title="7、给数据库设置用户名密码"></a>7、给数据库设置用户名密码</h3><p>1）、首先修改配置文件 cassandra.yaml<br>把默认的authenticator: AllowAllAuthenticator运行所有人登录设置为用密码登录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authenticator: PasswordAuthenticator</span><br></pre></td></tr></table></figure></p><p>2）、登录cassandra创建用户<br>使用默认账户登录cassandra<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cqlsh -ucassandra -pcassandra ip 9042</span><br></pre></td></tr></table></figure></p><p>创建用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER test WITH PASSWORD &apos;test&apos; SUPERUSER;</span><br></pre></td></tr></table></figure></p><p>3）、使用新用户登录<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cqlsh -utest -ptest ip 9042</span><br></pre></td></tr></table></figure></p><p>删除默认帐号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP USER cassandra;</span><br></pre></td></tr></table></figure></p><p>4）、java使用用户名密码访问cassandra<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cluster cluster = Cluster.builder()</span><br><span class="line">.addContactPoint(<span class="string">"192.168.22.161"</span>)</span><br><span class="line">.withCredentials(<span class="string">"myusername"</span>, <span class="string">"mypassword"</span>)</span><br><span class="line">.build();</span><br></pre></td></tr></table></figure></p><h3 id="8、账号权限分配命令"><a href="#8、账号权限分配命令" class="headerlink" title="8、账号权限分配命令"></a>8、账号权限分配命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">授权：</span><br><span class="line">GRANT permission_name PERMISSION ON resource TO user_name;</span><br><span class="line">GRANT ALL PERMISSIONS ON resource TO user_name;</span><br><span class="line">收回权限：</span><br><span class="line">REVOKE permission_name PERMISSION ON resource FROM user_name;</span><br><span class="line">REVOKE ALL PERMISSIONS ON resource FROM user_name;</span><br><span class="line">查看权限：</span><br><span class="line">LIST permission_name PERMISSION ON resource OF user_name NORECURSIVE;</span><br><span class="line">LIST ALL PERMISSIONS ON resource OF user_name NORECURSIVE;</span><br><span class="line">其中，</span><br><span class="line">permission_name为：  ALL/ALTER/AUTHORIZE/CREATE/DROP/MODIFY/SELECT</span><br><span class="line">resource为：ALL KEYSPACES/KEYSPACE keyspace_name/TABLE keyspace_name.table_name</span><br></pre></td></tr></table></figure><h3 id="9、其他使用命令："><a href="#9、其他使用命令：" class="headerlink" title="9、其他使用命令："></a>9、其他使用命令：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">desc KEYSPACEs</span><br><span class="line">枚举所有数据库</span><br><span class="line">list users;</span><br><span class="line">查看所有用户</span><br><span class="line">show version;</span><br><span class="line">显示当前cqlsh,cassandra，cql spec,native protocol 版本信息</span><br><span class="line">show host;</span><br><span class="line">显示当前集群节点的ip地址和端口</span><br><span class="line">SHOW SESSION &lt;session id&gt;</span><br><span class="line">跟踪一个会话信息</span><br><span class="line">SOURCE &apos;/home/thobbs/commands.cql&apos;</span><br><span class="line">读取文件内容，执行cql语句</span><br><span class="line">CAPTURE &apos;&lt;file&gt;&apos;;</span><br><span class="line">将会话查询内容指定到一个文件内</span><br><span class="line">CAPTURE OFF;</span><br><span class="line">停止将查询结果指定到文件内，使其正常输出到屏幕上</span><br><span class="line">CAPTURE;</span><br><span class="line">查看当前抓取信息是否指定到什么目录下</span><br></pre></td></tr></table></figure><h3 id="10、如果nodetool-decommission命令将某节点提出-执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。"><a href="#10、如果nodetool-decommission命令将某节点提出-执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。" class="headerlink" title="10、如果nodetool decommission命令将某节点提出,执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。"></a>10、如果nodetool decommission命令将某节点提出,执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。</h3>]]></content>
      
      
        <tags>
            
            <tag> Cassandra </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mgr从节点down恢复过程遇到的问题</title>
      <link href="/2018/09/14/mysql%20mgr%E4%BB%8E%E8%8A%82%E7%82%B9down%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/14/mysql%20mgr%E4%BB%8E%E8%8A%82%E7%82%B9down%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h3 id="1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1-2）断掉，3节点被踢出了集群"><a href="#1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1-2）断掉，3节点被踢出了集群" class="headerlink" title="1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1,2）断掉，3节点被踢出了集群"></a>1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1,2）断掉，3节点被踢出了集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-2:3306 has become unreachable.&apos;</span><br><span class="line">[Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-1:3306 has become unreachable.&apos;</span><br><span class="line"> [ERROR] Plugin group_replication reported: &apos;Member was expelled from the group due to network failures, changing member status to ERROR.&apos;</span><br></pre></td></tr></table></figure><h3 id="2、登录节点3尝试重新启动group-replication："><a href="#2、登录节点3尝试重新启动group-replication：" class="headerlink" title="2、登录节点3尝试重新启动group_replication："></a>2、登录节点3尝试重新启动group_replication：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;stop group_replicaiton;</span><br><span class="line">mysql&gt;start group_replication;</span><br></pre></td></tr></table></figure><h3 id="3、查看集群成员状态"><a href="#3、查看集群成员状态" class="headerlink" title="3、查看集群成员状态"></a>3、查看集群成员状态</h3><p>SELECT * FROM performance_schema.replication_group_members;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 6a41c0b6-8e3d-11e8-b076-000d3aa05296 | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 71540a17-8e3d-11e8-8cee-000d3aa1d767 | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e | wallet-mysql-3 |        3306 | RECOVERING       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br></pre></td></tr></table></figure></p><h3 id="4、节点3正在进行恢复，与主库同步数据，但是恢复过程error-log出现了以下问题："><a href="#4、节点3正在进行恢复，与主库同步数据，但是恢复过程error-log出现了以下问题：" class="headerlink" title="4、节点3正在进行恢复，与主库同步数据，但是恢复过程error.log出现了以下问题："></a>4、节点3正在进行恢复，与主库同步数据，但是恢复过程error.log出现了以下问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">[ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br></pre></td></tr></table></figure><p>提示无法读取主库的binary log</p><h3 id="5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr："><a href="#5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr：" class="headerlink" title="5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr："></a>5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr：</h3><h4 id="5-1、节点2操作："><a href="#5-1、节点2操作：" class="headerlink" title="5.1、节点2操作："></a>5.1、节点2操作：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;/data/mysql/bin/mysqldump --all-databases --set-gtid-purged=ON --single-transaction -uroot -P3306 -p &gt; /tmp/alldb.sql</span><br></pre></td></tr></table></figure><p>拷贝alldb.sql到节点3的/tmp目录</p><h4 id="5-2、节点3操作："><a href="#5-2、节点3操作：" class="headerlink" title="5.2、节点3操作："></a>5.2、节点3操作：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;stop group_replication;</span><br><span class="line">mysql&gt;reset master;</span><br><span class="line">mysql&gt;set global read_only=0;</span><br><span class="line">mysql&gt;source /tmp/alldb.sql</span><br></pre></td></tr></table></figure><p>重新启动mysql数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br></pre></td></tr></table></figure></p><p>将节点3加入mgr集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;start group_replication;</span><br></pre></td></tr></table></figure></p><p>查看集群成员状态，集群状态恢复：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 6a41c0b6-8e3d-11e8-b076-000d3aa05296 | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 71540a17-8e3d-11e8-8cee-000d3aa1d767 | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] Multi-threaded slave statistics for channel</title>
      <link href="/2018/09/13/Multi-threaded%20slave%20statistics%20for%20channel%20&#39;group_replication_applier&#39;/"/>
      <url>/2018/09/13/Multi-threaded%20slave%20statistics%20for%20channel%20&#39;group_replication_applier&#39;/</url>
      <content type="html"><![CDATA[<h3 id="0、从库error日志提示信息如下："><a href="#0、从库error日志提示信息如下：" class="headerlink" title="0、从库error日志提示信息如下："></a>0、从库error日志提示信息如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] Multi-threaded slave statistics for channel &apos;group_replication_applier&apos;: seconds elapsed = 267; events assigned = 10241; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 0; waited at clock conflicts = 981623300 waited (count) when Workers occupied = 1238 waited when Workers occupied = 6762438500</span><br></pre></td></tr></table></figure><h3 id="1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded-slave）需要启用slave-parallel-workers参数（默认值为0，最大值为1024），并且log-warning（该参数将于v8-0-3去除，被log-error-verbosity-替代）参数要大于1，在error-log里面会有上述提示。"><a href="#1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded-slave）需要启用slave-parallel-workers参数（默认值为0，最大值为1024），并且log-warning（该参数将于v8-0-3去除，被log-error-verbosity-替代）参数要大于1，在error-log里面会有上述提示。" class="headerlink" title="1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded slave）需要启用slave_parallel_workers参数（默认值为0，最大值为1024），并且log_warning（该参数将于v8.0.3去除，被log_error_verbosity 替代）参数要大于1，在error_log里面会有上述提示。"></a>1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded slave）需要启用slave_parallel_workers参数（默认值为0，最大值为1024），并且log_warning（该参数将于v8.0.3去除，被log_error_verbosity 替代）参数要大于1，在error_log里面会有上述提示。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seconds elapsed 就是上一次统计跟这一次统计的时间间隔。</span><br><span class="line">events assigned：总共有多少个event被分配执行，计的是总数。</span><br><span class="line">worker queues filled over overrun level：mts在所有的并行workers之间倾向于加载平衡的时间。slave_parrllel_workers参数决定workers数量。这个统计参数显示了当前线程承受的饱和等级。如果以一个并行线程序列趋近与饱和，这个数会递增，线程复制时间会被推迟，避免达到线程序列限制。</span><br><span class="line">Waited due to a Worker queue full：因为worker队列爆满，协调线程必须等待该统计参数会增长</span><br><span class="line">Waited due to the total size:该参数代表因为达到了可用内存的限制，worker队列持有未应用事件造成协调线程睡眠的次数。如果这个值持续增长，需要增大slave_pending_jobs_size_max值来避免协调线程等待时间。</span><br><span class="line">slave_pending_jobs_size_max：此变量代表用于保存尚未应用的事件的从worker队列的最大内存量（以字节为单位），如果没有启动mts，修改该参数不会有任何效果。（v8.0.11之前默认值为16M,v8.0.12默认值为128M，最小值为1024，最大值为16eib）</span><br><span class="line">Waited at clock conflicts:在事务之间存在依赖的情况下，该参数显示等待时间相当于冲突检测和解决方案的逻辑时间。</span><br><span class="line">Waited (count) when used occupied:协调进程监控worker足额（enough）分配的统计次数。enough定义取决于调度类型（基于每个库和时钟）</span><br><span class="line">Waited when workers occupied:对任何可用worker计算协调线程等待的次数，仅适用于提交时钟调度程序。</span><br></pre></td></tr></table></figure><p><a href="https://www.percona.com/blog/2017/07/19/multi-threaded-slave-statistics/" target="_blank" rel="noopener">参考文档</a></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql切割慢日志</title>
      <link href="/2018/09/12/mysql%20%E5%88%87%E5%89%B2%E6%85%A2%E6%97%A5%E5%BF%97%E5%8F%A6%E9%99%84%E5%AE%9A%E6%9C%9F%E5%88%87%E5%89%B2%E6%97%A5%E5%BF%97%E8%84%9A%E6%9C%AC/"/>
      <url>/2018/09/12/mysql%20%E5%88%87%E5%89%B2%E6%85%A2%E6%97%A5%E5%BF%97%E5%8F%A6%E9%99%84%E5%AE%9A%E6%9C%9F%E5%88%87%E5%89%B2%E6%97%A5%E5%BF%97%E8%84%9A%E6%9C%AC/</url>
      <content type="html"><![CDATA[<h3 id="0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割："><a href="#0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割：" class="headerlink" title="0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割："></a>0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">split几个主要参数：</span><br><span class="line">-b 分割后的文档大小，单位是byte</span><br><span class="line">-C 分割后的文档，单行最大byte数</span><br><span class="line">-d 使用数字作为后缀，同时使用-a length指定后缀长度</span><br><span class="line">-l 分割后文档的行数</span><br></pre></td></tr></table></figure><h3 id="1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test-log，不指定后缀会使用默认后缀名aa-ab-ac…-等"><a href="#1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test-log，不指定后缀会使用默认后缀名aa-ab-ac…-等" class="headerlink" title="1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test.log，不指定后缀会使用默认后缀名aa,ab,ac….等"></a>1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test.log，不指定后缀会使用默认后缀名aa,ab,ac….等</h3><p>split slow.log -b 1G test.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -ltrh test.log*</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:08 test.logaa</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:09 test.logab</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:10 test.logac</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:11 test.logad</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:12 test.logae</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:13 test.logaf</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:14 test.logag</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:15 test.logah</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:16 test.logai</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:17 test.logaj</span><br><span class="line">-rw-r--r-- 1 root  root  270M Sep 12 03:17 test.logak</span><br></pre></td></tr></table></figure></p><h3 id="2、如果需要指定后缀可使用-d-a-参数（n）代表指定附加后缀的个数，比如切割test-logaa日志文件："><a href="#2、如果需要指定后缀可使用-d-a-参数（n）代表指定附加后缀的个数，比如切割test-logaa日志文件：" class="headerlink" title="2、如果需要指定后缀可使用-d -a  参数（n）代表指定附加后缀的个数，比如切割test.logaa日志文件："></a>2、如果需要指定后缀可使用-d -a <n> 参数（n）代表指定附加后缀的个数，比如切割test.logaa日志文件：</n></h3><p>split test.logaa -b 100M -d -a 2 logaa<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> ll logaa*</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa00</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa01</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa02</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa03</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa04</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa05</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa06</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa07</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa08</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:04 logaa09</span><br><span class="line">-rw-r--r-- 1 root root  24M Sep 12 09:04 logaa10</span><br></pre></td></tr></table></figure></p><p>split test.logab -b 100M -d -a 4 logab<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -ltrh logab*</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0000</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0001</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0002</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0003</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0004</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0005</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0006</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0007</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:06 logab0008</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:06 logab0009</span><br><span class="line">-rw-r--r-- 1 root root  24M Sep 12 09:06 logab0010</span><br></pre></td></tr></table></figure></p><h3 id="4、按行切割日志文件，查看准备切割的文件有多少行："><a href="#4、按行切割日志文件，查看准备切割的文件有多少行：" class="headerlink" title="4、按行切割日志文件，查看准备切割的文件有多少行："></a>4、按行切割日志文件，查看准备切割的文件有多少行：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat logab0001 |wc -l</span><br><span class="line">505</span><br></pre></td></tr></table></figure><p>按每个文件60行切割<br>split logab0001 -l 60 logab0001<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ll logab0001*</span><br><span class="line">-rw-r--r-- 1 root root 104857600 Sep 12 09:05 logab0001</span><br><span class="line">-rw-r--r-- 1 root root  11922880 Sep 12 09:10 logab0001aa</span><br><span class="line">-rw-r--r-- 1 root root  12506422 Sep 12 09:10 logab0001ab</span><br><span class="line">-rw-r--r-- 1 root root  12506026 Sep 12 09:10 logab0001ac</span><br><span class="line">-rw-r--r-- 1 root root  12506635 Sep 12 09:10 logab0001ad</span><br><span class="line">-rw-r--r-- 1 root root  12506065 Sep 12 09:10 logab0001ae</span><br><span class="line">-rw-r--r-- 1 root root  12506313 Sep 12 09:10 logab0001af</span><br><span class="line">-rw-r--r-- 1 root root  12506206 Sep 12 09:10 logab0001ag</span><br><span class="line">-rw-r--r-- 1 root root  12506325 Sep 12 09:10 logab0001ah</span><br><span class="line">-rw-r--r-- 1 root root   5390728 Sep 12 09:10 logab0001ai</span><br></pre></td></tr></table></figure></p><p>查看每个文件的行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">for i in `ls logab0001*`;do echo &quot;$i文件行数&quot;`cat $i|wc -l` ;done </span><br><span class="line">logab0001文件行数505</span><br><span class="line">logab0001aa文件行数60</span><br><span class="line">logab0001ab文件行数60</span><br><span class="line">logab0001ac文件行数60</span><br><span class="line">logab0001ad文件行数60</span><br><span class="line">logab0001ae文件行数60</span><br><span class="line">logab0001af文件行数60</span><br><span class="line">logab0001ag文件行数60</span><br><span class="line">logab0001ah文件行数60</span><br><span class="line">logab0001ai文件行数25</span><br></pre></td></tr></table></figure></p><h3 id="5、按每行字节数切割"><a href="#5、按每行字节数切割" class="headerlink" title="5、按每行字节数切割"></a>5、按每行字节数切割</h3><p>指定每行字节数最多不超过2000000个字节<br>split logab0001aa -C 2000000 testlog<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -lthr testlog*</span><br><span class="line">-rw-r--r-- 1 root root  1.5M Sep 12 10:19 testlogaa</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogab</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogac</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogad</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogae</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogaf</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogag</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogah</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogai</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogaj</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogak</span><br></pre></td></tr></table></figure></p><p>查看某一行的字节数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-slave log]# sed &apos;1p&apos; testlogaa|wc -c</span><br><span class="line">1960374</span><br></pre></td></tr></table></figure></p><p>字节数小于2000000<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf testlog*</span><br></pre></td></tr></table></figure></p><p>删除生成的日志文件，生成每行字节最大不超过1500000的日志文件：<br>split logab0001aa -C 1500000 testlog<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ls -lthr testlog*</span><br><span class="line">-rw-r--r-- 1 root root  449K Sep 12 10:22 testlogaa</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogab</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogac</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogad</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogae</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogaf</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogag</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogah</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogai</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogaj</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogak</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogal</span><br></pre></td></tr></table></figure></p><p>查看某一行的字节数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-slave log]# sed &apos;1p&apos; testlogaa|wc -c</span><br><span class="line">918219</span><br></pre></td></tr></table></figure></p><p>字节数小于1500000</p><h3 id="6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割："><a href="#6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割：" class="headerlink" title="6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割："></a>6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#mysql慢日志所在路径</span><br><span class="line">slowlogpath=/data/mysql/log</span><br><span class="line">#mysql慢日志文件名</span><br><span class="line">slowlogname=slow.log</span><br><span class="line">#当前系统时间</span><br><span class="line">stamp=`date +&apos;%Y%m%d&apos;`</span><br><span class="line">#与当前系统时间对比，七天前的时间</span><br><span class="line">oldstamp=`date +&quot;%Y%m%d&quot; -d &quot;-7 day&quot;`</span><br><span class="line">#mysql用户名</span><br><span class="line">username=root</span><br><span class="line">#mysql用户名密码</span><br><span class="line">password=12345678</span><br><span class="line">#mysql安装路径</span><br><span class="line">dbpath=/data/mysql/bin</span><br><span class="line">#移动mysql慢日志</span><br><span class="line">mv $&#123;slowlogpath&#125;/$&#123;slowlogname&#125;  $&#123;slowlogpath&#125;/$&#123;stamp&#125;_$&#123;slowlogname&#125;</span><br><span class="line">#重新生成slow日志文件：</span><br><span class="line">$&#123;dbpath&#125;/mysqladmin -u $&#123;username&#125; -p$&#123;password&#125; flush-logs slow</span><br><span class="line">#删除7天前的日志文件</span><br><span class="line">if [ -e $&#123;slowlogpath&#125;/$&#123;oldstamp&#125;_$&#123;slowlogname&#125; ];then</span><br><span class="line">   sudo rm -rf $&#123;slowlogpath&#125;/$&#123;oldstamp&#125;_$&#123;slowlogname&#125;</span><br><span class="line">else</span><br><span class="line">   :</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>将脚本添加到定时任务：<br>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/script/split_mysqlslowlog.sh</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysqldumpslow参数详解</title>
      <link href="/2018/09/12/mysqldumpslow%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/09/12/mysqldumpslow%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。"><a href="#1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。" class="headerlink" title="1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。"></a>1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。</h3><p>mysqldumpslow解析慢日志文件并打印出内容摘要。<br>mysqldumpslow进行分组查询，除了有特殊数值和字符串数据值之外。当现实摘要输出是，将数值抽象化为n（数字）和s（字符串）。参数-a和-n可以用于修改抽象化行为。</p><h3 id="0、-a-表示不使用抽象的字符串s，数字n替换查询sql语句的内容"><a href="#0、-a-表示不使用抽象的字符串s，数字n替换查询sql语句的内容" class="headerlink" title="0、-a 表示不使用抽象的字符串s，数字n替换查询sql语句的内容"></a>0、-a 表示不使用抽象的字符串s，数字n替换查询sql语句的内容</h3><p>不指定-a参数，查询结果中数值和字符串分别用n和s代替<br>/data/mysql/bin/mysqldumpslow -t 2  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=132.03s (924s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=81.63s (571s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br></pre></td></tr></table></figure></p><p>添加-a参数，查询结果中数值和字符串用各自的对应值表示，未被抽象化：<br>/data/mysql/bin/mysqldumpslow -a -t 2  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 1  Time=244.60s (244s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT 1,1000000) as tmp)</span><br><span class="line">Count: 1  Time=230.44s (230s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT 4000000,1000000) as tmp)</span><br></pre></td></tr></table></figure></p><h3 id="2、-n-名称中抽象化数字的最少个数"><a href="#2、-n-名称中抽象化数字的最少个数" class="headerlink" title="2、-n 名称中抽象化数字的最少个数"></a>2、-n 名称中抽象化数字的最少个数</h3><h3 id="3、–debug-写入调试信息"><a href="#3、–debug-写入调试信息" class="headerlink" title="3、–debug 写入调试信息"></a>3、–debug 写入调试信息</h3><h3 id="4、-g-后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字："><a href="#4、-g-后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字：" class="headerlink" title="4、-g 后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字："></a>4、-g 后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字：</h3><p>/data/mysql/bin/mysqldumpslow -t 5 -l -g ‘test’  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 1  Time=44.68s (44s)  Lock=0.00s (0s)  Rows=2.0 (2), root[root]@localhost</span><br><span class="line">  select distinct state from test  order by id</span><br><span class="line">Count: 2  Time=27.04s (54s)  Lock=0.00s (0s)  Rows=2.0 (4), root[root]@localhost</span><br><span class="line">  select distinct state from test where id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br></pre></td></tr></table></figure></p><h3 id="5、–help-显示帮助信息并退出"><a href="#5、–help-显示帮助信息并退出" class="headerlink" title="5、–help 显示帮助信息并退出"></a>5、–help 显示帮助信息并退出</h3><h3 id="6、-h-日志文件名中服务的主机名"><a href="#6、-h-日志文件名中服务的主机名" class="headerlink" title="6、-h 日志文件名中服务的主机名"></a>6、-h 日志文件名中服务的主机名</h3><p>使用-h hostname参数，可使用通配符去过滤慢日志<br>查看当前目录下的慢日志文件名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ll *-slow.log</span><br><span class="line">-rw-r--r-- 1 root  root   583 Sep 12 06:21 10.0.7.4-slow.log</span><br><span class="line">-rw-r----- 1 mysql mysql 1889 Sep 12 05:51 test-slow.log</span><br></pre></td></tr></table></figure></p><p>如果使用<em>-slow.log去过滤慢日志，会把所有-slow.log为后缀的文件都过滤。<br>mysqldumpslow -a -t 20 -h dax-mysql-slave  /data/mysql/log/</em>-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/10.0.7.4-slow.log /data/mysql/log/test-slow.log</span><br><span class="line">Count: 1  Time=137.68s (137s)  Lock=0.00s (0s)  Rows=5.0 (5), root[root]@localhost</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 5</span><br><span class="line">Count: 1  Time=120.01s (120s)  Lock=0.00s (0s)  Rows=15.0 (15), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 20</span><br><span class="line">Count: 2  Time=90.84s (181s)  Lock=0.00s (0s)  Rows=10.0 (20), 2users@2hosts</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 10</span><br><span class="line">Count: 1  Time=82.82s (82s)  Lock=0.00s (0s)  Rows=12.0 (12), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 12</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 5.</span><br></pre></td></tr></table></figure></p><p>也可以指定匹配主机范围：<br>mysqldumpslow -a -t 20 -h dax-mysql-slave  /data/mysql/log/10.0.7.*-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/10.0.7.4-slow.log</span><br><span class="line">Count: 1  Time=82.82s (82s)  Lock=0.00s (0s)  Rows=12.0 (12), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 12</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 1.</span><br></pre></td></tr></table></figure></p><p>-h 后面如果不加任何参数，会匹配出test-slow.log为日志文件名的日志：<br>[root@dax-mysql-slave log]# mysqldumpslow -a -t 20 -h   /data/mysql/log/*-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/test-slow.log</span><br><span class="line">Count: 1  Time=137.68s (137s)  Lock=0.00s (0s)  Rows=5.0 (5), root[root]@localhost</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 5</span><br><span class="line">Count: 1  Time=120.01s (120s)  Lock=0.00s (0s)  Rows=15.0 (15), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 20</span><br><span class="line">Count: 2  Time=90.84s (181s)  Lock=0.00s (0s)  Rows=10.0 (20), 2users@2hosts</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 10</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 4.</span><br></pre></td></tr></table></figure></p><p>-h 后面不加任何参数，日志文件名使用过滤条件会报错：<br>[root@dax-mysql-slave log]# mysqldumpslow -a -t 20 -h  /data/mysql/log/10.0.7.*-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/data//data/mysql/log/10.0.7.4-slow.log-slow.log</span><br><span class="line">Can&apos;t open /data/mysql/data//data/mysql/log/10.0.7.4-slow.log-slow.log: No such file or directory at /data/mysql/bin/mysqldumpslow line 91.</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161.</span><br></pre></td></tr></table></figure></p><h3 id="7、-i-服务的实例名（官方文档说通过mysql-server启动查看服务实例名，测试之后未找到）"><a href="#7、-i-服务的实例名（官方文档说通过mysql-server启动查看服务实例名，测试之后未找到）" class="headerlink" title="7、-i 服务的实例名（官方文档说通过mysql.server启动查看服务实例名，测试之后未找到）"></a>7、-i 服务的实例名（官方文档说通过mysql.server启动查看服务实例名，测试之后未找到）</h3><h3 id="8、-l-不从总时间内减去锁时间"><a href="#8、-l-不从总时间内减去锁时间" class="headerlink" title="8、-l 不从总时间内减去锁时间"></a>8、-l 不从总时间内减去锁时间</h3><h3 id="9、-r-反转排序顺序"><a href="#9、-r-反转排序顺序" class="headerlink" title="9、-r 反转排序顺序"></a>9、-r 反转排序顺序</h3><h3 id="10、-s-何种方式排序：t，at：按查询时间或平均查询时间排序-l，al：按锁定时间或平均锁定时间排序-r，ar：按发送的行或发送的平均行排序-c：按计数排序-默认情况下，按平均查询时间（相当于-s-at）排序。"><a href="#10、-s-何种方式排序：t，at：按查询时间或平均查询时间排序-l，al：按锁定时间或平均锁定时间排序-r，ar：按发送的行或发送的平均行排序-c：按计数排序-默认情况下，按平均查询时间（相当于-s-at）排序。" class="headerlink" title="10、-s 何种方式排序：t，at：按查询时间或平均查询时间排序;l，al：按锁定时间或平均锁定时间排序;r，ar：按发送的行或发送的平均行排序;c：按计数排序;默认情况下，按平均查询时间（相当于-s at）排序。"></a>10、-s 何种方式排序：t，at：按查询时间或平均查询时间排序;l，al：按锁定时间或平均锁定时间排序;r，ar：按发送的行或发送的平均行排序;c：按计数排序;默认情况下，按平均查询时间（相当于-s at）排序。</h3><p>按总时间排序：<br>/data/mysql/bin/mysqldumpslow -s t -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br><span class="line">Count: 6674  Time=1.52s (10151s)  Lock=0.00s (0s)  Rows=9.9 (66259), 2users@5hosts</span><br><span class="line">  SELECT id, order_no, broker_id, broker_uid, plat_id, trade_asset, price_asset, trade_type, order_type, price, number, client_order_no, traded_number, over_number, traded_money, fee_asset, fee, broker_fee, cloud_fee, create_time, update_time, state, send_state, error_code, error_msg FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;)) order by create_time desc LIMIT N</span><br><span class="line">Count: 84  Time=40.42s (3394s)  Lock=0.00s (0s)  Rows=1.0 (84), 42users@42hosts</span><br><span class="line">  SELECT member_id, member_host, member_port, member_state, @@group_replication_single_primary_mode FROM performance_schema.replication_group_members WHERE channel_name = &apos;S&apos;</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br></pre></td></tr></table></figure></p><p>按平均时间排序：<br>/data/mysql/bin/mysqldumpslow -s at -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 35  Time=79.40s (2779s)  Lock=0.00s (0s)  Rows=18592104.7 (650723665), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `finance_detail`</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 1  Time=44.68s (44s)  Lock=0.00s (0s)  Rows=2.0 (2), root[root]@localhost</span><br><span class="line">  select distinct state from test  order by id</span><br></pre></td></tr></table></figure></p><p>按锁表时间排序<br>[root@mw-mysql-2 ~]# /data/mysql/bin/mysqldumpslow -s l -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br></pre></td></tr></table></figure></p><p>按锁表平均时间排序<br>[root@mw-mysql-2 ~]# /data/mysql/bin/mysqldumpslow -s al -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 1  Time=44.68s (44s)  Lock=0.00s (0s)  Rows=2.0 (2), root[root]@localhost</span><br><span class="line">  select distinct state from test  order by id</span><br><span class="line">Count: 1  Time=0.98s (0s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@localhost</span><br><span class="line">  select count(*) from test where broker_id = &apos;S&apos; AND broker_uid = N</span><br><span class="line">Count: 2  Time=27.04s (54s)  Lock=0.00s (0s)  Rows=2.0 (4), root[root]@localhost</span><br><span class="line">  select distinct state from test where id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br></pre></td></tr></table></figure></p><p>按返回行排序<br>/data/mysql/bin/mysqldumpslow -s r -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 35  Time=79.40s (2779s)  Lock=0.00s (0s)  Rows=18592104.7 (650723665), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `finance_detail`</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 4  Time=7.10s (28s)  Lock=0.00s (0s)  Rows=1121601.2 (4486405), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_1`</span><br><span class="line">Count: 4  Time=4.29s (17s)  Lock=0.00s (0s)  Rows=1121591.2 (4486365), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_2`</span><br><span class="line">Count: 4  Time=4.72s (18s)  Lock=0.00s (0s)  Rows=1121587.5 (4486350), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_3`</span><br></pre></td></tr></table></figure></p><p>按平均返回行排序<br>/data/mysql/bin/mysqldumpslow -s ar -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 35  Time=79.40s (2779s)  Lock=0.00s (0s)  Rows=18592104.7 (650723665), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `finance_detail`</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 4  Time=7.10s (28s)  Lock=0.00s (0s)  Rows=1121601.2 (4486405), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_1`</span><br><span class="line">Count: 4  Time=4.29s (17s)  Lock=0.00s (0s)  Rows=1121591.2 (4486365), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_2`</span><br><span class="line">Count: 4  Time=4.72s (18s)  Lock=0.00s (0s)  Rows=1121587.5 (4486350), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_3`</span><br></pre></td></tr></table></figure></p><p>按查询次数排序<br>/data/mysql/bin/mysqldumpslow -s c -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br><span class="line">Count: 6674  Time=1.52s (10151s)  Lock=0.00s (0s)  Rows=9.9 (66259), 2users@5hosts</span><br><span class="line">  SELECT id, order_no, broker_id, broker_uid, plat_id, trade_asset, price_asset, trade_type, order_type, price, number, client_order_no, traded_number, over_number, traded_money, fee_asset, fee, broker_fee, cloud_fee, create_time, update_time, state, send_state, error_code, error_msg FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;)) order by create_time desc LIMIT N</span><br><span class="line">Count: 619  Time=1.20s (741s)  Lock=0.00s (0s)  Rows=10.0 (6181), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT  id,order_no,broker_id,broker_uid,plat_id,trade_asset,price_asset,trade_type,order_type,price,number,client_order_no,traded_number,over_number,traded_money,fee_asset,fee,broker_fee,cloud_fee,create_time,update_time,state,send_state,error_code,error_msg  FROM test  WHERE       (  state = &apos;S&apos;</span><br><span class="line">  and send_state = &apos;S&apos;</span><br><span class="line">  and update_time &lt; &apos;S&apos; ) LIMIT N</span><br></pre></td></tr></table></figure></p><p>添加-r参数对取到值反转排序：<br>/data/mysql/bin/mysqldumpslow -s c -t 5 -l -r  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 619  Time=1.20s (741s)  Lock=0.00s (0s)  Rows=10.0 (6181), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT  id,order_no,broker_id,broker_uid,plat_id,trade_asset,price_asset,trade_type,order_type,price,number,client_order_no,traded_number,over_number,traded_money,fee_asset,fee,broker_fee,cloud_fee,create_time,update_time,state,send_state,error_code,error_msg  FROM test  WHERE       (  state = &apos;S&apos;</span><br><span class="line">  and send_state = &apos;S&apos;</span><br><span class="line">  and update_time &lt; &apos;S&apos; ) LIMIT N</span><br><span class="line">Count: 6674  Time=1.52s (10151s)  Lock=0.00s (0s)  Rows=9.9 (66259), 2users@5hosts</span><br><span class="line">  SELECT id, order_no, broker_id, broker_uid, plat_id, trade_asset, price_asset, trade_type, order_type, price, number, client_order_no, traded_number, over_number, traded_money, fee_asset, fee, broker_fee, cloud_fee, create_time, update_time, state, send_state, error_code, error_msg FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;)) order by create_time desc LIMIT N</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br></pre></td></tr></table></figure></p><h3 id="11、-t-按指定数字显示行输出"><a href="#11、-t-按指定数字显示行输出" class="headerlink" title="11、-t 按指定数字显示行输出"></a>11、-t 按指定数字显示行输出</h3><h3 id="12、–verbose-详细模式"><a href="#12、–verbose-详细模式" class="headerlink" title="12、–verbose 详细模式"></a>12、–verbose 详细模式</h3><h3 id="13、如果不小心删掉了slow-log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）"><a href="#13、如果不小心删掉了slow-log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）" class="headerlink" title="13、如果不小心删掉了slow.log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）"></a>13、如果不小心删掉了slow.log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root -ptest flush-logs slow</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql limit参数详解及使用过程遇到的问题</title>
      <link href="/2018/09/11/mysql%20limit%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/11/mysql%20limit%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3%E5%8F%8A%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h3 id="前提：开发反应一条sql查询很慢，查看sql执行计划："><a href="#前提：开发反应一条sql查询很慢，查看sql执行计划：" class="headerlink" title="前提：开发反应一条sql查询很慢，查看sql执行计划："></a>前提：开发反应一条sql查询很慢，查看sql执行计划：</h3><p><img src="https://i.imgur.com/0g4vJQi.png" alt=""><br>查看到没有走设置的索引，而是走了主键索引，尝试去掉limit行限制之后：<br><img src="https://i.imgur.com/cHs3D6a.png" alt=""><br>发现去掉limit走索引正常。<br>是用group by和limit测试执行计划是否正常：<br><img src="https://i.imgur.com/taIuBAg.png" alt=""><br><img src="https://i.imgur.com/zmycRJf.png" alt=""><br>group by与limit组合会影响执行计划。<br>只使用limit，去掉order by和group by实验：<br><img src="https://i.imgur.com/ur8UNHg.png" alt=""><br><img src="https://i.imgur.com/W5mAiMg.png" alt=""><br>执行计划没有受影响。<br>结论：order by、group by与limit在一起执行的时候要注意执行计划是否影响，如果不得不使用该组合，担心执行计划被更改，建议使用force index(index_name)，或者多次测试执行计划不会被影响再放到生产环境里。<br>下面介绍官方文档就limit参数的解释：</p><h3 id="0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。"><a href="#0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。" class="headerlink" title="0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。"></a>0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。</h3><h3 id="1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。"><a href="#1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。" class="headerlink" title="1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。"></a>1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。</h3><h3 id="2、如果使用order-by与limit-row-count组合，mysql只要找到排序结果row-count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row-count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order-by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。"><a href="#2、如果使用order-by与limit-row-count组合，mysql只要找到排序结果row-count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row-count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order-by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。" class="headerlink" title="2、如果使用order by与limit row_count组合，mysql只要找到排序结果row_count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row_count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。"></a>2、如果使用order by与limit row_count组合，mysql只要找到排序结果row_count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row_count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。</h3><p>limit会影响执行计划，因此orderby带有limit和不带有limit返回行会是不同排序。</p><h3 id="3、官方文档的实验如下："><a href="#3、官方文档的实验如下：" class="headerlink" title="3、官方文档的实验如下："></a>3、官方文档的实验如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">|  2 |        3 |    5.0 |</span><br><span class="line">|  7 |        3 |    2.7 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure><p>带有limit子句会影响每一个行category的返回值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category LIMIT 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure></p><p>对于带有limit和不带有limit的子句返回相同的行排序是很重要的，增加合适的列在order by子句中确保顺序。例如在order by后加一个id的排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category, id;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">|  2 |        3 |    5.0 |</span><br><span class="line">|  7 |        3 |    2.7 |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category, id LIMIT 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure></p><p>4、根据官方文档提供的信息，自己动手实验，创建测试数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">create table ratings (id int,category int,rating varchar(10));</span><br><span class="line">insert into ratings values(5,1,&apos;3.2&apos;),(1,1,&apos;4.5&apos;),(4,2,&apos;3.5&apos;),(3,2,&apos;3.7&apos;),(6,2,&apos;3.5&apos;),(7,3,&apos;2.7&apos;),(2,3,&apos;5.0&apos;);</span><br><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">|    7 |        3 | 2.7    |</span><br><span class="line">|    2 |        3 | 5.0    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category limit 5;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>id列没有做任何排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category,id;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">|    2 |        3 | 5.0    |</span><br><span class="line">|    7 |        3 | 2.7    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>在order by后多加一个id列，category和id列都按大小做了排序。</p><p>5、尝试在对id列添加主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:10:  [test]&gt; alter table ratings add primary key(id);</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line">root@db 09:10:  [test]&gt; SELECT * FROM ratings order by category;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 | 4.5    |</span><br><span class="line">|  5 |        1 | 3.2    |</span><br><span class="line">|  3 |        2 | 3.7    |</span><br><span class="line">|  4 |        2 | 3.5    |</span><br><span class="line">|  6 |        2 | 3.5    |</span><br><span class="line">|  2 |        3 | 5.0    |</span><br><span class="line">|  7 |        3 | 2.7    |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">root@db 09:10:  [test]&gt; SELECT * FROM ratings order by category limit 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 | 4.5    |</span><br><span class="line">|  5 |        1 | 3.2    |</span><br><span class="line">|  3 |        2 | 3.7    |</span><br><span class="line">|  4 |        2 | 3.5    |</span><br><span class="line">|  6 |        2 | 3.5    |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>添加主键之后id和category列都按大小排序。</p><h3 id="6、如果使用limit-row-count和distinct联合，mysql停止查询一旦找到row-count唯一行数。"><a href="#6、如果使用limit-row-count和distinct联合，mysql停止查询一旦找到row-count唯一行数。" class="headerlink" title="6、如果使用limit row_count和distinct联合，mysql停止查询一旦找到row_count唯一行数。"></a>6、如果使用limit row_count和distinct联合，mysql停止查询一旦找到row_count唯一行数。</h3><h3 id="7、一些情况下，group-by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit-row-count不计算任何不必要group-by值。"><a href="#7、一些情况下，group-by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit-row-count不计算任何不必要group-by值。" class="headerlink" title="7、一些情况下，group by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit row_count不计算任何不必要group by值。"></a>7、一些情况下，group by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit row_count不计算任何不必要group by值。</h3><h3 id="8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql-cal-found-rows函数。在这种情况下，可以使用select-found-rows-获取行数。"><a href="#8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql-cal-found-rows函数。在这种情况下，可以使用select-found-rows-获取行数。" class="headerlink" title="8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql_cal_found_rows函数。在这种情况下，可以使用select found_rows()获取行数。"></a>8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql_cal_found_rows函数。在这种情况下，可以使用select found_rows()获取行数。</h3><h3 id="9、limit-0快速返回一个空集。对于检查查询有效性很用帮助。"><a href="#9、limit-0快速返回一个空集。对于检查查询有效性很用帮助。" class="headerlink" title="9、limit 0快速返回一个空集。对于检查查询有效性很用帮助。"></a>9、limit 0快速返回一个空集。对于检查查询有效性很用帮助。</h3><h3 id="10、如果服务使用临时表来解决查询，使用limit-row-count子句来计算需要多少空间。"><a href="#10、如果服务使用临时表来解决查询，使用limit-row-count子句来计算需要多少空间。" class="headerlink" title="10、如果服务使用临时表来解决查询，使用limit row_count子句来计算需要多少空间。"></a>10、如果服务使用临时表来解决查询，使用limit row_count子句来计算需要多少空间。</h3><h3 id="11、如果order-by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。"><a href="#11、如果order-by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。" class="headerlink" title="11、如果order by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。"></a>11、如果order by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。</h3>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-Lock wait timeout exceeded; try restarting transaction</title>
      <link href="/2018/09/10/mysql-Lock%20wait%20timeout%20exceeded;%20try%20restarting%20transaction/"/>
      <url>/2018/09/10/mysql-Lock%20wait%20timeout%20exceeded;%20try%20restarting%20transaction/</url>
      <content type="html"><![CDATA[<h3 id="1、mysql执行一条update语句报错："><a href="#1、mysql执行一条update语句报错：" class="headerlink" title="1、mysql执行一条update语句报错："></a>1、mysql执行一条update语句报错：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure><p>查看当前系统锁等待超时时间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%lock_wait_timeout%&apos;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_lock_wait_timeout | 30    |</span><br><span class="line">| lock_wait_timeout        | 60    |</span><br><span class="line">+--------------------------+-------+</span><br></pre></td></tr></table></figure></p><p>innodb事务锁等待超时事件30s，其他非innodb事务锁等待事件超时为60s，</p><h3 id="2、查看造成事务阻塞的信息："><a href="#2、查看造成事务阻塞的信息：" class="headerlink" title="2、查看造成事务阻塞的信息："></a>2、查看造成事务阻塞的信息：</h3><p>select * from information_schema.innodb_trx\G；查看innodb_trx各列参数，点击<a href="https://zeven0707.github.io/2018/09/10/mysql%20innodb_trx%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">此处</a><br><img src="https://i.imgur.com/FxQAYyR.png" alt=""><br>线程id为1308的事务被线程id为1311的事务阻塞，查看不到线程id为1311正在执行的语句</p><h3 id="3、查看事务锁信息，记录了当前锁的相关信息；查看innodb-lock各列参数，点击此处："><a href="#3、查看事务锁信息，记录了当前锁的相关信息；查看innodb-lock各列参数，点击此处：" class="headerlink" title="3、查看事务锁信息，记录了当前锁的相关信息；查看innodb_lock各列参数，点击此处："></a>3、查看事务锁信息，记录了当前锁的相关信息；查看innodb_lock各列参数，点击<a href="https://zeven0707.github.io/2018/09/10/mysql%20innodb_locks%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">此处</a>：</h3><p>select * from information_schema.innodb_locks\G<br><img src="https://i.imgur.com/DlBpbOe.png" alt=""></p><h3 id="4、查看线程id为1311的线程信息，select-from-information-schema-processlist-where-id-1311-G，"><a href="#4、查看线程id为1311的线程信息，select-from-information-schema-processlist-where-id-1311-G，" class="headerlink" title="4、查看线程id为1311的线程信息，select * from information_schema.processlist where id=1311\G，"></a>4、查看线程id为1311的线程信息，select * from information_schema.processlist where id=1311\G，</h3><p><img src="https://i.imgur.com/chR1kiv.png" alt=""><br>该事务command为sleep，表示事务sql语句已经执行完成，但是锁仍然存在，没有释放手动kill掉该线程，在执行其他操作正常。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill 1311</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql show innodb_locks详解</title>
      <link href="/2018/09/10/mysql%20innodb_locks%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/09/10/mysql%20innodb_locks%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="1、INFORMATION-SCHEMA-INNODB-LOCKS-提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下："><a href="#1、INFORMATION-SCHEMA-INNODB-LOCKS-提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下：" class="headerlink" title="1、INFORMATION_SCHEMA INNODB_LOCKS 提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下："></a>1、INFORMATION_SCHEMA INNODB_LOCKS 提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_locks\G</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/PCfQYeg.png" alt=""></p><h3 id="2、innodb-locks各列参数详解："><a href="#2、innodb-locks各列参数详解：" class="headerlink" title="2、innodb_locks各列参数详解："></a>2、innodb_locks各列参数详解：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lock_id:innodb唯一lock id。把他当做一个不透明的字符串。虽然lock_id当前包含trx_id，lock_id的数据格式在任何时间都肯能改变。不要写用于解析lock_id值得应用程序。</span><br><span class="line">lock_trx_id：持有锁的事务id。查询事务信息，与innodb_trx表中trx_id列匹配。</span><br><span class="line">lock_mode:锁请求。该值包括： S, X, IS, IX, GAP, AUTO_INC, and UNKNOWN。锁模式标识符可以组合用于识别特定的锁模式。查看更多信息，点击[此处]((https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html))</span><br><span class="line">lock_type:锁类型。行锁为record，表锁为table。</span><br><span class="line">lock_table:被锁的表名，或者包含锁记录的表名。</span><br><span class="line">lock_index:lock_type为行锁时，该值为索引名，否则为空。</span><br><span class="line">lock_space:lock_type为行锁时，该值为锁记录的表空间的id，否则为空。</span><br><span class="line">lock_page：lock_type为行锁时，该值为锁记录页数量，否则为空。</span><br><span class="line">lock_rec:lock_type为行锁时，页内锁记录的堆数，否则为空。</span><br><span class="line">lock_data：与锁相关的数据。如果lock_type为行锁时，该值是锁记录的主键值，否则为空。这列包含锁定行的主键列的值，转化为一个有效的字符串，如果没有主键，lock_data是唯一innodb内部行id号。如果是键值或者范围大于索引的最大值会使用间隙锁，lock_data表示为supremum pseudo-record。当包含锁记录的页不在buffer pool内，innodb不去从磁盘获取页，为了避免不必要的磁盘操作，lock_data为空。</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql innodb_trx参数详解</title>
      <link href="/2018/09/10/mysql%20innodb_trx%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/09/10/mysql%20innodb_trx%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="1、innodb-trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句："><a href="#1、innodb-trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句：" class="headerlink" title="1、innodb_trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句："></a>1、innodb_trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_trx;</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/QEeh4UJ.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_trx\G</span><br></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/MLfEIgP.png" alt=""></p><h3 id="2、innodb-trx表列信息详解："><a href="#2、innodb-trx表列信息详解：" class="headerlink" title="2、innodb_trx表列信息详解："></a>2、innodb_trx表列信息详解：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">trx_id：唯一事务id号，只读事务和非锁事务是不会创建id的。</span><br><span class="line">TRX_WEIGHT：事务的高度，代表修改的行数（不一定准确）和被事务锁住的行数。为了解决死锁，innodb会选择一个高度最小的事务来当做牺牲品进行回滚。已经被更改的非交易型表的事务权重比其他事务高，即使改变的行和锁住的行比其他事务低。</span><br><span class="line">TRX_STATE：事务的执行状态，值一般分为：RUNNING, LOCK WAIT, ROLLING BACK, and COMMITTING.</span><br><span class="line">TRX_STARTED：事务的开始时间</span><br><span class="line">TRX_REQUESTED_LOCK_ID:如果trx_state是lockwait,显示事务当前等待锁的id，不是则为空。想要获取锁的信息，根据该lock_id，以innodb_locks表中lock_id列匹配条件进行查询，获取相关信息。</span><br><span class="line">TRX_WAIT_STARTED：如果trx_state是lockwait,该值代表事务开始等待锁的时间；否则为空。</span><br><span class="line">TRX_MYSQL_THREAD_ID：mysql线程id。想要获取该线程的信息，根据该thread_id，以INFORMATION_SCHEMA.PROCESSLIST表的id列为匹配条件进行查询。</span><br><span class="line">TRX_QUERY：事务正在执行的sql语句。</span><br><span class="line">TRX_OPERATION_STATE：事务当前的操作状态，没有则为空。</span><br><span class="line">TRX_TABLES_IN_USE：事务在处理当前sql语句使用innodb引擎表的数量。</span><br><span class="line">TRX_TABLES_LOCKED：当前sql语句有行锁的innodb表的数量。（因为只是行锁，不是表锁，表仍然可以被多个事务读和写）</span><br><span class="line">TRX_LOCK_STRUCTS：事务保留锁的数量。</span><br><span class="line">TRX_LOCK_MEMORY_BYTES：在内存中事务索结构占得空间大小。</span><br><span class="line">TRX_ROWS_LOCKED：事务行锁最准确的数量。这个值可能包括对于事务在物理上存在，实际不可见的删除标记的行。</span><br><span class="line">TRX_ROWS_MODIFIED：事务修改和插入的行数</span><br><span class="line">TRX_CONCURRENCY_TICKETS：该值代表当前事务在被清掉之前可以多少工作，由 innodb_concurrency_tickets系统变量值指定。</span><br><span class="line">TRX_ISOLATION_LEVEL：事务隔离等级。</span><br><span class="line">TRX_UNIQUE_CHECKS：当前事务唯一性检查启用还是禁用。当批量数据导入时，这个参数是关闭的。</span><br><span class="line">TRX_FOREIGN_KEY_CHECKS：当前事务的外键坚持是启用还是禁用。当批量数据导入时，这个参数是关闭的。</span><br><span class="line">TRX_LAST_FOREIGN_KEY_ERROR：最新一个外键错误信息，没有则为空。</span><br><span class="line">TRX_ADAPTIVE_HASH_LATCHED：自适应哈希索引是否被当前事务阻塞。当自适应哈希索引查找系统分区，一个单独的事务不会阻塞全部的自适应hash索引。自适应hash索引分区通过 innodb_adaptive_hash_index_parts参数控制，默认值为8。</span><br><span class="line">TRX_ADAPTIVE_HASH_TIMEOUT：是否为了自适应hash索引立即放弃查询锁，或者通过调用mysql函数保留它。当没有自适应hash索引冲突，该值为0并且语句保持锁直到结束。在冲突过程中，该值被计数为0，每句查询完之后立即释放门闩。当自适应hash索引查询系统被分区（由 innodb_adaptive_hash_index_parts参数控制），值保持为0。</span><br><span class="line">TRX_IS_READ_ONLY：值为1表示事务是read only。</span><br><span class="line">TRX_AUTOCOMMIT_NON_LOCKING：值为1表示事务是一个select语句，该语句没有使用for update或者shared mode锁，并且执行开启了autocommit，因此事务只包含一个语句。当TRX_AUTOCOMMIT_NON_LOCKING和TRX_IS_READ_ONLY同时为1，innodb通过降低事务开销和改变表数据库来优化事务。</span><br></pre></td></tr></table></figure><h3 id="3、注意事项"><a href="#3、注意事项" class="headerlink" title="3、注意事项"></a>3、注意事项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该表用于当系统负载较高时，诊断性能问题。</span><br><span class="line">查询该表必须有process权限。</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql show processlist详解</title>
      <link href="/2018/09/09/mysql%20show%20processlist%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/09/09/mysql%20show%20processlist%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h3 id="0、show-processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。"><a href="#0、show-processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。" class="headerlink" title="0、show processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。"></a>0、show processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。</h3><p>有管理员权限的用户，如下图所示：<br><img src="https://i.imgur.com/CwMY5kv.png" alt=""><br>没有管理权限的用户，如下图所示：：<br><img src="https://i.imgur.com/iJ8OO2x.png" alt=""><br>如果不加full关键字，每条语句的info信息栏只能显示前100个字符。<br>如果看到“too many connections”的错误信息，想要看看什么线程正在运行，使用show processlist语句是很有用的。mysql数据库会额外保持一个连接，供具有connection_admin或者super权限用户的使用，用以确保管理员能随时连接进来检查系统状况（假设你没有将此权限授予所有用户）。<br>show processlist输出列详解：</p><h3 id="1、id：连接标识符，与INFORMATION-SCHEMA-PROCESSLIST表的id列显示的是同类型的值，如下图所示："><a href="#1、id：连接标识符，与INFORMATION-SCHEMA-PROCESSLIST表的id列显示的是同类型的值，如下图所示：" class="headerlink" title="1、id：连接标识符，与INFORMATION_SCHEMA PROCESSLIST表的id列显示的是同类型的值，如下图所示："></a>1、id：连接标识符，与INFORMATION_SCHEMA PROCESSLIST表的id列显示的是同类型的值，如下图所示：</h3><p><img src="https://i.imgur.com/Hl57tcb.png" alt=""><br>Performance_Schema threads表的processlist_id列也是相同值，由connection_id())函数返回值。<br><img src="https://i.imgur.com/CwS1fUD.png" alt=""><br>通过kill 语句可以杀掉查询到的线程，执行命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill id号</span><br></pre></td></tr></table></figure></p><h3 id="2、user-代表数据库用户，如果是system-user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system-user，host列没有任何信息。-unauthenticated-user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event-scheduler-是监控调度事件的线程。"><a href="#2、user-代表数据库用户，如果是system-user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system-user，host列没有任何信息。-unauthenticated-user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event-scheduler-是监控调度事件的线程。" class="headerlink" title="2、user: 代表数据库用户，如果是system user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system user，host列没有任何信息。 unauthenticated user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event_scheduler 是监控调度事件的线程。"></a>2、user: 代表数据库用户，如果是system user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system user，host列没有任何信息。 unauthenticated user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event_scheduler 是监控调度事件的线程。</h3><h3 id="3、host：发起线程的客户的主机名（对于system-user，host这一列为空）。tcp-ip连接的主机名是：hostname：client-port格式，用这种格式来更方面查看客户端在做什么操作。"><a href="#3、host：发起线程的客户的主机名（对于system-user，host这一列为空）。tcp-ip连接的主机名是：hostname：client-port格式，用这种格式来更方面查看客户端在做什么操作。" class="headerlink" title="3、host：发起线程的客户的主机名（对于system user，host这一列为空）。tcp/ip连接的主机名是：hostname：client_port格式，用这种格式来更方面查看客户端在做什么操作。"></a>3、host：发起线程的客户的主机名（对于system user，host这一列为空）。tcp/ip连接的主机名是：hostname：client_port格式，用这种格式来更方面查看客户端在做什么操作。</h3><h3 id="4、db：如果指定了库名，会使用当前的库名；如果没有则为空。"><a href="#4、db：如果指定了库名，会使用当前的库名；如果没有则为空。" class="headerlink" title="4、db：如果指定了库名，会使用当前的库名；如果没有则为空。"></a>4、db：如果指定了库名，会使用当前的库名；如果没有则为空。</h3><h3 id="5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处"><a href="#5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处" class="headerlink" title="5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处"></a>5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击<a href="https://dev.mysql.com/doc/refman/8.0/en/thread-commands.html" target="_blank" rel="noopener">此处</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">connect：从复制已经连接到主库</span><br><span class="line">connect out：从复制正在连接到主库</span><br><span class="line">create db：正在执行一个创建库的操作。</span><br><span class="line">execute：正在执行一个准备好的语句。</span><br><span class="line">field list：提取表列信息线程</span><br><span class="line">kill：当前线程被其他线程杀掉。</span><br><span class="line">query：正在整型一条语句。</span><br><span class="line">quit：线程被终止。</span><br><span class="line">refresh：刷新表、日志、缓存、重置状态变量值或从服务信息线程。</span><br><span class="line">shutdown：关闭服务线程</span><br><span class="line">sleep：等待客户端发送一条新语句线程。</span><br><span class="line">table dump：发送表内容到从服务器</span><br><span class="line">statics：获取当前服务状态信息。</span><br><span class="line">如果一个线程耗时比较久，需要重点关注造成该线程。</span><br></pre></td></tr></table></figure><h3 id="6、time：当前线程耗时。对于slave-sql-线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。"><a href="#6、time：当前线程耗时。对于slave-sql-线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。" class="headerlink" title="6、time：当前线程耗时。对于slave sql 线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。"></a>6、time：当前线程耗时。对于slave sql 线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。</h3><h3 id="7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处"><a href="#7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处" class="headerlink" title="7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处"></a>7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击<a href="https://dev.mysql.com/doc/refman/8.0/en/general-thread-states.html" target="_blank" rel="noopener">此处</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">after create：执行完create table函数之后，创建表的线程（包括内部临时表），即使因为某些错误创建表失败，该状态也会显示。</span><br><span class="line">analyzing：统计myisam表键分布（例如执行analyze table）</span><br><span class="line">checking permissions：检查是否有权限执行该语句。</span><br><span class="line">check tables：执行表检查操作。</span><br><span class="line">cleaning up：线程正在处理一条命名，准备释放内存重置某些状态变量。</span><br><span class="line">closing tables:刷新更改的表到磁盘，关闭使用的表。该操作应该快速完成，如果没有，请确保是否有足够的磁盘空间或者磁盘io是否太高。</span><br><span class="line">copy to tmp table:处理alter table语句。该状态发生在表新结构被创建之后，行数据被拷贝到表之前。</span><br><span class="line">copying to group table：该执行语句中order by和group by有不同的关键字，行被组处理拷贝到临时表。</span><br><span class="line">copying to tmp table：正在复制内存中的临时表。</span><br><span class="line">altering table：正在执行alter table</span><br><span class="line">Copying to tmp table on disk:正在拷贝临时表到磁盘。临时结果变得太大，因此，线程将临时表从内存转到磁盘来节省内存。</span><br><span class="line">creating index：对myisam表进行alter table ... enable keys操作</span><br><span class="line">creating sort index:使用内部临时表处理一个select语句。</span><br><span class="line">creating table：正在创建表（包括创建临时表）</span><br><span class="line">creating tmp table：在内存或磁盘创建一个临时表。如果一个表刚开始再内存创建，之后转到磁盘，该状态会变为：Copying to tmp table on disk。</span><br><span class="line">committing alter table to storage engine：alter table已经执行完成，正在提交 结果。</span><br><span class="line">executing：已经开始执行一个语句</span><br><span class="line">freeing items：已经执行了一个命令，该状态通常在cleaning up之后。</span><br><span class="line">query end：，在freeing items状态之前，处理一个查询之后</span><br><span class="line">logging slow query：写语句到slow-query日志</span><br><span class="line">sending data：正在读取和处理一个select语句的行，并发送数据到客户端，因为可能会发生物理读，该状态可能是给定生命周期时间最长的。</span><br><span class="line">update：准备更新表</span><br><span class="line">updating：正在搜索更新的行，并更新他们</span><br><span class="line">system lock：调用了mysql_lock_tables()函数，线程状态一直没有更新。产生该问题原因很多：</span><br><span class="line">比如：请求或等待一个表的内部或者外部系统锁。当innodb等待一个表锁等级为lock tables时会发生。如果这个问题是由请求外部锁，并且你没有用多个mysqld服务访问相同的myisam引擎表，你可以通过参数 --skip-external-locking禁用外部系统锁。但是外部锁默认情况下是禁用的，因此该参数可能没有影响。对于show profile命令，该状态代表正在请求锁（不是在等待锁）</span><br><span class="line">对于系统表锁状态是Locking system tables。</span><br><span class="line">waiting for commit lock：flush tables with read lock正在等待一个commit 锁</span><br><span class="line">waiting for tables：线程收到通知，表的底层架构已经更改，需要重新打开表后去一个新的结构。但是重新打开一个表，需要等待其他正在访问该表的线程。</span><br><span class="line">通常在其他线程使用flush tables或者执行下面语句: FLUSH TABLES tbl_name, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, or OPTIMIZE TABLE. 时会发生此通知。</span><br></pre></td></tr></table></figure><h3 id="8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。"><a href="#8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。" class="headerlink" title="8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。"></a>8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。</h3><h3 id="9、另外使用mysqladmin-processlist也可以查看进程信息，如下图所示："><a href="#9、另外使用mysqladmin-processlist也可以查看进程信息，如下图所示：" class="headerlink" title="9、另外使用mysqladmin processlist也可以查看进程信息，如下图所示："></a>9、另外使用mysqladmin processlist也可以查看进程信息，如下图所示：</h3><p><img src="https://i.imgur.com/72IPvk1.png" alt=""></p><h3 id="10、如果想通过sql命令去获取自己设定的行，可按以下方法设置："><a href="#10、如果想通过sql命令去获取自己设定的行，可按以下方法设置：" class="headerlink" title="10、如果想通过sql命令去获取自己设定的行，可按以下方法设置："></a>10、如果想通过sql命令去获取自己设定的行，可按以下方法设置：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.processlist where state !=&apos; &apos;;</span><br><span class="line">![](https://i.imgur.com/pGGuMER.png)</span><br></pre></td></tr></table></figure><p>可根据自己需求添加条件。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql update一条语句过程遇到的问题</title>
      <link href="/2018/09/09/mysql%20update%E4%B8%80%E6%9D%A1%E8%AF%AD%E5%8F%A5%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/09/mysql%20update%E4%B8%80%E6%9D%A1%E8%AF%AD%E5%8F%A5%E8%BF%87%E7%A8%8B%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h3 id="1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题："><a href="#1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题：" class="headerlink" title="1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题："></a>1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos;;</span><br><span class="line">error：Multi-statement TRANSACTION required more THAN &apos;max_binlog_cache_size&apos; bytes of STORAGE; increase this mysqld variable AND try again</span><br></pre></td></tr></table></figure><h3 id="2、查看binlog-cache-size，最大值为1G："><a href="#2、查看binlog-cache-size，最大值为1G：" class="headerlink" title="2、查看binlog_cache_size，最大值为1G："></a>2、查看binlog_cache_size，最大值为1G：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%binlog_cache_size%&apos;;</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| Variable_name         | Value      |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| binlog_cache_size     | 4194304    |</span><br><span class="line">| max_binlog_cache_size | 1073741824 |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3、尝试去调高max-binlog-cache-size，在此执行update语句："><a href="#3、尝试去调高max-binlog-cache-size，在此执行update语句：" class="headerlink" title="3、尝试去调高max_binlog_cache_size，在此执行update语句："></a>3、尝试去调高max_binlog_cache_size，在此执行update语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global max_binlog_cache_size=4073741824;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">mysql&gt; show variables like &apos;%binlog_cache_size%&apos;;</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| Variable_name         | Value      |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| binlog_cache_size     | 4194304    |</span><br><span class="line">| max_binlog_cache_size | 4073738240 |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog-cache-size仍然不满足，每次更新100万，执行正常："><a href="#4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog-cache-size仍然不满足，每次更新100万，执行正常：" class="headerlink" title="4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog_cache_size仍然不满足，每次更新100万，执行正常："></a>4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog_cache_size仍然不满足，每次更新100万，执行正常：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id &gt;=1 and id &lt;= 1000000;</span><br><span class="line">Query OK, 974190 rows affected (2 min 3.48 sec)</span><br><span class="line">Rows matched: 974190  Changed: 974190  Warnings: 0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id &gt;=16000000 and id &lt;= 17000000;</span><br><span class="line">Query OK, 982238 rows affected (2 min 37.44 sec)</span><br><span class="line">Rows matched: 982238  Changed: 982238  Warnings: 0</span><br></pre></td></tr></table></figure><p>每100万更新耗时为2min 40s左右</p><h3 id="5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法："><a href="#5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法：" class="headerlink" title="5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法："></a>5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from trade_order ORDER BY id ASC LIMIT 1,1000000) as tmp);</span><br></pre></td></tr></table></figure><p>该方法涉及到一个子查询，总体执行速度会下降，根据取值范围和当前实际更新的行数，耗时在4min左右：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from trade_order ORDER BY id ASC LIMIT 1,1000000) as tmp);</span><br><span class="line">Query OK, 981631 rows affected (3 min 49.27 sec)</span><br><span class="line">Rows matched: 981631  Changed: 981631  Warnings: 0</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql报错：[ERROR] InnoDB: Unable to lock ./ibdata1</title>
      <link href="/2018/09/08/mysql%E6%8A%A5%E9%94%99-%5BERROR%5D%20InnoDB-Unable%20to%20lock%20-ibdata1/"/>
      <url>/2018/09/08/mysql%E6%8A%A5%E9%94%99-%5BERROR%5D%20InnoDB-Unable%20to%20lock%20-ibdata1/</url>
      <content type="html"><![CDATA[<h3 id="1、-登录mysql报错："><a href="#1、-登录mysql报错：" class="headerlink" title="1、 登录mysql报错："></a>1、 登录mysql报错：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">ERROR 2002 (HY000): Can&apos;t connect to local MySQL server through socket &apos;/data/mysql/tmp/mysql.sock&apos; (2)</span><br></pre></td></tr></table></figure><h3 id="2、netstat-tunlp-grep-3306发现mysql进程不存在，尝试去启动mysql："><a href="#2、netstat-tunlp-grep-3306发现mysql进程不存在，尝试去启动mysql：" class="headerlink" title="2、netstat -tunlp|grep 3306发现mysql进程不存在，尝试去启动mysql："></a>2、netstat -tunlp|grep 3306发现mysql进程不存在，尝试去启动mysql：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br><span class="line"> ERROR! MySQL server PID file could not be found!</span><br><span class="line">Starting MySQL....................................................................................^C</span><br><span class="line">启动失败，按ctrl+c退出。</span><br></pre></td></tr></table></figure><h3 id="3、查看log日志，一直在刷错误日志"><a href="#3、查看log日志，一直在刷错误日志" class="headerlink" title="3、查看log日志，一直在刷错误日志"></a>3、查看log日志，一直在刷错误日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] InnoDB: Unable to lock ./ibdata1 error: 11</span><br><span class="line">[Note] InnoDB: Check that you do not already have</span><br></pre></td></tr></table></figure><h3 id="4、查看磁盘使用情况"><a href="#4、查看磁盘使用情况" class="headerlink" title="4、查看磁盘使用情况"></a>4、查看磁盘使用情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdc1       1.1T   59G  967G   6% /data</span><br><span class="line">数据目录还有很多空间。</span><br></pre></td></tr></table></figure><h3 id="5、查看mysql进程"><a href="#5、查看mysql进程" class="headerlink" title="5、查看mysql进程"></a>5、查看mysql进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;ps -ef|grep mysql</span><br><span class="line">mysql      1486 130771  2 05:16 pts/0    00:00:01 /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306</span><br><span class="line">root      77736      1  0 Jul25 ?        00:00:00 /bin/sh /data/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/tmp/mysql.pid</span><br><span class="line">mysql    128601  77736 85 05:13 ?        00:03:49 /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306</span><br><span class="line">root     130771      1  0 05:16 pts/0    00:00:00 /bin/sh /data/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/tmp/mysql.pid</span><br></pre></td></tr></table></figure><h3 id="6、top查看进程运行情况"><a href="#6、top查看进程运行情况" class="headerlink" title="6、top查看进程运行情况"></a>6、top查看进程运行情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tasks: 187 total,   1 running, 186 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.4 us,  0.3 sy,  0.0 ni, 99.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 32930580 total, 21548588 free,  7218592 used,  4163400 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 24748960 avail Mem </span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                             </span><br><span class="line">128601 mysql     20   0 21.711g 4.678g  12784 S   2.6 14.9   3:50.26 mysqld</span><br></pre></td></tr></table></figure><h3 id="7、杀掉进程128601"><a href="#7、杀掉进程128601" class="headerlink" title="7、杀掉进程128601"></a>7、杀掉进程128601</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -9 128601</span><br><span class="line">/data/mysql/bin/mysqld_safe: line 198:  1486 Killed                  nohup /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306 &lt; /dev/null &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>因为mysql的守护进程存在，会自动启动mysql进程，再次登录数据库<br>mysql -uroot -p,登录正常。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql批量建库、修改多库中同一命名个表</title>
      <link href="/2018/09/07/%E4%BA%91%E4%BA%A4%E6%98%93%E6%89%80%E5%BB%BA%E5%BA%93%E3%80%81%E4%BF%AE%E6%94%B9%E5%A4%9A%E4%B8%AA%E8%A1%A8%E7%9A%84%E8%AF%AD%E5%8F%A5/"/>
      <url>/2018/09/07/%E4%BA%91%E4%BA%A4%E6%98%93%E6%89%80%E5%BB%BA%E5%BA%93%E3%80%81%E4%BF%AE%E6%94%B9%E5%A4%9A%E4%B8%AA%E8%A1%A8%E7%9A%84%E8%AF%AD%E5%8F%A5/</url>
      <content type="html"><![CDATA[<h3 id="1、批量删除数据库"><a href="#1、批量删除数据库" class="headerlink" title="1、批量删除数据库"></a>1、批量删除数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">mysql -u root -ptest -e &quot;drop database $i&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="2、批量创建数据库"><a href="#2、批量创建数据库" class="headerlink" title="2、批量创建数据库"></a>2、批量创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">mysql -u root -ptest -e &quot;create database $i&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="3、批量在多个库中创建多个表"><a href="#3、批量在多个库中创建多个表" class="headerlink" title="3、批量在多个库中创建多个表"></a>3、批量在多个库中创建多个表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">for j in &#123;0..19&#125;</span><br><span class="line">do </span><br><span class="line">sql=&quot;CREATE TABLE \`match_record_$&#123;j&#125;\` (</span><br><span class="line">  \`id\` bigint(20) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">  \`symbol\` varchar(30) NOT NULL COMMENT &apos;交易对&apos;,</span><br><span class="line">  \`price\` decimal(30,15) NOT NULL COMMENT &apos;成交价格&apos;,</span><br><span class="line">  \`quantity\` decimal(30,15) NOT NULL COMMENT &apos;成交量&apos;,</span><br><span class="line">  \`buy_match_seq\` int(11) NOT NULL COMMENT &apos;买入成交序号&apos;,</span><br><span class="line">  \`buy_tx_no\` varchar(32) NOT NULL COMMENT &apos;买入交易单号&apos;,</span><br><span class="line">  \`sell_match_seq\` int(11) NOT NULL COMMENT &apos;卖出成交序号&apos;,</span><br><span class="line">  \`sell_tx_no\` varchar(32) NOT NULL COMMENT &apos;卖出交易单号&apos;,</span><br><span class="line">  \`is_maker\` tinyint(1) NOT NULL COMMENT &apos;买入方是否为maker&apos;,</span><br><span class="line">  \`create_time\` bigint(20) NOT NULL COMMENT &apos;成交时间戳&apos;,</span><br><span class="line">  PRIMARY KEY (\`id\`),</span><br><span class="line">  UNIQUE KEY \`uniq_idsymbol\` (\`id\`,\`symbol\`),</span><br><span class="line">  UNIQUE KEY \`uniq_txno\` (\`buy_tx_no\`,\`sell_tx_no\`),</span><br><span class="line">  KEY \`idx_create_time\` (\`create_time\`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;成交记录表&apos;;</span><br><span class="line">&quot;</span><br><span class="line">mysql -uroot -ptest -D $i -e&quot;$&#123;sql&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="4、批量修改多个库中的一个同名表做ddl语句操作"><a href="#4、批量修改多个库中的一个同名表做ddl语句操作" class="headerlink" title="4、批量修改多个库中的一个同名表做ddl语句操作"></a>4、批量修改多个库中的一个同名表做ddl语句操作</h3><p>对表增加列，添加唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">symbol=`echo &quot;$i&quot;| awk -F &apos;test_&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">sql=&quot;alter table match_record_0 add column symbol varchar(30) NOT NULL COMMENT &apos;交易对&apos; default &apos;&quot;$&#123;symbol&#125;&quot;&apos;&quot;</span><br><span class="line">alter1=&quot;alter table match_record_0 add UNIQUE KEY \`uniq_idsymbol\` (\`id\`,\`symbol\`)&quot;</span><br><span class="line">alter2=&quot;alter table match_record_0 add UNIQUE KEY \`uniq_txno\` (\`buy_tx_no\`,\`sell_tx_no\`)&quot;</span><br><span class="line">mysql -u root -ptest -D $i -e&quot;$&#123;sql&#125;;$&#123;alter1&#125;;$&#123;alter2&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p><p>对表删除列，删除唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">symbol=`echo &quot;$i&quot;| awk -F &apos;test_&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">sql=&quot;alter table match_record_0 drop column symbol&quot;</span><br><span class="line">alter1=&quot;alter table match_record_0 drop index \`uniq_idsymbol\`&quot;</span><br><span class="line">alter2=&quot;alter table match_record_0 drop index \`uniq_txno\`&quot;</span><br><span class="line">mysql -u root -ptest -D $i -e&quot;$&#123;sql&#125;;$&#123;alter1&#125;;$&#123;alter2&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-binary排序规则与_bin排序规则对比</title>
      <link href="/2018/09/06/mysql%20binary%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E4%B8%8E_bin%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E5%AF%B9%E6%AF%94/"/>
      <url>/2018/09/06/mysql%20binary%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E4%B8%8E_bin%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E5%AF%B9%E6%AF%94/</url>
      <content type="html"><![CDATA[<h3 id="1、binary排序规则与-bin排序规则对比"><a href="#1、binary排序规则与-bin排序规则对比" class="headerlink" title="1、binary排序规则与_bin排序规则对比"></a>1、binary排序规则与_bin排序规则对比</h3><p>二进制字符串（像用binary，barbinary，blob存储的数据类型）有一个字符集和以binary命名的排序规则。二进制字符串是序列字节，这些字节的数字值决定了比较和排序的顺序。<br>非二进制字符串（像用char，varchar，text存储的数据类型）有一个字符集和排序规则（名称不是binary）。一个给定的非二进制字符集有几个排序规则，每一种排序规则对集合中的字符串定义一个特定的比较和排序的顺序。这些非二进制字符集的命名规则是在二进制字符集排序规则的名称后面添加_bin后缀。例如二进制排序规则latin1和utf8分别被命名latin1_bin,utf8_bin。</p><h3 id="2、在某些方面，二进制排序规则与-bin排序规则不同。"><a href="#2、在某些方面，二进制排序规则与-bin排序规则不同。" class="headerlink" title="2、在某些方面，二进制排序规则与_bin排序规则不同。"></a>2、在某些方面，二进制排序规则与_bin排序规则不同。</h3><h5 id="2-1、比较和排序单元："><a href="#2-1、比较和排序单元：" class="headerlink" title="2.1、比较和排序单元："></a>2.1、比较和排序单元：</h5><p>二进制字符串是字节序列。对于二进制排序规则，比较和排序是基于数字字节值。<br>非二进制字符串是（可能是多字节）字符的序列。非二进制排序规则定义了比较和排序字符值的顺序。对于_bin排序规则，这个顺序基于数字字符串编码值，类似于二进制字符串顺序（多字节字符串编制值除外）</p><h5 id="2-2、字符转换："><a href="#2-2、字符转换：" class="headerlink" title="2.2、字符转换："></a>2.2、字符转换：</h5><p>一个非二进制字符串有一个字符集，在很多情况下（即使字符串有_bin排序规则）也可以自动转换为另一个字符集。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当从另一个有不同字符集的列分配列值：</span><br><span class="line">UPDATE t1 SET utf8_bin_column=latin1_column;</span><br><span class="line">INSERT INTO t1 (latin1_column) SELECT utf8_bin_column FROM t2;</span><br><span class="line">当使用字符串文字为insert或update分配值时：</span><br><span class="line">SET NAMES latin1;</span><br><span class="line">INSERT INTO t1 (utf8_bin_column) VALUES (&apos;string-in-latin1&apos;);</span><br><span class="line">当从服务端给客户端返回结果：</span><br><span class="line">SET NAMES latin1;</span><br><span class="line">SELECT utf8_bin_column FROM t2;</span><br></pre></td></tr></table></figure></p><p>对于二进制字符串列，没有转换发生。对于前面的情况，字符串值是按字节复制的。</p><h5 id="2-3、大小写转换："><a href="#2-3、大小写转换：" class="headerlink" title="2.3、大小写转换："></a>2.3、大小写转换：</h5><p>非二进制字符集排序规则提供关于字符字母大小写的信息，因此非二进制字符可以被转换从一个字母到另一个，即使_bin排序规则忽略字母大小写顺序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES latin1 COLLATE latin1_bin;</span><br><span class="line">mysql&gt; SELECT LOWER(&apos;aA&apos;), UPPER(&apos;zZ&apos;);</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| LOWER(&apos;aA&apos;) | UPPER(&apos;zZ&apos;) |</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| aa          | ZZ          |</span><br><span class="line">+-------------+-------------+</span><br></pre></td></tr></table></figure></p><p>字母大小写的概念对二进制字符串的字节不适用，执行字母大小写转换，字符串必须转换为非二进制字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES binary;</span><br><span class="line">mysql&gt; SELECT LOWER(&apos;aA&apos;), LOWER(CONVERT(&apos;aA&apos; USING latin1));</span><br><span class="line">+-------------+-----------------------------------+</span><br><span class="line">| LOWER(&apos;aA&apos;) | LOWER(CONVERT(&apos;aA&apos; USING latin1)) |</span><br><span class="line">+-------------+-----------------------------------+</span><br><span class="line">| aA          | aa                                |</span><br><span class="line">+-------------+-----------------------------------+</span><br></pre></td></tr></table></figure></p><h5 id="2-4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括-bin排序规则，尾随空间在比较过程是无关紧要的："><a href="#2-4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括-bin排序规则，尾随空间在比较过程是无关紧要的：" class="headerlink" title="2.4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括_bin排序规则，尾随空间在比较过程是无关紧要的："></a>2.4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括_bin排序规则，尾随空间在比较过程是无关紧要的：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; SELECT &apos;a &apos; = &apos;a&apos;;</span><br><span class="line">+------------+</span><br><span class="line">| &apos;a &apos; = &apos;a&apos; |</span><br><span class="line">+------------+</span><br><span class="line">|          1 |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure><p>对于二进制字符串，比较过程所有的字符都是重要的，包括尾随空间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES binary;</span><br><span class="line">mysql&gt; SELECT &apos;a &apos; = &apos;a&apos;;</span><br><span class="line">+------------+</span><br><span class="line">| &apos;a &apos; = &apos;a&apos; |</span><br><span class="line">+------------+</span><br><span class="line">|          0 |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure></p><h5 id="2-5、在插入和检索中的尾随空间处理："><a href="#2-5、在插入和检索中的尾随空间处理：" class="headerlink" title="2.5、在插入和检索中的尾随空间处理："></a>2.5、在插入和检索中的尾随空间处理：</h5><p>char(n)列存储非二进制字符串，当insert操作是，值小于n字符会使用空格扩展。在检索时尾随空间会被移除。<br>二进制列存储二进制字符串,插入过程中值小于n字节，会使用ox00扩展，在检索过程中不会被移除；总是返回声明长度的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE t1 (</span><br><span class="line">         a CHAR(10) CHARACTER SET utf8 COLLATE utf8_bin,</span><br><span class="line">         b BINARY(10)</span><br><span class="line">       );</span><br><span class="line">mysql&gt; INSERT INTO t1 VALUES (&apos;a&apos;,&apos;a&apos;);</span><br><span class="line">mysql&gt; SELECT HEX(a), HEX(b) FROM t1;</span><br><span class="line">+--------+----------------------+</span><br><span class="line">| HEX(a) | HEX(b)               |</span><br><span class="line">+--------+----------------------+</span><br><span class="line">| 61     | 61000000000000000000 |</span><br><span class="line">+--------+----------------------+</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql唯一性索引详解</title>
      <link href="/2018/09/05/mysql%E5%94%AF%E4%B8%80%E6%80%A7%E7%B4%A2%E5%BC%95/"/>
      <url>/2018/09/05/mysql%E5%94%AF%E4%B8%80%E6%80%A7%E7%B4%A2%E5%BC%95/</url>
      <content type="html"><![CDATA[<h3 id="1、唯一性索引创建条件："><a href="#1、唯一性索引创建条件：" class="headerlink" title="1、唯一性索引创建条件："></a>1、唯一性索引创建条件：</h3><p>唯一性索引创建一个约束条件要求索引列上的所有值必须是不同的，如果你尝试添加一行新数据，但该行的键值与已经存在的其他行的键值相同将会报错。如果为唯一性索引指定前缀值，前缀长度的列值要保证唯一。唯一性索引允许null值。</p><h3 id="2、唯一非空索引-rowid的使用："><a href="#2、唯一非空索引-rowid的使用：" class="headerlink" title="2、唯一非空索引_rowid的使用："></a>2、唯一非空索引_rowid的使用：</h3><p>如果一个表有主键索引或者唯一非空索引，且索引由一个单独整型列类型组成，你可以在select语句使用_rowid来引用索引列，具体如下：<br>_rowid引用主键列如果主键列由单个整型列组成，如果存在主键列但是他不是由一个单独整型列组成，_rowid不能被使用。<br>另外，_rowid引用第一个有单个整型列组成的唯一非空索引列，如果不是，_rowid不能被使用。</p><h3 id="3、创建测试表，并将列修改为唯一非空进行试验："><a href="#3、创建测试表，并将列修改为唯一非空进行试验：" class="headerlink" title="3、创建测试表，并将列修改为唯一非空进行试验："></a>3、创建测试表，并将列修改为唯一非空进行试验：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table unique_t(id int,name varchar(10));</span><br><span class="line">alter table unique_t add unique index id_unique_ind(id);</span><br><span class="line">alter table unique_t modify id int not null;</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                                      |</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL,</span><br><span class="line">  UNIQUE KEY `id_unique_ind` (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>插入测试数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">insert into unique_t values(1,&apos;a&apos;),(2,&apos;b&apos;),(3,&apos;c&apos;),(4,&apos;d&apos;),(6,&apos;e&apos;);</span><br><span class="line">select *,_rowid from unique_t;</span><br><span class="line">+----+------+--------+</span><br><span class="line">| id | name | _rowid |</span><br><span class="line">+----+------+--------+</span><br><span class="line">|  1 | a    |      1 |</span><br><span class="line">|  2 | b    |      2 |</span><br><span class="line">|  3 | c    |      3 |</span><br><span class="line">|  4 | d    |      4 |</span><br><span class="line">|  6 | e    |      6 |</span><br><span class="line">+----+------+--------+</span><br></pre></td></tr></table></figure></p><h3 id="4、删除唯一性索引，修改id默认列可以为空："><a href="#4、删除唯一性索引，修改id默认列可以为空：" class="headerlink" title="4、删除唯一性索引，修改id默认列可以为空："></a>4、删除唯一性索引，修改id默认列可以为空：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">alter table unique_t drop index id_unique_ind;</span><br><span class="line">alter table unique_t modify id int null;</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                     |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>为id列创建主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">alter table unique_t add primary key(id);</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                       |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">select *,_rowid from unique_t;</span><br><span class="line">+----+------+--------+</span><br><span class="line">| id | name | _rowid |</span><br><span class="line">+----+------+--------+</span><br><span class="line">|  1 | a    |      1 |</span><br><span class="line">|  2 | b    |      2 |</span><br><span class="line">|  3 | c    |      3 |</span><br><span class="line">|  4 | d    |      4 |</span><br><span class="line">|  6 | e    |      6 |</span><br><span class="line">+----+------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>给id添加主键约束和唯一非空约束，_rowid都可以引用对应列。</p><h3 id="5、删除id主键，将name列设置为主键测试"><a href="#5、删除id主键，将name列设置为主键测试" class="headerlink" title="5、删除id主键，将name列设置为主键测试"></a>5、删除id主键，将name列设置为主键测试</h3><p>alter table unique_t drop primary key;<br>alter table unique_t add primary key(name);<br>show index from unique_t;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| Table    | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| unique_t |          0 | PRIMARY  |            1 | name        | A         |           5 |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line"></span><br><span class="line"> show create table unique_t;</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                     |</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">root@db 07:11:  [exchange_market]&gt; select *,_rowid from unique_t;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &apos;_rowid&apos; in &apos;field list&apos;</span><br></pre></td></tr></table></figure></p><p>非单个整型列的主键，_rowid无法使用。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql前缀索引详解</title>
      <link href="/2018/09/05/mysql%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95/"/>
      <url>/2018/09/05/mysql%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95/</url>
      <content type="html"><![CDATA[<h3 id="1、使用前缀索引注意事项："><a href="#1、使用前缀索引注意事项：" class="headerlink" title="1、使用前缀索引注意事项："></a>1、使用前缀索引注意事项：</h3><p>1)、列类型为char，varchar，binary，varbinary可以创建前缀索引；<br>2)、列类型为blob，text必须创建前缀索引，而且只有innodb，myisam，blackhole的存储引擎前缀索引才生效；<br>3)、前缀限制是以字节为单位的，但是在create table，alter table，create index语句中索引指定的前缀长度的值为：非二进制类型的（cahr varchar，text）的字符串数据量、二进制类型的（binary，varbinary，blob）的字节数量。当用多字节字符串集为非二进制字符串列创建前缀索引长度时，需要考虑这一点。<br>是否支持前缀索引和前缀的长度跟存储引擎有关系。例如，innodb引擎表前缀索引支持767字节长度，如果开启innodb_large_prefix参数，支持3072字节长度。myisam存储引擎表，前缀长度为1000字节。NDB引擎不支持前缀索引。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_large_prefix'</span>;</span><br><span class="line">+<span class="comment">---------------------+-------+</span></span><br><span class="line">| Variable_name       | Value |</span><br><span class="line">+<span class="comment">---------------------+-------+</span></span><br><span class="line">| innodb_large_prefix | ON    |</span><br><span class="line">+<span class="comment">---------------------+-------+</span></span><br></pre></td></tr></table></figure></p><p>4)、以mysql5.7.17为例，如果一个指定的索引前缀长度超过最大列数据类型大小，create index时会如下处理索引：<br>对于非唯一索引，或者一个错误发生(严格sqlmode开启)，或者索引长度降低到最大列数据类型大小并产生一个警告信息(如果strcit sql mode没有开启)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;sql_mode&apos;;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                  |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>严格模式是指将SQL_MODE变量设置为STRICT_TRANS_TABLES或STRICT_ALL_TABLES中的至少一种。<br>对于唯一索引，不管sqlmode模式是何种，都会直接报错，因为降低索引长度会插入非唯一的条目不满足唯一性需求。</p><p>5)、创建前缀索引语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX part_of_name ON customer (name(10));</span><br></pre></td></tr></table></figure></p><p>如果列中的名字在前10个字节中通常是不同的，查询性能不应该慢于创建整个name列索引的查询。另外使用列前缀索引使索引文件更小，能够节省更多的磁盘空间并且增加插入速度。</p><h3 id="2、下面是根据网上提供的方法做的测试，参考链接"><a href="#2、下面是根据网上提供的方法做的测试，参考链接" class="headerlink" title="2、下面是根据网上提供的方法做的测试，参考链接"></a>2、下面是根据网上提供的方法做的测试，<a href="https://blog.csdn.net/dhrome/article/details/72853153" target="_blank" rel="noopener">参考链接</a></h3><p>1)、插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table music(</span><br><span class="line">name varchar(30)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into music values(&apos;BITE&apos;),(&apos;There for you&apos;),(&apos;Scarborough Fair&apos;),(&apos;Shape of You&apos;),(&apos;Marvin Gaye&apos;),(&apos;Pretty Girl&apos;),(&apos;Pretty Boy&apos;),(&apos;Walk Away&apos;),(&apos;YOUTH&apos;),(&apos;Paris&apos;);</span><br><span class="line"></span><br><span class="line">insert into music values (&apos;Scarborough Fair&apos;),(&apos;Shape of You&apos;),(&apos;Marvin Gaye&apos;),(&apos;Pretty Girl&apos;),(&apos;Pretty Boy&apos;),(&apos;Walk Away&apos;),(&apos;YOUTH&apos;),(&apos;Paris&apos;);</span><br></pre></td></tr></table></figure></p><p>2)、查看完整列索引选择性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:31:  [exchange_market]&gt; select count(distinct name) / count(*) from music;</span><br><span class="line">+---------------------------------+</span><br><span class="line">| count(distinct name) / count(*) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                          0.5556 |</span><br><span class="line">+---------------------------------+</span><br></pre></td></tr></table></figure></p><p>3)、查找合适的前缀索引长度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct left(name,1))/count(*) as sel1, count(distinct left(name,2))/count(*) as sel2, count(distinct left(name,3))/count(*) as sel3, count(distinct left(name,4))/count(*) as sel4 from music;</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">| sel1   | sel2   | sel3   | sel4   |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">| 0.3889 | 0.5000 | 0.5000 | 0.5000 |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></p><p>4)、可以看到当前缀长度为2是已经接近完整列索引选择性,添加前缀索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">alter table music add index music_index(name(2));</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">show index from music;</span><br><span class="line">+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| Table | Non_unique | Key_name    | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| music |          1 | music_index |            1 | name        | A         |           9 |        2 | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br></pre></td></tr></table></figure></p><p>5)、查询索引是否被正常应用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">select * from music where name like &apos;s%&apos;;</span><br><span class="line">+------------------+</span><br><span class="line">| name             |</span><br><span class="line">+------------------+</span><br><span class="line">| Scarborough Fair |</span><br><span class="line">| Scarborough Fair |</span><br><span class="line">| Shape of You     |</span><br><span class="line">| Shape of You     |</span><br><span class="line">+------------------+</span><br><span class="line">4 rows in set (0.07 sec)</span><br><span class="line"></span><br><span class="line">explain select * from music where name like &apos;s%&apos;;</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+-------------+---------+------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key         | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+-------------+---------+------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | music | NULL       | range | music_index   | music_index | 11      | NULL |    4 |   100.00 | Using where |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+-------------+---------+------+------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 使用mysqladmin查看innodb_buffer_pool缓存命中率及缓存使用情况</title>
      <link href="/2018/09/04/%E4%BD%BF%E7%94%A8mysqladmin%E6%9F%A5%E7%9C%8Binnodb_buffer_pool%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87%E5%8F%8A%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5/"/>
      <url>/2018/09/04/%E4%BD%BF%E7%94%A8mysqladmin%E6%9F%A5%E7%9C%8Binnodb_buffer_pool%E7%BC%93%E5%AD%98%E5%91%BD%E4%B8%AD%E7%8E%87%E5%8F%8A%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5/</url>
      <content type="html"><![CDATA[<h3 id="1、查看缓存命中率"><a href="#1、查看缓存命中率" class="headerlink" title="1、查看缓存命中率"></a>1、查看缓存命中率</h3><p>计算缓存命中率相关参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Innodb_buffer_pool_reads：innodb缓存无法满足逻辑读，不得不从磁盘获取数据的逻辑读数量</span><br><span class="line">Innodb_buffer_pool_read_requests：逻辑读的请求数量</span><br></pre></td></tr></table></figure></p><p>如果查看当前某一时刻的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> mysqladmin -uroot -p12345678  ext | grep Innodb_buffer_pool_reads</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_reads                      | 31763701                                         |</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> mysqladmin -uroot -p12345678 ext | grep Innodb_buffer_pool_read_requests </span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 866018530                                        |</span><br></pre></td></tr></table></figure><p>如果想要查看多次的取值，并计算间隔的差值(-i 1间隔为1s)(-r 获取前后两个值之间的差值)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_reads</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_reads                      | 31763701                                         |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_reads                      | 0                                                |</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_read_requests </span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 866018530                                        |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_read_requests              | 0                                                |</span><br></pre></td></tr></table></figure><p>也可指定-c(value)参数，指定获取几次的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 -c5 ext | grep Innodb_buffer_pool_read_requests</span><br></pre></td></tr></table></figure></p><p>根据获取到的值计算缓存命中率：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Innodb_buffer_pool_read_requests-Innodb_buffer_pool_reads)/Innodb_buffer_pool_read_requests</span><br></pre></td></tr></table></figure></p><p>如果太低，建议增大innodb_buffer_pool</p><h3 id="2、查看缓存池使用情况"><a href="#2、查看缓存池使用情况" class="headerlink" title="2、查看缓存池使用情况"></a>2、查看缓存池使用情况</h3><p>缓存池使用情况参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Innodb_buffer_pool_pages_free:innodb buffer pool空闲页；</span><br><span class="line">Innodb_buffer_pool_pages_data：innodb buffer pool包含数据的页数量：</span><br><span class="line">Innodb_buffer_pool_pages_total：innodb buffer pool内存页总数量(每页16k)；</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_pages_free</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 31974                                            |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_free                 | 0                                                |</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_pages_data</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 96923                                            |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_data                 | 0                                                |</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p12345678 -ri1 ext | grep Innodb_buffer_pool_pages_total</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 131056                                           |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br><span class="line">| Innodb_buffer_pool_pages_total                | 0                                                |</span><br></pre></td></tr></table></figure><p>如果Innodb_buffer_pool_pages_free偏大的话，证明有很多缓存没有被利用到，这时可以考虑减小缓存，相反Innodb_buffer_pool_pages_data过大就考虑增大缓存。</p><h3 id="3、另附使用mysqladmin查询qps的方法，参考链接"><a href="#3、另附使用mysqladmin查询qps的方法，参考链接" class="headerlink" title="3、另附使用mysqladmin查询qps的方法，参考链接"></a>3、另附使用mysqladmin查询qps的方法，<a href="http://blog.itpub.net/31475233/viewspace-2142864/" target="_blank" rel="noopener">参考链接</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -P3306 -uroot -p12345678  -ri1 ext |\</span><br><span class="line">awk -F&quot;|&quot; \</span><br><span class="line">&quot;BEGIN&#123; count=0; &#125;&quot;\</span><br><span class="line">&apos;&#123; if($2 ~ /Variable_name/ &amp;&amp; ((++count)%20 == 1))&#123;\</span><br><span class="line">  print &quot;----------|---------|--- MySQL Command Status --|----- Innodb row operation ----|-- Buffer Pool Read --&quot;;\</span><br><span class="line">  print &quot;---Time---|---QPS---|select insert update delete| read inserted updated deleted|  logical  physical&quot;;\</span><br><span class="line">&#125;\</span><br><span class="line">else if ($2 ~ /Queries/)&#123;queries=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_select /)&#123;com_select=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_insert /)&#123;com_insert=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_update /)&#123;com_update=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Com_delete /)&#123;com_delete=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_read/)&#123;innodb_rows_read=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_deleted/)&#123;innodb_rows_deleted=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_inserted/)&#123;innodb_rows_inserted=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_rows_updated/)&#123;innodb_rows_updated=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_buffer_pool_read_requests/)&#123;innodb_lor=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Innodb_buffer_pool_reads/)&#123;innodb_phr=$3;&#125;\</span><br><span class="line">else if ($2 ~ /Uptime / &amp;&amp; count &gt;= 2)&#123;\</span><br><span class="line"> printf(&quot; %s |%9d&quot;,strftime(&quot;%H:%M:%S&quot;),queries);\</span><br><span class="line"> printf(&quot;|%6d %6d %6d %6d&quot;,com_select,com_insert,com_update,com_delete);\</span><br><span class="line"> printf(&quot;|%6d %8d %7d %7d&quot;,innodb_rows_read,innodb_rows_inserted,innodb_rows_updated,innodb_rows_deleted);\</span><br><span class="line"> printf(&quot;|%10d %11d\n&quot;,innodb_lor,innodb_phr);\</span><br><span class="line">&#125;&#125;&apos;</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql blackhole-engine详解</title>
      <link href="/2018/09/04/mysql%20blackhole-engine/"/>
      <url>/2018/09/04/mysql%20blackhole-engine/</url>
      <content type="html"><![CDATA[<h3 id="1、mysql-黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。"><a href="#1、mysql-黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。" class="headerlink" title="1、mysql 黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。"></a>1、mysql 黑洞引擎就像黑洞一样，能接受数据，但把接受的数据扔掉，不存储数据，检查结果返回为空。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE test(i INT, c CHAR(10)) ENGINE = BLACKHOLE;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">mysql&gt; INSERT INTO test VALUES(1,&apos;record one&apos;),(2,&apos;record two&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line">mysql&gt; SELECT * FROM test;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为-frm，没有与该表关联的其他文件"><a href="#2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为-frm，没有与该表关联的其他文件" class="headerlink" title="2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为.frm，没有与该表关联的其他文件"></a>2、创建黑洞引擎表，数据目录下回创建表格式文件，以表明开头后缀为.frm，没有与该表关联的其他文件</h3><p>黑洞引擎支持所有类型的索引，定义表时，可以声明索引。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll test.*</span><br><span class="line">-rw-r----- 1 mysql mysql 8578 Sep  4 06:22 test.frm</span><br></pre></td></tr></table></figure></p><h3 id="3、可以通过show-engines查看是否支持黑洞引擎："><a href="#3、可以通过show-engines查看是否支持黑洞引擎：" class="headerlink" title="3、可以通过show engines查看是否支持黑洞引擎："></a>3、可以通过show engines查看是否支持黑洞引擎：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span><br></pre></td></tr></table></figure><h3 id="4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。"><a href="#4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。" class="headerlink" title="4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。"></a>4、黑洞引擎表不存储任何数据，但是如果启用了二进制日志，sql语句会被记录并复制到从库，这对于中继机制和过滤机制很有用。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设您的应用程序需要从属端过滤规则，但是传输所有的二进制数据到从库会造成很大的网络流量，在这种情况下，在主库设置存储引擎为黑洞的‘dummy’从进程，如下图所示：</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/cxMKOso.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主库写入二级制日志，‘dummy’mysqld 进程作为从进程执行，合并replicate-do-* 和replicate-ignore-*规则，自己写入一个新的，过滤好的二进制日志，该过滤日志传递给从库。</span><br><span class="line">虚拟的进程不存储任何数据，因此外的mysqld进程复制主库信息产生少量的开销。</span><br><span class="line">黑洞引擎表，insert触发器可正常使用，但是因为不存储数据，update和delete引擎没有激活，因为没有行，for each row触发器定义不适用。</span><br></pre></td></tr></table></figure></p><h3 id="5、黑洞引擎的用途："><a href="#5、黑洞引擎的用途：" class="headerlink" title="5、黑洞引擎的用途："></a>5、黑洞引擎的用途：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、验证转储文件语法</span><br><span class="line">2、启用或禁用二级制日志，来测量二进制日志带来的开销</span><br><span class="line">3、黑洞引擎本质上是一个无操作的引擎，因此可以用于查找与引擎本身无关的性能瓶颈。</span><br></pre></td></tr></table></figure><p>黑洞引擎是交易感知的，提交的事物写入二进制日志，回滚事物不写入。</p><h3 id="6、黑洞引擎和自动增量列的问题："><a href="#6、黑洞引擎和自动增量列的问题：" class="headerlink" title="6、黑洞引擎和自动增量列的问题："></a>6、黑洞引擎和自动增量列的问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">主从架构数据库：1、主库黑洞表有一个自动增量字段是主键；2、从服务器有相同表引擎为myisam，3、主库执行insert，并隐式设置增量值。</span><br><span class="line">在这种情况下，主从复制将失败，</span><br><span class="line">如果主站有许多从站，则在发送到从站之前进行过滤可能会减少网络流量。</span><br><span class="line">在基于行的复制中，引擎为行返回的值对于每个插入始终是相同的。这将导致从服务器尝试使用主键列的相同值重播两个插入日志条目，因此复制将失败。</span><br></pre></td></tr></table></figure><h3 id="7、黑洞引擎和列过滤问题："><a href="#7、黑洞引擎和列过滤问题：" class="headerlink" title="7、黑洞引擎和列过滤问题："></a>7、黑洞引擎和列过滤问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">基于行的复制，从库支持表中缺少最后一列。</span><br><span class="line">从库端执行过滤，在执行过滤之前，先将数据传到从库，最少有两种情况不希望将列拷贝到从库：</span><br><span class="line">1、数据是机密的，从库没有权限访问它；</span><br><span class="line">2、主库有多个从库，在发送到从库之前执行过滤用于减少网络带宽</span><br></pre></td></tr></table></figure><p>官方文档提供的案例如下,对于受信任和不受信任从库的语句未找到合理解释，没看懂：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用BLACKHOLE引擎和 --replicate-do-table或 --replicate-ignore-table选项，可以实现主列过滤，</span><br><span class="line">主库配置：</span><br><span class="line">CREATE TABLE t1 (public_col_1, ..., public_col_N,</span><br><span class="line">                 secret_col_1, ..., secret_col_M) ENGINE=MyISAM;</span><br><span class="line">受信任的从库配置：</span><br><span class="line">CREATE TABLE t1 (public_col_1, ..., public_col_N) ENGINE=BLACKHOLE;</span><br><span class="line">不受信任的从库配置：</span><br><span class="line">CREATE TABLE t1 (public_col_1, ..., public_col_N) ENGINE=MyISAM;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Grafana] grafana监控redis、mongodb、mysql数据库</title>
      <link href="/2018/08/29/grafana+prometheus%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7mysql%E3%80%81redis%E3%80%81mongodb/"/>
      <url>/2018/08/29/grafana+prometheus%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7mysql%E3%80%81redis%E3%80%81mongodb/</url>
      <content type="html"><![CDATA[<h3 id="0、参考链接"><a href="#0、参考链接" class="headerlink" title="0、参考链接"></a>0、参考链接</h3><p><a href="https://mp.weixin.qq.com/s/Qz87UE1aXFZbAdFlx7Zeow" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Qz87UE1aXFZbAdFlx7Zeow</a></p><h3 id="1、grafana下载安装"><a href="#1、grafana下载安装" class="headerlink" title="1、grafana下载安装"></a>1、grafana下载安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.2.2-1.x86_64.rpm</span><br><span class="line">sudo yum localinstall grafana-5.2.2-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p>启动grafana<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service grafana-server start</span><br><span class="line">service grafana-server status</span><br></pre></td></tr></table></figure></p><p>加入开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add grafana-server</span><br></pre></td></tr></table></figure></p><p>查看grafana端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -plntu | grep grafana-serv</span><br><span class="line">tcp6       0      0 :::3000                 :::*                    LISTEN      2539/grafana-server</span><br></pre></td></tr></table></figure></p><p>登录web界面，localhost:3000<br>用户：admin<br>密码：admin（默认）<br>登录之后提示修改密码,登录界面如下图所示<br><img src="https://i.imgur.com/drKlMKC.png" alt=""></p><h3 id="2、安装Prometheus"><a href="#2、安装Prometheus" class="headerlink" title="2、安装Prometheus"></a>2、安装Prometheus</h3><p>下载Prometheus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.3.2/prometheus-2.3.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p><p>解压安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf prometheus-2.3.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p><p>配置 Prometheus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd prometheus-2.3.2.linux-amd64/</span><br><span class="line">cat prometheus.yml </span><br><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&apos;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;0.0.0.0:9090&apos;]</span><br></pre></td></tr></table></figure></p><p>启动prometheus<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml</span><br><span class="line">----</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966212621Z caller=main.go:222 msg=&quot;Starting Prometheus&quot; version=&quot;(version=2.3.2, branch=HEAD, revision=71af5e29e815795e9dd14742ee7725682fa14b7b)&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966876421Z caller=main.go:223 build_context=&quot;(go=go1.10.3, user=root@5258e0bd9cc1, date=20180712-14:02:52)&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966953021Z caller=main.go:224 host_details=&quot;(Linux 3.10.0-693.21.1.el7.x86_64 #1 SMP Wed Mar 7 19:03:37 UTC 2018 x86_64 dax-mysql-mha (none))&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.966990021Z caller=main.go:225 fd_limits=&quot;(soft=1024, hard=4096)&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.968101421Z caller=main.go:533 msg=&quot;Starting TSDB ...&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.970314221Z caller=web.go:415 component=web msg=&quot;Start listening for connections&quot; address=0.0.0.0:9090</span><br><span class="line">level=info ts=2018-08-28T03:42:08.977918922Z caller=main.go:543 msg=&quot;TSDB started&quot;</span><br><span class="line">level=info ts=2018-08-28T03:42:08.977966022Z caller=main.go:603 msg=&quot;Loading configuration file&quot; filename=prometheus.yml</span><br><span class="line">level=info ts=2018-08-28T03:42:08.979126022Z caller=main.go:629 msg=&quot;Completed loading of configuration file&quot; filename=prometheus.yml</span><br><span class="line">level=info ts=2018-08-28T03:42:08.979171222Z caller=main.go:502 msg=&quot;Server is ready to receive web requests.&quot;</span><br><span class="line">level=info ts=2018-08-28T05:00:04.558075427Z caller=compact.go:398 component=tsdb msg=&quot;write block&quot; mint=1535421600000 maxt=1535428800000 ulid=01CNZEEBGJ237RVH965D3VWT57</span><br><span class="line">level=info ts=2018-08-28T05:00:04.566214242Z caller=head.go:348 component=tsdb msg=&quot;head GC completed&quot; duration=1.539902ms</span><br><span class="line">level=info ts=2018-08-28T05:00:04.575381958Z caller=head.go:357 component=tsdb msg=&quot;WAL truncation completed&quot; duration=9.095816ms</span><br><span class="line">-----</span><br></pre></td></tr></table></figure></p><p>登录控制台 localhost:9090,登录界面如下：<br><img src="https://i.imgur.com/xMfoPTq.png" alt=""></p><h3 id="3、mysql-exporter部署"><a href="#3、mysql-exporter部署" class="headerlink" title="3、mysql_exporter部署"></a>3、mysql_exporter部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf mysqld_exporter-0.11.0.linux-amd64.tar.gz </span><br><span class="line">cd mysqld_exporter-0.11.0.linux-amd64/</span><br></pre></td></tr></table></figure><p>配置连接数据库文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat .my.cnf</span><br><span class="line">[client]</span><br><span class="line">host = 127.0.0.1</span><br><span class="line">user=root</span><br><span class="line">password=12345678</span><br></pre></td></tr></table></figure></p><p>启动mysqld_exporter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./mysqld_exporter --config.my-cnf=&quot;/data/soft/mysqld_exporter-0.11.0.linux-amd64/.my.cnf&quot;  </span><br><span class="line">----</span><br><span class="line">INFO[0000] Starting mysqld_exporter (version=0.11.0, branch=HEAD, revision=5d7179615695a61ecc3b5bf90a2a7c76a9592cdd)  source=&quot;mysqld_exporter.go:206&quot;</span><br><span class="line">INFO[0000] Build context (go=go1.10.3, user=root@3d3ff666b0e4, date=20180629-15:00:35)  source=&quot;mysqld_exporter.go:207&quot;</span><br><span class="line">INFO[0000] Enabled scrapers:                             source=&quot;mysqld_exporter.go:218&quot;</span><br><span class="line">INFO[0000]  --collect.global_status                      source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000]  --collect.global_variables                   source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000]  --collect.slave_status                       source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000]  --collect.info_schema.tables                 source=&quot;mysqld_exporter.go:222&quot;</span><br><span class="line">INFO[0000] Listening on :9104                            source=&quot;mysqld_exporter.go:232&quot;</span><br><span class="line">----</span><br></pre></td></tr></table></figure></p><p>查看进程是否启动正常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp|grep 9104</span><br></pre></td></tr></table></figure></p><p>登录web界面,<a href="http://localhost:9104/" target="_blank" rel="noopener">http://localhost:9104/</a><br><img src="https://i.imgur.com/aqDGY1B.png" alt=""><br>修改vim prometheus.yml配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- job_name: mysql</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&apos;127.0.0.1:9104&apos;]</span><br><span class="line">        labels:</span><br><span class="line">          instance: test</span><br></pre></td></tr></table></figure></p><p>备注:<br>job_name,当前执行job的名字<br>targets，连接的主机<br>instance，数据库实例的标签明</p><p>重新启动prometheus，进入prometheus控制台，点击status-&gt;target<br><img src="https://i.imgur.com/ecV2em3.png" alt=""></p><h3 id="4、添加数据源"><a href="#4、添加数据源" class="headerlink" title="4、添加数据源"></a>4、添加数据源</h3><p><img src="https://i.imgur.com/MDVSTgs.png" alt=""><br><img src="https://i.imgur.com/NCJXDQj.png" alt=""><br>保存测试</p><h3 id="5、下载仪表盘"><a href="#5、下载仪表盘" class="headerlink" title="5、下载仪表盘"></a>5、下载仪表盘</h3><p><a href="https://github.com/percona/grafana-dashboards/tree/master/dashboards">https://github.com/percona/grafana-dashboards/tree/master/dashboards</a><br>选择仪表盘类型，导入到grafana<br><img src="https://i.imgur.com/L0zhbuM.png" alt=""><br><img src="https://i.imgur.com/PkzRe5Y.png" alt=""><br><img src="https://i.imgur.com/1eYa7uN.png" alt=""><br>点击仪表盘查看<br><img src="https://i.imgur.com/i5qvt2u.png" alt=""></p><h3 id="6、mongodb-exporter部署用于监控mongodb"><a href="#6、mongodb-exporter部署用于监控mongodb" class="headerlink" title="6、mongodb_exporter部署用于监控mongodb"></a>6、mongodb_exporter部署用于监控mongodb</h3><p>prometheus监控mongodb数据库，安装之前需要配置go环境下载配置go环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.google.com/go/go1.11.linux-amd64.tar.gz</span><br><span class="line">tar -C /usr/local -xzf go1.11.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure></p><p>添加环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;</span><br><span class="line">GOPATH=$HOME/go</span><br><span class="line">export PATH=$PATH:$GOPATH/bin&quot; &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p>使配置的环境变量生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p>创建配置mognodb所需要的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/go/&#123;dir,src,pkg&#125;</span><br></pre></td></tr></table></figure></p><p>安装glide<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://glide.sh/get | sh</span><br></pre></td></tr></table></figure></p><p>安装mongodb-exporter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:dcu/mongodb_exporter.git $GOPATH/src/github.com/dcu/mongodb_exporter</span><br><span class="line">cd $GOPATH/src/github.com/dcu/mongodb_exporter</span><br><span class="line">make build</span><br></pre></td></tr></table></figure></p><p>查看mongdob_exporter使用的参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mongodb_exporter -h</span><br></pre></td></tr></table></figure></p><p>启动mongodb_exporter,获取数据库的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mongodb_exporter -mongodb.uri mongodb://localhost:30000</span><br></pre></td></tr></table></figure></p><p>启动端口默认为9001,登录<a href="http://localhost:9001，查看是否正常" target="_blank" rel="noopener">http://localhost:9001，查看是否正常</a><br><img src="https://i.imgur.com/1pnvKo4.png" alt=""><br>修改prometheus.yml，添加mongodb参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: mongodb</span><br><span class="line">  static_configs:</span><br><span class="line">    - targets: [&apos;127.0.0.1:9001&apos;]</span><br></pre></td></tr></table></figure></p><p>重启premetheus,登录premetheus控制台查看获取mognodb是否正常<br><img src="https://i.imgur.com/UK4EwiK.png" alt=""><br>登录grafana添加模板，可以添加模板id或者导入代码<br><img src="https://i.imgur.com/24JBVvP.png" alt=""><br>点击<a href="https://grafana.com/dashboards/2583" target="_blank" rel="noopener">链接</a>，跳转到mongodb_exporter模板<br>添加完成模板如下图所示：<br><img src="https://i.imgur.com/O0lRt1R.png" alt=""></p><h3 id="7、redis-exporter部署用于监控redis-安装redis-exporter模板"><a href="#7、redis-exporter部署用于监控redis-安装redis-exporter模板" class="headerlink" title="7、redis_exporter部署用于监控redis,安装redis-exporter模板"></a>7、redis_exporter部署用于监控redis,安装redis-exporter模板</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/oliver006/redis_exporter</span><br><span class="line">cd $GOPATH/src/github.com/oliver006/redis_exporter</span><br><span class="line">go build</span><br></pre></td></tr></table></figure><p>启动redis_exporter进程获取redis数据(默认进程端口号位9121)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis_exporter -redis.addr redis://127.0.0.1:6379 -redis.password test</span><br></pre></td></tr></table></figure></p><p>启动端口默认为9001,登录<a href="http://localhost:9121，查看是否正常" target="_blank" rel="noopener">http://localhost:9121，查看是否正常</a><br><img src="https://i.imgur.com/Xaokb9P.png" alt=""><br>修改prometheus.yml，添加redis参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: redis</span><br><span class="line">  static_configs:</span><br><span class="line">     - targets: [&apos;127.0.0.1:9121&apos;]</span><br></pre></td></tr></table></figure></p><p>重启premetheus,登录premetheus控制台查看获取redis是否正常<br><img src="https://i.imgur.com/FzmeelO.png" alt=""><br>登录grafana添加模板，可以添加模板id或者导入代码,点击<a href="https://github.com/oliver006/redis_exporter/blob/master/contrib/grafana_prometheus_redis_dashboard_alias.json">此处</a>跳转到redis_exporter链接<br>，导入完成之后界面如下图所示：<br><img src="https://i.imgur.com/4M5y84Y.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mongodb </tag>
            
            <tag> redis </tag>
            
            <tag> grafana </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] 解决zabbix中文乱码问题</title>
      <link href="/2018/08/28/%E8%A7%A3%E5%86%B3zabbix%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/"/>
      <url>/2018/08/28/%E8%A7%A3%E5%86%B3zabbix%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/</url>
      <content type="html"><![CDATA[<h3 id="1、在windows机器上查找simkai-ttf文件，在windows下拷贝simkai字体到zabbix-server端，并拷贝到相应目录"><a href="#1、在windows机器上查找simkai-ttf文件，在windows下拷贝simkai字体到zabbix-server端，并拷贝到相应目录" class="headerlink" title="1、在windows机器上查找simkai.ttf文件，在windows下拷贝simkai字体到zabbix server端，并拷贝到相应目录"></a>1、在windows机器上查找simkai.ttf文件，在windows下拷贝simkai字体到zabbix server端，并拷贝到相应目录</h3><p>可在c盘路径下搜索simkai.ttf，本地机器的路径为‘C:\Windows\WinSxS\amd64_microsoft-windows-font-truetype-simkai_31bf3856ad364e35_10.0.17134.1_none_d7e1e1a5de638405’，每台机器对应的目录会有差异，但‘C:\Windows\WinSxS’路径一致。</p><h3 id="2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下"><a href="#2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下" class="headerlink" title="2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下"></a>2、将找到的simkai文件上传到zabbix-server端nginx的安装目录下</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv simkai.ttf /data/nginx-1.9.15/html/zabbix/fonts/</span><br></pre></td></tr></table></figure><h3 id="3、修改nginx配置文件"><a href="#3、修改nginx配置文件" class="headerlink" title="3、修改nginx配置文件"></a>3、修改nginx配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/DejaVuSans/simkai/g&apos; /data/nginx-1.9.15/html/zabbix/include/defines.inc.php</span><br></pre></td></tr></table></figure><h3 id="4、重启php-fpm、nginx"><a href="#4、重启php-fpm、nginx" class="headerlink" title="4、重启php-fpm、nginx"></a>4、重启php-fpm、nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop</span><br><span class="line">service php-fpm stop</span><br><span class="line">service php-fpm start</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控磁盘io总吞吐量批量安装配置</title>
      <link href="/2018/08/27/zabbix%E7%9B%91%E6%8E%A7%E7%A3%81%E7%9B%98io%E6%80%BB%E5%90%9E%E5%90%90%E9%87%8F/"/>
      <url>/2018/08/27/zabbix%E7%9B%91%E6%8E%A7%E7%A3%81%E7%9B%98io%E6%80%BB%E5%90%9E%E5%90%90%E9%87%8F/</url>
      <content type="html"><![CDATA[<h2 id="0、编辑监控磁盘io总吞吐量脚本"><a href="#0、编辑监控磁盘io总吞吐量脚本" class="headerlink" title="0、编辑监控磁盘io总吞吐量脚本"></a>0、编辑监控磁盘io总吞吐量脚本</h2><p>cat /home/zabbix/disk_io_check.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">sudo bash</span><br><span class="line">#安装iostat命令</span><br><span class="line">yum install -y sysstat </span><br><span class="line">#创建监控目录及数据文件</span><br><span class="line">mkdir -p /usr/local/zabbix/script</span><br><span class="line">touch /usr/local/zabbix/script/iostat_data.txt</span><br><span class="line">chown zabbix.zabbix /usr/local/zabbix/script/iostat_data.txt</span><br><span class="line">chmod 777 /usr/local/zabbix/script/iostat_data.txt</span><br><span class="line">touch /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">chown zabbix.zabbix /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">chmod 777 /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">#编辑收集数据脚本</span><br><span class="line">echo &quot;</span><br><span class="line">#!/bin/bash</span><br><span class="line">iostat -dxkt 1 2|grep -E &apos;^sd|^xvda|^vd&apos; &gt; /usr/local/zabbix/script/iostat_data.txt&quot; &gt; /usr/local/zabbix/script/iostat_collect_data.sh</span><br><span class="line">#添加到定时任务，每分钟收集一次</span><br><span class="line">echo &quot;* * * * * root sh /usr/local/zabbix/script/iostat_collect_data.sh&quot; &gt;&gt; /etc/crontab</span><br><span class="line">#添加参数到zabbix配置文件</span><br><span class="line">echo &quot;</span><br><span class="line">#每秒进行 merge 的读操作数目。即 rmerge/s</span><br><span class="line">UserParameter=disk.status.rmerge,cat /usr/local/zabbix/script/iostat_data.txt|tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$2&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos; </span><br><span class="line">#每秒进行 merge 的写操作数目。即 wmerge/s</span><br><span class="line">UserParameter=disk.status.wmerge,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$3&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒完成的读 I/O 设备次数。即 rio/s</span><br><span class="line">UserParameter=disk.status.rio,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$4&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒完成的写 I/O 设备次数。即 wio/s</span><br><span class="line">UserParameter=disk.status.wio,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$5&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。</span><br><span class="line">UserParameter=disk.status.rsect,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$6&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#每秒写K字节数。是 wsect/s 的一半。</span><br><span class="line">UserParameter=disk.status.wsect,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$7&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O操作的数据大小 (扇区)。</span><br><span class="line">UserParameter=disk.status.sectsize,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$8&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均I/O队列长度。</span><br><span class="line">UserParameter=disk.status.queuelength,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$9&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O操作的等待时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.avgiowait,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$10&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O读操作的等待时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.avgreadiowait,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$11&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O写操作的等待时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.avgwriteiowait,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$12&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">#平均每次设备I/O操作的服务时间 (毫秒)。</span><br><span class="line">UserParameter=disk.status.svctm,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$13&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line"># 一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比</span><br><span class="line">UserParameter=disk.status.util,cat /usr/local/zabbix/script/iostat_data.txt |tail -n \`iostat -dxk 1 1|grep -E &apos;^sd|^xvda|^vd&apos;|wc -l\` |awk &apos;&#123;print \$14&#125;&apos;|awk &apos;&#123;sum+=\$1&#125; END &#123;print  sum&#125;&apos;</span><br><span class="line">&quot; &gt; /usr/local/zabbix/etc/zabbix_agentd.conf.d/iostat_data.conf</span><br><span class="line">echo &quot;</span><br><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d</span><br><span class="line">&quot; &gt;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line">#重新启动zabbix_agent客户端</span><br><span class="line">/etc/init.d/zabbix_agentd restart</span><br><span class="line">#查看监控进程是否启动</span><br><span class="line">netstat -tunlp|grep 10050</span><br></pre></td></tr></table></figure></p><h2 id="1、如果需要批量安装，在ansible-server端配置批量上传脚本"><a href="#1、如果需要批量安装，在ansible-server端配置批量上传脚本" class="headerlink" title="1、如果需要批量安装，在ansible-server端配置批量上传脚本"></a>1、如果需要批量安装，在ansible-server端配置批量上传脚本</h2><p>cat /etc/ansible/scopy-diskio-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix-agent config to all hosts</span><br><span class="line">    copy: src=&quot;/home/zabbix/disk_io_check.sh&quot; dest=&quot;/home/zabbix/disk_io_check.sh&quot;</span><br></pre></td></tr></table></figure></p><p>执行批量上传脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-diskio-zabbix.sh</span><br></pre></td></tr></table></figure></p><p>执行脚本批量配置监控磁盘io总吞吐量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/execute-zabbix.sh&apos;</span><br></pre></td></tr></table></figure></p><h2 id="2、web端配置监控模板，亦可自行编译，点击此处下载"><a href="#2、web端配置监控模板，亦可自行编译，点击此处下载" class="headerlink" title="2、web端配置监控模板，亦可自行编译，点击此处下载"></a>2、web端配置监控模板，亦可自行编译，点击此处<a href="https://pan.baidu.com/s/1aJmOWwVpdPAaoBABQGiBig" target="_blank" rel="noopener">下载</a></h2>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix-agent批量安装配置</title>
      <link href="/2018/08/27/zabbix-agent%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85/"/>
      <url>/2018/08/27/zabbix-agent%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<h2 id="0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible"><a href="#0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible" class="headerlink" title="0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible"></a>0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure><h2 id="1、修改ansible-server端免交互登录"><a href="#1、修改ansible-server端免交互登录" class="headerlink" title="1、修改ansible-server端免交互登录"></a>1、修改ansible-server端免交互登录</h2><p>cat /etc/ssh/ssh_config<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StrictHostKeyChecking no</span><br><span class="line">UserKnownHostsFile /dev/null</span><br></pre></td></tr></table></figure></p><p>修改好配置后，重新启动sshd服务即可，命令为：/etc/init.d/sshd restart （或 service sshd restart 或/bin/systemctl restart  sshd.service）</p><h2 id="2、编辑-etc-ansible-hosts主机配置文件"><a href="#2、编辑-etc-ansible-hosts主机配置文件" class="headerlink" title="2、编辑/etc/ansible/hosts主机配置文件"></a>2、编辑/etc/ansible/hosts主机配置文件</h2><p>cat /etc/ansible/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[test]</span><br><span class="line">172.29.25.196   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos </span><br><span class="line">172.29.16.6   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos</span><br><span class="line">172.29.20.97   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos</span><br></pre></td></tr></table></figure></p><p>hosts文件使用参数详解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible_ssh_host   #用于指定被管理的主机的真实IP</span><br><span class="line">ansible_ssh_port   #用于指定连接到被管理主机的ssh端口号，默认是22</span><br><span class="line">ansible_ssh_user   #ssh连接时默认使用的用户名</span><br><span class="line">ansible_ssh_pass   #ssh连接时的密码</span><br><span class="line">ansible_sudo_pass  #使用sudo连接用户时的密码</span><br><span class="line">ansible_sudo_exec  #如果sudo命令不在默认路径，需要指定sudo命令路径 </span><br><span class="line">ansible_ssh_private_key_file #秘钥文件路径，秘钥文件如果不想使用ssh-agent管理时可以使用此选项 </span><br><span class="line">ansible_shell_type          #目标系统的shell的类型，默认sh </span><br><span class="line">ansible_connection         #SSH 连接的类型： local , ssh , paramiko，在 ansible 1.2 之前默认是 paramiko ，后来智能选择，优先使用基于 ControlPersist 的 ssh(支持的前提)</span><br><span class="line">ansible_python_interpreter  #用来指定python解释器的路径，默认为/usr/bin/python 同样可以指定ruby 、perl 的路径 </span><br><span class="line">ansible_*_interpreter     #其他解释器路径，用法和ansible_python_interpreter类似，这里&quot;*&quot;可以是ruby或才perl等其他语言</span><br></pre></td></tr></table></figure></p><p>上例中使用的是私钥和用户名，如果想要使用执行端口，密码，用户名可参考上面详解参数。</p><h2 id="3、编辑批量上传脚本"><a href="#3、编辑批量上传脚本" class="headerlink" title="3、编辑批量上传脚本"></a>3、编辑批量上传脚本</h2><p>cat /etc/ansible/scopy-test-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix to all hosts</span><br><span class="line">    copy: src=&quot;/root/zabbix-3.4.2.tar.gz&quot; dest=&quot;/home/centos/zabbix-3.4.2.tar.gz&quot;</span><br><span class="line">  - name: scopy zabbix-agent config to all hosts</span><br><span class="line">    copy: src=&quot;/home/centos/execute-zabbix.sh&quot; dest=&quot;/home/centos/execute-zabbix.sh&quot;</span><br></pre></td></tr></table></figure></p><p>src:代表本机的源文件，dest代表目标端的路径<br>hosts：要与/etc/ansible/hosts下的[test]保持一致。</p><p>execute-zabbix.sh脚本为安装zabbix-agent脚本<br>cat /home/centos/execute-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"> mkdir /home/zabbix</span><br><span class="line"> useradd -r -s /sbin/nologin zabbix</span><br><span class="line"> yum -y install gcc gcc-c++ pcre-devel openssl-devel</span><br><span class="line"> mv /home/centos/zabbix-3.4.2.tar.gz /home/zabbix/</span><br><span class="line">cd /home/zabbix</span><br><span class="line"> tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line"> /home/zabbix/zabbix-3.4.2/configure --prefix=/usr/local/zabbix --enable-agent  --with-openssl </span><br><span class="line"> make </span><br><span class="line"> make install</span><br><span class="line">#host1=`ifconfig eth0 |awk -F &apos;[ :]+&apos; &apos;NR==2 &#123;print $3&#125;&apos;`</span><br><span class="line">host1=`ip addr |grep dynamic |awk &apos;&#123;print $2&#125;&apos;|awk -F&apos;/&apos; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">echo &quot;LogFile=/tmp/zabbix_agentd.log</span><br><span class="line">Server=172.29.12.85</span><br><span class="line">ServerActive=172.29.12.85</span><br><span class="line">Hostname=$host1&quot;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line"></span><br><span class="line">cp /home/zabbix/zabbix-3.4.2/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/         </span><br><span class="line">ln -s /usr/local/zabbix/etc/zabbix_agentd.conf /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">sed -i &apos;s/BASEDIR=\/usr\/local/BASEDIR=\/usr\/local\/zabbix/g&apos; /etc/init.d/zabbix_agentd</span><br><span class="line">service zabbix_agentd start</span><br><span class="line">chkconfig --add zabbix_agentd</span><br><span class="line">chkconfig --level 35 zabbix_agentd on                                                  </span><br><span class="line">netstat -lnpt | grep zabbix_agent</span><br></pre></td></tr></table></figure></p><p>server端的ip地址根据自己的zabbix-proxy或者zabbix-server自行定义。</p><p>执行批量脚本将文件上传到目标端：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-test-zabbix.sh</span><br></pre></td></tr></table></figure></p><p>在ansible-server端执行批量安装脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/execute-zabbix.sh&apos;</span><br></pre></td></tr></table></figure></p><h2 id="4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端"><a href="#4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端" class="headerlink" title="4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端"></a>4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端</h2><p>编辑检查zabbix-agent进程脚本<br>cat /home/centos/check-zabbix-port.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">netstat -tunlp |grep 10050</span><br></pre></td></tr></table></figure></p><p>编辑批量上传脚本<br>cat /etc/ansible/scopy-test-check-zabbixport.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix-check-port to all hosts</span><br><span class="line">    copy: src=&quot;/home/centos/check-zabbix-port.sh&quot; dest=&quot;/home/centos/check-zabbix-port.sh&quot;</span><br></pre></td></tr></table></figure></p><p>执行批量上传脚本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-test-check-zabbixport.sh</span><br></pre></td></tr></table></figure></p><p>在ansible-server服务端执行检查脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/check-zabbix-port.sh&apos;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix-server安装配置</title>
      <link href="/2018/08/27/zabbix-server%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/08/27/zabbix-server%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h4 id="0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包："><a href="#0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包：" class="headerlink" title="0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包："></a>0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall &quot;Development tools&quot;  </span><br><span class="line">yum -y install gcc gcc-c++ cmake autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers pcre-devel libaio  openssl openssl-devel</span><br></pre></td></tr></table></figure><h4 id="1、上传nginx软件包到服务器，如果没有可点击此处下载"><a href="#1、上传nginx软件包到服务器，如果没有可点击此处下载" class="headerlink" title="1、上传nginx软件包到服务器，如果没有可点击此处下载"></a>1、上传nginx软件包到服务器，如果没有可点击此处<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">下载</a></h4><p>创建nginx用户，创建nginx安装目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd nginx -s /sbin/nologin -M   </span><br><span class="line">mkdir /data/soft</span><br></pre></td></tr></table></figure></p><p>解压安装包、编译安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.9.15.tar.gz</span><br><span class="line">cd nginx-1.9.15</span><br><span class="line">./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_stub_status_module --with-http_ssl_module  </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>检查语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure></p><p>启动nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure></p><p>查看进程是否正常启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp|grep nginx</span><br></pre></td></tr></table></figure></p><p>关闭nginx服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br></pre></td></tr></table></figure></p><h4 id="2、Mysql数据库安装"><a href="#2、Mysql数据库安装" class="headerlink" title="2、Mysql数据库安装"></a>2、Mysql数据库安装</h4><p>下载mysql数据库(可自行下载自己喜欢的版本）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p><p>添加用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd mysql -s /sbin/nologin -M</span><br></pre></td></tr></table></figure></p><p>解压、重命名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz </span><br><span class="line">mv mysql-5.7.18-linux-glibc2.5-x86_64 /application/mysql</span><br></pre></td></tr></table></figure></p><p>改变权限权限、初始化,初始化过程中会默认生成随机密码，记录以便后面更改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql /data/mysql/ </span><br><span class="line">/data/mysql/bin/mysqld --initialize --user=mysql --basedir=/data/mysql/ --datadir=/data/mysql/data/</span><br><span class="line">/data/mysql/bin/mysql_ssl_rsa_setup --datadir=/data/mysql/data/</span><br></pre></td></tr></table></figure></p><p>修改配置文件<br>cat /data/mysql/support-files/my_default.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line">server_id = 1</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">basedir =/data/mysql/</span><br><span class="line">datadir =/data/mysql/data/</span><br><span class="line">character-set-server=utf8</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br></pre></td></tr></table></figure></p><p>配合mysql启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp my_default.cnf /etc/my.cnf</span><br><span class="line">cp mysql.server /etc/init.d/mysqld</span><br><span class="line">chmod 755 /etc/init.d/mysqld</span><br></pre></td></tr></table></figure></p><p>修改/etc/init.d/mysqld，文件数据和安装路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">basedir=/data/mysql/</span><br><span class="line">datadir=/dadta/mysql/data/</span><br></pre></td></tr></table></figure></p><p>启动mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p><p>修改mysql密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u  root -p</span><br><span class="line">set password=password(&apos;root&apos;);</span><br><span class="line">grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;root&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p><h4 id="3、安装php服务"><a href="#3、安装php服务" class="headerlink" title="3、安装php服务"></a>3、安装php服务</h4><p>安装依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zlib libxml2 libjpeg freetype libpng gd curl libiconv  zlib-devel libxml2-devel libjpeg-devel freetype-devel libpng-devel gd-devel curl-devel openssl-devel libxslt-devel libxslt*</span><br></pre></td></tr></table></figure></p><p>安装libiconv,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libiconv-1.14.tar.gz </span><br><span class="line">cd libiconv-1.14</span><br><span class="line">./configure --prefix=/usr/local/libiconv   </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>报错：<br>./stdio.h:1010:1: error: ‘gets’ undeclared here (not in a function)<br>_GL_WARN_ON_USE (gets, “gets is a security hole - use fgets instead”);</p><p>vi srclib/stdio.in.h文件，接着搜索到在698行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_GL_WARN_ON_USE (gets, “gets is a security hole - use fgets instead”);</span><br></pre></td></tr></table></figure></p><p>这一行，然后把这个替换成下面三行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if defined(__GLIBC__) &amp;&amp; !defined(__UCLIBC__) &amp;&amp; !__GLIBC_PREREQ(2, 16)</span><br><span class="line">_GL_WARN_ON_USE (gets, &quot;gets is a security hole - use fgets instead&quot;);</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></p><p>安装Libmcrypt,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libmcrypt-2.5.8.tar.gz </span><br><span class="line">cd libmcrypt-2.5.8</span><br><span class="line">./configure   </span><br><span class="line">make &amp;&amp; make install   </span><br><span class="line"></span><br><span class="line">/sbin/ldconfig   </span><br><span class="line">cd libltdl/   </span><br><span class="line">./configure --enable-ltdl-install   </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ../../</span><br></pre></td></tr></table></figure></p><p>安装mhash,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mhash-0.9.9.9.tar.gz </span><br><span class="line">cd mhash-0.9.9.9</span><br><span class="line">./configure   </span><br><span class="line">make &amp;&amp; make install </span><br><span class="line">cd ../   </span><br><span class="line">rm -f /usr/lib64/libmcrypt.*   </span><br><span class="line">rm -f /usr/lib64/libmhash*   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.la /usr/lib64/libmcrypt.la   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.so /usr/lib64/libmcrypt.so   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.so.4 /usr/lib64/libmcrypt.so.4   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.so.4.4.8 /usr/lib64/libmcrypt.so.4.4.8   </span><br><span class="line">ln -s /usr/local/lib/libmhash.a /usr/lib64/libmhash.a   </span><br><span class="line">ln -s /usr/local/lib/libmhash.la /usr/lib64/libmhash.la   </span><br><span class="line">ln -s /usr/local/lib/libmhash.so /usr/lib64/libmhash.so   </span><br><span class="line">ln -s /usr/local/lib/libmhash.so.2 /usr/lib64/libmhash.so.2   </span><br><span class="line">ln -s /usr/local/lib/libmhash.so.2.0.1 /usr/lib64/libmhash.so.2.0.1   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt-config /usr/lib/libmcrypt-config</span><br></pre></td></tr></table></figure></p><p>安装mcrypt,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -xf mcrypt-2.6.8.tar.gz   </span><br><span class="line">cd mcrypt-2.6.8/</span><br><span class="line">/sbin/ldconfig   </span><br><span class="line">./configure LD_LIBRARY=/usr/local/lib &amp;&amp; make &amp;&amp;make install   </span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure></p><p>安装php,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf php-5.6.11.tar.gz </span><br><span class="line">cd php-5.6.11</span><br><span class="line"></span><br><span class="line">修改mysql路径对应为自己的mysql安装路径</span><br><span class="line">./configure --prefix=/usr/local/php --with-mysql=/data/mysql --with-iconv-dir=/usr/local/libiconv --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl  --enable-mbregex --enable-fpm --enable-mbstring --with-mcrypt --with-gd --enable-gd-native-ttf --with-openssl --with-mhash --enable-pcntl --enable-sockets --with-xmlrpc --enable-zip --enable-soap --enable-short-tags --enable-static --with-xsl --with-fpm-user=nginx --with-fpm-group=nginx --enable-ftp --enable-pdo --with-pdo-mysql  --enable-opcache=no</span><br><span class="line">make &amp;&amp; make install </span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure></p><p>安装过程提示缺少mysqlclient包的问题，根据版本差异执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /data/mysql/lib/libmysqlclient.so.18 /usr/lib64/</span><br><span class="line">或者</span><br><span class="line">ln -s /data/mysql/lib/libmysqlclient.so.20 /usr/lib64/</span><br></pre></td></tr></table></figure></p><p>缺少phar.phar文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chmod: cannot access `ext/phar/phar.phar&apos;: No such file or directory</span><br><span class="line">make: [ext/phar/phar.phar] Error 1 (ignored)</span><br><span class="line"></span><br><span class="line">Build complete.</span><br><span class="line">Don&apos;t forget to run &apos;make test&apos;.</span><br><span class="line"></span><br><span class="line">解决方法</span><br><span class="line">#cd  ext/phar/</span><br><span class="line">#cp ./phar.php  ./phar.phar</span><br></pre></td></tr></table></figure></p><p>配置文件（php.ini和php-fpm）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">需要把php.ini文件放到lib下面，放到etc下面不生效：</span><br><span class="line">cp /data/soft/php-5.6.11/php.ini-production /usr/local/php/lib/php.ini</span><br><span class="line">cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf</span><br></pre></td></tr></table></figure></p><p>检查语法、启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/php/sbin/php-fpm -t </span><br><span class="line">/usr/local/php/sbin/php-fpm</span><br><span class="line">cp  /data/soft/php-5.6.11/sapi/fpm/init.d.php-fpm  /etc/init.d/php-fpm</span><br><span class="line">chmod a+x /etc/init.d/php-fpm</span><br><span class="line">加入开机启动</span><br><span class="line">chkconfig --add php-fpm</span><br><span class="line">chkconfig --level 35 php-fpm on</span><br><span class="line">启动 php-fpm</span><br><span class="line">service php-fpm start</span><br><span class="line">netstat -anpt | grep php-fpm</span><br><span class="line">停止 php-fpm</span><br><span class="line">service php-fpm stop</span><br></pre></td></tr></table></figure></p><h4 id="4、配置nginx使其支持php"><a href="#4、配置nginx使其支持php" class="headerlink" title="4、配置nginx使其支持php"></a>4、配置nginx使其支持php</h4><p>cat /usr/local/nginx/conf/nginx.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name localhost;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">root html;</span><br><span class="line">index index.php index.html index.htm;                               # 加入 index.php</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ \.php$ &#123; # 整段注释去掉</span><br><span class="line">root html;</span><br><span class="line">fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME /usr/local/nginx/html$fastcgi_script_name;                          # 修改为自己的根目录</span><br><span class="line">include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>创建测试页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;?php phpinfo(); ?&gt;"</span> &gt; /usr/<span class="built_in">local</span>/nginx/html/info.php</span><br></pre></td></tr></table></figure></p><p>重启 Nginx 、php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service php-fpm stop</span><br><span class="line">service php-fpm start</span><br><span class="line">nginx -s stop</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure></p><p>浏览器访问测试页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost/info.php</span><br></pre></td></tr></table></figure></p><h4 id="5、安装zabbix-server"><a href="#5、安装zabbix-server" class="headerlink" title="5、安装zabbix-server"></a>5、安装zabbix-server</h4><p>下载安装包<br>wget <a href="https://jaist.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.0.3/zabbix-4.0.3.tar.gz" target="_blank" rel="noopener">https://jaist.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.0.3/zabbix-4.0.3.tar.gz</a><br>安装依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntpdate net-snmp net-snmp-devel libcurl-devel libevent-devel</span><br></pre></td></tr></table></figure></p><p>设置zabbix用户，编译安装zabbix<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">tar -zxvf zabbix-4.0.3.tar.gz</span><br><span class="line">cd zabbix-4.0.3</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2 --with-openssl</span><br><span class="line"></span><br><span class="line"># --prefix  指定安装路径</span><br><span class="line"># --enable-server  安装 Server 端</span><br><span class="line"># --enable-agent  安装 Agent 端</span><br><span class="line"># --with-mysql  使用 Mysql 数据库</span><br><span class="line"># --with-net-snmp  支持 SNMP 协议</span><br><span class="line"># --with-libcurl  支持 libcurl URL 监控</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>mysql数据库添加zabbix初始化数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database zabbixDB character set utf8;                                    # 创建 zabbixDB 并设置编码为 utf8</span><br><span class="line">mysql&gt; grant all on zabbixDB.* to &apos;zabbix&apos;@&apos;%&apos; identified by &apos;zabbix&apos;;                 # 建立授权用户</span><br><span class="line">mysql&gt; flush privileges;                                                               # 刷新授权表 ( 虽然 grant 操作是不需要刷新授权表的，但那又如何 ? )</span><br><span class="line">mysql&gt; use zabbixDB;</span><br><span class="line">mysql&gt; source /data/soft/zabbix-4.0.3/database/mysql/schema.sql                             # 导入数据</span><br><span class="line">mysql&gt; source /data/soft/zabbix-4.0.3/database/mysql/images.sql</span><br><span class="line">mysql&gt; source /data/soft/zabbix-4.0.3/database/mysql/data.sql</span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure></p><p>配置 Zabbix 服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 服务端启动脚本</span><br><span class="line">shell &gt; cp /data/soft/zabbix-4.0.3/misc/init.d/fedora/core/zabbix_server /etc/init.d/</span><br><span class="line"># 客户端启动脚本</span><br><span class="line">shell &gt; cp /data/soft/zabbix-4.0.3/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/</span><br><span class="line"># 网页文件</span><br><span class="line">shell &gt; cp -R /data/soft/zabbix-4.0.3/frontends/php/ /usr/local/nginx/html/zabbix</span><br></pre></td></tr></table></figure></p><p>服务端配置文件<br>vim /usr/local/zabbix/etc/zabbix_server.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LogFile=/tmp/zabbix_server.log  # 日志文件存放位置</span><br><span class="line">DBName=zabbixDB                  # 数据库名</span><br><span class="line">DBUser=zabbix                    # 连接用户</span><br><span class="line">DBPassword=zabbix               # 连接密码</span><br></pre></td></tr></table></figure></p><p>服务端启动脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; vim /etc/init.d/zabbix_server </span><br><span class="line">BASEDIR=/usr/local/zabbix # 修改后的位置 ( 原：/usr/local )</span><br></pre></td></tr></table></figure></p><p>客户端启动脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt;vim /etc/init.d/zabbix_agentd</span><br><span class="line">BASEDIR=/usr/local/zabbix # 修改后的位置 ( 原：/usr/local )</span><br></pre></td></tr></table></figure></p><p>配置zabbix开机启动，并启动Zabbix服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; chkconfig --add zabbix_server</span><br><span class="line">shell &gt; chkconfig --add zabbix_agentd</span><br><span class="line">shell &gt; chkconfig --level 35 zabbix_server on</span><br><span class="line">shell &gt; chkconfig --level 35 zabbix_agentd on</span><br><span class="line">shell &gt; service zabbix_server start</span><br><span class="line">Starting zabbix_server: [确定]</span><br><span class="line">shell &gt; service zabbix_agentd start</span><br><span class="line">Starting zabbix_agentd: [确定]</span><br></pre></td></tr></table></figure></p><p>查看进程启动是否正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; netstat -anpt | grep zabbix ( 注意：要来确认一下到底有没有启动成功，因为当授权用户无法连接数据库时，zabbix_server 是无法启动的，但是启动过程显示成功 )</span><br><span class="line">tcp        0      0 0.0.0.0:10050               0.0.0.0:*                   LISTEN      75399/zabbix_agentd </span><br><span class="line">tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      75321/zabbix_server</span><br></pre></td></tr></table></figure></p><h4 id="6、登陆网页进行配置-Zabbix-http-your-domain-zabbix-（初始用户名密码为admin-zabbix）"><a href="#6、登陆网页进行配置-Zabbix-http-your-domain-zabbix-（初始用户名密码为admin-zabbix）" class="headerlink" title="6、登陆网页进行配置 Zabbix ( http://your-domain/zabbix )（初始用户名密码为admin/zabbix）"></a>6、登陆网页进行配置 Zabbix ( <a href="http://your-domain/zabbix" target="_blank" rel="noopener">http://your-domain/zabbix</a> )（初始用户名密码为admin/zabbix）</h4><blockquote><p>第一个页面是欢迎页面，直接 Next<br><img src="https://i.imgur.com/t8fwVzF.png" alt=""><br><img src="https://i.imgur.com/5cjC7SU.png" alt=""><br>第二个页面大多会有多处检测失败，也是出问题最多的位置,修改php文件一下参数：<br>vim /usr/local/php/etc/php.ini<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">post_max_size = 16M</span><br><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">去掉date前面的分号，并添加时区</span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line">去掉always前面的分号</span><br><span class="line">always_populate_raw_post_data = -1</span><br></pre></td></tr></table></figure></p></blockquote><p>根据页面提示报错还需要修改以下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /root/php-5.6.11/ext/openssl/</span><br><span class="line">cp  ./config0.m4 ./config.m4</span><br><span class="line">#重新编译php，添加mysqli模块</span><br><span class="line">cd /data/soft/php-5.6.11/ext/mysqli</span><br><span class="line">/usr/local/php/bin/phpize </span><br><span class="line">./configure --prefix=/data/soft/mysqli --with-php-config=/usr/local/php/bin/php-config --with-mysqli=/data/mysql/bin/mysql_config</span><br><span class="line">make </span><br><span class="line">make test</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p><p>配置完成后在php.ini下加入下来一行<br>vim /usr/local/php/etc/php.ini<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=mysqli.so</span><br></pre></td></tr></table></figure></p><p>安装过程中的其他报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: ext/mysqlnd/mysql_float_to_double.h: No such file or directory</span><br></pre></td></tr></table></figure></p><p>vim /data/soft/php-5.6.11/ext/mysqli/mysqli_api.c<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">把第36行的</span><br><span class="line">#include &quot;ext/mysqlnd/mysql_float_to_double.h&quot;</span><br><span class="line">修改为</span><br><span class="line">#include &quot;/data/soft/php-5.6.11/ext/mysqlnd/mysql_float_to_double.h&quot;</span><br></pre></td></tr></table></figure></p><p>点击下一步，配置数据库信息，根据自己配置的db信息填写<br><img src="https://i.imgur.com/0jqoRJU.png" alt=""><br>点击下一步，设置zabbix-server信息<br><img src="https://i.imgur.com/RbsR5W3.png" alt=""><br>点击下一步，预览设置的db和server的信息<br><img src="https://i.imgur.com/cdT09RC.png" alt=""><br>点击下一步，按提示要求，将下载下来的文件放到相应的目录<br><img src="https://i.imgur.com/1PNShFe.png" alt=""><br>zabbix-server安装完成</p><h4 id="7、zabbix-proxy代理端安装"><a href="#7、zabbix-proxy代理端安装" class="headerlink" title="7、zabbix-proxy代理端安装"></a>7、zabbix-proxy代理端安装</h4><p>依赖包安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y groupinstall &quot;Development tools&quot; </span><br><span class="line">yum -y install gcc gcc-c++ cmake autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers pcre-devel libaio ntpdate net-snmp net-snmp-devel libcurl-devel libevent-devel  vim telnet pcre-devel</span><br></pre></td></tr></table></figure></p><p>添加zabbix用户，并编译安装zabbix-proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-agent --enable-proxy --with-mysql --with-net-snmp --with-libcurl --with-libxml2 --with-openssl</span><br><span class="line"># --enable-agent 不是必须的 ( 如果不想监控 Proxy 的话 )</span><br><span class="line">mysql路径如果安装路径不是默认，需要单独指定</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-agent --enable-proxy --with-mysql=/data/mysql/bin/mysql_config --with-net-snmp --with-libcurl --with-libxml2 --with-openssl  </span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>将proxy代理所需要的初始化数据导入到mysql数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">mysql&gt; create database proxydb character set utf8;                                            # 创建数据库</span><br><span class="line">mysql&gt; grant all on proxydb.* to &apos;proxy&apos;@&apos;%&apos; identified by &apos;proxydb&apos;;                         # 创建授权用户</span><br><span class="line">mysql&gt; flush privileges;                                                                      # 刷新授权表，虽然不需要~</span><br><span class="line">mysql&gt; use proxydb;</span><br><span class="line">mysql&gt; source /root/zabbix-3.4.2/database/mysql/schema.sql                                    # 导入数据，只导入这一个就可以了</span><br></pre></td></tr></table></figure></p><p>修改zabbix_proxy.conf配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# grep -vP &apos;^$|#&apos; /usr/local/zabbix/etc/zabbix_proxy.conf</span><br><span class="line">ProxyMode=0</span><br><span class="line">Server=192.168.197.135</span><br><span class="line">ServerPort=10051</span><br><span class="line">Hostname=node1</span><br><span class="line">LogFile=/tmp/zabbix_proxy.log</span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=proxydb</span><br><span class="line">DBUser=proxy</span><br><span class="line">DBPassword=proxydb</span><br><span class="line">ConfigFrequency=60</span><br><span class="line">DataSenderFrequency=60</span><br><span class="line">Timeout=4</span><br><span class="line">LogSlowQueries=3000</span><br></pre></td></tr></table></figure></p><p>参数详解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ProxyMode=0                    # 0 代表 Proxy 处于主动模式，即：Proxy 主动去请求 Zabbix Server 获取监控项；1 代表被动模式</span><br><span class="line">Server=192.168.188.30                     #填写Server的IP，Proxy会将收集到的数据发往这个IP。</span><br><span class="line">ServerPort=10051              # Zabbix Server 监听端口，同上只在 Proxy 为主动模式时生效</span><br><span class="line">Hostname=node1              # 这个很重要啦，跟 Agent 的 Hostname 一样重要，注意修改Hostname与web界面的需要添加的主机名称一致</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_proxy.log   # Proxy 日志文件位置</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_proxy.pid</span><br><span class="line">DBHost=localhost              # 连接哪里的数据库</span><br><span class="line">DBName=proxydb                       #Proxy连接的数据库</span><br><span class="line">DBUser=proxy                             #连接数据库的用户名</span><br><span class="line">DBPassword=proxypass                         #连接数据库的秘密</span><br><span class="line">DBSocket=/var/lib/mysql/mysql.sock</span><br><span class="line">ProxyLocalBuffer=0                        #当数据发送到Server，还要在本地保留多少小时.不保留</span><br><span class="line">ProxyOfflineBuffer=3                      #当数据没有发送到Server，在本地保留多少小时，3小时。</span><br><span class="line">HeartbeatFrequency=60                     #心跳检测代理在Server的可用性</span><br><span class="line">ConfigFrequency=60                        # Proxy 向 Zabbix Server 请求监控项间隔，单位为 秒，默认3600秒.</span><br><span class="line">DataSenderFrequency=3                     #代理收集到数据后，多久向Server发送一次,单位为 秒</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">TLSConnect=psk                            #加密传输</span><br><span class="line">TLSPSKFile=/usr/local/zabbix/etc/zabbix_proxy.psk #加密传输文件</span><br><span class="line">TLSPSKIdentity=PSK 002 #加密传输标识，与web控制台一致</span><br><span class="line">#DebugLevel=5</span><br></pre></td></tr></table></figure></p><p>如果要加密传输生成秘钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 32</span><br></pre></td></tr></table></figure></p><p>将秘钥存入/usr/local/zabbix/etc/zabbix_proxy.psk文件<br>然后再zabbix-server，web控制台添加zabbix-proxy信息</p><p><img src="https://i.imgur.com/Gn9MMx2.png" alt=""></p><p><img src="https://i.imgur.com/87a6P6J.png" alt=""><br>启动 zabbix_proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zabbix/sbin/zabbix_proxy</span><br></pre></td></tr></table></figure></p><p>启动报错如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zabbix/sbin/zabbix_proxy: error while loading shared libraries: libmysqlclient.so.20: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p><p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /application/mysql/lib/libmysqlclient.so.20 /usr/lib64/</span><br></pre></td></tr></table></figure></p><p>查看是否启动成功：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnpt | grep zabbix_proxy</span><br><span class="line">tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      80154/zabbix_proxy</span><br></pre></td></tr></table></figure></p><p>加入开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;/usr/local/zabbix/sbin/zabbix_proxy&quot; &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控cassandra数据库</title>
      <link href="/2018/08/27/zabbix%E7%9B%91%E6%8E%A7cassandra%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
      <url>/2018/08/27/zabbix%E7%9B%91%E6%8E%A7cassandra%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
      <content type="html"><![CDATA[<h2 id="1、安装java-gate-way-如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server-将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）："><a href="#1、安装java-gate-way-如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server-将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）：" class="headerlink" title="1、安装java_gate_way,如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server,将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）："></a>1、安装java_gate_way,如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server,将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">创建zabbix用户，安装依赖包：</span><br><span class="line">sudo bash</span><br><span class="line">mkdir /home/zabbix</span><br><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">yum -y install gcc gcc-c++ pcre-devel openssl-devel</span><br><span class="line">yum -y install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br><span class="line"></span><br><span class="line">上传zabbix安装包，并安装java-gate-way：</span><br><span class="line"> mv /data/download/zabbix-3.4.2.tar.gz /home/zabbix/</span><br><span class="line"> cd /home/zabbix/</span><br><span class="line">tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line">./configure --prefix=/data/zabbix --enable-java</span><br><span class="line">(如果zabbix-porxy或zabbix-server已安装，可指定一个新路径，gate-way与proxy、server并没有直接关系，可不必一起安装；如果都没有安装，为了管理方便，亦可放到同一目录）</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>安装完成之后，会在指定目录下存在以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ll /data/zabbix/sbin/zabbix_java/</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x. 2 root root   65 Aug 23 02:41 bin</span><br><span class="line">drwxr-xr-x. 2 root root  177 Aug 23 02:36 lib</span><br><span class="line">-rw-r--r--. 1 root root  791 Aug 23 02:36 settings.sh</span><br><span class="line">-rwxr-xr-x. 1 root root  545 Aug 23 02:36 shutdown.sh</span><br><span class="line">-rwxr-xr-x. 1 root root 2025 Aug 23 02:36 startup.sh</span><br></pre></td></tr></table></figure></p><p>包括启动脚本，关闭脚本，配置文件，依赖库，运行命令等文件。<br>启动java_gate_way：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./startup.sh</span><br></pre></td></tr></table></figure></p><h2 id="2、安装完成之后，修改zabbix-proxy-conf配置文件，添加以下参数："><a href="#2、安装完成之后，修改zabbix-proxy-conf配置文件，添加以下参数：" class="headerlink" title="2、安装完成之后，修改zabbix_proxy.conf配置文件，添加以下参数："></a>2、安装完成之后，修改zabbix_proxy.conf配置文件，添加以下参数：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaGateway=127.0.0.1</span><br><span class="line">JavaGatewayPort=10052</span><br><span class="line">StartJavaPollers=5</span><br></pre></td></tr></table></figure><p>默认端口为10052，因为zabbix-proxy与gate-way在同一台服务器上，因此使用127.0.0.1即可。必须指定java轮询器的预分叉实例数，默认情况下启动不会启动与jmx监控相关的进程。<br>修改完成之后重新启动zabbix-proxy服务，是修改参数生效。</p><h2 id="3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问"><a href="#3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问" class="headerlink" title="3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问"></a>3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问</h2><p>cat /etc/cassandra/conf/cassandra-env.sh |grep -v ‘^#’ |grep -v ‘^$’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">calculate_heap_sizes()</span><br><span class="line">&#123;</span><br><span class="line">    case &quot;`uname`&quot; in</span><br><span class="line">        Linux)</span><br><span class="line">            system_memory_in_mb=`free -m | awk &apos;/:/ &#123;print $2;exit&#125;&apos;`</span><br><span class="line">            system_cpu_cores=`egrep -c &apos;processor([[:space:]]+):.*&apos; /proc/cpuinfo`</span><br><span class="line">        ;;</span><br><span class="line">        FreeBSD)</span><br><span class="line">            system_memory_in_bytes=`sysctl hw.physmem | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            system_memory_in_mb=`expr $system_memory_in_bytes / 1024 / 1024`</span><br><span class="line">            system_cpu_cores=`sysctl hw.ncpu | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">        SunOS)</span><br><span class="line">            system_memory_in_mb=`prtconf | awk &apos;/Memory size:/ &#123;print $3&#125;&apos;`</span><br><span class="line">            system_cpu_cores=`psrinfo | wc -l`</span><br><span class="line">        ;;</span><br><span class="line">        Darwin)</span><br><span class="line">            system_memory_in_bytes=`sysctl hw.memsize | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            system_memory_in_mb=`expr $system_memory_in_bytes / 1024 / 1024`</span><br><span class="line">            system_cpu_cores=`sysctl hw.ncpu | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">        *)</span><br><span class="line">            # assume reasonable defaults for e.g. a modern desktop or</span><br><span class="line">            # cheap server</span><br><span class="line">            system_memory_in_mb=&quot;2048&quot;</span><br><span class="line">            system_cpu_cores=&quot;2&quot;</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">    # some systems like the raspberry pi don&apos;t report cores, use at least 1</span><br><span class="line">    if [ &quot;$system_cpu_cores&quot; -lt &quot;1&quot; ]</span><br><span class="line">    then</span><br><span class="line">        system_cpu_cores=&quot;1&quot;</span><br><span class="line">    fi</span><br><span class="line">    # set max heap size based on the following</span><br><span class="line">    # max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB))</span><br><span class="line">    # calculate 1/2 ram and cap to 1024MB</span><br><span class="line">    # calculate 1/4 ram and cap to 8192MB</span><br><span class="line">    # pick the max</span><br><span class="line">    half_system_memory_in_mb=`expr $system_memory_in_mb / 2`</span><br><span class="line">    quarter_system_memory_in_mb=`expr $half_system_memory_in_mb / 2`</span><br><span class="line">    if [ &quot;$half_system_memory_in_mb&quot; -gt &quot;1024&quot; ]</span><br><span class="line">    then</span><br><span class="line">        half_system_memory_in_mb=&quot;1024&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$quarter_system_memory_in_mb&quot; -gt &quot;8192&quot; ]</span><br><span class="line">    then</span><br><span class="line">        quarter_system_memory_in_mb=&quot;8192&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$half_system_memory_in_mb&quot; -gt &quot;$quarter_system_memory_in_mb&quot; ]</span><br><span class="line">    then</span><br><span class="line">        max_heap_size_in_mb=&quot;$half_system_memory_in_mb&quot;</span><br><span class="line">    else</span><br><span class="line">        max_heap_size_in_mb=&quot;$quarter_system_memory_in_mb&quot;</span><br><span class="line">    fi</span><br><span class="line">    MAX_HEAP_SIZE=&quot;$&#123;max_heap_size_in_mb&#125;M&quot;</span><br><span class="line">    # Young gen: min(max_sensible_per_modern_cpu_core * num_cores, 1/4 * heap size)</span><br><span class="line">    max_sensible_yg_per_core_in_mb=&quot;100&quot;</span><br><span class="line">    max_sensible_yg_in_mb=`expr $max_sensible_yg_per_core_in_mb &quot;*&quot; $system_cpu_cores`</span><br><span class="line">    desired_yg_in_mb=`expr $max_heap_size_in_mb / 4`</span><br><span class="line">    if [ &quot;$desired_yg_in_mb&quot; -gt &quot;$max_sensible_yg_in_mb&quot; ]</span><br><span class="line">    then</span><br><span class="line">        HEAP_NEWSIZE=&quot;$&#123;max_sensible_yg_in_mb&#125;M&quot;</span><br><span class="line">    else</span><br><span class="line">        HEAP_NEWSIZE=&quot;$&#123;desired_yg_in_mb&#125;M&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">java_ver_output=`&quot;$&#123;JAVA:-java&#125;&quot; -version 2&gt;&amp;1`</span><br><span class="line">jvmver=`echo &quot;$java_ver_output&quot; | grep &apos;[openjdk|java] version&apos; | awk -F&apos;&quot;&apos; &apos;NR==1 &#123;print $2&#125;&apos; | cut -d\- -f1`</span><br><span class="line">JVM_VERSION=$&#123;jvmver%_*&#125;</span><br><span class="line">JVM_PATCH_VERSION=$&#123;jvmver#*_&#125;</span><br><span class="line">if [ &quot;$JVM_VERSION&quot; \&lt; &quot;1.8&quot; ] ; then</span><br><span class="line">    echo &quot;Cassandra 3.0 and later require Java 8u40 or later.&quot;</span><br><span class="line">    exit 1;</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$JVM_VERSION&quot; \&lt; &quot;1.8&quot; ] &amp;&amp; [ &quot;$JVM_PATCH_VERSION&quot; -lt 40 ] ; then</span><br><span class="line">    echo &quot;Cassandra 3.0 and later require Java 8u40 or later.&quot;</span><br><span class="line">    exit 1;</span><br><span class="line">fi</span><br><span class="line">jvm=`echo &quot;$java_ver_output&quot; | grep -A 1 &apos;java version&apos; | awk &apos;NR==2 &#123;print $1&#125;&apos;`</span><br><span class="line">case &quot;$jvm&quot; in</span><br><span class="line">    OpenJDK)</span><br><span class="line">        JVM_VENDOR=OpenJDK</span><br><span class="line">        # this will be &quot;64-Bit&quot; or &quot;32-Bit&quot;</span><br><span class="line">        JVM_ARCH=`echo &quot;$java_ver_output&quot; | awk &apos;NR==3 &#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">    &quot;Java(TM)&quot;)</span><br><span class="line">        JVM_VENDOR=Oracle</span><br><span class="line">        # this will be &quot;64-Bit&quot; or &quot;32-Bit&quot;</span><br><span class="line">        JVM_ARCH=`echo &quot;$java_ver_output&quot; | awk &apos;NR==3 &#123;print $3&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        # Help fill in other JVM values</span><br><span class="line">        JVM_VENDOR=other</span><br><span class="line">        JVM_ARCH=unknown</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Xloggc:/var/log/cassandra/gc.log&quot;</span><br><span class="line">JVM_OPTS_FILE=$CASSANDRA_CONF/jvm.options</span><br><span class="line">for opt in `grep &quot;^-&quot; $JVM_OPTS_FILE`</span><br><span class="line">do</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS $opt&quot;</span><br><span class="line">done</span><br><span class="line">echo $JVM_OPTS | grep -q Xmn</span><br><span class="line">DEFINED_XMN=$?</span><br><span class="line">echo $JVM_OPTS | grep -q Xmx</span><br><span class="line">DEFINED_XMX=$?</span><br><span class="line">echo $JVM_OPTS | grep -q Xms</span><br><span class="line">DEFINED_XMS=$?</span><br><span class="line">echo $JVM_OPTS | grep -q UseConcMarkSweepGC</span><br><span class="line">USING_CMS=$?</span><br><span class="line">echo $JVM_OPTS | grep -q UseG1GC</span><br><span class="line">USING_G1=$?</span><br><span class="line">if [ &quot;x$MAX_HEAP_SIZE&quot; = &quot;x&quot; ] &amp;&amp; [ &quot;x$HEAP_NEWSIZE&quot; = &quot;x&quot; -o $USING_G1 -eq 0 ]; then</span><br><span class="line">    calculate_heap_sizes</span><br><span class="line">elif [ &quot;x$MAX_HEAP_SIZE&quot; = &quot;x&quot; ] ||  [ &quot;x$HEAP_NEWSIZE&quot; = &quot;x&quot; -a $USING_G1 -ne 0 ]; then</span><br><span class="line">    echo &quot;please set or unset MAX_HEAP_SIZE and HEAP_NEWSIZE in pairs when using CMS GC (see cassandra-env.sh)&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">if [ &quot;x$MALLOC_ARENA_MAX&quot; = &quot;x&quot; ] ; then</span><br><span class="line">    export MALLOC_ARENA_MAX=4</span><br><span class="line">fi</span><br><span class="line">if [ $DEFINED_XMX -ne 0 ] &amp;&amp; [ $DEFINED_XMS -ne 0 ]; then</span><br><span class="line">     JVM_OPTS=&quot;$JVM_OPTS -Xms$&#123;MAX_HEAP_SIZE&#125;&quot;</span><br><span class="line">     JVM_OPTS=&quot;$JVM_OPTS -Xmx$&#123;MAX_HEAP_SIZE&#125;&quot;</span><br><span class="line">elif [ $DEFINED_XMX -ne 0 ] || [ $DEFINED_XMS -ne 0 ]; then</span><br><span class="line">     echo &quot;Please set or unset -Xmx and -Xms flags in pairs on jvm.options file.&quot;</span><br><span class="line">     exit 1</span><br><span class="line">fi</span><br><span class="line">if [ $DEFINED_XMN -eq 0 ] &amp;&amp; [ $DEFINED_XMX -ne 0 ]; then</span><br><span class="line">    echo &quot;Please set or unset -Xmx and -Xmn flags in pairs on jvm.options file.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">elif [ $DEFINED_XMN -ne 0 ] &amp;&amp; [ $USING_CMS -eq 0 ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -Xmn$&#123;HEAP_NEWSIZE&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$JVM_ARCH&quot; = &quot;64-Bit&quot; ] &amp;&amp; [ $USING_CMS -eq 0 ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -XX:+UseCondCardMark&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -XX:CompileCommandFile=$CASSANDRA_CONF/hotspot_compiler&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -javaagent:$CASSANDRA_HOME/lib/jamm-0.3.0.jar&quot;</span><br><span class="line">if [ &quot;x$CASSANDRA_HEAPDUMP_DIR&quot; != &quot;x&quot; ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -XX:HeapDumpPath=$CASSANDRA_HEAPDUMP_DIR/cassandra-`date +%s`-pid$$.hprof&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_ON_OUT_OF_MEMORY_ERROR_OPT=&quot;-XX:OnOutOfMemoryError=kill -9 %p&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Djava.rmi.server.hostname=10.0.7.50&quot;</span><br><span class="line">if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span><br><span class="line">    LOCAL_JMX=no</span><br><span class="line">fi</span><br><span class="line">JMX_PORT=&quot;7199&quot;</span><br><span class="line">if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT&quot;</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">else</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.remote.port=$JMX_PORT&quot;</span><br><span class="line">  # if ssl is enabled the same port cannot be used for both jmx and rmi so either</span><br><span class="line">  # pick another value for this property or comment out to use a random port (though see CASSANDRA-7087 for origins)</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;</span><br><span class="line">  # turn on JMX authentication. See below for further options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">  # jmx ssl options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl=false&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.need.client.auth=true&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.enabled.protocols=&lt;enabled-protocols&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.enabled.cipher.suites=&lt;enabled-cipher-suites&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.keyStore=/path/to/keystore&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.keyStorePassword=&lt;keystore-password&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.trustStore=/path/to/truststore&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.trustStorePassword=&lt;truststore-password&gt;&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Djava.library.path=$CASSANDRA_HOME/lib/sigar-bin&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $MX4J_ADDRESS&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $MX4J_PORT&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $JVM_EXTRA_OPTS&quot;</span><br></pre></td></tr></table></figure></p><p>主要修改一下内容，默认LOCAL_JMX=yes<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span><br><span class="line">    LOCAL_JMX=no</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p><p>将true改为false,修改远程访问认证无需密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT&quot;</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">else</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.remote.port=$JMX_PORT&quot;</span><br><span class="line">  # if ssl is enabled the same port cannot be used for both jmx and rmi so either</span><br><span class="line">  # pick another value for this property or comment out to use a random port (though see CASSANDRA-7087 for origins)</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;</span><br><span class="line">  # turn on JMX authentication. See below for further options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br></pre></td></tr></table></figure></p><h2 id="4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下："><a href="#4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下：" class="headerlink" title="4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下："></a>4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下：</h2><p>cat /data/zabbix/sbin/zabbix_java/bin/zabbix_get_jmx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">if [ $# != 5 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;Usage: $0 &lt;JAVA_GATEWAY_HOST&gt; &lt;JAVA_GATEWAY_PORT&gt; &lt;JMX_SERVER&gt; &lt;JMX_PORT&gt; &lt;KEY&gt;&quot;</span><br><span class="line">        exit;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># create connection</span><br><span class="line">exec 3&lt;&gt;/dev/tcp/$1/$2</span><br><span class="line"></span><br><span class="line"># compose message</span><br><span class="line">MSG=&quot;&#123;\&quot;request\&quot;: \&quot;java gateway jmx\&quot;,\&quot;jmx_endpoint\&quot;:\&quot;service:jmx:rmi:///jndi/rmi://$3:$4/jmxrmi\&quot;,\&quot;keys\&quot;: [\&quot;$5\&quot;]&#125;&quot;</span><br><span class="line"># write message length as zero-padded 16-digit hexadecimal number</span><br><span class="line">printf -v LEN &apos;%016x&apos; &quot;$&#123;#MSG&#125;&quot;</span><br><span class="line"></span><br><span class="line"># prepare message length in little endian representation</span><br><span class="line">BYTES=&quot;&quot;</span><br><span class="line">for i in &#123;0..14..2&#125;</span><br><span class="line">do</span><br><span class="line">        BYTES=&quot;\\x$&#123;LEN:$i:2&#125;$BYTES&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># prepend protocol header and message length</span><br><span class="line">printf &quot;ZBXD\\1$BYTES%s&quot; &quot;$MSG&quot; &gt;&amp;3</span><br><span class="line"></span><br><span class="line"># output the result skipping 5 bytes of &quot;ZBXD\\1&quot; header and 8 bytes of message length</span><br><span class="line">tail -c+13 &lt;&amp;3</span><br></pre></td></tr></table></figure></p><p>该脚本可自行存放，没有规定，测试命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zabbix_get_jmx 127.0.0.1 10052 10.0.7.50 7199 &apos;jmx[\&quot;org.apache.cassandra.metrics:type=ThreadPools,path=internal,scope=MemtablePostFlush,name=ActiveTasks\&quot;,\&quot;Value\&quot;]&apos;</span><br></pre></td></tr></table></figure></p><p>127.0.0.1:为java-gate-way地址；<br>10052：为java-gate-way端口；<br>10.0.7.50：为被监控端的ip地址；<br>7199：为被监控端jmx的端口；<br>org.apache**:为要获取的参数，需要获取哪些参数可查看<a href="https://cassandra.apache.org/doc/latest/operating/metrics.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载"><a href="#5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载" class="headerlink" title="5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载"></a>5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击<a href="https://share.zabbix.com/databases/cassandradb/cassandra-cluster-template-jmx" target="_blank" rel="noopener">此处</a>，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处<a href="https://pan.baidu.com/s/1Yo-9-dP6QRRl0nu5u-icYw" target="_blank" rel="noopener">下载</a></h2>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> cassandra </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] centos7.2 服务器 使用df -h卡死问题</title>
      <link href="/2018/08/23/centos7.2%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8df%20-h%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/"/>
      <url>/2018/08/23/centos7.2%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8df%20-h%E5%8D%A1%E6%AD%BB%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="1、服务器使用df-h命令卡死，crtl-c没有反应，ps-ef-grep-df-命令杀掉df-h进程也无效。"><a href="#1、服务器使用df-h命令卡死，crtl-c没有反应，ps-ef-grep-df-命令杀掉df-h进程也无效。" class="headerlink" title="1、服务器使用df -h命令卡死，crtl+c没有反应，ps -ef|grep df 命令杀掉df -h进程也无效。"></a>1、服务器使用df -h命令卡死，crtl+c没有反应，ps -ef|grep df 命令杀掉df -h进程也无效。</h2><h2 id="2、重新启动会话，使用strace跟踪df-h执行状态"><a href="#2、重新启动会话，使用strace跟踪df-h执行状态" class="headerlink" title="2、重新启动会话，使用strace跟踪df -h执行状态"></a>2、重新启动会话，使用strace跟踪df -h执行状态</h2><p>strace df -h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/df&quot;, [&quot;df&quot;, &quot;-h&quot;], [/* 24 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77097000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=19527, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 19527, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77092000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0 \34\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2107816, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3932736, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efe76ab6000</span><br><span class="line">mprotect(0x7efe76c6c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7efe76e6c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b6000) = 0x7efe76e6c000</span><br><span class="line">mmap(0x7efe76e72000, 16960, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efe76e72000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77091000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe7708f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7efe7708f740) = 0</span><br><span class="line">mprotect(0x7efe76e6c000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x616000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7efe77098000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7efe77092000, 19527)           = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">brk(0x1ebd000)                          = 0x1ebd000</span><br><span class="line">brk(NULL)                               = 0x1ebd000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106065056, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106065056, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe7058f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2502, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=190751, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 190751, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77060000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/mtab&quot;, O_RDONLY|O_CLOEXEC)   = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;rootfs / rootfs rw 0 0\nsysfs /sy&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;ev,noexec,relatime,freezer 0 0\nc&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;sd rw,relatime 0 0\n&quot;, 1024)   = 19</span><br><span class="line">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/lib64/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26254, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26254, PROT_READ, MAP_SHARED, 3, 0) = 0x7efe77059000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/pts&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/sys/fs/binfmt_misc&quot;</span><br></pre></td></tr></table></figure></p><p>df -h进程在”/proc/sys/fs/binfmt_misc”这个位置卡主了</p><h2 id="3、启动另一个会话，重新挂在这个目录"><a href="#3、启动另一个会话，重新挂在这个目录" class="headerlink" title="3、启动另一个会话，重新挂在这个目录"></a>3、启动另一个会话，重新挂在这个目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart proc-sys-fs-binfmt_misc.automount</span><br></pre></td></tr></table></figure><h2 id="4、strace-df-h-跟踪的进程内容有新的输出，完整信息输出如下："><a href="#4、strace-df-h-跟踪的进程内容有新的输出，完整信息输出如下：" class="headerlink" title="4、strace df -h 跟踪的进程内容有新的输出，完整信息输出如下："></a>4、strace df -h 跟踪的进程内容有新的输出，完整信息输出如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/df&quot;, [&quot;df&quot;, &quot;-h&quot;], [/* 24 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77097000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=19527, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 19527, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77092000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0 \34\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2107816, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3932736, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efe76ab6000</span><br><span class="line">mprotect(0x7efe76c6c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7efe76e6c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b6000) = 0x7efe76e6c000</span><br><span class="line">mmap(0x7efe76e72000, 16960, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efe76e72000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77091000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe7708f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7efe7708f740) = 0</span><br><span class="line">mprotect(0x7efe76e6c000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x616000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7efe77098000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7efe77092000, 19527)           = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">brk(0x1ebd000)                          = 0x1ebd000</span><br><span class="line">brk(NULL)                               = 0x1ebd000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106065056, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106065056, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe7058f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2502, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=190751, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 190751, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77060000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/mtab&quot;, O_RDONLY|O_CLOEXEC)   = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;rootfs / rootfs rw 0 0\nsysfs /sy&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;ev,noexec,relatime,freezer 0 0\nc&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;sd rw,relatime 0 0\n&quot;, 1024)   = 19</span><br><span class="line">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/lib64/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26254, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26254, PROT_READ, MAP_SHARED, 3, 0) = 0x7efe77059000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/pts&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/sys/fs/binfmt_misc&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/hugepages&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/debug&quot;, &#123;st_mode=S_IFDIR|0700, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/mqueue&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/boot&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run/user/0&quot;, &#123;st_mode=S_IFDIR|0700, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/var/lib/nfs/rpc_pipefs&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/fs/nfsd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;xkey-boss01-8035-184&quot;, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/&quot;, &#123;f_type=0x58465342, f_bsize=4096, f_blocks=9293380, f_bfree=5378782, f_bavail=5378782, f_files=37191680, f_ffree=37150656, f_fsid=&#123;64768, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=494791, f_bfree=494791, f_bavail=494791, f_files=494791, f_ffree=494430, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/kernel/security&quot;, &#123;f_type=SECURITYFS_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev/shm&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=497337, f_bavail=497337, f_files=497337, f_ffree=497336, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/run&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=458142, f_bavail=458142, f_files=497337, f_ffree=496689, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=497337, f_bavail=497337, f_files=497337, f_ffree=497324, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RDONLY|ST_NOSUID|ST_NODEV|ST_NOEXEC&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/systemd&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/pstore&quot;, &#123;f_type=PSTOREFS_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/memory&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/freezer&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/devices&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/blkio&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/kernel/config&quot;, &#123;f_type=0x62656570, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev/hugepages&quot;, &#123;f_type=HUGETLBFS_MAGIC, f_bsize=2097152, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=2097152, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/dev/hugepages&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/boot&quot;, &#123;f_type=0x58465342, f_bsize=4096, f_blocks=127147, f_bfree=95769, f_bavail=95769, f_files=512000, f_ffree=511670, f_fsid=&#123;64513, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/boot&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/run/user/0&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=99468, f_bfree=99468, f_bavail=99468, f_files=497337, f_ffree=497336, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/run/user/0&quot;, &#123;st_mode=S_IFDIR|0700, st_size=40, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/proc/fs/nfsd&quot;, &#123;f_type=0x6e667364, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/proc/fs/nfsd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(136, 7), ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">write(1, &quot;\346\226\207\344\273\266\347\263\273\347\273\237                 \345\256\271&quot;..., 70文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">) = 70</span><br><span class="line">write(1, &quot;/dev/mapper/centos-root   36G   &quot;..., 50/dev/mapper/centos-root   36G   15G   21G   43% /</span><br><span class="line">) = 50</span><br><span class="line">write(1, &quot;devtmpfs                 1.9G   &quot;..., 53devtmpfs                 1.9G     0  1.9G    0% /dev</span><br><span class="line">) = 53</span><br><span class="line">write(1, &quot;tmpfs                    1.9G   &quot;..., 57tmpfs                    1.9G     0  1.9G    0% /dev/shm</span><br><span class="line">) = 57</span><br><span class="line">write(1, &quot;tmpfs                    1.9G  1&quot;..., 53tmpfs                    1.9G  154M  1.8G    8% /run</span><br><span class="line">) = 53</span><br><span class="line">write(1, &quot;tmpfs                    1.9G   &quot;..., 63tmpfs                    1.9G     0  1.9G    0% /sys/fs/cgroup</span><br><span class="line">) = 63</span><br><span class="line">write(1, &quot;/dev/vda1                497M  1&quot;..., 54/dev/vda1                497M  123M  375M   25% /boot</span><br><span class="line">) = 54</span><br><span class="line">write(1, &quot;tmpfs                    389M   &quot;..., 60tmpfs                    389M     0  389M    0% /run/user/0</span><br><span class="line">) = 60</span><br><span class="line">close(1)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure><h2 id="5、重新使用df-h命令，恢复正常。"><a href="#5、重新使用df-h命令，恢复正常。" class="headerlink" title="5、重新使用df -h命令，恢复正常。"></a>5、重新使用df -h命令，恢复正常。</h2>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] InnoDB：page_cleaner：1000ms intended loop took xxxms</title>
      <link href="/2018/08/21/InnoDB-page_cleaner-1000ms%20intended%20loop%20took%20xxxms/"/>
      <url>/2018/08/21/InnoDB-page_cleaner-1000ms%20intended%20loop%20took%20xxxms/</url>
      <content type="html"><![CDATA[<h2 id="1、在查看mysqllog日志的时候不经意间发现一条这个提示："><a href="#1、在查看mysqllog日志的时候不经意间发现一条这个提示：" class="headerlink" title="1、在查看mysqllog日志的时候不经意间发现一条这个提示："></a>1、在查看mysqllog日志的时候不经意间发现一条这个提示：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] InnoDB: page_cleaner: 1000ms intended loop took 16111ms. The settings might not be optimal. (flushed=7 and evicted=0, during the time.)</span><br></pre></td></tr></table></figure><p>造成该问题的主要原因：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">page_cleaner_thread:脏页清理线程负责将脏页从内存写到磁盘。</span><br><span class="line"></span><br><span class="line">出现该问题的原因：上面提示的信息的含义是,有大量脏页需要刷新，理论上应该在1s内完成，但实际却用了16s的时间将脏页刷新到磁盘，它接受脏页的数量远远大于它每秒能够处理脏页的能力，因此为了避免该问题，可降低每秒循环期间搜索脏页的深度（innodb_lru_scan_depth）。</span><br><span class="line"></span><br><span class="line">如果数据库存在很多的buffer pool instance 将会引起更多的刷新工作，因此如果只是增大 buffer pool instances 而没有降低lru_scan_depth,很可能会引起性能瓶颈。</span><br><span class="line"></span><br><span class="line">如果只是临时对数据库进行大量导入操作造成的这类问题,可以忽略这个问题不需关注。如果数据库一直存在大量更新操作，快速创建大量的脏页，该问题一直存在需要关注。</span><br></pre></td></tr></table></figure></p><p>下面是官方文档对lru_scan_depth参数的解释，中文为自己对官方文档的理解翻译，错误之处望大家指正。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A setting smaller than the default is generally suitable for most workloads. A value that is much higher than necessary may impact performance. Only consider increasing the value if you have spare I/O capacity under a typical workload. Conversely, if a write-intensive workload saturates your I/O capacity, decrease the value, especially in the case of a large buffer pool.</span><br><span class="line">When tuning innodb_lru_scan_depth, start with a low value and configure the setting upward with the goal of rarely seeing zero free pages. Also, consider adjusting innodb_lru_scan_depth when changing the number of buffer pool instances, since innodb_lru_scan_depth * innodb_buffer_pool_instances defines the amount of work performed by the page cleaner thread each second.</span><br><span class="line">比默认值小适合于大多数工作负载，如果设置比默认值大可能会影响性能。只有当有额外的磁盘io容量的时候才考虑需不需要增加该值。相反，如果在写密集度负载已经使io容量饱和，需要降低该值，尤其是buffer pool的值设置特别大的时候。</span><br><span class="line"></span><br><span class="line">如果lru_scan_depth值特别低，而且存在0空闲页，可以考虑调高该值。如果调整buffer pool instances时，需要考虑是否调整innodb_lru_scan_depth大小，因为innodb_lru_scan_depth * innodb_buffer_pool_instances决定了每秒page cleaner thread处理的工作量。</span><br></pre></td></tr></table></figure></p><h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL innodb_lru_scan_depth=256;</span><br></pre></td></tr></table></figure><p>该参数默认只为1024。<br>这只是数据库级别调整，出现该问题还需要查看服务器硬件问题，磁盘io是否达到瓶颈扥问题。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mgr集群节点主节点与两个从节点网络异常，造成的集群异常问题</title>
      <link href="/2018/08/20/mysql-mgr%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8E%E4%B8%A4%E4%B8%AA%E4%BB%8E%E8%8A%82%E7%82%B9%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%EF%BC%8C%E9%80%A0%E6%88%90%E7%9A%84%E9%9B%86%E7%BE%A4%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/"/>
      <url>/2018/08/20/mysql-mgr%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8E%E4%B8%A4%E4%B8%AA%E4%BB%8E%E8%8A%82%E7%82%B9%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%EF%BC%8C%E9%80%A0%E6%88%90%E7%9A%84%E9%9B%86%E7%BE%A4%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B-切换为主，报错如下："><a href="#1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B-切换为主，报错如下：" class="headerlink" title="1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B)切换为主，报错如下："></a>1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B)切换为主，报错如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-08-20T05:38:16.071653Z 0 [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-2:3306 has become unreachable.&apos;</span><br><span class="line">2018-08-20T05:38:16.071730Z 0 [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-3:3306 has become unreachable.&apos;</span><br><span class="line">2018-08-20T05:38:16.071744Z 0 [ERROR] Plugin group_replication reported: &apos;This server is not able to reach a majority of members in the group. This server will now block all updates. The server will remain blocked until contact with the majority is restored. It is possible to use group_replication_force_members to force a new group membership.&apos;</span><br></pre></td></tr></table></figure><h2 id="2、对故障节点A操作，使其重新加入集群"><a href="#2、对故障节点A操作，使其重新加入集群" class="headerlink" title="2、对故障节点A操作，使其重新加入集群"></a>2、对故障节点A操作，使其重新加入集群</h2><p>A节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p><p>查看报错日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2018-08-20T07:29:40.796952Z 12 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-08-20T07:29:40.803975Z 26 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-08-20T07:29:40.855935Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;wallet-mysql-2&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-08-20T07:29:40.906041Z 12 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 4/10&apos;</span><br><span class="line">2018-08-20T07:29:40.949597Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;wallet-mysql-3&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-08-20T07:29:41.001446Z 12 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e at wallet-mysql-3 port: 3306.&apos;</span><br><span class="line">2018-08-20T07:29:41.001738Z 29 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-08-20T07:29:41.005538Z 29 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@wallet-mysql-3:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-08-20T07:29:41.016839Z 30 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-08-20T07:29:41.028408Z 29 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-08-20T07:29:41.028442Z 29 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-08-20T07:29:41.028449Z 29 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-08-20T07:29:41.028493Z 12 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-08-20T07:29:41.028790Z 30 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-08-20T07:29:41.085012Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;wallet-mysql-3&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br></pre></td></tr></table></figure></p><p>出现该问题的原因是现在的新的主节点B，已经清除了binglog,A节点需要恢复的日志已经找不到了，因此需要对A进行数据恢复。</p><h2 id="3、在B节点mysqldump一份最新数据，命令如下："><a href="#3、在B节点mysqldump一份最新数据，命令如下：" class="headerlink" title="3、在B节点mysqldump一份最新数据，命令如下："></a>3、在B节点mysqldump一份最新数据，命令如下：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqldump --all-databases --<span class="built_in">set</span>-gtid-purged=ON --single-transaction -uroot -p***** &gt; /data/backup/all.sql</span><br></pre></td></tr></table></figure><h2 id="4、将dump的数据库拷贝到A节点，对节点A进行恢复："><a href="#4、将dump的数据库拷贝到A节点，对节点A进行恢复：" class="headerlink" title="4、将dump的数据库拷贝到A节点，对节点A进行恢复："></a>4、将dump的数据库拷贝到A节点，对节点A进行恢复：</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p******* &lt; /data/backup/all.sql</span><br></pre></td></tr></table></figure><p>执行提示报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</span><br></pre></td></tr></table></figure></p><p>解决方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">提示只有@@GLOBAL.GTID_EXECUTED为空是，才能设置@@GLOBAL.GTID_PURGED的值，清空GLOBAL.GTID_EXECUTED的值</span><br><span class="line">root@db 07:53:  [(none)]&gt; reset master;</span><br><span class="line">ERROR 3190 (HY000): RESET MASTER is not allowed because Group Replication is running.</span><br><span class="line">root@db 07:53:  [(none)]&gt; stop group_replication;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">root@db 07:53:  [(none)]&gt; reset master;</span><br><span class="line">Query OK, 0 rows affected (0.27 sec)</span><br><span class="line">如果数据库为只读的状态还需要将数据库改为读写模式：</span><br><span class="line">root@db 07:54:  [performance_schema]&gt; set global read_only=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="5、重新恢复数据"><a href="#5、重新恢复数据" class="headerlink" title="5、重新恢复数据"></a>5、重新恢复数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p******* &lt; /data/backup/all.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure><p>恢复完成</p><h2 id="6、重新将该节点加入集群"><a href="#6、重新将该节点加入集群" class="headerlink" title="6、重新将该节点加入集群"></a>6、重新将该节点加入集群</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">root@db 07:56:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">| group_replication_applier |           |             |        NULL | OFFLINE      |</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@db <span class="number">07</span>:<span class="number">56</span>:  [performance_schema]&gt; <span class="keyword">start</span> group_replication;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (3.03 sec)</span><br><span class="line">root@db 07:57:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">| group_replication_applier | *** | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-1 |        3306 | RECOVERING   |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>此时节点A正在与主节点同步数据，待同步完成之后再查看及节点之间的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:57:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>此时集群恢复完成。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控redis数据库</title>
      <link href="/2018/08/17/zabbix%E7%9B%91%E6%8E%A7redis/"/>
      <url>/2018/08/17/zabbix%E7%9B%91%E6%8E%A7redis/</url>
      <content type="html"><![CDATA[<h3 id="1、编写定期收集redis信息脚本，并指定到对应目录"><a href="#1、编写定期收集redis信息脚本，并指定到对应目录" class="headerlink" title="1、编写定期收集redis信息脚本，并指定到对应目录"></a>1、编写定期收集redis信息脚本，并指定到对应目录</h3><p>cat /usr/local/zabbix/script/redis_get_data.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件路径</span></span><br><span class="line">dbconfigfile=/data/redis/etc/redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">主机ip地址</span></span><br><span class="line">dbhost=`cat $&#123;dbconfigfile&#125; |grep bind|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">redis启动端口</span></span><br><span class="line">dbport=`cat $&#123;dbconfigfile&#125; |grep port|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">数据库命令路径</span></span><br><span class="line">dbcmdpath=/data/redis/src</span><br><span class="line"><span class="meta">#</span><span class="bash">数据库密码</span></span><br><span class="line">dbpass=`cat $&#123;dbconfigfile&#125; |grep requirepass|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">指定生成的<span class="built_in">log</span>路径</span></span><br><span class="line">dblogpath=/tmp/redis.log</span><br><span class="line"><span class="meta">#</span><span class="bash">如果有没密码，使用以下命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$&#123;dbcmdpath&#125;</span>/redis-cli -h <span class="variable">$&#123;dbhost&#125;</span> -a <span class="variable">$&#123;dbpass&#125;</span> -p <span class="variable">$&#123;dbport&#125;</span>  <span class="string">'info'</span> &gt; <span class="variable">$&#123;dblogpath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果没有密码，使用以下命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbcmdpath&#125;/redis-cli -h <span class="variable">$&#123;dbhost&#125;</span> -p <span class="variable">$&#123;dbport&#125;</span>  <span class="string">'info'</span> &gt; <span class="variable">$&#123;dblogpath&#125;</span></span></span><br></pre></td></tr></table></figure></p><p>修改redis配置文件目录，生成的log目录，修改完成之后授权脚本执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/redis_get_data.sh</span><br></pre></td></tr></table></figure></p><h3 id="2、将脚本添加到定时任务，每分钟执行一次"><a href="#2、将脚本添加到定时任务，每分钟执行一次" class="headerlink" title="2、将脚本添加到定时任务，每分钟执行一次"></a>2、将脚本添加到定时任务，每分钟执行一次</h3><p>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /usr/local/zabbix/script/redis_get_data.sh</span><br></pre></td></tr></table></figure></p><h3 id="3、编写zabbix监控项文件-通过-usr-local-zabbix-script-redis-get-data-sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值"><a href="#3、编写zabbix监控项文件-通过-usr-local-zabbix-script-redis-get-data-sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值" class="headerlink" title="3、编写zabbix监控项文件,通过/usr/local/zabbix/script/redis_get_data.sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值"></a>3、编写zabbix监控项文件,通过/usr/local/zabbix/script/redis_get_data.sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值</h3><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/redis_monitor_parameter.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#数据库进程是否存在</span><br><span class="line">UserParameter=redis_exist[*],ps -ef|grep redis-server|grep -v grep|wc -l</span><br><span class="line">#客户端连接数，包括从库的连接</span><br><span class="line">UserParameter=connected_clients[*],cat /tmp/redis.log |grep &apos;connected_clients&apos; |cut -d&apos;:&apos; -f2</span><br><span class="line">#当前客户端最长输出列表</span><br><span class="line">UserParameter=client_longest_output_list[*],cat /tmp/redis.log |grep client_longest_output_list |cut -d&apos;:&apos; -f2</span><br><span class="line">#当前客户端最大输入缓冲区</span><br><span class="line">UserParameter=client_biggest_input_buf[*],cat /tmp/redis.log |grep client_biggest_input_buf |cut -d&apos;:&apos; -f2</span><br><span class="line">#阻塞会话数</span><br><span class="line">UserParameter=blocked_clients[*],cat /tmp/redis.log |grep blocked_clients |cut -d&apos;:&apos; -f2</span><br><span class="line">#redis通过分配器分配的总内存</span><br><span class="line">UserParameter=used_memory[*],cat /tmp/redis.log |grep used_memory |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#操作系统通过top和ps命令查看到redis分配的内存</span><br><span class="line">UserParameter=used_memory_rss[*],cat /tmp/redis.log |grep used_memory_rss |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#redis消耗内存的峰值</span><br><span class="line">UserParameter=used_memory_peak[*],cat /tmp/redis.log |grep used_memory_peak |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#系统为管理内部数据架构造成的所有内存开销</span><br><span class="line">UserParameter=used_memory_overhead[*],cat /tmp/redis.log |grep used_memory_overhead |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#redis启动初始化消耗的内存</span><br><span class="line">UserParameter=used_memory_startup[*],cat /tmp/redis.log |grep used_memory_startup |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#数据集的大小（used_memory减去used_memory_overhead）</span><br><span class="line">UserParameter=used_memory_dataset[*],cat /tmp/redis.log |grep used_memory_dataset |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#数据集内存占净内存的百分比（used_memory_dataset/(used_memory-used_memory_startup))</span><br><span class="line">UserParameter=used_memory_dataset_perc[*],cat /tmp/redis.log |grep used_memory_dataset_perc |cut -d&apos;:&apos; -f2|head -1|cut -d&apos;%&apos; -f1</span><br><span class="line">#lua引擎使用的内存</span><br><span class="line">UserParameter=used_memory_lua[*],cat /tmp/redis.log |grep used_memory_lua |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#系统配置文件配置的内存</span><br><span class="line">UserParameter=maxmemory[*],cat /tmp/redis.log |grep maxmemory |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#内存碎片率（需要重点关注）远大于1过高说明内存碎片化严重，原小于1过低说明有大量内存交换，建议增加内存。</span><br><span class="line">UserParameter=mem_fragmentation_ratio[*],cat /tmp/redis.log |grep mem_fragmentation_ratio |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#自上次转存以来redis发生的更改数</span><br><span class="line">UserParameter=rdb_changes_since_last_save[*],cat /tmp/redis.log |grep rdb_changes_since_last_save |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端接受的总连接数</span><br><span class="line">UserParameter=total_connections_received[*],cat /tmp/redis.log |grep total_connections_received |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端处理命令总数</span><br><span class="line">UserParameter=total_commands_processed[*],cat /tmp/redis.log |grep total_commands_processed |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端每秒处理命令数</span><br><span class="line">UserParameter=instantaneous_ops_per_sec[*],cat /tmp/redis.log |grep instantaneous_ops_per_sec |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#网络读取的总流量</span><br><span class="line">UserParameter=total_net_input_bytes[*],cat /tmp/redis.log |grep total_net_input_bytes |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#网络写入的总流量</span><br><span class="line">UserParameter=total_net_output_bytes[*],cat /tmp/redis.log |grep total_net_output_bytes |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#每秒网络读的流量</span><br><span class="line">UserParameter=instantaneous_input_kbps[*],cat /tmp/redis.log |grep instantaneous_input_kbps |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#每秒网络写的流量</span><br><span class="line">UserParameter=instantaneous_output_kbps[*],cat /tmp/redis.log |grep instantaneous_output_kbps |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#因最大连接数达到上限，而被拒绝的连接数，maxclient默认值为10000</span><br><span class="line">UserParameter=rejected_connections[*],cat /tmp/redis.log |grep rejected_connections |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#键值到期总数</span><br><span class="line">UserParameter=expired_keys[*],cat /tmp/redis.log |grep expired_keys |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#因maxmemory限制，被驱逐的键值</span><br><span class="line">UserParameter=evicted_keys[*],cat /tmp/redis.log |grep evicted_keys |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#在主字典里面键值匹配成功的次数</span><br><span class="line">UserParameter=keyspace_hits[*],cat /tmp/redis.log |grep keyspace_hits |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#在主字典里面键值匹配失败的次数</span><br><span class="line">UserParameter=keyspace_misses[*],cat /tmp/redis.log |grep keyspace_misses |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#db0数据库键值的数量</span><br><span class="line">UserParameter=db0_keys[*], cat /tmp/redis.log |grep db0 |cat /tmp/redis.log |grep db0|cut -d &apos;,&apos; -f1|cut -d &apos;=&apos; -f2</span><br><span class="line">#db0数据库键值过期的数量</span><br><span class="line">UserParameter=db0_keys_expired[*],cat /tmp/redis.log |cat /tmp/redis.log |grep db0|cut -d &apos;,&apos; -f2|cut -d &apos;=&apos; -f2</span><br></pre></td></tr></table></figure><h3 id="4、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数："><a href="#4、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数：" class="headerlink" title="4、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数："></a>4、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span><br></pre></td></tr></table></figure><p>添加完成之后，需要重启zabbix_agent客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure></p><h3 id="5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载"><a href="#5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载" class="headerlink" title="5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载"></a>5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击<a href="https://pan.baidu.com/s/1dpWSBo-gZXk34aQNtjwqEw" target="_blank" rel="noopener">下载</a></h3>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[linux] suse_11_sp4安装samba-server</title>
      <link href="/2018/08/17/samba%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/08/17/samba%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="0、当前系统版本"><a href="#0、当前系统版本" class="headerlink" title="0、当前系统版本"></a>0、当前系统版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">Welcome to SUSE Linux Enterprise Server 11 SP4  (x86_64) - Kernel \r (\l).</span><br></pre></td></tr></table></figure><h2 id="1、查看samba是否安装"><a href="#1、查看samba是否安装" class="headerlink" title="1、查看samba是否安装"></a>1、查看samba是否安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # rpm -q samba</span><br><span class="line">samba-3.6.3-0.58.1</span><br></pre></td></tr></table></figure><p>如果没有安装，使用以下命令安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # zypper install samba</span><br></pre></td></tr></table></figure></p><h2 id="2、新建共享目录"><a href="#2、新建共享目录" class="headerlink" title="2、新建共享目录"></a>2、新建共享目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # mkdir -p /data/share</span><br></pre></td></tr></table></figure><h2 id="3、开始配置共享目录"><a href="#3、开始配置共享目录" class="headerlink" title="3、开始配置共享目录"></a>3、开始配置共享目录</h2><p>yast进入控制台,network services-samba server<br><img src="https://i.imgur.com/LZWt4Tz.png" alt=""><br>第一次启用samba server会做一些初始化，操作如下（也可根据自己需求自定义）：<br><img src="https://i.imgur.com/xFQrJwS.png" alt=""><br><img src="https://i.imgur.com/BUT6kUS.png" alt=""><br><img src="https://i.imgur.com/G06GBBG.png" alt=""><br>初始化完成之后，再一次进入samba server,会显示如下：<br><img src="https://i.imgur.com/P74w0YP.png" alt=""><br>点击add,开始新增共享目录<br><img src="https://i.imgur.com/e0OSaZ3.png" alt=""><br>修改完成之后保存，会显示新的share目录<br><img src="https://i.imgur.com/r0ueNn5.png" alt=""></p><h2 id="4、添加smbuser系统用户"><a href="#4、添加smbuser系统用户" class="headerlink" title="4、添加smbuser系统用户"></a>4、添加smbuser系统用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # useradd smbuser</span><br><span class="line">localhost:~ # passwd smbuser</span><br><span class="line">Changing password for smbuser.</span><br><span class="line">New Password: </span><br><span class="line">Bad password: too simple</span><br><span class="line">Reenter New Password: </span><br><span class="line">Password changed.</span><br></pre></td></tr></table></figure><h2 id="5、为samba服务添加访问用户，设置访问用的密码："><a href="#5、为samba服务添加访问用户，设置访问用的密码：" class="headerlink" title="5、为samba服务添加访问用户，设置访问用的密码："></a>5、为samba服务添加访问用户，设置访问用的密码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # smbpasswd -a smbuser</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user smbuser.</span><br></pre></td></tr></table></figure><h2 id="6、修改共享目录权限"><a href="#6、修改共享目录权限" class="headerlink" title="6、修改共享目录权限"></a>6、修改共享目录权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown smbuser /data/share</span><br><span class="line">chmod 777 /data/share</span><br></pre></td></tr></table></figure><p>**如果不修改目录权限，访问预览都是正常的，但是没有写权限，创建目录会报错</p><h2 id="7、修改配置配置文件-添加读写权限"><a href="#7、修改配置配置文件-添加读写权限" class="headerlink" title="7、修改配置配置文件,添加读写权限"></a>7、修改配置配置文件,添加读写权限</h2><p>vim /etc/samba/smb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[share]</span></span><br><span class="line">        <span class="string">comment</span> <span class="string">=</span> <span class="string">share</span></span><br><span class="line">        <span class="string">inherit</span> <span class="string">acls</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">        <span class="string">path</span> <span class="string">=</span> <span class="string">/data/share</span></span><br><span class="line">        <span class="string">read</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">No</span></span><br><span class="line">        <span class="string">Valid</span> <span class="string">users</span> <span class="string">=smbuser</span></span><br><span class="line">        <span class="string">Writable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">　      <span class="string">Browsable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br></pre></td></tr></table></figure></p><h2 id="8、重启samba服务器"><a href="#8、重启samba服务器" class="headerlink" title="8、重启samba服务器"></a>8、重启samba服务器</h2><p>/etc/rc.d/smb restart</p><h2 id="9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口"><a href="#9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口" class="headerlink" title="9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口"></a>9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口</h2><p>vim /etc/sysconfig/SuSEfirewall2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FW_SERVICES_EXT_TCP=&quot;22 1521 139 445&quot;</span><br></pre></td></tr></table></figure></p><p>重新启动防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rcSuSEfirewall2 restart</span><br></pre></td></tr></table></figure></p><h2 id="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："><a href="#10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：" class="headerlink" title="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："></a>10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：</h2><p><img src="https://i.imgur.com/XPOeklf.png" alt=""><br>因此修改sambaserver服务器端的协议，启用smbv2协议<br>vim /etc/samba/smb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">min protocol = SMB2</span><br><span class="line">max protocol = SMB2</span><br><span class="line">client min protocol = SMB2</span><br><span class="line">client max protocol = SMB2</span><br></pre></td></tr></table></figure></p><p>重启samba服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.d/smb restart</span><br></pre></td></tr></table></figure></p><h2 id="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"><a href="#11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误" class="headerlink" title="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"></a>11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -U smbuser //10.0.30.180/share -m smb2</span><br><span class="line">Unrecognised protocol level smb2</span><br><span class="line">WARNING: Ignoring invalid value &apos;SMB3&apos; for parameter &apos;max protocol&apos;</span><br><span class="line">Unknown parameter encountered: &quot;client min protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client min protocol&quot;</span><br><span class="line">Unknown parameter encountered: &quot;client max protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client max protocol&quot;</span><br></pre></td></tr></table></figure><p>该问题为suse 11版本的问题，默认只支持smbv1协议，suse12版本之后才开始支持smbv2.</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql lock table &amp;&amp; unlock tables实验</title>
      <link href="/2018/08/17/mysql%20lock%20table%20&amp;&amp;%20unlock%20tables%E5%AE%9E%E9%AA%8C/"/>
      <url>/2018/08/17/mysql%20lock%20table%20&amp;&amp;%20unlock%20tables%E5%AE%9E%E9%AA%8C/</url>
      <content type="html"><![CDATA[<h2 id="0、mysql版本"><a href="#0、mysql版本" class="headerlink" title="0、mysql版本"></a>0、mysql版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:12:  [aaaa]&gt; select @@version;</span><br><span class="line">+------------+</span><br><span class="line">| @@version  |</span><br><span class="line">+------------+</span><br><span class="line">| 5.7.22-log |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="1、创建实验表，内容如下："><a href="#1、创建实验表，内容如下：" class="headerlink" title="1、创建实验表，内容如下："></a>1、创建实验表，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:11:  [aaaa]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_aaaa |</span><br><span class="line">+----------------+</span><br><span class="line">| aaa            |</span><br><span class="line">| bbb            |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from bbb;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="2、开启两个会话，session1、session2-对表aaa进行read表锁"><a href="#2、开启两个会话，session1、session2-对表aaa进行read表锁" class="headerlink" title="2、开启两个会话，session1、session2,对表aaa进行read表锁"></a>2、开启两个会话，session1、session2,对表aaa进行read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:16:  [aaaa]&gt; lock table aaa read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:17:  [aaaa]&gt; </span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;aaa&apos; was locked with a READ lock and can&apos;t be updated</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:18:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:20:  [aaaa]&gt; show OPEN TABLES where In_use &gt; 0;</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| Database | Table | In_use | Name_locked |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| aaaa     | aaa   |      1 |           0 |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：在session1对表aaa进行read锁表，session1只能对表aaa进行读操作，对其他表没有任何操作权限，session2对表aaa有读权限，没有写权限。</p><h2 id="3、开启两个会话，session1、session2-对表aaa进行write表锁"><a href="#3、开启两个会话，session1、session2-对表aaa进行write表锁" class="headerlink" title="3、开启两个会话，session1、session2,对表aaa进行write表锁"></a>3、开启两个会话，session1、session2,对表aaa进行write表锁</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; lock table aaa write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:27:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">root@db 15:29:  [aaaa]&gt; update bbb set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:20:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:28:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:31:  [aaaa]&gt; unlock  tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：在session1对表aaa进行write锁表，session1对表aaa有读写权限，对其他表没有任何操作权限，session2对表aaa即没有读权限，又没有写权限。</p><h2 id="4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁"><a href="#4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁" class="headerlink" title="4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁"></a>4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:32:  [aaaa]&gt; lock table aaa write , aaa as t1 read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:32root@db 04:01:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:01:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:02:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;t1&apos; was locked with a READ lock and can&apos;t be updated</span><br><span class="line">root@db 04:04:  [aaaa]&gt; update aaa  set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa as t1;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;1&apos; for key &apos;PRIMARY&apos;</span><br></pre></td></tr></table></figure></p><p>session2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:05:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 04:06:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=2;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:07:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：session1对表aaa同时进行read，write锁，需要使用别名。对表进行select,update操作正常，如果使用insert into aaa select * from aaa as t1;需要加上别名。session 2对表aaa即没有读权限，又没有写权限。</p><h2 id="5、对表aaa进行read表锁，并使用别名"><a href="#5、对表aaa进行read表锁，并使用别名" class="headerlink" title="5、对表aaa进行read表锁，并使用别名"></a>5、对表aaa进行read表锁，并使用别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:47:  [aaaa]&gt;  LOCK TABLE aaa AS t1 READ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:48:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：session 1对表aaa加别名read表锁，session1查询需要使用别名，直接查询无效，session2对表aaa有读权限，无写权限</p><h2 id="6、对表aaa使用write表锁，并添加别名"><a href="#6、对表aaa使用write表锁，并添加别名" class="headerlink" title="6、对表aaa使用write表锁，并添加别名"></a>6、对表aaa使用write表锁，并添加别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:51:  [aaaa]&gt; LOCK TABLE aaa AS t1 write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; </span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:54:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>结论：session 1对表aaa加别名write表锁，session1查询和更改需要使用别名，直接查询和更改无效，session2对表aaa无读权限，无写权限</p><p>##7、额外提示：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">LOCK</span> <span class="string">TABLES或者UNLOCK</span> <span class="string">TABLES，当应用于分区表时，始终锁定或解锁整个表;</span> <span class="string">这些语句不支持分区锁定修剪</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控mongodb数据库</title>
      <link href="/2018/08/15/zabbix%E7%9B%91%E6%8E%A7mongodb/"/>
      <url>/2018/08/15/zabbix%E7%9B%91%E6%8E%A7mongodb/</url>
      <content type="html"><![CDATA[<h2 id="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"><a href="#1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本" class="headerlink" title="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"></a>1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本</h2><p>mkdir -p /usr/local/zabbix/script<br>vim /usr/local/zabbix/script/zabbix_monitor_mongodb.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#mongodb管理员用户</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#mongodb管理员密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#Mongodb指定验证数据库</span></span><br><span class="line"><span class="string">authdb=admin</span></span><br><span class="line"><span class="comment">#mongodb指定端口</span></span><br><span class="line"><span class="string">dbport=30000</span></span><br><span class="line"><span class="comment">#mongodb安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongo</span> <span class="bullet">--port</span> <span class="string">$&#123;dbport&#125;</span> <span class="bullet">-u</span> <span class="string">$&#123;authuser&#125;</span> <span class="bullet">-p</span> <span class="string">$&#123;authpass&#125;</span> <span class="bullet">--authenticationDatabase</span> <span class="string">$&#123;authdb&#125;</span></span><br></pre></td></tr></table></figure></p><p>授权脚本执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/zabbix_monitor_mongodb.sh</span><br></pre></td></tr></table></figure></p><h2 id="2、修改zabbix监控项脚本，用于获取mongodb参数"><a href="#2、修改zabbix监控项脚本，用于获取mongodb参数" class="headerlink" title="2、修改zabbix监控项脚本，用于获取mongodb参数"></a>2、修改zabbix监控项脚本，用于获取mongodb参数</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/zabbix_mongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#当前连接数，包括当前的shell会话，副本集成员连接，mongos实例连接</span><br><span class="line">#(4.0version)connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前可用的连接数，数据库上的连接负载的值</span><br><span class="line">#(4.0version)connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#服务器所有的连接，包括已经关闭的连接</span><br><span class="line">#(4.0version)connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p|cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line"></span><br><span class="line">#因锁而造成排队等待的总数</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因读锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因写锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用内存情况</span><br><span class="line">#(4.0version)mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用虚拟内存的大小</span><br><span class="line">#(4.0version)mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#流入mongodb数据库的总量</span><br><span class="line">#(4.0version)network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库流出总量</span><br><span class="line">#(4.0version)network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1|cut -d &apos;&quot;&apos; -f2|cut -d &apos;&quot;&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库总请求数</span><br><span class="line">#(4.0version)network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前副本集状态，为1代表为主节点，为2代表为从节点</span><br><span class="line">#(4.0version)rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#页错误总数，当数据库性能不佳、内存限制、或者数据库较大会导致该值增加</span><br><span class="line">#(4.0version)extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br></pre></td></tr></table></figure></p><h2 id="3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件"><a href="#3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件" class="headerlink" title="3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件"></a>3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span></span><br></pre></td></tr></table></figure></p><h2 id="4、重新启动agent客户端"><a href="#4、重新启动agent客户端" class="headerlink" title="4、重新启动agent客户端"></a>4、重新启动agent客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure><h2 id="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"><a href="#5、通过zabbix-web端，添加配置模板，参考模板，点击下载" class="headerlink" title="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"></a>5、通过zabbix-web端，添加配置模板，参考模板，点击<a href="https://pan.baidu.com/s/1tpyzeOEFihpWge_IN-zDdw" target="_blank" rel="noopener">下载</a></h2>]]></content>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix监控mysql数据库</title>
      <link href="/2018/08/14/zabbix%E7%9B%91%E6%8E%A7mysql/"/>
      <url>/2018/08/14/zabbix%E7%9B%91%E6%8E%A7mysql/</url>
      <content type="html"><![CDATA[<h3 id="1、编写定期收集mysql信息脚本，并指定到对应目录"><a href="#1、编写定期收集mysql信息脚本，并指定到对应目录" class="headerlink" title="1、编写定期收集mysql信息脚本，并指定到对应目录"></a>1、编写定期收集mysql信息脚本，并指定到对应目录</h3><p>cat /usr/local/zabbix/script/mysql_monitor.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">dbpath='/data/mysql/bin/mysql'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的用户</span></span><br><span class="line">dbuser='root'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的密码</span></span><br><span class="line">dbpass='123456'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的端口</span></span><br><span class="line">dbport='3306'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的socket文件</span></span><br><span class="line">dbsocket='/data/mysql/tmp/mysql.sock'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-status日志路径</span></span><br><span class="line">dbstatuspath=/tmp/mysql_status_monitor.log</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-engine-status日志路径</span></span><br><span class="line">dbenginestatuspath=/tmp/mysql_engine_innodb_status.log</span><br><span class="line"><span class="meta">#</span><span class="bash">self-define-script</span></span><br><span class="line">dbselfpath=/tmp/mysql_self_status.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查询mysql-status信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbpath&#125; -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> -S<span class="variable">$&#123;dbsocket&#125;</span> -P<span class="variable">$&#123;dbport&#125;</span> -BNe <span class="string">"show global status;"</span> &gt; <span class="variable">$&#123;dbstatuspath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查询mysql-engine-innodb信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbpath&#125; -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> -S<span class="variable">$&#123;dbsocket&#125;</span> -P<span class="variable">$&#123;dbport&#125;</span> -BNe <span class="string">"show engine innodb status\G"</span> &gt; <span class="variable">$&#123;dbenginestatuspath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">检查集群节点</span></span><br><span class="line">nodecount=`export MYSQL_PWD=$&#123;dbpass&#125;;$&#123;dbpath&#125; -u$&#123;dbuser&#125; --socket=/data/mysql/data/mysql.sock -P$&#123;dbport&#125; -BNe "select count(*) from performance_schema.replication_group_members where MEMBER_STATE != 'ONLINE'"`</span><br><span class="line">echo -e "nodecount $&#123;nodecount&#125;" &gt; $&#123;dbselfpath&#125;</span><br></pre></td></tr></table></figure></p><p>根据自己的数据库配置，修改相应的参数，修改完成之后授权脚本执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/mysql_monitor.sh</span><br></pre></td></tr></table></figure></p><h3 id="2、将脚本添加到定时任务，每分钟执行一次"><a href="#2、将脚本添加到定时任务，每分钟执行一次" class="headerlink" title="2、将脚本添加到定时任务，每分钟执行一次"></a>2、将脚本添加到定时任务，每分钟执行一次</h3><p>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /usr/local/zabbix/script/mysql_monitor.sh</span><br></pre></td></tr></table></figure></p><h3 id="3、编写获取数据脚本，对定时生成的log文件进行信息筛选"><a href="#3、编写获取数据脚本，对定时生成的log文件进行信息筛选" class="headerlink" title="3、编写获取数据脚本，对定时生成的log文件进行信息筛选"></a>3、编写获取数据脚本，对定时生成的log文件进行信息筛选</h3><p>cat /usr/local/zabbix/script/mysql_get_data.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">case $1 in</span><br><span class="line">nodecount)</span><br><span class="line">       #查询集群节点存活状态</span><br><span class="line">       cat /tmp/mysql_self_status.log |awk '/nodecount/ &#123;print $2&#125;' |head -1 </span><br><span class="line">       ;;</span><br><span class="line">uptime)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_select)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_select/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    com_insert)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_insert/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_update)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_update/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_delete)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_delete/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    connections)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Connections/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    thread_cached)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_cached/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    threads_connected)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_connected/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    thread_created)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_created/ &#123;print $2&#125;'            </span><br><span class="line">       ;;</span><br><span class="line">    Threads_running)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_running/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_immediate)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_immediate/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_waited)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_waited/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    slow_launch_threads)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Slow_launch_threads/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    slow_queries)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Slow_queries/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    qps)</span><br><span class="line">       uptime=`cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1`</span><br><span class="line">       questions=`cat /tmp/mysql_status_monitor.log | awk '/Questions/ &#123;print $2&#125;'`</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;questions&#125;/$&#123;uptime&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    tps)</span><br><span class="line">       uptime=`cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1`</span><br><span class="line">       com_commit=`cat /tmp/mysql_status_monitor.log | awk '/Com_commit/ &#123;print $2&#125;'`</span><br><span class="line">       com_rollback=`cat /tmp/mysql_status_monitor.log | awk '/Com_rollback/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       com_sum=$(($&#123;com_commit&#125;+$&#123;com_rollback&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;com_sum&#125;/$&#123;uptime&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    innodb_buffer_read_hits)</span><br><span class="line">       innodb_buffer_pool_reads=`cat /tmp/mysql_status_monitor.log | awk '/Innodb_buffer_pool_reads/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       innodb_buffer_pool_read_requests=`cat /tmp/mysql_status_monitor.log | awk '/Innodb_buffer_pool_read_requests/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       innodb_buffer_read_diff=$(($&#123;innodb_buffer_pool_read_requests&#125;-$&#123;innodb_buffer_pool_reads&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;innodb_buffer_read_diff&#125;/$&#123;innodb_buffer_pool_read_requests&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    table_cache_hit)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Opened_tables/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    thread_cache_hits)</span><br><span class="line">       thread_created=`cat /tmp/mysql_status_monitor.log | awk '/Threads_created/ &#123;print $2&#125;'`</span><br><span class="line">       connections=`cat /tmp/mysql_status_monitor.log | awk '/Connections/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       thread_cache_diff=$(($&#123;connections&#125;-$&#123;thread_created&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;thread_cache_diff&#125;/$&#123;connections&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    create_tmp_tables_hits)</span><br><span class="line">       created_tmp_tables=`cat /tmp/mysql_status_monitor.log | awk '/Created_tmp_tables/ &#123;print $2&#125;'`</span><br><span class="line">       created_tmp_disk_tables=`cat /tmp/mysql_status_monitor.log | awk '/Created_tmp_disk_tables/ &#123;print $2&#125;'`</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;created_tmp_disk_tables&#125;/$&#123;created_tmp_tables&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    binlog_cache_disk_use)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Binlog_cache_disk_use/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_immediate)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_immediate/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_waited)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_waited/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    innodb_row_lock_waits)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Innodb_row_lock_waits/ &#123;print $2&#125;'</span><br><span class="line">       ;;               </span><br><span class="line">    *)</span><br><span class="line">       ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></p><h3 id="4、编写zabbix监控项文件-通过-usr-local-zabbix-script-mysql-get-data-sh脚本去获取对应监控的数值"><a href="#4、编写zabbix监控项文件-通过-usr-local-zabbix-script-mysql-get-data-sh脚本去获取对应监控的数值" class="headerlink" title="4、编写zabbix监控项文件,通过/usr/local/zabbix/script/mysql_get_data.sh脚本去获取对应监控的数值"></a>4、编写zabbix监控项文件,通过/usr/local/zabbix/script/mysql_get_data.sh脚本去获取对应监控的数值</h3><p>cat /usr/local/zabbix/etc/zabbix_agentd.conf.d/mysql_monitor_parameter.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#集群节点数量</span><br><span class="line">UserParameter=nodecount[*],sh /usr/local/zabbix/script/mysql_get_data.sh nodecount</span><br><span class="line">#系统运行时间</span><br><span class="line">UserParameter=uptime[*],sh /usr/local/zabbix/script/mysql_get_data.sh uptime</span><br><span class="line">#查看select语句的执行数</span><br><span class="line">UserParameter=com_select[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_select</span><br><span class="line">#查看insert语句的执行数</span><br><span class="line">UserParameter=com_insert[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_insert</span><br><span class="line">#查看update语句的执行数</span><br><span class="line">UserParameter=com_update[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_update</span><br><span class="line">#查看delete语句的执行数</span><br><span class="line">UserParameter=com_delete[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_delete</span><br><span class="line">#查看试图连接到MySQL(不管是否连接成功)的连接数</span><br><span class="line">UserParameter=connections[*],sh /usr/local/zabbix/script/mysql_get_data.sh connections</span><br><span class="line">#查看线程缓存内的线程的数量</span><br><span class="line">UserParameter=thread_cached[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_cached</span><br><span class="line">#当线程打开连接数</span><br><span class="line">UserParameter=threads_connected[*],sh /usr/local/zabbix/script/mysql_get_data.sh threads_connected</span><br><span class="line">#查看创建用来处理连接的线程数。如果Threads_created较大，你可能要增加thread_cache_size值</span><br><span class="line">UserParameter=thread_created[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_created</span><br><span class="line">#查看激活的(非睡眠状态)线程数</span><br><span class="line">UserParameter=threads_running[*],sh /usr/local/zabbix/script/mysql_get_data.sh threads_running</span><br><span class="line">#查看创建时间超过slow_launch_time秒的线程数。</span><br><span class="line">UserParameter=slow_launch_threads[*],sh /usr/local/zabbix/script/mysql_get_data.sh slow_launch_threads</span><br><span class="line">#查看查询时间超过long_query_time秒的查询的个数。</span><br><span class="line">UserParameter=slow_queries[*],sh /usr/local/zabbix/script/mysql_get_data.sh slow_queries</span><br><span class="line">#在服务器上执行语句的数量，只包括客户端发送给服务器的语句，并不包括存储项目执行的语句</span><br><span class="line">UserParameter=qps[*],sh /usr/local/zabbix/script/mysql_get_data.sh qps</span><br><span class="line">#事物提交数量com_commit</span><br><span class="line">#事物回滚数量com_rollback</span><br><span class="line">UserParameter=tps[*],sh /usr/local/zabbix/script/mysql_get_data.sh tps</span><br><span class="line">#在buffer pool满足不了逻辑读的请求，而必须直接从硬盘读取的数量innodb_buffer_pool_reads</span><br><span class="line">#逻辑读的请求数innodb_buffer_pool_read_requests</span><br><span class="line">#buffer_read命中率</span><br><span class="line">UserParameter=innodb_buffer_read_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh innodb_buffer_read_hits</span><br><span class="line">#打开表的数量open_tables</span><br><span class="line">#已经打开表的数量opened_tables</span><br><span class="line">#table_cache命中率</span><br><span class="line">UserParameter=table_cache_hit[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_cache_hit</span><br><span class="line">#thread_cache命中率</span><br><span class="line">UserParameter=thread_cache_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_cache_hits</span><br><span class="line">#执行语句过程中创建的临时表created_tmp_tables</span><br><span class="line">#当创建的内部临时表过大，mysql会自动将表从内存中转换为磁盘上的表created_tmp_disk_tables</span><br><span class="line">#在磁盘上创建临时表的比例</span><br><span class="line">UserParameter=create_tmp_tables_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh create_tmp_tables_hits</span><br><span class="line">#事物使用binlog但是临时二进制日志超过binlog_cache_size，使用临时文件存储事物的语句，如果该值不为0，需要调整binlog_cache_size</span><br><span class="line">UserParameter=binlog_cache_disk_use[*],sh /usr/local/zabbix/script/mysql_get_data.sh binlog_cache_disk_use</span><br><span class="line">#可以立即授予表锁请求的次数</span><br><span class="line">UserParameter=table_locks_immediate[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_locks_immediate</span><br><span class="line">#一个表锁的请求不能立即被授予，需要等待的次数,如果该值过高，说明数据库有性能问题，应该优化sql语句，表分区或者读写分离</span><br><span class="line">UserParameter=table_locks_waited[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_locks_waited</span><br><span class="line">#操作innodb表等待行数的次数</span><br><span class="line">UserParameter=innodb_row_lock_waits[*],sh /usr/local/zabbix/script/mysql_get_data.sh innodb_row_lock_waits</span><br></pre></td></tr></table></figure></p><h3 id="5、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数："><a href="#5、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数：" class="headerlink" title="5、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数："></a>5、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span><br></pre></td></tr></table></figure><p>添加完成之后，需要重启zabbix_agent客户端</p><h3 id="6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载"><a href="#6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载" class="headerlink" title="6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载"></a>6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击<a href="https://pan.baidu.com/s/1UiMl8fPY57RKDauV8uvVBg" target="_blank" rel="noopener">下载</a></h3><h3 id="7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件-usr-local-zabbix-script-mysql-get-data-sh："><a href="#7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件-usr-local-zabbix-script-mysql-get-data-sh：" class="headerlink" title="7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件/usr/local/zabbix/script/mysql_get_data.sh："></a>7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件/usr/local/zabbix/script/mysql_get_data.sh：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">qps)</span><br><span class="line">   #uptime=`cat /tmp/mysql_status_monitor.log | awk &apos;/Uptime/ &#123;print $2&#125;&apos; |head -1`</span><br><span class="line">   #questions=`cat /tmp/mysql_status_monitor.log | awk &apos;/Questions/ &#123;print $2&#125;&apos;`</span><br><span class="line">   #echo $(printf &quot;%.2f&quot; `echo &quot;scale=2;$&#123;questions&#125;/$&#123;uptime&#125;&quot;|bc`)</span><br><span class="line">   cat /tmp/mysql_status_monitor.log | awk &apos;/Questions/ &#123;print $2&#125;&apos;</span><br><span class="line">   ;;</span><br><span class="line">tps)</span><br><span class="line">   #uptime=`cat /tmp/mysql_status_monitor.log | awk &apos;/Uptime/ &#123;print $2&#125;&apos; |head -1`</span><br><span class="line">   com_commit=`cat /tmp/mysql_status_monitor.log | awk &apos;/Com_commit/ &#123;print $2&#125;&apos;`</span><br><span class="line">   com_rollback=`cat /tmp/mysql_status_monitor.log | awk &apos;/Com_rollback/ &#123;print $2&#125;&apos;|head -1`</span><br><span class="line">   com_sum=$(($&#123;com_commit&#125;+$&#123;com_rollback&#125;))</span><br><span class="line">   echo $&#123;com_sum&#125;</span><br><span class="line">   #echo $(printf &quot;%.2f&quot; `echo &quot;scale=2;$&#123;com_sum&#125;/$&#123;uptime&#125;&quot;|bc`)</span><br><span class="line">   ;;</span><br></pre></td></tr></table></figure><p>修改zabbix模板监控项，将tps、qps的监控项下添加如下图所示进程：<br><img src="https://i.imgur.com/zKYZfAT.png" alt=""><br>亦可点击此处<a href="https://pan.baidu.com/s/1kVtTuqjmMbxD_eEn8vJdEw" target="_blank" rel="noopener">下载</a>，获取该模板，并导入zabbix。</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 去掉查询结果中带的mysql: [Warning] Using a password on the command line interface can be insecure</title>
      <link href="/2018/08/14/%E5%8E%BB%E6%8E%89%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E4%B8%AD%E5%B8%A6%E7%9A%84mysql%20%5BWarning%5D%20Using%20a%20password%20on%20the%20command%20line%20interface%20can%20be%20insecure/"/>
      <url>/2018/08/14/%E5%8E%BB%E6%8E%89%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E4%B8%AD%E5%B8%A6%E7%9A%84mysql%20%5BWarning%5D%20Using%20a%20password%20on%20the%20command%20line%20interface%20can%20be%20insecure/</url>
      <content type="html"><![CDATA[<h2 id="1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码-输出结果如下："><a href="#1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码-输出结果如下：" class="headerlink" title="1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码,输出结果如下："></a>1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码,输出结果如下：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678 -BNe "<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> performance_schema.replication_group_members <span class="keyword">where</span> MEMBER_STATE=<span class="string">'ONLINE'</span><span class="string">"</span></span><br></pre></td></tr></table></figure><p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">3</span><br></pre></td></tr></table></figure></p><h2 id="2、为了消除结果中的-Warning-信息，只显示查询结果，可使用环境变量存储密码的方法："><a href="#2、为了消除结果中的-Warning-信息，只显示查询结果，可使用环境变量存储密码的方法：" class="headerlink" title="2、为了消除结果中的[Warning]信息，只显示查询结果，可使用环境变量存储密码的方法："></a>2、为了消除结果中的[Warning]信息，只显示查询结果，可使用环境变量存储密码的方法：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export MYSQL_PWD=12345678;mysql -u root -BNe "<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> performance_schema.replication_group_members <span class="keyword">where</span> MEMBER_STATE=<span class="string">'ONLINE'</span><span class="string">"</span></span><br></pre></td></tr></table></figure><p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-innodb buffer pool size调整</title>
      <link href="/2018/08/14/mysql-innodb%20buffer%20pool%20size%E8%B0%83%E6%95%B4/"/>
      <url>/2018/08/14/mysql-innodb%20buffer%20pool%20size%E8%B0%83%E6%95%B4/</url>
      <content type="html"><![CDATA[<h2 id="1、查看当前数据库innodb-buffer-pool参数"><a href="#1、查看当前数据库innodb-buffer-pool参数" class="headerlink" title="1、查看当前数据库innodb_buffer_pool参数"></a>1、查看当前数据库innodb_buffer_pool参数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_buffer_pool_size'</span>;</span><br></pre></td></tr></table></figure><p>##2、查看page_size大小<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_page_size'</span>;</span><br></pre></td></tr></table></figure></p><p>官方文档参数详解<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_page_size</span></span><br><span class="line"><span class="string">InnoDB</span> <span class="string">page</span> <span class="string">size</span> <span class="string">(default</span> <span class="number">16</span><span class="string">KB).</span> <span class="string">Many</span> <span class="string">values</span> <span class="string">are</span> <span class="string">counted</span> <span class="string">in</span> <span class="string">pages;</span> <span class="string">the</span> <span class="string">page</span> <span class="string">size</span> <span class="string">enables</span> <span class="string">them</span> <span class="string">to</span> <span class="string">be</span></span><br><span class="line"><span class="string">easily</span> <span class="string">converted</span> <span class="string">to</span> <span class="string">bytes</span></span><br></pre></td></tr></table></figure></p><h2 id="3、查看当前内存innodb页的总数量和包含数据的页的数量"><a href="#3、查看当前内存innodb页的总数量和包含数据的页的数量" class="headerlink" title="3、查看当前内存innodb页的总数量和包含数据的页的数量"></a>3、查看当前内存innodb页的总数量和包含数据的页的数量</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_data'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_total'</span>;</span><br></pre></td></tr></table></figure><p>官方文档参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_buffer_pool_pages_data</span></span><br><span class="line"><span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pages</span> <span class="string">in</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool</span> <span class="string">containing</span> <span class="string">data.</span> <span class="string">The</span> <span class="string">number</span> <span class="string">includes</span> <span class="string">both</span> <span class="string">dirty</span> <span class="string">and</span></span><br><span class="line"><span class="string">clean</span> <span class="string">pages.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Innodb_buffer_pool_pages_total</span></span><br><span class="line"><span class="string">The</span> <span class="string">total</span> <span class="string">size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool,</span> <span class="string">in</span> <span class="string">pages.</span></span><br></pre></td></tr></table></figure></p><h2 id="4、调优参考计算方法："><a href="#4、调优参考计算方法：" class="headerlink" title="4、调优参考计算方法："></a>4、调优参考计算方法：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val = Innodb_buffer_pool_pages_data / Innodb_buffer_pool_pages_total * 100%</span><br><span class="line">val &gt; 95% 则考虑增大 innodb_buffer_pool_size， 建议使用物理内存的75%</span><br><span class="line">val &lt; 95% 则考虑减小 innodb_buffer_pool_size， 建议设置为：Innodb_buffer_pool_pages_data * Innodb_page_size * 1.05 / (1024*1024*1024)</span><br></pre></td></tr></table></figure><h2 id="5、设置innodb-buffer-pool-siz大小"><a href="#5、设置innodb-buffer-pool-siz大小" class="headerlink" title="5、设置innodb_buffer_pool_siz大小"></a>5、设置innodb_buffer_pool_siz大小</h2><p>设置命令：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> innodb_buffer_pool_size = <span class="number">17179869184</span>;</span><br></pre></td></tr></table></figure></p><p>缓冲池字节大小，单位kb，如果不设置，默认为128M<br>5.7版本以后可以动态修改参数，但是也要修改配置文件参数，防止重启之后，参数又变成配置文件内的参数,5.7以下的版本为静态参数，需要修改配置文件，并重新启动mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/my.cnf</span><br><span class="line">---------</span><br><span class="line">innodb_buffer_pool_size = 17179869184  #设置16G</span><br><span class="line">---------</span><br></pre></td></tr></table></figure></p><h2 id="6、配置参数也可使用M、G等参数，内容如下："><a href="#6、配置参数也可使用M、G等参数，内容如下：" class="headerlink" title="6、配置参数也可使用M、G等参数，内容如下："></a>6、配置参数也可使用M、G等参数，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf：</span><br><span class="line">-------------------</span><br><span class="line">innodb_buffer_pool_size = 16G  #设置16G</span><br><span class="line">innodb_buffer_pool_size = 500M  #设置500M</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb4.0定时备份并邮件告知备份情况</title>
      <link href="/2018/08/12/mongodb4.0%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%B9%B6%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/"/>
      <url>/2018/08/12/mongodb4.0%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%B9%B6%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/</url>
      <content type="html"><![CDATA[<h2 id="1、mongodb全量备份脚本，内容如下："><a href="#1、mongodb全量备份脚本，内容如下：" class="headerlink" title="1、mongodb全量备份脚本，内容如下："></a>1、mongodb全量备份脚本，内容如下：</h2><p>cat /data/soft/mongodb_backup.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#认证用户名</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#认证用户对应密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#备份的服务器地址</span></span><br><span class="line"><span class="string">servername=testrepl/127.0.0.1:30000</span></span><br><span class="line"><span class="comment">#备份的数据库实例名称</span></span><br><span class="line"><span class="string">instancename=test</span></span><br><span class="line"><span class="comment">#认证数据库实例名称</span></span><br><span class="line"><span class="string">authdbname=admin</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line"><span class="string">stamp=`date</span> <span class="string">+"%Y-%m-%d"`</span></span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line"><span class="string">programname=bulingbuling</span></span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line"><span class="string">backuppath=/data/backup</span></span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line"><span class="string">backname=$&#123;backuppath&#125;/$&#123;instancename&#125;</span></span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line"><span class="string">oldstamp=`date</span> <span class="string">+"%Y-%m-%d"</span> <span class="bullet">-d</span> <span class="string">"-5 day"</span><span class="string">`</span></span><br><span class="line"><span class="string">oldbackname=$&#123;backname&#125;-$&#123;oldstamp&#125;.dump</span></span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line"><span class="string">backuplogname=/tmp/mongodb_bakcup_$&#123;stamp&#125;.log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line"><span class="string">localname=`hostname`</span></span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line"><span class="string">localip=`ip</span> <span class="string">a</span> <span class="string">|grep</span> <span class="string">global|</span> <span class="string">head</span> <span class="bullet">-1</span><span class="string">| awk '&#123;print $2&#125;'|awk -F'/' '&#123;print $1&#125;'`</span></span><br><span class="line"><span class="string">#localip='65.52.165.104'</span></span><br><span class="line"><span class="string">#目标邮箱</span></span><br><span class="line"><span class="string">dest_mail='test@qq.com'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="string">if [ -e $&#123;backuplogname&#125; ];then</span></span><br><span class="line"><span class="string">   sudo rm -rf $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">   :</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="string">send_fail_mail()&#123;</span></span><br><span class="line"><span class="string">echo "$&#123;programname&#125;备份失败,登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看报错！！！" |mail -s $&#123;programname&#125;数据库备份情况 $&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="string">send_success_mail()&#123;</span></span><br><span class="line"><span class="string">echo "$&#123;programname&#125;备份成功,可登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看备份信息。" |mail -s $&#123;programname&#125;数据库备份情况 $&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建备份时间函数</span></span><br><span class="line"><span class="string">date_func()&#123;</span></span><br><span class="line"><span class="string">   dateresult=$(($&#123;afterstamp&#125;-$&#123;beforstamp&#125;))</span></span><br><span class="line"><span class="string">   hour=$(($&#123;dateresult&#125;/3600))</span></span><br><span class="line"><span class="string">   min=$((($&#123;dateresult&#125;-$&#123;hour&#125;*3600)/60))</span></span><br><span class="line"><span class="string">   sec=$(($&#123;dateresult&#125;-$&#123;hour&#125;*3600-$&#123;min&#125;*60))</span></span><br><span class="line"><span class="string">   echo "6、本次备份运行时间为:"$&#123;hour&#125;时$&#123;min&#125;分$&#123;sec&#125;秒 &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="string">del_old_bakdata()&#123;</span></span><br><span class="line"><span class="string">   if [ -e $&#123;oldbackname&#125; ];then</span></span><br><span class="line"><span class="string">    sudo echo "7、五天前的备份数据$&#123;oldbackname&#125;存在，进行删除"  &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    rm -rf $&#123;oldbackname&#125;</span></span><br><span class="line"><span class="string">    if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    sudo echo "7.1、备份数据删除成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">    sudo echo "7.1、备份数据删除失败，注意查看失败原因" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">   else</span></span><br><span class="line"><span class="string">     sudo echo "7、五天前的备份数据$&#123;oldbackname&#125;不存在，不需要再删除。" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   fi </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#因为mongodbdump只能指定路径，不能自定义备份文件名称，因此需要对备份完成的目录重命名</span></span><br><span class="line"><span class="string">rename_backname_func()&#123;</span></span><br><span class="line"><span class="string">if [ -e $&#123;backname&#125;-$&#123;stamp&#125; ];then</span></span><br><span class="line"><span class="string">  mv $&#123;backname&#125;-$&#123;stamp&#125; $&#123;backname&#125;-$&#123;stamp&#125;-old</span></span><br><span class="line"><span class="string">  mv $&#123;backname&#125; $&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line"><span class="string">  if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名失败,查看命名失败原因！" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">  mv $&#123;backname&#125; $&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line"><span class="string">  if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    echo "5、备份目录重命名失败,查看命名失败原因！" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="string">if [ -d $&#123;backuppath&#125; ];then</span></span><br><span class="line"><span class="string">sudo echo "1、备份目录存在,可执行备份操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">sudo echo "1、备份目录不存在,手动创建" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">sudo mkdir -p $&#123;backuppath&#125;</span></span><br><span class="line"><span class="string">if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">   sudo echo "1.1、备份目录创建成功，可进行下面操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">   sudo echo "1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   exit</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="string">if [ -d $&#123;backname&#125; ];then</span></span><br><span class="line"><span class="string">sudo echo "2、指定的备份实例目录$&#123;backname&#125;已存在，对其进行重命名" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    mv $&#123;backname&#125; $&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump</span></span><br><span class="line"><span class="string">    if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    sudo echo "2.1、文件已重新命名为$&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump,可继续备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">    sudo echo "2.1、文件重命名失败，退出备份操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    exit</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">sudo echo "2、指定的备份文件不存在，开始进行备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前时间戳</span></span><br><span class="line"><span class="string">beforstamp=`date +%s`</span></span><br><span class="line"><span class="string">#开始全量备份数据库</span></span><br><span class="line"><span class="string">sudo echo "3、开始全量备份数据库" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongodump -h $&#123;servername&#125; -u $&#123;authuser&#125; -p $&#123;authpass&#125; -d $&#123;instancename&#125; -o $&#123;backuppath&#125; --authenticationDatabase $&#123;authdbname&#125;</span></span><br><span class="line"><span class="string">backupresult=$?</span></span><br><span class="line"><span class="string">afterstamp=`date +%s`</span></span><br><span class="line"><span class="string">if [ $&#123;backupresult&#125; == 0 ];then</span></span><br><span class="line"><span class="string">    sudo echo "4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份成功,文件名称为$&#123;backname&#125;，重命名备份文件" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    rename_backname_func</span></span><br><span class="line"><span class="string">    date_func</span></span><br><span class="line"><span class="string">        del_old_bakdata</span></span><br><span class="line"><span class="string">        send_success_mail</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">    sudo echo "4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份失败,注意查看备份失败原因并重新备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    send_fail_mail</span></span><br><span class="line"><span class="string">    exit</span></span><br><span class="line"><span class="string">fi</span></span><br></pre></td></tr></table></figure></p><p>使用该脚本需要修改自己数据库对应的用户名authuser,密码authpass,邮箱dest_mail,项目名称programname,服务器名称servername,数据库实例名称instancename,mongodb数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改</p><h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure></p><p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure></p><p>参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">from:</span><span class="string">指定发送邮件的发件人</span></span><br><span class="line"><span class="attr">smtp:</span><span class="string">指定smtp服务器信息</span></span><br><span class="line"><span class="attr">smtp-auth-user:</span><span class="string">允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure></p><p>2.3、发送测试邮件：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="bullet">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure></p><p>title:指定发送文件的标题，可自行定义</p><h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure><h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb4.0备份与恢复</title>
      <link href="/2018/08/12/mongdob4.0%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
      <url>/2018/08/12/mongdob4.0%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<h2 id="1、mongodb备份命令"><a href="#1、mongodb备份命令" class="headerlink" title="1、mongodb备份命令"></a>1、mongodb备份命令</h2><p>1.1、备份之前查看备份实例的相关数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.auth(&apos;admin1&apos;,&apos;admin123&apos;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use test;</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure></p><p>1.2、对于replica set集群模式命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongodump -h <span class="string">"testrepl/127.0.0.1:30000"</span> -u admin1 -p admin123 -d <span class="built_in">test</span> -o /data/backup/ --authenticationDatabase admin</span><br></pre></td></tr></table></figure></p><p>结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-12</span><span class="attr">T03:40:01.489+0000</span>    <span class="string">writing</span> <span class="string">test.test_collection</span> <span class="string">to</span> </span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-12</span><span class="attr">T03:40:03.823+0000</span>    <span class="string">done</span> <span class="string">dumping</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br></pre></td></tr></table></figure></p><p>会在指定的备份目录下，生成备份实例名对应的文件夹，文件夹下有以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_collection.bson  test_collection.metadata.json</span><br></pre></td></tr></table></figure></p><p>命令参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-h:</span><span class="string">指定当前备份主机ip</span></span><br><span class="line"><span class="attr">--port:</span><span class="string">指定当前mongodb的启动端口</span></span><br><span class="line"><span class="attr">-u:</span><span class="string">指定验证的用户名</span></span><br><span class="line"><span class="attr">-d:</span><span class="string">需要备份的数据库实例</span></span><br><span class="line"><span class="attr">-p:</span><span class="string">指定用户名对应的密码</span></span><br><span class="line"><span class="attr">-o:</span><span class="string">指定备份的路径</span></span><br><span class="line"><span class="attr">--authenticationDatabase:</span><span class="string">认证数据库</span></span><br></pre></td></tr></table></figure></p><p>备份过程没有加上指定认证数据库“–authenticationDatabase admin”,会报一下错误<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Failed:</span> <span class="string">error</span> <span class="string">connecting</span> <span class="string">to</span> <span class="string">db</span> <span class="attr">server:</span> <span class="string">server</span> <span class="string">returned</span> <span class="string">error</span> <span class="string">on</span> <span class="string">SASL</span> <span class="string">authentication</span> <span class="attr">step:</span> <span class="string">Authentication</span> <span class="string">failed.</span></span><br></pre></td></tr></table></figure></p><p>1.3、对于单节点备份命令如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/data/mongodb/bin/mongodump</span> <span class="bullet">-h</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="bullet">--port</span> <span class="number">30000</span> <span class="bullet">-u</span> <span class="string">admin1</span> <span class="bullet">-p</span> <span class="string">admin123</span> <span class="bullet">-d</span> <span class="string">test</span> <span class="bullet">-o</span> <span class="string">/data/backup</span> <span class="bullet">--authenticationDatabase</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure></p><h2 id="2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-："><a href="#2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-：" class="headerlink" title="2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)："></a>2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongorestore -h 10.0.7.36 --port 30000  -u admin1 -p admin123 -d <span class="built_in">test</span>  /data/backup/<span class="built_in">test</span> --authenticationDatabase admin</span><br></pre></td></tr></table></figure><p>恢复输出结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.860+0000</span>    <span class="string">the</span> <span class="bullet">--db</span> <span class="string">and</span> <span class="bullet">--collection</span> <span class="string">args</span> <span class="string">should</span> <span class="string">only</span> <span class="string">be</span> <span class="string">used</span> <span class="string">when</span> <span class="string">restoring</span> <span class="string">from</span> <span class="string">a</span> <span class="string">BSON</span> <span class="string">file.</span> <span class="string">Other</span> <span class="string">uses</span> <span class="string">are</span> <span class="string">deprecated</span> <span class="string">and</span> <span class="string">will</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">in</span> <span class="string">the</span> <span class="string">future;</span> <span class="string">use</span> <span class="bullet">--nsInclude</span> <span class="string">instead</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.860+0000</span>    <span class="string">building</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">collections</span> <span class="string">to</span> <span class="string">restore</span> <span class="string">from</span> <span class="string">/data/backup/test</span> <span class="string">dir</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.885+0000</span>    <span class="string">reading</span> <span class="string">metadata</span> <span class="string">for</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.metadata.json</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.972+0000</span>    <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.bson</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:51.781+0000</span>    <span class="string">[###########.............]</span>  <span class="string">test.test_collection</span>  <span class="number">28.4</span><span class="string">MB/57.1MB</span>  <span class="string">(49.8%)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:54.490+0000</span>    <span class="string">[########################]</span>  <span class="string">test.test_collection</span>  <span class="number">57.1</span><span class="string">MB/57.1MB</span>  <span class="string">(100.0%)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:54.490+0000</span>    <span class="string">restoring</span> <span class="string">indexes</span> <span class="string">for</span> <span class="string">collection</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">metadata</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:57.737+0000</span>    <span class="string">finished</span> <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:57.737+0000</span>    <span class="string">done</span></span><br></pre></td></tr></table></figure></p><p>控制台登录，查看数据是否一致：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise &gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise &gt; db.auth(&apos;admin1&apos;,&apos;admin123&apos;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise &gt; show dbs;</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">test    0.031GB</span><br><span class="line">MongoDB Enterprise &gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise &gt; show tables;</span><br><span class="line">test_collection</span><br><span class="line">MongoDB Enterprise &gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure></p><p>恢复完成</p>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] 使用innodb trx和innodb lock信息表查看锁事物</title>
      <link href="/2018/08/11/%E4%BD%BF%E7%94%A8innodb%20trx%E5%92%8Cinnodb%20lock%E4%BF%A1%E6%81%AF%E8%A1%A8%E6%9F%A5%E7%9C%8B%E9%94%81%E4%BA%8B%E7%89%A9/"/>
      <url>/2018/08/11/%E4%BD%BF%E7%94%A8innodb%20trx%E5%92%8Cinnodb%20lock%E4%BF%A1%E6%81%AF%E8%A1%A8%E6%9F%A5%E7%9C%8B%E9%94%81%E4%BA%8B%E7%89%A9/</url>
      <content type="html"><![CDATA[<h2 id="1、插入表测试数据"><a href="#1、插入表测试数据" class="headerlink" title="1、插入表测试数据"></a>1、插入表测试数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> aaa;</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br></pre></td></tr></table></figure><h2 id="2、创建三个会话，造成锁事物"><a href="#2、创建三个会话，造成锁事物" class="headerlink" title="2、创建三个会话，造成锁事物"></a>2、创建三个会话，造成锁事物</h2><p>sessin 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">60</span>);</span><br></pre></td></tr></table></figure></p><p>session 2:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></p><p>sesion 3:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></p><h2 id="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："><a href="#3、使用以下查询来查看正在等待的事务以及阻止它们的事务：" class="headerlink" title="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："></a>3、使用以下查询来查看正在等待的事务以及阻止它们的事务：</h2><p>session 4<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  r.trx_id waiting_trx_id,</span><br><span class="line">  r.trx_mysql_thread_id waiting_thread,</span><br><span class="line">  r.trx_query waiting_query,</span><br><span class="line">  b.trx_id blocking_trx_id,</span><br><span class="line">  b.trx_mysql_thread_id blocking_thread,</span><br><span class="line">  b.trx_query blocking_query</span><br><span class="line"><span class="keyword">FROM</span>       information_schema.innodb_lock_waits w</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx b</span><br><span class="line">  <span class="keyword">ON</span> b.trx_id = w.blocking_trx_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx r</span><br><span class="line">  <span class="keyword">ON</span> r.trx_id = w.requesting_trx_id;</span><br><span class="line">查询结果如下：</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| waiting_trx_id | waiting_thread | waiting_query                        | blocking_trx_id | blocking_thread | blocking_query                  |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| 2488           |             58 | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2487</span>            |              <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">| <span class="number">2488</span>           |             <span class="number">58</span> | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">| <span class="number">2487</span>           |             <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>      | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br></pre></td></tr></table></figure></p><p>上述sql语句可能太繁琐，也可使用下面语句查询<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  waiting_trx_id,</span><br><span class="line">  waiting_pid,</span><br><span class="line">  waiting_query,</span><br><span class="line">  blocking_trx_id,</span><br><span class="line">  blocking_pid,</span><br><span class="line">  blocking_query</span><br><span class="line"><span class="keyword">FROM</span> sys.innodb_lock_waits;</span><br></pre></td></tr></table></figure></p><h2 id="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物"><a href="#4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物" class="headerlink" title="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物"></a>4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br><span class="line">| 57 | root        | localhost | aaaa | Sleep   |    566 |                                                        | NULL                  |</span><br></pre></td></tr></table></figure><p>查询出process_id为57</p><h2 id="5、通过processlist-id查询出thread-id"><a href="#5、通过processlist-id查询出thread-id" class="headerlink" title="5、通过processlist_id查询出thread_id"></a>5、通过processlist_id查询出thread_id</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID <span class="keyword">FROM</span> performance_schema.threads <span class="keyword">WHERE</span> PROCESSLIST_ID = <span class="number">57</span>;</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| THREAD_ID |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">|        79 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></table></figure><h2 id="6、根据thread-id查询出来造成锁事物的sql语句"><a href="#6、根据thread-id查询出来造成锁事物的sql语句" class="headerlink" title="6、根据thread_id查询出来造成锁事物的sql语句"></a>6、根据thread_id查询出来造成锁事物的sql语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_current </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">THREAD_ID: <span class="number">79</span></span><br><span class="line"> SQL_TEXT: <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。"><a href="#7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。" class="headerlink" title="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。"></a>7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_history </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> EVENT_ID;</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">| THREAD_ID | SQL_TEXT                        |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">|        79 | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</title>
      <link href="/2018/08/11/mysql-%20Lock%20wait%20timeout%20exceeded;%20try%20restarting%20transaction/"/>
      <url>/2018/08/11/mysql-%20Lock%20wait%20timeout%20exceeded;%20try%20restarting%20transaction/</url>
      <content type="html"><![CDATA[<h2 id="1、对一个表进行ddl操作"><a href="#1、对一个表进行ddl操作" class="headerlink" title="1、对一个表进行ddl操作"></a>1、对一个表进行ddl操作</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql&gt;ALTER</span> <span class="string">TABLE</span> <span class="string">deposit_coin_order_user</span> <span class="string">add</span> <span class="string">`txid`</span>  <span class="string">varchar(128)</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">COLLATE</span> <span class="string">utf8mb4_general_ci</span> <span class="string">NOT</span> <span class="literal">NULL</span> <span class="string">COMMENT</span> <span class="string">'区块链id'</span> <span class="string">;</span></span><br><span class="line"><span class="string">提示报错：</span></span><br><span class="line"><span class="string">ERROR</span> <span class="number">1205</span> <span class="string">(HY000):</span> <span class="string">Lock</span> <span class="string">wait</span> <span class="string">timeout</span> <span class="string">exceeded;</span> <span class="string">try</span> <span class="string">restarting</span> <span class="string">transaction</span></span><br></pre></td></tr></table></figure><p>查看该表数据只有39行数据：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">select</span> <span class="string">count(*)</span> <span class="string">from</span> <span class="string">deposit_coin_order_user;</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">| count(*) |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|       39 |</span></span><br><span class="line"><span class="string">+----------+</span></span><br></pre></td></tr></table></figure></p><h2 id="2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’"><a href="#2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’" class="headerlink" title="2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’"></a>2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">SELECT</span> <span class="string">*</span> <span class="string">FROM</span> <span class="string">information_schema.INNODB_TRX\G</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line"><span class="attr">                    trx_id:</span> <span class="number">421462261342800</span></span><br><span class="line"><span class="attr">                 trx_state:</span> <span class="string">RUNNING</span></span><br><span class="line"><span class="attr">               trx_started:</span> <span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-10</span> <span class="number">08</span><span class="string">:24:58</span></span><br><span class="line"><span class="attr">     trx_requested_lock_id:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">          trx_wait_started:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">                trx_weight:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">       trx_mysql_thread_id:</span> <span class="number">12989053</span></span><br><span class="line"><span class="attr">                 trx_query:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">       trx_operation_state:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">         trx_tables_in_use:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">         trx_tables_locked:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          trx_lock_structs:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">     trx_lock_memory_bytes:</span> <span class="number">1136</span></span><br><span class="line"><span class="attr">           trx_rows_locked:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">         trx_rows_modified:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">   trx_concurrency_tickets:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">       trx_isolation_level:</span> <span class="string">REPEATABLE</span> <span class="string">READ</span></span><br><span class="line"><span class="attr">         trx_unique_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    trx_foreign_key_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">trx_last_foreign_key_error:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr"> trx_adaptive_hash_latched:</span> <span class="number">0</span></span><br><span class="line"><span class="attr"> trx_adaptive_hash_timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          trx_is_read_only:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">trx_autocommit_non_locking:</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure><p>使用show full processlist查看是否有‘trx_mysql_thread_id’对应的进程，如果有就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。没有的话看看有没有正在执行的很慢SQL记录线程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show full processlist;</span><br><span class="line">| 12989053 | cwreadonly                        | 10.1.10.9:51650  | exchange_market | Sleep            |   1189 |                                                               | NULL</span><br></pre></td></tr></table></figure></p><h2 id="3、发现有id为12989053的sql，需要手动kill掉"><a href="#3、发现有id为12989053的sql，需要手动kill掉" class="headerlink" title="3、发现有id为12989053的sql，需要手动kill掉"></a>3、发现有id为12989053的sql，需要手动kill掉</h2><p>mysql &gt; KILL 12989053;</p><h2 id="4、再次执行ddl语句，正常执行"><a href="#4、再次执行ddl语句，正常执行" class="headerlink" title="4、再次执行ddl语句，正常执行"></a>4、再次执行ddl语句，正常执行</h2><p>ALTER TABLE deposit_coin_order_user add <code>txid</code>  varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT ‘区块链id’ ;</p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql定时备份及邮件告知备份情况</title>
      <link href="/2018/08/10/mysql%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%8F%8A%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/"/>
      <url>/2018/08/10/mysql%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD%E5%8F%8A%E9%82%AE%E4%BB%B6%E5%91%8A%E7%9F%A5%E5%A4%87%E4%BB%BD%E6%83%85%E5%86%B5/</url>
      <content type="html"><![CDATA[<h2 id="1、mysql全量备份脚本，内容如下："><a href="#1、mysql全量备份脚本，内容如下：" class="headerlink" title="1、mysql全量备份脚本，内容如下："></a>1、mysql全量备份脚本，内容如下：</h2><p>cat /data/soft/mysql_backup.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#数据库用户名</span></span><br><span class="line">dbuser=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#数据库密码</span></span><br><span class="line">dbpass=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line">stamp=`date +<span class="string">"%Y-%m-%d"</span>`</span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line">programname=mw</span><br><span class="line"><span class="comment">#备份文件名称前缀</span></span><br><span class="line">fullbackupname=<span class="variable">$&#123;programname&#125;</span>-dbfullbak</span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line">backuppath=/data/backup</span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line">backname=<span class="variable">$backuppath</span>/<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump</span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line">oldstamp=`date +<span class="string">"%Y-%m-%d"</span> -d <span class="string">"-5 day"</span>`</span><br><span class="line">oldbackname=<span class="variable">$backuppath</span>/<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;oldstamp&#125;</span>.dump</span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line">dbpath=/data/mysql/bin</span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line">backuplogname=/tmp/backup_<span class="variable">$&#123;stamp&#125;</span>.<span class="built_in">log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line">localname=`hostname`</span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line">localip=`ip a |grep global| head -1| awk <span class="string">'&#123;print $2&#125;'</span>|awk -F<span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="comment">#localip='65.52.165.104'</span></span><br><span class="line"><span class="comment">#目标邮箱</span></span><br><span class="line">dest_mail=<span class="string">'test@qq.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;backuplogname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">   sudo rm -rf <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   :</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="function"><span class="title">send_fail_mail</span></span>()&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;programname&#125;</span>备份失败,登录服务器<span class="variable">$&#123;localname&#125;</span>-<span class="variable">$&#123;localip&#125;</span>的日志<span class="variable">$&#123;backuplogname&#125;</span>下查看报错！！！"</span> |mail -s <span class="variable">$&#123;programname&#125;</span>数据库备份情况 <span class="variable">$&#123;dest_mail&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="function"><span class="title">send_success_mail</span></span>()&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;programname&#125;</span>备份成功,可登录服务器<span class="variable">$&#123;localname&#125;</span>-<span class="variable">$&#123;localip&#125;</span>的日志<span class="variable">$&#123;backuplogname&#125;</span>下查看备份信息。"</span> |mail -s <span class="variable">$&#123;programname&#125;</span>数据库备份情况 <span class="variable">$&#123;dest_mail&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建备份时间函数</span></span><br><span class="line"><span class="function"><span class="title">date_func</span></span>()&#123;</span><br><span class="line">   dateresult=$((<span class="variable">$&#123;afterstamp&#125;</span>-<span class="variable">$&#123;beforstamp&#125;</span>))</span><br><span class="line">   hour=$((<span class="variable">$&#123;dateresult&#125;</span>/3600))</span><br><span class="line">   min=$(((<span class="variable">$&#123;dateresult&#125;</span>-<span class="variable">$&#123;hour&#125;</span>*3600)/60))</span><br><span class="line">   sec=$((<span class="variable">$&#123;dateresult&#125;</span>-<span class="variable">$&#123;hour&#125;</span>*3600-<span class="variable">$&#123;min&#125;</span>*60))</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"5、本次备份运行时间为:"</span><span class="variable">$&#123;hour&#125;</span>时<span class="variable">$&#123;min&#125;</span>分<span class="variable">$&#123;sec&#125;</span>秒 &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="function"><span class="title">del_old_bakdata</span></span>()&#123;</span><br><span class="line">   <span class="keyword">if</span> [ -e <span class="variable">$&#123;oldbackname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"6、五天前的备份数据<span class="variable">$&#123;oldbackname&#125;</span>存在，进行删除"</span>  &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    rm -rf <span class="variable">$&#123;oldbackname&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"6.1、备份数据删除成功"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"6.1、备份数据删除失败，注意查看失败原因"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     sudo <span class="built_in">echo</span> <span class="string">"6、五天前的备份数据<span class="variable">$&#123;oldbackname&#125;</span>不存在，不需要再删除。"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   <span class="keyword">fi</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$&#123;backuppath&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"1、备份目录存在,可执行备份操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"1、备份目录不存在,手动创建"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">sudo mkdir -p <span class="variable">$&#123;backuppath&#125;</span></span><br><span class="line"><span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">   sudo <span class="built_in">echo</span> <span class="string">"1.1、备份目录创建成功，可进行下面操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   sudo <span class="built_in">echo</span> <span class="string">"1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;backname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"2、指定的备份文件<span class="variable">$&#123;backname&#125;</span>已存在，对其进行重命名"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    mv <span class="variable">$&#123;backname&#125;</span> <span class="variable">$&#123;backuppath&#125;</span>/bak-<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump</span><br><span class="line">    <span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"2.1、文件已重新命名为<span class="variable">$&#123;backuppath&#125;</span>/bak-<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump,可继续备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"2.1、文件重命名失败，退出备份操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"2、指定的备份文件不存在，开始进行备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前时间戳</span></span><br><span class="line">beforstamp=`date +%s`</span><br><span class="line"><span class="comment">#开始全量备份数据库</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"3、开始全量备份数据库"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="variable">$&#123;dbpath&#125;</span>/mysqldump -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> --all-databases  --single-transaction --master-data=2 --quick --<span class="built_in">set</span>-gtid-purged=OFF &gt; <span class="variable">$&#123;backname&#125;</span></span><br><span class="line">backupresult=$?</span><br><span class="line">afterstamp=`date +%s`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;backupresult&#125;</span> == 0 ];<span class="keyword">then</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"4、<span class="variable">$&#123;programname&#125;</span>数据库备份成功,文件名称为<span class="variable">$&#123;backname&#125;</span>，准备删除五天前的备份数据"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    date_func</span><br><span class="line">        del_old_bakdata</span><br><span class="line">        send_success_mail</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    sudo <span class="built_in">echo</span> <span class="string">"4、<span class="variable">$&#123;programname&#125;</span>数据库备份失败,注意查看备份失败原因并重新备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    send_fail_mail</span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><p>使用该脚本需要修改自己数据库对应的用户名dbuser,密码dbpass,邮箱dest_mail,项目名称programname,mysql数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改<br>其中–single-transaction：该参数在备份前将隔离模式设为repeatable read并启动start transaction语句。该参数只对innodb事物表有作用，当启动start transaction时开始备份数据库一致性状态，并不阻塞其他的应用。对于myisam和memory数据引擎使用这个参数备份的时候状态是实时改变的。另外该参数与–lock-tables参数是相互排斥的，lock-tables会是隐式吧提交的事物产生等待。<br>–master-data=2：使用该参数指备份执行时binglog开始的坐标，在输出结果中属于change master to语句，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-binlog.000036&apos;, MASTER_LOG_POS=79549;</span><br></pre></td></tr></table></figure></p><p>如果使用该参数不指定值，默认值为1，语句不会以注释的形式写入，当dump文件被加载时该行参数会影响加载过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-binlog.000036&apos;, MASTER_LOG_POS=79549;</span><br></pre></td></tr></table></figure></p><p>如果指定参数为2，会以注释的形式写入输出文件，dump文件被加载也不会受该行语句影响。</p><p>–quick：对于备份大表比较有用，该参数强制mysqldump命令一次性从数据库中获取表的行，而不是先获取行集合，在写出之前把他们缓存到内存。</p><h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure></p><p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure></p><p>参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">from:</span><span class="string">指定发送邮件的发件人</span></span><br><span class="line"><span class="attr">smtp:</span><span class="string">指定smtp服务器信息</span></span><br><span class="line"><span class="attr">smtp-auth-user:</span><span class="string">允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure></p><p>2.3、发送测试邮件：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="bullet">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure></p><p>title:指定发送文件的标题，可自行定义</p><h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mysql_backup.sh</span><br></pre></td></tr></table></figure><h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mysql_backup.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysqldump逻辑备份及恢复</title>
      <link href="/2018/08/09/mysqldump%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%8F%8A%E6%81%A2%E5%A4%8D/"/>
      <url>/2018/08/09/mysqldump%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%8F%8A%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<h2 id="0、mysql实验版本"><a href="#0、mysql实验版本" class="headerlink" title="0、mysql实验版本"></a>0、mysql实验版本</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.7</span><span class="number">.22</span><span class="bullet">-log</span></span><br></pre></td></tr></table></figure><h2 id="1、mysqldump备份操作详解："><a href="#1、mysqldump备份操作详解：" class="headerlink" title="1、mysqldump备份操作详解："></a>1、mysqldump备份操作详解：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-d --no-data No row information 只导出数据结构</span><br><span class="line">-t --no-create-info 只导出数据（不包含结构）</span><br><span class="line">1）导出所有数据库</span><br><span class="line">mysqldump -u root -p --all-databases &gt; all_db.dump</span><br><span class="line">2）导出指定数据库</span><br><span class="line">mysqldump -u root -p zabbixDB &gt; zabbix.dump</span><br><span class="line">3) 导出多个数据库</span><br><span class="line">mysqldump -u root -p --databases zabbixDB mysql &gt; zabbix_mysql.dump</span><br><span class="line">4）导出一个表</span><br><span class="line">mysqldump -u root -p zabbixDB task &gt;  zabbixDB_task.dump</span><br><span class="line">5)导出一个数据库的多个表</span><br><span class="line">mysqldump -u root -p --databases zabbixDB --tables trends users &gt; zabbix_trends_users.dump</span><br><span class="line">6)条件导出----导出db1表a1中id=1的数据</span><br><span class="line">mysqldump -uroot -p --databases db1 --tables a1 --where=&apos;id=1&apos; &gt; db1_a1_id.dump</span><br><span class="line">7)将h1服务器中的db1数据库的所有数据导入到h2中的db2数据库中，db2的数据库必须存在否则会报错</span><br><span class="line">mysqldump --host=h1 -uroot -proot --databases db1 |mysql --host=h2 -uroot -proot db2</span><br><span class="line">8)压缩备份</span><br><span class="line">mysqldump -uroot -p --databases zabbixDB 2&gt;/dev/null |gzip &gt; zabbixDB.gz</span><br></pre></td></tr></table></figure><p>##开始实验</p><h2 id="2、源库插入测试数据"><a href="#2、源库插入测试数据" class="headerlink" title="2、源库插入测试数据"></a>2、源库插入测试数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create database aaaa;</span><br><span class="line">use aaaa;</span><br><span class="line">create table aa (id int primary key);</span><br><span class="line">insert into aa values(&apos;1&apos;);</span><br></pre></td></tr></table></figure><h2 id="3、导出备份"><a href="#3、导出备份" class="headerlink" title="3、导出备份"></a>3、导出备份</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u root -p --all-databases --<span class="built_in">set</span>-gtid-purged=OFF  &gt; /tmp/test.dump</span><br></pre></td></tr></table></figure><h2 id="4、在目标数据库进行还原，全库导入"><a href="#4、在目标数据库进行还原，全库导入" class="headerlink" title="4、在目标数据库进行还原，全库导入"></a>4、在目标数据库进行还原，全库导入</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678 &lt; test.dump</span><br></pre></td></tr></table></figure><p>因为mysqldump属于逻辑备份，恢复步骤为先检查要恢复的database是否存在，如果不存在就手动创建，如果存在就进入database去检查表是否存在，如果存在，会先删除再手动创建,表创建完成之后插入数据,分析dump文件，具体内容如下：</p><p>4.1、创建database：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">Current</span> <span class="attr">Database:</span> <span class="string">`aaaa`</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="string">CREATE</span> <span class="string">DATABASE</span> <span class="string">/*!32312</span> <span class="string">IF</span> <span class="string">NOT</span> <span class="string">EXISTS*/</span> <span class="string">`aaaa`</span> <span class="string">/*!40100</span> <span class="string">DEFAULT</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">USE</span> <span class="string">`aaaa`;</span></span><br></pre></td></tr></table></figure></p><p>4.2、检查并创建表aaa:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">Table</span> <span class="string">structure</span> <span class="string">for</span> <span class="string">table</span> <span class="string">`aaa`</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="string">DROP</span> <span class="string">TABLE</span> <span class="string">IF</span> <span class="string">EXISTS</span> <span class="string">`aaa`;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">@saved_cs_client</span>     <span class="string">=</span> <span class="string">@@character_set_client</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">character_set_client</span> <span class="string">=</span> <span class="string">utf8</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">CREATE</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">(</span></span><br><span class="line">  <span class="string">`id`</span> <span class="string">int(11)</span> <span class="string">NOT</span> <span class="literal">NULL</span><span class="string">,</span></span><br><span class="line">  <span class="string">PRIMARY</span> <span class="string">KEY</span> <span class="string">(`id`)</span></span><br><span class="line"><span class="string">)</span> <span class="string">ENGINE=InnoDB</span> <span class="string">DEFAULT</span> <span class="string">CHARSET=utf8mb4;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">character_set_client</span> <span class="string">=</span> <span class="string">@saved_cs_client</span> <span class="string">*/;</span></span><br></pre></td></tr></table></figure></p><p>4.3、对表aaa插入备份出来的数据：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">Dumping</span> <span class="string">data</span> <span class="string">for</span> <span class="string">table</span> <span class="string">`aaa`</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span></span><br><span class="line"><span class="string">LOCK</span> <span class="string">TABLES</span> <span class="string">`aaa`</span> <span class="string">WRITE;</span></span><br><span class="line"><span class="string">/*!40000</span> <span class="string">ALTER</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">DISABLE</span> <span class="string">KEYS</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">INSERT</span> <span class="string">INTO</span> <span class="string">`aaa`</span> <span class="string">VALUES</span> <span class="string">(1);</span></span><br><span class="line"><span class="string">/*!40000</span> <span class="string">ALTER</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">ENABLE</span> <span class="string">KEYS</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">UNLOCK</span> <span class="string">TABLES;</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb sharding集群配置</title>
      <link href="/2018/08/08/mongodb-sharding-cluster%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/08/08/mongodb-sharding-cluster%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="0、前提需求"><a href="#0、前提需求" class="headerlink" title="0、前提需求"></a>0、前提需求</h2><p>为了满足mongodb数据库高可用环境，可以使用配置副本集CSRS（config server replica set)，搭建方法点击<a href="https://zeven0707.github.io/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/" target="_blank" rel="noopener">此处</a>,但是当业务吞吐量特别高的时刻，单台节点已经不能满足访问需求，因此需要考虑sharding cluster 模式，提高访问性能。</p><h2 id="1、将集群架构从csrs调整为sharding-cluster-下文按照上面搭建的csrs架构继续调整："><a href="#1、将集群架构从csrs调整为sharding-cluster-下文按照上面搭建的csrs架构继续调整：" class="headerlink" title="1、将集群架构从csrs调整为sharding cluster,下文按照上面搭建的csrs架构继续调整："></a>1、将集群架构从csrs调整为sharding cluster,下文按照上面搭建的csrs架构继续调整：</h2><p>1.1、节点信息如下：<br>主：10.0.7.53<br>从：10.0.7.51<br>仲裁：10.0.7.50<br>依次关闭仲裁、从、主节点，修改配置文件mongodb.conf，添加如下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sharding:</span><br><span class="line">   clusterRole: shardsvr</span><br></pre></td></tr></table></figure></p><p>1.2、修改完三个节点之后，依次启动主，从，仲裁三个节点，进入控制台使用rs.status()，查看集群状态是否正常。为了保证停机时间较短，可使用rs.stepDown()分别进行主从切换，对从库进行配置并重启。</p><h2 id="2、新建一个shard1集群节点，操作如下-三个节点都要执行）："><a href="#2、新建一个shard1集群节点，操作如下-三个节点都要执行）：" class="headerlink" title="2、新建一个shard1集群节点，操作如下(三个节点都要执行）："></a>2、新建一个shard1集群节点，操作如下(三个节点都要执行）：</h2><p>2.1、节点信息如下：<br>从：10.0.7.53<br>主：10.0.7.51<br>仲裁：10.0.7.50<br>2.2、拷贝一份mongodb.conf文件，并重新命名<br>cp mongodb.conf shard1mongodb.conf<br>2.3、主节点需要在无需验证的模式下，先配置用户名密码。之后修改（三个节点）shard1mongodb.conf配置文件内容如下：<br>cat shard1mongodb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line"><span class="attr">  destination:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/data/mongodb/shard1/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  dbPath:</span> <span class="string">/data/mongodb/shard1/data/</span></span><br><span class="line"><span class="attr">  journal:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line"><span class="attr">  fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line"><span class="attr">  pidFilePath:</span> <span class="string">/data/mongodb/shard1/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.53</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">   authorization:</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">   keyFile:</span> <span class="string">/data/mongodb/shard1/mongodb.keyfile</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line"><span class="attr">   replSetName:</span> <span class="string">"shard1"</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line"><span class="attr">   clusterRole:</span> <span class="string">shardsvr</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p><p>注意修改sharding、port、path、replname等参数</p><p>2.4、创建相应的数据目录和日志目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/shard1/&#123;<span class="built_in">log</span>,data&#125;</span><br></pre></td></tr></table></figure></p><p>2.5、生成keyfile文件并拷贝keyfile文件到指定目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mongodb.keyfile /data/mongodb/shard1/</span><br></pre></td></tr></table></figure></p><p>2.6、三个节点启动mongodb-shard1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod -f /data/mongodb/shard1mongodb.conf</span><br></pre></td></tr></table></figure></p><p>2.7、初始化集群配置：</p><h2 id="data-mongodb-bin-mongo-–port-30001"><a href="#data-mongodb-bin-mongo-–port-30001" class="headerlink" title="/data/mongodb/bin/mongo –port 30001"></a>/data/mongodb/bin/mongo –port 30001</h2><p>rs.initiate(<br>  {<br>    _id : “shard”,<br>    members: [<br>      { _id : 0, host : “10.0.7.53:30001” },<br>      { _id : 1, host : “10.0.7.50:30001” },<br>      { _id : 2, host : “10.0.7.51:30001”,”arbiterOnly” : true }<br>    ]<br>  }<br>)<br>2.8、查看集群节点信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status();</span><br></pre></td></tr></table></figure></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"set"</span> <span class="string">:</span> <span class="string">"shard"</span><span class="string">,</span></span><br><span class="line"><span class="string">"date"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.697Z"),</span></span><br><span class="line"><span class="string">"myState"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"term"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"heartbeatIntervalMillis"</span> <span class="string">:</span> <span class="string">NumberLong(2000),</span></span><br><span class="line"><span class="string">"optimes"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"readConcernMajorityOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"appliedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"durableOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"lastStableCheckpointTimestamp"</span> <span class="string">:</span> <span class="string">Timestamp(1533784355,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"members"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.53:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">47039</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"self"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"PRIMARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">46862</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line"><span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:33.395Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:32.735Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"electionTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533737562,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"electionDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-08T14:12:42Z"),</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30001"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">7</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"ARBITER"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">46862</span><span class="string">,</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.660Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.658Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(0),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"$gleStats"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"lastOpTime"</span> <span class="string">:</span> <span class="string">Timestamp(0,</span> <span class="number">0</span><span class="string">),</span></span><br><span class="line"><span class="string">"electionId"</span> <span class="string">:</span> <span class="string">ObjectId("000000000000000000000000")</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"$configServerState"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"opTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784394,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784408,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"dToZVSHbihPkQILJVl0qcSY+8ys="),</span></span><br><span class="line"><span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong("6587344633552961565")</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="3、新建一个config-server集群节点，操作如下-三个节点都要执行）："><a href="#3、新建一个config-server集群节点，操作如下-三个节点都要执行）：" class="headerlink" title="3、新建一个config-server集群节点，操作如下(三个节点都要执行）："></a>3、新建一个config-server集群节点，操作如下(三个节点都要执行）：</h2><p>3.1、节点信息如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">从：10.0.7.53</span></span><br><span class="line"><span class="string">从：10.0.7.51</span></span><br><span class="line"><span class="string">主：10.0.7.50</span></span><br></pre></td></tr></table></figure></p><p>3.2、拷贝一份mongodb.conf文件，并重新命名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp shard1mongodb.conf configmongodb.conf</span><br></pre></td></tr></table></figure></p><p>3.3、主节点需要在无需验证的模式下，先配置用户名密码。之后修改（三个节点）configmongodb.conf配置文件内容如下：<br>cat configmongodb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line"><span class="attr">  destination:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/data/mongodb/config/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  dbPath:</span> <span class="string">/data/mongodb/config/data/</span></span><br><span class="line"><span class="attr">  journal:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line"><span class="attr">  fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line"><span class="attr">  pidFilePath:</span> <span class="string">/data/mongodb/config/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.53</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#   authorization: enabled</span></span><br><span class="line"><span class="comment">#   keyFile: /data/mongodb/config/mongodb.keyfile</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line"><span class="attr">   replSetName:</span> <span class="string">"config"</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line"><span class="attr">   clusterRole:</span> <span class="string">configsvr</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p><p>注意修改sharding、repl、port、path<br>3.4、创建相应的数据目录和日志目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/config/&#123;<span class="built_in">log</span>,data&#125;</span><br></pre></td></tr></table></figure></p><p>3.5、三个节点启动mongodb-shard1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod --configsvr -f /data/mongodb/configmongodb.conf</span><br></pre></td></tr></table></figure></p><p>启动config-server服务需要指定参数，否则初始化集群的时候会报错：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"errmsg"</span> <span class="string">:</span> <span class="string">"Nodes being used for config servers must be started with the --configsvr flag"</span></span><br></pre></td></tr></table></figure></p><p>3.6、初始化集群配置：</p><h2 id="data-mongodb-bin-mongo-–port-30002"><a href="#data-mongodb-bin-mongo-–port-30002" class="headerlink" title="/data/mongodb/bin/mongo –port 30002"></a>/data/mongodb/bin/mongo –port 30002</h2><p>rs.initiate(<br>  {<br>    _id : “config”,<br>    configsvr: true,<br>    members: [<br>      { _id : 0, host : “10.0.7.53:30002” },<br>      { _id : 1, host : “10.0.7.50:30002” },<br>      { _id : 2, host : “10.0.7.51:30002” }<br>    ]<br>  }<br>)<br>3.7、查看集群信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rs.status();</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"set"</span> <span class="string">:</span> <span class="string">"config"</span><span class="string">,</span></span><br><span class="line"><span class="string">"date"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.472Z"),</span></span><br><span class="line"><span class="string">"myState"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"term"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"heartbeatIntervalMillis"</span> <span class="string">:</span> <span class="string">NumberLong(2000),</span></span><br><span class="line"><span class="string">"optimes"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"readConcernMajorityOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"appliedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"durableOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"lastStableCheckpointTimestamp"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"members"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.53:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">15</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.161Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:12.674Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(0),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">15</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.164Z"),</span></span><br><span class="line"><span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:12.680Z"),</span></span><br><span class="line"><span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"_id"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line"><span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line"><span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"state"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"PRIMARY"</span><span class="string">,</span></span><br><span class="line"><span class="string">"uptime"</span> <span class="string">:</span> <span class="number">59</span><span class="string">,</span></span><br><span class="line"><span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line"><span class="string">&#125;,</span></span><br><span class="line"><span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line"><span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line"><span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="bullet">-1</span><span class="string">,</span></span><br><span class="line"><span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">"could not find member to sync from"</span><span class="string">,</span></span><br><span class="line"><span class="string">"electionTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544150,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line"><span class="string">"electionDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:10Z"),</span></span><br><span class="line"><span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"self"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line"><span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">],</span></span><br><span class="line"><span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line"><span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line"><span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</span></span><br><span class="line"><span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong(0)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p><h2 id="4、配置mongs-mongodb-router-用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点"><a href="#4、配置mongs-mongodb-router-用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点" class="headerlink" title="4、配置mongs(mongodb-router),用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点"></a>4、配置mongs(mongodb-router),用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点</h2><p>4.1、拷贝一份配置文件，并重命名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp configmongodb.conf routermongodb.conf</span><br></pre></td></tr></table></figure></p><p>4.2、修改配置文件参数，内容如下：<br>cat routermongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># mongod.conf</span><br><span class="line"></span><br><span class="line"># for documentation of all options, see:</span><br><span class="line">#   http://docs.mongodb.org/manual/reference/routeruration-options/</span><br><span class="line"></span><br><span class="line"># where to write logging data.</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /data/mongodb/router/log/mongod.log</span><br><span class="line"></span><br><span class="line"># Where and how to store data.</span><br><span class="line">#storage:</span><br><span class="line">#  dbPath: /data/mongodb/router/data/</span><br><span class="line">#  journal:</span><br><span class="line">#    enabled: true</span><br><span class="line">#  engine:</span><br><span class="line">#  mmapv1:</span><br><span class="line">#  wiredTiger:</span><br><span class="line"></span><br><span class="line"># how the process runs</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true  # fork and run in background</span><br><span class="line">  pidFilePath: /data/mongodb/router/log/mongod.pid  # location of pidfile</span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 30004</span><br><span class="line">  bindIp: 127.0.0.1,10.0.7.53  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line"></span><br><span class="line">#security:</span><br><span class="line">#security:</span><br><span class="line">#   authorization: enabled</span><br><span class="line">#operationProfiling:</span><br><span class="line"></span><br><span class="line">#replication:</span><br><span class="line">#sharding:</span><br><span class="line">sharding:</span><br><span class="line">   configDB: config/10.0.7.53:30002,10.0.7.51:30002,10.0.7.50:30002</span><br><span class="line"></span><br><span class="line">## Enterprise-Only Options</span><br><span class="line"></span><br><span class="line">#auditLog:</span><br><span class="line"></span><br><span class="line">#snmp:</span><br></pre></td></tr></table></figure></p><p>注意修改sharding,port参数，注释掉storage参数<br>4.3、创建router日志目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/router/<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p><p>4.4、启动mongos<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongos -f /data/mongodb/routermongodb.conf</span><br></pre></td></tr></table></figure></p><p>4.5、为模拟生产环境数据，对testrepl集群节点，插入部分数据,批量插入脚本如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use test</span><br><span class="line">var bulk = db.test_collection.initializeUnorderedBulkOp();</span><br><span class="line">people = [&quot;Marc&quot;, &quot;Bill&quot;, &quot;George&quot;, &quot;Eliot&quot;, &quot;Matt&quot;, &quot;Trey&quot;, &quot;Tracy&quot;, &quot;Greg&quot;, &quot;Steve&quot;, &quot;Kristina&quot;, &quot;Katie&quot;, &quot;Jeff&quot;];</span><br><span class="line">for(var i=0; i&lt;1000000; i++)&#123;</span><br><span class="line">   user_id = i;</span><br><span class="line">   name = people[Math.floor(Math.random()*people.length)];</span><br><span class="line">   number = Math.floor(Math.random()*10001);</span><br><span class="line">   bulk.insert( &#123; &quot;user_id&quot;:user_id, &quot;name&quot;:name, &quot;number&quot;:number &#125;);</span><br><span class="line">&#125;</span><br><span class="line">bulk.execute();</span><br></pre></td></tr></table></figure></p><p>4.6、连接到mongos<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mongo --host 10.0.7.50 --port 30004</span><br><span class="line">mongos&gt; use admin</span><br><span class="line">mongos&gt; db.auth(<span class="string">'admin1'</span>,<span class="string">'admin123'</span>);</span><br></pre></td></tr></table></figure></p><p>4.7、将节点添加到集群内：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(&quot;testrepl/10.0.7.53:30000&quot;)</span><br><span class="line">mongos&gt; sh.addShard(&quot;shard1/10.0.7.53:30001&quot;)</span><br></pre></td></tr></table></figure></p><p>4.8、使数据库test支持sharding<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.enableSharding(&quot;test&quot;)</span><br><span class="line">mongos&gt; use test</span><br><span class="line">#在拆分键上创建索引</span><br><span class="line">mongos&gt; db.test_collection.createIndex( &#123; number : 1 &#125; )</span><br><span class="line">#拆分集合</span><br><span class="line">mongos&gt; sh.shardCollection(&apos;test.mycol2&apos;, &#123;&apos;_id&apos;: 1&#125;)</span><br></pre></td></tr></table></figure></p><p>4.9、查看拆分结果,(可多次重复4.5步骤进行测试）<br>sh.status()或者db.printShardingStatus()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  <span class="string">"_id"</span> : 1,</span><br><span class="line">  <span class="string">"minCompatibleVersion"</span> : 5,</span><br><span class="line">  <span class="string">"currentVersion"</span> : 6,</span><br><span class="line">  <span class="string">"clusterId"</span> : ObjectId(<span class="string">"5b6af30b5025146bfd45717b"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"shard"</span>,  <span class="string">"host"</span> : <span class="string">"shard/10.0.7.50:30001,10.0.7.53:30001"</span>,  <span class="string">"state"</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"testrepl"</span>,  <span class="string">"host"</span> : <span class="string">"testrepl/10.0.7.50:30000,10.0.7.53:30000"</span>,  <span class="string">"state"</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">"4.0.0"</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: yes</span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                4 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"config"</span>,  <span class="string">"primary"</span> : <span class="string">"config"</span>,  <span class="string">"partitioned"</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">"_id"</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shard1</span><br><span class="line">                        &#123; <span class="string">"_id"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">"_id"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : 1 &#125; &#125; on : shard Timestamp(1, 0) </span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"test"</span>,  <span class="string">"primary"</span> : <span class="string">"testrepl"</span>,  <span class="string">"partitioned"</span> : <span class="literal">true</span>,  <span class="string">"version"</span> : &#123;  <span class="string">"uuid"</span> : UUID(<span class="string">"185a3842-639f-42b0-89a1-afdc8dcdfbe7"</span>),  <span class="string">"lastMod"</span> : 1 &#125; &#125;</span><br><span class="line">                test.test_collection</span><br><span class="line">                        shard key: &#123; <span class="string">"number"</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shard4</span><br><span class="line">                                testrepl4</span><br><span class="line">                        &#123; <span class="string">"number"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 2394 &#125; on : shard Timestamp(2, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 2394 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 4791 &#125; on : shard Timestamp(3, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 4791 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 7194 &#125; on : shard Timestamp(4, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 7194 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 7892 &#125; on : shard Timestamp(5, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 7892 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 8591 &#125; on : testrepl Timestamp(5, 1) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 8591 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 9287 &#125; on : testrepl Timestamp(3, 4) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 9287 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 9589 &#125; on : testrepl Timestamp(3, 5) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 9589 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : 1 &#125; &#125; on : testrepl Timestamp(4, 1)</span><br></pre></td></tr></table></figure></p><h2 id="5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可"><a href="#5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可" class="headerlink" title="5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可"></a>5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可</h2>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mysql] mysql-mha主从环境，从库报错Error_code: 1062</title>
      <link href="/2018/08/07/5.7.22-log%E7%89%88%E6%9C%ACmysql,mha%E4%B8%BB%E4%BB%8E%E7%8E%AF%E5%A2%83%EF%BC%8C%E4%BB%8E%E5%BA%93%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF/"/>
      <url>/2018/08/07/5.7.22-log%E7%89%88%E6%9C%ACmysql,mha%E4%B8%BB%E4%BB%8E%E7%8E%AF%E5%A2%83%EF%BC%8C%E4%BB%8E%E5%BA%93%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF/</url>
      <content type="html"><![CDATA[<h2 id="0、数据库版本信息："><a href="#0、数据库版本信息：" class="headerlink" title="0、数据库版本信息："></a>0、数据库版本信息：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.7</span><span class="number">.22</span></span><br></pre></td></tr></table></figure><h2 id="1、从库报错信息"><a href="#1、从库报错信息" class="headerlink" title="1、从库报错信息"></a>1、从库报错信息</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Last_SQL_Error:</span> <span class="string">Could</span> <span class="string">not</span> <span class="string">execute</span> <span class="string">Write_rows</span> <span class="string">event</span> <span class="string">on</span> <span class="string">table</span> <span class="string">test.tb1;</span></span><br><span class="line"><span class="string">Duplicate</span> <span class="string">entry</span> <span class="string">'4'</span> <span class="string">for</span> <span class="string">key</span> <span class="string">'PRIMARY'</span><span class="string">,</span></span><br><span class="line"><span class="attr">Error_code:</span> <span class="number">1062</span><span class="string">;</span></span><br><span class="line"><span class="string">handler</span> <span class="string">error</span> <span class="string">HA_ERR_FOUND_DUPP_KEY;</span> <span class="string">the</span> <span class="string">event's</span> <span class="string">master</span> <span class="string">log</span> <span class="string">mysql-binlog.000005,</span> <span class="string">end_log_pos</span> <span class="number">273273632</span></span><br></pre></td></tr></table></figure><h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><p>2.1、在主库上查询二进制文件信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqlbinlog  -v --stop-position=273273632 /data/mysql/<span class="built_in">log</span>/mysql-binlog.000005 &gt; /tmp/f.log</span><br></pre></td></tr></table></figure></p><p>2.2、过滤出报错的pos所对应的行数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/f.log | awk <span class="string">'/end_log_pos 273273632/ &#123;print NR&#125;'</span></span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">22556452</span><br></pre></td></tr></table></figure><p>2.3、根据查询到的行数，查看其上下文：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/f.log | awk <span class="string">'NR==22556442,NR==22556492'</span></span><br></pre></td></tr></table></figure></p><p>2.4、查询到insert的插入语句<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### INSERT INTO `test`.`tb1`</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=4</span></span><br><span class="line"><span class="comment">###   @2='ERC20'</span></span><br><span class="line"><span class="comment">###   @3='GTO'</span></span><br><span class="line"><span class="comment">###   @4=1533176390</span></span><br><span class="line"><span class="string">ROLLBACK</span> <span class="string">/*</span> <span class="string">added</span> <span class="string">by</span> <span class="string">mysqlbinlog</span> <span class="string">*/</span> <span class="string">/*!*/;</span></span><br></pre></td></tr></table></figure></p><p>2.5、在从库上执行下面操作，停止主从同步<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure></p><p>2.6、删除报错提示的对应的行：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb1 <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">4</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb1;</span><br></pre></td></tr></table></figure></p><p>2.7、重新启动主从同步，查看节点信息正常：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongodb集群配置一主一从一仲裁</title>
      <link href="/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/"/>
      <url>/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/</url>
      <content type="html"><![CDATA[<h2 id="1、首先安装在三个节点安装mongodb-安装方法详见"><a href="#1、首先安装在三个节点安装mongodb-安装方法详见" class="headerlink" title="1、首先安装在三个节点安装mongodb,安装方法详见"></a>1、首先安装在三个节点安装mongodb,安装方法详见</h2><p>   <a href="https://zeven0707.github.io/2018/08/03/mongdob4.0/" target="_blank" rel="noopener">mongodb单点安装</a></p><h2 id="2、集群节点信息："><a href="#2、集群节点信息：" class="headerlink" title="2、集群节点信息："></a>2、集群节点信息：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">主：10.0.7.53</span></span><br><span class="line"><span class="string">从：10.0.7.51</span></span><br><span class="line"><span class="string">仲裁：10.0.7.50</span></span><br></pre></td></tr></table></figure><h2 id="3、启动主节点，进入主节点控制台，"><a href="#3、启动主节点，进入主节点控制台，" class="headerlink" title="3、启动主节点，进入主节点控制台，"></a>3、启动主节点，进入主节点控制台，</h2><p>3.1、创建管理员用户名、密码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; /data/mongodb/bin/mongo --port 30000</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt;use admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt;</span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: <span class="string">"admin"</span>,</span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"abc123"</span>,</span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>使用userAdminAnyDatabase的role权限去查看rs.status();会提示<br>“not authorized on admin to execute command”,建议授予root权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: <span class="string">"admin1"</span>,</span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"admin123"</span>,</span><br><span class="line">    roles: [ &#123; role: <span class="string">"root"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>3.2、查看创建的管理员信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.system.users.find()</span><br></pre></td></tr></table></figure></p><p>3.3、退出控制台，修改配置文件mongodb.conf(每个节点都要配置)：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">   authorization:</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure></p><h2 id="4、在主节点上，生成秘钥文件"><a href="#4、在主节点上，生成秘钥文件" class="headerlink" title="4、在主节点上，生成秘钥文件"></a>4、在主节点上，生成秘钥文件</h2><p>4.1、生成密钥文件，用于集群之间互相通信：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 756 &gt; /data/mongodb/mongodb.keyfile</span><br></pre></td></tr></table></figure></p><p>4.2、更改文件权限以仅为文件所有者提供读取权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 400 /data/mongodb/mongodb.keyfile</span><br></pre></td></tr></table></figure></p><p>4.3、将密钥文件复制到每个副本集成员<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /data/mongodb/mongodb.keyfile root@10.0.7.51:/data/mongodb/</span><br><span class="line">scp /data/mongodb/mongodb.keyfile root@10.0.7.50:/data/mongodb/</span><br></pre></td></tr></table></figure></p><p>4.4、修改配置文件mongodb.conf，添加keyfile参数(每个节点都要配置)：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">   keyFile:</span> <span class="string">/data/mongodb/mongodb.keyfile</span></span><br></pre></td></tr></table></figure></p><h2 id="5、配置集群"><a href="#5、配置集群" class="headerlink" title="5、配置集群"></a>5、配置集群</h2><p>5.1、修改配置文件mongodb.conf，添加集群配置参数(每个节点都要配置)：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">   replSetName: <span class="string">"testrepl"</span></span><br></pre></td></tr></table></figure></p><p>replSetName:设置集群名称，根据自己需求自定义（三个节点要保持一直）</p><p>5.2、重新启动mongodb<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod -f /data/mongodb/mongodb.conf</span><br></pre></td></tr></table></figure></p><p>5.3、进入主节点控制台<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongo --port 30000</span><br></pre></td></tr></table></figure></p><p>5.4、添加集群节点：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use admin;</span><br><span class="line">db.auth(<span class="string">'admin'</span>,<span class="string">'abc123'</span>);</span><br><span class="line"></span><br><span class="line">rs.initiate( &#123;</span><br><span class="line">   _id : <span class="string">"testrepl"</span>,</span><br><span class="line">   members: [</span><br><span class="line">      &#123; _id: 0, host: <span class="string">"10.0.7.53:30000"</span> &#125;,</span><br><span class="line">      &#123; _id: 1, host: <span class="string">"10.0.7.50:30000"</span> &#125;,</span><br><span class="line">      &#123; _id: 2, host: <span class="string">"10.0.7.51:30000"</span>,<span class="string">"arbiterOnly"</span> : <span class="literal">true</span>&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>执行结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line">        <span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">        <span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533388128,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">        <span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533388128,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">                <span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">                        <span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</span></span><br><span class="line">                        <span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong(0)</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p><p>5.5、查看集群状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; rs.status();</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"testrepl"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.894Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : 1,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(1),</span><br><span class="line">        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(2000),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"readConcernMajorityOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"lastStableCheckpointTimestamp"</span> : Timestamp(1533388140, 1),</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 1,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 289,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"electionTime"</span> : Timestamp(1533388139, 1),</span><br><span class="line">                        <span class="string">"electionDate"</span> : ISODate(<span class="string">"2018-08-04T13:08:59Z"</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.50:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 2,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 37,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.051Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.677Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(3),</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : 0,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.51:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 7,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"ARBITER"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 37,</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.031Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2018-08-04T13:09:24.265Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(0),</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : 1,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1533388160, 1),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(0,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(0)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5.6、从库默认为不能读写模式，如果要启动从库的读模式，进入从库执行以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk();</span><br></pre></td></tr></table></figure></p><p>5.7、增加一个仲裁节点，新增节点，配置文件中密钥文件、repl参数一定要保持一致：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(<span class="string">"m1.example.net:27017"</span>)</span><br></pre></td></tr></table></figure></p><p>5.8、添加一个新的从节点，添加之前设置该节点优先级为0，表决为0，以防止该节点数据未同步完成之前参与选举，待该节点数据同步完成之后，使用rs.reconfig()参数再修改其优先级和表决：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add( &#123; host: <span class="string">"mongodb3.example.net:27017"</span>, priority: 0, votes: 0 &#125; )</span><br></pre></td></tr></table></figure></p><p>rs.reconfig()命令执行如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var cfg = rs.conf();</span><br><span class="line">cfg.members[4].priority = 1</span><br><span class="line">cfg.members[4].votes = 1</span><br><span class="line">rs.reconfig(cfg)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Mongodb] mongdob-enterprise-4.0安装</title>
      <link href="/2018/08/03/mongdob4.0/"/>
      <url>/2018/08/03/mongdob4.0/</url>
      <content type="html"><![CDATA[<h3 id="1、Yum方式安装"><a href="#1、Yum方式安装" class="headerlink" title="1、Yum方式安装"></a>1、Yum方式安装</h3><p>  1.1配置yum源<br> cat /etc/yum.repos.d/mongodb-enterprise.repo<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[mongodb-enterprise]</span></span><br><span class="line"><span class="string">name=MongoDB</span> <span class="string">Enterprise</span> <span class="string">Repository</span></span><br><span class="line"><span class="string">baseurl=https://repo.mongodb.com/yum/redhat/$releasever/mongodb-enterprise/4.0/$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span></span><br></pre></td></tr></table></figure></p><p>  1.2执行安装命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y mongodb-enterprise</span><br></pre></td></tr></table></figure></p><p> 如果想要指定安装某一个版本的mongodb,需要指定每一个组件的安装版本,如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y mongodb-enterprise-4.0.0 mongodb-enterprise-server-4.0.0 mongodb-enterprise-shell-4.0.0 mongodb-enterprise-mongos-4.0.0 mongodb-enterprise-tools-4.0.0</span><br></pre></td></tr></table></figure></p><p>  1.3mongodb启动、关闭命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service mongod start</span><br><span class="line">sudo service mongod stop</span><br><span class="line">sudo service mongod restart</span><br></pre></td></tr></table></figure></p><p>  1.4通过yum方式安装完之后，配置文件所在为/etc/mongod.conf</p><h3 id="2、tar包方式安装"><a href="#2、tar包方式安装" class="headerlink" title="2、tar包方式安装"></a>2、tar包方式安装</h3><p> 2.1安装之前需要，安装依赖包：<br> linux-6:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y cyrus-sasl cyrus-sasl-plain cyrus-sasl-gssapi krb5-libs libcurl libpcap net-snmp openldap openssl</span><br></pre></td></tr></table></figure></p><p> linux-7<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y cyrus-sasl cyrus-sasl-gssapi cyrus-sasl-plain krb5-libs libcurl libpcap lm_sensors-libs net-snmp net-snmp-agent-libs openldap openssl rpm-libs tcp_wrappers-libs</span><br></pre></td></tr></table></figure></p><p> 2.2下载mongodb-enterprise软件包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.mongodb.com/linux/mongodb-linux-x86_64-enterprise-rhel70-4.0.0.tgz</span><br></pre></td></tr></table></figure></p><p> 2.3解压软件包，修改目录名称，配置环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> tar -zxvf mongodb-linux-x86_64-enterprise-rhel70-4.0.0.tgz -C /data/</span><br><span class="line"> mv /data/mongodb-linux-x86_64-enterprise-rhel70-4.0.0 /data/mongodb</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export PATH=/data/mongodb/bin:\$PATH"</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p> 2.4修改配置文件<br> cat /data/mongodb/mongodb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line"><span class="attr">  destination:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">/data/mongodb/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  dbPath:</span> <span class="string">/data/mongodb/data/</span></span><br><span class="line"><span class="attr">  journal:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line"><span class="attr">  fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line"><span class="attr">  pidFilePath:</span> <span class="string">/data/mongodb/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.51</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p><p> 2.5修改的配置文件中，如果数据目录，日志目录不存在会报错，需要手动配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/&#123;log,data&#125;</span><br></pre></td></tr></table></figure></p><p> 2.6启动mongodb<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;/data/mongodb/bin/mongod -f /data/mongodb/mongodb.conf</span><br><span class="line"> --------</span><br><span class="line"> 2018-08-03T08:42:19.873+0000 I CONTROL  [main] Automatically disabling TLS 1.0, to force-enable TLS 1.0 specify --sslDisabledProtocols <span class="string">'none'</span></span><br><span class="line">about to fork child process, waiting until server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 41022</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure></p><p> 2.7查看mongodb进程：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> netstat -tunlp|grep 30000</span><br><span class="line">---------</span><br><span class="line">tcp        0      0 10.0.7.51:30000         0.0.0.0:*               LISTEN      41022/mongod        </span><br><span class="line">tcp        0      0 127.0.0.1:30000         0.0.0.0:*               LISTEN      41022/mongod</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> mongodb </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Zabbix] zabbix3.4监控nginx性能</title>
      <link href="/2018/08/03/zabbix-nginx/"/>
      <url>/2018/08/03/zabbix-nginx/</url>
      <content type="html"><![CDATA[<h2 id="1、查看nginx安装HTTP-Stub-Status"><a href="#1、查看nginx安装HTTP-Stub-Status" class="headerlink" title="1、查看nginx安装HTTP Stub Status"></a>1、查看nginx安装HTTP Stub Status</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openresty -V</span><br></pre></td></tr></table></figure><p>如果”–with-http_stub_status_module”参数，表示没有安装，要手动添加：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">在编译nginx</span> <span class="string">的时候要加上参数</span> <span class="string">–with-http_stub_status_module，</span></span><br><span class="line"><span class="string">执行./configure</span> <span class="string">&amp;&amp;</span> <span class="string">make就可以了，不用make</span> <span class="string">install。不过，一般情况下都是安装了的。</span></span><br></pre></td></tr></table></figure></p><h2 id="2、nginx服务器添加配置"><a href="#2、nginx服务器添加配置" class="headerlink" title="2、nginx服务器添加配置"></a>2、nginx服务器添加配置</h2><p>   2.1添加配置文件nginx_status.conf<br>cat /usr/local/openresty/nginx/conf/conf.d/nginx_status.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line"></span><br><span class="line">    location /basic_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>   2.2重新加载配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openresty -s reload</span><br></pre></td></tr></table></figure></p><p>   2.3获取nginx监控状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1/basic_status</span><br><span class="line">-------------</span><br><span class="line">Active connections: 1 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 572 572 764 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0</span><br></pre></td></tr></table></figure></p><p>   nginx监控参数详解<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Active connections: 对后端发起的活动连接数</span></span><br><span class="line"><span class="comment">## Server accepts handled requests: Nginx 总共处理了 572 个连接，成功创建了 572 次握手（没有失败次数），总共处理了 764 个请求</span></span><br><span class="line"><span class="comment">## Reading: Nginx 读取到客户端的 Header 信息数</span></span><br><span class="line"><span class="comment">## Writing: Nginx 返回给客户端的 Header 信息数</span></span><br><span class="line"><span class="comment">## Waiting: 开启 keep-alive 的情况下，这个值等于 active - ( reading + writing ), 意思是 Nginx 已经处理完成，正在等待下一次请求指令的驻留连接</span></span><br><span class="line"><span class="comment">## 在访问效率很高，请求很快被处理完毕的情况下，Waiting 数比较多是正常的。如果 reading + writing 数较多，则说明并发访问量很大，正在处理过程中</span></span><br></pre></td></tr></table></figure></p><h2 id="3、配置zabbix"><a href="#3、配置zabbix" class="headerlink" title="3、配置zabbix"></a>3、配置zabbix</h2><p>创建存放脚本目录，（我的zabbix安装路径为 /usr/local/zabbix）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/zabbix/script</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/zabbix/script</span><br></pre></td></tr></table></figure></p><p>创建存放数据文件（可自行定义）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch .status.txt</span><br></pre></td></tr></table></figure></p><p>编辑脚本用于获取nginx监控状态参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">server_hostname=127.0.0.1</span></span><br><span class="line"><span class="string">data_file=/usr/local/zabbix/script/.status.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">status_data=\`curl -o \$data_file -s http://\$server_hostname/basic_status\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Active() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Active/&#123;print \$4&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Reading() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Reading/ &#123;print \$3&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Writing() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Writing/ &#123;print \$6&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Waiting() &#123;</span></span><br><span class="line"><span class="string">    awk -F \"[: ]\" '/Waiting/ &#123;print \$9&#125;' \$data_file</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\$1"</span> &gt; /usr/<span class="built_in">local</span>/zabbix/script/nginx_connection.sh</span><br></pre></td></tr></table></figure></p><p>修改目录下所有文件的权限，否则脚本写入文件会有权限问题<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R zabbix.zabbix /usr/<span class="built_in">local</span>/zabbix/script</span><br></pre></td></tr></table></figure></p><p>添加zabbix参数到agent配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \<span class="string">"UserParameter=nginx.Active,sh /usr/local/zabbix/script/nginx_connection.sh Active</span></span><br><span class="line"><span class="string">UserParameter=nginx.Writing,sh /usr/local/zabbix/script/nginx_connection.sh Writing</span></span><br><span class="line"><span class="string">UserParameter=nginx.Reading,sh /usr/local/zabbix/script/nginx_connection.sh Reading</span></span><br><span class="line"><span class="string">UserParameter=nginx.Waiting,sh /usr/local/zabbix/script/nginx_connection.sh Waiting\" &gt;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span></span><br></pre></td></tr></table></figure></p><p>重新启动agent客户端：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure></p><p>在server端测试是否能获取到参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/zabbix/bin/zabbix_get -s 10.1.130.47  -k nginx.Active</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Redis] redis-cluster集群部署</title>
      <link href="/2018/08/02/redis-cluster%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/08/02/redis-cluster%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="0、Redis-集群功能限制"><a href="#0、Redis-集群功能限制" class="headerlink" title="0、Redis 集群功能限制"></a>0、Redis 集群功能限制</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Redis集群相对单机在功能上有一定限制。</span></span><br><span class="line"><span class="string">key批量操作支持有限。如：MSET``MGET，目前只支持具有相同slot值的key执行批量操作。</span></span><br><span class="line"><span class="string">key事务操作支持有限。支持多key在同一节点上的事务操作，不支持分布在多个节点的事务功能。</span></span><br><span class="line"><span class="string">key作为数据分区的最小粒度，因此不能将一个大的键值对象映射到不同的节点。如：hash、list。</span></span><br><span class="line"><span class="string">不支持多数据库空间。单机下Redis支持16个数据库，集群模式下只能使用一个数据库空间，即db</span> <span class="number">0</span><span class="string">。</span></span><br><span class="line"><span class="string">复制结构只支持一层，不支持嵌套树状复制结构。</span></span><br></pre></td></tr></table></figure><h2 id="1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下："><a href="#1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下：" class="headerlink" title="1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下："></a>1、服务器三台，在每台服务器上部署两个redis服务器，节点信息如下：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">主1：10.0.7.53-6379,</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span><span class="bullet">-6380</span></span><br><span class="line"><span class="string">主2：10.0.7.50-6379,</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.50</span><span class="bullet">-6380</span></span><br><span class="line"><span class="string">主3：10.0.7.51-6379,</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.51</span><span class="bullet">-6380</span></span><br></pre></td></tr></table></figure><h2 id="2、修改redis-conf配置文件"><a href="#2、修改redis-conf配置文件" class="headerlink" title="2、修改redis.conf配置文件"></a>2、修改redis.conf配置文件</h2><p>cat /data/redis/etc/redis6379.conf(不同服务器，修改bind对应的ip即可)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pidfile /data/redis6379/<span class="built_in">log</span>/redis.pid</span><br><span class="line"><span class="built_in">bind</span> 10.0.7.53</span><br><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile /data/redis6379/<span class="built_in">log</span>/redis.log</span><br><span class="line">dir /data/redis6379/</span><br><span class="line">databases 16</span><br><span class="line">maxmemory 1g</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p><p>cat /data/redis/etc/redis6380.conf(不同服务器，修改bind对应的ip即可)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pidfile /data/redis6380/<span class="built_in">log</span>/redis.pid</span><br><span class="line"><span class="built_in">bind</span> 10.0.7.53</span><br><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">logfile /data/redis6380/<span class="built_in">log</span>/redis.log</span><br><span class="line">dir /data/redis6380/</span><br><span class="line">databases 16</span><br><span class="line">maxmemory 1g</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p><p>创建指定的文件目录(指定目录不存在，启动会报错)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/redis6379/<span class="built_in">log</span>/</span><br><span class="line">mkdir -p /data/redis6380/<span class="built_in">log</span>/</span><br></pre></td></tr></table></figure></p><h2 id="3、启动redis服务"><a href="#3、启动redis服务" class="headerlink" title="3、启动redis服务"></a>3、启动redis服务</h2><p>3.1启动服务之前，修改内核参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">添加到开机自动启动/etc/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> &gt;&gt; /etc/rc.local</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"vm.overcommit_memory = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">使修改环境变量生效</span><br><span class="line">sysctl vm.overcommit_memory=1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 511 &gt; /proc/sys/net/core/somaxconn</span><br></pre></td></tr></table></figure></p><p>3.2在三个服务器上，分别启动redis服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-server /data/redis/etc/redis6379.conf</span><br><span class="line">/data/redis/src/redis-server /data/redis/etc/redis6380.conf</span><br></pre></td></tr></table></figure></p><h2 id="4、启动成功之后，在指定的dir目录下回生成一个nodes-conf的文件"><a href="#4、启动成功之后，在指定的dir目录下回生成一个nodes-conf的文件" class="headerlink" title="4、启动成功之后，在指定的dir目录下回生成一个nodes.conf的文件"></a>4、启动成功之后，在指定的dir目录下回生成一个nodes.conf的文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">/data/redis6379/nodes.conf</span></span><br><span class="line"><span class="number">4933</span><span class="string">ef69f73b390098a4431449aeef2e83dacfc0</span> <span class="string">:0@0</span> <span class="string">myself,master</span> <span class="bullet">-</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="string">connected</span></span><br><span class="line"><span class="string">vars</span> <span class="string">currentEpoch</span> <span class="number">0</span> <span class="string">lastVoteEpoch</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>该文件记录了节点信息id，不随主机名和端口的改变而改变。</p><h2 id="5、开始配置集群"><a href="#5、开始配置集群" class="headerlink" title="5、开始配置集群"></a>5、开始配置集群</h2><p>5.1配置集群需要安装ruby<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="bullet">-y</span> <span class="string">ruby</span></span><br><span class="line"><span class="string">安装完成之后运行：</span></span><br><span class="line"><span class="string">gem</span> <span class="string">install</span> <span class="string">redis</span></span><br><span class="line"><span class="string">提示报错：</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">Fetching:</span> <span class="string">redis-4.0.1.gem</span> <span class="string">(100%)</span></span><br><span class="line"><span class="attr">ERROR:</span>  <span class="string">Error</span> <span class="string">installing</span> <span class="attr">redis:</span></span><br><span class="line"><span class="string">redis</span> <span class="string">requires</span> <span class="string">Ruby</span> <span class="string">version</span> <span class="string">&gt;=</span> <span class="number">2.2</span><span class="number">.2</span><span class="string">.</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-----------</span></span><br><span class="line"><span class="string">默认yum安装ruby版本为2.0.0，但是安装redis-trib.rb运行的环境，最少需要ruby-2.2.2版本</span></span><br></pre></td></tr></table></figure></p><p>5.2需要先安装rvm，升级ruby版本<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">安装curl：</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">curl</span></span><br><span class="line"><span class="string">安装RVM</span></span><br><span class="line"><span class="string">curl</span> <span class="bullet">-L</span> <span class="string">get.rvm.io</span> <span class="string">| bash -s stable</span></span><br><span class="line"><span class="string">安装如果提示没有public key,按提示在命令行输入信息：</span></span><br><span class="line"><span class="string">shell&gt; gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</span></span><br><span class="line"><span class="string">-----</span></span><br><span class="line"><span class="string"></span><span class="attr">gpg:</span> <span class="string">Can't</span> <span class="string">check</span> <span class="attr">signature:</span> <span class="literal">No</span> <span class="string">public</span> <span class="string">key</span></span><br><span class="line"><span class="string">Warning,</span> <span class="string">RVM</span> <span class="number">1.26</span><span class="number">.0</span> <span class="string">introduces</span> <span class="string">signed</span> <span class="string">releases</span> <span class="string">and</span> <span class="string">automated</span> <span class="string">check</span> <span class="string">of</span> <span class="string">signatures</span> <span class="string">when</span> <span class="string">GPG</span> <span class="string">software</span> <span class="string">found.</span> <span class="string">Assuming</span> <span class="string">you</span> <span class="string">trust</span> <span class="string">Michal</span> <span class="string">Papis</span> <span class="string">import</span> <span class="string">the</span> <span class="string">mpapis</span> <span class="string">public</span> <span class="string">key</span> <span class="string">(downloading</span> <span class="string">the</span> <span class="string">signatures).</span></span><br><span class="line"></span><br><span class="line"><span class="string">GPG</span> <span class="string">signature</span> <span class="string">verification</span> <span class="string">failed</span> <span class="string">for</span> <span class="string">'/usr/local/rvm/archives/rvm-1.29.4.tgz'</span> <span class="bullet">-</span> <span class="string">'https://github.com/rvm/rvm/releases/download/1.29.4/1.29.4.tar.gz.asc'</span><span class="string">!</span> <span class="string">Try</span> <span class="string">to</span> <span class="string">install</span> <span class="string">GPG</span> <span class="string">v2</span> <span class="string">and</span> <span class="string">then</span> <span class="string">fetch</span> <span class="string">the</span> <span class="string">public</span> <span class="attr">key:</span></span><br><span class="line"></span><br><span class="line">    <span class="string">gpg2</span> <span class="bullet">--recv-keys</span> <span class="number">409</span><span class="string">B6B1796C275462A1703113804BB82D39DC0E3</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-----------------------------</span></span><br><span class="line"><span class="string">使rvm环境变量生效</span></span><br><span class="line"><span class="string">source</span> <span class="string">/usr/local/rvm/scripts/rvm</span></span><br><span class="line"><span class="string">查看rvm库中已知的ruby版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">list</span> <span class="string">known</span></span><br><span class="line"><span class="string">安装一个ruby版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">install</span>  <span class="number">2.5</span><span class="number">.1</span></span><br><span class="line"><span class="string">使用一个ruby版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">use</span>  <span class="number">2.5</span><span class="number">.1</span></span><br><span class="line"><span class="string">卸载已安装的旧版本</span></span><br><span class="line"><span class="string">rvm</span> <span class="string">remove</span> <span class="number">2.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">查看版本</span></span><br><span class="line"><span class="string">ruby</span>  <span class="bullet">--version</span></span><br></pre></td></tr></table></figure></p><p>5.3再安装redis就可以了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure></p><p>5.4安装完成之后，执行以下命令创建一个新的集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb create --replicas 1 10.0.7.53:6379 10.0.7.53:6380 10.0.7.50:6379 10.0.7.50:6380 10.0.7.51:6379 10.0.7.51:6380</span><br></pre></td></tr></table></figure><p>–replicas 1：该参数代表为每一个主节点增加一个从节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">[ERR] Sorry, can&apos;t connect to node 10.0.7.53:6379</span><br><span class="line">创建集群报错，确认gem版本没有问题，查看配置文件是否存在requirpass等参数</span><br></pre></td></tr></table></figure><p>重新执行创建集群<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">10.0.7.53:6379</span><br><span class="line">10.0.7.50:6379</span><br><span class="line">10.0.7.51:6379</span><br><span class="line">Adding replica 10.0.7.50:6380 to 10.0.7.53:6379</span><br><span class="line">Adding replica 10.0.7.51:6380 to 10.0.7.50:6379</span><br><span class="line">Adding replica 10.0.7.53:6380 to 10.0.7.51:6379</span><br><span class="line">M: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">S: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   replicates 4933ef69f73b390098a4431449aeef2e83dacfc0</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join...</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6379)</span><br><span class="line">M: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">S: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4933ef69f73b390098a4431449aeef2e83dacfc0</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">----------------------------------</span><br></pre></td></tr></table></figure></p><p>5.5集群安装完成，查看集群状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb check 10.0.7.53:6379</span><br><span class="line">（或者 进入控制台/data/redis/src/redis-cli -h  10.0.7.53，输入 CLUSTER nodes)</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6379)</span><br><span class="line">M: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">S: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4933ef69f73b390098a4431449aeef2e83dacfc0</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br></pre></td></tr></table></figure></p><h2 id="6、集群安装完成，测试集群是否正常运行"><a href="#6、集群安装完成，测试集群是否正常运行" class="headerlink" title="6、集群安装完成，测试集群是否正常运行"></a>6、集群安装完成，测试集群是否正常运行</h2><p>6.1杀掉任意一个主节点，从节点自动切换为主，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb check 10.0.7.53:6380</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6380)</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br></pre></td></tr></table></figure></p><p>6.2重新启动别杀掉的节点之后，该节点自动变为从：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-trib.rb check 10.0.7.53:6380</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.0.7.53:6380)</span><br><span class="line">S: 3f757295e082a5fbe237015862d0a502779f3adf 10.0.7.53:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 3e31b1ceded27ad5b4114beaebb559d7f5ca465d</span><br><span class="line">M: 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4 10.0.7.50:6379</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 4933ef69f73b390098a4431449aeef2e83dacfc0 10.0.7.53:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 5b3aa1532d911e1a9b966ec53e3203a3221056e3</span><br><span class="line">M: 5b3aa1532d911e1a9b966ec53e3203a3221056e3 10.0.7.50:6380</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 30aabebd554d34e59584774feebd472f622f1cc2 10.0.7.51:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 27eb4895dc9369adcd81d9a00709dfbf6fbbd0d4</span><br><span class="line">M: 3e31b1ceded27ad5b4114beaebb559d7f5ca465d 10.0.7.51:6379</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Linux] centos7.4--yum install gcc报错</title>
      <link href="/2018/08/02/centos7.4yum%E5%AE%89%E8%A3%85gcc%E6%8A%A5%E9%94%99/"/>
      <url>/2018/08/02/centos7.4yum%E5%AE%89%E8%A3%85gcc%E6%8A%A5%E9%94%99/</url>
      <content type="html"><![CDATA[<h3 id="yum-install-gcc执行报错如下："><a href="#yum-install-gcc执行报错如下：" class="headerlink" title="[yum install gcc执行报错如下：]"></a>[yum install gcc执行报错如下：]</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Loaded</span> <span class="attr">plugins:</span> <span class="string">fastestmirror,</span> <span class="string">langpacks</span></span><br><span class="line"><span class="string">Loading</span> <span class="string">mirror</span> <span class="string">speeds</span> <span class="string">from</span> <span class="string">cached</span> <span class="string">hostfile</span></span><br><span class="line"><span class="string">Resolving</span> <span class="string">Dependencies</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">gcc.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-28.el7_5.1</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">libgomp</span> <span class="string">=</span> <span class="number">4.8</span><span class="number">.5</span><span class="bullet">-28.</span><span class="string">el7_5.1</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">cpp</span> <span class="string">=</span> <span class="number">4.8</span><span class="number">.5</span><span class="bullet">-28.</span><span class="string">el7_5.1</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc-devel</span> <span class="string">&gt;=</span> <span class="number">2.2</span><span class="number">.90</span><span class="bullet">-12</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">libmpfr.so.4()(64bit)</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">libmpc.so.3()(64bit)</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">gcc-4.8.5-28.el7_5.1.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">cpp.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-28.el7_5.1</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc-devel.x86_64</span> <span class="number">0</span><span class="string">:2.17-222.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc-headers</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-222.</span><span class="string">el7</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-devel-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-222.</span><span class="string">el7</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-devel-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc-headers</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-devel-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">libgomp.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-11.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">updated</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">libgomp.x86_64</span> <span class="number">0</span><span class="string">:4.8.5-28.el7_5.1</span> <span class="string">will</span> <span class="string">be</span> <span class="string">an</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">libmpc.x86_64</span> <span class="number">0</span><span class="string">:1.0.1-3.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">mpfr.x86_64</span> <span class="number">0</span><span class="string">:3.1.1-4.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc.x86_64</span> <span class="number">0</span><span class="string">:2.17-157.el7_3.5</span> <span class="string">will</span> <span class="string">be</span> <span class="string">updated</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc.x86_64</span> <span class="number">0</span><span class="string">:2.17-222.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">an</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc-headers.x86_64</span> <span class="number">0</span><span class="string">:2.17-222.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">kernel-headers</span> <span class="string">&gt;=</span> <span class="number">2.2</span><span class="number">.1</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-headers-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">kernel-headers</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-headers-2.17-222.el7.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Running</span> <span class="string">transaction</span> <span class="string">check</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">glibc.x86_64</span> <span class="number">0</span><span class="string">:2.17-157.el7_3.5</span> <span class="string">will</span> <span class="string">be</span> <span class="string">updated</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Processing</span> <span class="attr">Dependency:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span> <span class="string">for</span> <span class="attr">package:</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--&gt;</span> <span class="string">Package</span> <span class="string">kernel-headers.x86_64</span> <span class="number">0</span><span class="string">:3.10.0-862.9.1.el7</span> <span class="string">will</span> <span class="string">be</span> <span class="string">installed</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-&gt;</span> <span class="string">Finished</span> <span class="string">Dependency</span> <span class="string">Resolution</span></span><br><span class="line"><span class="attr">Error:</span> <span class="attr">Package:</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span> <span class="string">(@CentOS-Updates)</span></span><br><span class="line"><span class="attr">           Requires:</span> <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span></span><br><span class="line"><span class="attr">           Removing:</span> <span class="string">glibc-2.17-157.el7_3.5.x86_64</span> <span class="string">(@CentOS-Updates)</span></span><br><span class="line">               <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-157.</span><span class="string">el7_3.5</span></span><br><span class="line">           <span class="string">Updated</span> <span class="attr">By:</span> <span class="string">glibc-2.17-222.el7.x86_64</span> <span class="string">(base)</span></span><br><span class="line">               <span class="string">glibc</span> <span class="string">=</span> <span class="number">2.17</span><span class="bullet">-222.</span><span class="string">el7</span></span><br><span class="line"> <span class="string">You</span> <span class="string">could</span> <span class="string">try</span> <span class="string">using</span> <span class="bullet">--skip-broken</span> <span class="string">to</span> <span class="string">work</span> <span class="string">around</span> <span class="string">the</span> <span class="string">problem</span></span><br><span class="line"><span class="string">**</span> <span class="string">Found</span> <span class="number">3</span> <span class="string">pre-existing</span> <span class="string">rpmdb</span> <span class="string">problem(s),</span> <span class="string">'yum check'</span> <span class="string">output</span> <span class="attr">follows:</span></span><br><span class="line"><span class="string">glibc-common-2.17-222.el7.x86_64</span> <span class="string">is</span> <span class="string">a</span> <span class="string">duplicate</span> <span class="string">with</span> <span class="string">glibc-common-2.17-157.el7_3.5.x86_64</span></span><br><span class="line"><span class="string">glibc-common-2.17-222.el7.x86_64</span> <span class="string">has</span> <span class="string">missing</span> <span class="string">requires</span> <span class="string">of</span> <span class="string">glibc</span> <span class="string">=</span> <span class="string">('0',</span> <span class="string">'2.17'</span><span class="string">,</span> <span class="string">'222.el7'</span><span class="string">)</span></span><br><span class="line"><span class="string">libgcc-4.8.5-28.el7_5.1.x86_64</span> <span class="string">is</span> <span class="string">a</span> <span class="string">duplicate</span> <span class="string">with</span> <span class="string">libgcc-4.8.5-11.el7.x86_64</span></span><br></pre></td></tr></table></figure><p>产生该问题的主要原因是：在系统upgrade的时候，残存了上一个版本的软件包</p><h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="[解决办法：]"></a>[解决办法：]</h3><p>首先安装 yum-utils 套件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br></pre></td></tr></table></figure></p><p>执行clean duplicate package　　<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package-cleanup --cleandupes</span><br></pre></td></tr></table></figure></p><p>重新安装glibc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum reinstall glibc glibc-common libgcc</span><br></pre></td></tr></table></figure></p><p>安装完成之后再安装gcc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Redis] redis-sentinel集群配置（一主两从三哨兵）</title>
      <link href="/2018/08/01/redis-sentinel%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE(%E4%B8%80%E4%B8%BB%E4%B8%A4%E4%BB%8E%E4%B8%89%E5%93%A8%E5%85%B5)/"/>
      <url>/2018/08/01/redis-sentinel%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE(%E4%B8%80%E4%B8%BB%E4%B8%A4%E4%BB%8E%E4%B8%89%E5%93%A8%E5%85%B5)/</url>
      <content type="html"><![CDATA[<h1 id="1、所有节点安装redis"><a href="#1、所有节点安装redis" class="headerlink" title="1、所有节点安装redis"></a>1、所有节点安装redis</h1><p>节点信息：<br>主1：10.0.7.53<br>从2：10.0.7.50<br>从3：10.0.7.51<br>除了在三个节点部署redis服务，再分别部署sentinel。</p><h1 id="2、配置主从，在主节点配置文件添加如下配置："><a href="#2、配置主从，在主节点配置文件添加如下配置：" class="headerlink" title="2、配置主从，在主节点配置文件添加如下配置："></a>2、配置主从，在主节点配置文件添加如下配置：</h1><p>主节点1配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pidfile</span> <span class="string">/data/redis/log/redis.pid</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span></span><br><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">daemonize</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">logfile</span> <span class="string">"/data/redis/log/redis.log"</span></span><br><span class="line"><span class="string">databases</span> <span class="number">16</span></span><br><span class="line"><span class="string">maxmemory</span> <span class="number">1</span><span class="string">g</span></span><br><span class="line"><span class="string">requirepass</span> <span class="number">123456</span></span><br><span class="line"><span class="string">masterauth</span> <span class="number">123456</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"><span class="string">repl-ping-slave-period</span> <span class="number">10</span></span><br><span class="line"><span class="string">repl-timeout</span> <span class="number">60</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-backlog-size</span> <span class="number">5</span><span class="string">mb</span></span><br><span class="line"><span class="string">repl-backlog-ttl</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p><p>从节点2配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pidfile</span> <span class="string">/data/redis/log/redis.pid</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.50</span></span><br><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">daemonize</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">logfile</span> <span class="string">"/data/redis/log/redis.log"</span></span><br><span class="line"><span class="string">databases</span> <span class="number">16</span></span><br><span class="line"><span class="string">maxmemory</span> <span class="number">1</span><span class="string">g</span></span><br><span class="line"><span class="string">slaveof</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span> <span class="number">6379</span></span><br><span class="line"><span class="string">masterauth</span> <span class="number">123456</span></span><br><span class="line"><span class="string">requirepass</span> <span class="number">123456</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"><span class="string">repl-ping-slave-period</span> <span class="number">10</span></span><br><span class="line"><span class="string">repl-timeout</span> <span class="number">60</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-backlog-size</span> <span class="number">5</span><span class="string">mb</span></span><br><span class="line"><span class="string">repl-backlog-ttl</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p><p>从节点3配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pidfile</span> <span class="string">/data/redis/log/redis.pid</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.50</span></span><br><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">daemonize</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">logfile</span> <span class="string">"/data/redis/log/redis.log"</span></span><br><span class="line"><span class="string">databases</span> <span class="number">16</span></span><br><span class="line"><span class="string">maxmemory</span> <span class="number">1</span><span class="string">g</span></span><br><span class="line"><span class="string">slaveof</span> <span class="number">10.0</span><span class="number">.7</span><span class="number">.53</span> <span class="number">6379</span></span><br><span class="line"><span class="string">masterauth</span> <span class="number">123456</span></span><br><span class="line"><span class="string">requirepass</span> <span class="number">123456</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"><span class="string">repl-ping-slave-period</span> <span class="number">10</span></span><br><span class="line"><span class="string">repl-timeout</span> <span class="number">60</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"><span class="string">repl-backlog-size</span> <span class="number">5</span><span class="string">mb</span></span><br><span class="line"><span class="string">repl-backlog-ttl</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p><p>上面配置相关参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制选项，slave复制对应的master。</span></span><br><span class="line"><span class="string">slaveof</span> <span class="string">&lt;masterip&gt;</span> <span class="string">&lt;masterport&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果master设置了requirepass，那么slave要连上master，需要有master的密码才行。masterauth就是用来配置master的密码，这样可以在连上master后进行认证。</span></span><br><span class="line"><span class="string">masterauth</span> <span class="string">&lt;master-password&gt;</span></span><br><span class="line"><span class="bullet">   -</span><span class="bullet">------------------------------------</span></span><br><span class="line">   <span class="string">如果主库配置了密码，从库没有添加这行数据，会报一下错误：</span></span><br><span class="line">   <span class="comment"># Unexpected reply to PSYNC from master: -NOAUTH Authentication required.</span></span><br><span class="line">   <span class="string">*</span> <span class="string">Retrying</span> <span class="string">with</span> <span class="string">SYNC...</span></span><br><span class="line">   <span class="comment"># MASTER aborted replication with an error: NOAUTH Authentication required.</span></span><br><span class="line"><span class="bullet">   -</span><span class="bullet">------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：1) 如果slave-serve-stale-data设置为yes(默认设置)，从库会继续响应客户端的请求。2) 如果slave-serve-stale-data设置为no，除去INFO和SLAVOF命令之外的任何请求都会返回一个错误”SYNC with master in progress”。</span></span><br><span class="line"><span class="string">slave-serve-stale-data</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#作为从服务器，默认情况下是只读的（yes），可以修改成NO，用于写（不建议）。</span></span><br><span class="line"><span class="string">slave-read-only</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否使用socket方式复制数据。目前redis复制提供两种方式，disk和socket。如果新的slave连上来或者重连的slave无法部分同步，就会执行全量同步，master会生成rdb文件。有2种方式：disk方式是master创建一个新的进程把rdb文件保存到磁盘，再把磁盘上的rdb文件传递给slave。socket是master创建一个新的进程，直接把rdb文件以socket的方式发给slave。disk方式的时候，当一个rdb保存的过程中，多个slave都能共享这个rdb文件。socket的方式就的一个个slave顺序复制。在磁盘速度缓慢，网速快的情况下推荐用socket方式。</span></span><br><span class="line"><span class="string">repl-diskless-sync</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#diskless复制的延迟时间，防止设置为0。一旦复制开始，节点不会再接收新slave的复制请求直到下一个rdb传输。所以最好等待一段时间，等更多的slave连上来。</span></span><br><span class="line"><span class="string">repl-diskless-sync-delay</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#slave根据指定的时间间隔向服务器发送ping请求。时间间隔可以通过 repl_ping_slave_period 来设置，默认10秒。</span></span><br><span class="line"><span class="comment"># repl-ping-slave-period 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#复制连接超时时间。master和slave都有超时时间的设置。master检测到slave上次发送的时间超过repl-timeout，即认为slave离线，清除该slave信息。slave检测到上次和master交互的时间超过repl-timeout，则认为master离线。需要注意的是repl-timeout需要设置一个比repl-ping-slave-period更大的值，不然会经常检测到超时。</span></span><br><span class="line"><span class="comment"># repl-timeout 60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#是否禁止复制tcp链接的tcp nodelay参数，可传递yes或者no。默认是no，即使用tcp nodelay。如果master设置了yes来禁止tcp nodelay设置，在把数据复制给slave的时候，会减少包的数量和更小的网络带宽。但是这也可能带来数据的延迟。默认我们推荐更小的延迟，但是在数据量传输很大的场景下，建议选择yes。</span></span><br><span class="line"><span class="string">repl-disable-tcp-nodelay</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#复制缓冲区大小，这是一个环形复制缓冲区，用来保存最新复制的命令。这样在slave离线的时候，不需要完全复制master的数据，如果可以执行部分同步，只需要把缓冲区的部分数据复制给slave，就能恢复正常复制状态。缓冲区的大小越大，slave离线的时间可以更长，复制缓冲区只有在有slave连接的时候才分配内存。没有slave的一段时间，内存会被释放出来，默认1m。</span></span><br><span class="line"><span class="comment"># repl-backlog-size 5mb</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master没有slave一段时间会释放复制缓冲区的内存，repl-backlog-ttl用来设置该时间长度。单位为秒。</span></span><br><span class="line"><span class="comment"># repl-backlog-ttl 3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当master不可用，Sentinel会根据slave的优先级选举一个master。最低的优先级的slave，当选master。而配置成0，永远不会被选举。</span></span><br><span class="line"><span class="string">slave-priority</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#redis提供了可以让master停止写入的方式，如果配置了min-slaves-to-write，健康的slave的个数小于N，mater就禁止写入。master最少得有多少个健康的slave存活才能执行写命令。这个配置虽然不能保证N个slave都一定能接收到master的写操作，但是能避免没有足够健康的slave的时候，master不能写入来避免数据丢失。设置为0是关闭该功能。</span></span><br><span class="line"><span class="comment"># min-slaves-to-write 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#延迟小于min-slaves-max-lag秒的slave才认为是健康的slave。</span></span><br><span class="line"><span class="comment"># min-slaves-max-lag 10</span></span><br></pre></td></tr></table></figure></p><h1 id="3、修改哨兵配置文件"><a href="#3、修改哨兵配置文件" class="headerlink" title="3、修改哨兵配置文件"></a>3、修改哨兵配置文件</h1><p>cat sentinel.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">dir <span class="string">"/tmp/sentinel"</span></span><br><span class="line">logfile <span class="string">"/tmp/sentinel.log"</span></span><br><span class="line">daemonize yes</span><br><span class="line">sentinel monitor mymaster 10.0.7.53 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel config-epoch mymaster 2</span><br><span class="line">sentinel leader-epoch mymaster 2</span><br><span class="line">sentinel known-slave mymaster 10.0.7.51 6379</span><br><span class="line">sentinel known-slave mymaster 10.0.7.50 6379</span><br><span class="line">sentinel current-epoch 2</span><br><span class="line">protected-mode no</span><br></pre></td></tr></table></figure></p><p>指定的dir路径若不存在需要手动创建：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/sentinel</span><br></pre></td></tr></table></figure></p><p>sentinel相关配置参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sentinel monitor mymaster 10.0.7.53 6379 2</span></span><br><span class="line"><span class="string">//</span> <span class="string">当前Sentinel节点监控</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:6379</span> <span class="string">这个主节点</span></span><br><span class="line"><span class="string">//</span> <span class="number">2</span><span class="string">代表判断主节点失败至少需要2个Sentinel节点节点同意</span></span><br><span class="line"><span class="string">//</span> <span class="string">mymaster是主节点的别名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel down-after-milliseconds mymaster 30000</span></span><br><span class="line"><span class="string">//每个Sentinel节点都要定期PING命令来判断Redis数据节点和其余Sentinel节点是否可达，如果超过30000毫秒且没有回复，则判定不可达</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel parallel-syncs mymaster 1</span></span><br><span class="line"><span class="string">//当Sentinel节点集合对主节点故障判定达成一致时，Sentinel领导者节点会做故障转移操作，选出新的主节点，原来的从节点会向新的主节点发起复制操作，限制每次向新的主节点发起复制操作的从节点个数为1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel failover-timeout mymaster 180000</span></span><br><span class="line"><span class="string">//故障转移超时时间为180000毫秒</span></span><br></pre></td></tr></table></figure></p><h1 id="4、启动服务"><a href="#4、启动服务" class="headerlink" title="4、启动服务"></a>4、启动服务</h1><p>各服务器启动redis服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-server /data/redis/etc/redis.conf</span><br></pre></td></tr></table></figure></p><p>各服务器启动sentinel服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-sentinel /data/redis/sentinel.conf</span><br></pre></td></tr></table></figure></p><p>查看集群信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/src/redis-cli -h 127.0.0.1 -p 26379 INFO Sentinel</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>[Python] python-2.7升级到python-3.7</title>
      <link href="/2018/07/30/python-2.7%E5%8D%87%E7%BA%A7%E5%88%B0python-3.7/"/>
      <url>/2018/07/30/python-2.7%E5%8D%87%E7%BA%A7%E5%88%B0python-3.7/</url>
      <content type="html"><![CDATA[<h1 id="下载、解压python3-7"><a href="#下载、解压python3-7" class="headerlink" title="[下载、解压python3.7]"></a>[下载、解压python3.7]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tar.xz</span><br><span class="line">tar -xvf Python-3.7.0.tar.xz</span><br></pre></td></tr></table></figure><h1 id="安装编译"><a href="#安装编译" class="headerlink" title="[安装编译]"></a>[安装编译]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Python-3.7.0/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python3.7</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h1 id="安装报错"><a href="#安装报错" class="headerlink" title="[安装报错]"></a>[安装报错]</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ModuleNotFoundError:</span> <span class="literal">No</span> <span class="string">module</span> <span class="string">named</span> <span class="string">'_ctypes'</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">***</span> <span class="string">[install]</span> <span class="string">Error</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>解决方法：<br> 安装libffi-devel<br> yum install libffi-devel<br> 重新编译安装<br> make &amp;&amp; make install</p><h1 id="备份旧版本的python"><a href="#备份旧版本的python" class="headerlink" title="[备份旧版本的python]"></a>[备份旧版本的python]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ll /usr/bin/python*</span><br><span class="line">lrwxrwxrwx. 1 root root    7 Apr 10 19:35 /usr/bin/python -&gt; python2</span><br><span class="line">lrwxrwxrwx. 1 root root    9 Apr 10 19:35 /usr/bin/python2 -&gt; python2.7</span><br><span class="line">-rwxr-xr-x. 1 root root 7136 Aug  4  2017 /usr/bin/python2.7</span><br><span class="line">-------------------------</span><br><span class="line">一般自带系统已经做好了python2.7的备份，直接替换掉python即可</span><br><span class="line"></span><br><span class="line">如果没有备份，使用一些命令备份：</span><br><span class="line">mv /usr/bin/python /usr/bin/python_old  <span class="comment">#备份旧的python</span></span><br></pre></td></tr></table></figure><h1 id="新版本python软连接到python"><a href="#新版本python软连接到python" class="headerlink" title="[新版本python软连接到python]"></a>[新版本python软连接到python]</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/bin/python <span class="comment">#需要删除旧版的python,否则报错</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/python3.7/bin/python3.7 /usr/bin/python <span class="comment">#添加软连接</span></span><br><span class="line">python -V <span class="comment">#查看python版本</span></span><br><span class="line">2.7版本没有pip,升级到python3.7后，自带有pip,做一个pip的软连接即可</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/python3.7/bin/pip3 /usr/bin/pip</span><br></pre></td></tr></table></figure><h1 id="升级完python之后，yum命令失效，需修改配置文件"><a href="#升级完python之后，yum命令失效，需修改配置文件" class="headerlink" title="[升级完python之后，yum命令失效，需修改配置文件]"></a>[升级完python之后，yum命令失效，需修改配置文件]</h1><p>使用yum命令报以下错误：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span></span><br><span class="line">  <span class="string">File</span> <span class="string">"/usr/bin/yum"</span><span class="string">,</span> <span class="string">line</span> <span class="number">30</span></span><br><span class="line">    <span class="string">except</span> <span class="string">KeyboardInterrupt,</span> <span class="attr">e:</span></span><br><span class="line">                            <span class="string">^</span></span><br><span class="line"><span class="attr">SyntaxError:</span> <span class="string">invalid</span> <span class="string">syntax</span></span><br></pre></td></tr></table></figure></p><p>解决 yum 不可用：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">修改/usr/bin/yum配置文件</span></span><br><span class="line"><span class="comment">#!/usr/bin/python    改成：    #!/usr/bin/python2.7</span></span><br><span class="line"><span class="string">重新测试yum是否正常：</span></span><br><span class="line"><span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span></span><br></pre></td></tr></table></figure></p><h1 id="升级完python之后，yum使用过程中，额外问题："><a href="#升级完python之后，yum使用过程中，额外问题：" class="headerlink" title="[升级完python之后，yum使用过程中，额外问题：]"></a>[升级完python之后，yum使用过程中，额外问题：]</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">tree</span> <span class="bullet">-y</span> </span><br><span class="line"><span class="bullet">-</span><span class="bullet">---------------------------------</span></span><br><span class="line"><span class="string">报错：</span></span><br><span class="line"><span class="string">File</span> <span class="string">"/usr/libexec/urlgrabber-ext-down"</span><span class="string">,</span> <span class="string">line</span> <span class="number">28</span></span><br><span class="line">    <span class="string">except</span> <span class="string">OSError,</span> <span class="attr">e:</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--------------------------------</span></span><br></pre></td></tr></table></figure><p>解决方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">修改/usr/libexec/urlgrabber-ext-down配置文件</span><br><span class="line"><span class="comment">#!/usr/bin/python    改成：    #!/usr/bin/python2.7</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
  
  
    
    <entry>
      <title>tags</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      <content type="html"><![CDATA[]]></content>
    </entry>
    
    <entry>
      <title>About Me</title>
      <link href="/about/index.html"/>
      <url>/about/index.html</url>
      <content type="html"><![CDATA[<blockquote><p>愿你被这个世界温柔以待，即使生活总以刻薄荒芜相欺！</p></blockquote>]]></content>
    </entry>
    
  
</search>
