<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 8 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/27/zabbix-agent批量安装/"><span>[Zabbix] zabbix-agent批量安装配置</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/27/zabbix-agent批量安装/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-27T12:09:00.000Z">
          2018-08-27
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible"><a href="#0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible" class="headerlink" title="0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible"></a>0、本文批量安装使用ansible加shell脚本的方法，首先安装ansible</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure>
<h2 id="1、修改ansible-server端免交互登录"><a href="#1、修改ansible-server端免交互登录" class="headerlink" title="1、修改ansible-server端免交互登录"></a>1、修改ansible-server端免交互登录</h2><p>cat /etc/ssh/ssh_config<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StrictHostKeyChecking no</span><br><span class="line">UserKnownHostsFile /dev/null</span><br></pre></td></tr></table></figure></p>
<p>修改好配置后，重新启动sshd服务即可，命令为：/etc/init.d/sshd restart （或 service sshd restart 或/bin/systemctl restart  sshd.service）</p>
<h2 id="2、编辑-etc-ansible-hosts主机配置文件"><a href="#2、编辑-etc-ansible-hosts主机配置文件" class="headerlink" title="2、编辑/etc/ansible/hosts主机配置文件"></a>2、编辑/etc/ansible/hosts主机配置文件</h2><p>cat /etc/ansible/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[test]</span><br><span class="line">172.29.25.196   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos </span><br><span class="line">172.29.16.6   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos</span><br><span class="line">172.29.20.97   ansible_ssh_private_key_file=/root/test ansible_ssh_user=centos</span><br></pre></td></tr></table></figure></p>
<p>hosts文件使用参数详解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible_ssh_host   #用于指定被管理的主机的真实IP</span><br><span class="line">ansible_ssh_port   #用于指定连接到被管理主机的ssh端口号，默认是22</span><br><span class="line">ansible_ssh_user   #ssh连接时默认使用的用户名</span><br><span class="line">ansible_ssh_pass   #ssh连接时的密码</span><br><span class="line">ansible_sudo_pass  #使用sudo连接用户时的密码</span><br><span class="line">ansible_sudo_exec  #如果sudo命令不在默认路径，需要指定sudo命令路径 </span><br><span class="line">ansible_ssh_private_key_file #秘钥文件路径，秘钥文件如果不想使用ssh-agent管理时可以使用此选项 </span><br><span class="line">ansible_shell_type          #目标系统的shell的类型，默认sh </span><br><span class="line">ansible_connection         #SSH 连接的类型： local , ssh , paramiko，在 ansible 1.2 之前默认是 paramiko ，后来智能选择，优先使用基于 ControlPersist 的 ssh(支持的前提)</span><br><span class="line">ansible_python_interpreter  #用来指定python解释器的路径，默认为/usr/bin/python 同样可以指定ruby 、perl 的路径 </span><br><span class="line">ansible_*_interpreter     #其他解释器路径，用法和ansible_python_interpreter类似，这里&quot;*&quot;可以是ruby或才perl等其他语言</span><br></pre></td></tr></table></figure></p>
<p>上例中使用的是私钥和用户名，如果想要使用执行端口，密码，用户名可参考上面详解参数。</p>
<h2 id="3、编辑批量上传脚本"><a href="#3、编辑批量上传脚本" class="headerlink" title="3、编辑批量上传脚本"></a>3、编辑批量上传脚本</h2><p>cat /etc/ansible/scopy-test-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix to all hosts</span><br><span class="line">    copy: src=&quot;/root/zabbix-3.4.2.tar.gz&quot; dest=&quot;/home/centos/zabbix-3.4.2.tar.gz&quot;</span><br><span class="line">  - name: scopy zabbix-agent config to all hosts</span><br><span class="line">    copy: src=&quot;/home/centos/execute-zabbix.sh&quot; dest=&quot;/home/centos/execute-zabbix.sh&quot;</span><br></pre></td></tr></table></figure></p>
<p>src:代表本机的源文件，dest代表目标端的路径<br>hosts：要与/etc/ansible/hosts下的[test]保持一致。</p>
<p>execute-zabbix.sh脚本为安装zabbix-agent脚本<br>cat /home/centos/execute-zabbix.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"> mkdir /home/zabbix</span><br><span class="line"> useradd -r -s /sbin/nologin zabbix</span><br><span class="line"> yum -y install gcc gcc-c++ pcre-devel openssl-devel</span><br><span class="line"> mv /home/centos/zabbix-3.4.2.tar.gz /home/zabbix/</span><br><span class="line">cd /home/zabbix</span><br><span class="line"> tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line"> /home/zabbix/zabbix-3.4.2/configure --prefix=/usr/local/zabbix --enable-agent  --with-openssl </span><br><span class="line"> make </span><br><span class="line"> make install</span><br><span class="line">#host1=`ifconfig eth0 |awk -F &apos;[ :]+&apos; &apos;NR==2 &#123;print $3&#125;&apos;`</span><br><span class="line">host1=`ip addr |grep dynamic |awk &apos;&#123;print $2&#125;&apos;|awk -F&apos;/&apos; &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">echo &quot;LogFile=/tmp/zabbix_agentd.log</span><br><span class="line">Server=172.29.12.85</span><br><span class="line">ServerActive=172.29.12.85</span><br><span class="line">Hostname=$host1&quot;&gt; /usr/local/zabbix/etc/zabbix_agentd.conf</span><br><span class="line"></span><br><span class="line">cp /home/zabbix/zabbix-3.4.2/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/         </span><br><span class="line">ln -s /usr/local/zabbix/etc/zabbix_agentd.conf /usr/local/etc/zabbix_agentd.conf</span><br><span class="line">sed -i &apos;s/BASEDIR=\/usr\/local/BASEDIR=\/usr\/local\/zabbix/g&apos; /etc/init.d/zabbix_agentd</span><br><span class="line">service zabbix_agentd start</span><br><span class="line">chkconfig --add zabbix_agentd</span><br><span class="line">chkconfig --level 35 zabbix_agentd on                                                  </span><br><span class="line">netstat -lnpt | grep zabbix_agent</span><br></pre></td></tr></table></figure></p>
<p>server端的ip地址根据自己的zabbix-proxy或者zabbix-server自行定义。</p>
<p>执行批量脚本将文件上传到目标端：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-test-zabbix.sh</span><br></pre></td></tr></table></figure></p>
<p>在ansible-server端执行批量安装脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/execute-zabbix.sh&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端"><a href="#4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端" class="headerlink" title="4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端"></a>4、编辑查看zabbix-agent进程的脚本，并批量上传到被监控端</h2><p>编辑检查zabbix-agent进程脚本<br>cat /home/centos/check-zabbix-port.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">netstat -tunlp |grep 10050</span><br></pre></td></tr></table></figure></p>
<p>编辑批量上传脚本<br>cat /etc/ansible/scopy-test-check-zabbixport.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">  remote_user: centos</span><br><span class="line">  tasks:</span><br><span class="line">  - name: scopy zabbix-check-port to all hosts</span><br><span class="line">    copy: src=&quot;/home/centos/check-zabbix-port.sh&quot; dest=&quot;/home/centos/check-zabbix-port.sh&quot;</span><br></pre></td></tr></table></figure></p>
<p>执行批量上传脚本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook /etc/ansible/scopy-test-check-zabbixport.sh</span><br></pre></td></tr></table></figure></p>
<p>在ansible-server服务端执行检查脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m command -a &apos;sudo sh /home/centos/check-zabbix-port.sh&apos;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/27/zabbix-agent批量安装/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/27/zabbix-server安装配置/"><span>[Zabbix] zabbix-server安装配置</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/27/zabbix-server安装配置/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-27T08:57:24.000Z">
          2018-08-27
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包："><a href="#0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包：" class="headerlink" title="0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包："></a>0、安装zabbix-server之前需要把server依赖环境lnmp安装完成，首先安装依赖包：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall &quot;Development tools&quot;  </span><br><span class="line">yum -y install gcc gcc-c++ cmake autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers pcre-devel libaio  openssl openssl-devel</span><br></pre></td></tr></table></figure>
<h4 id="1、上传nginx软件包到服务器，如果没有可点击此处下载"><a href="#1、上传nginx软件包到服务器，如果没有可点击此处下载" class="headerlink" title="1、上传nginx软件包到服务器，如果没有可点击此处下载"></a>1、上传nginx软件包到服务器，如果没有可点击此处<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">下载</a></h4><p>创建nginx用户，创建nginx安装目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd nginx -s /sbin/nologin -M   </span><br><span class="line">mkdir /data/soft</span><br></pre></td></tr></table></figure></p>
<p>解压安装包、编译安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.9.15.tar.gz</span><br><span class="line">cd nginx-1.9.15</span><br><span class="line">./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_stub_status_module --with-http_ssl_module  </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>检查语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure></p>
<p>启动nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure></p>
<p>查看进程是否正常启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tunlp|grep nginx</span><br></pre></td></tr></table></figure></p>
<p>关闭nginx服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br></pre></td></tr></table></figure></p>
<h4 id="2、Mysql数据库安装"><a href="#2、Mysql数据库安装" class="headerlink" title="2、Mysql数据库安装"></a>2、Mysql数据库安装</h4><p>下载mysql数据库(可自行下载自己喜欢的版本）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>添加用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd mysql -s /sbin/nologin -M</span><br></pre></td></tr></table></figure></p>
<p>解压、重命名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz </span><br><span class="line">mv mysql-5.7.18-linux-glibc2.5-x86_64 /application/mysql</span><br></pre></td></tr></table></figure></p>
<p>改变权限权限、初始化,初始化过程中会默认生成随机密码，记录以便后面更改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql /data/mysql/ </span><br><span class="line">/data/mysql/bin/mysqld --initialize --user=mysql --basedir=/data/mysql/ --datadir=/data/mysql/data/</span><br><span class="line">/data/mysql/bin/mysql_ssl_rsa_setup --datadir=/data/mysql/data/</span><br></pre></td></tr></table></figure></p>
<p>修改配置文件<br>cat /data/mysql/support-files/my_default.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line">server_id = 1</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">basedir =/data/mysql/</span><br><span class="line">datadir =/data/mysql/data/</span><br><span class="line">character-set-server=utf8</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br></pre></td></tr></table></figure></p>
<p>配合mysql启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp my_default.cnf /etc/my.cnf</span><br><span class="line">cp mysql.server /etc/init.d/mysqld</span><br><span class="line">chmod 755 /etc/init.d/mysqld</span><br></pre></td></tr></table></figure></p>
<p>修改/etc/init.d/mysqld，文件数据和安装路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">basedir=/data/mysql/</span><br><span class="line">datadir=/dadta/mysql/data/</span><br></pre></td></tr></table></figure></p>
<p>启动mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p>
<p>修改mysql密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u  root -p</span><br><span class="line">set password=password(&apos;root&apos;);</span><br><span class="line">grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;root&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、安装php服务"><a href="#3、安装php服务" class="headerlink" title="3、安装php服务"></a>3、安装php服务</h4><p>安装依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zlib libxml2 libjpeg freetype libpng gd curl libiconv  zlib-devel libxml2-devel libjpeg-devel freetype-devel libpng-devel gd-devel curl-devel openssl-devel libxslt-devel libxslt*</span><br></pre></td></tr></table></figure></p>
<p>安装libiconv,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libiconv-1.14.tar.gz </span><br><span class="line">cd libiconv-1.14</span><br><span class="line">./configure --prefix=/usr/local/libiconv   </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>报错：<br>./stdio.h:1010:1: error: ‘gets’ undeclared here (not in a function)<br>_GL_WARN_ON_USE (gets, “gets is a security hole - use fgets instead”);</p>
<p>vi srclib/stdio.in.h文件，接着搜索到在698行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_GL_WARN_ON_USE (gets, “gets is a security hole - use fgets instead”);</span><br></pre></td></tr></table></figure></p>
<p>这一行，然后把这个替换成下面三行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if defined(__GLIBC__) &amp;&amp; !defined(__UCLIBC__) &amp;&amp; !__GLIBC_PREREQ(2, 16)</span><br><span class="line">_GL_WARN_ON_USE (gets, &quot;gets is a security hole - use fgets instead&quot;);</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></p>
<p>安装Libmcrypt,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libmcrypt-2.5.8.tar.gz </span><br><span class="line">cd libmcrypt-2.5.8</span><br><span class="line">./configure   </span><br><span class="line">make &amp;&amp; make install   </span><br><span class="line"></span><br><span class="line">/sbin/ldconfig   </span><br><span class="line">cd libltdl/   </span><br><span class="line">./configure --enable-ltdl-install   </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ../../</span><br></pre></td></tr></table></figure></p>
<p>安装mhash,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mhash-0.9.9.9.tar.gz </span><br><span class="line">cd mhash-0.9.9.9</span><br><span class="line">./configure   </span><br><span class="line">make &amp;&amp; make install </span><br><span class="line">cd ../   </span><br><span class="line">rm -f /usr/lib64/libmcrypt.*   </span><br><span class="line">rm -f /usr/lib64/libmhash*   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.la /usr/lib64/libmcrypt.la   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.so /usr/lib64/libmcrypt.so   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.so.4 /usr/lib64/libmcrypt.so.4   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt.so.4.4.8 /usr/lib64/libmcrypt.so.4.4.8   </span><br><span class="line">ln -s /usr/local/lib/libmhash.a /usr/lib64/libmhash.a   </span><br><span class="line">ln -s /usr/local/lib/libmhash.la /usr/lib64/libmhash.la   </span><br><span class="line">ln -s /usr/local/lib/libmhash.so /usr/lib64/libmhash.so   </span><br><span class="line">ln -s /usr/local/lib/libmhash.so.2 /usr/lib64/libmhash.so.2   </span><br><span class="line">ln -s /usr/local/lib/libmhash.so.2.0.1 /usr/lib64/libmhash.so.2.0.1   </span><br><span class="line">ln -s /usr/local/lib/libmcrypt-config /usr/lib/libmcrypt-config</span><br></pre></td></tr></table></figure></p>
<p>安装mcrypt,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -xf mcrypt-2.6.8.tar.gz   </span><br><span class="line">cd mcrypt-2.6.8/</span><br><span class="line">/sbin/ldconfig   </span><br><span class="line">./configure LD_LIBRARY=/usr/local/lib &amp;&amp; make &amp;&amp;make install   </span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure></p>
<p>安装php,下载<a href="https://pan.baidu.com/s/1SH5TujhLgN9EkjjWI97gQQ" target="_blank" rel="noopener">链接</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf php-5.6.11.tar.gz </span><br><span class="line">cd php-5.6.11</span><br><span class="line"></span><br><span class="line">修改mysql路径对应为自己的mysql安装路径</span><br><span class="line">./configure --prefix=/usr/local/php --with-mysql=/data/mysql --with-iconv-dir=/usr/local/libiconv --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl  --enable-mbregex --enable-fpm --enable-mbstring --with-mcrypt --with-gd --enable-gd-native-ttf --with-openssl --with-mhash --enable-pcntl --enable-sockets --with-xmlrpc --enable-zip --enable-soap --enable-short-tags --enable-static --with-xsl --with-fpm-user=nginx --with-fpm-group=nginx --enable-ftp --enable-pdo --with-pdo-mysql  --enable-opcache=no</span><br><span class="line">make &amp;&amp; make install </span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure></p>
<p>安装过程提示缺少mysqlclient包的问题，根据版本差异执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /data/mysql/lib/libmysqlclient.so.18 /usr/lib64/</span><br><span class="line">或者</span><br><span class="line">ln -s /data/mysql/lib/libmysqlclient.so.20 /usr/lib64/</span><br></pre></td></tr></table></figure></p>
<p>缺少phar.phar文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chmod: cannot access `ext/phar/phar.phar&apos;: No such file or directory</span><br><span class="line">make: [ext/phar/phar.phar] Error 1 (ignored)</span><br><span class="line"></span><br><span class="line">Build complete.</span><br><span class="line">Don&apos;t forget to run &apos;make test&apos;.</span><br><span class="line"></span><br><span class="line">解决方法</span><br><span class="line">#cd  ext/phar/</span><br><span class="line">#cp ./phar.php  ./phar.phar</span><br></pre></td></tr></table></figure></p>
<p>配置文件（php.ini和php-fpm）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">需要把php.ini文件放到lib下面，放到etc下面不生效：</span><br><span class="line">cp /data/soft/php-5.6.11/php.ini-production /usr/local/php/lib/php.ini</span><br><span class="line">cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf</span><br></pre></td></tr></table></figure></p>
<p>检查语法、启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/php/sbin/php-fpm -t </span><br><span class="line">/usr/local/php/sbin/php-fpm</span><br><span class="line">cp  /data/soft/php-5.6.11/sapi/fpm/init.d.php-fpm  /etc/init.d/php-fpm</span><br><span class="line">chmod a+x /etc/init.d/php-fpm</span><br><span class="line">加入开机启动</span><br><span class="line">chkconfig --add php-fpm</span><br><span class="line">chkconfig --level 35 php-fpm on</span><br><span class="line">启动 php-fpm</span><br><span class="line">service php-fpm start</span><br><span class="line">netstat -anpt | grep php-fpm</span><br><span class="line">停止 php-fpm</span><br><span class="line">service php-fpm stop</span><br></pre></td></tr></table></figure></p>
<h4 id="4、配置nginx使其支持php"><a href="#4、配置nginx使其支持php" class="headerlink" title="4、配置nginx使其支持php"></a>4、配置nginx使其支持php</h4><p>cat /usr/local/nginx/conf/nginx.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name localhost;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">root html;</span><br><span class="line">index index.php index.html index.htm;                               # 加入 index.php</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ \.php$ &#123; # 整段注释去掉</span><br><span class="line">root html;</span><br><span class="line">fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME /usr/local/nginx/html$fastcgi_script_name;                          # 修改为自己的根目录</span><br><span class="line">include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建测试页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;?php phpinfo(); ?&gt;"</span> &gt; /usr/<span class="built_in">local</span>/nginx/html/info.php</span><br></pre></td></tr></table></figure></p>
<p>重启 Nginx 、php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service php-fpm stop</span><br><span class="line">service php-fpm start</span><br><span class="line">nginx -s stop</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure></p>
<p>浏览器访问测试页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost/info.php</span><br></pre></td></tr></table></figure></p>
<h4 id="5、安装zabbix-server"><a href="#5、安装zabbix-server" class="headerlink" title="5、安装zabbix-server"></a>5、安装zabbix-server</h4><p>下载安装包<br>wget <a href="https://jaist.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.0.3/zabbix-4.0.3.tar.gz" target="_blank" rel="noopener">https://jaist.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.0.3/zabbix-4.0.3.tar.gz</a><br>安装依赖包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntpdate net-snmp net-snmp-devel libcurl-devel libevent-devel</span><br></pre></td></tr></table></figure></p>
<p>设置zabbix用户，编译安装zabbix<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">tar -zxvf zabbix-4.0.3.tar.gz</span><br><span class="line">cd zabbix-4.0.3</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-libxml2 --with-openssl</span><br><span class="line"></span><br><span class="line"># --prefix  指定安装路径</span><br><span class="line"># --enable-server  安装 Server 端</span><br><span class="line"># --enable-agent  安装 Agent 端</span><br><span class="line"># --with-mysql  使用 Mysql 数据库</span><br><span class="line"># --with-net-snmp  支持 SNMP 协议</span><br><span class="line"># --with-libcurl  支持 libcurl URL 监控</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>mysql数据库添加zabbix初始化数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database zabbixDB character set utf8;                                    # 创建 zabbixDB 并设置编码为 utf8</span><br><span class="line">mysql&gt; grant all on zabbixDB.* to &apos;zabbix&apos;@&apos;%&apos; identified by &apos;zabbix&apos;;                 # 建立授权用户</span><br><span class="line">mysql&gt; flush privileges;                                                               # 刷新授权表 ( 虽然 grant 操作是不需要刷新授权表的，但那又如何 ? )</span><br><span class="line">mysql&gt; use zabbixDB;</span><br><span class="line">mysql&gt; source /data/soft/zabbix-4.0.3/database/mysql/schema.sql                             # 导入数据</span><br><span class="line">mysql&gt; source /data/soft/zabbix-4.0.3/database/mysql/images.sql</span><br><span class="line">mysql&gt; source /data/soft/zabbix-4.0.3/database/mysql/data.sql</span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure></p>
<p>配置 Zabbix 服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 服务端启动脚本</span><br><span class="line">shell &gt; cp /data/soft/zabbix-4.0.3/misc/init.d/fedora/core/zabbix_server /etc/init.d/</span><br><span class="line"># 客户端启动脚本</span><br><span class="line">shell &gt; cp /data/soft/zabbix-4.0.3/misc/init.d/fedora/core/zabbix_agentd /etc/init.d/</span><br><span class="line"># 网页文件</span><br><span class="line">shell &gt; cp -R /data/soft/zabbix-4.0.3/frontends/php/ /usr/local/nginx/html/zabbix</span><br></pre></td></tr></table></figure></p>
<p>服务端配置文件<br>vim /usr/local/zabbix/etc/zabbix_server.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LogFile=/tmp/zabbix_server.log  # 日志文件存放位置</span><br><span class="line">DBName=zabbixDB                  # 数据库名</span><br><span class="line">DBUser=zabbix                    # 连接用户</span><br><span class="line">DBPassword=zabbix               # 连接密码</span><br></pre></td></tr></table></figure></p>
<p>服务端启动脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; vim /etc/init.d/zabbix_server </span><br><span class="line">BASEDIR=/usr/local/zabbix # 修改后的位置 ( 原：/usr/local )</span><br></pre></td></tr></table></figure></p>
<p>客户端启动脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt;vim /etc/init.d/zabbix_agentd</span><br><span class="line">BASEDIR=/usr/local/zabbix # 修改后的位置 ( 原：/usr/local )</span><br></pre></td></tr></table></figure></p>
<p>配置zabbix开机启动，并启动Zabbix服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; chkconfig --add zabbix_server</span><br><span class="line">shell &gt; chkconfig --add zabbix_agentd</span><br><span class="line">shell &gt; chkconfig --level 35 zabbix_server on</span><br><span class="line">shell &gt; chkconfig --level 35 zabbix_agentd on</span><br><span class="line">shell &gt; service zabbix_server start</span><br><span class="line">Starting zabbix_server: [确定]</span><br><span class="line">shell &gt; service zabbix_agentd start</span><br><span class="line">Starting zabbix_agentd: [确定]</span><br></pre></td></tr></table></figure></p>
<p>查看进程启动是否正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; netstat -anpt | grep zabbix ( 注意：要来确认一下到底有没有启动成功，因为当授权用户无法连接数据库时，zabbix_server 是无法启动的，但是启动过程显示成功 )</span><br><span class="line">tcp        0      0 0.0.0.0:10050               0.0.0.0:*                   LISTEN      75399/zabbix_agentd </span><br><span class="line">tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      75321/zabbix_server</span><br></pre></td></tr></table></figure></p>
<h4 id="6、登陆网页进行配置-Zabbix-http-your-domain-zabbix-（初始用户名密码为admin-zabbix）"><a href="#6、登陆网页进行配置-Zabbix-http-your-domain-zabbix-（初始用户名密码为admin-zabbix）" class="headerlink" title="6、登陆网页进行配置 Zabbix ( http://your-domain/zabbix )（初始用户名密码为admin/zabbix）"></a>6、登陆网页进行配置 Zabbix ( <a href="http://your-domain/zabbix" target="_blank" rel="noopener">http://your-domain/zabbix</a> )（初始用户名密码为admin/zabbix）</h4><blockquote>
<p>第一个页面是欢迎页面，直接 Next<br><img src="https://i.imgur.com/t8fwVzF.png" alt=""><br><img src="https://i.imgur.com/5cjC7SU.png" alt=""><br>第二个页面大多会有多处检测失败，也是出问题最多的位置,修改php文件一下参数：<br>vim /usr/local/php/etc/php.ini<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">post_max_size = 16M</span><br><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">去掉date前面的分号，并添加时区</span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line">去掉always前面的分号</span><br><span class="line">always_populate_raw_post_data = -1</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>根据页面提示报错还需要修改以下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /root/php-5.6.11/ext/openssl/</span><br><span class="line">cp  ./config0.m4 ./config.m4</span><br><span class="line">#重新编译php，添加mysqli模块</span><br><span class="line">cd /data/soft/php-5.6.11/ext/mysqli</span><br><span class="line">/usr/local/php/bin/phpize </span><br><span class="line">./configure --prefix=/data/soft/mysqli --with-php-config=/usr/local/php/bin/php-config --with-mysqli=/data/mysql/bin/mysql_config</span><br><span class="line">make </span><br><span class="line">make test</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>配置完成后在php.ini下加入下来一行<br>vim /usr/local/php/etc/php.ini<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=mysqli.so</span><br></pre></td></tr></table></figure></p>
<p>安装过程中的其他报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: ext/mysqlnd/mysql_float_to_double.h: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>vim /data/soft/php-5.6.11/ext/mysqli/mysqli_api.c<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">把第36行的</span><br><span class="line">#include &quot;ext/mysqlnd/mysql_float_to_double.h&quot;</span><br><span class="line">修改为</span><br><span class="line">#include &quot;/data/soft/php-5.6.11/ext/mysqlnd/mysql_float_to_double.h&quot;</span><br></pre></td></tr></table></figure></p>
<p>点击下一步，配置数据库信息，根据自己配置的db信息填写<br><img src="https://i.imgur.com/0jqoRJU.png" alt=""><br>点击下一步，设置zabbix-server信息<br><img src="https://i.imgur.com/RbsR5W3.png" alt=""><br>点击下一步，预览设置的db和server的信息<br><img src="https://i.imgur.com/cdT09RC.png" alt=""><br>点击下一步，按提示要求，将下载下来的文件放到相应的目录<br><img src="https://i.imgur.com/1PNShFe.png" alt=""><br>zabbix-server安装完成</p>
<h4 id="7、zabbix-proxy代理端安装"><a href="#7、zabbix-proxy代理端安装" class="headerlink" title="7、zabbix-proxy代理端安装"></a>7、zabbix-proxy代理端安装</h4><p>依赖包安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y groupinstall &quot;Development tools&quot; </span><br><span class="line">yum -y install gcc gcc-c++ cmake autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers pcre-devel libaio ntpdate net-snmp net-snmp-devel libcurl-devel libevent-devel  vim telnet pcre-devel</span><br></pre></td></tr></table></figure></p>
<p>添加zabbix用户，并编译安装zabbix-proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-agent --enable-proxy --with-mysql --with-net-snmp --with-libcurl --with-libxml2 --with-openssl</span><br><span class="line"># --enable-agent 不是必须的 ( 如果不想监控 Proxy 的话 )</span><br><span class="line">mysql路径如果安装路径不是默认，需要单独指定</span><br><span class="line">./configure --prefix=/usr/local/zabbix --enable-agent --enable-proxy --with-mysql=/data/mysql/bin/mysql_config --with-net-snmp --with-libcurl --with-libxml2 --with-openssl  </span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>将proxy代理所需要的初始化数据导入到mysql数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">mysql&gt; create database proxydb character set utf8;                                            # 创建数据库</span><br><span class="line">mysql&gt; grant all on proxydb.* to &apos;proxy&apos;@&apos;%&apos; identified by &apos;proxydb&apos;;                         # 创建授权用户</span><br><span class="line">mysql&gt; flush privileges;                                                                      # 刷新授权表，虽然不需要~</span><br><span class="line">mysql&gt; use proxydb;</span><br><span class="line">mysql&gt; source /root/zabbix-3.4.2/database/mysql/schema.sql                                    # 导入数据，只导入这一个就可以了</span><br></pre></td></tr></table></figure></p>
<p>修改zabbix_proxy.conf配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# grep -vP &apos;^$|#&apos; /usr/local/zabbix/etc/zabbix_proxy.conf</span><br><span class="line">ProxyMode=0</span><br><span class="line">Server=192.168.197.135</span><br><span class="line">ServerPort=10051</span><br><span class="line">Hostname=node1</span><br><span class="line">LogFile=/tmp/zabbix_proxy.log</span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=proxydb</span><br><span class="line">DBUser=proxy</span><br><span class="line">DBPassword=proxydb</span><br><span class="line">ConfigFrequency=60</span><br><span class="line">DataSenderFrequency=60</span><br><span class="line">Timeout=4</span><br><span class="line">LogSlowQueries=3000</span><br></pre></td></tr></table></figure></p>
<p>参数详解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ProxyMode=0                    # 0 代表 Proxy 处于主动模式，即：Proxy 主动去请求 Zabbix Server 获取监控项；1 代表被动模式</span><br><span class="line">Server=192.168.188.30                     #填写Server的IP，Proxy会将收集到的数据发往这个IP。</span><br><span class="line">ServerPort=10051              # Zabbix Server 监听端口，同上只在 Proxy 为主动模式时生效</span><br><span class="line">Hostname=node1              # 这个很重要啦，跟 Agent 的 Hostname 一样重要，注意修改Hostname与web界面的需要添加的主机名称一致</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_proxy.log   # Proxy 日志文件位置</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_proxy.pid</span><br><span class="line">DBHost=localhost              # 连接哪里的数据库</span><br><span class="line">DBName=proxydb                       #Proxy连接的数据库</span><br><span class="line">DBUser=proxy                             #连接数据库的用户名</span><br><span class="line">DBPassword=proxypass                         #连接数据库的秘密</span><br><span class="line">DBSocket=/var/lib/mysql/mysql.sock</span><br><span class="line">ProxyLocalBuffer=0                        #当数据发送到Server，还要在本地保留多少小时.不保留</span><br><span class="line">ProxyOfflineBuffer=3                      #当数据没有发送到Server，在本地保留多少小时，3小时。</span><br><span class="line">HeartbeatFrequency=60                     #心跳检测代理在Server的可用性</span><br><span class="line">ConfigFrequency=60                        # Proxy 向 Zabbix Server 请求监控项间隔，单位为 秒，默认3600秒.</span><br><span class="line">DataSenderFrequency=3                     #代理收集到数据后，多久向Server发送一次,单位为 秒</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">TLSConnect=psk                            #加密传输</span><br><span class="line">TLSPSKFile=/usr/local/zabbix/etc/zabbix_proxy.psk #加密传输文件</span><br><span class="line">TLSPSKIdentity=PSK 002 #加密传输标识，与web控制台一致</span><br><span class="line">#DebugLevel=5</span><br></pre></td></tr></table></figure></p>
<p>如果要加密传输生成秘钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 32</span><br></pre></td></tr></table></figure></p>
<p>将秘钥存入/usr/local/zabbix/etc/zabbix_proxy.psk文件<br>然后再zabbix-server，web控制台添加zabbix-proxy信息</p>
<p><img src="https://i.imgur.com/Gn9MMx2.png" alt=""></p>
<p><img src="https://i.imgur.com/87a6P6J.png" alt=""><br>启动 zabbix_proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zabbix/sbin/zabbix_proxy</span><br></pre></td></tr></table></figure></p>
<p>启动报错如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/zabbix/sbin/zabbix_proxy: error while loading shared libraries: libmysqlclient.so.20: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /application/mysql/lib/libmysqlclient.so.20 /usr/lib64/</span><br></pre></td></tr></table></figure></p>
<p>查看是否启动成功：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnpt | grep zabbix_proxy</span><br><span class="line">tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      80154/zabbix_proxy</span><br></pre></td></tr></table></figure></p>
<p>加入开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;/usr/local/zabbix/sbin/zabbix_proxy&quot; &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/27/zabbix-server安装配置/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/27/zabbix监控cassandra数据库/"><span>[Zabbix] zabbix监控cassandra数据库</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/27/zabbix监控cassandra数据库/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-27T06:53:24.000Z">
          2018-08-27
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、安装java-gate-way-如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server-将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）："><a href="#1、安装java-gate-way-如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server-将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）：" class="headerlink" title="1、安装java_gate_way,如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server,将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）："></a>1、安装java_gate_way,如果当前监控架构为client-server将zabbix-java-gate-way安装在server端口，如果当前架构为client-proxy-server,将zabbix-java-gate-way安装在proxy端，安装步骤如下（下面以client-proxy-server架构为例）：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">创建zabbix用户，安装依赖包：</span><br><span class="line">sudo bash</span><br><span class="line">mkdir /home/zabbix</span><br><span class="line">useradd -r -s /sbin/nologin zabbix</span><br><span class="line">yum -y install gcc gcc-c++ pcre-devel openssl-devel</span><br><span class="line">yum -y install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br><span class="line"></span><br><span class="line">上传zabbix安装包，并安装java-gate-way：</span><br><span class="line"> mv /data/download/zabbix-3.4.2.tar.gz /home/zabbix/</span><br><span class="line"> cd /home/zabbix/</span><br><span class="line">tar -zxvf zabbix-3.4.2.tar.gz</span><br><span class="line">cd zabbix-3.4.2</span><br><span class="line">./configure --prefix=/data/zabbix --enable-java</span><br><span class="line">(如果zabbix-porxy或zabbix-server已安装，可指定一个新路径，gate-way与proxy、server并没有直接关系，可不必一起安装；如果都没有安装，为了管理方便，亦可放到同一目录）</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>安装完成之后，会在指定目录下存在以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ll /data/zabbix/sbin/zabbix_java/</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x. 2 root root   65 Aug 23 02:41 bin</span><br><span class="line">drwxr-xr-x. 2 root root  177 Aug 23 02:36 lib</span><br><span class="line">-rw-r--r--. 1 root root  791 Aug 23 02:36 settings.sh</span><br><span class="line">-rwxr-xr-x. 1 root root  545 Aug 23 02:36 shutdown.sh</span><br><span class="line">-rwxr-xr-x. 1 root root 2025 Aug 23 02:36 startup.sh</span><br></pre></td></tr></table></figure></p>
<p>包括启动脚本，关闭脚本，配置文件，依赖库，运行命令等文件。<br>启动java_gate_way：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./startup.sh</span><br></pre></td></tr></table></figure></p>
<h2 id="2、安装完成之后，修改zabbix-proxy-conf配置文件，添加以下参数："><a href="#2、安装完成之后，修改zabbix-proxy-conf配置文件，添加以下参数：" class="headerlink" title="2、安装完成之后，修改zabbix_proxy.conf配置文件，添加以下参数："></a>2、安装完成之后，修改zabbix_proxy.conf配置文件，添加以下参数：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaGateway=127.0.0.1</span><br><span class="line">JavaGatewayPort=10052</span><br><span class="line">StartJavaPollers=5</span><br></pre></td></tr></table></figure>
<p>默认端口为10052，因为zabbix-proxy与gate-way在同一台服务器上，因此使用127.0.0.1即可。必须指定java轮询器的预分叉实例数，默认情况下启动不会启动与jmx监控相关的进程。<br>修改完成之后重新启动zabbix-proxy服务，是修改参数生效。</p>
<h2 id="3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问"><a href="#3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问" class="headerlink" title="3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问"></a>3、修改cassandra-java启动参数，使其jmx监控进程允许其他服务器访问</h2><p>cat /etc/cassandra/conf/cassandra-env.sh |grep -v ‘^#’ |grep -v ‘^$’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">calculate_heap_sizes()</span><br><span class="line">&#123;</span><br><span class="line">    case &quot;`uname`&quot; in</span><br><span class="line">        Linux)</span><br><span class="line">            system_memory_in_mb=`free -m | awk &apos;/:/ &#123;print $2;exit&#125;&apos;`</span><br><span class="line">            system_cpu_cores=`egrep -c &apos;processor([[:space:]]+):.*&apos; /proc/cpuinfo`</span><br><span class="line">        ;;</span><br><span class="line">        FreeBSD)</span><br><span class="line">            system_memory_in_bytes=`sysctl hw.physmem | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            system_memory_in_mb=`expr $system_memory_in_bytes / 1024 / 1024`</span><br><span class="line">            system_cpu_cores=`sysctl hw.ncpu | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">        SunOS)</span><br><span class="line">            system_memory_in_mb=`prtconf | awk &apos;/Memory size:/ &#123;print $3&#125;&apos;`</span><br><span class="line">            system_cpu_cores=`psrinfo | wc -l`</span><br><span class="line">        ;;</span><br><span class="line">        Darwin)</span><br><span class="line">            system_memory_in_bytes=`sysctl hw.memsize | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">            system_memory_in_mb=`expr $system_memory_in_bytes / 1024 / 1024`</span><br><span class="line">            system_cpu_cores=`sysctl hw.ncpu | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">        *)</span><br><span class="line">            # assume reasonable defaults for e.g. a modern desktop or</span><br><span class="line">            # cheap server</span><br><span class="line">            system_memory_in_mb=&quot;2048&quot;</span><br><span class="line">            system_cpu_cores=&quot;2&quot;</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">    # some systems like the raspberry pi don&apos;t report cores, use at least 1</span><br><span class="line">    if [ &quot;$system_cpu_cores&quot; -lt &quot;1&quot; ]</span><br><span class="line">    then</span><br><span class="line">        system_cpu_cores=&quot;1&quot;</span><br><span class="line">    fi</span><br><span class="line">    # set max heap size based on the following</span><br><span class="line">    # max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB))</span><br><span class="line">    # calculate 1/2 ram and cap to 1024MB</span><br><span class="line">    # calculate 1/4 ram and cap to 8192MB</span><br><span class="line">    # pick the max</span><br><span class="line">    half_system_memory_in_mb=`expr $system_memory_in_mb / 2`</span><br><span class="line">    quarter_system_memory_in_mb=`expr $half_system_memory_in_mb / 2`</span><br><span class="line">    if [ &quot;$half_system_memory_in_mb&quot; -gt &quot;1024&quot; ]</span><br><span class="line">    then</span><br><span class="line">        half_system_memory_in_mb=&quot;1024&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$quarter_system_memory_in_mb&quot; -gt &quot;8192&quot; ]</span><br><span class="line">    then</span><br><span class="line">        quarter_system_memory_in_mb=&quot;8192&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$half_system_memory_in_mb&quot; -gt &quot;$quarter_system_memory_in_mb&quot; ]</span><br><span class="line">    then</span><br><span class="line">        max_heap_size_in_mb=&quot;$half_system_memory_in_mb&quot;</span><br><span class="line">    else</span><br><span class="line">        max_heap_size_in_mb=&quot;$quarter_system_memory_in_mb&quot;</span><br><span class="line">    fi</span><br><span class="line">    MAX_HEAP_SIZE=&quot;$&#123;max_heap_size_in_mb&#125;M&quot;</span><br><span class="line">    # Young gen: min(max_sensible_per_modern_cpu_core * num_cores, 1/4 * heap size)</span><br><span class="line">    max_sensible_yg_per_core_in_mb=&quot;100&quot;</span><br><span class="line">    max_sensible_yg_in_mb=`expr $max_sensible_yg_per_core_in_mb &quot;*&quot; $system_cpu_cores`</span><br><span class="line">    desired_yg_in_mb=`expr $max_heap_size_in_mb / 4`</span><br><span class="line">    if [ &quot;$desired_yg_in_mb&quot; -gt &quot;$max_sensible_yg_in_mb&quot; ]</span><br><span class="line">    then</span><br><span class="line">        HEAP_NEWSIZE=&quot;$&#123;max_sensible_yg_in_mb&#125;M&quot;</span><br><span class="line">    else</span><br><span class="line">        HEAP_NEWSIZE=&quot;$&#123;desired_yg_in_mb&#125;M&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">java_ver_output=`&quot;$&#123;JAVA:-java&#125;&quot; -version 2&gt;&amp;1`</span><br><span class="line">jvmver=`echo &quot;$java_ver_output&quot; | grep &apos;[openjdk|java] version&apos; | awk -F&apos;&quot;&apos; &apos;NR==1 &#123;print $2&#125;&apos; | cut -d\- -f1`</span><br><span class="line">JVM_VERSION=$&#123;jvmver%_*&#125;</span><br><span class="line">JVM_PATCH_VERSION=$&#123;jvmver#*_&#125;</span><br><span class="line">if [ &quot;$JVM_VERSION&quot; \&lt; &quot;1.8&quot; ] ; then</span><br><span class="line">    echo &quot;Cassandra 3.0 and later require Java 8u40 or later.&quot;</span><br><span class="line">    exit 1;</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$JVM_VERSION&quot; \&lt; &quot;1.8&quot; ] &amp;&amp; [ &quot;$JVM_PATCH_VERSION&quot; -lt 40 ] ; then</span><br><span class="line">    echo &quot;Cassandra 3.0 and later require Java 8u40 or later.&quot;</span><br><span class="line">    exit 1;</span><br><span class="line">fi</span><br><span class="line">jvm=`echo &quot;$java_ver_output&quot; | grep -A 1 &apos;java version&apos; | awk &apos;NR==2 &#123;print $1&#125;&apos;`</span><br><span class="line">case &quot;$jvm&quot; in</span><br><span class="line">    OpenJDK)</span><br><span class="line">        JVM_VENDOR=OpenJDK</span><br><span class="line">        # this will be &quot;64-Bit&quot; or &quot;32-Bit&quot;</span><br><span class="line">        JVM_ARCH=`echo &quot;$java_ver_output&quot; | awk &apos;NR==3 &#123;print $2&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">    &quot;Java(TM)&quot;)</span><br><span class="line">        JVM_VENDOR=Oracle</span><br><span class="line">        # this will be &quot;64-Bit&quot; or &quot;32-Bit&quot;</span><br><span class="line">        JVM_ARCH=`echo &quot;$java_ver_output&quot; | awk &apos;NR==3 &#123;print $3&#125;&apos;`</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        # Help fill in other JVM values</span><br><span class="line">        JVM_VENDOR=other</span><br><span class="line">        JVM_ARCH=unknown</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Xloggc:/var/log/cassandra/gc.log&quot;</span><br><span class="line">JVM_OPTS_FILE=$CASSANDRA_CONF/jvm.options</span><br><span class="line">for opt in `grep &quot;^-&quot; $JVM_OPTS_FILE`</span><br><span class="line">do</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS $opt&quot;</span><br><span class="line">done</span><br><span class="line">echo $JVM_OPTS | grep -q Xmn</span><br><span class="line">DEFINED_XMN=$?</span><br><span class="line">echo $JVM_OPTS | grep -q Xmx</span><br><span class="line">DEFINED_XMX=$?</span><br><span class="line">echo $JVM_OPTS | grep -q Xms</span><br><span class="line">DEFINED_XMS=$?</span><br><span class="line">echo $JVM_OPTS | grep -q UseConcMarkSweepGC</span><br><span class="line">USING_CMS=$?</span><br><span class="line">echo $JVM_OPTS | grep -q UseG1GC</span><br><span class="line">USING_G1=$?</span><br><span class="line">if [ &quot;x$MAX_HEAP_SIZE&quot; = &quot;x&quot; ] &amp;&amp; [ &quot;x$HEAP_NEWSIZE&quot; = &quot;x&quot; -o $USING_G1 -eq 0 ]; then</span><br><span class="line">    calculate_heap_sizes</span><br><span class="line">elif [ &quot;x$MAX_HEAP_SIZE&quot; = &quot;x&quot; ] ||  [ &quot;x$HEAP_NEWSIZE&quot; = &quot;x&quot; -a $USING_G1 -ne 0 ]; then</span><br><span class="line">    echo &quot;please set or unset MAX_HEAP_SIZE and HEAP_NEWSIZE in pairs when using CMS GC (see cassandra-env.sh)&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">if [ &quot;x$MALLOC_ARENA_MAX&quot; = &quot;x&quot; ] ; then</span><br><span class="line">    export MALLOC_ARENA_MAX=4</span><br><span class="line">fi</span><br><span class="line">if [ $DEFINED_XMX -ne 0 ] &amp;&amp; [ $DEFINED_XMS -ne 0 ]; then</span><br><span class="line">     JVM_OPTS=&quot;$JVM_OPTS -Xms$&#123;MAX_HEAP_SIZE&#125;&quot;</span><br><span class="line">     JVM_OPTS=&quot;$JVM_OPTS -Xmx$&#123;MAX_HEAP_SIZE&#125;&quot;</span><br><span class="line">elif [ $DEFINED_XMX -ne 0 ] || [ $DEFINED_XMS -ne 0 ]; then</span><br><span class="line">     echo &quot;Please set or unset -Xmx and -Xms flags in pairs on jvm.options file.&quot;</span><br><span class="line">     exit 1</span><br><span class="line">fi</span><br><span class="line">if [ $DEFINED_XMN -eq 0 ] &amp;&amp; [ $DEFINED_XMX -ne 0 ]; then</span><br><span class="line">    echo &quot;Please set or unset -Xmx and -Xmn flags in pairs on jvm.options file.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">elif [ $DEFINED_XMN -ne 0 ] &amp;&amp; [ $USING_CMS -eq 0 ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -Xmn$&#123;HEAP_NEWSIZE&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$JVM_ARCH&quot; = &quot;64-Bit&quot; ] &amp;&amp; [ $USING_CMS -eq 0 ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -XX:+UseCondCardMark&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -XX:CompileCommandFile=$CASSANDRA_CONF/hotspot_compiler&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -javaagent:$CASSANDRA_HOME/lib/jamm-0.3.0.jar&quot;</span><br><span class="line">if [ &quot;x$CASSANDRA_HEAPDUMP_DIR&quot; != &quot;x&quot; ]; then</span><br><span class="line">    JVM_OPTS=&quot;$JVM_OPTS -XX:HeapDumpPath=$CASSANDRA_HEAPDUMP_DIR/cassandra-`date +%s`-pid$$.hprof&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_ON_OUT_OF_MEMORY_ERROR_OPT=&quot;-XX:OnOutOfMemoryError=kill -9 %p&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Djava.rmi.server.hostname=10.0.7.50&quot;</span><br><span class="line">if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span><br><span class="line">    LOCAL_JMX=no</span><br><span class="line">fi</span><br><span class="line">JMX_PORT=&quot;7199&quot;</span><br><span class="line">if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT&quot;</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">else</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.remote.port=$JMX_PORT&quot;</span><br><span class="line">  # if ssl is enabled the same port cannot be used for both jmx and rmi so either</span><br><span class="line">  # pick another value for this property or comment out to use a random port (though see CASSANDRA-7087 for origins)</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;</span><br><span class="line">  # turn on JMX authentication. See below for further options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">  # jmx ssl options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl=false&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.need.client.auth=true&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.enabled.protocols=&lt;enabled-protocols&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl.enabled.cipher.suites=&lt;enabled-cipher-suites&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.keyStore=/path/to/keystore&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.keyStorePassword=&lt;keystore-password&gt;&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.trustStore=/path/to/truststore&quot;</span><br><span class="line">  #JVM_OPTS=&quot;$JVM_OPTS -Djavax.net.ssl.trustStorePassword=&lt;truststore-password&gt;&quot;</span><br><span class="line">fi</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS -Djava.library.path=$CASSANDRA_HOME/lib/sigar-bin&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $MX4J_ADDRESS&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $MX4J_PORT&quot;</span><br><span class="line">JVM_OPTS=&quot;$JVM_OPTS $JVM_EXTRA_OPTS&quot;</span><br></pre></td></tr></table></figure></p>
<p>主要修改一下内容，默认LOCAL_JMX=yes<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span><br><span class="line">    LOCAL_JMX=no</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>将true改为false,修改远程访问认证无需密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT&quot;</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">else</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.remote.port=$JMX_PORT&quot;</span><br><span class="line">  # if ssl is enabled the same port cannot be used for both jmx and rmi so either</span><br><span class="line">  # pick another value for this property or comment out to use a random port (though see CASSANDRA-7087 for origins)</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;</span><br><span class="line">  # turn on JMX authentication. See below for further options</span><br><span class="line">  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下："><a href="#4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下：" class="headerlink" title="4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下："></a>4、在zabbix-proxy端测试，获取被监控端的数据是否正常，监控脚本如下：</h2><p>cat /data/zabbix/sbin/zabbix_java/bin/zabbix_get_jmx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">if [ $# != 5 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;Usage: $0 &lt;JAVA_GATEWAY_HOST&gt; &lt;JAVA_GATEWAY_PORT&gt; &lt;JMX_SERVER&gt; &lt;JMX_PORT&gt; &lt;KEY&gt;&quot;</span><br><span class="line">        exit;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># create connection</span><br><span class="line">exec 3&lt;&gt;/dev/tcp/$1/$2</span><br><span class="line"></span><br><span class="line"># compose message</span><br><span class="line">MSG=&quot;&#123;\&quot;request\&quot;: \&quot;java gateway jmx\&quot;,\&quot;jmx_endpoint\&quot;:\&quot;service:jmx:rmi:///jndi/rmi://$3:$4/jmxrmi\&quot;,\&quot;keys\&quot;: [\&quot;$5\&quot;]&#125;&quot;</span><br><span class="line"># write message length as zero-padded 16-digit hexadecimal number</span><br><span class="line">printf -v LEN &apos;%016x&apos; &quot;$&#123;#MSG&#125;&quot;</span><br><span class="line"></span><br><span class="line"># prepare message length in little endian representation</span><br><span class="line">BYTES=&quot;&quot;</span><br><span class="line">for i in &#123;0..14..2&#125;</span><br><span class="line">do</span><br><span class="line">        BYTES=&quot;\\x$&#123;LEN:$i:2&#125;$BYTES&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># prepend protocol header and message length</span><br><span class="line">printf &quot;ZBXD\\1$BYTES%s&quot; &quot;$MSG&quot; &gt;&amp;3</span><br><span class="line"></span><br><span class="line"># output the result skipping 5 bytes of &quot;ZBXD\\1&quot; header and 8 bytes of message length</span><br><span class="line">tail -c+13 &lt;&amp;3</span><br></pre></td></tr></table></figure></p>
<p>该脚本可自行存放，没有规定，测试命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zabbix_get_jmx 127.0.0.1 10052 10.0.7.50 7199 &apos;jmx[\&quot;org.apache.cassandra.metrics:type=ThreadPools,path=internal,scope=MemtablePostFlush,name=ActiveTasks\&quot;,\&quot;Value\&quot;]&apos;</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:为java-gate-way地址；<br>10052：为java-gate-way端口；<br>10.0.7.50：为被监控端的ip地址；<br>7199：为被监控端jmx的端口；<br>org.apache**:为要获取的参数，需要获取哪些参数可查看<a href="https://cassandra.apache.org/doc/latest/operating/metrics.html" target="_blank" rel="noopener">官方文档</a></p>
<h2 id="5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载"><a href="#5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载" class="headerlink" title="5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击此处，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处下载"></a>5、zabbix官网提供了对cassandra的监控模板，其中有部分参数已失效，如需下载官方模板，点击<a href="https://share.zabbix.com/databases/cassandradb/cassandra-cluster-template-jmx" target="_blank" rel="noopener">此处</a>，该模板为纯英文，且里面参数没有详细描述，下面为根据个人理解翻译后的模板，点击此处<a href="https://pan.baidu.com/s/1Yo-9-dP6QRRl0nu5u-icYw" target="_blank" rel="noopener">下载</a></h2>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a><a href="/tags/cassandra/">cassandra</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/27/zabbix监控cassandra数据库/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/23/centos7.2服务器使用df -h卡死问题/"><span>[Linux] centos7.2 服务器 使用df -h卡死问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/23/centos7.2服务器使用df -h卡死问题/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-23T05:06:24.000Z">
          2018-08-23
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、服务器使用df-h命令卡死，crtl-c没有反应，ps-ef-grep-df-命令杀掉df-h进程也无效。"><a href="#1、服务器使用df-h命令卡死，crtl-c没有反应，ps-ef-grep-df-命令杀掉df-h进程也无效。" class="headerlink" title="1、服务器使用df -h命令卡死，crtl+c没有反应，ps -ef|grep df 命令杀掉df -h进程也无效。"></a>1、服务器使用df -h命令卡死，crtl+c没有反应，ps -ef|grep df 命令杀掉df -h进程也无效。</h2><h2 id="2、重新启动会话，使用strace跟踪df-h执行状态"><a href="#2、重新启动会话，使用strace跟踪df-h执行状态" class="headerlink" title="2、重新启动会话，使用strace跟踪df -h执行状态"></a>2、重新启动会话，使用strace跟踪df -h执行状态</h2><p>strace df -h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/df&quot;, [&quot;df&quot;, &quot;-h&quot;], [/* 24 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77097000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=19527, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 19527, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77092000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0 \34\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2107816, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3932736, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efe76ab6000</span><br><span class="line">mprotect(0x7efe76c6c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7efe76e6c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b6000) = 0x7efe76e6c000</span><br><span class="line">mmap(0x7efe76e72000, 16960, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efe76e72000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77091000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe7708f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7efe7708f740) = 0</span><br><span class="line">mprotect(0x7efe76e6c000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x616000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7efe77098000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7efe77092000, 19527)           = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">brk(0x1ebd000)                          = 0x1ebd000</span><br><span class="line">brk(NULL)                               = 0x1ebd000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106065056, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106065056, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe7058f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2502, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=190751, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 190751, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77060000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/mtab&quot;, O_RDONLY|O_CLOEXEC)   = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;rootfs / rootfs rw 0 0\nsysfs /sy&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;ev,noexec,relatime,freezer 0 0\nc&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;sd rw,relatime 0 0\n&quot;, 1024)   = 19</span><br><span class="line">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/lib64/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26254, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26254, PROT_READ, MAP_SHARED, 3, 0) = 0x7efe77059000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/pts&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/sys/fs/binfmt_misc&quot;</span><br></pre></td></tr></table></figure></p>
<p>df -h进程在”/proc/sys/fs/binfmt_misc”这个位置卡主了</p>
<h2 id="3、启动另一个会话，重新挂在这个目录"><a href="#3、启动另一个会话，重新挂在这个目录" class="headerlink" title="3、启动另一个会话，重新挂在这个目录"></a>3、启动另一个会话，重新挂在这个目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart proc-sys-fs-binfmt_misc.automount</span><br></pre></td></tr></table></figure>
<h2 id="4、strace-df-h-跟踪的进程内容有新的输出，完整信息输出如下："><a href="#4、strace-df-h-跟踪的进程内容有新的输出，完整信息输出如下：" class="headerlink" title="4、strace df -h 跟踪的进程内容有新的输出，完整信息输出如下："></a>4、strace df -h 跟踪的进程内容有新的输出，完整信息输出如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/df&quot;, [&quot;df&quot;, &quot;-h&quot;], [/* 24 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77097000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=19527, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 19527, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77092000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0 \34\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2107816, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3932736, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efe76ab6000</span><br><span class="line">mprotect(0x7efe76c6c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7efe76e6c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b6000) = 0x7efe76e6c000</span><br><span class="line">mmap(0x7efe76e72000, 16960, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efe76e72000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77091000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe7708f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7efe7708f740) = 0</span><br><span class="line">mprotect(0x7efe76e6c000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x616000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7efe77098000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7efe77092000, 19527)           = 0</span><br><span class="line">brk(NULL)                               = 0x1e9c000</span><br><span class="line">brk(0x1ebd000)                          = 0x1ebd000</span><br><span class="line">brk(NULL)                               = 0x1ebd000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106065056, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106065056, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe7058f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2502, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2502</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh_CN/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=190751, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 190751, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efe77060000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/share/locale/zh/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/mtab&quot;, O_RDONLY|O_CLOEXEC)   = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">read(3, &quot;rootfs / rootfs rw 0 0\nsysfs /sy&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;ev,noexec,relatime,freezer 0 0\nc&quot;..., 1024) = 1024</span><br><span class="line">read(3, &quot;sd rw,relatime 0 0\n&quot;, 1024)   = 19</span><br><span class="line">read(3, &quot;&quot;, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">open(&quot;/usr/lib64/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26254, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26254, PROT_READ, MAP_SHARED, 3, 0) = 0x7efe77059000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/pts&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/sys/fs/binfmt_misc&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/hugepages&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/debug&quot;, &#123;st_mode=S_IFDIR|0700, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/dev/mqueue&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/boot&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/run/user/0&quot;, &#123;st_mode=S_IFDIR|0700, st_size=40, ...&#125;) = 0</span><br><span class="line">stat(&quot;/var/lib/nfs/rpc_pipefs&quot;, &#123;st_mode=S_IFDIR|0555, st_size=0, ...&#125;) = 0</span><br><span class="line">stat(&quot;/proc/fs/nfsd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;xkey-boss01-8035-184&quot;, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/&quot;, &#123;f_type=0x58465342, f_bsize=4096, f_blocks=9293380, f_bfree=5378782, f_bavail=5378782, f_files=37191680, f_ffree=37150656, f_fsid=&#123;64768, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=494791, f_bfree=494791, f_bavail=494791, f_files=494791, f_ffree=494430, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID&#125;) = 0</span><br><span class="line">stat(&quot;/dev&quot;, &#123;st_mode=S_IFDIR|0755, st_size=3140, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/kernel/security&quot;, &#123;f_type=SECURITYFS_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/security&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev/shm&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=497337, f_bavail=497337, f_files=497337, f_ffree=497336, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV&#125;) = 0</span><br><span class="line">stat(&quot;/dev/shm&quot;, &#123;st_mode=S_IFDIR|S_ISVTX|0777, st_size=40, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/run&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=458142, f_bavail=458142, f_files=497337, f_ffree=496689, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV&#125;) = 0</span><br><span class="line">stat(&quot;/run&quot;, &#123;st_mode=S_IFDIR|0755, st_size=740, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=497337, f_bfree=497337, f_bavail=497337, f_files=497337, f_ffree=497324, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RDONLY|ST_NOSUID|ST_NODEV|ST_NOEXEC&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup&quot;, &#123;st_mode=S_IFDIR|0755, st_size=280, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/systemd&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/systemd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/pstore&quot;, &#123;f_type=PSTOREFS_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/pstore&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/memory&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/memory&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpu,cpuacct&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/net_cls&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/freezer&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/freezer&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/devices&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/devices&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/blkio&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/blkio&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/perf_event&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/cpuset&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;f_type=CGROUP_SUPER_MAGIC, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_NOEXEC|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/fs/cgroup/hugetlb&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/sys/kernel/config&quot;, &#123;f_type=0x62656570, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/sys/kernel/config&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/dev/hugepages&quot;, &#123;f_type=HUGETLBFS_MAGIC, f_bsize=2097152, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=2097152, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/dev/hugepages&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/boot&quot;, &#123;f_type=0x58465342, f_bsize=4096, f_blocks=127147, f_bfree=95769, f_bavail=95769, f_files=512000, f_ffree=511670, f_fsid=&#123;64513, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/boot&quot;, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/run/user/0&quot;, &#123;f_type=TMPFS_MAGIC, f_bsize=4096, f_blocks=99468, f_bfree=99468, f_bavail=99468, f_files=497337, f_ffree=497336, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_NOSUID|ST_NODEV|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/run/user/0&quot;, &#123;st_mode=S_IFDIR|0700, st_size=40, ...&#125;) = 0</span><br><span class="line">statfs(&quot;/proc/fs/nfsd&quot;, &#123;f_type=0x6e667364, f_bsize=4096, f_blocks=0, f_bfree=0, f_bavail=0, f_files=0, f_ffree=0, f_fsid=&#123;0, 0&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">stat(&quot;/proc/fs/nfsd&quot;, &#123;st_mode=S_IFDIR|0755, st_size=0, ...&#125;) = 0</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(136, 7), ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efe77096000</span><br><span class="line">write(1, &quot;\346\226\207\344\273\266\347\263\273\347\273\237                 \345\256\271&quot;..., 70文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">) = 70</span><br><span class="line">write(1, &quot;/dev/mapper/centos-root   36G   &quot;..., 50/dev/mapper/centos-root   36G   15G   21G   43% /</span><br><span class="line">) = 50</span><br><span class="line">write(1, &quot;devtmpfs                 1.9G   &quot;..., 53devtmpfs                 1.9G     0  1.9G    0% /dev</span><br><span class="line">) = 53</span><br><span class="line">write(1, &quot;tmpfs                    1.9G   &quot;..., 57tmpfs                    1.9G     0  1.9G    0% /dev/shm</span><br><span class="line">) = 57</span><br><span class="line">write(1, &quot;tmpfs                    1.9G  1&quot;..., 53tmpfs                    1.9G  154M  1.8G    8% /run</span><br><span class="line">) = 53</span><br><span class="line">write(1, &quot;tmpfs                    1.9G   &quot;..., 63tmpfs                    1.9G     0  1.9G    0% /sys/fs/cgroup</span><br><span class="line">) = 63</span><br><span class="line">write(1, &quot;/dev/vda1                497M  1&quot;..., 54/dev/vda1                497M  123M  375M   25% /boot</span><br><span class="line">) = 54</span><br><span class="line">write(1, &quot;tmpfs                    389M   &quot;..., 60tmpfs                    389M     0  389M    0% /run/user/0</span><br><span class="line">) = 60</span><br><span class="line">close(1)                                = 0</span><br><span class="line">munmap(0x7efe77096000, 4096)            = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>
<h2 id="5、重新使用df-h命令，恢复正常。"><a href="#5、重新使用df-h命令，恢复正常。" class="headerlink" title="5、重新使用df -h命令，恢复正常。"></a>5、重新使用df -h命令，恢复正常。</h2>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/23/centos7.2服务器使用df -h卡死问题/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/21/InnoDB-page_cleaner-1000ms intended loop took xxxms/"><span>[Mysql] InnoDB：page_cleaner：1000ms intended loop took xxxms</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/21/InnoDB-page_cleaner-1000ms intended loop took xxxms/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-21T07:10:20.000Z">
          2018-08-21
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、在查看mysqllog日志的时候不经意间发现一条这个提示："><a href="#1、在查看mysqllog日志的时候不经意间发现一条这个提示：" class="headerlink" title="1、在查看mysqllog日志的时候不经意间发现一条这个提示："></a>1、在查看mysqllog日志的时候不经意间发现一条这个提示：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] InnoDB: page_cleaner: 1000ms intended loop took 16111ms. The settings might not be optimal. (flushed=7 and evicted=0, during the time.)</span><br></pre></td></tr></table></figure>
<p>造成该问题的主要原因：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">page_cleaner_thread:脏页清理线程负责将脏页从内存写到磁盘。</span><br><span class="line"></span><br><span class="line">出现该问题的原因：上面提示的信息的含义是,有大量脏页需要刷新，理论上应该在1s内完成，但实际却用了16s的时间将脏页刷新到磁盘，它接受脏页的数量远远大于它每秒能够处理脏页的能力，因此为了避免该问题，可降低每秒循环期间搜索脏页的深度（innodb_lru_scan_depth）。</span><br><span class="line"></span><br><span class="line">如果数据库存在很多的buffer pool instance 将会引起更多的刷新工作，因此如果只是增大 buffer pool instances 而没有降低lru_scan_depth,很可能会引起性能瓶颈。</span><br><span class="line"></span><br><span class="line">如果只是临时对数据库进行大量导入操作造成的这类问题,可以忽略这个问题不需关注。如果数据库一直存在大量更新操作，快速创建大量的脏页，该问题一直存在需要关注。</span><br></pre></td></tr></table></figure></p>
<p>下面是官方文档对lru_scan_depth参数的解释，中文为自己对官方文档的理解翻译，错误之处望大家指正。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A setting smaller than the default is generally suitable for most workloads. A value that is much higher than necessary may impact performance. Only consider increasing the value if you have spare I/O capacity under a typical workload. Conversely, if a write-intensive workload saturates your I/O capacity, decrease the value, especially in the case of a large buffer pool.</span><br><span class="line">When tuning innodb_lru_scan_depth, start with a low value and configure the setting upward with the goal of rarely seeing zero free pages. Also, consider adjusting innodb_lru_scan_depth when changing the number of buffer pool instances, since innodb_lru_scan_depth * innodb_buffer_pool_instances defines the amount of work performed by the page cleaner thread each second.</span><br><span class="line">比默认值小适合于大多数工作负载，如果设置比默认值大可能会影响性能。只有当有额外的磁盘io容量的时候才考虑需不需要增加该值。相反，如果在写密集度负载已经使io容量饱和，需要降低该值，尤其是buffer pool的值设置特别大的时候。</span><br><span class="line"></span><br><span class="line">如果lru_scan_depth值特别低，而且存在0空闲页，可以考虑调高该值。如果调整buffer pool instances时，需要考虑是否调整innodb_lru_scan_depth大小，因为innodb_lru_scan_depth * innodb_buffer_pool_instances决定了每秒page cleaner thread处理的工作量。</span><br></pre></td></tr></table></figure></p>
<h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL innodb_lru_scan_depth=256;</span><br></pre></td></tr></table></figure>
<p>该参数默认只为1024。<br>这只是数据库级别调整，出现该问题还需要查看服务器硬件问题，磁盘io是否达到瓶颈扥问题。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/21/InnoDB-page_cleaner-1000ms intended loop took xxxms/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/20/mysql-mgr集群节点主节点与两个从节点网络异常，造成的集群异常问题/"><span>[Mysql] mysql-mgr集群节点主节点与两个从节点网络异常，造成的集群异常问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/20/mysql-mgr集群节点主节点与两个从节点网络异常，造成的集群异常问题/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-20T09:14:20.000Z">
          2018-08-20
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B-切换为主，报错如下："><a href="#1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B-切换为主，报错如下：" class="headerlink" title="1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B)切换为主，报错如下："></a>1、mysql-mgr集群节点主节点（A）与两个从节点网络异常，主节点（A）发生切换，从节点（B)切换为主，报错如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-08-20T05:38:16.071653Z 0 [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-2:3306 has become unreachable.&apos;</span><br><span class="line">2018-08-20T05:38:16.071730Z 0 [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-3:3306 has become unreachable.&apos;</span><br><span class="line">2018-08-20T05:38:16.071744Z 0 [ERROR] Plugin group_replication reported: &apos;This server is not able to reach a majority of members in the group. This server will now block all updates. The server will remain blocked until contact with the majority is restored. It is possible to use group_replication_force_members to force a new group membership.&apos;</span><br></pre></td></tr></table></figure>
<h2 id="2、对故障节点A操作，使其重新加入集群"><a href="#2、对故障节点A操作，使其重新加入集群" class="headerlink" title="2、对故障节点A操作，使其重新加入集群"></a>2、对故障节点A操作，使其重新加入集群</h2><p>A节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p>
<p>查看报错日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2018-08-20T07:29:40.796952Z 12 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-08-20T07:29:40.803975Z 26 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-08-20T07:29:40.855935Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;wallet-mysql-2&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-08-20T07:29:40.906041Z 12 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 4/10&apos;</span><br><span class="line">2018-08-20T07:29:40.949597Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;wallet-mysql-3&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-08-20T07:29:41.001446Z 12 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e at wallet-mysql-3 port: 3306.&apos;</span><br><span class="line">2018-08-20T07:29:41.001738Z 29 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</span><br><span class="line">2018-08-20T07:29:41.005538Z 29 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos;: connected to master &apos;repl@wallet-mysql-3:3306&apos;,replication started in log &apos;FIRST&apos; at position 4</span><br><span class="line">2018-08-20T07:29:41.016839Z 30 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_recovery.000001&apos; position: 4</span><br><span class="line">2018-08-20T07:29:41.028408Z 29 [ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">2018-08-20T07:29:41.028442Z 29 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br><span class="line">2018-08-20T07:29:41.028449Z 29 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</span><br><span class="line">2018-08-20T07:29:41.028493Z 12 [Note] Plugin group_replication reported: &apos;Terminating existing group replication donor connection and purging the corresponding logs.&apos;</span><br><span class="line">2018-08-20T07:29:41.028790Z 30 [Note] Error reading relay log event for channel &apos;group_replication_recovery&apos;: slave SQL thread was killed</span><br><span class="line">2018-08-20T07:29:41.085012Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;wallet-mysql-3&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br></pre></td></tr></table></figure></p>
<p>出现该问题的原因是现在的新的主节点B，已经清除了binglog,A节点需要恢复的日志已经找不到了，因此需要对A进行数据恢复。</p>
<h2 id="3、在B节点mysqldump一份最新数据，命令如下："><a href="#3、在B节点mysqldump一份最新数据，命令如下：" class="headerlink" title="3、在B节点mysqldump一份最新数据，命令如下："></a>3、在B节点mysqldump一份最新数据，命令如下：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqldump --all-databases --<span class="built_in">set</span>-gtid-purged=ON --single-transaction -uroot -p***** &gt; /data/backup/all.sql</span><br></pre></td></tr></table></figure>
<h2 id="4、将dump的数据库拷贝到A节点，对节点A进行恢复："><a href="#4、将dump的数据库拷贝到A节点，对节点A进行恢复：" class="headerlink" title="4、将dump的数据库拷贝到A节点，对节点A进行恢复："></a>4、将dump的数据库拷贝到A节点，对节点A进行恢复：</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p******* &lt; /data/backup/all.sql</span><br></pre></td></tr></table></figure>
<p>执行提示报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</span><br></pre></td></tr></table></figure></p>
<p>解决方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">提示只有@@GLOBAL.GTID_EXECUTED为空是，才能设置@@GLOBAL.GTID_PURGED的值，清空GLOBAL.GTID_EXECUTED的值</span><br><span class="line">root@db 07:53:  [(none)]&gt; reset master;</span><br><span class="line">ERROR 3190 (HY000): RESET MASTER is not allowed because Group Replication is running.</span><br><span class="line">root@db 07:53:  [(none)]&gt; stop group_replication;</span><br><span class="line">Query OK, 0 rows affected (1.01 sec)</span><br><span class="line">root@db 07:53:  [(none)]&gt; reset master;</span><br><span class="line">Query OK, 0 rows affected (0.27 sec)</span><br><span class="line">如果数据库为只读的状态还需要将数据库改为读写模式：</span><br><span class="line">root@db 07:54:  [performance_schema]&gt; set global read_only=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="5、重新恢复数据"><a href="#5、重新恢复数据" class="headerlink" title="5、重新恢复数据"></a>5、重新恢复数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p******* &lt; /data/backup/all.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure>
<p>恢复完成</p>
<h2 id="6、重新将该节点加入集群"><a href="#6、重新将该节点加入集群" class="headerlink" title="6、重新将该节点加入集群"></a>6、重新将该节点加入集群</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">root@db 07:56:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">| group_replication_applier |           |             |        NULL | OFFLINE      |</span><br><span class="line">+<span class="comment">---------------------------+-----------+-------------+-------------+--------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@db <span class="number">07</span>:<span class="number">56</span>:  [performance_schema]&gt; <span class="keyword">start</span> group_replication;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (3.03 sec)</span><br><span class="line">root@db 07:57:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">| group_replication_applier | *** | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-1 |        3306 | RECOVERING   |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+<span class="comment">---------------------------+--------------------------------------+----------------+-------------+--------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>此时节点A正在与主节点同步数据，待同步完成之后再查看及节点之间的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:57:  [performance_schema]&gt; select * from replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | *** | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>此时集群恢复完成。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/20/mysql-mgr集群节点主节点与两个从节点网络异常，造成的集群异常问题/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/17/zabbix监控redis/"><span>[Zabbix] zabbix监控redis数据库</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/17/zabbix监控redis/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-17T09:47:24.000Z">
          2018-08-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、编写定期收集redis信息脚本，并指定到对应目录"><a href="#1、编写定期收集redis信息脚本，并指定到对应目录" class="headerlink" title="1、编写定期收集redis信息脚本，并指定到对应目录"></a>1、编写定期收集redis信息脚本，并指定到对应目录</h3><p>cat /usr/local/zabbix/script/redis_get_data.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件路径</span></span><br><span class="line">dbconfigfile=/data/redis/etc/redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">主机ip地址</span></span><br><span class="line">dbhost=`cat $&#123;dbconfigfile&#125; |grep bind|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">redis启动端口</span></span><br><span class="line">dbport=`cat $&#123;dbconfigfile&#125; |grep port|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">数据库命令路径</span></span><br><span class="line">dbcmdpath=/data/redis/src</span><br><span class="line"><span class="meta">#</span><span class="bash">数据库密码</span></span><br><span class="line">dbpass=`cat $&#123;dbconfigfile&#125; |grep requirepass|awk '&#123;print $2&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash">指定生成的<span class="built_in">log</span>路径</span></span><br><span class="line">dblogpath=/tmp/redis.log</span><br><span class="line"><span class="meta">#</span><span class="bash">如果有没密码，使用以下命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$&#123;dbcmdpath&#125;</span>/redis-cli -h <span class="variable">$&#123;dbhost&#125;</span> -a <span class="variable">$&#123;dbpass&#125;</span> -p <span class="variable">$&#123;dbport&#125;</span>  <span class="string">'info'</span> &gt; <span class="variable">$&#123;dblogpath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果没有密码，使用以下命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbcmdpath&#125;/redis-cli -h <span class="variable">$&#123;dbhost&#125;</span> -p <span class="variable">$&#123;dbport&#125;</span>  <span class="string">'info'</span> &gt; <span class="variable">$&#123;dblogpath&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>修改redis配置文件目录，生成的log目录，修改完成之后授权脚本执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/redis_get_data.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="2、将脚本添加到定时任务，每分钟执行一次"><a href="#2、将脚本添加到定时任务，每分钟执行一次" class="headerlink" title="2、将脚本添加到定时任务，每分钟执行一次"></a>2、将脚本添加到定时任务，每分钟执行一次</h3><p>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /usr/local/zabbix/script/redis_get_data.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="3、编写zabbix监控项文件-通过-usr-local-zabbix-script-redis-get-data-sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值"><a href="#3、编写zabbix监控项文件-通过-usr-local-zabbix-script-redis-get-data-sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值" class="headerlink" title="3、编写zabbix监控项文件,通过/usr/local/zabbix/script/redis_get_data.sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值"></a>3、编写zabbix监控项文件,通过/usr/local/zabbix/script/redis_get_data.sh脚本生成的log文件，根据关键字过滤，获取对应监控的数值</h3><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/redis_monitor_parameter.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#数据库进程是否存在</span><br><span class="line">UserParameter=redis_exist[*],ps -ef|grep redis-server|grep -v grep|wc -l</span><br><span class="line">#客户端连接数，包括从库的连接</span><br><span class="line">UserParameter=connected_clients[*],cat /tmp/redis.log |grep &apos;connected_clients&apos; |cut -d&apos;:&apos; -f2</span><br><span class="line">#当前客户端最长输出列表</span><br><span class="line">UserParameter=client_longest_output_list[*],cat /tmp/redis.log |grep client_longest_output_list |cut -d&apos;:&apos; -f2</span><br><span class="line">#当前客户端最大输入缓冲区</span><br><span class="line">UserParameter=client_biggest_input_buf[*],cat /tmp/redis.log |grep client_biggest_input_buf |cut -d&apos;:&apos; -f2</span><br><span class="line">#阻塞会话数</span><br><span class="line">UserParameter=blocked_clients[*],cat /tmp/redis.log |grep blocked_clients |cut -d&apos;:&apos; -f2</span><br><span class="line">#redis通过分配器分配的总内存</span><br><span class="line">UserParameter=used_memory[*],cat /tmp/redis.log |grep used_memory |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#操作系统通过top和ps命令查看到redis分配的内存</span><br><span class="line">UserParameter=used_memory_rss[*],cat /tmp/redis.log |grep used_memory_rss |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#redis消耗内存的峰值</span><br><span class="line">UserParameter=used_memory_peak[*],cat /tmp/redis.log |grep used_memory_peak |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#系统为管理内部数据架构造成的所有内存开销</span><br><span class="line">UserParameter=used_memory_overhead[*],cat /tmp/redis.log |grep used_memory_overhead |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#redis启动初始化消耗的内存</span><br><span class="line">UserParameter=used_memory_startup[*],cat /tmp/redis.log |grep used_memory_startup |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#数据集的大小（used_memory减去used_memory_overhead）</span><br><span class="line">UserParameter=used_memory_dataset[*],cat /tmp/redis.log |grep used_memory_dataset |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#数据集内存占净内存的百分比（used_memory_dataset/(used_memory-used_memory_startup))</span><br><span class="line">UserParameter=used_memory_dataset_perc[*],cat /tmp/redis.log |grep used_memory_dataset_perc |cut -d&apos;:&apos; -f2|head -1|cut -d&apos;%&apos; -f1</span><br><span class="line">#lua引擎使用的内存</span><br><span class="line">UserParameter=used_memory_lua[*],cat /tmp/redis.log |grep used_memory_lua |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#系统配置文件配置的内存</span><br><span class="line">UserParameter=maxmemory[*],cat /tmp/redis.log |grep maxmemory |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#内存碎片率（需要重点关注）远大于1过高说明内存碎片化严重，原小于1过低说明有大量内存交换，建议增加内存。</span><br><span class="line">UserParameter=mem_fragmentation_ratio[*],cat /tmp/redis.log |grep mem_fragmentation_ratio |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#自上次转存以来redis发生的更改数</span><br><span class="line">UserParameter=rdb_changes_since_last_save[*],cat /tmp/redis.log |grep rdb_changes_since_last_save |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端接受的总连接数</span><br><span class="line">UserParameter=total_connections_received[*],cat /tmp/redis.log |grep total_connections_received |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端处理命令总数</span><br><span class="line">UserParameter=total_commands_processed[*],cat /tmp/redis.log |grep total_commands_processed |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#服务端每秒处理命令数</span><br><span class="line">UserParameter=instantaneous_ops_per_sec[*],cat /tmp/redis.log |grep instantaneous_ops_per_sec |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#网络读取的总流量</span><br><span class="line">UserParameter=total_net_input_bytes[*],cat /tmp/redis.log |grep total_net_input_bytes |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#网络写入的总流量</span><br><span class="line">UserParameter=total_net_output_bytes[*],cat /tmp/redis.log |grep total_net_output_bytes |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#每秒网络读的流量</span><br><span class="line">UserParameter=instantaneous_input_kbps[*],cat /tmp/redis.log |grep instantaneous_input_kbps |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#每秒网络写的流量</span><br><span class="line">UserParameter=instantaneous_output_kbps[*],cat /tmp/redis.log |grep instantaneous_output_kbps |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#因最大连接数达到上限，而被拒绝的连接数，maxclient默认值为10000</span><br><span class="line">UserParameter=rejected_connections[*],cat /tmp/redis.log |grep rejected_connections |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#键值到期总数</span><br><span class="line">UserParameter=expired_keys[*],cat /tmp/redis.log |grep expired_keys |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#因maxmemory限制，被驱逐的键值</span><br><span class="line">UserParameter=evicted_keys[*],cat /tmp/redis.log |grep evicted_keys |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#在主字典里面键值匹配成功的次数</span><br><span class="line">UserParameter=keyspace_hits[*],cat /tmp/redis.log |grep keyspace_hits |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#在主字典里面键值匹配失败的次数</span><br><span class="line">UserParameter=keyspace_misses[*],cat /tmp/redis.log |grep keyspace_misses |cut -d&apos;:&apos; -f2|head -1</span><br><span class="line">#db0数据库键值的数量</span><br><span class="line">UserParameter=db0_keys[*], cat /tmp/redis.log |grep db0 |cat /tmp/redis.log |grep db0|cut -d &apos;,&apos; -f1|cut -d &apos;=&apos; -f2</span><br><span class="line">#db0数据库键值过期的数量</span><br><span class="line">UserParameter=db0_keys_expired[*],cat /tmp/redis.log |cat /tmp/redis.log |grep db0|cut -d &apos;,&apos; -f2|cut -d &apos;=&apos; -f2</span><br></pre></td></tr></table></figure>
<h3 id="4、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数："><a href="#4、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数：" class="headerlink" title="4、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数："></a>4、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span><br></pre></td></tr></table></figure>
<p>添加完成之后，需要重启zabbix_agent客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure></p>
<h3 id="5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载"><a href="#5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载" class="headerlink" title="5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击下载"></a>5、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的redis模板，上传到百度云，仅供参考，点击<a href="https://pan.baidu.com/s/1dpWSBo-gZXk34aQNtjwqEw" target="_blank" rel="noopener">下载</a></h3>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a><a href="/tags/redis/">redis</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/17/zabbix监控redis/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/17/samba配置/"><span>[linux] suse_11_sp4安装samba-server</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/17/samba配置/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-17T09:16:24.000Z">
          2018-08-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、当前系统版本"><a href="#0、当前系统版本" class="headerlink" title="0、当前系统版本"></a>0、当前系统版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">Welcome to SUSE Linux Enterprise Server 11 SP4  (x86_64) - Kernel \r (\l).</span><br></pre></td></tr></table></figure>
<h2 id="1、查看samba是否安装"><a href="#1、查看samba是否安装" class="headerlink" title="1、查看samba是否安装"></a>1、查看samba是否安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # rpm -q samba</span><br><span class="line">samba-3.6.3-0.58.1</span><br></pre></td></tr></table></figure>
<p>如果没有安装，使用以下命令安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # zypper install samba</span><br></pre></td></tr></table></figure></p>
<h2 id="2、新建共享目录"><a href="#2、新建共享目录" class="headerlink" title="2、新建共享目录"></a>2、新建共享目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # mkdir -p /data/share</span><br></pre></td></tr></table></figure>
<h2 id="3、开始配置共享目录"><a href="#3、开始配置共享目录" class="headerlink" title="3、开始配置共享目录"></a>3、开始配置共享目录</h2><p>yast进入控制台,network services-samba server<br><img src="https://i.imgur.com/LZWt4Tz.png" alt=""><br>第一次启用samba server会做一些初始化，操作如下（也可根据自己需求自定义）：<br><img src="https://i.imgur.com/xFQrJwS.png" alt=""><br><img src="https://i.imgur.com/BUT6kUS.png" alt=""><br><img src="https://i.imgur.com/G06GBBG.png" alt=""><br>初始化完成之后，再一次进入samba server,会显示如下：<br><img src="https://i.imgur.com/P74w0YP.png" alt=""><br>点击add,开始新增共享目录<br><img src="https://i.imgur.com/e0OSaZ3.png" alt=""><br>修改完成之后保存，会显示新的share目录<br><img src="https://i.imgur.com/r0ueNn5.png" alt=""></p>
<h2 id="4、添加smbuser系统用户"><a href="#4、添加smbuser系统用户" class="headerlink" title="4、添加smbuser系统用户"></a>4、添加smbuser系统用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # useradd smbuser</span><br><span class="line">localhost:~ # passwd smbuser</span><br><span class="line">Changing password for smbuser.</span><br><span class="line">New Password: </span><br><span class="line">Bad password: too simple</span><br><span class="line">Reenter New Password: </span><br><span class="line">Password changed.</span><br></pre></td></tr></table></figure>
<h2 id="5、为samba服务添加访问用户，设置访问用的密码："><a href="#5、为samba服务添加访问用户，设置访问用的密码：" class="headerlink" title="5、为samba服务添加访问用户，设置访问用的密码："></a>5、为samba服务添加访问用户，设置访问用的密码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # smbpasswd -a smbuser</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user smbuser.</span><br></pre></td></tr></table></figure>
<h2 id="6、修改共享目录权限"><a href="#6、修改共享目录权限" class="headerlink" title="6、修改共享目录权限"></a>6、修改共享目录权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown smbuser /data/share</span><br><span class="line">chmod 777 /data/share</span><br></pre></td></tr></table></figure>
<p>**如果不修改目录权限，访问预览都是正常的，但是没有写权限，创建目录会报错</p>
<h2 id="7、修改配置配置文件-添加读写权限"><a href="#7、修改配置配置文件-添加读写权限" class="headerlink" title="7、修改配置配置文件,添加读写权限"></a>7、修改配置配置文件,添加读写权限</h2><p>vim /etc/samba/smb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[share]</span></span><br><span class="line">        <span class="string">comment</span> <span class="string">=</span> <span class="string">share</span></span><br><span class="line">        <span class="string">inherit</span> <span class="string">acls</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">        <span class="string">path</span> <span class="string">=</span> <span class="string">/data/share</span></span><br><span class="line">        <span class="string">read</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">No</span></span><br><span class="line">        <span class="string">Valid</span> <span class="string">users</span> <span class="string">=smbuser</span></span><br><span class="line">        <span class="string">Writable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">　      <span class="string">Browsable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br></pre></td></tr></table></figure></p>
<h2 id="8、重启samba服务器"><a href="#8、重启samba服务器" class="headerlink" title="8、重启samba服务器"></a>8、重启samba服务器</h2><p>/etc/rc.d/smb restart</p>
<h2 id="9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口"><a href="#9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口" class="headerlink" title="9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口"></a>9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口</h2><p>vim /etc/sysconfig/SuSEfirewall2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FW_SERVICES_EXT_TCP=&quot;22 1521 139 445&quot;</span><br></pre></td></tr></table></figure></p>
<p>重新启动防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rcSuSEfirewall2 restart</span><br></pre></td></tr></table></figure></p>
<h2 id="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："><a href="#10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：" class="headerlink" title="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："></a>10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：</h2><p><img src="https://i.imgur.com/XPOeklf.png" alt=""><br>因此修改sambaserver服务器端的协议，启用smbv2协议<br>vim /etc/samba/smb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">min protocol = SMB2</span><br><span class="line">max protocol = SMB2</span><br><span class="line">client min protocol = SMB2</span><br><span class="line">client max protocol = SMB2</span><br></pre></td></tr></table></figure></p>
<p>重启samba服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.d/smb restart</span><br></pre></td></tr></table></figure></p>
<h2 id="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"><a href="#11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误" class="headerlink" title="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"></a>11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -U smbuser //10.0.30.180/share -m smb2</span><br><span class="line">Unrecognised protocol level smb2</span><br><span class="line">WARNING: Ignoring invalid value &apos;SMB3&apos; for parameter &apos;max protocol&apos;</span><br><span class="line">Unknown parameter encountered: &quot;client min protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client min protocol&quot;</span><br><span class="line">Unknown parameter encountered: &quot;client max protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client max protocol&quot;</span><br></pre></td></tr></table></figure>
<p>该问题为suse 11版本的问题，默认只支持smbv1协议，suse12版本之后才开始支持smbv2.</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/17/samba配置/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/17/mysql lock table && unlock tables实验/"><span>[Mysql] mysql lock table &amp;&amp; unlock tables实验</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/17/mysql lock table && unlock tables实验/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-17T04:03:24.000Z">
          2018-08-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、mysql版本"><a href="#0、mysql版本" class="headerlink" title="0、mysql版本"></a>0、mysql版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:12:  [aaaa]&gt; select @@version;</span><br><span class="line">+------------+</span><br><span class="line">| @@version  |</span><br><span class="line">+------------+</span><br><span class="line">| 5.7.22-log |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="1、创建实验表，内容如下："><a href="#1、创建实验表，内容如下：" class="headerlink" title="1、创建实验表，内容如下："></a>1、创建实验表，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:11:  [aaaa]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_aaaa |</span><br><span class="line">+----------------+</span><br><span class="line">| aaa            |</span><br><span class="line">| bbb            |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from bbb;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="2、开启两个会话，session1、session2-对表aaa进行read表锁"><a href="#2、开启两个会话，session1、session2-对表aaa进行read表锁" class="headerlink" title="2、开启两个会话，session1、session2,对表aaa进行read表锁"></a>2、开启两个会话，session1、session2,对表aaa进行read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:16:  [aaaa]&gt; lock table aaa read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:17:  [aaaa]&gt; </span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;aaa&apos; was locked with a READ lock and can&apos;t be updated</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:18:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:20:  [aaaa]&gt; show OPEN TABLES where In_use &gt; 0;</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| Database | Table | In_use | Name_locked |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| aaaa     | aaa   |      1 |           0 |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：在session1对表aaa进行read锁表，session1只能对表aaa进行读操作，对其他表没有任何操作权限，session2对表aaa有读权限，没有写权限。</p>
<h2 id="3、开启两个会话，session1、session2-对表aaa进行write表锁"><a href="#3、开启两个会话，session1、session2-对表aaa进行write表锁" class="headerlink" title="3、开启两个会话，session1、session2,对表aaa进行write表锁"></a>3、开启两个会话，session1、session2,对表aaa进行write表锁</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; lock table aaa write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:27:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">root@db 15:29:  [aaaa]&gt; update bbb set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:20:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:28:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:31:  [aaaa]&gt; unlock  tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：在session1对表aaa进行write锁表，session1对表aaa有读写权限，对其他表没有任何操作权限，session2对表aaa即没有读权限，又没有写权限。</p>
<h2 id="4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁"><a href="#4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁" class="headerlink" title="4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁"></a>4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:32:  [aaaa]&gt; lock table aaa write , aaa as t1 read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:32root@db 04:01:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:01:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:02:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;t1&apos; was locked with a READ lock and can&apos;t be updated</span><br><span class="line">root@db 04:04:  [aaaa]&gt; update aaa  set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa as t1;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;1&apos; for key &apos;PRIMARY&apos;</span><br></pre></td></tr></table></figure></p>
<p>session2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:05:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 04:06:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=2;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:07:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：session1对表aaa同时进行read，write锁，需要使用别名。对表进行select,update操作正常，如果使用insert into aaa select * from aaa as t1;需要加上别名。session 2对表aaa即没有读权限，又没有写权限。</p>
<h2 id="5、对表aaa进行read表锁，并使用别名"><a href="#5、对表aaa进行read表锁，并使用别名" class="headerlink" title="5、对表aaa进行read表锁，并使用别名"></a>5、对表aaa进行read表锁，并使用别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:47:  [aaaa]&gt;  LOCK TABLE aaa AS t1 READ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:48:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：session 1对表aaa加别名read表锁，session1查询需要使用别名，直接查询无效，session2对表aaa有读权限，无写权限</p>
<h2 id="6、对表aaa使用write表锁，并添加别名"><a href="#6、对表aaa使用write表锁，并添加别名" class="headerlink" title="6、对表aaa使用write表锁，并添加别名"></a>6、对表aaa使用write表锁，并添加别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:51:  [aaaa]&gt; LOCK TABLE aaa AS t1 write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; </span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:54:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：session 1对表aaa加别名write表锁，session1查询和更改需要使用别名，直接查询和更改无效，session2对表aaa无读权限，无写权限</p>
<p>##7、额外提示：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">LOCK</span> <span class="string">TABLES或者UNLOCK</span> <span class="string">TABLES，当应用于分区表时，始终锁定或解锁整个表;</span> <span class="string">这些语句不支持分区锁定修剪</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/17/mysql lock table && unlock tables实验/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/15/zabbix监控mongodb/"><span>[Zabbix] zabbix监控mongodb数据库</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/15/zabbix监控mongodb/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-15T13:30:24.000Z">
          2018-08-15
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"><a href="#1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本" class="headerlink" title="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"></a>1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本</h2><p>mkdir -p /usr/local/zabbix/script<br>vim /usr/local/zabbix/script/zabbix_monitor_mongodb.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#mongodb管理员用户</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#mongodb管理员密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#Mongodb指定验证数据库</span></span><br><span class="line"><span class="string">authdb=admin</span></span><br><span class="line"><span class="comment">#mongodb指定端口</span></span><br><span class="line"><span class="string">dbport=30000</span></span><br><span class="line"><span class="comment">#mongodb安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongo</span> <span class="bullet">--port</span> <span class="string">$&#123;dbport&#125;</span> <span class="bullet">-u</span> <span class="string">$&#123;authuser&#125;</span> <span class="bullet">-p</span> <span class="string">$&#123;authpass&#125;</span> <span class="bullet">--authenticationDatabase</span> <span class="string">$&#123;authdb&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>授权脚本执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/zabbix_monitor_mongodb.sh</span><br></pre></td></tr></table></figure></p>
<h2 id="2、修改zabbix监控项脚本，用于获取mongodb参数"><a href="#2、修改zabbix监控项脚本，用于获取mongodb参数" class="headerlink" title="2、修改zabbix监控项脚本，用于获取mongodb参数"></a>2、修改zabbix监控项脚本，用于获取mongodb参数</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/zabbix_mongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#当前连接数，包括当前的shell会话，副本集成员连接，mongos实例连接</span><br><span class="line">#(4.0version)connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前可用的连接数，数据库上的连接负载的值</span><br><span class="line">#(4.0version)connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#服务器所有的连接，包括已经关闭的连接</span><br><span class="line">#(4.0version)connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p|cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line"></span><br><span class="line">#因锁而造成排队等待的总数</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因读锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因写锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用内存情况</span><br><span class="line">#(4.0version)mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用虚拟内存的大小</span><br><span class="line">#(4.0version)mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#流入mongodb数据库的总量</span><br><span class="line">#(4.0version)network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库流出总量</span><br><span class="line">#(4.0version)network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1|cut -d &apos;&quot;&apos; -f2|cut -d &apos;&quot;&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库总请求数</span><br><span class="line">#(4.0version)network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前副本集状态，为1代表为主节点，为2代表为从节点</span><br><span class="line">#(4.0version)rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#页错误总数，当数据库性能不佳、内存限制、或者数据库较大会导致该值增加</span><br><span class="line">#(4.0version)extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br></pre></td></tr></table></figure></p>
<h2 id="3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件"><a href="#3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件" class="headerlink" title="3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件"></a>3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span></span><br></pre></td></tr></table></figure></p>
<h2 id="4、重新启动agent客户端"><a href="#4、重新启动agent客户端" class="headerlink" title="4、重新启动agent客户端"></a>4、重新启动agent客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure>
<h2 id="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"><a href="#5、通过zabbix-web端，添加配置模板，参考模板，点击下载" class="headerlink" title="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"></a>5、通过zabbix-web端，添加配置模板，参考模板，点击<a href="https://pan.baidu.com/s/1tpyzeOEFihpWge_IN-zDdw" target="_blank" rel="noopener">下载</a></h2>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a><a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/15/zabbix监控mongodb/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/7/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/9/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2019 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>