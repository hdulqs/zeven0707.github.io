<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 8 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/17/samba配置/"><span>[linux] suse_11_sp4安装samba-server</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/17/samba配置/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-17T09:16:24.000Z">
          2018-08-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、当前系统版本"><a href="#0、当前系统版本" class="headerlink" title="0、当前系统版本"></a>0、当前系统版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">Welcome to SUSE Linux Enterprise Server 11 SP4  (x86_64) - Kernel \r (\l).</span><br></pre></td></tr></table></figure>
<h2 id="1、查看samba是否安装"><a href="#1、查看samba是否安装" class="headerlink" title="1、查看samba是否安装"></a>1、查看samba是否安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # rpm -q samba</span><br><span class="line">samba-3.6.3-0.58.1</span><br></pre></td></tr></table></figure>
<p>如果没有安装，使用以下命令安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # zypper install samba</span><br></pre></td></tr></table></figure></p>
<h2 id="2、新建共享目录"><a href="#2、新建共享目录" class="headerlink" title="2、新建共享目录"></a>2、新建共享目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # mkdir -p /data/share</span><br></pre></td></tr></table></figure>
<h2 id="3、开始配置共享目录"><a href="#3、开始配置共享目录" class="headerlink" title="3、开始配置共享目录"></a>3、开始配置共享目录</h2><p>yast进入控制台,network services-samba server<br><img src="https://i.imgur.com/LZWt4Tz.png" alt=""><br>第一次启用samba server会做一些初始化，操作如下（也可根据自己需求自定义）：<br><img src="https://i.imgur.com/xFQrJwS.png" alt=""><br><img src="https://i.imgur.com/BUT6kUS.png" alt=""><br><img src="https://i.imgur.com/G06GBBG.png" alt=""><br>初始化完成之后，再一次进入samba server,会显示如下：<br><img src="https://i.imgur.com/P74w0YP.png" alt=""><br>点击add,开始新增共享目录<br><img src="https://i.imgur.com/e0OSaZ3.png" alt=""><br>修改完成之后保存，会显示新的share目录<br><img src="https://i.imgur.com/r0ueNn5.png" alt=""></p>
<h2 id="4、添加smbuser系统用户"><a href="#4、添加smbuser系统用户" class="headerlink" title="4、添加smbuser系统用户"></a>4、添加smbuser系统用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # useradd smbuser</span><br><span class="line">localhost:~ # passwd smbuser</span><br><span class="line">Changing password for smbuser.</span><br><span class="line">New Password: </span><br><span class="line">Bad password: too simple</span><br><span class="line">Reenter New Password: </span><br><span class="line">Password changed.</span><br></pre></td></tr></table></figure>
<h2 id="5、为samba服务添加访问用户，设置访问用的密码："><a href="#5、为samba服务添加访问用户，设置访问用的密码：" class="headerlink" title="5、为samba服务添加访问用户，设置访问用的密码："></a>5、为samba服务添加访问用户，设置访问用的密码：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">localhost:~ # smbpasswd -a smbuser</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user smbuser.</span><br></pre></td></tr></table></figure>
<h2 id="6、修改共享目录权限"><a href="#6、修改共享目录权限" class="headerlink" title="6、修改共享目录权限"></a>6、修改共享目录权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown smbuser /data/share</span><br><span class="line">chmod 777 /data/share</span><br></pre></td></tr></table></figure>
<p>**如果不修改目录权限，访问预览都是正常的，但是没有写权限，创建目录会报错</p>
<h2 id="7、修改配置配置文件-添加读写权限"><a href="#7、修改配置配置文件-添加读写权限" class="headerlink" title="7、修改配置配置文件,添加读写权限"></a>7、修改配置配置文件,添加读写权限</h2><p>vim /etc/samba/smb.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[share]</span></span><br><span class="line">        <span class="string">comment</span> <span class="string">=</span> <span class="string">share</span></span><br><span class="line">        <span class="string">inherit</span> <span class="string">acls</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">        <span class="string">path</span> <span class="string">=</span> <span class="string">/data/share</span></span><br><span class="line">        <span class="string">read</span> <span class="string">only</span> <span class="string">=</span> <span class="literal">No</span></span><br><span class="line">        <span class="string">Valid</span> <span class="string">users</span> <span class="string">=smbuser</span></span><br><span class="line">        <span class="string">Writable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br><span class="line">　      <span class="string">Browsable</span> <span class="string">=</span> <span class="literal">Yes</span></span><br></pre></td></tr></table></figure></p>
<h2 id="8、重启samba服务器"><a href="#8、重启samba服务器" class="headerlink" title="8、重启samba服务器"></a>8、重启samba服务器</h2><p>/etc/rc.d/smb restart</p>
<h2 id="9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口"><a href="#9、suse默认防火墙是开启的，客户端要访问samba-需要开启139和445端口" class="headerlink" title="9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口"></a>9、suse默认防火墙是开启的，客户端要访问samba,需要开启139和445端口</h2><p>vim /etc/sysconfig/SuSEfirewall2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FW_SERVICES_EXT_TCP=&quot;22 1521 139 445&quot;</span><br></pre></td></tr></table></figure></p>
<p>重新启动防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rcSuSEfirewall2 restart</span><br></pre></td></tr></table></figure></p>
<h2 id="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："><a href="#10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：" class="headerlink" title="10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误："></a>10、windows10之后微软默认已放弃安装smbv1客户端，使用windows访问会报如下错误：</h2><p><img src="https://i.imgur.com/XPOeklf.png" alt=""><br>因此修改sambaserver服务器端的协议，启用smbv2协议<br>vim /etc/samba/smb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">min protocol = SMB2</span><br><span class="line">max protocol = SMB2</span><br><span class="line">client min protocol = SMB2</span><br><span class="line">client max protocol = SMB2</span><br></pre></td></tr></table></figure></p>
<p>重启samba服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.d/smb restart</span><br></pre></td></tr></table></figure></p>
<h2 id="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"><a href="#11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误" class="headerlink" title="11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误"></a>11、在sambaserver本地服务器测试的时候，哪怕指定了smb2协议，也会报如下错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -U smbuser //10.0.30.180/share -m smb2</span><br><span class="line">Unrecognised protocol level smb2</span><br><span class="line">WARNING: Ignoring invalid value &apos;SMB3&apos; for parameter &apos;max protocol&apos;</span><br><span class="line">Unknown parameter encountered: &quot;client min protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client min protocol&quot;</span><br><span class="line">Unknown parameter encountered: &quot;client max protocol&quot;</span><br><span class="line">Ignoring unknown parameter &quot;client max protocol&quot;</span><br></pre></td></tr></table></figure>
<p>该问题为suse 11版本的问题，默认只支持smbv1协议，suse12版本之后才开始支持smbv2.</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/17/samba配置/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/17/mysql lock table && unlock tables实验/"><span>[Mysql] mysql lock table &amp;&amp; unlock tables实验</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/17/mysql lock table && unlock tables实验/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-17T04:03:24.000Z">
          2018-08-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、mysql版本"><a href="#0、mysql版本" class="headerlink" title="0、mysql版本"></a>0、mysql版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:12:  [aaaa]&gt; select @@version;</span><br><span class="line">+------------+</span><br><span class="line">| @@version  |</span><br><span class="line">+------------+</span><br><span class="line">| 5.7.22-log |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="1、创建实验表，内容如下："><a href="#1、创建实验表，内容如下：" class="headerlink" title="1、创建实验表，内容如下："></a>1、创建实验表，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:11:  [aaaa]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_aaaa |</span><br><span class="line">+----------------+</span><br><span class="line">| aaa            |</span><br><span class="line">| bbb            |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:15:  [aaaa]&gt; select * from bbb;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="2、开启两个会话，session1、session2-对表aaa进行read表锁"><a href="#2、开启两个会话，session1、session2-对表aaa进行read表锁" class="headerlink" title="2、开启两个会话，session1、session2,对表aaa进行read表锁"></a>2、开启两个会话，session1、session2,对表aaa进行read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:16:  [aaaa]&gt; lock table aaa read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:17:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:17:  [aaaa]&gt; </span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;aaa&apos; was locked with a READ lock and can&apos;t be updated</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:18:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:18:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:20:  [aaaa]&gt; show OPEN TABLES where In_use &gt; 0;</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| Database | Table | In_use | Name_locked |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">| aaaa     | aaa   |      1 |           0 |</span><br><span class="line">+----------+-------+--------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：在session1对表aaa进行read锁表，session1只能对表aaa进行读操作，对其他表没有任何操作权限，session2对表aaa有读权限，没有写权限。</p>
<h2 id="3、开启两个会话，session1、session2-对表aaa进行write表锁"><a href="#3、开启两个会话，session1、session2-对表aaa进行write表锁" class="headerlink" title="3、开启两个会话，session1、session2,对表aaa进行write表锁"></a>3、开启两个会话，session1、session2,对表aaa进行write表锁</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:21:  [aaaa]&gt; lock table aaa write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line">root@db 15:26:  [aaaa]&gt; select * from bbb;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 15:27:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">root@db 15:29:  [aaaa]&gt; update bbb set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;bbb&apos; was not locked with LOCK TABLES</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:20:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 15:28:  [aaaa]&gt;  update aaa set name=&apos;e&apos; where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:31:  [aaaa]&gt; unlock  tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：在session1对表aaa进行write锁表，session1对表aaa有读写权限，对其他表没有任何操作权限，session2对表aaa即没有读权限，又没有写权限。</p>
<h2 id="4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁"><a href="#4、开启两个会话，session1、session2-对表aaa进行write-amp-read表锁" class="headerlink" title="4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁"></a>4、开启两个会话，session1、session2,对表aaa进行write&amp;read表锁</h2><p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@db 15:32:  [aaaa]&gt; lock table aaa write , aaa as t1 read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">root@db 15:32root@db 04:01:  [aaaa]&gt; select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:01:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 04:02:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1099 (HY000): Table &apos;t1&apos; was locked with a READ lock and can&apos;t be updated</span><br><span class="line">root@db 04:04:  [aaaa]&gt; update aaa  set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 04:04:  [aaaa]&gt; insert into aaa select * from aaa as t1;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &apos;1&apos; for key &apos;PRIMARY&apos;</span><br></pre></td></tr></table></figure></p>
<p>session2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:05:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">root@db 04:06:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id=2;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 04:07:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：session1对表aaa同时进行read，write锁，需要使用别名。对表进行select,update操作正常，如果使用insert into aaa select * from aaa as t1;需要加上别名。session 2对表aaa即没有读权限，又没有写权限。</p>
<h2 id="5、对表aaa进行read表锁，并使用别名"><a href="#5、对表aaa进行read表锁，并使用别名" class="headerlink" title="5、对表aaa进行read表锁，并使用别名"></a>5、对表aaa进行read表锁，并使用别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:47:  [aaaa]&gt;  LOCK TABLE aaa AS t1 READ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:47:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> select * from aaa;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:48:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：session 1对表aaa加别名read表锁，session1查询需要使用别名，直接查询无效，session2对表aaa有读权限，无写权限</p>
<h2 id="6、对表aaa使用write表锁，并添加别名"><a href="#6、对表aaa使用write表锁，并添加别名" class="headerlink" title="6、对表aaa使用write表锁，并添加别名"></a>6、对表aaa使用write表锁，并添加别名</h2><p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:51:  [aaaa]&gt; LOCK TABLE aaa AS t1 write;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; </span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:53:  [aaaa]&gt; select * from aaa as t1;</span><br><span class="line">+----+------+-------------+</span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">|  1 | e    | 11111111111 |</span><br><span class="line">|  2 | e    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">|  4 | d    | 44444444    |</span><br><span class="line">|  5 | f    | 5555555     |</span><br><span class="line">+----+------+-------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:53:  [aaaa]&gt; update aaa set name=&apos;e&apos; where id =1;</span><br><span class="line">ERROR 1100 (HY000): Table &apos;aaa&apos; was not locked with LOCK TABLES</span><br><span class="line">root@db 03:54:  [aaaa]&gt; update aaa as t1 set name=&apos;e&apos; where id =1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>session 2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; select * from aaa;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>session 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:55:  [aaaa]&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>结论：session 1对表aaa加别名write表锁，session1查询和更改需要使用别名，直接查询和更改无效，session2对表aaa无读权限，无写权限</p>
<p>##7、额外提示：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">LOCK</span> <span class="string">TABLES或者UNLOCK</span> <span class="string">TABLES，当应用于分区表时，始终锁定或解锁整个表;</span> <span class="string">这些语句不支持分区锁定修剪</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/17/mysql lock table && unlock tables实验/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/15/zabbix监控mongodb/"><span>[Zabbix] zabbix监控mongodb数据库</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/15/zabbix监控mongodb/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-15T13:30:24.000Z">
          2018-08-15
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"><a href="#1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本" class="headerlink" title="1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本"></a>1、创建监控脚本，用于连接mongodb数据库，可根据自身数据库配置修改该脚本</h2><p>mkdir -p /usr/local/zabbix/script<br>vim /usr/local/zabbix/script/zabbix_monitor_mongodb.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#mongodb管理员用户</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#mongodb管理员密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#Mongodb指定验证数据库</span></span><br><span class="line"><span class="string">authdb=admin</span></span><br><span class="line"><span class="comment">#mongodb指定端口</span></span><br><span class="line"><span class="string">dbport=30000</span></span><br><span class="line"><span class="comment">#mongodb安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongo</span> <span class="bullet">--port</span> <span class="string">$&#123;dbport&#125;</span> <span class="bullet">-u</span> <span class="string">$&#123;authuser&#125;</span> <span class="bullet">-p</span> <span class="string">$&#123;authpass&#125;</span> <span class="bullet">--authenticationDatabase</span> <span class="string">$&#123;authdb&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>授权脚本执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/zabbix_monitor_mongodb.sh</span><br></pre></td></tr></table></figure></p>
<h2 id="2、修改zabbix监控项脚本，用于获取mongodb参数"><a href="#2、修改zabbix监控项脚本，用于获取mongodb参数" class="headerlink" title="2、修改zabbix监控项脚本，用于获取mongodb参数"></a>2、修改zabbix监控项脚本，用于获取mongodb参数</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf.d/zabbix_mongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#当前连接数，包括当前的shell会话，副本集成员连接，mongos实例连接</span><br><span class="line">#(4.0version)connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.current[*],echo &quot;db.serverStatus().connections.current&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前可用的连接数，数据库上的连接负载的值</span><br><span class="line">#(4.0version)connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.available[*],echo &quot;db.serverStatus().connections.available&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#服务器所有的连接，包括已经关闭的连接</span><br><span class="line">#(4.0version)connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=connections.totalCreated[*],echo &quot;db.serverStatus().connections.totalCreated&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p|cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line"></span><br><span class="line">#因锁而造成排队等待的总数</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.total[*],echo &quot;db.serverStatus().globalLock.currentQueue.total&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因读锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.readers[*],echo &quot;db.serverStatus().globalLock.currentQueue.readers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#因写锁而造成排队等待的数量</span><br><span class="line">#(4.0version)UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=globalLock.currentQueue.writers[*],echo &quot;db.serverStatus().globalLock.currentQueue.writers&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用内存情况</span><br><span class="line">#(4.0version)mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.resident[*],echo &quot;db.serverStatus().mem.resident&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前数据库进程占用虚拟内存的大小</span><br><span class="line">#(4.0version)mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=mem.virtual[*],echo &quot;db.serverStatus().mem.virtual&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#流入mongodb数据库的总量</span><br><span class="line">#(4.0version)network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesIn[*],echo &quot;db.serverStatus().network.bytesIn&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库流出总量</span><br><span class="line">#(4.0version)network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1|cut -d &apos;&quot;&apos; -f2|cut -d &apos;&quot;&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.bytesOut[*],echo &quot;db.serverStatus().network.bytesOut&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#数据库总请求数</span><br><span class="line">#(4.0version)network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh| grep NumberLong |cut -d &apos;(&apos; -f2|cut -d &apos;)&apos; -f1</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=network.numRequests[*],echo &quot;db.serverStatus().network.numRequests&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#当前副本集状态，为1代表为主节点，为2代表为从节点</span><br><span class="line">#(4.0version)rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=rs.status.myState[*],echo &quot;rs.status().myState&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br><span class="line"></span><br><span class="line">#页错误总数，当数据库性能不佳、内存限制、或者数据库较大会导致该值增加</span><br><span class="line">#(4.0version)extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 4p</span><br><span class="line">#3.0version</span><br><span class="line">UserParameter=extra_info.page_faults[*],echo &quot;db.serverStatus().extra_info.page_faults&quot;|sh /usr/local/zabbix/script/zabbix_monitor_mongodb.sh|sed -n 3p</span><br></pre></td></tr></table></figure></p>
<h2 id="3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件"><a href="#3、修改zabbix-agent配置文件，添加zabbix-agentd-conf-d目录，用于加载该目录下文件" class="headerlink" title="3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件"></a>3、修改zabbix-agent配置文件，添加zabbix_agentd.conf.d目录，用于加载该目录下文件</h2><p>vim /usr/local/zabbix/etc/zabbix_agentd.conf<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span></span><br></pre></td></tr></table></figure></p>
<h2 id="4、重新启动agent客户端"><a href="#4、重新启动agent客户端" class="headerlink" title="4、重新启动agent客户端"></a>4、重新启动agent客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/zabbix_agentd restart</span><br></pre></td></tr></table></figure>
<h2 id="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"><a href="#5、通过zabbix-web端，添加配置模板，参考模板，点击下载" class="headerlink" title="5、通过zabbix-web端，添加配置模板，参考模板，点击下载"></a>5、通过zabbix-web端，添加配置模板，参考模板，点击<a href="https://pan.baidu.com/s/1tpyzeOEFihpWge_IN-zDdw" target="_blank" rel="noopener">下载</a></h2>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a><a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/15/zabbix监控mongodb/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/14/zabbix监控mysql/"><span>[Zabbix] zabbix监控mysql数据库</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/14/zabbix监控mysql/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-14T10:30:24.000Z">
          2018-08-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、编写定期收集mysql信息脚本，并指定到对应目录"><a href="#1、编写定期收集mysql信息脚本，并指定到对应目录" class="headerlink" title="1、编写定期收集mysql信息脚本，并指定到对应目录"></a>1、编写定期收集mysql信息脚本，并指定到对应目录</h3><p>cat /usr/local/zabbix/script/mysql_monitor.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">dbpath='/data/mysql/bin/mysql'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的用户</span></span><br><span class="line">dbuser='root'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的密码</span></span><br><span class="line">dbpass='123456'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的端口</span></span><br><span class="line">dbport='3306'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql的socket文件</span></span><br><span class="line">dbsocket='/data/mysql/tmp/mysql.sock'</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-status日志路径</span></span><br><span class="line">dbstatuspath=/tmp/mysql_status_monitor.log</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql-engine-status日志路径</span></span><br><span class="line">dbenginestatuspath=/tmp/mysql_engine_innodb_status.log</span><br><span class="line"><span class="meta">#</span><span class="bash">self-define-script</span></span><br><span class="line">dbselfpath=/tmp/mysql_self_status.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查询mysql-status信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbpath&#125; -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> -S<span class="variable">$&#123;dbsocket&#125;</span> -P<span class="variable">$&#123;dbport&#125;</span> -BNe <span class="string">"show global status;"</span> &gt; <span class="variable">$&#123;dbstatuspath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查询mysql-engine-innodb信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;dbpath&#125; -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> -S<span class="variable">$&#123;dbsocket&#125;</span> -P<span class="variable">$&#123;dbport&#125;</span> -BNe <span class="string">"show engine innodb status\G"</span> &gt; <span class="variable">$&#123;dbenginestatuspath&#125;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">检查集群节点</span></span><br><span class="line">nodecount=`export MYSQL_PWD=$&#123;dbpass&#125;;$&#123;dbpath&#125; -u$&#123;dbuser&#125; --socket=/data/mysql/data/mysql.sock -P$&#123;dbport&#125; -BNe "select count(*) from performance_schema.replication_group_members where MEMBER_STATE != 'ONLINE'"`</span><br><span class="line">echo -e "nodecount $&#123;nodecount&#125;" &gt; $&#123;dbselfpath&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据自己的数据库配置，修改相应的参数，修改完成之后授权脚本执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/zabbix/script/mysql_monitor.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="2、将脚本添加到定时任务，每分钟执行一次"><a href="#2、将脚本添加到定时任务，每分钟执行一次" class="headerlink" title="2、将脚本添加到定时任务，每分钟执行一次"></a>2、将脚本添加到定时任务，每分钟执行一次</h3><p>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /usr/local/zabbix/script/mysql_monitor.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="3、编写获取数据脚本，对定时生成的log文件进行信息筛选"><a href="#3、编写获取数据脚本，对定时生成的log文件进行信息筛选" class="headerlink" title="3、编写获取数据脚本，对定时生成的log文件进行信息筛选"></a>3、编写获取数据脚本，对定时生成的log文件进行信息筛选</h3><p>cat /usr/local/zabbix/script/mysql_get_data.sh<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">case $1 in</span><br><span class="line">	nodecount)</span><br><span class="line">       #查询集群节点存活状态</span><br><span class="line">       cat /tmp/mysql_self_status.log |awk '/nodecount/ &#123;print $2&#125;' |head -1 </span><br><span class="line">       ;;</span><br><span class="line">	uptime)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_select)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_select/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    com_insert)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_insert/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_update)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_update/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    com_delete)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Com_delete/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    connections)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Connections/ &#123;print $2&#125;'|head -1</span><br><span class="line">       ;;</span><br><span class="line">    thread_cached)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_cached/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    threads_connected)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_connected/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    thread_created)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_created/ &#123;print $2&#125;'            </span><br><span class="line">       ;;</span><br><span class="line">    Threads_running)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Threads_running/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_immediate)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_immediate/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_waited)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_waited/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    slow_launch_threads)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Slow_launch_threads/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    slow_queries)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Slow_queries/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    qps)</span><br><span class="line">       uptime=`cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1`</span><br><span class="line">       questions=`cat /tmp/mysql_status_monitor.log | awk '/Questions/ &#123;print $2&#125;'`</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;questions&#125;/$&#123;uptime&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    tps)</span><br><span class="line">       uptime=`cat /tmp/mysql_status_monitor.log | awk '/Uptime/ &#123;print $2&#125;' |head -1`</span><br><span class="line">       com_commit=`cat /tmp/mysql_status_monitor.log | awk '/Com_commit/ &#123;print $2&#125;'`</span><br><span class="line">       com_rollback=`cat /tmp/mysql_status_monitor.log | awk '/Com_rollback/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       com_sum=$(($&#123;com_commit&#125;+$&#123;com_rollback&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;com_sum&#125;/$&#123;uptime&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    innodb_buffer_read_hits)</span><br><span class="line">       innodb_buffer_pool_reads=`cat /tmp/mysql_status_monitor.log | awk '/Innodb_buffer_pool_reads/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       innodb_buffer_pool_read_requests=`cat /tmp/mysql_status_monitor.log | awk '/Innodb_buffer_pool_read_requests/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       innodb_buffer_read_diff=$(($&#123;innodb_buffer_pool_read_requests&#125;-$&#123;innodb_buffer_pool_reads&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;innodb_buffer_read_diff&#125;/$&#123;innodb_buffer_pool_read_requests&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    table_cache_hit)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Opened_tables/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    thread_cache_hits)</span><br><span class="line">       thread_created=`cat /tmp/mysql_status_monitor.log | awk '/Threads_created/ &#123;print $2&#125;'`</span><br><span class="line">       connections=`cat /tmp/mysql_status_monitor.log | awk '/Connections/ &#123;print $2&#125;'|head -1`</span><br><span class="line">       thread_cache_diff=$(($&#123;connections&#125;-$&#123;thread_created&#125;))</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;thread_cache_diff&#125;/$&#123;connections&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    create_tmp_tables_hits)</span><br><span class="line">       created_tmp_tables=`cat /tmp/mysql_status_monitor.log | awk '/Created_tmp_tables/ &#123;print $2&#125;'`</span><br><span class="line">       created_tmp_disk_tables=`cat /tmp/mysql_status_monitor.log | awk '/Created_tmp_disk_tables/ &#123;print $2&#125;'`</span><br><span class="line">       echo $(printf "%.2f" `echo "scale=2;$&#123;created_tmp_disk_tables&#125;/$&#123;created_tmp_tables&#125;"|bc`)</span><br><span class="line">       ;;</span><br><span class="line">    binlog_cache_disk_use)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Binlog_cache_disk_use/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_immediate)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_immediate/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    table_locks_waited)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Table_locks_waited/ &#123;print $2&#125;'</span><br><span class="line">       ;;</span><br><span class="line">    innodb_row_lock_waits)</span><br><span class="line">       cat /tmp/mysql_status_monitor.log | awk '/Innodb_row_lock_waits/ &#123;print $2&#125;'</span><br><span class="line">       ;;               </span><br><span class="line">    *)</span><br><span class="line">       ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></p>
<h3 id="4、编写zabbix监控项文件-通过-usr-local-zabbix-script-mysql-get-data-sh脚本去获取对应监控的数值"><a href="#4、编写zabbix监控项文件-通过-usr-local-zabbix-script-mysql-get-data-sh脚本去获取对应监控的数值" class="headerlink" title="4、编写zabbix监控项文件,通过/usr/local/zabbix/script/mysql_get_data.sh脚本去获取对应监控的数值"></a>4、编写zabbix监控项文件,通过/usr/local/zabbix/script/mysql_get_data.sh脚本去获取对应监控的数值</h3><p>cat /usr/local/zabbix/etc/zabbix_agentd.conf.d/mysql_monitor_parameter.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#集群节点数量</span><br><span class="line">UserParameter=nodecount[*],sh /usr/local/zabbix/script/mysql_get_data.sh nodecount</span><br><span class="line">#系统运行时间</span><br><span class="line">UserParameter=uptime[*],sh /usr/local/zabbix/script/mysql_get_data.sh uptime</span><br><span class="line">#查看select语句的执行数</span><br><span class="line">UserParameter=com_select[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_select</span><br><span class="line">#查看insert语句的执行数</span><br><span class="line">UserParameter=com_insert[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_insert</span><br><span class="line">#查看update语句的执行数</span><br><span class="line">UserParameter=com_update[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_update</span><br><span class="line">#查看delete语句的执行数</span><br><span class="line">UserParameter=com_delete[*],sh /usr/local/zabbix/script/mysql_get_data.sh com_delete</span><br><span class="line">#查看试图连接到MySQL(不管是否连接成功)的连接数</span><br><span class="line">UserParameter=connections[*],sh /usr/local/zabbix/script/mysql_get_data.sh connections</span><br><span class="line">#查看线程缓存内的线程的数量</span><br><span class="line">UserParameter=thread_cached[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_cached</span><br><span class="line">#当线程打开连接数</span><br><span class="line">UserParameter=threads_connected[*],sh /usr/local/zabbix/script/mysql_get_data.sh threads_connected</span><br><span class="line">#查看创建用来处理连接的线程数。如果Threads_created较大，你可能要增加thread_cache_size值</span><br><span class="line">UserParameter=thread_created[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_created</span><br><span class="line">#查看激活的(非睡眠状态)线程数</span><br><span class="line">UserParameter=threads_running[*],sh /usr/local/zabbix/script/mysql_get_data.sh threads_running</span><br><span class="line">#查看创建时间超过slow_launch_time秒的线程数。</span><br><span class="line">UserParameter=slow_launch_threads[*],sh /usr/local/zabbix/script/mysql_get_data.sh slow_launch_threads</span><br><span class="line">#查看查询时间超过long_query_time秒的查询的个数。</span><br><span class="line">UserParameter=slow_queries[*],sh /usr/local/zabbix/script/mysql_get_data.sh slow_queries</span><br><span class="line">#在服务器上执行语句的数量，只包括客户端发送给服务器的语句，并不包括存储项目执行的语句</span><br><span class="line">UserParameter=qps[*],sh /usr/local/zabbix/script/mysql_get_data.sh qps</span><br><span class="line">#事物提交数量com_commit</span><br><span class="line">#事物回滚数量com_rollback</span><br><span class="line">UserParameter=tps[*],sh /usr/local/zabbix/script/mysql_get_data.sh tps</span><br><span class="line">#在buffer pool满足不了逻辑读的请求，而必须直接从硬盘读取的数量innodb_buffer_pool_reads</span><br><span class="line">#逻辑读的请求数innodb_buffer_pool_read_requests</span><br><span class="line">#buffer_read命中率</span><br><span class="line">UserParameter=innodb_buffer_read_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh innodb_buffer_read_hits</span><br><span class="line">#打开表的数量open_tables</span><br><span class="line">#已经打开表的数量opened_tables</span><br><span class="line">#table_cache命中率</span><br><span class="line">UserParameter=table_cache_hit[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_cache_hit</span><br><span class="line">#thread_cache命中率</span><br><span class="line">UserParameter=thread_cache_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh thread_cache_hits</span><br><span class="line">#执行语句过程中创建的临时表created_tmp_tables</span><br><span class="line">#当创建的内部临时表过大，mysql会自动将表从内存中转换为磁盘上的表created_tmp_disk_tables</span><br><span class="line">#在磁盘上创建临时表的比例</span><br><span class="line">UserParameter=create_tmp_tables_hits[*],sh /usr/local/zabbix/script/mysql_get_data.sh create_tmp_tables_hits</span><br><span class="line">#事物使用binlog但是临时二进制日志超过binlog_cache_size，使用临时文件存储事物的语句，如果该值不为0，需要调整binlog_cache_size</span><br><span class="line">UserParameter=binlog_cache_disk_use[*],sh /usr/local/zabbix/script/mysql_get_data.sh binlog_cache_disk_use</span><br><span class="line">#可以立即授予表锁请求的次数</span><br><span class="line">UserParameter=table_locks_immediate[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_locks_immediate</span><br><span class="line">#一个表锁的请求不能立即被授予，需要等待的次数,如果该值过高，说明数据库有性能问题，应该优化sql语句，表分区或者读写分离</span><br><span class="line">UserParameter=table_locks_waited[*],sh /usr/local/zabbix/script/mysql_get_data.sh table_locks_waited</span><br><span class="line">#操作innodb表等待行数的次数</span><br><span class="line">UserParameter=innodb_row_lock_waits[*],sh /usr/local/zabbix/script/mysql_get_data.sh innodb_row_lock_waits</span><br></pre></td></tr></table></figure></p>
<h3 id="5、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数："><a href="#5、修改-usr-local-zabbix-etc-zabbix-agentd-conf配置文件-添加该行参数：" class="headerlink" title="5、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数："></a>5、修改/usr/local/zabbix/etc/zabbix_agentd.conf配置文件,添加该行参数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include=/usr/local/zabbix/etc/zabbix_agentd.conf.d/</span><br></pre></td></tr></table></figure>
<p>添加完成之后，需要重启zabbix_agent客户端</p>
<h3 id="6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载"><a href="#6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载" class="headerlink" title="6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击下载"></a>6、通过zabbix-web控制台，自定义一个模板，新建监控项、触发器、图形等内容，下面链接是我创建的比较简单的mysql模板，上传到百度云，仅供参考，点击<a href="https://pan.baidu.com/s/1UiMl8fPY57RKDauV8uvVBg" target="_blank" rel="noopener">下载</a></h3><h3 id="7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件-usr-local-zabbix-script-mysql-get-data-sh："><a href="#7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件-usr-local-zabbix-script-mysql-get-data-sh：" class="headerlink" title="7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件/usr/local/zabbix/script/mysql_get_data.sh："></a>7、上面模式中tps和qps的算法是按照自数据库启动获取的参数值与uptime相除获取的每秒内执行数，下面计算另一个取值方法：取单位时间内前后值得差值，得到的差值除以时间间隔，获取单位时间内的qps和tps值，修改配置文件/usr/local/zabbix/script/mysql_get_data.sh：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">qps)</span><br><span class="line">   #uptime=`cat /tmp/mysql_status_monitor.log | awk &apos;/Uptime/ &#123;print $2&#125;&apos; |head -1`</span><br><span class="line">   #questions=`cat /tmp/mysql_status_monitor.log | awk &apos;/Questions/ &#123;print $2&#125;&apos;`</span><br><span class="line">   #echo $(printf &quot;%.2f&quot; `echo &quot;scale=2;$&#123;questions&#125;/$&#123;uptime&#125;&quot;|bc`)</span><br><span class="line">   cat /tmp/mysql_status_monitor.log | awk &apos;/Questions/ &#123;print $2&#125;&apos;</span><br><span class="line">   ;;</span><br><span class="line">tps)</span><br><span class="line">   #uptime=`cat /tmp/mysql_status_monitor.log | awk &apos;/Uptime/ &#123;print $2&#125;&apos; |head -1`</span><br><span class="line">   com_commit=`cat /tmp/mysql_status_monitor.log | awk &apos;/Com_commit/ &#123;print $2&#125;&apos;`</span><br><span class="line">   com_rollback=`cat /tmp/mysql_status_monitor.log | awk &apos;/Com_rollback/ &#123;print $2&#125;&apos;|head -1`</span><br><span class="line">   com_sum=$(($&#123;com_commit&#125;+$&#123;com_rollback&#125;))</span><br><span class="line">   echo $&#123;com_sum&#125;</span><br><span class="line">   #echo $(printf &quot;%.2f&quot; `echo &quot;scale=2;$&#123;com_sum&#125;/$&#123;uptime&#125;&quot;|bc`)</span><br><span class="line">   ;;</span><br></pre></td></tr></table></figure>
<p>修改zabbix模板监控项，将tps、qps的监控项下添加如下图所示进程：<br><img src="https://i.imgur.com/zKYZfAT.png" alt=""><br>亦可点击此处<a href="https://pan.baidu.com/s/1kVtTuqjmMbxD_eEn8vJdEw" target="_blank" rel="noopener">下载</a>，获取该模板，并导入zabbix。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a><a href="/tags/zabbix/">zabbix</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/14/zabbix监控mysql/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/14/去掉查询结果中带的mysql [Warning] Using a password on the command line interface can be insecure/"><span>[Mysql] 去掉查询结果中带的mysql: [Warning] Using a password on the command line interface can be insecure</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/14/去掉查询结果中带的mysql [Warning] Using a password on the command line interface can be insecure/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-14T08:40:24.000Z">
          2018-08-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码-输出结果如下："><a href="#1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码-输出结果如下：" class="headerlink" title="1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码,输出结果如下："></a>1、一般情况为了方便，在使用mysql命令查询的时候会在-p后面直接加上密码,输出结果如下：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678 -BNe "<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> performance_schema.replication_group_members <span class="keyword">where</span> MEMBER_STATE=<span class="string">'ONLINE'</span><span class="string">"</span></span><br></pre></td></tr></table></figure>
<p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">3</span><br></pre></td></tr></table></figure></p>
<h2 id="2、为了消除结果中的-Warning-信息，只显示查询结果，可使用环境变量存储密码的方法："><a href="#2、为了消除结果中的-Warning-信息，只显示查询结果，可使用环境变量存储密码的方法：" class="headerlink" title="2、为了消除结果中的[Warning]信息，只显示查询结果，可使用环境变量存储密码的方法："></a>2、为了消除结果中的[Warning]信息，只显示查询结果，可使用环境变量存储密码的方法：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export MYSQL_PWD=12345678;mysql -u root -BNe "<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> performance_schema.replication_group_members <span class="keyword">where</span> MEMBER_STATE=<span class="string">'ONLINE'</span><span class="string">"</span></span><br></pre></td></tr></table></figure>
<p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/14/去掉查询结果中带的mysql [Warning] Using a password on the command line interface can be insecure/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/14/mysql-innodb buffer pool size调整/"><span>[Mysql] mysql-innodb buffer pool size调整</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/14/mysql-innodb buffer pool size调整/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-14T05:03:24.000Z">
          2018-08-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、查看当前数据库innodb-buffer-pool参数"><a href="#1、查看当前数据库innodb-buffer-pool参数" class="headerlink" title="1、查看当前数据库innodb_buffer_pool参数"></a>1、查看当前数据库innodb_buffer_pool参数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_buffer_pool_size'</span>;</span><br></pre></td></tr></table></figure>
<p>##2、查看page_size大小<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_page_size'</span>;</span><br></pre></td></tr></table></figure></p>
<p>官方文档参数详解<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_page_size</span></span><br><span class="line"><span class="string">InnoDB</span> <span class="string">page</span> <span class="string">size</span> <span class="string">(default</span> <span class="number">16</span><span class="string">KB).</span> <span class="string">Many</span> <span class="string">values</span> <span class="string">are</span> <span class="string">counted</span> <span class="string">in</span> <span class="string">pages;</span> <span class="string">the</span> <span class="string">page</span> <span class="string">size</span> <span class="string">enables</span> <span class="string">them</span> <span class="string">to</span> <span class="string">be</span></span><br><span class="line"><span class="string">easily</span> <span class="string">converted</span> <span class="string">to</span> <span class="string">bytes</span></span><br></pre></td></tr></table></figure></p>
<h2 id="3、查看当前内存innodb页的总数量和包含数据的页的数量"><a href="#3、查看当前内存innodb页的总数量和包含数据的页的数量" class="headerlink" title="3、查看当前内存innodb页的总数量和包含数据的页的数量"></a>3、查看当前内存innodb页的总数量和包含数据的页的数量</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_data'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_total'</span>;</span><br></pre></td></tr></table></figure>
<p>官方文档参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_buffer_pool_pages_data</span></span><br><span class="line"><span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pages</span> <span class="string">in</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool</span> <span class="string">containing</span> <span class="string">data.</span> <span class="string">The</span> <span class="string">number</span> <span class="string">includes</span> <span class="string">both</span> <span class="string">dirty</span> <span class="string">and</span></span><br><span class="line"><span class="string">clean</span> <span class="string">pages.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Innodb_buffer_pool_pages_total</span></span><br><span class="line"><span class="string">The</span> <span class="string">total</span> <span class="string">size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool,</span> <span class="string">in</span> <span class="string">pages.</span></span><br></pre></td></tr></table></figure></p>
<h2 id="4、调优参考计算方法："><a href="#4、调优参考计算方法：" class="headerlink" title="4、调优参考计算方法："></a>4、调优参考计算方法：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val = Innodb_buffer_pool_pages_data / Innodb_buffer_pool_pages_total * 100%</span><br><span class="line">val &gt; 95% 则考虑增大 innodb_buffer_pool_size， 建议使用物理内存的75%</span><br><span class="line">val &lt; 95% 则考虑减小 innodb_buffer_pool_size， 建议设置为：Innodb_buffer_pool_pages_data * Innodb_page_size * 1.05 / (1024*1024*1024)</span><br></pre></td></tr></table></figure>
<h2 id="5、设置innodb-buffer-pool-siz大小"><a href="#5、设置innodb-buffer-pool-siz大小" class="headerlink" title="5、设置innodb_buffer_pool_siz大小"></a>5、设置innodb_buffer_pool_siz大小</h2><p>设置命令：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> innodb_buffer_pool_size = <span class="number">17179869184</span>;</span><br></pre></td></tr></table></figure></p>
<p>缓冲池字节大小，单位kb，如果不设置，默认为128M<br>5.7版本以后可以动态修改参数，但是也要修改配置文件参数，防止重启之后，参数又变成配置文件内的参数,5.7以下的版本为静态参数，需要修改配置文件，并重新启动mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/my.cnf</span><br><span class="line">---------</span><br><span class="line">innodb_buffer_pool_size = 17179869184  #设置16G</span><br><span class="line">---------</span><br></pre></td></tr></table></figure></p>
<h2 id="6、配置参数也可使用M、G等参数，内容如下："><a href="#6、配置参数也可使用M、G等参数，内容如下：" class="headerlink" title="6、配置参数也可使用M、G等参数，内容如下："></a>6、配置参数也可使用M、G等参数，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf：</span><br><span class="line">-------------------</span><br><span class="line">innodb_buffer_pool_size = 16G  #设置16G</span><br><span class="line">innodb_buffer_pool_size = 500M  #设置500M</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/14/mysql-innodb buffer pool size调整/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/12/mongodb4.0定时备份并邮件告知备份情况/"><span>[Mongodb] mongodb4.0定时备份并邮件告知备份情况</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/12/mongodb4.0定时备份并邮件告知备份情况/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-12T07:05:24.000Z">
          2018-08-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、mongodb全量备份脚本，内容如下："><a href="#1、mongodb全量备份脚本，内容如下：" class="headerlink" title="1、mongodb全量备份脚本，内容如下："></a>1、mongodb全量备份脚本，内容如下：</h2><p>cat /data/soft/mongodb_backup.sh<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#认证用户名</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#认证用户对应密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#备份的服务器地址</span></span><br><span class="line"><span class="string">servername=testrepl/127.0.0.1:30000</span></span><br><span class="line"><span class="comment">#备份的数据库实例名称</span></span><br><span class="line"><span class="string">instancename=test</span></span><br><span class="line"><span class="comment">#认证数据库实例名称</span></span><br><span class="line"><span class="string">authdbname=admin</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line"><span class="string">stamp=`date</span> <span class="string">+"%Y-%m-%d"`</span></span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line"><span class="string">programname=bulingbuling</span></span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line"><span class="string">backuppath=/data/backup</span></span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line"><span class="string">backname=$&#123;backuppath&#125;/$&#123;instancename&#125;</span></span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line"><span class="string">oldstamp=`date</span> <span class="string">+"%Y-%m-%d"</span> <span class="bullet">-d</span> <span class="string">"-5 day"</span><span class="string">`</span></span><br><span class="line"><span class="string">oldbackname=$&#123;backname&#125;-$&#123;oldstamp&#125;.dump</span></span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line"><span class="string">backuplogname=/tmp/mongodb_bakcup_$&#123;stamp&#125;.log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line"><span class="string">localname=`hostname`</span></span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line"><span class="string">localip=`ip</span> <span class="string">a</span> <span class="string">|grep</span> <span class="string">global|</span> <span class="string">head</span> <span class="bullet">-1</span><span class="string">| awk '&#123;print $2&#125;'|awk -F'/' '&#123;print $1&#125;'`</span></span><br><span class="line"><span class="string">#localip='65.52.165.104'</span></span><br><span class="line"><span class="string">#目标邮箱</span></span><br><span class="line"><span class="string">dest_mail='test@qq.com'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="string">if [ -e $&#123;backuplogname&#125; ];then</span></span><br><span class="line"><span class="string">   sudo rm -rf $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">   :</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="string">send_fail_mail()&#123;</span></span><br><span class="line"><span class="string">	echo "$&#123;programname&#125;备份失败,登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看报错！！！" |mail -s $&#123;programname&#125;数据库备份情况 $&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="string">send_success_mail()&#123;</span></span><br><span class="line"><span class="string">	echo "$&#123;programname&#125;备份成功,可登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看备份信息。" |mail -s $&#123;programname&#125;数据库备份情况 $&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建备份时间函数</span></span><br><span class="line"><span class="string">date_func()&#123;</span></span><br><span class="line"><span class="string">   dateresult=$(($&#123;afterstamp&#125;-$&#123;beforstamp&#125;))</span></span><br><span class="line"><span class="string">   hour=$(($&#123;dateresult&#125;/3600))</span></span><br><span class="line"><span class="string">   min=$((($&#123;dateresult&#125;-$&#123;hour&#125;*3600)/60))</span></span><br><span class="line"><span class="string">   sec=$(($&#123;dateresult&#125;-$&#123;hour&#125;*3600-$&#123;min&#125;*60))</span></span><br><span class="line"><span class="string">   echo "6、本次备份运行时间为:"$&#123;hour&#125;时$&#123;min&#125;分$&#123;sec&#125;秒 &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="string">del_old_bakdata()&#123;</span></span><br><span class="line"><span class="string">   if [ -e $&#123;oldbackname&#125; ];then</span></span><br><span class="line"><span class="string">   	 sudo echo "7、五天前的备份数据$&#123;oldbackname&#125;存在，进行删除"  &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   	 rm -rf $&#123;oldbackname&#125;</span></span><br><span class="line"><span class="string">   	 if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">   	 	sudo echo "7.1、备份数据删除成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   	 else</span></span><br><span class="line"><span class="string">   	 	sudo echo "7.1、备份数据删除失败，注意查看失败原因" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   	 fi</span></span><br><span class="line"><span class="string">   else</span></span><br><span class="line"><span class="string">     sudo echo "7、五天前的备份数据$&#123;oldbackname&#125;不存在，不需要再删除。" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">   fi </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#因为mongodbdump只能指定路径，不能自定义备份文件名称，因此需要对备份完成的目录重命名</span></span><br><span class="line"><span class="string">rename_backname_func()&#123;</span></span><br><span class="line"><span class="string">	if [ -e $&#123;backname&#125;-$&#123;stamp&#125; ];then</span></span><br><span class="line"><span class="string">	  mv $&#123;backname&#125;-$&#123;stamp&#125; $&#123;backname&#125;-$&#123;stamp&#125;-old</span></span><br><span class="line"><span class="string">	  mv $&#123;backname&#125; $&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line"><span class="string">	  if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">	    echo "5、备份目录重命名成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	  else</span></span><br><span class="line"><span class="string">	    echo "5、备份目录重命名失败,查看命名失败原因！" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	  fi</span></span><br><span class="line"><span class="string">	else</span></span><br><span class="line"><span class="string">	  mv $&#123;backname&#125; $&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line"><span class="string">	  if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">	    echo "5、备份目录重命名成功" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	  else</span></span><br><span class="line"><span class="string">	    echo "5、备份目录重命名失败,查看命名失败原因！" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	  fi</span></span><br><span class="line"><span class="string">	fi</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="string">if [ -d $&#123;backuppath&#125; ];then</span></span><br><span class="line"><span class="string">	sudo echo "1、备份目录存在,可执行备份操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">	sudo echo "1、备份目录不存在,手动创建" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	sudo mkdir -p $&#123;backuppath&#125;</span></span><br><span class="line"><span class="string">	if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">	   sudo echo "1.1、备份目录创建成功，可进行下面操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	else</span></span><br><span class="line"><span class="string">	   sudo echo "1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">	   exit</span></span><br><span class="line"><span class="string">	fi</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="string">if [ -d $&#123;backname&#125; ];then</span></span><br><span class="line"><span class="string">	sudo echo "2、指定的备份实例目录$&#123;backname&#125;已存在，对其进行重命名" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    mv $&#123;backname&#125; $&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump</span></span><br><span class="line"><span class="string">    if [ $? == 0 ];then</span></span><br><span class="line"><span class="string">    	sudo echo "2.1、文件已重新命名为$&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump,可继续备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">    	sudo echo "2.1、文件重命名失败，退出备份操作" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    	exit</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">	sudo echo "2、指定的备份文件不存在，开始进行备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#备份之前时间戳</span></span><br><span class="line"><span class="string">beforstamp=`date +%s`</span></span><br><span class="line"><span class="string">#开始全量备份数据库</span></span><br><span class="line"><span class="string">sudo echo "3、开始全量备份数据库" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongodump -h $&#123;servername&#125; -u $&#123;authuser&#125; -p $&#123;authpass&#125; -d $&#123;instancename&#125; -o $&#123;backuppath&#125; --authenticationDatabase $&#123;authdbname&#125;</span></span><br><span class="line"><span class="string">backupresult=$?</span></span><br><span class="line"><span class="string">afterstamp=`date +%s`</span></span><br><span class="line"><span class="string">if [ $&#123;backupresult&#125; == 0 ];then</span></span><br><span class="line"><span class="string">    	sudo echo "4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份成功,文件名称为$&#123;backname&#125;，重命名备份文件" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    	rename_backname_func</span></span><br><span class="line"><span class="string">    	date_func</span></span><br><span class="line"><span class="string">        del_old_bakdata</span></span><br><span class="line"><span class="string">        send_success_mail</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">    	sudo echo "4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份失败,注意查看备份失败原因并重新备份" &gt;&gt; $&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">    	send_fail_mail</span></span><br><span class="line"><span class="string">    	exit</span></span><br><span class="line"><span class="string">fi</span></span><br></pre></td></tr></table></figure></p>
<p>使用该脚本需要修改自己数据库对应的用户名authuser,密码authpass,邮箱dest_mail,项目名称programname,服务器名称servername,数据库实例名称instancename,mongodb数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改</p>
<h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure></p>
<p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure></p>
<p>参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">from:</span><span class="string">指定发送邮件的发件人</span></span><br><span class="line"><span class="attr">smtp:</span><span class="string">指定smtp服务器信息</span></span><br><span class="line"><span class="attr">smtp-auth-user:</span><span class="string">允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure></p>
<p>2.3、发送测试邮件：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="bullet">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure></p>
<p>title:指定发送文件的标题，可自行定义</p>
<h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure>
<h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/12/mongodb4.0定时备份并邮件告知备份情况/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/12/mongdob4.0 备份与恢复/"><span>[Mongodb] mongodb4.0备份与恢复</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/12/mongdob4.0 备份与恢复/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-12T04:06:00.000Z">
          2018-08-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、mongodb备份命令"><a href="#1、mongodb备份命令" class="headerlink" title="1、mongodb备份命令"></a>1、mongodb备份命令</h2><p>1.1、备份之前查看备份实例的相关数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.auth(&apos;admin1&apos;,&apos;admin123&apos;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use test;</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure></p>
<p>1.2、对于replica set集群模式命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongodump -h <span class="string">"testrepl/127.0.0.1:30000"</span> -u admin1 -p admin123 -d <span class="built_in">test</span> -o /data/backup/ --authenticationDatabase admin</span><br></pre></td></tr></table></figure></p>
<p>结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-12</span><span class="attr">T03:40:01.489+0000</span>    <span class="string">writing</span> <span class="string">test.test_collection</span> <span class="string">to</span> </span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-12</span><span class="attr">T03:40:03.823+0000</span>    <span class="string">done</span> <span class="string">dumping</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br></pre></td></tr></table></figure></p>
<p>会在指定的备份目录下，生成备份实例名对应的文件夹，文件夹下有以下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_collection.bson  test_collection.metadata.json</span><br></pre></td></tr></table></figure></p>
<p>命令参数详解：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-h:</span><span class="string">指定当前备份主机ip</span></span><br><span class="line"><span class="attr">--port:</span><span class="string">指定当前mongodb的启动端口</span></span><br><span class="line"><span class="attr">-u:</span><span class="string">指定验证的用户名</span></span><br><span class="line"><span class="attr">-d:</span><span class="string">需要备份的数据库实例</span></span><br><span class="line"><span class="attr">-p:</span><span class="string">指定用户名对应的密码</span></span><br><span class="line"><span class="attr">-o:</span><span class="string">指定备份的路径</span></span><br><span class="line"><span class="attr">--authenticationDatabase:</span><span class="string">认证数据库</span></span><br></pre></td></tr></table></figure></p>
<p>备份过程没有加上指定认证数据库“–authenticationDatabase admin”,会报一下错误<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Failed:</span> <span class="string">error</span> <span class="string">connecting</span> <span class="string">to</span> <span class="string">db</span> <span class="attr">server:</span> <span class="string">server</span> <span class="string">returned</span> <span class="string">error</span> <span class="string">on</span> <span class="string">SASL</span> <span class="string">authentication</span> <span class="attr">step:</span> <span class="string">Authentication</span> <span class="string">failed.</span></span><br></pre></td></tr></table></figure></p>
<p>1.3、对于单节点备份命令如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/data/mongodb/bin/mongodump</span> <span class="bullet">-h</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="bullet">--port</span> <span class="number">30000</span> <span class="bullet">-u</span> <span class="string">admin1</span> <span class="bullet">-p</span> <span class="string">admin123</span> <span class="bullet">-d</span> <span class="string">test</span> <span class="bullet">-o</span> <span class="string">/data/backup</span> <span class="bullet">--authenticationDatabase</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure></p>
<h2 id="2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-："><a href="#2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-：" class="headerlink" title="2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)："></a>2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongorestore -h 10.0.7.36 --port 30000  -u admin1 -p admin123 -d <span class="built_in">test</span>  /data/backup/<span class="built_in">test</span> --authenticationDatabase admin</span><br></pre></td></tr></table></figure>
<p>恢复输出结果如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.860+0000</span>    <span class="string">the</span> <span class="bullet">--db</span> <span class="string">and</span> <span class="bullet">--collection</span> <span class="string">args</span> <span class="string">should</span> <span class="string">only</span> <span class="string">be</span> <span class="string">used</span> <span class="string">when</span> <span class="string">restoring</span> <span class="string">from</span> <span class="string">a</span> <span class="string">BSON</span> <span class="string">file.</span> <span class="string">Other</span> <span class="string">uses</span> <span class="string">are</span> <span class="string">deprecated</span> <span class="string">and</span> <span class="string">will</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">in</span> <span class="string">the</span> <span class="string">future;</span> <span class="string">use</span> <span class="bullet">--nsInclude</span> <span class="string">instead</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.860+0000</span>    <span class="string">building</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">collections</span> <span class="string">to</span> <span class="string">restore</span> <span class="string">from</span> <span class="string">/data/backup/test</span> <span class="string">dir</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.885+0000</span>    <span class="string">reading</span> <span class="string">metadata</span> <span class="string">for</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.metadata.json</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:48.972+0000</span>    <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.bson</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:51.781+0000</span>    <span class="string">[###########.............]</span>  <span class="string">test.test_collection</span>  <span class="number">28.4</span><span class="string">MB/57.1MB</span>  <span class="string">(49.8%)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:54.490+0000</span>    <span class="string">[########################]</span>  <span class="string">test.test_collection</span>  <span class="number">57.1</span><span class="string">MB/57.1MB</span>  <span class="string">(100.0%)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:54.490+0000</span>    <span class="string">restoring</span> <span class="string">indexes</span> <span class="string">for</span> <span class="string">collection</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">metadata</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:57.737+0000</span>    <span class="string">finished</span> <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br><span class="line"><span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-11</span><span class="attr">T14:19:57.737+0000</span>    <span class="string">done</span></span><br></pre></td></tr></table></figure></p>
<p>控制台登录，查看数据是否一致：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise &gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise &gt; db.auth(&apos;admin1&apos;,&apos;admin123&apos;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise &gt; show dbs;</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">test    0.031GB</span><br><span class="line">MongoDB Enterprise &gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise &gt; show tables;</span><br><span class="line">test_collection</span><br><span class="line">MongoDB Enterprise &gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure></p>
<p>恢复完成</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/12/mongdob4.0 备份与恢复/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/11/使用innodb trx和innodb lock信息表查看锁事物/"><span>[Mysql] 使用innodb trx和innodb lock信息表查看锁事物</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/11/使用innodb trx和innodb lock信息表查看锁事物/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-11T09:10:24.000Z">
          2018-08-11
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、插入表测试数据"><a href="#1、插入表测试数据" class="headerlink" title="1、插入表测试数据"></a>1、插入表测试数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> aaa;</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br></pre></td></tr></table></figure>
<h2 id="2、创建三个会话，造成锁事物"><a href="#2、创建三个会话，造成锁事物" class="headerlink" title="2、创建三个会话，造成锁事物"></a>2、创建三个会话，造成锁事物</h2><p>sessin 1:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">60</span>);</span><br></pre></td></tr></table></figure></p>
<p>session 2:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></p>
<p>sesion 3:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："><a href="#3、使用以下查询来查看正在等待的事务以及阻止它们的事务：" class="headerlink" title="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："></a>3、使用以下查询来查看正在等待的事务以及阻止它们的事务：</h2><p>session 4<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  r.trx_id waiting_trx_id,</span><br><span class="line">  r.trx_mysql_thread_id waiting_thread,</span><br><span class="line">  r.trx_query waiting_query,</span><br><span class="line">  b.trx_id blocking_trx_id,</span><br><span class="line">  b.trx_mysql_thread_id blocking_thread,</span><br><span class="line">  b.trx_query blocking_query</span><br><span class="line"><span class="keyword">FROM</span>       information_schema.innodb_lock_waits w</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx b</span><br><span class="line">  <span class="keyword">ON</span> b.trx_id = w.blocking_trx_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx r</span><br><span class="line">  <span class="keyword">ON</span> r.trx_id = w.requesting_trx_id;</span><br><span class="line">查询结果如下：</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| waiting_trx_id | waiting_thread | waiting_query                        | blocking_trx_id | blocking_thread | blocking_query                  |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| 2488           |             58 | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2487</span>            |              <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">| <span class="number">2488</span>           |             <span class="number">58</span> | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">| <span class="number">2487</span>           |             <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>      | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br></pre></td></tr></table></figure></p>
<p>上述sql语句可能太繁琐，也可使用下面语句查询<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  waiting_trx_id,</span><br><span class="line">  waiting_pid,</span><br><span class="line">  waiting_query,</span><br><span class="line">  blocking_trx_id,</span><br><span class="line">  blocking_pid,</span><br><span class="line">  blocking_query</span><br><span class="line"><span class="keyword">FROM</span> sys.innodb_lock_waits;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物"><a href="#4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物" class="headerlink" title="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物"></a>4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br><span class="line">| 57 | root        | localhost | aaaa | Sleep   |    566 |                                                        | NULL                  |</span><br></pre></td></tr></table></figure>
<p>查询出process_id为57</p>
<h2 id="5、通过processlist-id查询出thread-id"><a href="#5、通过processlist-id查询出thread-id" class="headerlink" title="5、通过processlist_id查询出thread_id"></a>5、通过processlist_id查询出thread_id</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID <span class="keyword">FROM</span> performance_schema.threads <span class="keyword">WHERE</span> PROCESSLIST_ID = <span class="number">57</span>;</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| THREAD_ID |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">|        79 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></table></figure>
<h2 id="6、根据thread-id查询出来造成锁事物的sql语句"><a href="#6、根据thread-id查询出来造成锁事物的sql语句" class="headerlink" title="6、根据thread_id查询出来造成锁事物的sql语句"></a>6、根据thread_id查询出来造成锁事物的sql语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_current </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">THREAD_ID: <span class="number">79</span></span><br><span class="line"> SQL_TEXT: <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。"><a href="#7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。" class="headerlink" title="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。"></a>7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_history </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> EVENT_ID;</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">| THREAD_ID | SQL_TEXT                        |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">|        79 | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/11/使用innodb trx和innodb lock信息表查看锁事物/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/11/mysql- Lock wait timeout exceeded; try restarting transaction/"><span>[Mysql] ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/11/mysql- Lock wait timeout exceeded; try restarting transaction/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-11T02:03:24.000Z">
          2018-08-11
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、对一个表进行ddl操作"><a href="#1、对一个表进行ddl操作" class="headerlink" title="1、对一个表进行ddl操作"></a>1、对一个表进行ddl操作</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql&gt;ALTER</span> <span class="string">TABLE</span> <span class="string">deposit_coin_order_user</span> <span class="string">add</span> <span class="string">`txid`</span>  <span class="string">varchar(128)</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">COLLATE</span> <span class="string">utf8mb4_general_ci</span> <span class="string">NOT</span> <span class="literal">NULL</span> <span class="string">COMMENT</span> <span class="string">'区块链id'</span> <span class="string">;</span></span><br><span class="line"><span class="string">提示报错：</span></span><br><span class="line"><span class="string">ERROR</span> <span class="number">1205</span> <span class="string">(HY000):</span> <span class="string">Lock</span> <span class="string">wait</span> <span class="string">timeout</span> <span class="string">exceeded;</span> <span class="string">try</span> <span class="string">restarting</span> <span class="string">transaction</span></span><br></pre></td></tr></table></figure>
<p>查看该表数据只有39行数据：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">select</span> <span class="string">count(*)</span> <span class="string">from</span> <span class="string">deposit_coin_order_user;</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">| count(*) |</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|       39 |</span></span><br><span class="line"><span class="string">+----------+</span></span><br></pre></td></tr></table></figure></p>
<h2 id="2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’"><a href="#2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’" class="headerlink" title="2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’"></a>2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">SELECT</span> <span class="string">*</span> <span class="string">FROM</span> <span class="string">information_schema.INNODB_TRX\G</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line"><span class="attr">                    trx_id:</span> <span class="number">421462261342800</span></span><br><span class="line"><span class="attr">                 trx_state:</span> <span class="string">RUNNING</span></span><br><span class="line"><span class="attr">               trx_started:</span> <span class="number">2018</span><span class="bullet">-08</span><span class="bullet">-10</span> <span class="number">08</span><span class="string">:24:58</span></span><br><span class="line"><span class="attr">     trx_requested_lock_id:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">          trx_wait_started:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">                trx_weight:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">       trx_mysql_thread_id:</span> <span class="number">12989053</span></span><br><span class="line"><span class="attr">                 trx_query:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">       trx_operation_state:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">         trx_tables_in_use:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">         trx_tables_locked:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          trx_lock_structs:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">     trx_lock_memory_bytes:</span> <span class="number">1136</span></span><br><span class="line"><span class="attr">           trx_rows_locked:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">         trx_rows_modified:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">   trx_concurrency_tickets:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">       trx_isolation_level:</span> <span class="string">REPEATABLE</span> <span class="string">READ</span></span><br><span class="line"><span class="attr">         trx_unique_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    trx_foreign_key_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">trx_last_foreign_key_error:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr"> trx_adaptive_hash_latched:</span> <span class="number">0</span></span><br><span class="line"><span class="attr"> trx_adaptive_hash_timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          trx_is_read_only:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">trx_autocommit_non_locking:</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure>
<p>使用show full processlist查看是否有‘trx_mysql_thread_id’对应的进程，如果有就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。没有的话看看有没有正在执行的很慢SQL记录线程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show full processlist;</span><br><span class="line">| 12989053 | cwreadonly                        | 10.1.10.9:51650  | exchange_market | Sleep            |   1189 |                                                               | NULL</span><br></pre></td></tr></table></figure></p>
<h2 id="3、发现有id为12989053的sql，需要手动kill掉"><a href="#3、发现有id为12989053的sql，需要手动kill掉" class="headerlink" title="3、发现有id为12989053的sql，需要手动kill掉"></a>3、发现有id为12989053的sql，需要手动kill掉</h2><p>mysql &gt; KILL 12989053;</p>
<h2 id="4、再次执行ddl语句，正常执行"><a href="#4、再次执行ddl语句，正常执行" class="headerlink" title="4、再次执行ddl语句，正常执行"></a>4、再次执行ddl语句，正常执行</h2><p>ALTER TABLE deposit_coin_order_user add <code>txid</code>  varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT ‘区块链id’ ;</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/11/mysql- Lock wait timeout exceeded; try restarting transaction/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/7/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/9/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2019 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>