<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 2 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/17/mysql--The table is probably corrupted/"><span>[Mysql] ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/17/mysql--The table is probably corrupted/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-17T09:51:00.000Z">
          2018-10-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、从mysql5-6-msyqldump全备出来数据，导入到mysql5-7的库，导入导出均正常，在5-7的库新增用户时，提示以下错误："><a href="#1、从mysql5-6-msyqldump全备出来数据，导入到mysql5-7的库，导入导出均正常，在5-7的库新增用户时，提示以下错误：" class="headerlink" title="1、从mysql5.6 msyqldump全备出来数据，导入到mysql5.7的库，导入导出均正常，在5.7的库新增用户时，提示以下错误："></a>1、从mysql5.6 msyqldump全备出来数据，导入到mysql5.7的库，导入导出均正常，在5.7的库新增用户时，提示以下错误：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:21:  [(none)]&gt; grant select,update,delete,insert on *.* to &apos;clevergo&apos;@&apos;%&apos; identified by &apos;123123&apos;;</span><br><span class="line">ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span><br></pre></td></tr></table></figure>
<h3 id="2、造成该问题是因为把5-6的库数据，全部导入5-7造成的，因此需要使用mysql-upgrade将库升级到最新版本："><a href="#2、造成该问题是因为把5-6的库数据，全部导入5-7造成的，因此需要使用mysql-upgrade将库升级到最新版本：" class="headerlink" title="2、造成该问题是因为把5.6的库数据，全部导入5.7造成的，因此需要使用mysql_upgrade将库升级到最新版本："></a>2、造成该问题是因为把5.6的库数据，全部导入5.7造成的，因此需要使用mysql_upgrade将库升级到最新版本：</h3><p>/data/mysql/bin/mysql_upgrade -uroot -p123456<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysql_upgrade: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Checking if update is needed.</span><br><span class="line">Checking server version.</span><br><span class="line">Running queries to upgrade MySQL server.</span><br><span class="line">Checking system database.</span><br><span class="line">mysql.columns_priv                                 OK</span><br><span class="line">mysql.db                                           OK</span><br><span class="line">mysql.engine_cost                                  OK</span><br><span class="line">mysql.event                                        OK</span><br><span class="line">mysql.func                                         OK</span><br><span class="line">mysql.general_log                                  OK</span><br><span class="line">mysql.gtid_executed                                OK</span><br><span class="line">mysql.help_category                                OK</span><br><span class="line">mysql.help_keyword                                 OK</span><br><span class="line">mysql.help_relation                                OK</span><br><span class="line">mysql.help_topic                                   OK</span><br><span class="line">mysql.innodb_index_stats                           OK</span><br><span class="line">mysql.innodb_table_stats                           OK</span><br><span class="line">mysql.ndb_binlog_index                             OK</span><br><span class="line">mysql.plugin                                       OK</span><br><span class="line">mysql.proc                                         OK</span><br><span class="line">mysql.procs_priv                                   OK</span><br><span class="line">mysql.proxies_priv                                 OK</span><br><span class="line">mysql.server_cost                                  OK</span><br><span class="line">mysql.servers                                      OK</span><br><span class="line">mysql.slave_master_info                            OK</span><br><span class="line">mysql.slave_relay_log_info                         OK</span><br><span class="line">mysql.slave_worker_info                            OK</span><br><span class="line">mysql.slow_log                                     OK</span><br><span class="line">mysql.tables_priv                                  OK</span><br><span class="line">mysql.time_zone                                    OK</span><br><span class="line">mysql.time_zone_leap_second                        OK</span><br><span class="line">mysql.time_zone_name                               OK</span><br><span class="line">mysql.time_zone_transition                         OK</span><br><span class="line">mysql.time_zone_transition_type                    OK</span><br><span class="line">mysql.user                                         OK</span><br><span class="line">The sys schema is already up to date (version 1.5.1).</span><br><span class="line">Found 0 sys functions, but expected 22. Re-installing the sys schema.</span><br><span class="line">Upgrading the sys schema.</span><br><span class="line">Checking databases.</span><br><span class="line">t.t_test                                           OK</span><br><span class="line">Upgrade process completed successfully.</span><br><span class="line">Checking if update is needed.</span><br></pre></td></tr></table></figure></p>
<h3 id="3、进入mysql，再次执行创建用户："><a href="#3、进入mysql，再次执行创建用户：" class="headerlink" title="3、进入mysql，再次执行创建用户："></a>3、进入mysql，再次执行创建用户：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:26:  [(none)]&gt; grant select,update,delete,insert on *.* to &apos;clevergo&apos;@&apos;%&apos; identified by &apos;123123&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; select host,user from mysql.user;</span><br><span class="line">+-----------+----------------+</span><br><span class="line">| host      | user           |</span><br><span class="line">+-----------+----------------+</span><br><span class="line">| %         | clevergo       |</span><br><span class="line">| localhost | mysql.session  |</span><br><span class="line">| localhost | mysql.sys      |</span><br><span class="line">| localhost | root           |</span><br><span class="line">+-----------+----------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
<p>执行成功。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/17/mysql--The table is probably corrupted/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/08/使用mysqldiff和mysqldbcompare比较数据库差异/"><span>[Mysql] 使用mysqldiff和mysqldbcompare检查数据一致性</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/08/使用mysqldiff和mysqldbcompare比较数据库差异/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-08T09:51:24.000Z">
          2018-10-08
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、官网下载mysql-utilities工具"><a href="#1、官网下载mysql-utilities工具" class="headerlink" title="1、官网下载mysql-utilities工具"></a>1、官网下载mysql-utilities工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com/archives/mysql-utilities/mysql-utilities-1.6.5.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="2、解压mysql-utilities工具："><a href="#2、解压mysql-utilities工具：" class="headerlink" title="2、解压mysql-utilities工具："></a>2、解压mysql-utilities工具：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-utilities-1.6.5.tar.gz</span><br><span class="line">cd mysql-utilities-1.6.5/</span><br><span class="line">cd scripts/</span><br><span class="line">[root@dax-mysql-slave scripts]# ls</span><br><span class="line">mysqlauditadmin.py  mysqlbinlogpurge.py   mysqldbcopy.py    mysqldiff.py       mysqlfrm.py         mysqlmetagrep.py   mysqlrpladmin.py  mysqlrplshow.py      mysqlserverinfo.py  mysqluserclone.py</span><br><span class="line">mysqlauditgrep.py   mysqlbinlogrotate.py  mysqldbexport.py  mysqldiskusage.py  mysqlgrants.py      mysqlprocgrep.py   mysqlrplcheck.py  mysqlrplsync.py      mysqlslavetrx.py</span><br><span class="line">mysqlbinlogmove.py  mysqldbcompare.py     mysqldbimport.py  mysqlfailover.py   mysqlindexcheck.py  mysqlreplicate.py  mysqlrplms.py     mysqlserverclone.py  mysqluc.py</span><br></pre></td></tr></table></figure>
<p>在scripts目录下存在mysqldiff和mysqldbcompare用于比对数据的脚本</p>
<h3 id="3、使用mysqldbcompare需要安装connector-python依赖关系："><a href="#3、使用mysqldbcompare需要安装connector-python依赖关系：" class="headerlink" title="3、使用mysqldbcompare需要安装connector-python依赖关系："></a>3、使用mysqldbcompare需要安装connector-python依赖关系：</h3><p>官网下载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://cdn.mysql.com/archives/mysql-connector-python-2.2/mysql-connector-python-2.2.3-0.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mysql-connector-python-2.2.3-0.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h3 id="4、安装完成之后测试mysqldbcompare能否正常使用："><a href="#4、安装完成之后测试mysqldbcompare能否正常使用：" class="headerlink" title="4、安装完成之后测试mysqldbcompare能否正常使用："></a>4、安装完成之后测试mysqldbcompare能否正常使用：</h3><p> ./mysqldbcompare.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;./mysqldbcompare.py&quot;, line 28, in &lt;module&gt;</span><br><span class="line">    from mysql.utilities.common.tools import check_python_version</span><br><span class="line">ImportError: No module named utilities.common.tools</span><br></pre></td></tr></table></figure></p>
<p>将python2.7下的模块，软连接到lib64目录下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/lib/python2.7/site-packages/mysql/utilities /usr/lib64/python2.7/site-packages/mysql/utilities</span><br></pre></td></tr></table></figure></p>
<p>重新测试mysqldbcompare能否正常使用：<br>./mysqldbcompare.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Usage: mysqldbcompare --server1=user:pass@host:port:socket --server2=user:pass@host:port:socket db1:db2</span><br><span class="line"></span><br><span class="line">mysqldbcompare: error: You must specify at least one database to compare or use the --all option to compare all databases.</span><br></pre></td></tr></table></figure></p>
<p>提示需要指定对表的库：<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306:/data/mysql/tmp/mysql.sock –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306:/data/mysql/tmp/mysql.sock test:test<br>或者<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test:test<br>执行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test on server1 and test on server2</span><br><span class="line">#</span><br><span class="line">ERROR: The list of objects differs among database test and test.</span><br></pre></td></tr></table></figure></p>
<h3 id="5、准备测试数据："><a href="#5、准备测试数据：" class="headerlink" title="5、准备测试数据："></a>5、准备测试数据：</h3><p>server1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:40:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">|  6 |</span><br><span class="line">+----+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:40:  [test1]&gt; show create table test;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test  | CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>server2:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:37:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line"></span><br><span class="line">root@db 06:20:  [test1]&gt; show create table test</span><br><span class="line">    -&gt; ;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test  | CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来："><a href="#6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来：" class="headerlink" title="6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来："></a>6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来：</h3><p>./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1:test1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing `test1` to `test1`                                     [PASS]</span><br><span class="line"># Comparing `test1`.`aa` to `test1`.`aa`                           [PASS]</span><br><span class="line"># Comparing `test1`.`test` to `test1`.`test`                       [PASS]</span><br><span class="line"># Success. All objects are the same.</span><br></pre></td></tr></table></figure></p>
<p>单独对比某一张表：<br>./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1.test:test1.test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing test1.test to test1.test                               [PASS]</span><br><span class="line"># Success. All objects are the same.</span><br></pre></td></tr></table></figure></p>
<h3 id="7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测："><a href="#7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测：" class="headerlink" title="7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测："></a>7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测：</h3><p>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    ERROR: Row counts are not the same among `test1`.`test` and `test1`.`test`.</span><br><span class="line">#</span><br></pre></td></tr></table></figure></p>
<p>提示test1库下面的test表数据不一致。</p>
<h3 id="8、创建测试数据，表结构不同，数据内容相同："><a href="#8、创建测试数据，表结构不同，数据内容相同：" class="headerlink" title="8、创建测试数据，表结构不同，数据内容相同："></a>8、创建测试数据，表结构不同，数据内容相同：</h3><p>server1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table test1 (id int(10) primary key);</span><br><span class="line">insert into test1 values (1),(2),(3),(4),(5);</span><br><span class="line">select * from test1;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure></p>
<p>server2:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table test1 (id bigint(20));</span><br><span class="line">insert into test1 values (1),(2),(3),(4),(5);</span><br><span class="line">root@db 06:28:  [test1]&gt; select * from test1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">|    5 |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure></p>
<h3 id="9、使用mysqldiff检测："><a href="#9、使用mysqldiff检测：" class="headerlink" title="9、使用mysqldiff检测："></a>9、使用mysqldiff检测：</h3><p> ./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1.test1:test1.test1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing test1.test1 to test1.test1                             [FAIL]</span><br><span class="line"># Object definitions differ. (--changes-for=server1)</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">--- test1.test1</span><br><span class="line">+++ test1.test1</span><br><span class="line">@@ -1,4 +1,3 @@</span><br><span class="line"> CREATE TABLE `test1` (</span><br><span class="line">-  `id` int(10) NOT NULL,</span><br><span class="line">-  PRIMARY KEY (`id`)</span><br><span class="line">+  `id` bigint(20) DEFAULT NULL</span><br><span class="line"> ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line"># Compare failed. One or more differences found.</span><br></pre></td></tr></table></figure></p>
<p>提示表结构存在差异。</p>
<h3 id="10、使用mysqldbcompare检测："><a href="#10、使用mysqldbcompare检测：" class="headerlink" title="10、使用mysqldbcompare检测："></a>10、使用mysqldbcompare检测：</h3><p>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    ERROR: Row counts are not the same among `test1`.`test` and `test1`.`test`.</span><br><span class="line">#</span><br></pre></td></tr></table></figure></p>
<p>当检测到异常之后会直接退出，不进行下面的比较，因此未检测到test1表的内容，加上-t（-t, –run-all-tests   do not abort when a diff test fails）参数，运行测试模式，遇到异常之后仍然执行下面的比较：<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql -t<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    -       </span><br><span class="line">#           - Compare table checksum                                FAIL    </span><br><span class="line">#           - Find row differences                                  FAIL    </span><br><span class="line">#</span><br><span class="line"># Row counts are not the same among `test1`.`test` and `test1`.`test`.</span><br><span class="line">#</span><br><span class="line"># Transformation for --changes-for=server1:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">DELETE FROM `test1`.`test` WHERE `ID` = &apos;6&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># TABLE     test1                                   FAIL    pass    -       </span><br><span class="line">#           - Compare table checksum                                FAIL    </span><br><span class="line">#           - Find row differences                                  SKIP    </span><br><span class="line">#</span><br><span class="line"># Transformation for --changes-for=server1:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">ALTER TABLE `test1`.`test1` </span><br><span class="line">  DROP PRIMARY KEY, </span><br><span class="line">  CHANGE COLUMN id id bigint(20) NULL;</span><br><span class="line"></span><br><span class="line"># The table test1 does not have an usable Index or primary key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Database consistency check failed.</span><br><span class="line">#</span><br><span class="line"># ...done</span><br></pre></td></tr></table></figure></p>
<h3 id="11、创建两个test库，server1比server2实例多一个gtid-test14的表："><a href="#11、创建两个test库，server1比server2实例多一个gtid-test14的表：" class="headerlink" title="11、创建两个test库，server1比server2实例多一个gtid_test14的表："></a>11、创建两个test库，server1比server2实例多一个gtid_test14的表：</h3><p>server1:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| articles       |</span><br><span class="line">| gtid_test10    |</span><br><span class="line">| gtid_test11    |</span><br><span class="line">| gtid_test12    |</span><br><span class="line">| gtid_test13    |</span><br><span class="line">| gtid_test14    |</span><br><span class="line">| gtid_test15    |</span><br><span class="line">| gtid_test2     |</span><br><span class="line">| gtid_test3     |</span><br><span class="line">| gtid_test4     |</span><br><span class="line">| gtid_test5     |</span><br><span class="line">| gtid_test6     |</span><br><span class="line">| gtid_test7     |</span><br><span class="line">| gtid_test8     |</span><br><span class="line">| gtid_test9     |</span><br><span class="line">| ratings        |</span><br><span class="line">+----------------+</span><br><span class="line">16 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>server2:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| articles       |</span><br><span class="line">| gtid_test10    |</span><br><span class="line">| gtid_test11    |</span><br><span class="line">| gtid_test12    |</span><br><span class="line">| gtid_test13    |</span><br><span class="line">| gtid_test15    |</span><br><span class="line">| gtid_test2     |</span><br><span class="line">| gtid_test3     |</span><br><span class="line">| gtid_test4     |</span><br><span class="line">| gtid_test5     |</span><br><span class="line">| gtid_test6     |</span><br><span class="line">| gtid_test7     |</span><br><span class="line">| gtid_test8     |</span><br><span class="line">| gtid_test9     |</span><br><span class="line">| ratings        |</span><br><span class="line">+----------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="12、使用mysqldiff测试："><a href="#12、使用mysqldiff测试：" class="headerlink" title="12、使用mysqldiff测试："></a>12、使用mysqldiff测试：</h3><p> ./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test:test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># WARNING: Objects in server1.test but not in server2.test:</span><br><span class="line">#        TABLE: gtid_test14</span><br><span class="line"># Compare failed. One or more differences found.</span><br></pre></td></tr></table></figure></p>
<p>提示server2.test库下不存在gtid_test14表。</p>
<h3 id="13、使用mysqldbcompare测试："><a href="#13、使用mysqldbcompare测试：" class="headerlink" title="13、使用mysqldbcompare测试："></a>13、使用mysqldbcompare测试：</h3><p> ./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50" target="_blank" rel="noopener">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51" target="_blank" rel="noopener">12345678@10.0.7.51</a>:3306 test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test on server1 and test on server2</span><br><span class="line">#</span><br><span class="line">ERROR: The list of objects differs among database test and test.</span><br></pre></td></tr></table></figure></p>
<p>只会提示两个实例的test库有差异，并没有列出详细信息。在对比数据时可先使用mysqldiff工具检测两个server端的表结构是否一致，如果没有差异，再使用mysqldbcompare工具去检测表数据是否一致。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/08/使用mysqldiff和mysqldbcompare比较数据库差异/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/28/使用certbot为域名生成免费证书(apache版)/"><span>[Linux] 使用certbot为域名生成免费证书(apache版)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/28/使用certbot为域名生成免费证书(apache版)/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-28T08:41:30.000Z">
          2018-09-28
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、下载certbot"><a href="#1、下载certbot" class="headerlink" title="1、下载certbot"></a>1、下载certbot</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft</span><br><span class="line">wget https://dl.eff.org/certbot-auto</span><br><span class="line">chmod a+x certbot-auto</span><br></pre></td></tr></table></figure>
<h4 id="2、生成证书"><a href="#2、生成证书" class="headerlink" title="2、生成证书"></a>2、生成证书</h4><p>/data/soft/certbot-auto –apache certonly<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Could not choose appropriate plugin: The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Cannot find Apache executable apachectl&apos;,)</span><br><span class="line">The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Cannot find Apache executable apachectl&apos;,)</span><br></pre></td></tr></table></figure></p>
<h4 id="3、上面报错提示找不到执行路径，需要指定apache的路径"><a href="#3、上面报错提示找不到执行路径，需要指定apache的路径" class="headerlink" title="3、上面报错提示找不到执行路径，需要指定apache的路径"></a>3、上面报错提示找不到执行路径，需要指定apache的路径</h4><p>sudo env PATH=$PATH:/usr/local/apache2/bin ./certbot-auto –apache certonly<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Could not choose appropriate plugin: The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Could not find configuration root&apos;,)</span><br><span class="line">The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&apos;Could not find configuration root&apos;,)</span><br></pre></td></tr></table></figure></p>
<h4 id="4、上面报错提示找不到配置目录，需要指定–apache-server-root"><a href="#4、上面报错提示找不到配置目录，需要指定–apache-server-root" class="headerlink" title="4、上面报错提示找不到配置目录，需要指定–apache-server-root"></a>4、上面报错提示找不到配置目录，需要指定–apache-server-root</h4><p> sudo env PATH=$PATH:/usr/local/apache2/bin ./certbot-auto –apache –apache-server-root /usr/local/apache2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Plugins selected: Authenticator apache, Installer apache</span><br><span class="line">No names were found in your configuration files. Please enter in your domain</span><br><span class="line">name(s) (comma and/or space separated)  (Enter &apos;c&apos; to cancel): www.test.com</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">http-01 challenge for www.test.com</span><br><span class="line">Cleaning up challenges</span><br><span class="line">Unable to find a virtual host listening on port 80 which is currently needed for Certbot to prove to the CA that you control your domain. Please add a virtual host for port 80.</span><br></pre></td></tr></table></figure></p>
<h4 id="5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd-conf配置文件，添加上80端口，并重启apache"><a href="#5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd-conf配置文件，添加上80端口，并重启apache" class="headerlink" title="5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd.conf配置文件，添加上80端口，并重启apache"></a>5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd.conf配置文件，添加上80端口，并重启apache</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Listen 80</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;  </span><br><span class="line">    ServerAdmin test@test.example.com</span><br><span class="line">    ServerName  www.test.com</span><br><span class="line">    ServerAlias test</span><br><span class="line">    DocumentRoot /var/www/html </span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<h4 id="6、重新生成证书，成功之后会在-etc-letsencrypt-live-ebank-cbibank-com目录下生成四个文件-pem文件和一个README文件"><a href="#6、重新生成证书，成功之后会在-etc-letsencrypt-live-ebank-cbibank-com目录下生成四个文件-pem文件和一个README文件" class="headerlink" title="6、重新生成证书，成功之后会在/etc/letsencrypt/live/ebank.cbibank.com目录下生成四个文件.pem文件和一个README文件"></a>6、重新生成证书，成功之后会在/etc/letsencrypt/live/ebank.cbibank.com目录下生成四个文件.pem文件和一个README文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</span><br></pre></td></tr></table></figure>
<h4 id="7、修改conf-httpd-conf文件"><a href="#7、修改conf-httpd-conf文件" class="headerlink" title="7、修改conf/httpd.conf文件"></a>7、修改conf/httpd.conf文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Include conf/extra/httpd-ssl.conf</span><br><span class="line">#LoadModule ssl_module modules/mod_ssl.so</span><br></pre></td></tr></table></figure>
<p>将这两行的#去掉</p>
<h4 id="8、配置conf-extra-httpd-ssl-conf文件，修改对应的域名和证书路径："><a href="#8、配置conf-extra-httpd-ssl-conf文件，修改对应的域名和证书路径：" class="headerlink" title="8、配置conf/extra/httpd-ssl.conf文件，修改对应的域名和证书路径："></a>8、配置conf/extra/httpd-ssl.conf文件，修改对应的域名和证书路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">DocumentRoot &quot;/var/www/html&quot;</span><br><span class="line">ServerName ebank.cbibank.com</span><br><span class="line">SSLEngine on</span><br><span class="line">SSLCertificateFile /etc/letsencrypt/live/ebank.cbibank.com/cert.pem</span><br><span class="line">SSLCertificateKeyFile /etc/letsencrypt/live/ebank.cbibank.com/privkey.pem</span><br><span class="line">SSLCertificateChainFile /etc/letsencrypt/live/ebank.cbibank.com/chain.pem</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<h4 id="9、修改完成后重启apache："><a href="#9、修改完成后重启apache：" class="headerlink" title="9、修改完成后重启apache："></a>9、修改完成后重启apache：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache2/bin/apachectl restart</span><br></pre></td></tr></table></figure>
<p>重启过程报错，无法关闭apache提示以下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>在/usr/lib64/下面没有httpd的模块，yum安装mod_ssl：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mod_ssl</span><br></pre></td></tr></table></figure></p>
<p>安装完成之后在/usr/lib64/httpd/modules/下面会有mod_ssl.so<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib64/httpd/modules/mod_ssl.so</span><br><span class="line">ln -s /usr/lib64/httpd/modules/mod_ssl.so /usr/local/apache2/modules/mod_ssl.so</span><br></pre></td></tr></table></figure></p>
<p>再次尝试重启apache，报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so:undefined symbol: ap_global_mutex_create</span><br></pre></td></tr></table></figure></p>
<p>google了一下，有说yum安装的mod_ssl与apache的安装版本不兼容的问题，因此尝试使用对应版本的tar包将模块文件拷过去:<br>拷贝modules目录下的ssl目录和loggers的内容到/usr/local/apache2/modules/ssl目录下、拷贝include目录下的内容到/usr/local/apache2/modules/ssl目录下，拷贝完之后，在/usr/local/apache2/modules/ssl目录下执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache2/bin/apxs -a -i -c mod_ssl.c</span><br></pre></td></tr></table></figure></p>
<p>执行完成之后再次重启apache，依旧报错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so: undefined symbol: ssl_cmd_SSLPassPhraseDialog</span><br></pre></td></tr></table></figure></p>
<p>需要指定openssl路径，执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache2/bin/apxs -a -i -c -L/usr/lib/openssl/engines/lib -c *.c -lcrypto -lssl -ldl</span><br></pre></td></tr></table></figure></p>
<p>再次重启apache<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of /usr/local/apache2/conf/httpd.conf: Cannot load /usr/local/apache2/modules/mod_ssl.so into server: /usr/local/apache2/modules/mod_ssl.so:undefined symbol: ap_global_mutex_create</span><br></pre></td></tr></table></figure></p>
<p>重启apache依旧报错undefinedsymbol:ap_global_mutex_create，没找到任何解决办法，最后只能添加-enable-ssl参数，重新编译安装apache。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/28/使用certbot为域名生成免费证书(apache版)/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/26/mysql 勿操作drop table之后，利用mysqldump备份和binlog去恢复/"><span>[Mysql] mysql勿操作drop table之后，利用mysqldump备份和binlog恢复</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/26/mysql 勿操作drop table之后，利用mysqldump备份和binlog去恢复/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-26T14:35:24.000Z">
          2018-09-26
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <p>1、查看备份表数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:30:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure></p>
<p>2、查看当前binlog位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                       |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000036 |    80147 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-195:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>3、开始备份test1数据库下的test数据表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p12345678 test1 test --master-data=2 --single-transaction &gt; /data/test.dump</span><br></pre></td></tr></table></figure></p>
<p>4、查看备份数据文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> more /data/test.dump</span><br><span class="line">-- MySQL dump 10.13  Distrib 5.7.22, for linux-glibc2.12 (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost    Database: test1</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version	5.7.22-log</span><br><span class="line"></span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!40101 SET NAMES utf8 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&apos;+00:00&apos; */;</span><br><span class="line">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&apos;NO_AUTO_VALUE_ON_ZERO&apos; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line">SET @MYSQLDUMP_TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;</span><br><span class="line">SET @@SESSION.SQL_LOG_BIN= 0;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- GTID state at the beginning of the backup </span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">SET @@GLOBAL.GTID_PURGED=&apos;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-195:1000036-1000040&apos;;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Position to start replication or point-in-time recovery from</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-binlog.000036&apos;, MASTER_LOG_POS=80147;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Table structure for table `test`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `test`;</span><br><span class="line">/*!40101 SET @saved_cs_client     = @@character_set_client */;</span><br><span class="line">/*!40101 SET character_set_client = utf8 */;</span><br><span class="line">CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Dumping data for table `test`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">LOCK TABLES `test` WRITE;</span><br><span class="line">/*!40000 ALTER TABLE `test` DISABLE KEYS */;</span><br><span class="line">INSERT INTO `test` VALUES (1),(2),(3);</span><br><span class="line">/*!40000 ALTER TABLE `test` ENABLE KEYS */;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">SET @@SESSION.SQL_LOG_BIN = @MYSQLDUMP_TEMP_LOG_BIN;</span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line"></span><br><span class="line">-- Dump completed on 2018-09-25  7:32:05</span><br></pre></td></tr></table></figure></p>
<p>5、备份完成之后插入新的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:34:  [test1]&gt; insert into test values(4);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>6、刷新binlog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; flush binary logs;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure></p>
<p>7、查看binlog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                          |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000037 |      326 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-196:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>8、在新的binlog文件里面再次插入一条数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; insert into test values(5);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>9、查看当前测试的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:45:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>10、再次刷新binlog文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:45:  [test1]&gt; flush binary logs;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@db 07:49:  [test1]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                          |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000038 |      326 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-197:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>11、删除测试表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:49:  [test1]&gt; drop table test;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure></p>
<p>12、根据备份文件获取测试表test的创建语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e&apos;/./&#123;H;$!d;&#125;&apos; -e &apos;x;/CREATE TABLE `test`/!d;q&apos; /data/test.dump</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `test`;</span><br><span class="line">/*!40101 SET @saved_cs_client     = @@character_set_client */;</span><br><span class="line">/*!40101 SET character_set_client = utf8 */;</span><br><span class="line">CREATE TABLE `test` (</span><br><span class="line">  `ID` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br></pre></td></tr></table></figure>
<p>13、获取测试表test的数据，并指定到数据文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &apos;INSERT INTO `test`&apos; /data/test.dump &gt; insert.sql</span><br></pre></td></tr></table></figure></p>
<p>cat insert.sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `test` VALUES (1),(2),(3);</span><br></pre></td></tr></table></figure></p>
<p>14、根据test.dump备份文件记录的log-file文件位置和log-pos参数，去获取未备份的关于test表的增删改数据：<br>从mysql-binlog.000036文件开始，–start-position=80147：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog  -v --base64-output=decode-rows --set-charset=UTF-8 --database=test1 --start-position=80147  mysql-binlog.000036  &gt; restore.sql</span><br></pre></td></tr></table></figure></p>
<p>15、获取test表被删除是的pos，文件为mysql-binlog.000038，位置为507：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS --set-charset=UTF-8  /data/mysql/log/mysql-binlog.000038 |grep DROP  -A15 -B15</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># at 326</span><br><span class="line">#180925  7:49:39 server id 3306101  end_log_pos 387 	GTID	last_committed=0	sequence_number=1	rbr_only=no</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:198&apos;/*!*/;</span><br><span class="line"># at 387</span><br><span class="line">#180925  7:49:39 server id 3306101  end_log_pos 507 	Query	thread_id=267	exec_time=0	error_code=0</span><br><span class="line">use `test1`/*!*/;</span><br><span class="line">SET TIMESTAMP=1537861779/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=267/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=0/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=29301/*!*/;</span><br><span class="line">/*!\C utf8 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=45/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">DROP TABLE `test` /* generated by server */</span><br><span class="line">/*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &apos;AUTOMATIC&apos; /* added by mysqlbinlog */ /*!*/;</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure>
<p>16、在备份开始binlog文件和记录drop操作的binlog文件之间还存在一个mysql-binlog.000037文件，需要将该文件内记录的信息都导出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS --set-charset=UTF-8 mysql-binlog.000037 &gt;&gt; restore.sql</span><br></pre></td></tr></table></figure></p>
<p>17：将记录drop操作的binlog文件里面drop之前的信息导出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS --set-charset=UTF-8 --stop-position=507 mysql-binlog.000038 &gt;&gt; restore.sql</span><br></pre></td></tr></table></figure></p>
<p>18:对导出的文件进行筛选，过滤出test表的相关信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">more restore.sql |grep  --ignore-case -E &apos;insert|update|delete&apos; -A3|grep &apos;`test1`.`test`&apos; -A2</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">### INSERT INTO `test1`.`test`</span><br><span class="line">### SET</span><br><span class="line">###   @1=4</span><br><span class="line">--</span><br><span class="line">### INSERT INTO `test1`.`test`</span><br><span class="line">### SET</span><br><span class="line">###   @1=5</span><br></pre></td></tr></table></figure>
<p>将过滤出来的内容进行编辑，@1为第一列的列名，建议使用sublime或者vim进行批量编辑 ：<br>cat test_insert.sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `test1`.`test` SET   id=4  ;</span><br><span class="line">INSERT INTO `test1`.`test` SET   id=5  ;</span><br></pre></td></tr></table></figure></p>
<p>19、执行create table语句，并引用insert.sql和test_insert.sql文件，至此drop掉的test表被恢复。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/26/mysql 勿操作drop table之后，利用mysqldump备份和binlog去恢复/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/14/cassandra安装部署/"><span>[Cassandra] cassandra安装部署及日常使用命令</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/14/cassandra安装部署/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-14T09:31:00.000Z">
          2018-09-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、添加yum源"><a href="#1、添加yum源" class="headerlink" title="1、添加yum源"></a>1、添加yum源</h3><p>vim /etc/yum.repos.d/cassandra.repo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[cassandra]</span><br><span class="line">name=Apache Cassandra</span><br><span class="line">baseurl=https://www.apache.org/dist/cassandra/redhat/311x/</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://www.apache.org/dist/cassandra/KEYS</span><br></pre></td></tr></table></figure></p>
<h3 id="2、安装cassandra数据库"><a href="#2、安装cassandra数据库" class="headerlink" title="2、安装cassandra数据库"></a>2、安装cassandra数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install cassandra -y</span><br></pre></td></tr></table></figure>
<h3 id="3、修改配置文件-etc-cassandra-conf-cassandra-yaml"><a href="#3、修改配置文件-etc-cassandra-conf-cassandra-yaml" class="headerlink" title="3、修改配置文件/etc/cassandra/conf/cassandra.yaml"></a>3、修改配置文件/etc/cassandra/conf/cassandra.yaml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cluster_name: &apos;My Cluster&apos;</span><br><span class="line">hints_directory: /data/cassandra/hints</span><br><span class="line">data_file_directories:     </span><br><span class="line">        - /data/cassandra/dbdata</span><br><span class="line">commitlog_directory: /data/cassandra/commitlog</span><br><span class="line">saved_caches_directory: /data/cassandra/caches</span><br><span class="line"></span><br><span class="line">         - seeds: &quot;10.10.8.3,10.10.8.4,10.10.8.5&quot;</span><br><span class="line">listen_address: dax-mysql-mha</span><br><span class="line">rpc_address: dax-mysql-mha</span><br></pre></td></tr></table></figure>
<p>每个节点需要修改的基本参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster_name:修改集群名称</span><br><span class="line">修改存放目录hint、data、log</span><br><span class="line">seeds:添加节点ip</span><br><span class="line">listen_address：修改为本地ip地址</span><br><span class="line">rpc_address：修改为本地ip地址</span><br></pre></td></tr></table></figure></p>
<p>配置文件部分参数解释：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cluster_name: &apos;Test Cluster&apos;</span><br><span class="line">storage_port: 7000</span><br><span class="line">listen_address: dax-mysql-mha</span><br><span class="line">start_native_transport: true              #开启native协议 </span><br><span class="line">native_transport_port: 9042              #客户端的交互端口 </span><br><span class="line">data_file_directories:</span><br><span class="line">    - /data/cassandra/dbdata              # 数据位置，多盘的话可以写多个目录 </span><br><span class="line">commitlog_directory:</span><br><span class="line">    - /data/cassandra/commitlog          #commitlog的路径，与data目录分开磁盘，提高性能</span><br><span class="line">saved_caches_directory:</span><br><span class="line">    - /data/cassandra/caches              #缓存数据目录 </span><br><span class="line">commitlog_sync: batch                    #批量记录commitlog，每隔一段时间将数据commitlog</span><br><span class="line">commitlog_sync_batch_window_in_ms: 2      #batch模式下，批量操作缓存的时间间隔</span><br><span class="line">#commitlog_sync: periodic                #周期记录commitlog，每一次有数据更新都commitlog</span><br><span class="line">#commitlog_sync_period_in_ms: 10000      #periodic模式，刷新commitlog的时间间隔</span><br><span class="line"> rpc_address: dax-mysql-mha</span><br></pre></td></tr></table></figure></p>
<h3 id="4、创建配置文件内指定的相关目录："><a href="#4、创建配置文件内指定的相关目录：" class="headerlink" title="4、创建配置文件内指定的相关目录："></a>4、创建配置文件内指定的相关目录：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/cassandra/hints</span><br><span class="line">mkdir -p /data/cassandra/dbdata</span><br><span class="line">mkdir -p /data/cassandra/commitlog</span><br><span class="line">mkdir -p /data/cassandra/caches</span><br><span class="line">chmod 777 -R /data/cassandra</span><br></pre></td></tr></table></figure>
<h3 id="5、启动数据库，并添加到开机启动："><a href="#5、启动数据库，并添加到开机启动：" class="headerlink" title="5、启动数据库，并添加到开机启动："></a>5、启动数据库，并添加到开机启动：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service cassandra start</span><br><span class="line">chkconfig cassandra on</span><br></pre></td></tr></table></figure>
<p>查看运行状态<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodetool status</span><br></pre></td></tr></table></figure></p>
<p>进入控制台,9042端口为默认控制台端口，可自行修改配置文件设置：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cqlsh ip 9042</span><br></pre></td></tr></table></figure></p>
<h3 id="6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改："><a href="#6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改：" class="headerlink" title="6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改："></a>6、如果没有修改cluster-name启动该数据库，之后想要修改cluster-name需要使用下面方法去修改：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">进入控制台：</span><br><span class="line">UPDATE system.local SET cluster_name = &apos;daxcluster&apos; where key=&apos;local&apos;;</span><br><span class="line">bash $ ./nodetool flush</span><br><span class="line">修改cassandra.yaml配置文件cluster配置参数</span><br><span class="line">cluster_name: &apos;daxcluster&apos;</span><br><span class="line">重启cassandra</span><br><span class="line">/etc/init.d/cassandra restart</span><br></pre></td></tr></table></figure>
<h3 id="7、给数据库设置用户名密码"><a href="#7、给数据库设置用户名密码" class="headerlink" title="7、给数据库设置用户名密码"></a>7、给数据库设置用户名密码</h3><p>1）、首先修改配置文件 cassandra.yaml<br>把默认的authenticator: AllowAllAuthenticator运行所有人登录设置为用密码登录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authenticator: PasswordAuthenticator</span><br></pre></td></tr></table></figure></p>
<p>2）、登录cassandra创建用户<br>使用默认账户登录cassandra<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cqlsh -ucassandra -pcassandra ip 9042</span><br></pre></td></tr></table></figure></p>
<p>创建用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER test WITH PASSWORD &apos;test&apos; SUPERUSER;</span><br></pre></td></tr></table></figure></p>
<p>3）、使用新用户登录<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cqlsh -utest -ptest ip 9042</span><br></pre></td></tr></table></figure></p>
<p>删除默认帐号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP USER cassandra;</span><br></pre></td></tr></table></figure></p>
<p>4）、java使用用户名密码访问cassandra<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cluster cluster = Cluster.builder()</span><br><span class="line">.addContactPoint(<span class="string">"192.168.22.161"</span>)</span><br><span class="line">.withCredentials(<span class="string">"myusername"</span>, <span class="string">"mypassword"</span>)</span><br><span class="line">.build();</span><br></pre></td></tr></table></figure></p>
<h3 id="8、账号权限分配命令"><a href="#8、账号权限分配命令" class="headerlink" title="8、账号权限分配命令"></a>8、账号权限分配命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">授权：</span><br><span class="line">GRANT permission_name PERMISSION ON resource TO user_name;</span><br><span class="line">GRANT ALL PERMISSIONS ON resource TO user_name;</span><br><span class="line">收回权限：</span><br><span class="line">REVOKE permission_name PERMISSION ON resource FROM user_name;</span><br><span class="line">REVOKE ALL PERMISSIONS ON resource FROM user_name;</span><br><span class="line">查看权限：</span><br><span class="line">LIST permission_name PERMISSION ON resource OF user_name NORECURSIVE;</span><br><span class="line">LIST ALL PERMISSIONS ON resource OF user_name NORECURSIVE;</span><br><span class="line">其中，</span><br><span class="line">permission_name为：  ALL/ALTER/AUTHORIZE/CREATE/DROP/MODIFY/SELECT</span><br><span class="line">resource为：ALL KEYSPACES/KEYSPACE keyspace_name/TABLE keyspace_name.table_name</span><br></pre></td></tr></table></figure>
<h3 id="9、其他使用命令："><a href="#9、其他使用命令：" class="headerlink" title="9、其他使用命令："></a>9、其他使用命令：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">desc KEYSPACEs</span><br><span class="line">枚举所有数据库</span><br><span class="line">list users;</span><br><span class="line">查看所有用户</span><br><span class="line">show version;</span><br><span class="line">显示当前cqlsh,cassandra，cql spec,native protocol 版本信息</span><br><span class="line">show host;</span><br><span class="line">显示当前集群节点的ip地址和端口</span><br><span class="line">SHOW SESSION &lt;session id&gt;</span><br><span class="line">跟踪一个会话信息</span><br><span class="line">SOURCE &apos;/home/thobbs/commands.cql&apos;</span><br><span class="line">读取文件内容，执行cql语句</span><br><span class="line">CAPTURE &apos;&lt;file&gt;&apos;;</span><br><span class="line">将会话查询内容指定到一个文件内</span><br><span class="line">CAPTURE OFF;</span><br><span class="line">停止将查询结果指定到文件内，使其正常输出到屏幕上</span><br><span class="line">CAPTURE;</span><br><span class="line">查看当前抓取信息是否指定到什么目录下</span><br></pre></td></tr></table></figure>
<h3 id="10、如果nodetool-decommission命令将某节点提出-执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。"><a href="#10、如果nodetool-decommission命令将某节点提出-执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。" class="headerlink" title="10、如果nodetool decommission命令将某节点提出,执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。"></a>10、如果nodetool decommission命令将某节点提出,执行结束之后，如果需要把节点再重新加入集群，需要把数据目录下数据删除掉，重启cassandra服务。</h3>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Cassandra/">Cassandra</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/14/cassandra安装部署/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/14/mysql mgr从节点down恢复过程遇到的问题/"><span>[Mysql] mgr从节点down恢复过程遇到的问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/14/mysql mgr从节点down恢复过程遇到的问题/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-14T09:03:10.000Z">
          2018-09-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1-2）断掉，3节点被踢出了集群"><a href="#1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1-2）断掉，3节点被踢出了集群" class="headerlink" title="1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1,2）断掉，3节点被踢出了集群"></a>1、mgr集群有节点down掉，查看日志一台服务器（3）因网络问题与其他两个节点（1,2）断掉，3节点被踢出了集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> [Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-2:3306 has become unreachable.&apos;</span><br><span class="line">[Warning] Plugin group_replication reported: &apos;Member with address wallet-mysql-1:3306 has become unreachable.&apos;</span><br><span class="line"> [ERROR] Plugin group_replication reported: &apos;Member was expelled from the group due to network failures, changing member status to ERROR.&apos;</span><br></pre></td></tr></table></figure>
<h3 id="2、登录节点3尝试重新启动group-replication："><a href="#2、登录节点3尝试重新启动group-replication：" class="headerlink" title="2、登录节点3尝试重新启动group_replication："></a>2、登录节点3尝试重新启动group_replication：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;stop group_replicaiton;</span><br><span class="line">mysql&gt;start group_replication;</span><br></pre></td></tr></table></figure>
<h3 id="3、查看集群成员状态"><a href="#3、查看集群成员状态" class="headerlink" title="3、查看集群成员状态"></a>3、查看集群成员状态</h3><p>SELECT * FROM performance_schema.replication_group_members;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 6a41c0b6-8e3d-11e8-b076-000d3aa05296 | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 71540a17-8e3d-11e8-8cee-000d3aa1d767 | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e | wallet-mysql-3 |        3306 | RECOVERING       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br></pre></td></tr></table></figure></p>
<h3 id="4、节点3正在进行恢复，与主库同步数据，但是恢复过程error-log出现了以下问题："><a href="#4、节点3正在进行恢复，与主库同步数据，但是恢复过程error-log出现了以下问题：" class="headerlink" title="4、节点3正在进行恢复，与主库同步数据，但是恢复过程error.log出现了以下问题："></a>4、节点3正在进行恢复，与主库同步数据，但是恢复过程error.log出现了以下问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Error reading packet from server for channel &apos;group_replication_recovery&apos;: The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires. (server_errno=1236)</span><br><span class="line">[ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: Got fatal error 1236 from master when reading data from binary log: &apos;The slave is connecting using CHANGE MASTER TO MASTER_AUTO_POSITION = 1, but the master has purged binary logs containing GTIDs that the slave requires.&apos;, Error_code: 1236</span><br></pre></td></tr></table></figure>
<p>提示无法读取主库的binary log</p>
<h3 id="5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr："><a href="#5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr：" class="headerlink" title="5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr："></a>5、尝试去在另一个节点从库2上，全量dump一份数据，在3节点上应用并重新启动mgr：</h3><h4 id="5-1、节点2操作："><a href="#5-1、节点2操作：" class="headerlink" title="5.1、节点2操作："></a>5.1、节点2操作：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;/data/mysql/bin/mysqldump --all-databases --set-gtid-purged=ON --single-transaction -uroot -P3306 -p &gt; /tmp/alldb.sql</span><br></pre></td></tr></table></figure>
<p>拷贝alldb.sql到节点3的/tmp目录</p>
<h4 id="5-2、节点3操作："><a href="#5-2、节点3操作：" class="headerlink" title="5.2、节点3操作："></a>5.2、节点3操作：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;stop group_replication;</span><br><span class="line">mysql&gt;reset master;</span><br><span class="line">mysql&gt;set global read_only=0;</span><br><span class="line">mysql&gt;source /tmp/alldb.sql</span><br></pre></td></tr></table></figure>
<p>重新启动mysql数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br></pre></td></tr></table></figure></p>
<p>将节点3加入mgr集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;start group_replication;</span><br></pre></td></tr></table></figure></p>
<p>查看集群成员状态，集群状态恢复：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST    | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | 6a41c0b6-8e3d-11e8-b076-000d3aa05296 | wallet-mysql-2 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 71540a17-8e3d-11e8-8cee-000d3aa1d767 | wallet-mysql-1 |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | 7dd813bf-8e3d-11e8-8d92-000d3aa1c31e | wallet-mysql-3 |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+----------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/14/mysql mgr从节点down恢复过程遇到的问题/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/13/Multi-threaded slave statistics for channel 'group_replication_applier'/"><span>[Mysql] Multi-threaded slave statistics for channel</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/13/Multi-threaded slave statistics for channel 'group_replication_applier'/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-13T13:34:10.000Z">
          2018-09-13
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="0、从库error日志提示信息如下："><a href="#0、从库error日志提示信息如下：" class="headerlink" title="0、从库error日志提示信息如下："></a>0、从库error日志提示信息如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Note] Multi-threaded slave statistics for channel &apos;group_replication_applier&apos;: seconds elapsed = 267; events assigned = 10241; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 0; waited at clock conflicts = 981623300 waited (count) when Workers occupied = 1238 waited when Workers occupied = 6762438500</span><br></pre></td></tr></table></figure>
<h3 id="1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded-slave）需要启用slave-parallel-workers参数（默认值为0，最大值为1024），并且log-warning（该参数将于v8-0-3去除，被log-error-verbosity-替代）参数要大于1，在error-log里面会有上述提示。"><a href="#1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded-slave）需要启用slave-parallel-workers参数（默认值为0，最大值为1024），并且log-warning（该参数将于v8-0-3去除，被log-error-verbosity-替代）参数要大于1，在error-log里面会有上述提示。" class="headerlink" title="1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded slave）需要启用slave_parallel_workers参数（默认值为0，最大值为1024），并且log_warning（该参数将于v8.0.3去除，被log_error_verbosity 替代）参数要大于1，在error_log里面会有上述提示。"></a>1、mysqlerror-log出现上述提示信息是因为启用了mts（Multi-threaded slave）需要启用slave_parallel_workers参数（默认值为0，最大值为1024），并且log_warning（该参数将于v8.0.3去除，被log_error_verbosity 替代）参数要大于1，在error_log里面会有上述提示。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seconds elapsed 就是上一次统计跟这一次统计的时间间隔。</span><br><span class="line">events assigned：总共有多少个event被分配执行，计的是总数。</span><br><span class="line">worker queues filled over overrun level：mts在所有的并行workers之间倾向于加载平衡的时间。slave_parrllel_workers参数决定workers数量。这个统计参数显示了当前线程承受的饱和等级。如果以一个并行线程序列趋近与饱和，这个数会递增，线程复制时间会被推迟，避免达到线程序列限制。</span><br><span class="line">Waited due to a Worker queue full：因为worker队列爆满，协调线程必须等待该统计参数会增长</span><br><span class="line">Waited due to the total size:该参数代表因为达到了可用内存的限制，worker队列持有未应用事件造成协调线程睡眠的次数。如果这个值持续增长，需要增大slave_pending_jobs_size_max值来避免协调线程等待时间。</span><br><span class="line">slave_pending_jobs_size_max：此变量代表用于保存尚未应用的事件的从worker队列的最大内存量（以字节为单位），如果没有启动mts，修改该参数不会有任何效果。（v8.0.11之前默认值为16M,v8.0.12默认值为128M，最小值为1024，最大值为16eib）</span><br><span class="line">Waited at clock conflicts:在事务之间存在依赖的情况下，该参数显示等待时间相当于冲突检测和解决方案的逻辑时间。</span><br><span class="line">Waited (count) when used occupied:协调进程监控worker足额（enough）分配的统计次数。enough定义取决于调度类型（基于每个库和时钟）</span><br><span class="line">Waited when workers occupied:对任何可用worker计算协调线程等待的次数，仅适用于提交时钟调度程序。</span><br></pre></td></tr></table></figure>
<p><a href="https://www.percona.com/blog/2017/07/19/multi-threaded-slave-statistics/" target="_blank" rel="noopener">参考文档</a></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/13/Multi-threaded slave statistics for channel 'group_replication_applier'/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/12/mysql 切割慢日志另附定期切割日志脚本/"><span>[Mysql] mysql切割慢日志</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/12/mysql 切割慢日志另附定期切割日志脚本/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-12T11:04:10.000Z">
          2018-09-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割："><a href="#0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割：" class="headerlink" title="0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割："></a>0、去查看一个测试库的慢日志文件发现有11g的大小，根本没有办法使用mysqldumpslow去查询，因此想要先对日志进行切割：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">split几个主要参数：</span><br><span class="line">-b 	分割后的文档大小，单位是byte</span><br><span class="line">-C 	分割后的文档，单行最大byte数</span><br><span class="line">-d 	使用数字作为后缀，同时使用-a length指定后缀长度</span><br><span class="line">-l 	分割后文档的行数</span><br></pre></td></tr></table></figure>
<h3 id="1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test-log，不指定后缀会使用默认后缀名aa-ab-ac…-等"><a href="#1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test-log，不指定后缀会使用默认后缀名aa-ab-ac…-等" class="headerlink" title="1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test.log，不指定后缀会使用默认后缀名aa,ab,ac….等"></a>1、使用split，按大小切割日志文件，每个文件1G大小，切割后的文件名前缀为test.log，不指定后缀会使用默认后缀名aa,ab,ac….等</h3><p>split slow.log -b 1G test.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -ltrh test.log*</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:08 test.logaa</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:09 test.logab</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:10 test.logac</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:11 test.logad</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:12 test.logae</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:13 test.logaf</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:14 test.logag</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:15 test.logah</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:16 test.logai</span><br><span class="line">-rw-r--r-- 1 root  root  1.0G Sep 12 03:17 test.logaj</span><br><span class="line">-rw-r--r-- 1 root  root  270M Sep 12 03:17 test.logak</span><br></pre></td></tr></table></figure></p>
<h3 id="2、如果需要指定后缀可使用-d-a-参数（n）代表指定附加后缀的个数，比如切割test-logaa日志文件："><a href="#2、如果需要指定后缀可使用-d-a-参数（n）代表指定附加后缀的个数，比如切割test-logaa日志文件：" class="headerlink" title="2、如果需要指定后缀可使用-d -a  参数（n）代表指定附加后缀的个数，比如切割test.logaa日志文件："></a>2、如果需要指定后缀可使用-d -a <n> 参数（n）代表指定附加后缀的个数，比如切割test.logaa日志文件：</n></h3><p>split test.logaa -b 100M -d -a 2 logaa<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> ll logaa*</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa00</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa01</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa02</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa03</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa04</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa05</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa06</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa07</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:03 logaa08</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:04 logaa09</span><br><span class="line">-rw-r--r-- 1 root root  24M Sep 12 09:04 logaa10</span><br></pre></td></tr></table></figure></p>
<p>split test.logab -b 100M -d -a 4 logab<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -ltrh logab*</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0000</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0001</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0002</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0003</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0004</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0005</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0006</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:05 logab0007</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:06 logab0008</span><br><span class="line">-rw-r--r-- 1 root root 100M Sep 12 09:06 logab0009</span><br><span class="line">-rw-r--r-- 1 root root  24M Sep 12 09:06 logab0010</span><br></pre></td></tr></table></figure></p>
<h3 id="4、按行切割日志文件，查看准备切割的文件有多少行："><a href="#4、按行切割日志文件，查看准备切割的文件有多少行：" class="headerlink" title="4、按行切割日志文件，查看准备切割的文件有多少行："></a>4、按行切割日志文件，查看准备切割的文件有多少行：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat logab0001 |wc -l</span><br><span class="line">505</span><br></pre></td></tr></table></figure>
<p>按每个文件60行切割<br>split logab0001 -l 60 logab0001<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ll logab0001*</span><br><span class="line">-rw-r--r-- 1 root root 104857600 Sep 12 09:05 logab0001</span><br><span class="line">-rw-r--r-- 1 root root  11922880 Sep 12 09:10 logab0001aa</span><br><span class="line">-rw-r--r-- 1 root root  12506422 Sep 12 09:10 logab0001ab</span><br><span class="line">-rw-r--r-- 1 root root  12506026 Sep 12 09:10 logab0001ac</span><br><span class="line">-rw-r--r-- 1 root root  12506635 Sep 12 09:10 logab0001ad</span><br><span class="line">-rw-r--r-- 1 root root  12506065 Sep 12 09:10 logab0001ae</span><br><span class="line">-rw-r--r-- 1 root root  12506313 Sep 12 09:10 logab0001af</span><br><span class="line">-rw-r--r-- 1 root root  12506206 Sep 12 09:10 logab0001ag</span><br><span class="line">-rw-r--r-- 1 root root  12506325 Sep 12 09:10 logab0001ah</span><br><span class="line">-rw-r--r-- 1 root root   5390728 Sep 12 09:10 logab0001ai</span><br></pre></td></tr></table></figure></p>
<p>查看每个文件的行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">for i in `ls logab0001*`;do echo &quot;$i文件行数&quot;`cat $i|wc -l` ;done </span><br><span class="line">logab0001文件行数505</span><br><span class="line">logab0001aa文件行数60</span><br><span class="line">logab0001ab文件行数60</span><br><span class="line">logab0001ac文件行数60</span><br><span class="line">logab0001ad文件行数60</span><br><span class="line">logab0001ae文件行数60</span><br><span class="line">logab0001af文件行数60</span><br><span class="line">logab0001ag文件行数60</span><br><span class="line">logab0001ah文件行数60</span><br><span class="line">logab0001ai文件行数25</span><br></pre></td></tr></table></figure></p>
<h3 id="5、按每行字节数切割"><a href="#5、按每行字节数切割" class="headerlink" title="5、按每行字节数切割"></a>5、按每行字节数切割</h3><p>指定每行字节数最多不超过2000000个字节<br>split logab0001aa -C 2000000 testlog<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls -lthr testlog*</span><br><span class="line">-rw-r--r-- 1 root root  1.5M Sep 12 10:19 testlogaa</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogab</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogac</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogad</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogae</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogaf</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogag</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogah</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogai</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogaj</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:19 testlogak</span><br></pre></td></tr></table></figure></p>
<p>查看某一行的字节数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-slave log]# sed &apos;1p&apos; testlogaa|wc -c</span><br><span class="line">1960374</span><br></pre></td></tr></table></figure></p>
<p>字节数小于2000000<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf testlog*</span><br></pre></td></tr></table></figure></p>
<p>删除生成的日志文件，生成每行字节最大不超过1500000的日志文件：<br>split logab0001aa -C 1500000 testlog<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ls -lthr testlog*</span><br><span class="line">-rw-r--r-- 1 root root  449K Sep 12 10:22 testlogaa</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogab</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogac</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogad</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogae</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogaf</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogag</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogah</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogai</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogaj</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogak</span><br><span class="line">-rw-r--r-- 1 root root 1018K Sep 12 10:22 testlogal</span><br></pre></td></tr></table></figure></p>
<p>查看某一行的字节数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-slave log]# sed &apos;1p&apos; testlogaa|wc -c</span><br><span class="line">918219</span><br></pre></td></tr></table></figure></p>
<p>字节数小于1500000</p>
<h3 id="6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割："><a href="#6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割：" class="headerlink" title="6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割："></a>6、上面产生11g的慢日志文件主要是由于日志没有定期切割造成的，因此写了个脚本，定期对慢日志进行切割：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#mysql慢日志所在路径</span><br><span class="line">slowlogpath=/data/mysql/log</span><br><span class="line">#mysql慢日志文件名</span><br><span class="line">slowlogname=slow.log</span><br><span class="line">#当前系统时间</span><br><span class="line">stamp=`date +&apos;%Y%m%d&apos;`</span><br><span class="line">#与当前系统时间对比，七天前的时间</span><br><span class="line">oldstamp=`date +&quot;%Y%m%d&quot; -d &quot;-7 day&quot;`</span><br><span class="line">#mysql用户名</span><br><span class="line">username=root</span><br><span class="line">#mysql用户名密码</span><br><span class="line">password=12345678</span><br><span class="line">#mysql安装路径</span><br><span class="line">dbpath=/data/mysql/bin</span><br><span class="line">#移动mysql慢日志</span><br><span class="line">mv $&#123;slowlogpath&#125;/$&#123;slowlogname&#125;  $&#123;slowlogpath&#125;/$&#123;stamp&#125;_$&#123;slowlogname&#125;</span><br><span class="line">#重新生成slow日志文件：</span><br><span class="line">$&#123;dbpath&#125;/mysqladmin -u $&#123;username&#125; -p$&#123;password&#125; flush-logs slow</span><br><span class="line">#删除7天前的日志文件</span><br><span class="line">if [ -e $&#123;slowlogpath&#125;/$&#123;oldstamp&#125;_$&#123;slowlogname&#125; ];then</span><br><span class="line">   sudo rm -rf $&#123;slowlogpath&#125;/$&#123;oldstamp&#125;_$&#123;slowlogname&#125;</span><br><span class="line">else</span><br><span class="line">   :</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>将脚本添加到定时任务：<br>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/script/split_mysqlslowlog.sh</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a><a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/12/mysql 切割慢日志另附定期切割日志脚本/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/12/mysqldumpslow参数详解/"><span>[Mysql] mysqldumpslow参数详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/12/mysqldumpslow参数详解/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-12T08:35:10.000Z">
          2018-09-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。"><a href="#1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。" class="headerlink" title="1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。"></a>1、mysql慢查询日志包含了执行花费较长时间的查询语句信息。</h3><p>mysqldumpslow解析慢日志文件并打印出内容摘要。<br>mysqldumpslow进行分组查询，除了有特殊数值和字符串数据值之外。当现实摘要输出是，将数值抽象化为n（数字）和s（字符串）。参数-a和-n可以用于修改抽象化行为。</p>
<h3 id="0、-a-表示不使用抽象的字符串s，数字n替换查询sql语句的内容"><a href="#0、-a-表示不使用抽象的字符串s，数字n替换查询sql语句的内容" class="headerlink" title="0、-a 表示不使用抽象的字符串s，数字n替换查询sql语句的内容"></a>0、-a 表示不使用抽象的字符串s，数字n替换查询sql语句的内容</h3><p>不指定-a参数，查询结果中数值和字符串分别用n和s代替<br>/data/mysql/bin/mysqldumpslow -t 2  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=132.03s (924s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=81.63s (571s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br></pre></td></tr></table></figure></p>
<p>添加-a参数，查询结果中数值和字符串用各自的对应值表示，未被抽象化：<br>/data/mysql/bin/mysqldumpslow -a -t 2  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 1  Time=244.60s (244s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT 1,1000000) as tmp)</span><br><span class="line">Count: 1  Time=230.44s (230s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT 4000000,1000000) as tmp)</span><br></pre></td></tr></table></figure></p>
<h3 id="2、-n-名称中抽象化数字的最少个数"><a href="#2、-n-名称中抽象化数字的最少个数" class="headerlink" title="2、-n 名称中抽象化数字的最少个数"></a>2、-n 名称中抽象化数字的最少个数</h3><h3 id="3、–debug-写入调试信息"><a href="#3、–debug-写入调试信息" class="headerlink" title="3、–debug 写入调试信息"></a>3、–debug 写入调试信息</h3><h3 id="4、-g-后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字："><a href="#4、-g-后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字：" class="headerlink" title="4、-g 后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字："></a>4、-g 后面可以写正则表达式匹配，大小写不敏感。根据个人需要，过滤需要的关键字：</h3><p>/data/mysql/bin/mysqldumpslow -t 5 -l -g ‘test’  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 1  Time=44.68s (44s)  Lock=0.00s (0s)  Rows=2.0 (2), root[root]@localhost</span><br><span class="line">  select distinct state from test  order by id</span><br><span class="line">Count: 2  Time=27.04s (54s)  Lock=0.00s (0s)  Rows=2.0 (4), root[root]@localhost</span><br><span class="line">  select distinct state from test where id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br></pre></td></tr></table></figure></p>
<h3 id="5、–help-显示帮助信息并退出"><a href="#5、–help-显示帮助信息并退出" class="headerlink" title="5、–help 显示帮助信息并退出"></a>5、–help 显示帮助信息并退出</h3><h3 id="6、-h-日志文件名中服务的主机名"><a href="#6、-h-日志文件名中服务的主机名" class="headerlink" title="6、-h 日志文件名中服务的主机名"></a>6、-h 日志文件名中服务的主机名</h3><p>使用-h hostname参数，可使用通配符去过滤慢日志<br>查看当前目录下的慢日志文件名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ll *-slow.log</span><br><span class="line">-rw-r--r-- 1 root  root   583 Sep 12 06:21 10.0.7.4-slow.log</span><br><span class="line">-rw-r----- 1 mysql mysql 1889 Sep 12 05:51 test-slow.log</span><br></pre></td></tr></table></figure></p>
<p>如果使用<em>-slow.log去过滤慢日志，会把所有-slow.log为后缀的文件都过滤。<br>mysqldumpslow -a -t 20 -h dax-mysql-slave  /data/mysql/log/</em>-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/10.0.7.4-slow.log /data/mysql/log/test-slow.log</span><br><span class="line">Count: 1  Time=137.68s (137s)  Lock=0.00s (0s)  Rows=5.0 (5), root[root]@localhost</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 5</span><br><span class="line">Count: 1  Time=120.01s (120s)  Lock=0.00s (0s)  Rows=15.0 (15), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 20</span><br><span class="line">Count: 2  Time=90.84s (181s)  Lock=0.00s (0s)  Rows=10.0 (20), 2users@2hosts</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 10</span><br><span class="line">Count: 1  Time=82.82s (82s)  Lock=0.00s (0s)  Rows=12.0 (12), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 12</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 5.</span><br></pre></td></tr></table></figure></p>
<p>也可以指定匹配主机范围：<br>mysqldumpslow -a -t 20 -h dax-mysql-slave  /data/mysql/log/10.0.7.*-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/10.0.7.4-slow.log</span><br><span class="line">Count: 1  Time=82.82s (82s)  Lock=0.00s (0s)  Rows=12.0 (12), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 12</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 1.</span><br></pre></td></tr></table></figure></p>
<p>-h 后面如果不加任何参数，会匹配出test-slow.log为日志文件名的日志：<br>[root@dax-mysql-slave log]# mysqldumpslow -a -t 20 -h   /data/mysql/log/*-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/test-slow.log</span><br><span class="line">Count: 1  Time=137.68s (137s)  Lock=0.00s (0s)  Rows=5.0 (5), root[root]@localhost</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 5</span><br><span class="line">Count: 1  Time=120.01s (120s)  Lock=0.00s (0s)  Rows=15.0 (15), repl[repl]@[10.0.7.51]</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id = &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 20</span><br><span class="line">Count: 2  Time=90.84s (181s)  Lock=0.00s (0s)  Rows=10.0 (20), 2users@2hosts</span><br><span class="line">  SELECT * FROM test WHERE trade_asset = &apos;BCH&apos; AND price_asset = &apos;ETH&apos; AND broker_id &apos;1022668762972741633&apos; AND  state in (&apos;WAITING&apos;, &apos;PROCESSING&apos;) order by id limit 10</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 4.</span><br></pre></td></tr></table></figure></p>
<p>-h 后面不加任何参数，日志文件名使用过滤条件会报错：<br>[root@dax-mysql-slave log]# mysqldumpslow -a -t 20 -h  /data/mysql/log/10.0.7.*-slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/data//data/mysql/log/10.0.7.4-slow.log-slow.log</span><br><span class="line">Can&apos;t open /data/mysql/data//data/mysql/log/10.0.7.4-slow.log-slow.log: No such file or directory at /data/mysql/bin/mysqldumpslow line 91.</span><br><span class="line">Died at /data/mysql/bin/mysqldumpslow line 161.</span><br></pre></td></tr></table></figure></p>
<h3 id="7、-i-服务的实例名（官方文档说通过mysql-server启动查看服务实例名，测试之后未找到）"><a href="#7、-i-服务的实例名（官方文档说通过mysql-server启动查看服务实例名，测试之后未找到）" class="headerlink" title="7、-i 服务的实例名（官方文档说通过mysql.server启动查看服务实例名，测试之后未找到）"></a>7、-i 服务的实例名（官方文档说通过mysql.server启动查看服务实例名，测试之后未找到）</h3><h3 id="8、-l-不从总时间内减去锁时间"><a href="#8、-l-不从总时间内减去锁时间" class="headerlink" title="8、-l 不从总时间内减去锁时间"></a>8、-l 不从总时间内减去锁时间</h3><h3 id="9、-r-反转排序顺序"><a href="#9、-r-反转排序顺序" class="headerlink" title="9、-r 反转排序顺序"></a>9、-r 反转排序顺序</h3><h3 id="10、-s-何种方式排序：t，at：按查询时间或平均查询时间排序-l，al：按锁定时间或平均锁定时间排序-r，ar：按发送的行或发送的平均行排序-c：按计数排序-默认情况下，按平均查询时间（相当于-s-at）排序。"><a href="#10、-s-何种方式排序：t，at：按查询时间或平均查询时间排序-l，al：按锁定时间或平均锁定时间排序-r，ar：按发送的行或发送的平均行排序-c：按计数排序-默认情况下，按平均查询时间（相当于-s-at）排序。" class="headerlink" title="10、-s 何种方式排序：t，at：按查询时间或平均查询时间排序;l，al：按锁定时间或平均锁定时间排序;r，ar：按发送的行或发送的平均行排序;c：按计数排序;默认情况下，按平均查询时间（相当于-s at）排序。"></a>10、-s 何种方式排序：t，at：按查询时间或平均查询时间排序;l，al：按锁定时间或平均锁定时间排序;r，ar：按发送的行或发送的平均行排序;c：按计数排序;默认情况下，按平均查询时间（相当于-s at）排序。</h3><p>按总时间排序：<br>/data/mysql/bin/mysqldumpslow -s t -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br><span class="line">Count: 6674  Time=1.52s (10151s)  Lock=0.00s (0s)  Rows=9.9 (66259), 2users@5hosts</span><br><span class="line">  SELECT id, order_no, broker_id, broker_uid, plat_id, trade_asset, price_asset, trade_type, order_type, price, number, client_order_no, traded_number, over_number, traded_money, fee_asset, fee, broker_fee, cloud_fee, create_time, update_time, state, send_state, error_code, error_msg FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;)) order by create_time desc LIMIT N</span><br><span class="line">Count: 84  Time=40.42s (3394s)  Lock=0.00s (0s)  Rows=1.0 (84), 42users@42hosts</span><br><span class="line">  SELECT member_id, member_host, member_port, member_state, @@group_replication_single_primary_mode FROM performance_schema.replication_group_members WHERE channel_name = &apos;S&apos;</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br></pre></td></tr></table></figure></p>
<p>按平均时间排序：<br>/data/mysql/bin/mysqldumpslow -s at -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 35  Time=79.40s (2779s)  Lock=0.00s (0s)  Rows=18592104.7 (650723665), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `finance_detail`</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 1  Time=44.68s (44s)  Lock=0.00s (0s)  Rows=2.0 (2), root[root]@localhost</span><br><span class="line">  select distinct state from test  order by id</span><br></pre></td></tr></table></figure></p>
<p>按锁表时间排序<br>[root@mw-mysql-2 ~]# /data/mysql/bin/mysqldumpslow -s l -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br></pre></td></tr></table></figure></p>
<p>按锁表平均时间排序<br>[root@mw-mysql-2 ~]# /data/mysql/bin/mysqldumpslow -s al -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 7  Time=226.54s (1585s)  Lock=94.51s (661s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br><span class="line">Count: 7  Time=157.43s (1101s)  Lock=75.80s (530s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  UPDATE test SET state = &apos;S&apos; where state=&apos;S&apos; and id &gt;=N and id &lt;= N</span><br><span class="line">Count: 1  Time=44.68s (44s)  Lock=0.00s (0s)  Rows=2.0 (2), root[root]@localhost</span><br><span class="line">  select distinct state from test  order by id</span><br><span class="line">Count: 1  Time=0.98s (0s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@localhost</span><br><span class="line">  select count(*) from test where broker_id = &apos;S&apos; AND broker_uid = N</span><br><span class="line">Count: 2  Time=27.04s (54s)  Lock=0.00s (0s)  Rows=2.0 (4), root[root]@localhost</span><br><span class="line">  select distinct state from test where id in (select id from (select id from test ORDER BY id ASC LIMIT N,N) as tmp)</span><br></pre></td></tr></table></figure></p>
<p>按返回行排序<br>/data/mysql/bin/mysqldumpslow -s r -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 35  Time=79.40s (2779s)  Lock=0.00s (0s)  Rows=18592104.7 (650723665), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `finance_detail`</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 4  Time=7.10s (28s)  Lock=0.00s (0s)  Rows=1121601.2 (4486405), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_1`</span><br><span class="line">Count: 4  Time=4.29s (17s)  Lock=0.00s (0s)  Rows=1121591.2 (4486365), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_2`</span><br><span class="line">Count: 4  Time=4.72s (18s)  Lock=0.00s (0s)  Rows=1121587.5 (4486350), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_3`</span><br></pre></td></tr></table></figure></p>
<p>按平均返回行排序<br>/data/mysql/bin/mysqldumpslow -s ar -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 35  Time=79.40s (2779s)  Lock=0.00s (0s)  Rows=18592104.7 (650723665), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `finance_detail`</span><br><span class="line">Count: 35  Time=59.29s (2075s)  Lock=0.00s (0s)  Rows=9207179.6 (322251287), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `test`</span><br><span class="line">Count: 4  Time=7.10s (28s)  Lock=0.00s (0s)  Rows=1121601.2 (4486405), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_1`</span><br><span class="line">Count: 4  Time=4.29s (17s)  Lock=0.00s (0s)  Rows=1121591.2 (4486365), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_2`</span><br><span class="line">Count: 4  Time=4.72s (18s)  Lock=0.00s (0s)  Rows=1121587.5 (4486350), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `mq_produce_log_3`</span><br></pre></td></tr></table></figure></p>
<p>按查询次数排序<br>/data/mysql/bin/mysqldumpslow -s c -t 5 -l  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br><span class="line">Count: 6674  Time=1.52s (10151s)  Lock=0.00s (0s)  Rows=9.9 (66259), 2users@5hosts</span><br><span class="line">  SELECT id, order_no, broker_id, broker_uid, plat_id, trade_asset, price_asset, trade_type, order_type, price, number, client_order_no, traded_number, over_number, traded_money, fee_asset, fee, broker_fee, cloud_fee, create_time, update_time, state, send_state, error_code, error_msg FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;)) order by create_time desc LIMIT N</span><br><span class="line">Count: 619  Time=1.20s (741s)  Lock=0.00s (0s)  Rows=10.0 (6181), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT  id,order_no,broker_id,broker_uid,plat_id,trade_asset,price_asset,trade_type,order_type,price,number,client_order_no,traded_number,over_number,traded_money,fee_asset,fee,broker_fee,cloud_fee,create_time,update_time,state,send_state,error_code,error_msg  FROM test  WHERE       (  state = &apos;S&apos;</span><br><span class="line">  and send_state = &apos;S&apos;</span><br><span class="line">  and update_time &lt; &apos;S&apos; ) LIMIT N</span><br></pre></td></tr></table></figure></p>
<p>添加-r参数对取到值反转排序：<br>/data/mysql/bin/mysqldumpslow -s c -t 5 -l -r  /data/mysql/log/slow.log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Reading mysql slow query log from /data/mysql/log/slow.log</span><br><span class="line">Count: 619  Time=1.20s (741s)  Lock=0.00s (0s)  Rows=10.0 (6181), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT  id,order_no,broker_id,broker_uid,plat_id,trade_asset,price_asset,trade_type,order_type,price,number,client_order_no,traded_number,over_number,traded_money,fee_asset,fee,broker_fee,cloud_fee,create_time,update_time,state,send_state,error_code,error_msg  FROM test  WHERE       (  state = &apos;S&apos;</span><br><span class="line">  and send_state = &apos;S&apos;</span><br><span class="line">  and update_time &lt; &apos;S&apos; ) LIMIT N</span><br><span class="line">Count: 6674  Time=1.52s (10151s)  Lock=0.00s (0s)  Rows=9.9 (66259), 2users@5hosts</span><br><span class="line">  SELECT id, order_no, broker_id, broker_uid, plat_id, trade_asset, price_asset, trade_type, order_type, price, number, client_order_no, traded_number, over_number, traded_money, fee_asset, fee, broker_fee, cloud_fee, create_time, update_time, state, send_state, error_code, error_msg FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;)) order by create_time desc LIMIT N</span><br><span class="line">Count: 12053  Time=1.14s (13735s)  Lock=0.00s (0s)  Rows=1.0 (12053), 2users@5hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;))</span><br><span class="line">Count: 16300  Time=0.20s (3291s)  Lock=0.00s (1s)  Rows=1.0 (16300), cdax[cdax]@[10.1.110.9]</span><br><span class="line">  SELECT count(N) FROM test WHERE (state = &apos;S&apos; AND send_state = &apos;S&apos; AND update_time &lt; &apos;S&apos;)</span><br><span class="line">Count: 50831  Time=1.49s (75892s)  Lock=0.00s (4s)  Rows=1.0 (50831), cdax[cdax]@4hosts</span><br><span class="line">  SELECT count(N) FROM test WHERE (trade_asset = &apos;S&apos; AND price_asset = &apos;S&apos; AND broker_id = &apos;S&apos; AND broker_uid = N AND state IN (&apos;S&apos;, &apos;S&apos;) AND create_time &gt;= &apos;S&apos; AND create_time &lt;= &apos;S&apos;)</span><br></pre></td></tr></table></figure></p>
<h3 id="11、-t-按指定数字显示行输出"><a href="#11、-t-按指定数字显示行输出" class="headerlink" title="11、-t 按指定数字显示行输出"></a>11、-t 按指定数字显示行输出</h3><h3 id="12、–verbose-详细模式"><a href="#12、–verbose-详细模式" class="headerlink" title="12、–verbose 详细模式"></a>12、–verbose 详细模式</h3><h3 id="13、如果不小心删掉了slow-log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）"><a href="#13、如果不小心删掉了slow-log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）" class="headerlink" title="13、如果不小心删掉了slow.log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）"></a>13、如果不小心删掉了slow.log可通过flush-log参数来重新生成慢日志文件（定期做日志切割的时候可能会用到）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root -ptest flush-logs slow</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/12/mysqldumpslow参数详解/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/11/mysql limit参数详解及使用过程遇到的问题/"><span>[Mysql] mysql limit参数详解及使用过程遇到的问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/11/mysql limit参数详解及使用过程遇到的问题/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-11T11:08:40.000Z">
          2018-09-11
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="前提：开发反应一条sql查询很慢，查看sql执行计划："><a href="#前提：开发反应一条sql查询很慢，查看sql执行计划：" class="headerlink" title="前提：开发反应一条sql查询很慢，查看sql执行计划："></a>前提：开发反应一条sql查询很慢，查看sql执行计划：</h3><p><img src="https://i.imgur.com/0g4vJQi.png" alt=""><br>查看到没有走设置的索引，而是走了主键索引，尝试去掉limit行限制之后：<br><img src="https://i.imgur.com/cHs3D6a.png" alt=""><br>发现去掉limit走索引正常。<br>是用group by和limit测试执行计划是否正常：<br><img src="https://i.imgur.com/taIuBAg.png" alt=""><br><img src="https://i.imgur.com/zmycRJf.png" alt=""><br>group by与limit组合会影响执行计划。<br>只使用limit，去掉order by和group by实验：<br><img src="https://i.imgur.com/ur8UNHg.png" alt=""><br><img src="https://i.imgur.com/W5mAiMg.png" alt=""><br>执行计划没有受影响。<br>结论：order by、group by与limit在一起执行的时候要注意执行计划是否影响，如果不得不使用该组合，担心执行计划被更改，建议使用force index(index_name)，或者多次测试执行计划不会被影响再放到生产环境里。<br>下面介绍官方文档就limit参数的解释：</p>
<h3 id="0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。"><a href="#0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。" class="headerlink" title="0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。"></a>0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。</h3><h3 id="1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。"><a href="#1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。" class="headerlink" title="1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。"></a>1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。</h3><h3 id="2、如果使用order-by与limit-row-count组合，mysql只要找到排序结果row-count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row-count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order-by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。"><a href="#2、如果使用order-by与limit-row-count组合，mysql只要找到排序结果row-count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row-count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order-by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。" class="headerlink" title="2、如果使用order by与limit row_count组合，mysql只要找到排序结果row_count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row_count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。"></a>2、如果使用order by与limit row_count组合，mysql只要找到排序结果row_count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row_count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。</h3><p>limit会影响执行计划，因此orderby带有limit和不带有limit返回行会是不同排序。</p>
<h3 id="3、官方文档的实验如下："><a href="#3、官方文档的实验如下：" class="headerlink" title="3、官方文档的实验如下："></a>3、官方文档的实验如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">|  2 |        3 |    5.0 |</span><br><span class="line">|  7 |        3 |    2.7 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure>
<p>带有limit子句会影响每一个行category的返回值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category LIMIT 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure></p>
<p>对于带有limit和不带有limit的子句返回相同的行排序是很重要的，增加合适的列在order by子句中确保顺序。例如在order by后加一个id的排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category, id;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">|  2 |        3 |    5.0 |</span><br><span class="line">|  7 |        3 |    2.7 |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category, id LIMIT 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure></p>
<p>4、根据官方文档提供的信息，自己动手实验，创建测试数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">create table ratings (id int,category int,rating varchar(10));</span><br><span class="line">insert into ratings values(5,1,&apos;3.2&apos;),(1,1,&apos;4.5&apos;),(4,2,&apos;3.5&apos;),(3,2,&apos;3.7&apos;),(6,2,&apos;3.5&apos;),(7,3,&apos;2.7&apos;),(2,3,&apos;5.0&apos;);</span><br><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">|    7 |        3 | 2.7    |</span><br><span class="line">|    2 |        3 | 5.0    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category limit 5;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>id列没有做任何排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category,id;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">|    2 |        3 | 5.0    |</span><br><span class="line">|    7 |        3 | 2.7    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在order by后多加一个id列，category和id列都按大小做了排序。</p>
<p>5、尝试在对id列添加主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:10:  [test]&gt; alter table ratings add primary key(id);</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line">root@db 09:10:  [test]&gt; SELECT * FROM ratings order by category;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 | 4.5    |</span><br><span class="line">|  5 |        1 | 3.2    |</span><br><span class="line">|  3 |        2 | 3.7    |</span><br><span class="line">|  4 |        2 | 3.5    |</span><br><span class="line">|  6 |        2 | 3.5    |</span><br><span class="line">|  2 |        3 | 5.0    |</span><br><span class="line">|  7 |        3 | 2.7    |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">root@db 09:10:  [test]&gt; SELECT * FROM ratings order by category limit 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 | 4.5    |</span><br><span class="line">|  5 |        1 | 3.2    |</span><br><span class="line">|  3 |        2 | 3.7    |</span><br><span class="line">|  4 |        2 | 3.5    |</span><br><span class="line">|  6 |        2 | 3.5    |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>添加主键之后id和category列都按大小排序。</p>
<h3 id="6、如果使用limit-row-count和distinct联合，mysql停止查询一旦找到row-count唯一行数。"><a href="#6、如果使用limit-row-count和distinct联合，mysql停止查询一旦找到row-count唯一行数。" class="headerlink" title="6、如果使用limit row_count和distinct联合，mysql停止查询一旦找到row_count唯一行数。"></a>6、如果使用limit row_count和distinct联合，mysql停止查询一旦找到row_count唯一行数。</h3><h3 id="7、一些情况下，group-by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit-row-count不计算任何不必要group-by值。"><a href="#7、一些情况下，group-by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit-row-count不计算任何不必要group-by值。" class="headerlink" title="7、一些情况下，group by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit row_count不计算任何不必要group by值。"></a>7、一些情况下，group by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit row_count不计算任何不必要group by值。</h3><h3 id="8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql-cal-found-rows函数。在这种情况下，可以使用select-found-rows-获取行数。"><a href="#8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql-cal-found-rows函数。在这种情况下，可以使用select-found-rows-获取行数。" class="headerlink" title="8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql_cal_found_rows函数。在这种情况下，可以使用select found_rows()获取行数。"></a>8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql_cal_found_rows函数。在这种情况下，可以使用select found_rows()获取行数。</h3><h3 id="9、limit-0快速返回一个空集。对于检查查询有效性很用帮助。"><a href="#9、limit-0快速返回一个空集。对于检查查询有效性很用帮助。" class="headerlink" title="9、limit 0快速返回一个空集。对于检查查询有效性很用帮助。"></a>9、limit 0快速返回一个空集。对于检查查询有效性很用帮助。</h3><h3 id="10、如果服务使用临时表来解决查询，使用limit-row-count子句来计算需要多少空间。"><a href="#10、如果服务使用临时表来解决查询，使用limit-row-count子句来计算需要多少空间。" class="headerlink" title="10、如果服务使用临时表来解决查询，使用limit row_count子句来计算需要多少空间。"></a>10、如果服务使用临时表来解决查询，使用limit row_count子句来计算需要多少空间。</h3><h3 id="11、如果order-by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。"><a href="#11、如果order-by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。" class="headerlink" title="11、如果order by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。"></a>11、如果order by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。</h3>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/11/mysql limit参数详解及使用过程遇到的问题/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/3/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2018 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>