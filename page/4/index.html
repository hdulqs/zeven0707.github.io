<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 4 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/"><span>[Mysql] mysql-mgr（双节点)依次修改server-id</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T02:18:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、查看从节点server-id信息："><a href="#1、查看从节点server-id信息：" class="headerlink" title="1、查看从节点server-id信息："></a>1、查看从节点server-id信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:55:  [(none)]&gt; show variables like &quot;%server%&quot;;</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| character_set_server                              | utf8mb4                              |</span><br><span class="line">| collation_server                                  | utf8mb4_general_ci                   |</span><br><span class="line">| group_replication_recovery_ssl_verify_server_cert | OFF                                  |</span><br><span class="line">| innodb_ft_server_stopword_table                   |                                      |</span><br><span class="line">| server_id                                         | 3306102                              |</span><br><span class="line">| server_id_bits                                    | 32                                   |</span><br><span class="line">| server_uuid                                       | bddd9c32-8fee-11e8-ac79-525400edbe8d |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="2、登录mysql-shell查看集群信息："><a href="#2、登录mysql-shell查看集群信息：" class="headerlink" title="2、登录mysql-shell查看集群信息："></a>2、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将从节点移除集群：<br>MySQL  dax-mysql-master:3306  JS &gt; cluster.removeInstance(‘dax-mysql-slave:3306’)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">The instance will be removed from the InnoDB cluster. Depending on the </span><br><span class="line">instance being the Seed or not, the Metadata session might become invalid. </span><br><span class="line">If so, please start a new session to the Metadata Storage R/W instance.</span><br><span class="line"></span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please set the &apos;group_replication_start_on_boot&apos; variable to &apos;OFF&apos; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The instance &apos;dax-mysql-slave:3306&apos; was successfully removed from the cluster.</span><br><span class="line"></span><br><span class="line">WARNING: The &apos;group_replication_start_on_boot&apos; variable must be set to &apos;OFF&apos; in the server configuration file, otherwise it might silently rejoin the cluster upon restart.</span><br></pre></td></tr></table></figure></p>
<p>重新扫描集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan();</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、从节点修改server-id，并重启库，之后将从节点加入集群："><a href="#3、从节点修改server-id，并重启库，之后将从节点加入集群：" class="headerlink" title="3、从节点修改server-id，并重启库，之后将从节点加入集群："></a>3、从节点修改server-id，并重启库，之后将从节点加入集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql-shell &gt; cluster.addInstance(&apos;dax-mysql-slave:3306&apos;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &apos;root@dax-mysql-slave:3306&apos;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-slave:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &apos;root@dax-mysql-slave:3306&apos; was successfully added to the cluster.</span><br></pre></td></tr></table></figure>
<p>查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他节点修改方法如上。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/07/oracle本地表空间在uniform、system等不同模式下分配extent方式/"><span>[Oracle] oracle本地表空间在uniform、system等不同模式下分配extent方式</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/07/oracle本地表空间在uniform、system等不同模式下分配extent方式/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-07T10:51:00.000Z">
          2018-11-07
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、表空间和表都使用oracle默认参数"><a href="#1、表空间和表都使用oracle默认参数" class="headerlink" title="1、表空间和表都使用oracle默认参数"></a>1、表空间和表都使用oracle默认参数</h4><p>查看scott用户默认表空间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select username,default_tablespace from dba_users where username=&apos;SCOTT&apos;;</span><br><span class="line">USERNAME		       DEFAULT_TABLESPACE</span><br><span class="line">------------------------------ ------------------------------</span><br><span class="line">SCOTT			       USERS</span><br></pre></td></tr></table></figure></p>
<p>查看users表空间初始化extent大小：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select TABLESPACE_NAME,BLOCK_SIZE,INITIAL_EXTENT,NEXT_EXTENT,MIN_EXTENTS,MAX_EXTENTS,EXTENT_MANAGEMENT,ALLOCATION_TYPE from user_tablespaces where tablespace_name=&apos;USERS&apos;;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME 	       BLOCK_SIZE INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS EXTENT_MAN ALLOCATIO</span><br><span class="line">------------------------------ ---------- -------------- ----------- ----------- ----------- ---------- ---------</span><br><span class="line">USERS				     8192	   65536		       1  2147483645 LOCAL	SYSTEM</span><br></pre></td></tr></table></figure></p>
<p>查看当前数据库块大小：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show parameter db_block_size;</span><br><span class="line"></span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">db_block_size			     integer	 8192</span><br></pre></td></tr></table></figure></p>
<p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11:43:49 SCOTT@ boston&gt;  create table t1 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line">表数据为空，查看是否有extent区在：</span><br><span class="line">11:43:54 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p>
<p>向t1表内插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">11:43:50 SCOTT@ boston&gt;  insert into t1  select * from emp;</span><br><span class="line">14 rows created.</span><br></pre></td></tr></table></figure></p>
<p>查看已分配出一个8个block的extent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">11:43:55 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">Elapsed: 00:00:00.50</span><br></pre></td></tr></table></figure></p>
<p>因数据量太小，只分配了一个区，需插入大量数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12:00:40 SCOTT@ boston&gt;  insert into t1  select * from t1;</span><br><span class="line">42 rows created.</span><br><span class="line">...</span><br><span class="line">12:00:57 SCOTT@ boston&gt; /</span><br><span class="line">2688 rows created.</span><br><span class="line">Elapsed: 00:00:00.02</span><br></pre></td></tr></table></figure></p>
<p>再次查看extent，当分配16个extent之后，数据量达到了16<em>8</em>8/1024=1M，当达到1m之后，在分配下一个extent会直接分配128个块，大小分为128*8/1024=1M：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">12:01:01 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">...</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br></pre></td></tr></table></figure></p>
<p>再次插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12:28:36 SCOTT@ boston&gt; /</span><br><span class="line">5376 rows created.</span><br><span class="line">Elapsed: 00:00:00.02</span><br><span class="line">....</span><br><span class="line">12:30:11 SCOTT@ boston&gt; /</span><br><span class="line">688128 rows created.</span><br></pre></td></tr></table></figure></p>
<p>查看extent情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">12:30:14 SYS@ boston&gt;select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">....</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br><span class="line">...</span><br><span class="line">T1											  78	      4       8320	  128</span><br><span class="line">T1											  79	      4       8448	 1024</span><br><span class="line">80 rows selected.</span><br></pre></td></tr></table></figure></p>
<p>当表数据量达到64M的时候，再次分配下一个extent会直接分配1024个block，大小为64M。</p>
<p>手动对表t1分配extent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">13:35:52 SCOTT@ boston&gt; alter table t1 allocate extent;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.49</span><br><span class="line">14:18:45 SCOTT@ boston&gt; /</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.07</span><br><span class="line">14:19:28 SCOTT@ boston&gt; /</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.06</span><br></pre></td></tr></table></figure></p>
<p>查看extent情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">14:19:06 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">...</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br><span class="line">...</span><br><span class="line">T1											  78	      4       8320	  128</span><br><span class="line">T1											  79	      4       8448	 1024</span><br><span class="line">T1											  80	      4       9472	  128</span><br><span class="line">T1											  81	      4       9600	  128</span><br><span class="line">T1											  82	      4       9728	  128</span><br><span class="line">83 rows selected.</span><br><span class="line">Elapsed: 00:00:00.45</span><br></pre></td></tr></table></figure></p>
<p>使用alter table ** allocate extent手动分配的区大小为1M。</p>
<p>再次对表插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">14:19:30 SCOTT@ boston&gt;  insert into t1  select * from t1;</span><br><span class="line">1376256 rows created.</span><br><span class="line">Elapsed: 00:00:12.03</span><br></pre></td></tr></table></figure></p>
<p>查看extent情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">14:20:34 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">...</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br><span class="line">...</span><br><span class="line">T1											  78	      4       8320	  128</span><br><span class="line">T1											  79	      4       8448	 1024</span><br><span class="line">T1											  80	      4       9472	  128</span><br><span class="line">T1											  81	      4       9600	  128</span><br><span class="line">T1											  82	      4       9728	  128</span><br><span class="line">T1											  83	      4       9856	 1024</span><br><span class="line">...</span><br><span class="line">T1											  88	      4      14976	 1024</span><br><span class="line">89 rows selected.</span><br></pre></td></tr></table></figure></p>
<p>插入数据分配的extent大小均为64M。</p>
<h4 id="2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）："><a href="#2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）：" class="headerlink" title="2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）："></a>2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）：</h4><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table t2 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t2 MOVE STORAGE ( INITIAL 20k NEXT 40k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure></p>
<p>查看表参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name = &apos;T2&apos;;</span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">	 24576	     40960</span><br></pre></td></tr></table></figure></p>
<p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p>
<p>向表空插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from emp;</span><br><span class="line">insert into t2 select * from t2;</span><br></pre></td></tr></table></figure></p>
<p>查看extent情况:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      4        168	    8</span><br></pre></td></tr></table></figure></p>
<p>分配出来的extent最少8个块。<br>多次插入数据查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      4        168	    8</span><br><span class="line">...</span><br><span class="line">T2											  15	      4      17184	    8</span><br><span class="line">T2											  16	      4      17280	  128</span><br><span class="line">...</span><br><span class="line">T2											  78	      4       7936	  128</span><br><span class="line">T2											  79	      4       8064	 1024</span><br><span class="line">T2											  80	      4       9088	 1024</span><br><span class="line">T2											  81	      4      10112	 1024</span><br><span class="line">T2											  82	      4      11136	 1024</span><br></pre></td></tr></table></figure></p>
<p>extent分配增长情况为（64k-1m-64m-…)。</p>
<h4 id="3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）："><a href="#3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）：" class="headerlink" title="3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）："></a>3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）：</h4><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> create table t3 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t3 MOVE STORAGE ( INITIAL 100k NEXT 40k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure></p>
<p>查看表参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name = &apos;T3&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">	106496	     40960</span><br></pre></td></tr></table></figure></p>
<p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T3&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p>
<p>向表空插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t3 select * from emp;</span><br></pre></td></tr></table></figure></p>
<p>一次分配出来两个extent，每个extent8个block：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T3&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T3											   0	      4        176	    8</span><br><span class="line">T3											   1	      4        184	    8</span><br></pre></td></tr></table></figure></p>
<p>再次插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t3 select * from t3;</span><br></pre></td></tr></table></figure></p>
<p>不要插入太多数据，查看下一次分配的extent为1个，占8个块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T3&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T3											   0	      4        208	    8</span><br><span class="line">T3											   1	      4        216	    8</span><br><span class="line">T3											   2	      4        224	    8</span><br></pre></td></tr></table></figure></p>
<p>再次插入数据，extent增长情况（64k-1m-64m）</p>
<h4 id="4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）："><a href="#4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）：" class="headerlink" title="4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）："></a>4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）：</h4><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> create table t4 as select * from emp where 0=1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t4 MOVE STORAGE ( INITIAL 100k NEXT 140k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure></p>
<p>查看表参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">14:31:43 SCOTT@ boston&gt; SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name = &apos;T4&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">	106496	    147456</span><br></pre></td></tr></table></figure></p>
<p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T4&apos;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure></p>
<p>向表空插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t4 select * from emp;</span><br></pre></td></tr></table></figure></p>
<p>一次分配出来两个extent，每个extent8个block：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T4&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T4											   0	      4        176	    8</span><br><span class="line">T4											   1	      4        184	    8</span><br></pre></td></tr></table></figure></p>
<p>再次插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t4 select * from t4;</span><br></pre></td></tr></table></figure></p>
<p>不要插入太多数据，查看下一次分配的extent为1个，占8个块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T4&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T4											   0	      4        176	    8</span><br><span class="line">T4											   1	      4        184	    8</span><br><span class="line">T4											   2	      4        192	    8</span><br></pre></td></tr></table></figure></p>
<p>再次插入数据，extent增长情况（64k-1m-64m）</p>
<h4 id="5、创建表空间使用并设置extent大小，统一为2m："><a href="#5、创建表空间使用并设置extent大小，统一为2m：" class="headerlink" title="5、创建表空间使用并设置extent大小，统一为2m："></a>5、创建表空间使用并设置extent大小，统一为2m：</h4><p>创建测试表空间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create tablespace test datafile &apos;/data/u01/app/oracle/oradata/boston/test01.dbf&apos; size 100M extent management local uniform size 2m;</span><br></pre></td></tr></table></figure></p>
<p>查看表空间参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15:28:39 SYS@ boston&gt; select TABLESPACE_NAME,BLOCK_SIZE,INITIAL_EXTENT,NEXT_EXTENT,MIN_EXTENTS,MAX_EXTENTS,EXTENT_MANAGEMENT,ALLOCATION_TYPE from user_tablespaces where tablespace_name=&apos;TEST&apos;;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME 	       BLOCK_SIZE INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS EXTENT_MAN ALLOCATIO</span><br><span class="line">------------------------------ ---------- -------------- ----------- ----------- ----------- ---------- ---------</span><br><span class="line">TEST				     8192	 2097152     2097152	       1  2147483645 LOCAL	UNIFORM</span><br></pre></td></tr></table></figure></p>
<h5 id="6、表空间使用上面创建的test表空间，表参数默认："><a href="#6、表空间使用上面创建的test表空间，表参数默认：" class="headerlink" title="6、表空间使用上面创建的test表空间，表参数默认："></a>6、表空间使用上面创建的test表空间，表参数默认：</h5><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t1;</span><br><span class="line">create table t1 as select * from emp where 0=1;</span><br><span class="line">alter table t1 move tablespace test;</span><br></pre></td></tr></table></figure></p>
<p>查看表t1参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent,next_extent,min_extents,max_extents,pct_increase,blocks,sample_size FROM user_tables WHERE  table_name = &apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">       2097152	   2097152	     1	2147483645	      0</span><br></pre></td></tr></table></figure></p>
<p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">15:32:51 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">no rows selected</span><br><span class="line">Elapsed: 00:00:00.04</span><br></pre></td></tr></table></figure></p>
<p>插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15:33:16 SCOTT@ boston&gt; insert into t1  select * from emp;</span><br><span class="line">14 rows created.</span><br></pre></td></tr></table></figure></p>
<p>为t1表分配了一个2m大小的extent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:32:54 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      5        128	  256</span><br></pre></td></tr></table></figure></p>
<p>批量插入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">15:48:07 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T1&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      5        128	  256</span><br><span class="line">...</span><br><span class="line">T1											  80	      5      20608	  256</span><br><span class="line">81 rows selected.</span><br></pre></td></tr></table></figure></p>
<p>不管插入多少数据，因为设置了统一大小为2m，一个extent永远都是256个块。</p>
<h5 id="7、表空间使用上面创建的test表空间，表参数自定义："><a href="#7、表空间使用上面创建的test表空间，表参数自定义：" class="headerlink" title="7、表空间使用上面创建的test表空间，表参数自定义："></a>7、表空间使用上面创建的test表空间，表参数自定义：</h5><p>创建测试表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t2;</span><br><span class="line">create table t2 as select * from emp where 0=1;</span><br><span class="line">ALTER TABLE t2 MOVE STORAGE ( INITIAL 5m NEXT 5m) TABLESPACE test;</span><br></pre></td></tr></table></figure></p>
<p>查看表t2参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent,next_extent,min_extents,max_extents,pct_increase,blocks,sample_size FROM user_tables WHERE  table_name = &apos;T2&apos;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">       5242880	   5242880</span><br></pre></td></tr></table></figure></p>
<p>表数据为空，查看是否有extent区在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">no rows selected</span><br><span class="line">Elapsed: 00:00:00.11</span><br></pre></td></tr></table></figure></p>
<p>插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from emp;</span><br></pre></td></tr></table></figure></p>
<p>因为初始化设置为5m，而每个extent大小统一为2m，因此分配出三个extent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      5       1920	  256</span><br><span class="line">T2											   1	      5       2176	  256</span><br><span class="line">T2											   2	      5       2432	  256</span><br></pre></td></tr></table></figure></p>
<p>再次插入数据，一次性不要插入太多：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from t2;</span><br><span class="line">...</span><br><span class="line">insert into t2 (select * from t2 where rownum &lt; 10000);</span><br></pre></td></tr></table></figure></p>
<p>当前三个extent用满之后再次分配extent时，分配1个extent，大小为2m。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER=&apos;SCOTT&apos; AND SEGMENT_NAME=&apos;T2&apos;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      5        640	  256</span><br><span class="line">T2											   1	      5        896	  256</span><br><span class="line">T2											   2	      5       1152	  256</span><br><span class="line">T2											   3	      5       1408	  256</span><br></pre></td></tr></table></figure></p>
<h4 id="8、测试总结"><a href="#8、测试总结" class="headerlink" title="8、测试总结"></a>8、测试总结</h4><p>在本地管理表空间的模式下，oracle分配extent，会根据initial指定的参数分配（按相应的倍数），但是next指定的值会被忽略。官方文档如下所示：<br><img src="https://i.imgur.com/ZsQ7zP1.png" alt=""><br><img src="https://i.imgur.com/hcElxSO.png" alt=""></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/07/oracle本地表空间在uniform、system等不同模式下分配extent方式/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/06/centos安装vsftp/"><span>[Linux] centos安装vsftp</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/06/centos安装vsftp/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-06T14:49:30.000Z">
          2018-11-06
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、检查vsftp是否安装，如果没有yum安装vsftp："><a href="#1、检查vsftp是否安装，如果没有yum安装vsftp：" class="headerlink" title="1、检查vsftp是否安装，如果没有yum安装vsftp："></a>1、检查vsftp是否安装，如果没有yum安装vsftp：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa| grep vsftpd</span><br><span class="line">yum install vsftpd -y</span><br></pre></td></tr></table></figure>
<h4 id="2、创建用户："><a href="#2、创建用户：" class="headerlink" title="2、创建用户："></a>2、创建用户：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adduser -s /sbin/nologin -d /var/ftp/ftp1 ftp1 </span><br><span class="line">修改用户名：</span><br><span class="line">passwd ftp1</span><br></pre></td></tr></table></figure>
<h4 id="3、修改配置文件："><a href="#3、修改配置文件：" class="headerlink" title="3、修改配置文件："></a>3、修改配置文件：</h4><p>cat /etc/vsftpd/vsftpd.conf |grep -v ‘^#’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#禁止匿名用户登录</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">#不允许chroot_list下的用户访问其他目录：</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">listen=NO</span><br><span class="line">listen_ipv6=YES</span><br><span class="line"></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">#只允许vsftpd.user_list文件下的用户登录：</span><br><span class="line">userlist_enable=YES</span><br><span class="line">userlist_deny=NO</span><br><span class="line">userlist_file=/etc/vsftpd/vsftpd.user_list</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure></p>
<h4 id="4、添加访问用户："><a href="#4、添加访问用户：" class="headerlink" title="4、添加访问用户："></a>4、添加访问用户：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/vsftpd/vsftpd.user_list</span><br><span class="line">ftp1</span><br><span class="line"></span><br><span class="line">cat /etc/vsftpd/chroot_list</span><br><span class="line">ftp1</span><br></pre></td></tr></table></figure>
<h4 id="5、启动，查看ftp服务状态"><a href="#5、启动，查看ftp服务状态" class="headerlink" title="5、启动，查看ftp服务状态"></a>5、启动，查看ftp服务状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd status</span><br><span class="line">service vsftpd start</span><br><span class="line">service vsftpd stop</span><br><span class="line">service vsftpd restart</span><br></pre></td></tr></table></figure>
<h4 id="6、客户端安装ftp："><a href="#6、客户端安装ftp：" class="headerlink" title="6、客户端安装ftp："></a>6、客户端安装ftp：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ftp</span><br></pre></td></tr></table></figure>
<p>连接到ftp-server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; ftp *.*.*.*</span><br></pre></td></tr></table></figure></p>
<h4 id="7、配置过程遇到的问题："><a href="#7、配置过程遇到的问题：" class="headerlink" title="7、配置过程遇到的问题："></a>7、配置过程遇到的问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">500 OOPS: vsftpd: refusing to run with writable root inside chroot ()</span><br><span class="line">查看配置文件该行参数是否配置：</span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">500 OOPS: chroot</span><br><span class="line">Login failed.</span><br><span class="line">421 Service not available, remote server has closed connection</span><br><span class="line">检查selinux是否为enforcing状态，并修改：</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ftp vsftpd 530 login incorrect</span><br><span class="line">解决方法：</span><br><span class="line">1.检查密码是否正常。</span><br><span class="line">2.检查/etc/vsftpd/vsftpd.conf配置：</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">userlist_deny=NO</span><br><span class="line">userlist_file=/etc/vsftpd/vsftpd.user_list</span><br><span class="line">3.检查/etc/pam.d/vsftpd配置：</span><br><span class="line">#%PAM-1.0</span><br><span class="line">session    optional     pam_keyinit.so    force revoke</span><br><span class="line">auth       required	pam_listfile.so item=user sense=deny file=/etc/vsftpd/ftpusers onerr=succeed</span><br><span class="line">auth       required	pam_shells.so</span><br><span class="line">auth       include	password-auth</span><br><span class="line">account    include	password-auth</span><br><span class="line">session    required     pam_loginuid.so</span><br><span class="line">session    include	password-auth</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/06/centos安装vsftp/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/06/mysql意外drop表之后，使用innobackupex恢复/"><span>[Mysql] mysql意外drop表之后，使用innobackupex恢复</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/06/mysql意外drop表之后，使用innobackupex恢复/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-06T14:28:00.000Z">
          2018-11-06
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、使用innodbackupex备份测试删除表："><a href="#1、使用innodbackupex备份测试删除表：" class="headerlink" title="1、使用innodbackupex备份测试删除表："></a>1、使用innodbackupex备份测试删除表：</h4><p>innobackupex备份某以一张表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./innobackupex --defaults-file=/etc/my.cnf --databases=&quot;aaaa.test_order&quot; --user=root --password=12345678 --port=3306 /tmp</span><br></pre></td></tr></table></figure></p>
<p>如果要备份多个表，使用以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./innobackupex --defaults-file=/etc/my.cnf --databases=&quot;aaaa.test_order aaaa.test1&quot; --user=root --password=12345678 --port=3306 /tmp</span><br></pre></td></tr></table></figure></p>
<p>使用innobackupex备份出来的的数据在aaaa文件下面会存在table_name.frm和table_name.ibd两个文件。</p>
<h4 id="2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该链接，对表结构进行恢复"><a href="#2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该链接，对表结构进行恢复" class="headerlink" title="2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该链接，对表结构进行恢复"></a>2、如果知道表结构重新建表即可，如果表结构也无法获得，可通过该<a href="https://zeven0707.github.io/2018/11/01/mysql%E4%BD%BF%E7%94%A8%E5%A4%87%E4%BB%BD%E7%9A%84.frm%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E8%A1%A8%E7%BB%93%E6%9E%84/" target="_blank" rel="noopener">链接</a>，对表结构进行恢复</h4><h4 id="3、恢复完表结构之后，开始恢复数据，丢弃表空间："><a href="#3、恢复完表结构之后，开始恢复数据，丢弃表空间：" class="headerlink" title="3、恢复完表结构之后，开始恢复数据，丢弃表空间："></a>3、恢复完表结构之后，开始恢复数据，丢弃表空间：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#为防止新的数据写入，对表加锁：</span><br><span class="line">root@db 16:20:  [aaaa]&gt; lock tables tb1 write;</span><br><span class="line"></span><br><span class="line">root@db 16:20:  [aaaa]&gt; alter table test_order discard tablespace; </span><br><span class="line">Query OK, 0 rows affected (0.54 sec)</span><br></pre></td></tr></table></figure>
<p>将对应的ibd文件拷入对应的数据目录,修改数据文件权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; cp test_order.ibd /data/mysql/data/aaaa/</span><br><span class="line">shell &gt; chown mysql.mysql test_order.ibd</span><br></pre></td></tr></table></figure></p>
<p>载入表空间：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:24:  [aaaa]&gt; alter table test_order import tablespace;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (1 min 53.51 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看有无报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show warnings;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、对备份之后的数据进行恢复，查看备份开始的时间点"><a href="#4、对备份之后的数据进行恢复，查看备份开始的时间点" class="headerlink" title="4、对备份之后的数据进行恢复，查看备份开始的时间点"></a>4、对备份之后的数据进行恢复，查看备份开始的时间点</h4><p>cat xtrabackup_binlog_info<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql-binlog.000489	748512183</span><br></pre></td></tr></table></figure></p>
<p>然后查找drop的pos点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog  -v --base64-output=DECODE-ROWS /data/mysql/log/mysql-binlog.000489 | grep -C 10 -i  &quot;DROP&quot;</span><br></pre></td></tr></table></figure></p>
<p>找到删除的pos点，如果不在该log文件下，需要根据（show master status)的位置向前依次筛选,找到drop表的记录，内容如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server id 1  end_log_pos 748512209 CRC32 0x3fa6b448   Query   thread_id=27    </span><br><span class="line">DROP TABLE `test_order` /* generated by server */</span><br><span class="line">/*!*/;</span><br></pre></td></tr></table></figure></p>
<p>找到表删除的pos点（748512209），利用binlog2sql生成中间发生sql语句，（binlog2sql方法详解<a href="https://github.com/danfengcao/binlog2sql">此处</a>）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python binlog2sql.py  -uroot -p12345678 -daaaa -ttest_order --start-position=748512183 --stop-position=748512209 --start-file=&apos;mysql-binlog.000489&apos;  &gt; /tmp/re_aaaa_test_order.sql</span><br></pre></td></tr></table></figure></p>
<p>生成的sql内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@dax-mysql-master binlog2sql]# cat /tmp/re_aaaa_test_order.sql</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (12); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (11); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (10); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (9); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (8); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (7); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (6); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (5); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (4); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (2); #start 2804 end 2949 time 2018-11-06 18:45:45</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=12 LIMIT 1; #start 2571 end 2716 time 2018-11-06 18:45:39</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=11 LIMIT 1; #start 2338 end 2483 time 2018-11-06 18:45:33</span><br></pre></td></tr></table></figure></p>
<p>生成的sql顺序是倒序的，需要重新调整（github上关于binlog2sql的用法未有关于顺序的说明）：<br>sed -i ‘1!G;h;$!d’ /tmp/re_aaaa_test_order.sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master binlog2sql]#  sed -i &apos;1!G;h;$!d&apos; /tmp/re_aaaa_test_order.sql</span><br><span class="line">[root@dax-mysql-master binlog2sql]# cat /tmp/re_aaaa_test_order.sql</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=11 LIMIT 1; #start 2338 end 2483 time 2018-11-06 18:45:33</span><br><span class="line">DELETE FROM `aaaa`.`test_order` WHERE `id`=12 LIMIT 1; #start 2571 end 2716 time 2018-11-06 18:45:39</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (2); #start 2804 end 2949 time 2018-11-06 18:45:45</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (4); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (5); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (6); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (7); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (8); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (9); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (10); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (11); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br><span class="line">INSERT INTO `aaaa`.`test_order`(`id`) VALUES (12); #start 3037 end 3222 time 2018-11-06 18:54:21</span><br></pre></td></tr></table></figure></p>
<h4 id="5、把这sql文件进入导入即可进行备份后的数据恢复"><a href="#5、把这sql文件进入导入即可进行备份后的数据恢复" class="headerlink" title="5、把这sql文件进入导入即可进行备份后的数据恢复"></a>5、把这sql文件进入导入即可进行备份后的数据恢复</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master binlog2sql]# mysql -u root -p12345678 aaaa &lt; /tmp/re_aaaa_test_order.sql</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1205 (HY000) at line 1: Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>需要先解锁表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure></p>
<p>解锁完成在重新导入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@dax-mysql-master binlog2sql]# mysql -u root -p12345678 aaaa &lt; /tmp/re_aaaa_test_order.sql</span><br></pre></td></tr></table></figure></p>
<p>导入成功。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/06/mysql意外drop表之后，使用innobackupex恢复/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/01/mysql-Can't start group replication on secondary member with single primary-mode while asynchronous replication channels are running/"><span>[Mysql] Can&#39;t start group replication on secondary member with single primary-mode while asynchronous replication channels are running</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/01/mysql-Can't start group replication on secondary member with single primary-mode while asynchronous replication channels are running/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-01T10:28:00.000Z">
          2018-11-01
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、mysql-mgr双节点集群，节点信息如下："><a href="#0、mysql-mgr双节点集群，节点信息如下：" class="headerlink" title="0、mysql-mgr双节点集群，节点信息如下："></a>0、mysql-mgr双节点集群，节点信息如下：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">dax-mysql-master为主节点：</span><br><span class="line"> SHOW STATUS LIKE &apos;group_replication_primary_member&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="1、因某种需要需要重启数据库，先后停止从节点group-replication"><a href="#1、因某种需要需要重启数据库，先后停止从节点group-replication" class="headerlink" title="1、因某种需要需要重启数据库，先后停止从节点group_replication;"></a>1、因某种需要需要重启数据库，先后停止从节点group_replication;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">停止数据库：</span><br><span class="line">/etc/init.d/mysql stop</span><br></pre></td></tr></table></figure>
<p>停止主节点group_replication;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stop group_replication;</span><br><span class="line">重启数据库</span><br><span class="line">/etc/init.d/mysql restart</span><br><span class="line">启动组复制：</span><br><span class="line">start group_replication;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</span><br></pre></td></tr></table></figure>
<p>error.log日志报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T06:57:09.766303Z 6 [Note] Plugin group_replication reported: &apos;Group communication SSL configuration: group_replication_ssl_mode: &quot;DISABLED&quot;&apos;</span><br><span class="line">2018-11-01T06:57:09.768075Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 127.0.0.1/8,192.168.168.178/24 to the whitelist&apos;</span><br><span class="line">2018-11-01T06:57:09.769536Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Translated &apos;dax-mysql-master&apos; to 192.168.168.178&apos;</span><br><span class="line">2018-11-01T06:57:09.770000Z 6 [Warning] Plugin group_replication reported: &apos;[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.&apos;</span><br><span class="line">2018-11-01T06:57:09.770200Z 6 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</span><br><span class="line">2018-11-01T06:57:09.770253Z 6 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;740442c0-cc67-11e8-993e-525400578639&quot;; group_replication_local_address: &quot;dax-mysql-master:24901&quot;; group_replication_group_seeds: &quot;dax-mysql-master:24901,dax-mysql-slave:24901&quot;; group_replication_bootstrap_group: false; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</span><br><span class="line">2018-11-01T06:57:09.770341Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Configured number of attempts to join: 0&apos;</span><br><span class="line">2018-11-01T06:57:09.770356Z 6 [Note] Plugin group_replication reported: &apos;[GCS] Configured time between attempts to join: 5 seconds&apos;</span><br><span class="line">2018-11-01T06:57:09.770494Z 6 [Note] Plugin group_replication reported: &apos;Member configuration: member_id: 3306103; member_uuid: &quot;d5bd8edd-9a1d-11e8-993e-525400578639&quot;; single-primary mode: &quot;true&quot;; group_replication_auto_increment_increment: 7; &apos;</span><br><span class="line">2018-11-01T06:57:09.770589Z 6 [ERROR] Plugin group_replication reported: &apos;Can&apos;t start group replication on secondary member with single primary-mode while asynchronous replication channels are running.&apos;</span><br><span class="line">2018-11-01T06:57:09.770682Z 6 [Note] Plugin group_replication reported: &apos;Requesting to leave the group despite of not being a member&apos;</span><br><span class="line">2018-11-01T06:57:09.770696Z 6 [ERROR] Plugin group_replication reported: &apos;[GCS] The member is leaving a group without being on one.&apos;</span><br></pre></td></tr></table></figure></p>
<p>尝试重启dax-mysql-slave节点组复制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> start group_replication;</span><br><span class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</span><br></pre></td></tr></table></figure></p>
<p>error.log日志报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T06:59:20.617005Z 114 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 128090715, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</span><br><span class="line">2018-11-01T06:59:21.516164Z 111 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</span><br><span class="line">2018-11-01T06:59:21.516264Z 117 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./relay-log-group_replication_applier.000002&apos; position: 4</span><br><span class="line">2018-11-01T06:59:21.516277Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 7&apos;</span><br><span class="line">2018-11-01T06:59:21.516298Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 3306102&apos;</span><br><span class="line">2018-11-01T06:59:21.553616Z 0 [Note] Plugin group_replication reported: &apos;XCom protocol version: 3&apos;</span><br><span class="line">2018-11-01T06:59:21.553718Z 0 [Note] Plugin group_replication reported: &apos;XCom initialized and ready to accept incoming connections on port 24901&apos;</span><br><span class="line">2018-11-01T06:59:21.620998Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.621468Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.621794Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.621988Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622185Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622379Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622658Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.622875Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.623043Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.623201Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error on opening a connection to dax-mysql-master:24901 on local port: 24901.&apos;</span><br><span class="line">2018-11-01T06:59:21.623220Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error connecting to all peers. Member join failed. Local port: 24901&apos;</span><br><span class="line">2018-11-01T06:59:21.624544Z 0 [Warning] Plugin group_replication reported: &apos;read failed&apos;</span><br><span class="line">2018-11-01T06:59:21.656139Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] The member was unable to join the group. Local port: 24901&apos;</span><br><span class="line">2018-11-01T07:00:21.516998Z 111 [ERROR] Plugin group_replication reported: &apos;Timeout on wait for view after joining group&apos;</span><br><span class="line">2018-11-01T07:00:21.517630Z 111 [Note] Plugin group_replication reported: &apos;Requesting to leave the group despite of not being a member&apos;</span><br><span class="line">2018-11-01T07:00:21.517820Z 111 [ERROR] Plugin group_replication reported: &apos;[GCS] The member is leaving a group without being on one.&apos;</span><br><span class="line">2018-11-01T07:00:21.519413Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_increment is reset to 1&apos;</span><br><span class="line">2018-11-01T07:00:21.519442Z 111 [Note] Plugin group_replication reported: &apos;auto_increment_offset is reset to 1&apos;</span><br><span class="line">2018-11-01T07:00:21.521022Z 117 [Note] Error reading relay log event for channel &apos;group_replication_applier&apos;: slave SQL thread was killed</span><br><span class="line">2018-11-01T07:00:21.595775Z 114 [Note] Plugin group_replication reported: &apos;The group replication applier thread was killed&apos;</span><br><span class="line">2018-11-01T07:10:22.699429Z 111 [Note] Aborted connection 111 to db: &apos;unconnected&apos; user: &apos;root&apos; host: &apos;localhost&apos; (Got timeout reading communication packets)</span><br></pre></td></tr></table></figure></p>
<p>使用mysql-shell查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/mysql-shell/bin/mysqlsh --uri repl@dax-mysql-master:3306</span><br></pre></td></tr></table></figure></p>
<p>尝试查看集群信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">Dba.getCluster: This function is not available through a session to a standalone instance (metadata exists, but GR is not active) (RuntimeError)</span><br></pre></td></tr></table></figure></p>
<p>提示集群系统没有激活，尝试重启集群系统：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">dba.rebootClusterFromCompleteOutage(&apos;prodCluster&apos;)</span><br><span class="line">Reconfiguring the cluster &apos;prodCluster&apos; from complete outage...</span><br><span class="line">The instance &apos;dax-mysql-slave:3306&apos; was part of the cluster configuration.</span><br><span class="line">Would you like to rejoin it to the cluster? [y/N]: y</span><br><span class="line">WARNING: On instance &apos;dax-mysql-master:3306&apos; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;= 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The cluster was successfully rebooted.</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster = dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql://repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>集群状态恢复正常。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/01/mysql-Can't start group replication on secondary member with single primary-mode while asynchronous replication channels are running/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/01/mysql使用备份的.frm文件恢复表结构/"><span>[Mysql] mysql使用备份的.frm文件恢复表结构</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/01/mysql使用备份的.frm文件恢复表结构/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-01T06:04:00.000Z">
          2018-11-01
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、例如备份的表为test-order-则备份出来的-frm文件为test-order-frm"><a href="#0、例如备份的表为test-order-则备份出来的-frm文件为test-order-frm" class="headerlink" title="0、例如备份的表为test_order,则备份出来的.frm文件为test_order.frm"></a>0、例如备份的表为test_order,则备份出来的.frm文件为test_order.frm</h4><h4 id="1、在只知道表名的情况下，随意创建一个表名为test-order的表："><a href="#1、在只知道表名的情况下，随意创建一个表名为test-order的表：" class="headerlink" title="1、在只知道表名的情况下，随意创建一个表名为test_order的表："></a>1、在只知道表名的情况下，随意创建一个表名为test_order的表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table test_order (id1 int(2));</span><br></pre></td></tr></table></figure>
<p>替换test_order.frm文件，替换完成之后重启mysql数据库,查看表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:29:  [test]&gt; desc test_order;</span><br><span class="line">ERROR 1146 (42S02): Table &apos;test.test_order&apos; doesn&apos;t exist</span><br><span class="line">root@db 11:29:  [test]&gt; show create table test_order;</span><br><span class="line">ERROR 1146 (42S02): Table &apos;test.test_order&apos; doesn&apos;t exist</span><br></pre></td></tr></table></figure></p>
<p>报错提示表不存在，之后查看error.log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T11:29:10.359514Z 2 [Warning] InnoDB: Table test/test_order contains 1 user defined columns in InnoDB, but 25 columns in MySQL. Please check INFORMATION_SCHEMA.INNODB_SYS_COLUMNS and http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-11-01T11:29:10.359631Z 2 [Warning] InnoDB: Cannot open table test/test_order from the internal data dictionary of InnoDB though the .frm file for the table exists. Please refer to http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br><span class="line">2018-11-01T11:29:25.514189Z 2 [Note] InnoDB: Table `test`.`test_order` is corrupted. Please drop the table and recreate it</span><br><span class="line">2018-11-01T11:29:25.514313Z 2 [Warning] InnoDB: Cannot open table test/test_order from the internal data dictionary of InnoDB though the .frm file for the table exists. Please refer to http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br></pre></td></tr></table></figure></p>
<p>报错提示手动创建的表只有1列，但是mysql中记录的表有25列</p>
<h4 id="2、删除test-order表，并创建一个25列的test-order表："><a href="#2、删除test-order表，并创建一个25列的test-order表：" class="headerlink" title="2、删除test_order表，并创建一个25列的test_order表："></a>2、删除test_order表，并创建一个25列的test_order表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:40:  [test]&gt; drop table test_order;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">root@db 11:40:  [test]&gt; create table test_order (id1 int(2),id2 int(2),id3 int(2),id4 int(2),id5 int(2),id6 int(2),id7 int(2),id8 int(2),id9 int(2),id10 int(2),id11 int(2),id12 int(2),id13 int(2),id14 int(2),id15 int(2),id16 int(2),id17 int(2),id18 int(2),id19 int(2),id20 int(2),id21 int(2),id22 int(2),id23 int(2),id24 int(2),id25  int(2));</span><br></pre></td></tr></table></figure>
<p>替换test_order.frm文件，替换完成之后重启mysql数据库,查看表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:41:  [test]&gt; desc test_order;</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">root@db 11:42:  [test]&gt; show create table test_order;</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    2</span><br><span class="line">Current database: test</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br></pre></td></tr></table></figure></p>
<p>查看error.log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T11:42:25.566095Z 2 [ERROR] Build InnoDB index translation table for Table ./test/test_order failed</span><br><span class="line">2018-11-01T11:42:25.566445Z 2 [ERROR] Table ./test/test_order has no primary key in InnoDB data dictionary, but has one in MySQL! If you created the table with a MySQL version &lt; 3.23.54 and did not define a primary key, but defined a unique key with all non-NULL columns, then MySQL internally treats that key as the primary key. You can fix this error by dump + DROP + CREATE + reimport of the table.</span><br><span class="line">2018-11-01T11:42:25.566519Z 2 [Warning] Table ./test/test_order key_used_on_scan is 0 even though there is no primary key inside InnoDB.</span><br><span class="line">2018-11-01T11:42:25.566576Z 2 [ERROR] InnoDB could not find key no 0 with name PRIMARY from dict cache for table test/test_order</span><br><span class="line">11:42:25 UTC - mysqld got signal 11 ;</span><br><span class="line">This could be because you hit a bug. It is also possible that this binary</span><br><span class="line">or one of the libraries it was linked against is corrupt, improperly built,</span><br><span class="line">or misconfigured. This error can also be caused by malfunctioning hardware.</span><br><span class="line">Attempting to collect some information that could help diagnose the problem.</span><br><span class="line">As this is a crash and something is definitely wrong, the information</span><br><span class="line">collection process might fail.</span><br></pre></td></tr></table></figure></p>
<p>报错提示test_order表没有主键</p>
<h4 id="3、删除test-order表，并创建一个25列的带有主键的test-order表："><a href="#3、删除test-order表，并创建一个25列的带有主键的test-order表：" class="headerlink" title="3、删除test_order表，并创建一个25列的带有主键的test_order表："></a>3、删除test_order表，并创建一个25列的带有主键的test_order表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:45:  [test]&gt; drop table test_order;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">root@db 11:45:  [test]&gt; create table test_order (id1 int(2) primary key,id2 int(2),id3 int(2),id4 int(2),id5 int(2),id6 int(2),id7 int(2),id8 int(2),id9 int(2),id10 int(2),id11 int(2),id12 int(2),id13 int(2),id14 int(2),id15 int(2),id16 int(2),id17 int(2),id18 int(2),id19 int(2),id20 int(2),id21 int(2),id22 int(2),id23 int(2),id24 int(2),id25  int(2));</span><br></pre></td></tr></table></figure>
<p>替换test_order.frm文件，替换完成之后重启mysql数据库,查看表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">root@db 11:46:  [test]&gt; desc test_order;</span><br><span class="line">+-----------------+----------------+------+-----+---------+----------------+</span><br><span class="line">| Field           | Type           | Null | Key | Default | Extra          |</span><br><span class="line">+-----------------+----------------+------+-----+---------+----------------+</span><br><span class="line">| id              | bigint(20)     | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| order_no        | varchar(24)    | NO   | UNI | NULL    |                |</span><br><span class="line">| broker_id       | varchar(24)    | NO   | MUL | NULL    |                |</span><br><span class="line">| broker_uid      | bigint(20)     | NO   |     | NULL    |                |</span><br><span class="line">| plat_id         | varchar(24)    | NO   |     | NULL    |                |</span><br><span class="line">| price_asset     | varchar(8)     | NO   |     | NULL    |                |</span><br><span class="line">| test_type      | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| order_type      | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| price           | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| number          | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| test_asset     | varchar(8)     | NO   | MUL | NULL    |                |</span><br><span class="line">| testd_number   | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| over_number     | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| testd_money    | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| fee_asset       | varchar(8)     | NO   |     | NULL    |                |</span><br><span class="line">| fee             | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| broker_fee      | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| cloud_fee       | decimal(32,20) | NO   |     | NULL    |                |</span><br><span class="line">| client_order_no | varchar(36)    | NO   |     | NULL    |                |</span><br><span class="line">| state           | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| send_state      | varchar(16)    | NO   |     | NULL    |                |</span><br><span class="line">| error_code      | varchar(24)    | YES  |     | NULL    |                |</span><br><span class="line">| error_msg       | varchar(64)    | YES  |     | NULL    |                |</span><br><span class="line">| create_time     | datetime       | NO   |     | NULL    |                |</span><br><span class="line">| update_time     | datetime       | NO   |     | NULL    |                |</span><br><span class="line">+-----------------+----------------+------+-----+---------+----------------+</span><br><span class="line">25 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 11:46:  [test]&gt; show create table test_order\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: test_order</span><br><span class="line">Create Table: CREATE TABLE `test_order` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `order_no` varchar(24) NOT NULL,</span><br><span class="line">  `broker_id` varchar(24) NOT NULL,</span><br><span class="line">  `broker_uid` bigint(20) NOT NULL,</span><br><span class="line">  `plat_id` varchar(24) NOT NULL,</span><br><span class="line">  `price_asset` varchar(8) NOT NULL,</span><br><span class="line">  `test_type` varchar(16) NOT NULL,</span><br><span class="line">  `order_type` varchar(16) NOT NULL,</span><br><span class="line">  `price` decimal(32,20) NOT NULL,</span><br><span class="line">  `number` decimal(32,20) NOT NULL,</span><br><span class="line">  `test_asset` varchar(8) NOT NULL,</span><br><span class="line">  `testd_number` decimal(32,20) NOT NULL,</span><br><span class="line">  `over_number` decimal(32,20) NOT NULL,</span><br><span class="line">  `testd_money` decimal(32,20) NOT NULL,</span><br><span class="line">  `fee_asset` varchar(8) NOT NULL,</span><br><span class="line">  `fee` decimal(32,20) NOT NULL,</span><br><span class="line">  `broker_fee` decimal(32,20) NOT NULL,</span><br><span class="line">  `cloud_fee` decimal(32,20) NOT NULL,</span><br><span class="line">  `client_order_no` varchar(36) NOT NULL,</span><br><span class="line">  `state` varchar(16) NOT NULL,</span><br><span class="line">  `send_state` varchar(16) NOT NULL,</span><br><span class="line">  `error_code` varchar(24) DEFAULT NULL,</span><br><span class="line">  `error_msg` varchar(64) DEFAULT NULL,</span><br><span class="line">  `create_time` datetime NOT NULL,</span><br><span class="line">  `update_time` datetime NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `test_order_order_no_uindex` (`order_no`),</span><br><span class="line">  UNIQUE KEY `test_order_broker_id_client_order_no_uindex` (`broker_id`,`client_order_no`),</span><br><span class="line">  KEY `multi_price_test_id_uid_state_index` (`test_asset`,`price_asset`,`broker_uid`,`broker_id`,`state`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看error.log有无其他报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-11-01T11:45:09.272752Z 2 [ERROR] Build InnoDB index translation table for Table ./test/test_order failed</span><br><span class="line">2018-11-01T11:45:09.272904Z 2 [ERROR] InnoDB: MySQL and InnoDB data dictionaries are out of sync. Unable to find the AUTOINC column id in the InnoDB table `test`.`test_order`. We set the next AUTOINC column value to 0, in effect disabling the AUTOINC next value generation.</span><br><span class="line">2018-11-01T11:45:09.272935Z 2 [Note] InnoDB: You can either set the next AUTOINC value explicitly using ALTER TABLE or fix the data dictionary by recreating the table.</span><br><span class="line">2018-11-01T11:45:09.272959Z 2 [ERROR] InnoDB: Table test/test_order contains 1 indexes inside InnoDB, which is different from the number of indexes 4 defined in MySQL</span><br><span class="line">2018-11-01T11:45:09.272976Z 2 [ERROR] InnoDB could not find key no 1 with name test_order_order_no_uindex from dict cache for table test/test_order</span><br><span class="line">2018-11-01T11:45:09.272988Z 2 [ERROR] Table test/test_order contains fewer indexes inside InnoDB than are defined in the MySQL .frm file. Have you mixed up .frm files from different installations? Please refer to http://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html for how to resolve the issue.</span><br></pre></td></tr></table></figure></p>
<p>log日志依旧有报错，提示innodb只有一个索引，但mysql下存在4个索引，但是已经通过show create table test_order获取到了建表的语句，因此可以通过上面的建表语句，重新创建test_order表了。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/01/mysql使用备份的.frm文件恢复表结构/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/31/nginx https证书配置/"><span>[Linux] 使用certbot为域名生成免费证书(nginx版)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/31/nginx https证书配置/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-31T09:18:30.000Z">
          2018-10-31
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、下载letencrypt-用于生产免费证书工具："><a href="#1、下载letencrypt-用于生产免费证书工具：" class="headerlink" title="1、下载letencrypt,用于生产免费证书工具："></a>1、下载letencrypt,用于生产免费证书工具：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft</span><br><span class="line">wget https://dl.eff.org/certbot-auto</span><br><span class="line">chmod a+x certbot-auto</span><br></pre></td></tr></table></figure>
<h4 id="2、修改域名对应的配置文件，添加下面内容"><a href="#2、修改域名对应的配置文件，添加下面内容" class="headerlink" title="2、修改域名对应的配置文件，添加下面内容"></a>2、修改域名对应的配置文件，添加下面内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  test.com;</span><br><span class="line">    ...</span><br><span class="line">    location ~ /.well-known &#123;</span><br><span class="line">        root /data/soft;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面配置的 root /data/soft<br>信息目录最好不要与其他location指定的目录相同,且确保各个目录存在目录,如果目录相同的情况下可能会遇到以下问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[quote]Failed authorization procedure. test.com (http-01): urn:ietf:params:acme:error:unauthorized :: The client lacks sufficient authorization :: Invalid response from http://mydomain.fr/.well-known/acme-challenge/Xefe-sxGfexdcdezDEUJZRfexjfeeloekcdsesx [2001:1600:4:1::b]: 404</span><br><span class="line">IMPORTANT NOTES:</span><br><span class="line">The following errors were reported by the server:</span><br><span class="line">Domain: test.com</span><br><span class="line">Type: unauthorized</span><br><span class="line">Detail: Invalid response from</span><br><span class="line">http://mydomain.fr/.well-known/acme-challenge/Xefe-sxGfexdcdezDEUJZRfexjfeeloekcdsesx</span><br><span class="line">[2001:1600:4:1::b]: 404</span><br><span class="line">To fix these errors, please make sure that your domain name was</span><br><span class="line">entered correctly and the DNS A/AAAA record(s) for that domain</span><br><span class="line">contain(s) the right IP address.[/quote]</span><br></pre></td></tr></table></figure></p>
<p>如果服务器的80端口被限制，会提示如下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://demo.broker.masterdax.com/.well-known/acme-challenge/pIV-Rh1355xsh8xJFHhB0llri6HS8S2yOSYRE9N5D5I:</span><br><span class="line">   Timeout during connect (likely firewall problem)</span><br></pre></td></tr></table></figure></p>
<h4 id="3、执行生成证书命令："><a href="#3、执行生成证书命令：" class="headerlink" title="3、执行生成证书命令："></a>3、执行生成证书命令：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/certbot-auto certonly --email 123456@qq.com --agree-tos --webroot -w /data/soft/ -d test.com --dry-run</span><br></pre></td></tr></table></figure>
<p>第一次尝试生成证书最好加上–dry-run参数，如果le生成证书次数（包括报错的次数）每天有上限，添加–dry-run调试没有问题之后再真正生成证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/certbot-auto certonly --email 123456@qq.com --agree-tos --webroot -w /data/soft/ -d test.com</span><br></pre></td></tr></table></figure></p>
<h4 id="4、查看生成的证书"><a href="#4、查看生成的证书" class="headerlink" title="4、查看生成的证书"></a>4、查看生成的证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/certbot-auto certificates</span><br></pre></td></tr></table></figure>
<h4 id="5、修改nginx配置文件，添加https相关配置信息-http相关配置加上跳转到https："><a href="#5、修改nginx配置文件，添加https相关配置信息-http相关配置加上跳转到https：" class="headerlink" title="5、修改nginx配置文件，添加https相关配置信息,http相关配置加上跳转到https："></a>5、修改nginx配置文件，添加https相关配置信息,http相关配置加上跳转到https：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  test.com;</span><br><span class="line">    rewrite ^(.*)$  https://$server_name$1 permanent;</span><br><span class="line">    ...</span><br><span class="line">    location ~ /.well-known &#123;</span><br><span class="line">        root /data/soft;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl; </span><br><span class="line">    server_name test.com;</span><br><span class="line">    ....</span><br><span class="line">    ssl_certificate ssl/fullchain.pem;</span><br><span class="line">    ssl_certificate_key ssl/privkey.pem;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、将生成的证书添加软连接到nginx配置文件指定的路径："><a href="#6、将生成的证书添加软连接到nginx配置文件指定的路径：" class="headerlink" title="6、将生成的证书添加软连接到nginx配置文件指定的路径："></a>6、将生成的证书添加软连接到nginx配置文件指定的路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/letsencrypt/live/test.com/fullchain.pem /usr/local/openresty/nginx/conf/ssl/fullchain.pem</span><br><span class="line">ln -s /etc/letsencrypt/live/test.com/privkey.pem /usr/local/openresty/nginx/conf/ssl/privkey.pem</span><br></pre></td></tr></table></figure>
<h4 id="7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新："><a href="#7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新：" class="headerlink" title="7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新："></a>7、因为le生成的证书有效期为90天，需要添加定时任务，使其证书自动更新：</h4><p>cat /data/soft/cron-cerbot.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">/data/soft/certbot-auto renew</span><br></pre></td></tr></table></figure></p>
<p>授权文件执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /data/soft/cron-cerbot.sh</span><br></pre></td></tr></table></figure></p>
<p>添加到crontab,每周日凌晨定期更新<br>crontab -l<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * 0 /data/soft/cron-cerbot.sh</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/31/nginx https证书配置/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/31/oracle 静默安装/"><span>[Oracle] oracle 静默安装</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/31/oracle 静默安装/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-31T07:19:00.000Z">
          2018-10-31
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、安装数据库所需依赖包"><a href="#1、安装数据库所需依赖包" class="headerlink" title="1、安装数据库所需依赖包"></a>1、安装数据库所需依赖包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc*</span><br><span class="line">yum install -y glibc*</span><br><span class="line">yum install -y compat-libstdc++-33 elfutils-libelf-devel libaio-devel compat-libcap1</span><br><span class="line">yum install -y sysstat</span><br><span class="line">yum install -y smartmontools</span><br></pre></td></tr></table></figure>
<h4 id="2、创建用户-并修改用户名密码"><a href="#2、创建用户-并修改用户名密码" class="headerlink" title="2、创建用户,并修改用户名密码"></a>2、创建用户,并修改用户名密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/groupadd -g 505 oinstall</span><br><span class="line">/usr/sbin/groupadd -g 502 dba</span><br><span class="line">/usr/sbin/groupadd -g 503 oper</span><br><span class="line">/usr/sbin/useradd -u 506 -g oinstall -G dba,oper oracle</span><br></pre></td></tr></table></figure>
<p>配置用户名密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd oracle</span><br></pre></td></tr></table></figure></p>
<h4 id="3、配置相关数据库目录权限"><a href="#3、配置相关数据库目录权限" class="headerlink" title="3、配置相关数据库目录权限"></a>3、配置相关数据库目录权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/u01/app/oracle</span><br><span class="line">chown oracle.oinstall -R /data/u01/app/oracle</span><br><span class="line">chmod 775 /data/u01/app/oracle</span><br><span class="line">mkdir -p /data/u01/app/oracle/product/11.2.0.4/dbhome_1/</span><br><span class="line">chown oracle.oinstall -R /data/u01/app/oracle/product/11.2.0.4/dbhome_1/</span><br><span class="line">chmod 775 /data/u01/app/oracle/product/11.2.0.4/dbhome_1/</span><br><span class="line">chown oracle.oinstall -R /data/u01</span><br></pre></td></tr></table></figure>
<h4 id="4、修改系统参数："><a href="#4、修改系统参数：" class="headerlink" title="4、修改系统参数："></a>4、修改系统参数：</h4><p>4.1、关闭selinux<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure></p>
<p>4.2、关闭防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure></p>
<p>4.3、设置用户连接限制<br>cat /etc/security/limits.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">oracle soft nproc 16384</span><br><span class="line">oracle hard nproc 16384</span><br><span class="line">oracle soft nofile 65536</span><br><span class="line">oracle hard nofile 65536</span><br><span class="line">oracle soft memlock 8088608</span><br><span class="line">oracle hard memlock 8088608</span><br><span class="line">oracle hard stack 10240</span><br><span class="line">grid soft nproc 16384</span><br><span class="line">grid hard nproc 16384</span><br><span class="line">grid soft nofile 65536</span><br><span class="line">grid hard nofile 65536</span><br><span class="line">grid soft memlock 8088608</span><br><span class="line">grid hard memlock 8088608</span><br><span class="line">grid hard stack 10240</span><br></pre></td></tr></table></figure></p>
<p>oracle用户最大能开启的进程数不超过16384，最大能打开的文件数不超过65536。至于soft和hard的区别，不同于磁盘配额中的软限制和硬限制。普通用户可以调整自己的softlimit但最高不能超过hardlimit，而且除了root以外的普通用户也不能够随意更改hard limit。该调整完成之后一般可以使用ulimit命令查看。<br>针对nofile，这个只是基于用户层面的限制和调整方法。基于系统层面的限制和调整方法是修改/etc/sysctl.conf文件，直接改fs.file-max参数，调整之后sysctl –p生效<br>memlock参数随着服务器内存不同，进行调整，该参数要偏小于实际的物理内存，本文以（8g内存为例）</p>
<p>4.4、为使/etc/security/limits.conf文件配置生效，需要确保pam模块pam_limits.so被加入到启动文件中：<br>grep ‘pam_limits.so’ /etc/pam.d/login<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session    required     pam_limits.so</span><br></pre></td></tr></table></figure></p>
<p>pam_limits.so模块对用户使用系统资源的情况进行限制,也可以使用在对一般应用程序使用的资源限制方面。举例来说，如果需要在SSH服务器上对来自不同用户的ssh访问进行限制，就可以调用该模块来实现相关功能。例如，当需要限制用户admin登录到SSH服务器时的最大连接数（防止同一个用户开启过多的登录进程），就可以在/etc/pam.d/sshd 文件中增加一行对 pam_limits.so 模块的调用:<br>然后在/etc/security/limits.conf文件中增加一行对admin用户产生的连接数进行限定:<br>admin      hard        maxlogins       2<br>完成之后重启服务器端的sshd服务。<br>之后我们可以看到，从客户端以admin身份登录SSH服务器时，在客户端上可以打开两个控制台登录。但当客户端开启第三个登录窗口的时候会被服务器拒绝，但其它用户不会受到限制。</p>
<p>4.5、设置用户最大进程数和进程可以打开的最大文件描述符的数量：<br>cat /etc/profile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if [ $USER = &quot;oracle&quot; -o $USER = &quot;grid&quot; ]; then</span><br><span class="line">  if [ $SHELL = &quot;/bin/ksh&quot; ]; then</span><br><span class="line">    ulimit -p 16384</span><br><span class="line">    ulimit -n 65536</span><br><span class="line">  else</span><br><span class="line">    ulimit -u 16384 -n 65536</span><br><span class="line">  fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>4.6、设置内核参数<br>cat /etc/sysctl.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kernel.shmmax = 7730941132</span><br><span class="line">kernel.shmall = 15586574</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.sem = 250 32000 100 128</span><br><span class="line">fs.file-max = 6815744</span><br><span class="line">fs.aio-max-nr = 1048576</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500</span><br><span class="line">net.core.rmem_default = 1048576</span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line">net.core.wmem_max = 1048576</span><br><span class="line">vm.min_free_kbytes = 524288</span><br><span class="line">vm.swappiness = 60</span><br></pre></td></tr></table></figure></p>
<p>使配置生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>安装过程中shmmax,shmall参数设置过小，导致dbca创建数据库的时候报错ORA-12547：TNS：lost contact<br>图形化安装，oracle有一个runfix脚本，调整这些参数，参考response下的文件，如果文件里面的参数小于参考文件的参数，会进行调整，如果文件参数大于参考文件参数，则不会进行调整。</p>
<p>SHMMAX应该比SGA区大,否则会引发性能的下降,shmmax 指的是单个共享内存段的最大尺寸， 设置shmmax=1G，sga分配了1.2G，当启动实例的时候就分配 2 块共享内存给Oracle</p>
<p>kernel.shmall=（SHMMAX/PAGE_SIZE）：共享内存总量，以页为单位。Linux 共享内存页大小为4KB, 共享内<br>存段的大小都是共享内存页大小的整数倍。一个共享内存段的最大大小是16G，那么需<br>要共享内存页数是 16GB/4KB=16777216KB/4KB=4194304 （页），也就是64Bit 系统下<br>16GB 物理内存，设置 kernel.shmall = 4194304 才符合要求</p>
<p>SHMMIN= 最小的内存段的大小 </p>
<p>kernel.shmmni：共享内存段的最大数量，shmmni 缺省值 4096 ，一般肯定是够用了</p>
<p>kernel.sem(SEMMSL SEMMNS SEMOPM SEMMNI)：<br>SEMMSL，每个信号量集中的最大信号量数，应该设置为服务器中各个实例中PROCESSES参数的和+10；SEMMNS，系统中信号量的最大数，参数应设置为SEMMSL*SEMMNI。<br>SEMOPM，每个信号量调用所包含的最大操作数。<br>SEMMNI：系统中信号量集的最大数。<br>swappiness的值的大小对如何使用swap分区是有着很大的联系的。swappiness=0的时候表示最大限度使用物理内存，然后才是 swap空间，swappiness＝100的时候表示积极的使用swap分区，并且把内存上的数据及时的搬运到swap空间里面。linux的基本默认设置为60</p>
<h5 id="5、修改oracle用户环境变量"><a href="#5、修改oracle用户环境变量" class="headerlink" title="5、修改oracle用户环境变量"></a>5、修改oracle用户环境变量</h5><p>su - oracle<br>vim ~/.bash_profile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># .bash_profile</span><br><span class="line"># Get the aliases and functions</span><br><span class="line">if [ -f ~/.bashrc ]; then</span><br><span class="line">        . ~/.bashrc</span><br><span class="line">fi</span><br><span class="line"># User specific environment and startup programs</span><br><span class="line">PATH=$PATH:$HOME/bin</span><br><span class="line">export PATH</span><br><span class="line">export THREADS_FLAG=native</span><br><span class="line">export ORACLE_BASE=/data/u01/app/oracle</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0.4/dbhome_1</span><br><span class="line">export PATH=$ORACLE_HOME/bin:$ORACLE_HOME/OPatch:$PATH:/usr/sbin</span><br><span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib</span><br><span class="line">export ORACLE_SID=boston</span><br><span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line">export NLS_DATE_FORMAT=&quot;YYYY:MM:DD HH24:MI:SS&quot;</span><br><span class="line">export EDITOR=vi</span><br><span class="line">set -o vi</span><br><span class="line">umask 022</span><br><span class="line">alias bdump=&quot;cd $ORACLE_BASE/diag/rdbms/otcdb/$&#123;ORACLE_SID&#125;/trace&quot;</span><br><span class="line">alias sql=&apos;sqlplus &quot;/ as sysdba&quot;&apos;</span><br></pre></td></tr></table></figure></p>
<p>使环境变量生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure></p>
<h4 id="6、解压软件包，在database-response目录下找到db-install-rsp文件"><a href="#6、解压软件包，在database-response目录下找到db-install-rsp文件" class="headerlink" title="6、解压软件包，在database/response目录下找到db_install.rsp文件"></a>6、解压软件包，在database/response目录下找到db_install.rsp文件</h4><p>编辑db_install.rsp文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#选择安装类型：1.INSTALL_DB_SWONLY只装数据库软件 2.INSTALL_DB_AND_CONFIG安装数据库软件并建库 3.UPGRADE_DB升级数据库</span><br><span class="line">oracle.install.option=INSTALL_DB_SWONLY</span><br><span class="line">#指定操作系统主机名，通过hostname命令获得</span><br><span class="line">ORACLE_HOSTNAME=dax-mysql-slave</span><br><span class="line">#指定oracle inventory目录的所有者，通常会是oinstall或者dba</span><br><span class="line">UNIX_GROUP_NAME=oinstall</span><br><span class="line">#指定产品清单oracle inventory目录的路径,如果是Win平台下可以省略</span><br><span class="line">INVENTORY_LOCATION=/data/u01/app/oracle/oraInventory</span><br><span class="line">#指定数据库语言，可以选择多个，用逗号隔开。选择en, zh_CN(英文和简体中文)</span><br><span class="line">SELECTED_LANGUAGES=en,zh_CN</span><br><span class="line"># Specify the complete path of the OracleHome.设置ORALCE_HOME的路径</span><br><span class="line">ORACLE_HOME=/data/u01/app/oracle/product/11.2.0.4/dbhome_1</span><br><span class="line"># Specify the complete path of the OracleBase. 设置ORALCE_BASE的路径</span><br><span class="line">ORACLE_BASE=/data/u01/app/oracle</span><br><span class="line">#选择Oracle安装数据库软件的版本（企业版，标准版，标准版1），不同的版本功能不同</span><br><span class="line">oracle.install.db.InstallEdition=EE</span><br><span class="line">#是否自定义Oracle的组件，如果选择false，则会使用默认的组件</span><br><span class="line">#如果选择true否则需要自己在下面一条参数将要安装的组件一一列出。</span><br><span class="line">#安装相应版权后会安装所有的组件，后期如果缺乏某个组件，再次安装会非常的麻烦。</span><br><span class="line">oracle.install.db.EEOptionsSelection=false</span><br><span class="line"># oracle.install.db.EEOptionsSelection=true的话下面的安装组件会安装</span><br><span class="line">oracle.install.db.optionalComponents=oracle.rdbms.partitioning:11.2.0.4.0,oracle.oraolap:11.2.0.4.0,oracle.rdbms.dm:11.2.0.4.0,oracle.rdbms.dv:11.2.0.4.0,oracle.rdbms.lbac:11.2.0.4.0,oracle.rdbms.rat:11.2.0.4.0</span><br><span class="line">#指定拥有OSDBA、OSOPER权限的用户组，通常会是dba组</span><br><span class="line">oracle.install.db.DBA_GROUP=dba</span><br><span class="line">oracle.install.db.OPER_GROUP=oinstall</span><br><span class="line">#如果是RAC的安装，在这里指定所有的节点</span><br><span class="line">oracle.install.db.CLUSTER_NODES=</span><br><span class="line">oracle.install.db.isRACOneInstall=</span><br><span class="line">oracle.install.db.isRACOneInstall=</span><br><span class="line">--------安装数据库选项</span><br><span class="line">#选择数据库的用途，一般用途/事物处理，数据仓库</span><br><span class="line">oracle.install.db.config.starterdb.type=GENERAL_PURPOSE</span><br><span class="line"># Specify the Starter Database GlobalDatabase Name. 指定GlobalName</span><br><span class="line">oracle.install.db.config.starterdb.globalDBName=boston</span><br><span class="line"># Specify the Starter Database SID.指定SID</span><br><span class="line">oracle.install.db.config.starterdb.SID=boston</span><br><span class="line">#选择字符集。不正确的字符集会给数据显示和存储带来麻烦无数。</span><br><span class="line">#通常中文选择的有ZHS16GBK简体中文库，建议选择unicode的AL32UTF8国际字符集</span><br><span class="line">oracle.install.db.config.starterdb.characterSet=AL32UTF8</span><br><span class="line">#11g的新特性自动内存管理，也就是SGA_TARGET和PAG_AGGREGATE_TARGET都#不用设置了，Oracle会自动调配两部分大小。</span><br><span class="line">oracle.install.db.config.starterdb.memoryOption=true</span><br><span class="line">#指定Oracle自动管理内存的大小，最小是256MB</span><br><span class="line">oracle.install.db.config.starterdb.memoryLimit=5120</span><br><span class="line">#是否载入模板示例</span><br><span class="line">oracle.install.db.config.starterdb.installExampleSchemas=false</span><br><span class="line"># These settings may also be disabled.   是否启用安全设置</span><br><span class="line">oracle.install.db.config.starterdb.enableSecuritySettings=true</span><br><span class="line">#设置数据库用户密码</span><br><span class="line">oracle.install.db.config.starterdb.password.ALL=oracle</span><br><span class="line">#数据库本地管理工具DB_CONTROL，远程集中管理工具GRID_CONTROL</span><br><span class="line">oracle.install.db.config.starterdb.control=DB_CONTROL</span><br><span class="line">#.设置自动备份，和OUI里的自动备份一样。</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.enable=false</span><br><span class="line">#自动备份会启动一个job，指定启动JOB的系统用户ID</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.osuid=</span><br><span class="line">#自动备份会开启一个job，需要指定OSUser的密码</span><br><span class="line">oracle.install.db.config.starterdb.automatedBackup.ospwd=</span><br><span class="line">#自动备份，要求指定使用的文件系统存放数据库文件还是ASM</span><br><span class="line">oracle.install.db.config.starterdb.storageType=</span><br><span class="line">#使用文件系统存放数据库文件才需要指定数据文件、控制文件、Redo log的存放目录</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.dataLocation=</span><br><span class="line">#使用文件系统存放数据库文件才需要指定备份恢复目录</span><br><span class="line">oracle.install.db.config.starterdb.fileSystemStorage.recoveryLocation=</span><br><span class="line">#使用ASM存放数据库文件才需要指定存放的磁盘组</span><br><span class="line">oracle.install.db.config.asm.diskGroup=</span><br><span class="line">#使用ASM存放数据库文件才需要指定ASM实例密码</span><br><span class="line">oracle.install.db.config.asm.ASMSNMPPassword=</span><br><span class="line">#指定metalink账户用户名</span><br><span class="line">MYORACLESUPPORT_USERNAME=</span><br><span class="line"># 指定metalink账户密码</span><br><span class="line">MYORACLESUPPORT_PASSWORD=</span><br><span class="line"># 用户是否可以设置metalink密码</span><br><span class="line">SECURITY_UPDATES_VIA_MYORACLESUPPORT=</span><br><span class="line"># False表示不需要设置安全更新，注意，在11.2的静默安装中疑似有一个BUG</span><br><span class="line">******# Response File中必须指定为true，否则会提示错误,不管是否正确填写了邮件地址</span><br><span class="line">DECLINE_SECURITY_UPDATES=true</span><br><span class="line">#代理服务器名</span><br><span class="line">PROXY_HOST=</span><br><span class="line">#代理服务器端口</span><br><span class="line">PROXY_PORT=</span><br><span class="line">#代理服务器用户名</span><br><span class="line">PROXY_USER=</span><br><span class="line">#代理服务器密码</span><br><span class="line">PROXY_PWD=</span><br></pre></td></tr></table></figure></p>
<p>开始安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./runInstaller -silent -responseFile /data/soft/database/response/db_install.rsp</span><br></pre></td></tr></table></figure></p>
<p>如果是测试环境可能碰到下面的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Checking swap space: 0 MB available, 150 MB required.    Failed &lt;&lt;&lt;&lt;</span><br><span class="line">解决方法：</span><br><span class="line">dd if=/dev/zero of=/data/swapfile bs=1M count=1024</span><br><span class="line">mkswap /data/swapfile</span><br><span class="line">swapon /data/swapfile</span><br><span class="line"></span><br><span class="line">在/etc/fstab添加下面内容</span><br><span class="line">/data/swapfile swap swap defaults 0 0</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p>
<p>oracle安装到最后提示，使用root用户执行以下两个脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/u01/app/oracle/oraInventory/orainstRoot.sh</span><br><span class="line">/data/u01/app/oracle/product/11.2.0.4/dbhome_1/root.sh</span><br></pre></td></tr></table></figure></p>
<h4 id="7、静默配置监听"><a href="#7、静默配置监听" class="headerlink" title="7、静默配置监听"></a>7、静默配置监听</h4><p>通过response文件运行netca, 生成sqlnet.ora和listener.ora文件, 位于$ORACLE_HOME/network/admin目录下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># su - oracle</span><br><span class="line">$ORACLE_HOME/bin/netca -silent -responsefile /data/soft/database/response/netca.rsp</span><br><span class="line">ll $ORACLE_HOME/network/admin/*.ora</span><br><span class="line">lsnrctl status</span><br></pre></td></tr></table></figure></p>
<h4 id="8、创建数据库"><a href="#8、创建数据库" class="headerlink" title="8、创建数据库"></a>8、创建数据库</h4><p>修改配置文件dbca.rsp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[GENERAL]</span><br><span class="line">RESPONSEFILE_VERSION = &quot;11.2.0&quot;</span><br><span class="line">OPERATION_TYPE = &quot;createDatabase&quot;</span><br><span class="line">[CREATEDATABASE]</span><br><span class="line">GDBNAME = &quot;boston.us.oracle.com&quot;</span><br><span class="line">TEMPLATENAME = &quot;General_Purpose.dbc&quot;</span><br><span class="line">SID = &quot;boston&quot;</span><br><span class="line">SYSPASSWORD = &quot;oracle&quot;</span><br><span class="line">SYSTEMPASSWORD = &quot;oracle&quot;</span><br><span class="line">SYSMANPASSWORD = &quot;oracle&quot;</span><br><span class="line">DBSNMPPASSWORD = &quot;oracle&quot;</span><br><span class="line">CHARACTERSET = &quot;ZHS16GBK&quot;</span><br><span class="line">TOTALMEMORY = &quot;2048&quot;</span><br></pre></td></tr></table></figure></p>
<p>运行命令开始创建数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbca -silent -createDatabase -responseFile /data/soft/database/response/createdbca.rsp</span><br></pre></td></tr></table></figure></p>
<p>如果不适用配置文件，也可使用下面命令直接指定参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">##dbca -silent -createDatabase -templateName $ORACLE_HOME/assistants/dbca/templates/General_Purpose.dbc -gdbName orcogg -sid orcogg  -sysPassword oracle -systemPassword oracle -datafileDestination /u01/app/oradata/orcogg -characterSet GBK16 -TOTALMEMORY 2048</span><br></pre></td></tr></table></figure></p>
<p>各参数含义如下:<br>-silent 表示以静默方式安装<br>-responseFile 表示使用哪个响应文件,必需使用绝对路径<br>RESPONSEFILE_VERSION 响应文件模板的版本,该参数不要更改<br>OPERATION_TYPE 安装类型,该参数不要更改<br>GDBNAME 全局数据库名,点号前面默认是db_name,点号后面默认就是db_domain<br>TEMPLATENAME 建库模板名,参考各模板定义:$ORACLE_HOME/assistants/dbca/templates/*.dbc<br>CHARACTERSET 字符集,默认是WE8MSWIN1252<br>TOTALMEMORY 实例内存,默认是服务器物理内存的40%</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/31/oracle 静默安装/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/30/测试mysql where条件顺序对sql查询效率的影响/"><span>[Mysql] 测试mysql where条件执行顺序对sql查询效率的影响</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/30/测试mysql where条件顺序对sql查询效率的影响/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-30T04:40:00.000Z">
          2018-10-30
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、创建基表测试数据"><a href="#1、创建基表测试数据" class="headerlink" title="1、创建基表测试数据"></a>1、创建基表测试数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into test1(name,age) values(&apos;lucy&apos;,10),(&apos;bobo&apos;,18),(&apos;david&apos;,20),(&apos;tom&apos;,21),(&apos;dobu&apos;,22),(&apos;dali&apos;,12);</span><br></pre></td></tr></table></figure>
<h4 id="2、创建中间表"><a href="#2、创建中间表" class="headerlink" title="2、创建中间表"></a>2、创建中间表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> CREATE TABLE `testfororder` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=14699990 DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>
<p>创建存储过程对中间表插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists test;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure test()</span><br><span class="line"> begin</span><br><span class="line">  declare i int;</span><br><span class="line">  set i=0;</span><br><span class="line">  while i&lt;300000 do</span><br><span class="line">   insert into testfororder(newid,name,age) select concat(i,name),FLOOR(18 + (RAND() * 12)) from test1;</span><br><span class="line">   set i=i+1;</span><br><span class="line">  end while;</span><br><span class="line"> end//</span><br><span class="line"> delimiter ;</span><br><span class="line">调用存储过程：</span><br><span class="line">call test();</span><br></pre></td></tr></table></figure></p>
<h4 id="3、创建测试表："><a href="#3、创建测试表：" class="headerlink" title="3、创建测试表："></a>3、创建测试表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `sequence` (</span><br><span class="line">  `id` int(10) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `newid` int(10) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=89179437 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into sequence(newid,name,age) select * from testfororder;</span><br></pre></td></tr></table></figure>
<p>数据量根据自己需求可以多次导入</p>
<h4 id="4、查看sequence测试表数据："><a href="#4、查看sequence测试表数据：" class="headerlink" title="4、查看sequence测试表数据："></a>4、查看sequence测试表数据：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">| 12600000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (2.83 sec)</span><br></pre></td></tr></table></figure>
<p>age条件筛选数据量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence where age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|  7341992 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (3.82 sec)</span><br></pre></td></tr></table></figure></p>
<p>newid条件筛选数量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence where newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       56 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (3.28 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="5、where条件-age-newid-在没有创建索引的情况下："><a href="#5、where条件-age-newid-在没有创建索引的情况下：" class="headerlink" title="5、where条件(age,newid)在没有创建索引的情况下："></a>5、where条件(age,newid)在没有创建索引的情况下：</h4><p>age在前，newid在后，查看执行计划：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 12292293 |    25.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (5.36 sec)</span><br></pre></td></tr></table></figure></p>
<p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 12292293 |    25.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (4.47 sec)</span><br></pre></td></tr></table></figure></p>
<p>没有任何索引的情况下，where后面跟的条件从左到右，返回数据越小的条件在前面，效率会优于返回数据较大的条件在前面。</p>
<h4 id="6、where条件-age-在没有创建索引，newid创建索引的情况下："><a href="#6、where条件-age-在没有创建索引，newid创建索引的情况下：" class="headerlink" title="6、where条件(age)在没有创建索引，newid创建索引的情况下："></a>6、where条件(age)在没有创建索引，newid创建索引的情况下：</h4><p>创建newid的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index newid_ind on sequence(newid);</span><br></pre></td></tr></table></figure></p>
<p>age在前，newid在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key       | key_len | ref  | rows | filtered | Extra                              |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_ind     | newid_ind | 4       | NULL |   56 |    50.00 | Using index condition; Using where |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key       | key_len | ref  | rows | filtered | Extra                              |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_ind     | newid_ind | 4       | NULL |   56 |    50.00 | Using index condition; Using where |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+-----------+---------+------+------+----------+------------------------------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在newid创建索引的情况下，where后面的查询条件前后顺序对查询效率影响不大。</p>
<h4 id="7、where条件-newid-在没有创建索引，age创建索引的情况下："><a href="#7、where条件-newid-在没有创建索引，age创建索引的情况下：" class="headerlink" title="7、where条件(newid)在没有创建索引，age创建索引的情况下："></a>7、where条件(newid)在没有创建索引，age创建索引的情况下：</h4><p>删除newid的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop index newid_ind on sequence;</span><br></pre></td></tr></table></figure></p>
<p>创建age的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index age_ind on sequence(age);</span><br></pre></td></tr></table></figure></p>
<p>age在前，newid在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | age_ind       | NULL | NULL    | NULL | 12292293 |    50.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (4.97 sec)</span><br></pre></td></tr></table></figure></p>
<p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | age_ind       | NULL | NULL    | NULL | 12292293 |    50.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (4.82 sec)</span><br></pre></td></tr></table></figure></p>
<p>创建age索引之后，执行计划会默认使用索引执行，但是因为age的筛选出来的数据量比较大，使用索引也不是特别理想。</p>
<h4 id="8、where条件-newid-age-创建联合索引的情况下："><a href="#8、where条件-newid-age-创建联合索引的情况下：" class="headerlink" title="8、where条件(newid,age)创建联合索引的情况下："></a>8、where条件(newid,age)创建联合索引的情况下：</h4><p>删除age索引，创建newid，age的联合索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drop index age_ind on sequence;</span><br><span class="line">create index newid_age_ind on sequence(newid,age);</span><br></pre></td></tr></table></figure></p>
<p>age在前，newid在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_age_ind | newid_age_ind | 9       | NULL |   98 |   100.00 | Using index condition |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line"></span><br><span class="line"> select * from sequence where age in (26,19,22,20,28,29,25) and newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>newid在前，age在后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_age_ind | newid_age_ind | 9       | NULL |   98 |   100.00 | Using index condition |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726) and age in (26,19,22,20,28,29,25);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679487 | 116719 | 2382lucy  |   29 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">49 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>联合索引存在的情况下，where后面的查询条件前后顺序对查询效率影响不大，但是创建了联合索引之后要注意查询条件问题，如果是以（newid，age）的顺序创建的联合索引，如果where查询条件后面有newid会使用联合索引，但是如果where查询条件后面之后age则不会引用联合索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">explain select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | range | newid_age_ind | newid_age_ind | 4       | NULL |   56 |   100.00 | Using index condition |</span><br><span class="line">+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">explain select * from sequence where age in (26,19,22,20,28,29,25);</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | sequence | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 12292293 |    50.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/30/测试mysql where条件顺序对sql查询效率的影响/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/30/测试mysql or和in对sql查询效率的影响/"><span>[Mysql] 测试mysql or和in对sql查询效率的影响</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/30/测试mysql or和in对sql查询效率的影响/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-30T04:39:00.000Z">
          2018-10-30
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、创建基表测试数据"><a href="#1、创建基表测试数据" class="headerlink" title="1、创建基表测试数据"></a>1、创建基表测试数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test1` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into test1(name,age) values(&apos;lucy&apos;,10),(&apos;bobo&apos;,18),(&apos;david&apos;,20),(&apos;tom&apos;,21),(&apos;dobu&apos;,22),(&apos;dali&apos;,12);</span><br></pre></td></tr></table></figure>
<h4 id="2、创建中间表"><a href="#2、创建中间表" class="headerlink" title="2、创建中间表"></a>2、创建中间表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> CREATE TABLE `testfororder` (</span><br><span class="line">  `id` int(7) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=14699990 DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>
<p>创建存储过程对中间表插入数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists test;</span><br><span class="line">delimiter //</span><br><span class="line">create procedure test()</span><br><span class="line"> begin</span><br><span class="line">  declare i int;</span><br><span class="line">  set i=0;</span><br><span class="line">  while i&lt;300000 do</span><br><span class="line">   insert into testfororder(newid,name,age) select concat(i,name),FLOOR(18 + (RAND() * 12)) from test1;</span><br><span class="line">   set i=i+1;</span><br><span class="line">  end while;</span><br><span class="line"> end//</span><br><span class="line"> delimiter ;</span><br><span class="line">调用存储过程：</span><br><span class="line">call test();</span><br></pre></td></tr></table></figure></p>
<h4 id="3、创建测试表："><a href="#3、创建测试表：" class="headerlink" title="3、创建测试表："></a>3、创建测试表：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `sequence` (</span><br><span class="line">  `id` int(10) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `newid` int(10) NOT NULL,</span><br><span class="line">  `name` varchar(20) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=89179437 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">insert into sequence(newid,name,age) select * from testfororder;</span><br></pre></td></tr></table></figure>
<p>数据量根据自己需求可以多次导入</p>
<h4 id="4、查看sequence测试表数据："><a href="#4、查看sequence测试表数据：" class="headerlink" title="4、查看sequence测试表数据："></a>4、查看sequence测试表数据：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from sequence;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">| 12600000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (2.83 sec)</span><br></pre></td></tr></table></figure>
<h4 id="5、在newid没有索引的情况下，in和or的对比："><a href="#5、在newid没有索引的情况下，in和or的对比：" class="headerlink" title="5、在newid没有索引的情况下，in和or的对比："></a>5、在newid没有索引的情况下，in和or的对比：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">repl@db 16:14:  [aaaa]&gt; select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (4.47 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid =116670 or newid = 116677 or newid = 116684 or newid =116691 or newid = 116698 or newid=116705 or newid=116719 or newid=116726;</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (6.77 sec)</span><br></pre></td></tr></table></figure>
<p>没有索引的情况下使用in查询效率高于or</p>
<h4 id="6、创建newid索引，再次进行测试："><a href="#6、创建newid索引，再次进行测试：" class="headerlink" title="6、创建newid索引，再次进行测试："></a>6、创建newid索引，再次进行测试：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> create index newid_ind on sequence(newid);</span><br><span class="line">select * from sequence where  newid in (116670,116677,116684,116691,116698,116705,116719,116726);</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">select * from sequence where  newid =116670 or newid = 116677 or newid = 116684 or newid =116691 or newid = 116698 or newid=116705 or newid=116719 or newid=116726;</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">| id       | newid  | name      | age  |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">|   100003 | 116670 | 2381lucy  |   26 |</span><br><span class="line">...</span><br><span class="line">| 76679494 | 116726 | 2382bobo  |   21 |</span><br><span class="line">+----------+--------+-----------+------+</span><br><span class="line">56 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>在newid存在索引的情况下，使用or和in查询对sql查询效率影响较小。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/30/测试mysql or和in对sql查询效率的影响/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/3/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/5/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2019 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>