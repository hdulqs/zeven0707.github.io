<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 4 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/11/mysql limit参数详解及使用过程遇到的问题/"><span>[Mysql] mysql limit参数详解及使用过程遇到的问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/11/mysql limit参数详解及使用过程遇到的问题/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-11T11:08:40.000Z">
          2018-09-11
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="前提：开发反应一条sql查询很慢，查看sql执行计划："><a href="#前提：开发反应一条sql查询很慢，查看sql执行计划：" class="headerlink" title="前提：开发反应一条sql查询很慢，查看sql执行计划："></a>前提：开发反应一条sql查询很慢，查看sql执行计划：</h3><p><img src="https://i.imgur.com/0g4vJQi.png" alt=""><br>查看到没有走设置的索引，而是走了主键索引，尝试去掉limit行限制之后：<br><img src="https://i.imgur.com/cHs3D6a.png" alt=""><br>发现去掉limit走索引正常。<br>是用group by和limit测试执行计划是否正常：<br><img src="https://i.imgur.com/taIuBAg.png" alt=""><br><img src="https://i.imgur.com/zmycRJf.png" alt=""><br>group by与limit组合会影响执行计划。<br>只使用limit，去掉order by和group by实验：<br><img src="https://i.imgur.com/ur8UNHg.png" alt=""><br><img src="https://i.imgur.com/W5mAiMg.png" alt=""><br>执行计划没有受影响。<br>结论：order by、group by与limit在一起执行的时候要注意执行计划是否影响，如果不得不使用该组合，担心执行计划被更改，建议使用force index(index_name)，或者多次测试执行计划不会被影响再放到生产环境里。<br>下面介绍官方文档就limit参数的解释：</p>
<h3 id="0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。"><a href="#0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。" class="headerlink" title="0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。"></a>0、如果是想要在结果集中获取固定的行数，在查询语句中使用limit子句，而不是获取全部的数据之后扔掉额外的数据。</h3><h3 id="1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。"><a href="#1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。" class="headerlink" title="1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。"></a>1、如果使用limit子句选择少数行，正常情况下倾向于进行全表扫描的时候，mysql会使用索引。</h3><h3 id="2、如果使用order-by与limit-row-count组合，mysql只要找到排序结果row-count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row-count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order-by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。"><a href="#2、如果使用order-by与limit-row-count组合，mysql只要找到排序结果row-count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row-count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order-by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。" class="headerlink" title="2、如果使用order by与limit row_count组合，mysql只要找到排序结果row_count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row_count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。"></a>2、如果使用order by与limit row_count组合，mysql只要找到排序结果row_count行数就会停止排序，而不是把所有的结果排序。排序使用索引效率更高。如果一个文件排序必须完成，在row_count行被找到之前，选择不带限制语句的所有行对他们进行排序。在初始化行被找到之后，mysql将不在对结果集排序。如果order by列多行值相同，服务器返回这些行没有任何顺序，根据全部的执行计划会有所不同。换句话说，这些行的排序顺序是不确定的相对于非排序列。</h3><p>limit会影响执行计划，因此orderby带有limit和不带有limit返回行会是不同排序。</p>
<h3 id="3、官方文档的实验如下："><a href="#3、官方文档的实验如下：" class="headerlink" title="3、官方文档的实验如下："></a>3、官方文档的实验如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">|  2 |        3 |    5.0 |</span><br><span class="line">|  7 |        3 |    2.7 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure>
<p>带有limit子句会影响每一个行category的返回值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category LIMIT 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure></p>
<p>对于带有limit和不带有limit的子句返回相同的行排序是很重要的，增加合适的列在order by子句中确保顺序。例如在order by后加一个id的排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category, id;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">|  2 |        3 |    5.0 |</span><br><span class="line">|  7 |        3 |    2.7 |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">mysql&gt; SELECT * FROM ratings ORDER BY category, id LIMIT 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 |    4.5 |</span><br><span class="line">|  5 |        1 |    3.2 |</span><br><span class="line">|  3 |        2 |    3.7 |</span><br><span class="line">|  4 |        2 |    3.5 |</span><br><span class="line">|  6 |        2 |    3.5 |</span><br><span class="line">+----+----------+--------+</span><br></pre></td></tr></table></figure></p>
<p>4、根据官方文档提供的信息，自己动手实验，创建测试数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">create table ratings (id int,category int,rating varchar(10));</span><br><span class="line">insert into ratings values(5,1,&apos;3.2&apos;),(1,1,&apos;4.5&apos;),(4,2,&apos;3.5&apos;),(3,2,&apos;3.7&apos;),(6,2,&apos;3.5&apos;),(7,3,&apos;2.7&apos;),(2,3,&apos;5.0&apos;);</span><br><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">|    7 |        3 | 2.7    |</span><br><span class="line">|    2 |        3 | 5.0    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category limit 5;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>id列没有做任何排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 08:47:  [test]&gt; SELECT * FROM ratings order by category,id;</span><br><span class="line">+------+----------+--------+</span><br><span class="line">| id   | category | rating |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">|    1 |        1 | 4.5    |</span><br><span class="line">|    5 |        1 | 3.2    |</span><br><span class="line">|    3 |        2 | 3.7    |</span><br><span class="line">|    4 |        2 | 3.5    |</span><br><span class="line">|    6 |        2 | 3.5    |</span><br><span class="line">|    2 |        3 | 5.0    |</span><br><span class="line">|    7 |        3 | 2.7    |</span><br><span class="line">+------+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在order by后多加一个id列，category和id列都按大小做了排序。</p>
<p>5、尝试在对id列添加主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:10:  [test]&gt; alter table ratings add primary key(id);</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line">root@db 09:10:  [test]&gt; SELECT * FROM ratings order by category;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 | 4.5    |</span><br><span class="line">|  5 |        1 | 3.2    |</span><br><span class="line">|  3 |        2 | 3.7    |</span><br><span class="line">|  4 |        2 | 3.5    |</span><br><span class="line">|  6 |        2 | 3.5    |</span><br><span class="line">|  2 |        3 | 5.0    |</span><br><span class="line">|  7 |        3 | 2.7    |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">root@db 09:10:  [test]&gt; SELECT * FROM ratings order by category limit 5;</span><br><span class="line">+----+----------+--------+</span><br><span class="line">| id | category | rating |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">|  1 |        1 | 4.5    |</span><br><span class="line">|  5 |        1 | 3.2    |</span><br><span class="line">|  3 |        2 | 3.7    |</span><br><span class="line">|  4 |        2 | 3.5    |</span><br><span class="line">|  6 |        2 | 3.5    |</span><br><span class="line">+----+----------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>添加主键之后id和category列都按大小排序。</p>
<h3 id="6、如果使用limit-row-count和distinct联合，mysql停止查询一旦找到row-count唯一行数。"><a href="#6、如果使用limit-row-count和distinct联合，mysql停止查询一旦找到row-count唯一行数。" class="headerlink" title="6、如果使用limit row_count和distinct联合，mysql停止查询一旦找到row_count唯一行数。"></a>6、如果使用limit row_count和distinct联合，mysql停止查询一旦找到row_count唯一行数。</h3><h3 id="7、一些情况下，group-by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit-row-count不计算任何不必要group-by值。"><a href="#7、一些情况下，group-by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit-row-count不计算任何不必要group-by值。" class="headerlink" title="7、一些情况下，group by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit row_count不计算任何不必要group by值。"></a>7、一些情况下，group by通过顺序读取索引来解决（或者在索引上做一个排序），然后统计信息直到索引值发生变化。在一些情况下，limit row_count不计算任何不必要group by值。</h3><h3 id="8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql-cal-found-rows函数。在这种情况下，可以使用select-found-rows-获取行数。"><a href="#8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql-cal-found-rows函数。在这种情况下，可以使用select-found-rows-获取行数。" class="headerlink" title="8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql_cal_found_rows函数。在这种情况下，可以使用select found_rows()获取行数。"></a>8、只要mysql发送需要的行数据到客户端，并中止查询除非使用sql_cal_found_rows函数。在这种情况下，可以使用select found_rows()获取行数。</h3><h3 id="9、limit-0快速返回一个空集。对于检查查询有效性很用帮助。"><a href="#9、limit-0快速返回一个空集。对于检查查询有效性很用帮助。" class="headerlink" title="9、limit 0快速返回一个空集。对于检查查询有效性很用帮助。"></a>9、limit 0快速返回一个空集。对于检查查询有效性很用帮助。</h3><h3 id="10、如果服务使用临时表来解决查询，使用limit-row-count子句来计算需要多少空间。"><a href="#10、如果服务使用临时表来解决查询，使用limit-row-count子句来计算需要多少空间。" class="headerlink" title="10、如果服务使用临时表来解决查询，使用limit row_count子句来计算需要多少空间。"></a>10、如果服务使用临时表来解决查询，使用limit row_count子句来计算需要多少空间。</h3><h3 id="11、如果order-by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。"><a href="#11、如果order-by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。" class="headerlink" title="11、如果order by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。"></a>11、如果order by没有用索引并且limit子句存在，优化器为了避免合并文件会使用内存filesort操作对内存内的行排序。</h3>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/11/mysql limit参数详解及使用过程遇到的问题/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/10/mysql-Lock wait timeout exceeded; try restarting transaction/"><span>[Mysql] mysql-Lock wait timeout exceeded; try restarting transaction</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/10/mysql-Lock wait timeout exceeded; try restarting transaction/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-10T14:19:03.000Z">
          2018-09-10
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、mysql执行一条update语句报错："><a href="#1、mysql执行一条update语句报错：" class="headerlink" title="1、mysql执行一条update语句报错："></a>1、mysql执行一条update语句报错：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>查看当前系统锁等待超时时间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;%lock_wait_timeout%&apos;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_lock_wait_timeout | 30    |</span><br><span class="line">| lock_wait_timeout        | 60    |</span><br><span class="line">+--------------------------+-------+</span><br></pre></td></tr></table></figure></p>
<p>innodb事务锁等待超时事件30s，其他非innodb事务锁等待事件超时为60s，</p>
<h3 id="2、查看造成事务阻塞的信息："><a href="#2、查看造成事务阻塞的信息：" class="headerlink" title="2、查看造成事务阻塞的信息："></a>2、查看造成事务阻塞的信息：</h3><p>select * from information_schema.innodb_trx\G；查看innodb_trx各列参数，点击<a href="https://zeven0707.github.io/2018/09/10/mysql%20innodb_trx%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">此处</a><br><img src="https://i.imgur.com/FxQAYyR.png" alt=""><br>线程id为1308的事务被线程id为1311的事务阻塞，查看不到线程id为1311正在执行的语句</p>
<h3 id="3、查看事务锁信息，记录了当前锁的相关信息；查看innodb-lock各列参数，点击此处："><a href="#3、查看事务锁信息，记录了当前锁的相关信息；查看innodb-lock各列参数，点击此处：" class="headerlink" title="3、查看事务锁信息，记录了当前锁的相关信息；查看innodb_lock各列参数，点击此处："></a>3、查看事务锁信息，记录了当前锁的相关信息；查看innodb_lock各列参数，点击<a href="https://zeven0707.github.io/2018/09/10/mysql%20innodb_locks%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">此处</a>：</h3><p>select * from information_schema.innodb_locks\G<br><img src="https://i.imgur.com/DlBpbOe.png" alt=""></p>
<h3 id="4、查看线程id为1311的线程信息，select-from-information-schema-processlist-where-id-1311-G，"><a href="#4、查看线程id为1311的线程信息，select-from-information-schema-processlist-where-id-1311-G，" class="headerlink" title="4、查看线程id为1311的线程信息，select * from information_schema.processlist where id=1311\G，"></a>4、查看线程id为1311的线程信息，select * from information_schema.processlist where id=1311\G，</h3><p><img src="https://i.imgur.com/chR1kiv.png" alt=""><br>该事务command为sleep，表示事务sql语句已经执行完成，但是锁仍然存在，没有释放手动kill掉该线程，在执行其他操作正常。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill 1311</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/10/mysql-Lock wait timeout exceeded; try restarting transaction/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/10/mysql innodb_locks参数详解/"><span>[Mysql] mysql show innodb_locks详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/10/mysql innodb_locks参数详解/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-10T11:50:03.000Z">
          2018-09-10
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、INFORMATION-SCHEMA-INNODB-LOCKS-提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下："><a href="#1、INFORMATION-SCHEMA-INNODB-LOCKS-提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下：" class="headerlink" title="1、INFORMATION_SCHEMA INNODB_LOCKS 提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下："></a>1、INFORMATION_SCHEMA INNODB_LOCKS 提供innodb事务去请求但没有获取到的锁信息和事务阻塞其他事务的锁信息。执行命令如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_locks\G</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/PCfQYeg.png" alt=""></p>
<h3 id="2、innodb-locks各列参数详解："><a href="#2、innodb-locks各列参数详解：" class="headerlink" title="2、innodb_locks各列参数详解："></a>2、innodb_locks各列参数详解：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lock_id:innodb唯一lock id。把他当做一个不透明的字符串。虽然lock_id当前包含trx_id，lock_id的数据格式在任何时间都肯能改变。不要写用于解析lock_id值得应用程序。</span><br><span class="line">lock_trx_id：持有锁的事务id。查询事务信息，与innodb_trx表中trx_id列匹配。</span><br><span class="line">lock_mode:锁请求。该值包括： S, X, IS, IX, GAP, AUTO_INC, and UNKNOWN。锁模式标识符可以组合用于识别特定的锁模式。查看更多信息，点击[此处]((https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html))</span><br><span class="line">lock_type:锁类型。行锁为record，表锁为table。</span><br><span class="line">lock_table:被锁的表名，或者包含锁记录的表名。</span><br><span class="line">lock_index:lock_type为行锁时，该值为索引名，否则为空。</span><br><span class="line">lock_space:lock_type为行锁时，该值为锁记录的表空间的id，否则为空。</span><br><span class="line">lock_page：lock_type为行锁时，该值为锁记录页数量，否则为空。</span><br><span class="line">lock_rec:lock_type为行锁时，页内锁记录的堆数，否则为空。</span><br><span class="line">lock_data：与锁相关的数据。如果lock_type为行锁时，该值是锁记录的主键值，否则为空。这列包含锁定行的主键列的值，转化为一个有效的字符串，如果没有主键，lock_data是唯一innodb内部行id号。如果是键值或者范围大于索引的最大值会使用间隙锁，lock_data表示为supremum pseudo-record。当包含锁记录的页不在buffer pool内，innodb不去从磁盘获取页，为了避免不必要的磁盘操作，lock_data为空。</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/10/mysql innodb_locks参数详解/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/10/mysql innodb_trx参数详解/"><span>[Mysql] mysql innodb_trx参数详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/10/mysql innodb_trx参数详解/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-10T07:54:05.000Z">
          2018-09-10
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、innodb-trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句："><a href="#1、innodb-trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句：" class="headerlink" title="1、innodb_trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句："></a>1、innodb_trx表提供了当前innodb引擎内每个事务的信息（只读事务除外），包括当一个事务启动，事务是否在等待一个锁，以及交易正在执行的语句（如果有的话）。查询语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_trx;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/QEeh4UJ.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_trx\G</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/MLfEIgP.png" alt=""></p>
<h3 id="2、innodb-trx表列信息详解："><a href="#2、innodb-trx表列信息详解：" class="headerlink" title="2、innodb_trx表列信息详解："></a>2、innodb_trx表列信息详解：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">trx_id：唯一事务id号，只读事务和非锁事务是不会创建id的。</span><br><span class="line">TRX_WEIGHT：事务的高度，代表修改的行数（不一定准确）和被事务锁住的行数。为了解决死锁，innodb会选择一个高度最小的事务来当做牺牲品进行回滚。已经被更改的非交易型表的事务权重比其他事务高，即使改变的行和锁住的行比其他事务低。</span><br><span class="line">TRX_STATE：事务的执行状态，值一般分为：RUNNING, LOCK WAIT, ROLLING BACK, and COMMITTING.</span><br><span class="line">TRX_STARTED：事务的开始时间</span><br><span class="line">TRX_REQUESTED_LOCK_ID:如果trx_state是lockwait,显示事务当前等待锁的id，不是则为空。想要获取锁的信息，根据该lock_id，以innodb_locks表中lock_id列匹配条件进行查询，获取相关信息。</span><br><span class="line">TRX_WAIT_STARTED：如果trx_state是lockwait,该值代表事务开始等待锁的时间；否则为空。</span><br><span class="line">TRX_MYSQL_THREAD_ID：mysql线程id。想要获取该线程的信息，根据该thread_id，以INFORMATION_SCHEMA.PROCESSLIST表的id列为匹配条件进行查询。</span><br><span class="line">TRX_QUERY：事务正在执行的sql语句。</span><br><span class="line">TRX_OPERATION_STATE：事务当前的操作状态，没有则为空。</span><br><span class="line">TRX_TABLES_IN_USE：事务在处理当前sql语句使用innodb引擎表的数量。</span><br><span class="line">TRX_TABLES_LOCKED：当前sql语句有行锁的innodb表的数量。（因为只是行锁，不是表锁，表仍然可以被多个事务读和写）</span><br><span class="line">TRX_LOCK_STRUCTS：事务保留锁的数量。</span><br><span class="line">TRX_LOCK_MEMORY_BYTES：在内存中事务索结构占得空间大小。</span><br><span class="line">TRX_ROWS_LOCKED：事务行锁最准确的数量。这个值可能包括对于事务在物理上存在，实际不可见的删除标记的行。</span><br><span class="line">TRX_ROWS_MODIFIED：事务修改和插入的行数</span><br><span class="line">TRX_CONCURRENCY_TICKETS：该值代表当前事务在被清掉之前可以多少工作，由 innodb_concurrency_tickets系统变量值指定。</span><br><span class="line">TRX_ISOLATION_LEVEL：事务隔离等级。</span><br><span class="line">TRX_UNIQUE_CHECKS：当前事务唯一性检查启用还是禁用。当批量数据导入时，这个参数是关闭的。</span><br><span class="line">TRX_FOREIGN_KEY_CHECKS：当前事务的外键坚持是启用还是禁用。当批量数据导入时，这个参数是关闭的。</span><br><span class="line">TRX_LAST_FOREIGN_KEY_ERROR：最新一个外键错误信息，没有则为空。</span><br><span class="line">TRX_ADAPTIVE_HASH_LATCHED：自适应哈希索引是否被当前事务阻塞。当自适应哈希索引查找系统分区，一个单独的事务不会阻塞全部的自适应hash索引。自适应hash索引分区通过 innodb_adaptive_hash_index_parts参数控制，默认值为8。</span><br><span class="line">TRX_ADAPTIVE_HASH_TIMEOUT：是否为了自适应hash索引立即放弃查询锁，或者通过调用mysql函数保留它。当没有自适应hash索引冲突，该值为0并且语句保持锁直到结束。在冲突过程中，该值被计数为0，每句查询完之后立即释放门闩。当自适应hash索引查询系统被分区（由 innodb_adaptive_hash_index_parts参数控制），值保持为0。</span><br><span class="line">TRX_IS_READ_ONLY：值为1表示事务是read only。</span><br><span class="line">TRX_AUTOCOMMIT_NON_LOCKING：值为1表示事务是一个select语句，该语句没有使用for update或者shared mode锁，并且执行开启了autocommit，因此事务只包含一个语句。当TRX_AUTOCOMMIT_NON_LOCKING和TRX_IS_READ_ONLY同时为1，innodb通过降低事务开销和改变表数据库来优化事务。</span><br></pre></td></tr></table></figure>
<h3 id="3、注意事项"><a href="#3、注意事项" class="headerlink" title="3、注意事项"></a>3、注意事项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该表用于当系统负载较高时，诊断性能问题。</span><br><span class="line">查询该表必须有process权限。</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/10/mysql innodb_trx参数详解/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/09/mysql show processlist详解/"><span>[Mysql] mysql show processlist详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/09/mysql show processlist详解/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-09T14:50:03.000Z">
          2018-09-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="0、show-processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。"><a href="#0、show-processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。" class="headerlink" title="0、show processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。"></a>0、show processlist查看正在运行的线程，如果你有process权限，能够看到所有的线程，如果没有权限只能看到自己的线程。</h3><p>有管理员权限的用户，如下图所示：<br><img src="https://i.imgur.com/CwMY5kv.png" alt=""><br>没有管理权限的用户，如下图所示：：<br><img src="https://i.imgur.com/iJ8OO2x.png" alt=""><br>如果不加full关键字，每条语句的info信息栏只能显示前100个字符。<br>如果看到“too many connections”的错误信息，想要看看什么线程正在运行，使用show processlist语句是很有用的。mysql数据库会额外保持一个连接，供具有connection_admin或者super权限用户的使用，用以确保管理员能随时连接进来检查系统状况（假设你没有将此权限授予所有用户）。<br>show processlist输出列详解：</p>
<h3 id="1、id：连接标识符，与INFORMATION-SCHEMA-PROCESSLIST表的id列显示的是同类型的值，如下图所示："><a href="#1、id：连接标识符，与INFORMATION-SCHEMA-PROCESSLIST表的id列显示的是同类型的值，如下图所示：" class="headerlink" title="1、id：连接标识符，与INFORMATION_SCHEMA PROCESSLIST表的id列显示的是同类型的值，如下图所示："></a>1、id：连接标识符，与INFORMATION_SCHEMA PROCESSLIST表的id列显示的是同类型的值，如下图所示：</h3><p><img src="https://i.imgur.com/Hl57tcb.png" alt=""><br>Performance_Schema threads表的processlist_id列也是相同值，由connection_id())函数返回值。<br><img src="https://i.imgur.com/CwS1fUD.png" alt=""><br>通过kill 语句可以杀掉查询到的线程，执行命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill id号</span><br></pre></td></tr></table></figure></p>
<h3 id="2、user-代表数据库用户，如果是system-user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system-user，host列没有任何信息。-unauthenticated-user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event-scheduler-是监控调度事件的线程。"><a href="#2、user-代表数据库用户，如果是system-user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system-user，host列没有任何信息。-unauthenticated-user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event-scheduler-是监控调度事件的线程。" class="headerlink" title="2、user: 代表数据库用户，如果是system user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system user，host列没有任何信息。 unauthenticated user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event_scheduler 是监控调度事件的线程。"></a>2、user: 代表数据库用户，如果是system user代表非客户端线程，是服务器发起的处理内部事务的线程。这些线程可能是io线程、复制从库的sql线程、延迟行处理线程。对于system user，host列没有任何信息。 unauthenticated user是有客户端发起的，但是尚未对客户端用户进行验证的线程。event_scheduler 是监控调度事件的线程。</h3><h3 id="3、host：发起线程的客户的主机名（对于system-user，host这一列为空）。tcp-ip连接的主机名是：hostname：client-port格式，用这种格式来更方面查看客户端在做什么操作。"><a href="#3、host：发起线程的客户的主机名（对于system-user，host这一列为空）。tcp-ip连接的主机名是：hostname：client-port格式，用这种格式来更方面查看客户端在做什么操作。" class="headerlink" title="3、host：发起线程的客户的主机名（对于system user，host这一列为空）。tcp/ip连接的主机名是：hostname：client_port格式，用这种格式来更方面查看客户端在做什么操作。"></a>3、host：发起线程的客户的主机名（对于system user，host这一列为空）。tcp/ip连接的主机名是：hostname：client_port格式，用这种格式来更方面查看客户端在做什么操作。</h3><h3 id="4、db：如果指定了库名，会使用当前的库名；如果没有则为空。"><a href="#4、db：如果指定了库名，会使用当前的库名；如果没有则为空。" class="headerlink" title="4、db：如果指定了库名，会使用当前的库名；如果没有则为空。"></a>4、db：如果指定了库名，会使用当前的库名；如果没有则为空。</h3><h3 id="5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处"><a href="#5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处" class="headerlink" title="5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击此处"></a>5、command：线程的命令类型。下面列举几种常见的线程命令，如果想查看详细信息点击<a href="https://dev.mysql.com/doc/refman/8.0/en/thread-commands.html" target="_blank" rel="noopener">此处</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">connect：从复制已经连接到主库</span><br><span class="line">connect out：从复制正在连接到主库</span><br><span class="line">create db：正在执行一个创建库的操作。</span><br><span class="line">execute：正在执行一个准备好的语句。</span><br><span class="line">field list：提取表列信息线程</span><br><span class="line">kill：当前线程被其他线程杀掉。</span><br><span class="line">query：正在整型一条语句。</span><br><span class="line">quit：线程被终止。</span><br><span class="line">refresh：刷新表、日志、缓存、重置状态变量值或从服务信息线程。</span><br><span class="line">shutdown：关闭服务线程</span><br><span class="line">sleep：等待客户端发送一条新语句线程。</span><br><span class="line">table dump：发送表内容到从服务器</span><br><span class="line">statics：获取当前服务状态信息。</span><br><span class="line">如果一个线程耗时比较久，需要重点关注造成该线程。</span><br></pre></td></tr></table></figure>
<h3 id="6、time：当前线程耗时。对于slave-sql-线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。"><a href="#6、time：当前线程耗时。对于slave-sql-线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。" class="headerlink" title="6、time：当前线程耗时。对于slave sql 线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。"></a>6、time：当前线程耗时。对于slave sql 线程，该值代表最后一次复制时间的时间戳和从服务器的真正时间的秒数。</h3><h3 id="7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处"><a href="#7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处" class="headerlink" title="7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击此处"></a>7、state：行为，事件，状态指明当前线程在做什么。下面列举几种常见状态值，查看详细信息点击<a href="https://dev.mysql.com/doc/refman/8.0/en/general-thread-states.html" target="_blank" rel="noopener">此处</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">after create：执行完create table函数之后，创建表的线程（包括内部临时表），即使因为某些错误创建表失败，该状态也会显示。</span><br><span class="line">analyzing：统计myisam表键分布（例如执行analyze table）</span><br><span class="line">checking permissions：检查是否有权限执行该语句。</span><br><span class="line">check tables：执行表检查操作。</span><br><span class="line">cleaning up：线程正在处理一条命名，准备释放内存重置某些状态变量。</span><br><span class="line">closing tables:刷新更改的表到磁盘，关闭使用的表。该操作应该快速完成，如果没有，请确保是否有足够的磁盘空间或者磁盘io是否太高。</span><br><span class="line">copy to tmp table:处理alter table语句。该状态发生在表新结构被创建之后，行数据被拷贝到表之前。</span><br><span class="line">copying to group table：该执行语句中order by和group by有不同的关键字，行被组处理拷贝到临时表。</span><br><span class="line">copying to tmp table：正在复制内存中的临时表。</span><br><span class="line">altering table：正在执行alter table</span><br><span class="line">Copying to tmp table on disk:正在拷贝临时表到磁盘。临时结果变得太大，因此，线程将临时表从内存转到磁盘来节省内存。</span><br><span class="line">creating index：对myisam表进行alter table ... enable keys操作</span><br><span class="line">creating sort index:使用内部临时表处理一个select语句。</span><br><span class="line">creating table：正在创建表（包括创建临时表）</span><br><span class="line">creating tmp table：在内存或磁盘创建一个临时表。如果一个表刚开始再内存创建，之后转到磁盘，该状态会变为：Copying to tmp table on disk。</span><br><span class="line">committing alter table to storage engine：alter table已经执行完成，正在提交 结果。</span><br><span class="line">executing：已经开始执行一个语句</span><br><span class="line">freeing items：已经执行了一个命令，该状态通常在cleaning up之后。</span><br><span class="line">query end：，在freeing items状态之前，处理一个查询之后</span><br><span class="line">logging slow query：写语句到slow-query日志</span><br><span class="line">sending data：正在读取和处理一个select语句的行，并发送数据到客户端，因为可能会发生物理读，该状态可能是给定生命周期时间最长的。</span><br><span class="line">update：准备更新表</span><br><span class="line">updating：正在搜索更新的行，并更新他们</span><br><span class="line">system lock：调用了mysql_lock_tables()函数，线程状态一直没有更新。产生该问题原因很多：</span><br><span class="line">比如：请求或等待一个表的内部或者外部系统锁。当innodb等待一个表锁等级为lock tables时会发生。如果这个问题是由请求外部锁，并且你没有用多个mysqld服务访问相同的myisam引擎表，你可以通过参数 --skip-external-locking禁用外部系统锁。但是外部锁默认情况下是禁用的，因此该参数可能没有影响。对于show profile命令，该状态代表正在请求锁（不是在等待锁）</span><br><span class="line">对于系统表锁状态是Locking system tables。</span><br><span class="line">waiting for commit lock：flush tables with read lock正在等待一个commit 锁</span><br><span class="line">waiting for tables：线程收到通知，表的底层架构已经更改，需要重新打开表后去一个新的结构。但是重新打开一个表，需要等待其他正在访问该表的线程。</span><br><span class="line">通常在其他线程使用flush tables或者执行下面语句: FLUSH TABLES tbl_name, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, or OPTIMIZE TABLE. 时会发生此通知。</span><br></pre></td></tr></table></figure>
<h3 id="8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。"><a href="#8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。" class="headerlink" title="8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。"></a>8、info：正在执行的语句，如果没有语句则为空。语句可能是发送的服务端的，或一个内部语句（如果一个语句执行其他语句）例如：call调用一个（select语句）存储过程，info值会显示select语句。</h3><h3 id="9、另外使用mysqladmin-processlist也可以查看进程信息，如下图所示："><a href="#9、另外使用mysqladmin-processlist也可以查看进程信息，如下图所示：" class="headerlink" title="9、另外使用mysqladmin processlist也可以查看进程信息，如下图所示："></a>9、另外使用mysqladmin processlist也可以查看进程信息，如下图所示：</h3><p><img src="https://i.imgur.com/72IPvk1.png" alt=""></p>
<h3 id="10、如果想通过sql命令去获取自己设定的行，可按以下方法设置："><a href="#10、如果想通过sql命令去获取自己设定的行，可按以下方法设置：" class="headerlink" title="10、如果想通过sql命令去获取自己设定的行，可按以下方法设置："></a>10、如果想通过sql命令去获取自己设定的行，可按以下方法设置：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.processlist where state !=&apos; &apos;;</span><br><span class="line">![](https://i.imgur.com/pGGuMER.png)</span><br></pre></td></tr></table></figure>
<p>可根据自己需求添加条件。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/09/mysql show processlist详解/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/09/mysql update一条语句过程遇到的问题/"><span>[Mysql] mysql update一条语句过程遇到的问题</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/09/mysql update一条语句过程遇到的问题/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-09T08:55:03.000Z">
          2018-09-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题："><a href="#1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题：" class="headerlink" title="1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题："></a>1、因为业务已停掉不担心会出现大量的锁等待事件，因此也没有考虑批量去更新（数据量有1700万左右），直接尝试去跑这一条update语句，第一次跑出现以下问题：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos;;</span><br><span class="line">error：Multi-statement TRANSACTION required more THAN &apos;max_binlog_cache_size&apos; bytes of STORAGE; increase this mysqld variable AND try again</span><br></pre></td></tr></table></figure>
<h3 id="2、查看binlog-cache-size，最大值为1G："><a href="#2、查看binlog-cache-size，最大值为1G：" class="headerlink" title="2、查看binlog_cache_size，最大值为1G："></a>2、查看binlog_cache_size，最大值为1G：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%binlog_cache_size%&apos;;</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| Variable_name         | Value      |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| binlog_cache_size     | 4194304    |</span><br><span class="line">| max_binlog_cache_size | 1073741824 |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="3、尝试去调高max-binlog-cache-size，在此执行update语句："><a href="#3、尝试去调高max-binlog-cache-size，在此执行update语句：" class="headerlink" title="3、尝试去调高max_binlog_cache_size，在此执行update语句："></a>3、尝试去调高max_binlog_cache_size，在此执行update语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global max_binlog_cache_size=4073741824;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">mysql&gt; show variables like &apos;%binlog_cache_size%&apos;;</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| Variable_name         | Value      |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">| binlog_cache_size     | 4194304    |</span><br><span class="line">| max_binlog_cache_size | 4073738240 |</span><br><span class="line">+-----------------------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog-cache-size仍然不满足，每次更新100万，执行正常："><a href="#4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog-cache-size仍然不满足，每次更新100万，执行正常：" class="headerlink" title="4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog_cache_size仍然不满足，每次更新100万，执行正常："></a>4、将至调到4G、8G去执行该语句，均报以上的错误，考虑用批量更新的方法去处理该update问题，尝试每次更新500万数据，binlog_cache_size仍然不满足，每次更新100万，执行正常：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id &gt;=1 and id &lt;= 1000000;</span><br><span class="line">Query OK, 974190 rows affected (2 min 3.48 sec)</span><br><span class="line">Rows matched: 974190  Changed: 974190  Warnings: 0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id &gt;=16000000 and id &lt;= 17000000;</span><br><span class="line">Query OK, 982238 rows affected (2 min 37.44 sec)</span><br><span class="line">Rows matched: 982238  Changed: 982238  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>每100万更新耗时为2min 40s左右</p>
<h3 id="5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法："><a href="#5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法：" class="headerlink" title="5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法："></a>5、上述方法适用于当前表有主键id且递增的情况。如果该id值从其他关联表获取，可考虑一下方法：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from trade_order ORDER BY id ASC LIMIT 1,1000000) as tmp);</span><br></pre></td></tr></table></figure>
<p>该方法涉及到一个子查询，总体执行速度会下降，根据取值范围和当前实际更新的行数，耗时在4min左右：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE trade_order SET state = &apos;CANCELLED&apos; where state=&apos;CANCEL&apos; and id in (select id from (select id from trade_order ORDER BY id ASC LIMIT 1,1000000) as tmp);</span><br><span class="line">Query OK, 981631 rows affected (3 min 49.27 sec)</span><br><span class="line">Rows matched: 981631  Changed: 981631  Warnings: 0</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/09/mysql update一条语句过程遇到的问题/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/08/mysql报错-[ERROR] InnoDB-Unable to lock -ibdata1/"><span>[Mysql] mysql报错：[ERROR] InnoDB: Unable to lock ./ibdata1</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/08/mysql报错-[ERROR] InnoDB-Unable to lock -ibdata1/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-07T16:08:03.000Z">
          2018-09-08
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、-登录mysql报错："><a href="#1、-登录mysql报错：" class="headerlink" title="1、 登录mysql报错："></a>1、 登录mysql报错：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">ERROR 2002 (HY000): Can&apos;t connect to local MySQL server through socket &apos;/data/mysql/tmp/mysql.sock&apos; (2)</span><br></pre></td></tr></table></figure>
<h3 id="2、netstat-tunlp-grep-3306发现mysql进程不存在，尝试去启动mysql："><a href="#2、netstat-tunlp-grep-3306发现mysql进程不存在，尝试去启动mysql：" class="headerlink" title="2、netstat -tunlp|grep 3306发现mysql进程不存在，尝试去启动mysql："></a>2、netstat -tunlp|grep 3306发现mysql进程不存在，尝试去启动mysql：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br><span class="line"> ERROR! MySQL server PID file could not be found!</span><br><span class="line">Starting MySQL....................................................................................^C</span><br><span class="line">启动失败，按ctrl+c退出。</span><br></pre></td></tr></table></figure>
<h3 id="3、查看log日志，一直在刷错误日志"><a href="#3、查看log日志，一直在刷错误日志" class="headerlink" title="3、查看log日志，一直在刷错误日志"></a>3、查看log日志，一直在刷错误日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] InnoDB: Unable to lock ./ibdata1 error: 11</span><br><span class="line">[Note] InnoDB: Check that you do not already have</span><br></pre></td></tr></table></figure>
<h3 id="4、查看磁盘使用情况"><a href="#4、查看磁盘使用情况" class="headerlink" title="4、查看磁盘使用情况"></a>4、查看磁盘使用情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sdc1       1.1T   59G  967G   6% /data</span><br><span class="line">数据目录还有很多空间。</span><br></pre></td></tr></table></figure>
<h3 id="5、查看mysql进程"><a href="#5、查看mysql进程" class="headerlink" title="5、查看mysql进程"></a>5、查看mysql进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;ps -ef|grep mysql</span><br><span class="line">mysql      1486 130771  2 05:16 pts/0    00:00:01 /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306</span><br><span class="line">root      77736      1  0 Jul25 ?        00:00:00 /bin/sh /data/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/tmp/mysql.pid</span><br><span class="line">mysql    128601  77736 85 05:13 ?        00:03:49 /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306</span><br><span class="line">root     130771      1  0 05:16 pts/0    00:00:00 /bin/sh /data/mysql/bin/mysqld_safe --datadir=/data/mysql/data --pid-file=/data/mysql/tmp/mysql.pid</span><br></pre></td></tr></table></figure>
<h3 id="6、top查看进程运行情况"><a href="#6、top查看进程运行情况" class="headerlink" title="6、top查看进程运行情况"></a>6、top查看进程运行情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tasks: 187 total,   1 running, 186 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.4 us,  0.3 sy,  0.0 ni, 99.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 32930580 total, 21548588 free,  7218592 used,  4163400 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 24748960 avail Mem </span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                             </span><br><span class="line">128601 mysql     20   0 21.711g 4.678g  12784 S   2.6 14.9   3:50.26 mysqld</span><br></pre></td></tr></table></figure>
<h3 id="7、杀掉进程128601"><a href="#7、杀掉进程128601" class="headerlink" title="7、杀掉进程128601"></a>7、杀掉进程128601</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -9 128601</span><br><span class="line">/data/mysql/bin/mysqld_safe: line 198:  1486 Killed                  nohup /data/mysql/bin/mysqld --basedir=/data/mysql --datadir=/data/mysql/data --plugin-dir=/data/mysql/lib/plugin --user=mysql --log-error=/data/mysql/log/error.log --open-files-limit=65535 --pid-file=/data/mysql/tmp/mysql.pid --socket=/data/mysql/tmp/mysql.sock --port=3306 &lt; /dev/null &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>因为mysql的守护进程存在，会自动启动mysql进程，再次登录数据库<br>mysql -uroot -p,登录正常。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/08/mysql报错-[ERROR] InnoDB-Unable to lock -ibdata1/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/07/云交易所建库、修改多个表的语句/"><span>[Mysql] mysql批量建库、修改多库中同一命名个表</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/07/云交易所建库、修改多个表的语句/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-07T15:37:03.000Z">
          2018-09-07
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、批量删除数据库"><a href="#1、批量删除数据库" class="headerlink" title="1、批量删除数据库"></a>1、批量删除数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">mysql -u root -ptest -e &quot;drop database $i&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="2、批量创建数据库"><a href="#2、批量创建数据库" class="headerlink" title="2、批量创建数据库"></a>2、批量创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">mysql -u root -ptest -e &quot;create database $i&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="3、批量在多个库中创建多个表"><a href="#3、批量在多个库中创建多个表" class="headerlink" title="3、批量在多个库中创建多个表"></a>3、批量在多个库中创建多个表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">for j in &#123;0..19&#125;</span><br><span class="line">do </span><br><span class="line">sql=&quot;CREATE TABLE \`match_record_$&#123;j&#125;\` (</span><br><span class="line">  \`id\` bigint(20) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">  \`symbol\` varchar(30) NOT NULL COMMENT &apos;交易对&apos;,</span><br><span class="line">  \`price\` decimal(30,15) NOT NULL COMMENT &apos;成交价格&apos;,</span><br><span class="line">  \`quantity\` decimal(30,15) NOT NULL COMMENT &apos;成交量&apos;,</span><br><span class="line">  \`buy_match_seq\` int(11) NOT NULL COMMENT &apos;买入成交序号&apos;,</span><br><span class="line">  \`buy_tx_no\` varchar(32) NOT NULL COMMENT &apos;买入交易单号&apos;,</span><br><span class="line">  \`sell_match_seq\` int(11) NOT NULL COMMENT &apos;卖出成交序号&apos;,</span><br><span class="line">  \`sell_tx_no\` varchar(32) NOT NULL COMMENT &apos;卖出交易单号&apos;,</span><br><span class="line">  \`is_maker\` tinyint(1) NOT NULL COMMENT &apos;买入方是否为maker&apos;,</span><br><span class="line">  \`create_time\` bigint(20) NOT NULL COMMENT &apos;成交时间戳&apos;,</span><br><span class="line">  PRIMARY KEY (\`id\`),</span><br><span class="line">  UNIQUE KEY \`uniq_idsymbol\` (\`id\`,\`symbol\`),</span><br><span class="line">  UNIQUE KEY \`uniq_txno\` (\`buy_tx_no\`,\`sell_tx_no\`),</span><br><span class="line">  KEY \`idx_create_time\` (\`create_time\`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&apos;成交记录表&apos;;</span><br><span class="line">&quot;</span><br><span class="line">mysql -uroot -ptest -D $i -e&quot;$&#123;sql&#125;&quot;;</span><br><span class="line">done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="4、批量修改多个库中的一个同名表做ddl语句操作"><a href="#4、批量修改多个库中的一个同名表做ddl语句操作" class="headerlink" title="4、批量修改多个库中的一个同名表做ddl语句操作"></a>4、批量修改多个库中的一个同名表做ddl语句操作</h3><p>对表增加列，添加唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">symbol=`echo &quot;$i&quot;| awk -F &apos;test_&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">sql=&quot;alter table match_record_0 add column symbol varchar(30) NOT NULL COMMENT &apos;交易对&apos; default &apos;&quot;$&#123;symbol&#125;&quot;&apos;&quot;</span><br><span class="line">alter1=&quot;alter table match_record_0 add UNIQUE KEY \`uniq_idsymbol\` (\`id\`,\`symbol\`)&quot;</span><br><span class="line">alter2=&quot;alter table match_record_0 add UNIQUE KEY \`uniq_txno\` (\`buy_tx_no\`,\`sell_tx_no\`)&quot;</span><br><span class="line">mysql -u root -ptest -D $i -e&quot;$&#123;sql&#125;;$&#123;alter1&#125;;$&#123;alter2&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>对表删除列，删除唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i in test_ETH_BTC test_BTC_USDT test_ETH_USDT test_BCH_BTC test_BCH_ETH test_BCH_USDT test_ETC_BTC test_ETC_ETH test_ETC_USDT test_LTC_BTC test_LTC_ETH test_LTC_USDT test_OMG_BTC test_OMG_ETH test_OMG_USDT test_ACT_BTC test_ACT_ETH test_ACT_USDT ;</span><br><span class="line">do</span><br><span class="line">symbol=`echo &quot;$i&quot;| awk -F &apos;test_&apos; &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">sql=&quot;alter table match_record_0 drop column symbol&quot;</span><br><span class="line">alter1=&quot;alter table match_record_0 drop index \`uniq_idsymbol\`&quot;</span><br><span class="line">alter2=&quot;alter table match_record_0 drop index \`uniq_txno\`&quot;</span><br><span class="line">mysql -u root -ptest -D $i -e&quot;$&#123;sql&#125;;$&#123;alter1&#125;;$&#123;alter2&#125;&quot;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/07/云交易所建库、修改多个表的语句/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/06/mysql binary排序规则与_bin排序规则对比/"><span>[Mysql] mysql-binary排序规则与_bin排序规则对比</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/06/mysql binary排序规则与_bin排序规则对比/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-06T15:39:58.000Z">
          2018-09-06
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、binary排序规则与-bin排序规则对比"><a href="#1、binary排序规则与-bin排序规则对比" class="headerlink" title="1、binary排序规则与_bin排序规则对比"></a>1、binary排序规则与_bin排序规则对比</h3><p>二进制字符串（像用binary，barbinary，blob存储的数据类型）有一个字符集和以binary命名的排序规则。二进制字符串是序列字节，这些字节的数字值决定了比较和排序的顺序。<br>非二进制字符串（像用char，varchar，text存储的数据类型）有一个字符集和排序规则（名称不是binary）。一个给定的非二进制字符集有几个排序规则，每一种排序规则对集合中的字符串定义一个特定的比较和排序的顺序。这些非二进制字符集的命名规则是在二进制字符集排序规则的名称后面添加_bin后缀。例如二进制排序规则latin1和utf8分别被命名latin1_bin,utf8_bin。</p>
<h3 id="2、在某些方面，二进制排序规则与-bin排序规则不同。"><a href="#2、在某些方面，二进制排序规则与-bin排序规则不同。" class="headerlink" title="2、在某些方面，二进制排序规则与_bin排序规则不同。"></a>2、在某些方面，二进制排序规则与_bin排序规则不同。</h3><h5 id="2-1、比较和排序单元："><a href="#2-1、比较和排序单元：" class="headerlink" title="2.1、比较和排序单元："></a>2.1、比较和排序单元：</h5><p>二进制字符串是字节序列。对于二进制排序规则，比较和排序是基于数字字节值。<br>非二进制字符串是（可能是多字节）字符的序列。非二进制排序规则定义了比较和排序字符值的顺序。对于_bin排序规则，这个顺序基于数字字符串编码值，类似于二进制字符串顺序（多字节字符串编制值除外）</p>
<h5 id="2-2、字符转换："><a href="#2-2、字符转换：" class="headerlink" title="2.2、字符转换："></a>2.2、字符转换：</h5><p>一个非二进制字符串有一个字符集，在很多情况下（即使字符串有_bin排序规则）也可以自动转换为另一个字符集。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当从另一个有不同字符集的列分配列值：</span><br><span class="line">UPDATE t1 SET utf8_bin_column=latin1_column;</span><br><span class="line">INSERT INTO t1 (latin1_column) SELECT utf8_bin_column FROM t2;</span><br><span class="line">当使用字符串文字为insert或update分配值时：</span><br><span class="line">SET NAMES latin1;</span><br><span class="line">INSERT INTO t1 (utf8_bin_column) VALUES (&apos;string-in-latin1&apos;);</span><br><span class="line">当从服务端给客户端返回结果：</span><br><span class="line">SET NAMES latin1;</span><br><span class="line">SELECT utf8_bin_column FROM t2;</span><br></pre></td></tr></table></figure></p>
<p>对于二进制字符串列，没有转换发生。对于前面的情况，字符串值是按字节复制的。</p>
<h5 id="2-3、大小写转换："><a href="#2-3、大小写转换：" class="headerlink" title="2.3、大小写转换："></a>2.3、大小写转换：</h5><p>非二进制字符集排序规则提供关于字符字母大小写的信息，因此非二进制字符可以被转换从一个字母到另一个，即使_bin排序规则忽略字母大小写顺序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES latin1 COLLATE latin1_bin;</span><br><span class="line">mysql&gt; SELECT LOWER(&apos;aA&apos;), UPPER(&apos;zZ&apos;);</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| LOWER(&apos;aA&apos;) | UPPER(&apos;zZ&apos;) |</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| aa          | ZZ          |</span><br><span class="line">+-------------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>字母大小写的概念对二进制字符串的字节不适用，执行字母大小写转换，字符串必须转换为非二进制字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES binary;</span><br><span class="line">mysql&gt; SELECT LOWER(&apos;aA&apos;), LOWER(CONVERT(&apos;aA&apos; USING latin1));</span><br><span class="line">+-------------+-----------------------------------+</span><br><span class="line">| LOWER(&apos;aA&apos;) | LOWER(CONVERT(&apos;aA&apos; USING latin1)) |</span><br><span class="line">+-------------+-----------------------------------+</span><br><span class="line">| aA          | aa                                |</span><br><span class="line">+-------------+-----------------------------------+</span><br></pre></td></tr></table></figure></p>
<h5 id="2-4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括-bin排序规则，尾随空间在比较过程是无关紧要的："><a href="#2-4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括-bin排序规则，尾随空间在比较过程是无关紧要的：" class="headerlink" title="2.4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括_bin排序规则，尾随空间在比较过程是无关紧要的："></a>2.4、比较过程的尾随空间处理：非二进制字符串为所有的排序规则进行填充空间，包括_bin排序规则，尾随空间在比较过程是无关紧要的：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; SELECT &apos;a &apos; = &apos;a&apos;;</span><br><span class="line">+------------+</span><br><span class="line">| &apos;a &apos; = &apos;a&apos; |</span><br><span class="line">+------------+</span><br><span class="line">|          1 |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure>
<p>对于二进制字符串，比较过程所有的字符都是重要的，包括尾随空间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET NAMES binary;</span><br><span class="line">mysql&gt; SELECT &apos;a &apos; = &apos;a&apos;;</span><br><span class="line">+------------+</span><br><span class="line">| &apos;a &apos; = &apos;a&apos; |</span><br><span class="line">+------------+</span><br><span class="line">|          0 |</span><br><span class="line">+------------+</span><br></pre></td></tr></table></figure></p>
<h5 id="2-5、在插入和检索中的尾随空间处理："><a href="#2-5、在插入和检索中的尾随空间处理：" class="headerlink" title="2.5、在插入和检索中的尾随空间处理："></a>2.5、在插入和检索中的尾随空间处理：</h5><p>char(n)列存储非二进制字符串，当insert操作是，值小于n字符会使用空格扩展。在检索时尾随空间会被移除。<br>二进制列存储二进制字符串,插入过程中值小于n字节，会使用ox00扩展，在检索过程中不会被移除；总是返回声明长度的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE t1 (</span><br><span class="line">         a CHAR(10) CHARACTER SET utf8 COLLATE utf8_bin,</span><br><span class="line">         b BINARY(10)</span><br><span class="line">       );</span><br><span class="line">mysql&gt; INSERT INTO t1 VALUES (&apos;a&apos;,&apos;a&apos;);</span><br><span class="line">mysql&gt; SELECT HEX(a), HEX(b) FROM t1;</span><br><span class="line">+--------+----------------------+</span><br><span class="line">| HEX(a) | HEX(b)               |</span><br><span class="line">+--------+----------------------+</span><br><span class="line">| 61     | 61000000000000000000 |</span><br><span class="line">+--------+----------------------+</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/06/mysql binary排序规则与_bin排序规则对比/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/05/mysql唯一性索引/"><span>[Mysql] mysql唯一性索引详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/05/mysql唯一性索引/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-05T07:14:03.000Z">
          2018-09-05
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、唯一性索引创建条件："><a href="#1、唯一性索引创建条件：" class="headerlink" title="1、唯一性索引创建条件："></a>1、唯一性索引创建条件：</h3><p>唯一性索引创建一个约束条件要求索引列上的所有值必须是不同的，如果你尝试添加一行新数据，但该行的键值与已经存在的其他行的键值相同将会报错。如果为唯一性索引指定前缀值，前缀长度的列值要保证唯一。唯一性索引允许null值。</p>
<h3 id="2、唯一非空索引-rowid的使用："><a href="#2、唯一非空索引-rowid的使用：" class="headerlink" title="2、唯一非空索引_rowid的使用："></a>2、唯一非空索引_rowid的使用：</h3><p>如果一个表有主键索引或者唯一非空索引，且索引由一个单独整型列类型组成，你可以在select语句使用_rowid来引用索引列，具体如下：<br>_rowid引用主键列如果主键列由单个整型列组成，如果存在主键列但是他不是由一个单独整型列组成，_rowid不能被使用。<br>另外，_rowid引用第一个有单个整型列组成的唯一非空索引列，如果不是，_rowid不能被使用。</p>
<h3 id="3、创建测试表，并将列修改为唯一非空进行试验："><a href="#3、创建测试表，并将列修改为唯一非空进行试验：" class="headerlink" title="3、创建测试表，并将列修改为唯一非空进行试验："></a>3、创建测试表，并将列修改为唯一非空进行试验：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table unique_t(id int,name varchar(10));</span><br><span class="line">alter table unique_t add unique index id_unique_ind(id);</span><br><span class="line">alter table unique_t modify id int not null;</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                                      |</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL,</span><br><span class="line">  UNIQUE KEY `id_unique_ind` (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>插入测试数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">insert into unique_t values(1,&apos;a&apos;),(2,&apos;b&apos;),(3,&apos;c&apos;),(4,&apos;d&apos;),(6,&apos;e&apos;);</span><br><span class="line">select *,_rowid from unique_t;</span><br><span class="line">+----+------+--------+</span><br><span class="line">| id | name | _rowid |</span><br><span class="line">+----+------+--------+</span><br><span class="line">|  1 | a    |      1 |</span><br><span class="line">|  2 | b    |      2 |</span><br><span class="line">|  3 | c    |      3 |</span><br><span class="line">|  4 | d    |      4 |</span><br><span class="line">|  6 | e    |      6 |</span><br><span class="line">+----+------+--------+</span><br></pre></td></tr></table></figure></p>
<h3 id="4、删除唯一性索引，修改id默认列可以为空："><a href="#4、删除唯一性索引，修改id默认列可以为空：" class="headerlink" title="4、删除唯一性索引，修改id默认列可以为空："></a>4、删除唯一性索引，修改id默认列可以为空：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">alter table unique_t drop index id_unique_ind;</span><br><span class="line">alter table unique_t modify id int null;</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                     |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>为id列创建主键索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">alter table unique_t add primary key(id);</span><br><span class="line">show create table unique_t;</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                       |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+----------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">select *,_rowid from unique_t;</span><br><span class="line">+----+------+--------+</span><br><span class="line">| id | name | _rowid |</span><br><span class="line">+----+------+--------+</span><br><span class="line">|  1 | a    |      1 |</span><br><span class="line">|  2 | b    |      2 |</span><br><span class="line">|  3 | c    |      3 |</span><br><span class="line">|  4 | d    |      4 |</span><br><span class="line">|  6 | e    |      6 |</span><br><span class="line">+----+------+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>给id添加主键约束和唯一非空约束，_rowid都可以引用对应列。</p>
<h3 id="5、删除id主键，将name列设置为主键测试"><a href="#5、删除id主键，将name列设置为主键测试" class="headerlink" title="5、删除id主键，将name列设置为主键测试"></a>5、删除id主键，将name列设置为主键测试</h3><p>alter table unique_t drop primary key;<br>alter table unique_t add primary key(name);<br>show index from unique_t;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| Table    | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">| unique_t |          0 | PRIMARY  |            1 | name        | A         |           5 |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line"></span><br><span class="line"> show create table unique_t;</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table    | Create Table                                                                                                                                     |</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| unique_t | CREATE TABLE `unique_t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+----------+--------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">root@db 07:11:  [exchange_market]&gt; select *,_rowid from unique_t;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &apos;_rowid&apos; in &apos;field list&apos;</span><br></pre></td></tr></table></figure></p>
<p>非单个整型列的主键，_rowid无法使用。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/05/mysql唯一性索引/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/3/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/5/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2018 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>